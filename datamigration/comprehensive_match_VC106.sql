
-- VC106 comprehensive matching (160 investors)
WITH dashboard_investors AS (
    SELECT * FROM (VALUES
        ('ROLLINS', UPPER('ROLLINS'), NULL),
        ('CHANG', UPPER('CHANG'), NULL),
        ('NGAN', UPPER('NGAN'), NULL),
        ('MADHVANI', UPPER('MADHVANI'), NULL),
        ('KOHI', UPPER('KOHI'), NULL),
        ('CHIH-HENG', UPPER('CHIH-HENG'), NULL),
        ('AGARWALA', UPPER('AGARWALA'), NULL),
        ('CHANDRA', UPPER('CHANDRA'), NULL),
        ('YONGJIE', UPPER('YONGJIE'), NULL),
        ('SAE-JEE', UPPER('SAE-JEE'), NULL),
        ('GEOK', UPPER('GEOK'), NULL),
        ('DALINGA HOLDING AG', NULL, UPPER('DALINGA HOLDING AG')),
        ('MARTINI', UPPER('MARTINI'), NULL),
        ('SAHLI', UPPER('SAHLI'), NULL),
        ('OEP Ltd', NULL, UPPER('OEP Ltd')),
        ('KRANA INVESTMENTS PTE. LTD.', NULL, UPPER('KRANA INVESTMENTS PTE. LTD.')),
        ('AKERMANN', UPPER('AKERMANN'), NULL),
        ('CABIAN', UPPER('CABIAN'), NULL),
        ('SCIMONE', UPPER('SCIMONE'), NULL),
        ('OFBR Trust', NULL, UPPER('OFBR Trust')),
        ('Elidon Estate Inc', NULL, UPPER('Elidon Estate Inc')),
        ('Adam Smith Singapore Pte Ltd', NULL, UPPER('Adam Smith Singapore Pte Ltd')),
        ('KNOPF', UPPER('KNOPF'), NULL),
        ('VOLF Trust', NULL, UPPER('VOLF Trust')),
        ('Bahama Global Towers Limited', NULL, UPPER('Bahama Global Towers Limited')),
        ('CAUSE FIRST Holdings Ltd', NULL, UPPER('CAUSE FIRST Holdings Ltd')),
        ('KARKUN', UPPER('KARKUN'), NULL),
        ('BROWN', UPPER('BROWN'), NULL),
        ('TRUE INVESTMENTS 4 LLC', NULL, UPPER('TRUE INVESTMENTS 4 LLC')),
        ('ROSEN INVEST HOLDINGS Inc', NULL, UPPER('ROSEN INVEST HOLDINGS Inc')),
        ('SUBRAMANIAN', UPPER('SUBRAMANIAN'), NULL),
        ('JIMENEZ TRADING INC', NULL, UPPER('JIMENEZ TRADING INC')),
        ('RIKHYE', UPPER('RIKHYE'), NULL),
        ('HARIA', UPPER('HARIA'), NULL),
        ('SHAH', UPPER('SHAH'), NULL),
        ('ONC Limited', NULL, UPPER('ONC Limited')),
        ('AL ABBASI', UPPER('AL ABBASI'), NULL),
        ('CORR', UPPER('CORR'), NULL),
        ('JORDAN', UPPER('JORDAN'), NULL),
        ('FigTree Family Office Ltd', NULL, UPPER('FigTree Family Office Ltd')),
        ('WRIGHT', UPPER('WRIGHT'), NULL),
        ('VAN DEN BOL', UPPER('VAN DEN BOL'), NULL),
        ('MATTHEWS', UPPER('MATTHEWS'), NULL),
        ('HAYCOX', UPPER('HAYCOX'), NULL),
        ('ACKERLEY', UPPER('ACKERLEY'), NULL),
        ('MANNING', UPPER('MANNING'), NULL),
        ('Global Custody & Clearing Limited', NULL, UPPER('Global Custody & Clearing Limited')),
        ('BROOKS', UPPER('BROOKS'), NULL),
        ('DAHAN', UPPER('DAHAN'), NULL),
        ('DUTIL', UPPER('DUTIL'), NULL),
        ('Sudon Carlop Holdings Limited', NULL, UPPER('Sudon Carlop Holdings Limited')),
        ('SCHUTTE', UPPER('SCHUTTE'), NULL),
        ('SEKHON', UPPER('SEKHON'), NULL),
        ('GRAF', UPPER('GRAF'), NULL),
        ('NUSSBERGER', UPPER('NUSSBERGER'), NULL),
        ('JASSQ HOLDING LIMITED', NULL, UPPER('JASSQ HOLDING LIMITED')),
        ('INNOSIGHT VENTURES Pte Ltd', NULL, UPPER('INNOSIGHT VENTURES Pte Ltd')),
        ('GORILLA PE Inc', NULL, UPPER('GORILLA PE Inc')),
        ('EVANS', UPPER('EVANS'), NULL),
        ('HOLDEN', UPPER('HOLDEN'), NULL),
        ('HAYAT', UPPER('HAYAT'), NULL),
        ('KOTHARI', UPPER('KOTHARI'), NULL),
        ('MUKHTAR', UPPER('MUKHTAR'), NULL),
        ('SOUTH SOUND LTD', NULL, UPPER('SOUTH SOUND LTD')),
        ('PATRASCU', UPPER('PATRASCU'), NULL),
        ('JOGANI', UPPER('JOGANI'), NULL),
        ('RUSHTON', UPPER('RUSHTON'), NULL),
        ('SOMMERVILLE', UPPER('SOMMERVILLE'), NULL),
        ('LAI', UPPER('LAI'), NULL),
        ('LUND', UPPER('LUND'), NULL),
        ('BELGA', UPPER('BELGA'), NULL),
        ('JOMAA', UPPER('JOMAA'), NULL),
        ('JAYARAMAN', UPPER('JAYARAMAN'), NULL),
        ('HAKIM', UPPER('HAKIM'), NULL),
        ('Kenilworth Ltd', NULL, UPPER('Kenilworth Ltd')),
        ('KHAWAJA', UPPER('KHAWAJA'), NULL),
        ('JATANIA', UPPER('JATANIA'), NULL),
        ('QUNASH', UPPER('QUNASH'), NULL),
        ('GUERIN', UPPER('GUERIN'), NULL),
        ('LE SEIGNEUR', UPPER('LE SEIGNEUR'), NULL),
        ('PATEL', UPPER('PATEL'), NULL),
        ('POTASSIUM Capital', NULL, UPPER('POTASSIUM Capital')),
        ('HASSAN', UPPER('HASSAN'), NULL),
        ('GTV Partners SA', NULL, UPPER('GTV Partners SA')),
        ('LENN Participations SARL', NULL, UPPER('LENN Participations SARL')),
        ('WEALTH TRAIN LIMITED', NULL, UPPER('WEALTH TRAIN LIMITED')),
        ('GOKER', UPPER('GOKER'), NULL),
        ('ALAMOUTI', UPPER('ALAMOUTI'), NULL),
        ('Caspian Enterprises Limited', NULL, UPPER('Caspian Enterprises Limited')),
        ('Rensburg Client Nominees Limited A/c CLT', NULL, UPPER('Rensburg Client Nominees Limited A/c CLT')),
        ('DCMS Holdings Limited', NULL, UPPER('DCMS Holdings Limited')),
        ('GELIGA LIMITED', NULL, UPPER('GELIGA LIMITED')),
        ('KRAUSER', UPPER('KRAUSER'), NULL),
        ('FLETCHER', UPPER('FLETCHER'), NULL),
        ('STEIMES', UPPER('STEIMES'), NULL),
        ('SERRA', UPPER('SERRA'), NULL),
        ('SAMAMA', UPPER('SAMAMA'), NULL),
        ('SWISS TRUSTEES OF GENEVA SA as Trustees of the LUTEPIN TRUST', NULL, UPPER('SWISS TRUSTEES OF GENEVA SA as Trustees of the LUTEPIN TRUST')),
        ('CUDRE-MAUROUX', UPPER('CUDRE-MAUROUX'), NULL),
        ('CYTRON', UPPER('CYTRON'), NULL),
        ('RIENZO', UPPER('RIENZO'), NULL),
        ('GHESQUIERES', UPPER('GHESQUIERES'), NULL),
        ('ROSSIER', UPPER('ROSSIER'), NULL),
        ('MARSAULT INTERNATIONAL LTD', NULL, UPPER('MARSAULT INTERNATIONAL LTD')),
        ('DUFAURE', UPPER('DUFAURE'), NULL),
        ('SUKHOTIN', UPPER('SUKHOTIN'), NULL),
        ('JAVID', UPPER('JAVID'), NULL),
        ('BADII', UPPER('BADII'), NULL),
        ('SOLOUKI', UPPER('SOLOUKI'), NULL),
        ('HUSSAIN', UPPER('HUSSAIN'), NULL),
        ('TONELLI BANFI', UPPER('TONELLI BANFI'), NULL),
        ('GREENLEAF', NULL, UPPER('GREENLEAF')),
        ('Banco BTG Pactual S.A. Client 12279', NULL, UPPER('Banco BTG Pactual S.A. Client 12279')),
        ('Banco BTG Pactual S.A. Client 34658', NULL, UPPER('Banco BTG Pactual S.A. Client 34658')),
        ('Banco BTG Pactual S.A. Client 34924', NULL, UPPER('Banco BTG Pactual S.A. Client 34924')),
        ('Banco BTG Pactual S.A. Client 36003', NULL, UPPER('Banco BTG Pactual S.A. Client 36003')),
        ('Banco BTG Pactual S.A. Client 36749', NULL, UPPER('Banco BTG Pactual S.A. Client 36749')),
        ('Banco BTG Pactual S.A. Client 36957', NULL, UPPER('Banco BTG Pactual S.A. Client 36957')),
        ('Banco BTG Pactual S.A. Client 80738', NULL, UPPER('Banco BTG Pactual S.A. Client 80738')),
        ('Banco BTG Pactual S.A. Client 80772', NULL, UPPER('Banco BTG Pactual S.A. Client 80772')),
        ('Banco BTG Pactual S.A. Client 80775', NULL, UPPER('Banco BTG Pactual S.A. Client 80775')),
        ('Banco BTG Pactual S.A. Client 80776', NULL, UPPER('Banco BTG Pactual S.A. Client 80776')),
        ('Banco BTG Pactual S.A. Client 80840', NULL, UPPER('Banco BTG Pactual S.A. Client 80840')),
        ('Banco BTG Pactual S.A. Client 80862', NULL, UPPER('Banco BTG Pactual S.A. Client 80862')),
        ('Banco BTG Pactual S.A. Client 80873', NULL, UPPER('Banco BTG Pactual S.A. Client 80873')),
        ('Banco BTG Pactual S.A. Client 80890', NULL, UPPER('Banco BTG Pactual S.A. Client 80890')),
        ('Banco BTG Pactual S.A. Client 80910', NULL, UPPER('Banco BTG Pactual S.A. Client 80910')),
        ('Banco BTG Pactual S.A. Client 81022', NULL, UPPER('Banco BTG Pactual S.A. Client 81022')),
        ('Banco BTG Pactual S.A. Client 515', NULL, UPPER('Banco BTG Pactual S.A. Client 515')),
        ('OLD HILL INVESTMENT GROUP LLC', NULL, UPPER('OLD HILL INVESTMENT GROUP LLC')),
        ('FONTES WILLIAMS', UPPER('FONTES WILLIAMS'), NULL),
        ('MA GROUP AG', NULL, UPPER('MA GROUP AG')),
        ('WINZ', UPPER('WINZ'), NULL),
        ('HARALALKA', UPPER('HARALALKA'), NULL),
        ('DATT', UPPER('DATT'), NULL),
        ('BIN MOHAMED', UPPER('BIN MOHAMED'), NULL),
        ('GANERIWALA', UPPER('GANERIWALA'), NULL),
        ('PANT Investments Inc', NULL, UPPER('PANT Investments Inc')),
        ('SUD', UPPER('SUD'), NULL),
        ('KAPOOR', UPPER('KAPOOR'), NULL),
        ('KULKARNI', UPPER('KULKARNI'), NULL),
        ('Innovatech 1', NULL, UPPER('Innovatech 1')),
        ('MOORE', UPPER('MOORE'), NULL),
        ('TERRA Financial & Management Services SA', NULL, UPPER('TERRA Financial & Management Services SA')),
        ('BACHELIER', UPPER('BACHELIER'), NULL),
        ('ROTH', UPPER('ROTH'), NULL),
        ('KABELLA LTD', NULL, UPPER('KABELLA LTD')),
        ('CINCORIA LIMITED', NULL, UPPER('CINCORIA LIMITED')),
        ('WILLETTS', UPPER('WILLETTS'), NULL),
        ('Bank SYZ AG', NULL, UPPER('Bank SYZ AG')),
        ('Bright Phoenix Holdings Limited', NULL, UPPER('Bright Phoenix Holdings Limited')),
        ('Swip Holdings Ltd', NULL, UPPER('Swip Holdings Ltd')),
        ('Phaena Advisory Ltd', NULL, UPPER('Phaena Advisory Ltd')),
        ('WILTSHIRE', UPPER('WILTSHIRE'), NULL),
        ('TERSANE INTERNATIONAL LTD', NULL, UPPER('TERSANE INTERNATIONAL LTD')),
        ('Brahma Finance (BVI) Ltd', NULL, UPPER('Brahma Finance (BVI) Ltd')),
        ('HARTSHORN', UPPER('HARTSHORN'), NULL),
        ('SARASIN', UPPER('SARASIN'), NULL),
        ('KOHLER CABIAN', UPPER('KOHLER CABIAN'), NULL),
        ('RLABS HOLDINGS LTD', NULL, UPPER('RLABS HOLDINGS LTD'))
    ) AS t(identifier, match_lastname, match_entity)
),
matches AS (
    SELECT 
        d.identifier,
        inv.id as investor_id,
        inv.legal_name,
        inv.last_name as db_last_name,
        inv.type,
        CASE 
            WHEN d.match_lastname IS NOT NULL AND UPPER(inv.last_name) = d.match_lastname THEN 'EXACT_LASTNAME'
            WHEN d.match_entity IS NOT NULL AND UPPER(inv.legal_name) = d.match_entity THEN 'EXACT_ENTITY'
            WHEN UPPER(inv.legal_name) ILIKE '%' || d.identifier || '%' THEN 'PARTIAL'
            ELSE 'NO_MATCH'
        END as match_quality
    FROM dashboard_investors d
    LEFT JOIN vehicles v ON v.entity_code = 'VC106'
    LEFT JOIN subscriptions s ON s.vehicle_id = v.id
    LEFT JOIN investors inv ON inv.id = s.investor_id
        AND (
            (d.match_lastname IS NOT NULL AND UPPER(inv.last_name) = d.match_lastname)
            OR (d.match_entity IS NOT NULL AND UPPER(inv.legal_name) = d.match_entity)
            OR UPPER(inv.legal_name) ILIKE '%' || d.identifier || '%'
        )
)
SELECT 
    identifier,
    investor_id,
    legal_name,
    match_quality,
    COUNT(*) OVER (PARTITION BY identifier) as total_matches
FROM matches
WHERE investor_id IS NOT NULL
ORDER BY identifier;
