# Ralph Progress Log
Started: Mon Jan 26 22:04:55 CET 2026
---

## Codebase Patterns
- Use shadcn theme variables for theme-aware styling: `bg-background`, `text-foreground`, `text-muted-foreground`, `border-border`, `bg-muted`, `bg-card`, `bg-accent`, `text-primary`, `text-destructive`
- For hover states use: `hover:bg-muted`, `hover:bg-accent`
- For selection states use: `bg-primary/20 border-primary`
- shadcn Button component already handles theme - don't add custom text/border colors
- DropdownMenuContent doesn't need custom bg/border styling - shadcn handles it
- Responsive sidebar pattern: `grid-cols-1 lg:grid-cols-[280px_1fr]` with `hidden lg:flex` for desktop-only sidebar
- Vehicle hierarchy parsing: Use `parseVehicleHierarchy()` from `@/lib/documents/vehicle-hierarchy` to group vehicles by parent (fund/securitization → children) and create virtual SCSP parent nodes for Series vehicles
- Supabase aggregations: Use RPC functions with SQL `GROUP BY` for count/sum operations on large tables. Example: `serviceSupabase.rpc('get_folder_document_counts')` returns pre-aggregated counts instead of fetching all rows
- Breadcrumb vehicle context: Track `selectedVehicleId` state alongside `currentFolderId`, derive `currentVehicle` from folder's vehicle_id OR explicit selection. FolderBreadcrumbs accepts `vehicle` and `onVehicleClick` props.
- SSR-safe localStorage pattern: Initialize useState with default value, then use `useEffect(() => { const saved = localStorage.getItem(key); if (saved) setState(saved) }, [])` to load on client mount. Avoid using localStorage in useState initializer (doesn't work with SSR/hydration).
- URL state persistence pattern: Use `useSearchParams()` + `useRouter()` + `usePathname()` from next/navigation. Read params on mount with useEffect, update with `router.replace(\`\${pathname}?\${params.toString()}\`, { scroll: false })` to avoid page scroll.
- Server-side search pattern: Use `.ilike('column', '%${searchTerm}%')` for case-insensitive search. Join related tables in same query with explicit column selection for context (e.g., folder.name, vehicle.name). Limit 50 results with pagination for scalability.
- Debounce pattern: Use `const timerRef = useRef<NodeJS.Timeout | null>(null)` with `clearTimeout(timerRef.current)` before `timerRef.current = setTimeout(() => action(), 300)`. Clean up on unmount with `useEffect(() => () => clearTimeout(timerRef.current), [])`.
- Tree search with auto-expand: Separate `inputValue` from `debouncedValue` state. Use effect to find matching nodes and their ancestors, store in `searchExpanded` set. Combine with manual `expanded` set using `effectiveExpanded = new Set([...expanded, ...searchExpanded])`. Clear `searchExpanded` when search is cleared.
- Text highlighting pattern: Create `highlightText(text, query)` helper that returns `<>{before}<mark className="bg-yellow-300 dark:bg-yellow-500/40">{match}</mark>{after}</>` using case-insensitive indexOf.
- Bulk actions dropdown pattern: Use DropdownMenu with disabled button when `selectedDocuments.size === 0`. Pass callbacks like `onBulkMove`, `onBulkDelete`, `onBulkDownload`. Destructive items use `className="text-destructive focus:text-destructive"`.
- Bulk operations with progress: For multi-item operations, use sequential API calls (not Promise.all) to show progress "Processing X/Y...". Track success/fail counts and show appropriate toast (success if all pass, warning if partial, error if all fail).
- ZIP streaming response pattern: Use `archiver` package - collect chunks via `archive.on('data')`, finalize with `archive.finalize()`, wait for `archive.on('end')`, then return `new NextResponse(buffer, { headers: { 'Content-Type': 'application/zip', 'Content-Disposition': 'attachment; filename="..."' } })`.

## 2026-01-26 22:15 - US-001
- **What was implemented:** Fixed hardcoded dark theme in staff documents page
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx` - Replaced bg-[#0a0a0a], bg-black/40, border-white/10, text-white with theme-aware variants
  - `versotech-portal/src/components/documents/folder-tree.tsx` - Replaced hover:bg-gray-700, text-gray-300/400 with theme-aware variants
  - `versotech-portal/src/components/documents/document-card.tsx` - Replaced bg-white, text-gray-900, border-gray-200 with theme-aware variants
- **Learnings for future iterations:**
  - The staff documents page had fully hardcoded dark theme classes forcing dark mode regardless of system settings
  - shadcn components (Button, DropdownMenu) handle theming internally - don't override with custom colors
  - Icon colors can use semantic colors like `text-blue-500` for vehicle roots, `text-green-500` for categories (these are intentional differentiation, not theme colors)
  - The amber warning button uses `dark:text-amber-400` pattern for colors that need specific dark mode variants
---

## 2026-01-26 22:30 - US-002
- **What was implemented:** Created permanent tree sidebar layout
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx` - Major layout refactor:
    - Added CSS grid layout with `grid-cols-1 lg:grid-cols-[280px_1fr]`
    - Built sidebar tree renderer with folder expand/collapse
    - Added tree search with auto-expand for matching folders
    - Integrated document counts display in tree nodes
    - Added mobile hamburger toggle (Menu icon) for drawer
    - Moved main content to `<main>` element within grid
  - `versotech-portal/src/components/documents/navigation/FolderTreeDrawer.tsx` - Fixed hardcoded dark theme:
    - Replaced `bg-zinc-900`, `bg-black/40`, `border-white/10` with theme-aware variants
    - Replaced `text-white`, `text-gray-300/400` with `text-foreground`, `text-muted-foreground`
    - Fixed selection states to use `bg-primary/20 border-primary`
- **Learnings for future iterations:**
  - Use `lg:grid-cols-[280px_1fr]` for desktop sidebar + content layouts (1024px breakpoint)
  - `hidden lg:flex` pattern shows sidebar only on desktop; `lg:hidden` for mobile-only elements
  - ScrollArea from shadcn provides smooth independent scrolling for sidebars
  - Tree building pattern: `buildFolderTree()` creates nested structure from flat folder list, `filterTreeBySearch()` filters recursively
  - Auto-expand ancestors: When navigating to a folder, expand all parent folders using useEffect
---

## 2026-01-26 22:40 - US-003
- **What was implemented:** Created vehicle hierarchy parser for grouping vehicles in tree view
- **Files changed:**
  - `versotech-portal/src/lib/documents/vehicle-hierarchy.ts` - New module with:
    - `parseVehicleHierarchy()` - Main function converting flat vehicle array to nested hierarchy
    - `isParentVehicle()` - Checks if vehicle type is 'fund' or 'securitization'
    - `extractSeriesParentName()` - Extracts SCSP/LLC parent name from "Series XXX" vehicles
    - `extractCompartmentParentName()` - Extracts parent name from "Compartment X" vehicles
    - `flattenVehicleHierarchy()` - Utility to flatten hierarchy back to array
    - `findVehicleInHierarchy()` - Find vehicle by ID in nested structure
  - `versotech-portal/src/__tests__/lib/documents/vehicle-hierarchy.test.ts` - 26 unit tests covering:
    - Parent detection (fund/securitization types)
    - Compartment matching to securitization parents
    - Series grouping under virtual SCSP parents
    - Sort order (real parents first, then virtual groups)
    - Edge cases (empty input, mixed hierarchies)
- **Learnings for future iterations:**
  - Vehicle types: fund, spv, securitization, note, other, real_estate, private_equity, venture_capital
  - VERSO naming patterns: "VERSO Capital 1 SCSP Series XXX" (SCSP series), "Real Empire Capital Compartment X" (compartments)
  - Virtual parent nodes need `isVirtual: true` flag and synthetic IDs like `virtual-verso-capital-1-scsp`
  - Use numeric sorting for series: `localeCompare(a, b, { numeric: true })` ensures Series 101 < Series 102 < Series 200
---

## 2026-01-26 23:05 - US-004 (Updated 23:30)
- **What was implemented:** Added document counts to folders API using efficient SQL GROUP BY
- **Files changed:**
  - Created `get_folder_document_counts()` PostgreSQL function via Supabase migration:
    - Uses `SELECT folder_id, COUNT(*) GROUP BY folder_id` for efficient aggregation
    - Returns only count rows, not all document data (scales to 100k+ docs)
    - Function marked STABLE and SECURITY DEFINER for performance and RLS bypass
  - `versotech-portal/src/app/api/staff/documents/folders/route.ts` - Modified GET endpoint:
    - Replaced client-side counting with `serviceSupabase.rpc('get_folder_document_counts')`
    - Updated `buildFolderTree()` to accept pre-aggregated Map<folder_id, count>
    - Response shape: `{ ...folder, document_count: number }` for both flat and tree modes
- **Learnings for future iterations:**
  - Use Supabase RPC functions for aggregations that would fetch too much data client-side
  - SQL GROUP BY is far more efficient than fetching all rows and counting in JavaScript
  - Database functions with STABLE modifier allow PostgreSQL query planner optimizations
  - When passing aggregated data, use Map<string, number> instead of raw query results
---

## 2026-01-27 00:15 - US-005
- **What was implemented:** Rendered hierarchical tree with icons and document counts in sidebar
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx` - Major tree rendering updates:
    - Imported `parseVehicleHierarchy`, `VehicleNode` from vehicle-hierarchy module
    - Added `Building2`, `Package` icons from lucide-react for vehicle hierarchy
    - Added `expandedVehicles` state for vehicle expand/collapse tracking
    - Created `vehicleHierarchy` memo using `parseVehicleHierarchy(initialVehicles)`
    - Added `getFoldersForVehicle()` to get folders for a specific vehicle
    - Added `getVehicleDocumentCount()` to sum document counts across vehicle folders
    - Added `filterVehicleHierarchy()` for sidebar search to filter vehicles
    - Created `renderVehicleNode()` function with:
      - Building2 icon (blue) for parent vehicles (fund/securitization)
      - Package icon (amber) for compartments/series
      - Document count display in parentheses
      - Recursive rendering of child vehicles and folders
    - Updated sidebar tree section to render vehicle hierarchy first
    - Added "General Folders" section for orphan folders without vehicle_id
    - Updated sidebar header to "Vehicles & Folders"
- **Learnings for future iterations:**
  - Vehicle hierarchy rendering: Render vehicles first, then their folders as children
  - Icon differentiation: Use Building2 for parent vehicles, Package for children, Folder for regular folders
  - Color coding: Blue (text-blue-500) for parent entities, Amber (text-amber-500) for child entities
  - Separate state for vehicle expansion vs folder expansion (expandedVehicles vs expandedFolders)
  - Filter both vehicle names AND their folder contents when searching the tree
---

## 2026-01-27 01:30 - US-006
- **What was implemented:** Added breadcrumb with vehicle context
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `selectedVehicleId` state to track current vehicle context
    - Created `getVehicleById()` helper to resolve vehicle object from ID
    - Created `currentVehicle` memo that derives vehicle from folder or explicit selection
    - Added `navigateToVehicle()` function for vehicle root navigation
    - Added `handleBreadcrumbVehicleClick()` for breadcrumb vehicle segment clicks
    - Made vehicle nodes in sidebar clickable with `navigateToVehicle(vehicle.id)`
    - Added visual selection state for vehicles (`isVehicleSelected`)
    - Updated `FolderBreadcrumbs` to pass `vehicle` and `onVehicleClick` props
    - Show breadcrumbs when either `currentFolder` or `currentVehicle` is set
- **Learnings for future iterations:**
  - Breadcrumb vehicle context pattern: Track `selectedVehicleId` state separate from folder
  - Derive currentVehicle from: 1) folder's vehicle_id, 2) explicit selection when viewing vehicle root
  - FolderBreadcrumbs already had vehicle support - just needed props passed in
  - Selection highlighting in sidebar: `bg-primary/20 border border-primary` for consistent style
---

## 2026-01-27 02:00 - US-007
- **What was implemented:** Added grid/list view toggle with localStorage persistence
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added useEffect to load viewMode from localStorage on mount (SSR-safe pattern)
    - Added useEffect to save viewMode to localStorage when it changes
    - localStorage key: `staff-docs-view`
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Fixed hardcoded dark theme in toolbar (replaced bg-[#0a0a0a], bg-black/40, border-white/10, text-gray-400 with theme-aware variants)
    - Fixed hardcoded dark theme in SelectContent dropdown
    - Fixed hardcoded dark theme in EmptyState component
    - Created `DocumentListRow` component for table view with columns (name, size, date, actions)
    - Added helper functions: `getDocumentIcon()`, `formatFileSize()`
    - Updated documents section to render either grid or table view based on viewMode
    - Added DropdownMenu imports and actions for document rows
- **Learnings for future iterations:**
  - SSR + localStorage hydration issue: useState initializers run on server where `window` is undefined
  - Correct pattern: Initialize with default, use useEffect to load from localStorage on mount
  - View toggle with Grid3x3 and List icons from lucide-react, use `bg-primary/20 text-primary` for selected state
  - Table view pattern: CSS grid with fixed columns `grid-cols-[1fr_100px_140px_80px]` for responsive table
---

## 2026-01-27 01:20 - US-008
- **What was implemented:** Added document sorting with dropdown, direction toggle, and clickable column headers
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `useSearchParams`, `useRouter`, `usePathname` from next/navigation for URL state
    - Changed `sortBy` type from `'name' | 'date' | 'type'` to `'name' | 'date' | 'size'`
    - Added `sortDir` state with `'asc' | 'desc'` type
    - Changed default sort to `sortBy='date'`, `sortDir='desc'` (newest first)
    - Added `updateSortUrl()` to persist sort params in URL
    - Added `handleSortChange()` with smart direction defaults (date=desc, name/size=asc)
    - Added `handleSortDirChange()` for direct direction changes from dropdown
    - Updated `filteredDocuments` memo to handle direction and size sorting
    - Passed new `sortDir`, `onSortChange`, `onSortDirChange` props to FolderNavigator
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added `ArrowUp`, `ArrowDown` icons from lucide-react
    - Updated interface to include `sortDir` and `onSortDirChange` props
    - Changed default `sortBy` to `'date'` and added `sortDir='desc'`
    - Added sort direction dropdown with Asc/Desc options and arrow icons
    - Made table column headers (Name, Size, Date) clickable buttons
    - Added sort indicator arrows on active column header
    - Headers show hover states and highlight when active
- **Learnings for future iterations:**
  - URL state pattern: Use `useSearchParams` + `useRouter` + `usePathname` to read/write URL params
  - Smart sort defaults: When clicking a new column, use sensible defaults (date=desc for newest first, name/size=asc for A-Z)
  - Toggle sort direction: When clicking same column, toggle between asc/desc
  - Use `router.replace()` with `{ scroll: false }` to update URL without scrolling page
  - Clickable table headers: Use `<button>` elements with flex layout for icon + text
---

## 2026-01-27 03:00 - US-009
- **What was implemented:** Created server-side document search API endpoint
- **Files changed:**
  - `versotech-portal/src/app/api/staff/documents/search/route.ts` - New endpoint:
    - GET handler with required `q` query param for search term
    - Optional `vehicle_id` param for filtering by vehicle
    - Uses `.ilike('name', '%${searchTerm}%')` for case-insensitive matching
    - Joins `document_folders` and `vehicles` tables for context (folder.name, vehicle.name)
    - Returns explicit columns: id, name, type, file_size, status, created_at, updated_at, tags, current_version, document_expiry_date, watermark
    - Pagination with 50 results per page, supports `page` param
    - Response: `{ results: Document[], total: number, pagination: {...}, query, vehicle_id }`
- **Learnings for future iterations:**
  - Supabase `.ilike()` is case-insensitive LIKE operator - use for user-friendly search
  - Always use explicit column selection in search results to avoid leaking sensitive data
  - Join related tables with foreign key hints: `document_folders!documents_folder_id_fkey`
  - Include pagination metadata in response: page, limit, total_pages, has_more
  - Validate required query params early and return 400 with clear error message
---

## 2026-01-27 04:00 - US-010
- **What was implemented:** Implemented search UI with debounced API calls and result display
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `SearchResult` interface for server-side search response
    - Added search state: `globalSearchQuery`, `searchResults`, `isSearching`, `isSearchMode`, `searchTotal`
    - Added `searchDebounceRef` for debounce timer
    - Created `performSearch()` function to call `/api/staff/documents/search` endpoint
    - Created `handleGlobalSearchChange()` with 300ms debounce
    - Created `clearSearch()` to reset search state and return to folder view
    - Updated `onDocumentClick` to handle both search results and regular documents
    - Passed search props to FolderNavigator: `globalSearchQuery`, `onGlobalSearchChange`, `onClearSearch`, `isSearchMode`, `isSearching`, `searchResults`, `searchTotal`
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added `X`, `Loader2`, `ChevronRight` icons from lucide-react
    - Added `SearchResult` interface matching server response
    - Extended FolderNavigatorProps with global search props
    - Updated toolbar search input to use global search with loading spinner and clear button
    - Created `SearchEmptyState` component: "No results for [query]" with clear button
    - Created `SearchResultCard` component for grid view with document path context
    - Created `SearchResultRow` component for list view with location column
    - Added search mode conditional rendering: when searching, shows search results instead of folders/documents
- **Learnings for future iterations:**
  - Debounce pattern: Use `useRef<NodeJS.Timeout | null>` for timer, clear with `clearTimeout()` before setting new timeout
  - Search mode toggle: Use boolean `isSearchMode` state to switch between folder view and search results
  - Path context in search: Join vehicle_name and folder_name with ` > ` for breadcrumb-style display
  - Search results can be displayed in same grid/list view as documents - just create matching components
  - Clear search: Reset all search state (`query`, `results`, `mode`, `total`) in single function
---

## 2026-01-27 05:30 - US-011
- **What was implemented:** Added tree search filter with debounce, auto-expand, and text highlighting
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `debouncedTreeSearch` state for debounced search value
    - Added `treeSearchDebounceRef` for 150ms debounce timer
    - Added `searchExpandedVehicles` and `searchExpandedFolders` sets for auto-expansion
    - Created `handleTreeSearchChange()` with 150ms debounce
    - Created `clearTreeSearch()` to reset all search state
    - Added effect to auto-expand parent vehicles/folders when children match
    - Created `effectiveExpandedVehicles` and `effectiveExpandedFolders` memos combining manual + search expansion
    - Added `highlightText()` helper that wraps matches in `<mark>` with yellow background
    - Updated `renderVehicleNode()` and `renderSidebarTreeNode()` to use effective expanded sets
    - Updated vehicle/folder name rendering to use `highlightText()` when searching
    - Improved empty state: shows search icon, query text, "Try different search term", clear button
    - Updated sidebar search input to use new handlers
- **Learnings for future iterations:**
  - Separate debounced value from input value: `treeSearchQuery` for UI, `debouncedTreeSearch` for filtering
  - Auto-expand pattern: Traverse hierarchy collecting IDs of nodes that match or have matching descendants
  - Keep manual expansion separate from search expansion to restore state when clearing search
  - `<mark>` element is semantic HTML5 for highlighting - screen readers announce it correctly
  - Yellow highlight with dark mode support: `bg-yellow-300 dark:bg-yellow-500/40`
---

## 2026-01-27 02:15 - US-012
- **What was implemented:** Added checkbox selection to documents for bulk operations
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `selectedDocuments` state as `Set<string>` of document IDs
    - Created `toggleDocumentSelection()` handler for individual selection
    - Created `selectAllDocuments()` handler using `filteredDocuments` IDs
    - Created `clearSelection()` handler to reset selection
    - Updated `navigateToFolder()` to clear selection when changing folders
    - Passed selection props to `FolderNavigator`
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added selection props interface: `selectedDocuments`, `onToggleSelection`, `onSelectAll`, `onClearSelection`
    - Added "[N] selected" badge in toolbar using shadcn Badge component
    - Added "Select All" checkbox in Documents section header
    - Added checkbox column to list view table header with responsive grid columns
    - Updated `DocumentListRow` with `isSelected`, `onSelectToggle`, `showCheckbox` props
    - Added checkbox to list rows with `stopPropagation` to prevent preview
    - Added selection highlighting with `bg-primary/5`
  - `versotech-portal/src/components/documents/document-card.tsx`:
    - Added `isSelected` and `onSelectToggle` props to interface
    - Added checkbox rendering with shadcn Checkbox component
    - Added selection highlighting with `bg-primary/5 border-primary/50`
    - Used `stopPropagation` on checkbox wrapper to prevent preview trigger
- **Learnings for future iterations:**
  - Selection state as `Set<string>` provides O(1) add/delete/has operations
  - Use `stopPropagation()` on checkbox click handlers to prevent parent onClick (preview)
  - Clear selection when navigating folders to avoid stale references
  - `selectAllDocuments` must be defined after `filteredDocuments` useMemo (variable ordering matters)
  - Responsive grid columns for checkbox: `grid-cols-[40px_1fr_100px_140px_80px]` vs `grid-cols-[1fr_100px_140px_80px]`
  - Selection count badge uses `bg-primary/10 text-primary border-primary/20` for subtle emphasis
---

## 2026-01-27 06:30 - US-013
- **What was implemented:** Added bulk actions dropdown for selected documents
- **Files changed:**
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added `ChevronDown`, `FolderInput`, `Archive` icon imports from lucide-react
    - Added bulk action props to interface: `onBulkMove`, `onBulkDelete`, `onBulkDownload`
    - Created dropdown menu in toolbar with shadcn DropdownMenu component
    - Button shows "Actions" with ChevronDown icon, disabled when no selection
    - Menu items: "Move to..." (FolderInput icon), "Delete" (Trash2 icon, destructive style), "Download ZIP" (Archive icon)
    - Dropdown uses `asChild` pattern with Button component for proper styling
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `handleBulkMove`, `handleBulkDelete`, `handleBulkDownload` placeholder callbacks
    - Each shows toast notification: "[Action] X document(s) - coming soon"
    - Passed bulk action props to FolderNavigator component
- **Learnings for future iterations:**
  - Bulk actions dropdown pattern: Show button always but disable when `selectedDocuments.size === 0`
  - Use `asChild` prop on DropdownMenuTrigger with Button component for consistent styling
  - Destructive menu items use `className="text-destructive focus:text-destructive"` pattern
  - Placeholder handlers with `toast.info()` provide user feedback while functionality is pending
  - Icon choices: FolderInput for move, Trash2 for delete, Archive for ZIP download
---

## 2026-01-27 08:00 - US-014
- **What was implemented:** Bulk move dialog with folder tree picker
- **Files changed:**
  - `versotech-portal/src/components/documents/bulk-move-dialog.tsx` - New component:
    - Dialog with vehicle hierarchy and folder tree from parseVehicleHierarchy
    - Reuses tree rendering pattern from sidebar for consistent UX
    - Shows progress during move: "Moving X/Y..."
    - Sequential PATCH calls with progress tracking
    - Success toast: "Moved N document(s) to [folder]"
    - Clears selection after move completes
    - Handles partial failures with warning toast
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `bulkMoveDialogOpen` state
    - Updated `handleBulkMove` to open dialog instead of placeholder toast
    - Added `BulkMoveDialog` to component render tree
- **Learnings for future iterations:**
  - Bulk operations with progress: Use sequential API calls (not Promise.all) to show progress "Moving X/Y"
  - Folder picker pattern: Reuse vehicle hierarchy + folder tree rendering for consistent UX
  - Handle partial failures gracefully: Count successes/failures, show appropriate toast (success, warning, or error)
  - Selection clearing: Clear selection after successful operation via callback prop
---

## 2026-01-27 10:30 - US-015
- **What was implemented:** Bulk delete dialog with confirmation and sequential deletion
- **Files changed:**
  - `versotech-portal/src/components/documents/bulk-delete-dialog.tsx` - New component:
    - AlertDialog with destructive styling (AlertTriangle icon, red delete button)
    - Shows "Delete [N] documents? This cannot be undone." message
    - Lists first 5 document names with FileText icons
    - Shows "...and N more" for additional documents
    - Sequential DELETE calls with progress tracking ("Deleting X/Y...")
    - Handles partial failures with appropriate toasts (success, warning, error)
    - Clears selection after operation completes
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added import for `BulkDeleteDialog`
    - Added `bulkDeleteDialogOpen` state
    - Added `selectedDocumentNames` memo to get names of selected documents
    - Updated `handleBulkDelete` to open dialog instead of placeholder toast
    - Added `BulkDeleteDialog` to component render tree with all required props
- **Learnings for future iterations:**
  - Use AlertDialog (not Dialog) for destructive confirmation dialogs - provides proper a11y semantics
  - AlertDialogDescription with `asChild` allows complex content (divs) while maintaining semantics
  - Destructive button styling: Use `variant="destructive"` on Button component
  - Document name lookup: Create a memo that filters `filteredDocuments` by `selectedDocuments` Set
  - Reuse patterns from BulkMoveDialog for consistency: sequential operations, progress tracking, partial failure handling
---

## 2026-01-27 12:00 - US-016
- **What was implemented:** Created bulk download ZIP endpoint for downloading multiple documents
- **Files changed:**
  - `versotech-portal/src/app/api/staff/documents/bulk-download/route.ts` - New endpoint:
    - POST handler accepting `{ document_ids: string[] }` (1-100 documents)
    - Validates staff role (staff_admin, staff_ops, staff_rm, ceo)
    - Fetches document metadata (id, name, file_key) from documents table
    - Filters out external links (documents without file_key)
    - Downloads files from Supabase storage using `serviceSupabase.storage.download()`
    - Creates ZIP using `archiver` package with zlib level 5 compression
    - Handles duplicate filenames by adding suffix (e.g., "file (2).pdf")
    - Returns ZIP with Content-Type: application/zip and Content-Disposition attachment
    - Filename format: `documents-YYYY-MM-DD.zip`
    - Includes headers: X-Documents-Count, X-Errors-Count for client feedback
  - `versotech-portal/package.json` - Added `archiver` dependency
- **Learnings for future iterations:**
  - Use `archiver('zip', { zlib: { level: 5 } })` for balanced compression speed/size
  - Supabase storage download: `.storage.from(bucket).download(file_key)` returns Blob data
  - Convert Blob to Buffer: `Buffer.from(await blob.arrayBuffer())`
  - Collect archive chunks using `archive.on('data', chunk => chunks.push(new Uint8Array(chunk)))`
  - Wait for archive completion: `await archive.finalize()` + promise on `archive.on('end')`
  - Zod v4 uses `.issues` not `.errors` for validation error details
  - Duplicate filename handling: Track used names in Map, append ` (N)` before extension
---

## 2026-01-27 10:45 - US-017
- **What was implemented:** Implemented bulk download ZIP UI functionality
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx` - Updated `handleBulkDownload` callback:
    - Changed from placeholder toast to full async implementation
    - Shows loading toast "Preparing download..." using `toast.loading()`
    - Calls POST `/api/staff/documents/bulk-download` with selected document IDs
    - Handles response blob and extracts filename from Content-Disposition header
    - Creates temporary URL with `URL.createObjectURL()` and triggers browser download
    - Cleans up with `URL.revokeObjectURL()` to free memory
    - Shows success toast with document count from X-Documents-Count header
    - Clears selection after successful download
    - Handles errors with appropriate toast messages
- **Learnings for future iterations:**
  - Browser file download pattern: `response.blob()` → `URL.createObjectURL()` → create `<a>` element → `click()` → `URL.revokeObjectURL()`
  - Always call `URL.revokeObjectURL()` after download to prevent memory leaks
  - Use `toast.loading()` which returns an ID, then `toast.dismiss(id)` for clean loading state management
  - Extract filename from Content-Disposition header with regex: `/filename="([^"]+)"/`
  - Add `clearSelection` to useCallback dependencies when calling it inside the callback
---
