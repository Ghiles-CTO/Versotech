# Ralph Progress Log
Started: Mon Jan 20 2026
PRD: VERSO Admin Portal (ralph/admin-portal)
---

## Codebase Patterns
- Supabase foreign key joins (e.g., `profiles:user_id (...)`) may return arrays in TypeScript types even for single relationships - use `Array.isArray()` check to handle both cases
- UI components use shadcn/ui from @/components/ui/ (Badge, Button, Collapsible, etc.)
- Use cn() utility from @/lib/utils for conditional class names
- Navigation patterns: use `usePathname()` from next/navigation for active route detection
- Admin layout uses dedicated `AdminLayoutContent` (not UnifiedAppLayout) - provides AdminSidebar + custom header with page titles
- Dark mode support via Tailwind dark: prefix classes
- ThemeProvider wraps layout and provides `useTheme()` hook for theme-aware styling
- For route-based page titles, create a mapping function (e.g., `getPageTitle(pathname)`) with exact matches first, then pattern matches
- Next.js file conventions: `loading.tsx` auto-wraps in Suspense, `error.tsx` creates error boundary with `error` and `reset` props
- URL params for filters/state: use `useSearchParams()` + `useRouter().push()` pattern for shareable links
- Reusable KPICard component at `@/components/dashboard/kpi-card.tsx` - supports icons, trends, additionalInfo breakdown, and interactive drill-down with `hasDetails` prop
- Number formatting pattern: use toLocaleString() for counts, custom $XM/$XB formatting for large currency values
- Recharts pattern: Use LineChart with ResponsiveContainer, customize tooltip with a CustomTooltip component, use CartesianGrid with strokeDasharray for subtle grid lines
- API extension pattern: Add new data fetching functions at the bottom of route.ts, include in Promise.all(), destructure result, add to response object
- Lucide icon typing: Use `LucideIcon` type from lucide-react for icon props in interfaces, not `React.ElementType` (avoids className type errors)
- Badge variants: shadcn Badge only supports `default`, `secondary`, `destructive`, `outline` - for custom colors like yellow/warning, use className override
- Data table pattern: Use @tanstack/react-table with useReactTable hook. Define ColumnDef[] with custom header (ArrowUpDown button for sorting) and cell renderers. Wrap in Table/TableHeader/TableBody from shadcn/ui.
- User status derivation: Active = lastLoginAt within 30 days, Pending = never logged in (lastLoginAt null), Inactive = logged in but not recently, Deactivated = isDeleted flag
- Multi-select filter pattern: Use Popover + Command + CommandItem with checkbox styling for multi-select. Pass `selected: string[]` and `onSelect: (values: string[]) => void` props
- Debounce hook pattern: `useDebounce<T>(value: T, delay: number)` using useState + useEffect + setTimeout for search input (300ms is good default)
- API multi-value filters: Support comma-separated values in query params, parse with `.split(',').filter(Boolean)`
- CSV export pattern: Create Blob with text/csv, use temporary anchor element with download attribute, click() and remove
- Fixed action bar pattern: Use `fixed bottom-0 left-0 right-0 z-50` for bottom bar, add `pb-20` padding to content when bar is visible
- AlertDialog controlled pattern: Use `open={state}` + `onOpenChange={setState}` props for programmatic control
- Hook ordering: `useCallback` dependencies must reference functions already declared above them (JavaScript block-scoping)
- Entity type icon mapping: Use `Record<EntityType, LucideIcon>` with icons like Building2 (investor), Users (partner), Scale (lawyer), Handshake (commercial_partner), Globe (introducer), Landmark (arranger)
- Composite React keys: For entities, use `${type}-${id}` since same ID can exist across different entity types
- Activity timeline pattern: Use relative positioning with a vertical line (`absolute left-5 w-px bg-border`) and circular dots (`relative z-10 rounded-full`) for timeline UI
- API pagination pattern: Use `offset`/`limit` query params with `{ count: 'exact' }` in Supabase select for total count, return `hasMore` boolean
- Lazy loading tab content: Use `initialized` state flag + "Load" button to defer data fetching until tab is actually viewed
- Horizontal bar chart pattern: Use Recharts BarChart with `layout="vertical"`, XAxis type="number", YAxis type="category" + dataKey for labels
- Custom donut chart: SVG circles with `strokeDasharray` for segment length and `strokeDashoffset` for starting position (cumulative calculation)
- Semantic color coding for segments: Power Users = emerald (#059669), Regular = blue (#3b82f6), Occasional = amber (#f59e0b), At Risk = red (#ef4444)
- Retention/percentage color gradient: >=70% emerald (good), 40-69% amber (medium), <40% red (poor). For inverse metrics like churn, flip the thresholds
- Cohort matrix pattern: Use CSS grid with n+1 columns (1 for row labels). Gray out future periods with opacity. Color cells by percentage using gradient mapping
- Mailto contact pattern: Encode line breaks as %0D%0A, personalize with first name, include re-engagement messaging in subject/body
- TypeScript forEach type narrowing: `let` variables assigned in `forEach` callbacks lose type narrowing after callback. Use `reduce<T>()` with explicit return type for proper type inference

---

## 2026-01-20 - US-001
- What was implemented: Admin sidebar navigation component with collapsible sub-navigation
- Files changed:
  - src/app/(admin)/versotech_admin/components/admin-sidebar.tsx (NEW)
  - src/app/api/staff/fees/plans/[id]/generate-agreement/route.ts (fixed pre-existing type error)
- **Learnings for future iterations:**
  - The admin components directory didn't exist - created at /src/app/(admin)/versotech_admin/components/
  - Supabase joins can return arrays for single foreign keys in TypeScript - handle with Array.isArray() check
  - Collapsible component from shadcn/ui wraps Radix CollapsiblePrimitive
  - Mobile responsiveness: use fixed positioning for mobile sidebar overlay pattern
---

## 2026-01-20 - US-002
- What was implemented: Integrated admin sidebar into layout with dedicated AdminLayoutContent component
- Files changed:
  - src/app/(admin)/versotech_admin/components/admin-layout-content.tsx (NEW)
  - src/app/(admin)/versotech_admin/layout.tsx (MODIFIED - switched from UnifiedAppLayout to AdminLayoutContent)
- **Learnings for future iterations:**
  - Admin portal needs its own layout component separate from UnifiedAppLayout (which is for investor/staff portal)
  - Use `getPageTitle(pathname)` pattern for dynamic page titles - check exact matches first, then use regex patterns for dynamic routes like /users/[id]
  - Header utilities (ThemeToggle, NotificationCenter, IdentityMenu) can be imported from @/components/layout/
  - AdminSidebar already has mobile hamburger menu built-in with fixed positioning - coordinate header padding (`pl-12 md:pl-0`) to avoid overlap
  - ThemeProvider is needed to wrap the layout for useTheme() hook to work
---


## 2026-01-20 - US-003
- What was implemented: Updated admin root page redirect from /settings to /dashboard
- Files changed:
  - src/app/(admin)/versotech_admin/page.tsx (MODIFIED - changed redirect destination)
- **Learnings for future iterations:**
  - The admin page already used Next.js `redirect()` from `next/navigation` - just needed destination change
  - Server Components (no 'use client') with redirect() provide true server-side redirects (HTTP 307/308) without client-side flashes
---

## 2026-01-20 - US-004
- What was implemented: Dashboard page structure with Platform Overview title, date range selector, loading skeleton, and error boundary
- Files changed:
  - src/app/(admin)/versotech_admin/dashboard/page.tsx (NEW)
  - src/app/(admin)/versotech_admin/dashboard/dashboard-skeleton.tsx (NEW)
  - src/app/(admin)/versotech_admin/dashboard/loading.tsx (NEW)
  - src/app/(admin)/versotech_admin/dashboard/error.tsx (NEW)
- **Learnings for future iterations:**
  - Next.js App Router file conventions: `loading.tsx` wraps page in Suspense automatically, `error.tsx` creates error boundary
  - URL search params in client components: use `useSearchParams()` hook with `useRouter()` and `usePathname()` to update params
  - Date range selector pattern: store in URL params for shareable links, default to '30' days
  - `DashboardSkeleton` component is reusable across loading.tsx and Suspense fallbacks
  - Error boundary receives `error` and `reset` props - `reset()` retries the render
---

## 2026-01-20 - US-005
- What was implemented: Dashboard KPI cards displaying key metrics with responsive layout
- Files changed:
  - src/app/(admin)/versotech_admin/dashboard/components/dashboard-kpi-cards.tsx (NEW)
  - src/app/(admin)/versotech_admin/dashboard/page.tsx (MODIFIED - integrated DashboardKPICards)
- **Learnings for future iterations:**
  - Existing KPICard component at `@/components/dashboard/kpi-card.tsx` is highly reusable - supports icons, trends, breakdowns, and interactive features
  - Dashboard metrics API at `/api/admin/metrics/dashboard` returns structured KPIs: aum, revenue, investors, deals, pending items
  - Number formatting: Use `value.toLocaleString()` for counts, custom function for currency (e.g., `$45.2M` for millions, `$1.2B` for billions)
  - Dashboard component files should be in a `components/` subdirectory for organization
  - API response typing: Create interfaces matching the API response structure for type safety in useState hooks
---

## 2026-01-20 - US-006
- What was implemented: Dashboard activity chart showing daily active users with Recharts LineChart
- Files changed:
  - src/app/(admin)/versotech_admin/dashboard/components/dashboard-activity-chart.tsx (NEW)
  - src/app/(admin)/versotech_admin/dashboard/page.tsx (MODIFIED - integrated DashboardActivityChart)
  - src/app/api/admin/metrics/dashboard/route.ts (MODIFIED - added fetchUserActivityTrend, days query param)
- **Learnings for future iterations:**
  - Recharts LineChart with ResponsiveContainer handles responsive sizing automatically
  - Custom tooltip components receive `active` and `payload` props - payload[0].payload contains the data point
  - For daily active users, query audit_logs grouped by date using Set to track unique user IDs per day
  - API can accept query params by destructuring URL: `const { searchParams } = new URL(request.url)`
  - Initialize date range with empty Sets for all days to ensure continuous x-axis even with no activity
  - Use hsl(var(--primary)) for theme-aware stroke colors in charts
---

## 2026-01-21 - US-007
- What was implemented: Dashboard approval queue widget showing pending KYC reviews, subscriptions, and documents
- Files changed:
  - src/app/(admin)/versotech_admin/dashboard/components/dashboard-approval-queue.tsx (NEW)
  - src/app/(admin)/versotech_admin/dashboard/page.tsx (MODIFIED - integrated DashboardApprovalQueue)
- **Learnings for future iterations:**
  - Use `LucideIcon` type from lucide-react for icon props instead of `React.ElementType` - avoids TypeScript errors with className prop
  - Dashboard API `kpis.pending` provides: approvals, tasks, kyc counts - map to user-friendly labels (KYC Review, Subscriptions, Documents)
  - Card component from shadcn/ui provides CardHeader, CardTitle, CardContent for consistent layout
  - Use `cn()` for conditional styling with visual indicators (e.g., highlight items with count > 0)
  - Link component from next/link for navigation between admin pages
---

## 2026-01-21 - US-008
- What was implemented: Dashboard recent activity feed showing last 10 platform activities with relative timestamps
- Files changed:
  - src/app/(admin)/versotech_admin/dashboard/components/dashboard-activity-feed.tsx (NEW)
  - src/app/(admin)/versotech_admin/dashboard/page.tsx (MODIFIED - integrated DashboardActivityFeed)
- **Learnings for future iterations:**
  - Use `formatDistanceToNow(date, { addSuffix: true })` from date-fns for human-readable relative timestamps like "2 hours ago"
  - Action descriptions from audit logs need transformation - create a mapping function that converts actions like `KYC_APPROVE` to "Approved KYC"
  - Scrollable containers: use `max-h-[Xpx]` with `overflow-y-auto` for fixed-height scrollable areas
  - Activity feed API at `/api/admin/activity-feed` returns audit_logs with `actor_name`, `action`, `entity_type`, `timestamp`
  - For action description fallback, split action by underscore and use verb mapping to construct readable text
---

## 2026-01-21 - US-009
- What was implemented: Dashboard compliance alerts widget with severity grouping and collapsible sections
- Files changed:
  - src/app/(admin)/versotech_admin/dashboard/components/dashboard-compliance-alerts.tsx (NEW)
  - src/app/(admin)/versotech_admin/dashboard/page.tsx (MODIFIED - integrated DashboardComplianceAlerts)
- **Learnings for future iterations:**
  - Compliance alerts API at `/api/admin/compliance/alerts` returns alerts with severity levels: critical, high, medium, low
  - Badge component variants are limited to: default, secondary, destructive, outline - no 'warning' variant. Use className for custom colors
  - Collapsible component from shadcn/ui (`@/components/ui/collapsible.tsx`) wraps Radix CollapsiblePrimitive - use CollapsibleTrigger + CollapsibleContent
  - For severity grouping pattern: create SeverityGroup interface with colorClass, bgClass, borderClass for consistent styling
  - Empty state ("All Clear") should be visually distinct with green checkmark and positive messaging
  - When alerts exist, auto-expand the critical section using `defaultOpen` prop on Collapsible
---

## 2026-01-21 - US-010
- What was implemented: Users list page with searchable, filterable data table
- Files changed:
  - src/app/(admin)/versotech_admin/users/page.tsx (NEW)
- **Learnings for future iterations:**
  - Admin users API at `/api/admin/users` returns `UserRow[]` with pagination. Key fields: id, displayName, email, systemRole, lastLoginAt, createdAt, isDeleted, isSuperAdmin, entities[], kyc
  - For status badges, derive from data: Active = lastLoginAt within 30 days, Pending = never logged in, Inactive = no recent login, Deactivated = isDeleted
  - @tanstack/react-table provides useReactTable hook for powerful table features. Use ColumnDef with custom header (Button with ArrowUpDown icon for sorting), cell renderers for complex cells
  - Server-side pagination pattern: fetch with page/pageSize params, display "Showing X-Y of Z users" using calculated startIndex/endIndex
  - Avatar + name column: use Avatar/AvatarImage/AvatarFallback from shadcn/ui, compute initials with split+map+join pattern
  - Row selection: use RowSelectionState type, getRowId must return unique row.id for selection to work properly
  - Actions dropdown: Use DropdownMenu with DropdownMenuContent/MenuItem/Label/Separator from shadcn/ui for consistent UX
---

## 2026-01-21 - US-011
- What was implemented: Search and filter functionality for users list page
- Files changed:
  - src/app/(admin)/versotech_admin/users/page.tsx (MODIFIED - added search, filters, URL sync)
  - src/app/api/admin/users/route.ts (MODIFIED - extended to support multi-value filters and status filter)
- **Learnings for future iterations:**
  - Multi-select filter pattern: Use Popover + Command + Checkbox pattern from shadcn/ui. Create a reusable `MultiSelectFilter` component
  - Debounce pattern: Create `useDebounce<T>` hook with `useState` + `useEffect` + `setTimeout` for delayed state updates
  - URL param sync pattern: Use `useSearchParams()` + `useRouter()` + `usePathname()` to sync filter state with URL for shareable links
  - API multi-value filter: Support comma-separated values in query params, split with `.split(',').filter(Boolean)` in API route
  - Status filter is derived server-side: active (lastLoginAt within 30 days), pending (never logged in), inactive (no recent login), deactivated (isDeleted)
  - Active filters display: Show badges with X button for each active filter, makes it clear what's filtering the list
---

## 2026-01-21 - US-012
- What was implemented: Batch actions for users list (export CSV, deactivate with confirmation)
- Files changed:
  - src/app/(admin)/versotech_admin/users/page.tsx (MODIFIED - added batch action bar, AlertDialog, CSV export)
- **Learnings for future iterations:**
  - AlertDialog uses controlled pattern: `open={state}` + `onOpenChange={setState}` for programmatic open/close
  - CSV export: Create Blob with `text/csv;charset=utf-8;` MIME type, create temporary anchor with download attr, click() and remove()
  - Fixed bottom action bar: Use `fixed bottom-0 left-0 right-0 z-50` classes, add `pb-20` padding to content when bar visible
  - Hook ordering is critical: `useCallback` with dependencies must be defined AFTER the functions they depend on (fetchUsers must be defined before handleDeactivateUsers)
  - Use `useMemo` for derived state like `selectedUsers` to avoid recomputing on every render
---

## 2026-01-21 - US-013
- What was implemented: User detail page with header card showing user info and admin actions
- Files changed:
  - src/app/(admin)/versotech_admin/users/[id]/page.tsx (NEW)
- **Learnings for future iterations:**
  - User detail API at `/api/admin/users/[id]` returns full UserRow with entities array, KYC data, and profile fields
  - Reuse status/role badge styling patterns from the users list page - extract to helper functions for consistency
  - Actions pattern: Deactivate/Reactivate and Lock/Unlock both use the same `deleted_at` soft-delete mechanism in profiles table
  - Reset password sends email via Resend service - cannot reset password for deactivated users
  - Toast notifications use `sonner` package with `toast.success()` and `toast.error()` for action feedback
  - Multiple AlertDialogs on same page: use separate state variables for each (deactivateDialogOpen, lockDialogOpen, etc.)
  - Dynamic route params in Next.js 15: use `useParams()` hook and cast to string: `const userId = params.id as string`
---

## 2026-01-21 - US-014
- What was implemented: User detail profile tab with edit functionality
- Files changed:
  - src/app/(admin)/versotech_admin/users/[id]/page.tsx (MODIFIED - added tabs, Profile tab content, edit dialog)
- **Learnings for future iterations:**
  - Tabs component: Use `Tabs` with `TabsList`/`TabsTrigger`/`TabsContent` from shadcn/ui - wraps Radix primitives
  - Tab responsive design: Use grid layout for mobile (hidden text, show icons only) with `hidden sm:inline` pattern
  - Edit form pattern: Use react-hook-form with `zodResolver(schema)` for validation. Key methods: `register()`, `handleSubmit()`, `reset()`, `formState: { errors }`
  - Pre-populate form on dialog open: Call `reset({ field1: value1, ... })` in the open handler to populate form with current values
  - Optional form fields with zod: Use `.optional().or(z.literal(''))` to allow empty strings alongside optional values
  - Convert empty strings to null for API: Transform empty form values to `null` before sending to API (PATCH)
  - Dialog vs AlertDialog: Use Dialog for forms/content, AlertDialog for confirmations with action buttons
  - date-fns format function: Use `format(date, 'MMM d, yyyy')` for absolute dates alongside `formatDistanceToNow` for relative
---

## 2026-01-21 - US-015
- What was implemented: User detail entities tab showing linked entities with management actions
- Files changed:
  - src/app/(admin)/versotech_admin/users/[id]/page.tsx (MODIFIED - replaced entities tab placeholder with full implementation)
- **Learnings for future iterations:**
  - Entity type icon mapping pattern: Create `Record<EntityType, LucideIcon>` mapping (e.g., investor→Building2, partner→Users, lawyer→Scale)
  - Entity type display labels: Create separate `Record<EntityType, string>` for human-readable labels (e.g., 'commercial_partner'→'Commercial Partner')
  - Table component pattern: Import Table/TableHeader/TableBody/TableRow/TableCell/TableHead from shadcn/ui for consistent table styling
  - Placeholder dialog pattern: For features coming soon, show disabled input + centered content with icon, "Coming soon" text, and brief description
  - Remove confirmation pattern: Store `entityToRemove` in state, pass to AlertDialog description for personalized confirmation message
  - Composite unique key for entities: Use `${entity.type}-${entity.id}` for React keys since same entity ID could exist across different entity types
---

## 2026-01-21 - US-016
- What was implemented: User detail activity tab with timeline view, filtering, pagination, and CSV export
- Files changed:
  - src/app/(admin)/versotech_admin/users/[id]/page.tsx (MODIFIED - replaced activity tab placeholder with full implementation)
  - src/app/api/admin/users/[id]/activity/route.ts (MODIFIED - extended to support pagination, filtering, and return actionTypes list)
- **Learnings for future iterations:**
  - Activity API extended with `offset`, `limit`, and `action` query params for pagination and filtering
  - Use `{ count: 'exact' }` in Supabase select to get total count for pagination calculations
  - Return `hasMore` boolean (offset + limit < total) and `actionTypes` list for filter dropdown population
  - Timeline UI pattern: vertical line with `absolute left-5 w-px bg-border`, dots with `relative z-10 rounded-full bg-background border-2`
  - Lazy loading for tab content: Use `activityInitialized` flag + "Load Activity" button to defer API call until tab is viewed
  - Select component from shadcn/ui for action type filter - use `value="all"` for "show all" option
  - Action description formatting: Map raw action verbs (LOGIN, CREATE, UPDATE) to past tense (Logged in, Created, Updated)
  - CSV export includes: Timestamp (ISO), Action, Entity Type, Entity ID, IP Address
  - Empty state should be context-aware: different messages for "no activity" vs "no matching filtered results"
---

## 2026-01-21 - US-017
- What was implemented: User detail Security tab with full admin controls
- Files changed:
  - src/app/(admin)/versotech_admin/users/[id]/page.tsx (MODIFIED - replaced security tab placeholder with full implementation)
- **Learnings for future iterations:**
  - Switch component from shadcn/ui (`@/components/ui/switch`) provides toggle control - use `checked` and `onCheckedChange` props
  - Lock and Deactivate both use `deleted_at` column (same soft-delete mechanism) - the codebase treats them as equivalent
  - Security data (sessions, failed logins) derived from audit_logs via activity API with action filters
  - Lazy loading pattern for tab content: use `securityInitialized` flag + "Load" button to defer expensive queries until tab is viewed
  - For session count: count LOGIN actions from audit_logs in last 30 days (approximate active sessions)
  - For failed logins: count LOGIN_FAILED actions in last 24 hours, show severity indicator if count > 5
  - API self-action prevention (can't deactivate yourself) is handled server-side - no need for client-side check
  - Icons for security: Power (status), Lock/Unlock (lock), KeyRound (password), MonitorSmartphone (sessions), ShieldOff (revoke), AlertTriangle (failed logins)
---

## 2026-01-21 - US-018
- What was implemented: Staff users sub-page with dedicated data table showing staff-specific fields
- Files changed:
  - src/app/(admin)/versotech_admin/users/staff/page.tsx (NEW)
  - src/app/api/admin/staff/route.ts (MODIFIED - added assigned_investors and activity_score_7d)
- **Learnings for future iterations:**
  - Investors table has `primary_rm` and `secondary_rm` UUID columns for relationship manager assignment - use these to count assigned investors per staff
  - Activity score can be derived from audit_logs count in last 7 days grouped by actor_id
  - Staff permissions formatting: filter out 'super_admin' for display, show "Super Admin" separately, truncate to 3 items with "+N more"
  - Activity score color coding pattern: 0 = muted, <10 = yellow, <50 = blue, >=50 = green
  - Stats cards at top provide quick overview: total, active, invited, super admins
  - Staff status is simpler than users: 'active' (password_set true) or 'invited' (password_set false)
---

## 2026-01-21 - US-019
- What was implemented: Growth overview API endpoint for growth analytics metrics
- Files changed:
  - src/app/api/admin/growth/overview/route.ts (NEW)
- **Learnings for future iterations:**
  - DAU/WAU/MAU calculation uses Set to efficiently track unique users from audit_logs
  - Stickiness ratio (DAU/MAU * 100) is a standard product analytics metric - higher values mean more engaged users
  - Session duration can be estimated from audit log timestamps by grouping actions per user-day and calculating first-to-last action time
  - User segmentation by activity frequency: Power Users (50+ actions), Regular (10-49), Occasional (2-9), At Risk (1 action only)
  - Feature usage derived from action types in audit_logs - use formatFeatureName() helper to convert SNAKE_CASE actions to readable titles
  - Days query param validation: use allowlist [7, 30, 90] with fallback to 30 instead of min/max clamping for cleaner API contract
---

## 2026-01-21 - US-020
- What was implemented: Growth overview page with KPI cards, line chart, bar chart, and donut chart
- Files changed:
  - src/app/(admin)/versotech_admin/growth/page.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/loading.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/error.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/components/growth-overview-skeleton.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/components/growth-kpi-cards.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/components/active-users-trend-chart.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/components/feature-usage-chart.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/components/user-segments-chart.tsx (NEW)
- **Learnings for future iterations:**
  - Recharts BarChart with `layout="vertical"` creates horizontal bar chart - set type="number" for XAxis and type="category" for YAxis
  - Custom SVG donut chart pattern: use `strokeDasharray` and `strokeDashoffset` on circles to create segments, calculate offset cumulatively
  - User segment colors: semantic coloring (green for Power Users, red for At Risk) makes data easier to interpret at a glance
  - 5-column KPI grid: use `lg:grid-cols-5` for 5 cards in a row on desktop, `sm:grid-cols-2` for mobile stacking
  - Recharts Cell component allows setting individual bar colors in BarChart - pass fill prop with gradient from dark to light
  - Interactive donut: track `hoveredIndex` state and sync between SVG segments and legend items for coordinated highlighting
---

## 2026-01-21 - US-021
- What was implemented: Engagement API endpoint for engagement metrics analytics
- Files changed:
  - src/app/api/admin/growth/engagement/route.ts (NEW)
- **Learnings for future iterations:**
  - Day of week calculation: Use `Date.getDay()` which returns 0=Sunday through 6=Saturday - map to DAY_NAMES array for human-readable labels
  - Hour calculation: Use `Date.getHours()` which returns 0-23 (server timezone) - initialize all 24 hours to 0 before counting
  - Session counting pattern: Track unique dates per user with `Set<string>` of date keys (YYYY-MM-DD) - size gives session count
  - Top engaged users: Sort by action count descending, slice top 10, then batch-fetch profiles with `.in('id', topUserIds)` for display names
  - Action name formatting: Reuse `formatActionName()` helper pattern from overview API for consistent display across growth pages
---

## 2026-01-21 - US-022
- What was implemented: Engagement page with charts and table for detailed engagement analytics
- Files changed:
  - src/app/(admin)/versotech_admin/growth/engagement/page.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/engagement/loading.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/engagement/error.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/engagement/components/engagement-skeleton.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/engagement/components/actions-type-chart.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/engagement/components/engagement-by-day-chart.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/engagement/components/peak-hours-chart.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/engagement/components/top-engaged-users-table.tsx (NEW)
- **Learnings for future iterations:**
  - Day reordering pattern: API returns days 0=Sunday through 6=Saturday, but UI should show Mon-Sun. Sort with: `a.day === 0 ? 6 : a.day - 1`
  - Weekday vs weekend visual distinction: Use opacity variation on primary color (full opacity for weekdays, 50% for weekends)
  - Peak hours business hours indicator: Use Recharts ReferenceLine to add vertical markers at 9am and 5pm boundaries
  - Hour formatting: 12am special case (hour 0), 12pm special case (hour 12), then am/pm suffix based on < or >= 12
  - Rank icon pattern: Use different Lucide icons for top 3 (Trophy gold, Medal silver, Award bronze) and numbers for rest
  - Table avg calculation: Calculate derived metrics like avgActionsPerSession directly in map function for simplicity
  - Link to user details: Top engaged users table links to /versotech_admin/users/{id} for drill-down
---

## 2026-01-21 - US-023
- What was implemented: Retention API endpoint for retention metrics analytics
- Files changed:
  - src/app/api/admin/growth/retention/route.ts (NEW)
- **Learnings for future iterations:**
  - Retention rate calculation pattern: Compare users active in period X (e.g., 7-14 days ago) with users still active in recent period (last 7 days)
  - Cohort matrix: Group users by signup week, track activity in weeks 0-4 after signup. Use `userActivityDates` map with Set of dates for efficient lookup
  - At-risk users: Filter by `activity.last < day30Ago`, then enrich with profile info and total invested via investor_users → subscriptions → sum(commitment)
  - Investment total calculation: Join user → investor_users → subscriptions, filter by active/funded/completed status, sum commitment field
  - formatWeekLabel helper: Use `toLocaleString('en-US', { month: 'short' })` + getDate() for "Jan 14" style labels
  - Churn rate = users inactive 30+ days / total active users in 90-day window
  - Performance consideration: Limit at-risk users to 50 in query, sort by totalInvested descending to prioritize high-value users
---

## 2026-01-21 - US-024
- What was implemented: Retention page with KPI cards, cohort matrix, and at-risk users table
- Files changed:
  - src/app/(admin)/versotech_admin/growth/retention/page.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/retention/loading.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/retention/error.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/retention/components/retention-skeleton.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/retention/components/retention-kpi-cards.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/retention/components/cohort-matrix.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/retention/components/at-risk-users-table.tsx (NEW)
- **Learnings for future iterations:**
  - Retention KPI color coding: Use semantic colors - green for good retention (>=70%), amber for medium (40-69%), red for poor (<40%). For churn rate, invert the logic (lower is better)
  - Cohort matrix visualization: Use CSS grid with 6 columns (1 for cohort label, 5 for weeks). Gray out cells that represent time periods that haven't elapsed yet
  - Cohort matrix color gradient: Map retention percentages to colors: >=70% emerald-500, >=50% emerald-400, >=30% amber-400, >=10% orange-400, <10% red-400
  - At-risk users mailto pattern: Encode email body with %0D%0A for line breaks in mailto URLs. Include personalization (first name) and re-engagement message
  - Table vs CSS grid: Use shadcn/ui Table component for data tables with proper semantics - provides TableHeader, TableBody, TableRow, TableCell, TableHead
  - Empty state for positive outcomes: When no at-risk users exist, show positive messaging ("Great news!") with celebratory styling (emerald colors)
  - Component organization: Place all page components in a components/ subdirectory for cleaner imports and separation of concerns
---

## 2026-01-21 - US-025
- What was implemented: Funnel API endpoint for investment and onboarding funnel analytics
- Files changed:
  - src/app/api/admin/growth/funnel/route.ts (NEW)
- **Learnings for future iterations:**
  - Investment funnel uses deal_memberships table: `viewed_at` for "Viewed Deal", `interest_confirmed_at` for "Showed Interest"
  - Multiple interest signals: Combine investor_deal_interest table and deal_memberships.interest_confirmed_at for complete interest tracking
  - Onboarding funnel: profiles.created_at (Account Created), profiles.display_name (Profile Completed), investors.kyc_status (KYC stages)
  - Funnel percentage calculation: pctOfTotal = count/total*100, pctOfPrevious = count/previousCount*100 (index 0 is always 100%)
  - Biggest drop-off detection: Iterate through stages, calculate (100 - pctOfPrevious), track max drop. Skip stages with 0 count to avoid misleading results
  - Use Set<string> for unique investor counting when combining data from multiple sources
---

## 2026-01-21 - US-026
- What was implemented: Funnel page with Investment and Onboarding funnel visualizations plus Drop-off Analysis
- Files changed:
  - src/app/(admin)/versotech_admin/growth/funnel/page.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/funnel/loading.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/funnel/error.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/funnel/components/funnel-skeleton.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/funnel/components/investment-funnel.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/funnel/components/onboarding-funnel.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/funnel/components/dropoff-analysis.tsx (NEW)
- **Learnings for future iterations:**
  - Funnel bar width pattern: Calculate width as `(count / maxCount) * 100%` but use minimum 5% for visibility of small values
  - Conversion rate badge thresholds: >=50% emerald (good), 25-49% amber (medium), <25% red (poor) - standard industry benchmarks
  - Two-column layout for funnels: Use `grid-cols-1 lg:grid-cols-2` for side-by-side funnels on desktop
  - Color scheme differentiation: Investment funnel uses blue gradient, Onboarding uses violet gradient - helps distinguish at a glance
  - Drop-off severity mapping: >=70% critical (red), >=50% high (orange), >=30% medium (amber), <30% minor (blue)
  - Actionable insights in UI: Add contextual help text based on severity levels to guide admin actions
  - Funnel skeleton pattern: Use decreasing widths [100, 75, 50, 35, 20]% to simulate funnel shape in loading state
  - TypeScript reduce pattern for forEach callback narrowing: When `let` variables assigned in forEach callbacks lose type narrowing, refactor to `reduce<T>` with explicit return type for proper type inference
---

## 2026-01-21 - US-027
- What was implemented: Cohorts API endpoint for cohort-based analytics with multiple grouping options
- Files changed:
  - src/app/api/admin/growth/cohorts/route.ts (NEW)
- **Learnings for future iterations:**
  - TypeScript type narrowing in callbacks: `let` variables assigned inside `forEach` callbacks lose type narrowing after the callback. Fix by using `reduce<T>()` with explicit generic type parameter
  - Cohort grouping key patterns: Use sortable keys like `YYYY-WXX` (week) and `YYYY-MM` (month) that can be sorted chronologically, then format for display with separate function
  - Retention at checkpoint pattern: Check if user was active within a 7-day window around the checkpoint date, not just "after" - gives more meaningful retention signal
  - Return `-1` for retention metrics where not enough time has passed (e.g., 90-day retention for a 30-day old cohort) - UI can handle as "N/A"
  - Mapping user → investor → subscription: Use intermediate `userToInvestors` and `investorFirstSubscription` maps for efficient lookups when calculating avgTimeToFirstInvestment
  - Week number calculation: `Math.ceil((dayOfYear + 1) / 7)` using day offset from January 1st
---

## 2026-01-21 - US-028
- What was implemented: Cohorts page with grouping selector and sortable data table
- Files changed:
  - src/app/(admin)/versotech_admin/growth/cohorts/page.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/cohorts/components/cohorts-data-table.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/cohorts/components/cohorts-skeleton.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/cohorts/loading.tsx (NEW)
  - src/app/(admin)/versotech_admin/growth/cohorts/error.tsx (NEW)
- **Learnings for future iterations:**
  - Cohorts data table pattern: Use @tanstack/react-table with SortingState for client-side sortable columns. Each column header uses Button with ArrowUpDown icon for toggle
  - Summary stats above table: Provide aggregate metrics (total users, avg rates) at top for quick overview before diving into detailed table
  - Retention N/A handling: API returns -1 for retention where not enough time has passed. Display as "N/A" with muted-foreground styling
  - Rate color coding pattern: Use semantic colors - emerald for good (>=50%), amber for medium (25-49%), red for poor (<25%) for consistent visual language
  - Cohort grouping URL params: Use `groupBy` param synced to URL for shareable links and browser back/forward support
  - getSortedRowModel from @tanstack/react-table enables client-side sorting without additional API calls
---

## 2026-01-21 - US-029
- What was implemented: Agents placeholder page with AI automation feature preview
- Files changed:
  - src/app/(admin)/versotech_admin/agents/page.tsx (NEW)
- **Learnings for future iterations:**
  - Placeholder page pattern: Hero section (icon + heading + subtext) + feature cards grid + CTA link for consistent "coming soon" pages
  - Extensible status system: Use typed status enum ('planned' | 'in-development' | 'beta') with separate mappings for badge variants and display labels - allows easy updates as features progress
  - LucideIcon type import: Use `type LucideIcon` instead of `React.ComponentType<{className?: string}>` for proper icon prop typing in interfaces
  - Card visual interest: Add subtle gradient overlay (`bg-gradient-to-bl from-primary/5 to-transparent`) in top-right corner for depth without distraction
  - Mailto link encoding: Use %20 for spaces in subject, standard email format for product feedback links (e.g., `mailto:product@domain.com?subject=Feature%20Request`)
  - Min-height pattern: Use `min-h-[calc(100vh-8rem)]` for centered content that accounts for header/nav height
---
