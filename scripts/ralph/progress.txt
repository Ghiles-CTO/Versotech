# Ralph Progress Log
Started: Mon Jan 26 22:04:55 CET 2026
---

## Codebase Patterns
- Use shadcn theme variables for theme-aware styling: `bg-background`, `text-foreground`, `text-muted-foreground`, `border-border`, `bg-muted`, `bg-card`, `bg-accent`, `text-primary`, `text-destructive`
- For hover states use: `hover:bg-muted`, `hover:bg-accent`
- For selection states use: `bg-primary/20 border-primary`
- shadcn Button component already handles theme - don't add custom text/border colors
- DropdownMenuContent doesn't need custom bg/border styling - shadcn handles it
- Responsive sidebar pattern: `grid-cols-1 lg:grid-cols-[280px_1fr]` with `hidden lg:flex` for desktop-only sidebar
- Vehicle hierarchy parsing: Use `parseVehicleHierarchy()` from `@/lib/documents/vehicle-hierarchy` to group vehicles by parent (fund/securitization → children) and create virtual SCSP parent nodes for Series vehicles
- Supabase aggregations: Use RPC functions with SQL `GROUP BY` for count/sum operations on large tables. Example: `serviceSupabase.rpc('get_folder_document_counts')` returns pre-aggregated counts instead of fetching all rows
- Breadcrumb vehicle context: Track `selectedVehicleId` state alongside `currentFolderId`, derive `currentVehicle` from folder's vehicle_id OR explicit selection. FolderBreadcrumbs accepts `vehicle` and `onVehicleClick` props.
- SSR-safe localStorage pattern: Initialize useState with default value, then use `useEffect(() => { const saved = localStorage.getItem(key); if (saved) setState(saved) }, [])` to load on client mount. Avoid using localStorage in useState initializer (doesn't work with SSR/hydration).
- URL state persistence pattern: Use `useSearchParams()` + `useRouter()` + `usePathname()` from next/navigation. Read params on mount with useEffect, update with `router.replace(\`\${pathname}?\${params.toString()}\`, { scroll: false })` to avoid page scroll.
- Server-side search pattern: Use `.ilike('column', '%${searchTerm}%')` for case-insensitive search. Join related tables in same query with explicit column selection for context (e.g., folder.name, vehicle.name). Limit 50 results with pagination for scalability.
- Debounce pattern: Use `const timerRef = useRef<NodeJS.Timeout | null>(null)` with `clearTimeout(timerRef.current)` before `timerRef.current = setTimeout(() => action(), 300)`. Clean up on unmount with `useEffect(() => () => clearTimeout(timerRef.current), [])`.
- Tree search with auto-expand: Separate `inputValue` from `debouncedValue` state. Use effect to find matching nodes and their ancestors, store in `searchExpanded` set. Combine with manual `expanded` set using `effectiveExpanded = new Set([...expanded, ...searchExpanded])`. Clear `searchExpanded` when search is cleared.
- Text highlighting pattern: Create `highlightText(text, query)` helper that returns `<>{before}<mark className="bg-yellow-300 dark:bg-yellow-500/40">{match}</mark>{after}</>` using case-insensitive indexOf.
- Bulk actions dropdown pattern: Use DropdownMenu with disabled button when `selectedDocuments.size === 0`. Pass callbacks like `onBulkMove`, `onBulkDelete`, `onBulkDownload`. Destructive items use `className="text-destructive focus:text-destructive"`.
- Bulk operations with progress: For multi-item operations, use sequential API calls (not Promise.all) to show progress "Processing X/Y...". Track success/fail counts and show appropriate toast (success if all pass, warning if partial, error if all fail).
- ZIP streaming response pattern: Use `archiver` package - collect chunks via `archive.on('data')`, finalize with `archive.finalize()`, wait for `archive.on('end')`, then return `new NextResponse(buffer, { headers: { 'Content-Type': 'application/zip', 'Content-Disposition': 'attachment; filename="..."' } })`.
- Tree folder drag-drop pattern: Track `treeDragOverFolderId` state for highlight, use `e.relatedTarget` check in dragLeave to avoid flickering. Apply `ring-2 ring-primary bg-primary/10` class when dragging over. On drop, validate files, set target folder state, then open upload dialog.
- Tag badges with overflow pattern: Use `TagBadges` component from `@/components/documents/tag-badges` with `maxVisible` prop. Returns null for empty tags. Shows "+N" badge with Tooltip for overflow. Slate colors for neutral non-semantic appearance.
- Popover-in-dropdown pattern: To open a Popover from a DropdownMenuItem, use `onSelect={(e) => e.preventDefault()}` on the MenuItem to prevent dropdown from closing. Pass the MenuItem as the Popover's `trigger` prop.
- Hidden file input pattern: Use `useRef<HTMLInputElement>` + hidden `<input type="file">`, trigger with `ref.current?.click()`. Reset with `ref.current.value = ''` to allow re-selecting same file. Use `accept=".pdf,.docx,..."` for file type filtering.
- RefreshKey pattern for child components: Add `refreshKey?: number` prop, include in useEffect deps. Parent increments to trigger child refetch without remounting: `setRefreshKey(prev => prev + 1)`.

## 2026-01-26 22:15 - US-001
- **What was implemented:** Fixed hardcoded dark theme in staff documents page
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx` - Replaced bg-[#0a0a0a], bg-black/40, border-white/10, text-white with theme-aware variants
  - `versotech-portal/src/components/documents/folder-tree.tsx` - Replaced hover:bg-gray-700, text-gray-300/400 with theme-aware variants
  - `versotech-portal/src/components/documents/document-card.tsx` - Replaced bg-white, text-gray-900, border-gray-200 with theme-aware variants
- **Learnings for future iterations:**
  - The staff documents page had fully hardcoded dark theme classes forcing dark mode regardless of system settings
  - shadcn components (Button, DropdownMenu) handle theming internally - don't override with custom colors
  - Icon colors can use semantic colors like `text-blue-500` for vehicle roots, `text-green-500` for categories (these are intentional differentiation, not theme colors)
  - The amber warning button uses `dark:text-amber-400` pattern for colors that need specific dark mode variants
---

## 2026-01-26 22:30 - US-002
- **What was implemented:** Created permanent tree sidebar layout
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx` - Major layout refactor:
    - Added CSS grid layout with `grid-cols-1 lg:grid-cols-[280px_1fr]`
    - Built sidebar tree renderer with folder expand/collapse
    - Added tree search with auto-expand for matching folders
    - Integrated document counts display in tree nodes
    - Added mobile hamburger toggle (Menu icon) for drawer
    - Moved main content to `<main>` element within grid
  - `versotech-portal/src/components/documents/navigation/FolderTreeDrawer.tsx` - Fixed hardcoded dark theme:
    - Replaced `bg-zinc-900`, `bg-black/40`, `border-white/10` with theme-aware variants
    - Replaced `text-white`, `text-gray-300/400` with `text-foreground`, `text-muted-foreground`
    - Fixed selection states to use `bg-primary/20 border-primary`
- **Learnings for future iterations:**
  - Use `lg:grid-cols-[280px_1fr]` for desktop sidebar + content layouts (1024px breakpoint)
  - `hidden lg:flex` pattern shows sidebar only on desktop; `lg:hidden` for mobile-only elements
  - ScrollArea from shadcn provides smooth independent scrolling for sidebars
  - Tree building pattern: `buildFolderTree()` creates nested structure from flat folder list, `filterTreeBySearch()` filters recursively
  - Auto-expand ancestors: When navigating to a folder, expand all parent folders using useEffect
---

## 2026-01-26 22:40 - US-003
- **What was implemented:** Created vehicle hierarchy parser for grouping vehicles in tree view
- **Files changed:**
  - `versotech-portal/src/lib/documents/vehicle-hierarchy.ts` - New module with:
    - `parseVehicleHierarchy()` - Main function converting flat vehicle array to nested hierarchy
    - `isParentVehicle()` - Checks if vehicle type is 'fund' or 'securitization'
    - `extractSeriesParentName()` - Extracts SCSP/LLC parent name from "Series XXX" vehicles
    - `extractCompartmentParentName()` - Extracts parent name from "Compartment X" vehicles
    - `flattenVehicleHierarchy()` - Utility to flatten hierarchy back to array
    - `findVehicleInHierarchy()` - Find vehicle by ID in nested structure
  - `versotech-portal/src/__tests__/lib/documents/vehicle-hierarchy.test.ts` - 26 unit tests covering:
    - Parent detection (fund/securitization types)
    - Compartment matching to securitization parents
    - Series grouping under virtual SCSP parents
    - Sort order (real parents first, then virtual groups)
    - Edge cases (empty input, mixed hierarchies)
- **Learnings for future iterations:**
  - Vehicle types: fund, spv, securitization, note, other, real_estate, private_equity, venture_capital
  - VERSO naming patterns: "VERSO Capital 1 SCSP Series XXX" (SCSP series), "Real Empire Capital Compartment X" (compartments)
  - Virtual parent nodes need `isVirtual: true` flag and synthetic IDs like `virtual-verso-capital-1-scsp`
  - Use numeric sorting for series: `localeCompare(a, b, { numeric: true })` ensures Series 101 < Series 102 < Series 200
---

## 2026-01-26 23:05 - US-004 (Updated 23:30)
- **What was implemented:** Added document counts to folders API using efficient SQL GROUP BY
- **Files changed:**
  - Created `get_folder_document_counts()` PostgreSQL function via Supabase migration:
    - Uses `SELECT folder_id, COUNT(*) GROUP BY folder_id` for efficient aggregation
    - Returns only count rows, not all document data (scales to 100k+ docs)
    - Function marked STABLE and SECURITY DEFINER for performance and RLS bypass
  - `versotech-portal/src/app/api/staff/documents/folders/route.ts` - Modified GET endpoint:
    - Replaced client-side counting with `serviceSupabase.rpc('get_folder_document_counts')`
    - Updated `buildFolderTree()` to accept pre-aggregated Map<folder_id, count>
    - Response shape: `{ ...folder, document_count: number }` for both flat and tree modes
- **Learnings for future iterations:**
  - Use Supabase RPC functions for aggregations that would fetch too much data client-side
  - SQL GROUP BY is far more efficient than fetching all rows and counting in JavaScript
  - Database functions with STABLE modifier allow PostgreSQL query planner optimizations
  - When passing aggregated data, use Map<string, number> instead of raw query results
---

## 2026-01-27 00:15 - US-005
- **What was implemented:** Rendered hierarchical tree with icons and document counts in sidebar
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx` - Major tree rendering updates:
    - Imported `parseVehicleHierarchy`, `VehicleNode` from vehicle-hierarchy module
    - Added `Building2`, `Package` icons from lucide-react for vehicle hierarchy
    - Added `expandedVehicles` state for vehicle expand/collapse tracking
    - Created `vehicleHierarchy` memo using `parseVehicleHierarchy(initialVehicles)`
    - Added `getFoldersForVehicle()` to get folders for a specific vehicle
    - Added `getVehicleDocumentCount()` to sum document counts across vehicle folders
    - Added `filterVehicleHierarchy()` for sidebar search to filter vehicles
    - Created `renderVehicleNode()` function with:
      - Building2 icon (blue) for parent vehicles (fund/securitization)
      - Package icon (amber) for compartments/series
      - Document count display in parentheses
      - Recursive rendering of child vehicles and folders
    - Updated sidebar tree section to render vehicle hierarchy first
    - Added "General Folders" section for orphan folders without vehicle_id
    - Updated sidebar header to "Vehicles & Folders"
- **Learnings for future iterations:**
  - Vehicle hierarchy rendering: Render vehicles first, then their folders as children
  - Icon differentiation: Use Building2 for parent vehicles, Package for children, Folder for regular folders
  - Color coding: Blue (text-blue-500) for parent entities, Amber (text-amber-500) for child entities
  - Separate state for vehicle expansion vs folder expansion (expandedVehicles vs expandedFolders)
  - Filter both vehicle names AND their folder contents when searching the tree
---

## 2026-01-27 01:30 - US-006
- **What was implemented:** Added breadcrumb with vehicle context
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `selectedVehicleId` state to track current vehicle context
    - Created `getVehicleById()` helper to resolve vehicle object from ID
    - Created `currentVehicle` memo that derives vehicle from folder or explicit selection
    - Added `navigateToVehicle()` function for vehicle root navigation
    - Added `handleBreadcrumbVehicleClick()` for breadcrumb vehicle segment clicks
    - Made vehicle nodes in sidebar clickable with `navigateToVehicle(vehicle.id)`
    - Added visual selection state for vehicles (`isVehicleSelected`)
    - Updated `FolderBreadcrumbs` to pass `vehicle` and `onVehicleClick` props
    - Show breadcrumbs when either `currentFolder` or `currentVehicle` is set
- **Learnings for future iterations:**
  - Breadcrumb vehicle context pattern: Track `selectedVehicleId` state separate from folder
  - Derive currentVehicle from: 1) folder's vehicle_id, 2) explicit selection when viewing vehicle root
  - FolderBreadcrumbs already had vehicle support - just needed props passed in
  - Selection highlighting in sidebar: `bg-primary/20 border border-primary` for consistent style
---

## 2026-01-27 02:00 - US-007
- **What was implemented:** Added grid/list view toggle with localStorage persistence
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added useEffect to load viewMode from localStorage on mount (SSR-safe pattern)
    - Added useEffect to save viewMode to localStorage when it changes
    - localStorage key: `staff-docs-view`
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Fixed hardcoded dark theme in toolbar (replaced bg-[#0a0a0a], bg-black/40, border-white/10, text-gray-400 with theme-aware variants)
    - Fixed hardcoded dark theme in SelectContent dropdown
    - Fixed hardcoded dark theme in EmptyState component
    - Created `DocumentListRow` component for table view with columns (name, size, date, actions)
    - Added helper functions: `getDocumentIcon()`, `formatFileSize()`
    - Updated documents section to render either grid or table view based on viewMode
    - Added DropdownMenu imports and actions for document rows
- **Learnings for future iterations:**
  - SSR + localStorage hydration issue: useState initializers run on server where `window` is undefined
  - Correct pattern: Initialize with default, use useEffect to load from localStorage on mount
  - View toggle with Grid3x3 and List icons from lucide-react, use `bg-primary/20 text-primary` for selected state
  - Table view pattern: CSS grid with fixed columns `grid-cols-[1fr_100px_140px_80px]` for responsive table
---

## 2026-01-27 01:20 - US-008
- **What was implemented:** Added document sorting with dropdown, direction toggle, and clickable column headers
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `useSearchParams`, `useRouter`, `usePathname` from next/navigation for URL state
    - Changed `sortBy` type from `'name' | 'date' | 'type'` to `'name' | 'date' | 'size'`
    - Added `sortDir` state with `'asc' | 'desc'` type
    - Changed default sort to `sortBy='date'`, `sortDir='desc'` (newest first)
    - Added `updateSortUrl()` to persist sort params in URL
    - Added `handleSortChange()` with smart direction defaults (date=desc, name/size=asc)
    - Added `handleSortDirChange()` for direct direction changes from dropdown
    - Updated `filteredDocuments` memo to handle direction and size sorting
    - Passed new `sortDir`, `onSortChange`, `onSortDirChange` props to FolderNavigator
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added `ArrowUp`, `ArrowDown` icons from lucide-react
    - Updated interface to include `sortDir` and `onSortDirChange` props
    - Changed default `sortBy` to `'date'` and added `sortDir='desc'`
    - Added sort direction dropdown with Asc/Desc options and arrow icons
    - Made table column headers (Name, Size, Date) clickable buttons
    - Added sort indicator arrows on active column header
    - Headers show hover states and highlight when active
- **Learnings for future iterations:**
  - URL state pattern: Use `useSearchParams` + `useRouter` + `usePathname` to read/write URL params
  - Smart sort defaults: When clicking a new column, use sensible defaults (date=desc for newest first, name/size=asc for A-Z)
  - Toggle sort direction: When clicking same column, toggle between asc/desc
  - Use `router.replace()` with `{ scroll: false }` to update URL without scrolling page
  - Clickable table headers: Use `<button>` elements with flex layout for icon + text
---

## 2026-01-27 03:00 - US-009
- **What was implemented:** Created server-side document search API endpoint
- **Files changed:**
  - `versotech-portal/src/app/api/staff/documents/search/route.ts` - New endpoint:
    - GET handler with required `q` query param for search term
    - Optional `vehicle_id` param for filtering by vehicle
    - Uses `.ilike('name', '%${searchTerm}%')` for case-insensitive matching
    - Joins `document_folders` and `vehicles` tables for context (folder.name, vehicle.name)
    - Returns explicit columns: id, name, type, file_size, status, created_at, updated_at, tags, current_version, document_expiry_date, watermark
    - Pagination with 50 results per page, supports `page` param
    - Response: `{ results: Document[], total: number, pagination: {...}, query, vehicle_id }`
- **Learnings for future iterations:**
  - Supabase `.ilike()` is case-insensitive LIKE operator - use for user-friendly search
  - Always use explicit column selection in search results to avoid leaking sensitive data
  - Join related tables with foreign key hints: `document_folders!documents_folder_id_fkey`
  - Include pagination metadata in response: page, limit, total_pages, has_more
  - Validate required query params early and return 400 with clear error message
---

## 2026-01-27 04:00 - US-010
- **What was implemented:** Implemented search UI with debounced API calls and result display
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `SearchResult` interface for server-side search response
    - Added search state: `globalSearchQuery`, `searchResults`, `isSearching`, `isSearchMode`, `searchTotal`
    - Added `searchDebounceRef` for debounce timer
    - Created `performSearch()` function to call `/api/staff/documents/search` endpoint
    - Created `handleGlobalSearchChange()` with 300ms debounce
    - Created `clearSearch()` to reset search state and return to folder view
    - Updated `onDocumentClick` to handle both search results and regular documents
    - Passed search props to FolderNavigator: `globalSearchQuery`, `onGlobalSearchChange`, `onClearSearch`, `isSearchMode`, `isSearching`, `searchResults`, `searchTotal`
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added `X`, `Loader2`, `ChevronRight` icons from lucide-react
    - Added `SearchResult` interface matching server response
    - Extended FolderNavigatorProps with global search props
    - Updated toolbar search input to use global search with loading spinner and clear button
    - Created `SearchEmptyState` component: "No results for [query]" with clear button
    - Created `SearchResultCard` component for grid view with document path context
    - Created `SearchResultRow` component for list view with location column
    - Added search mode conditional rendering: when searching, shows search results instead of folders/documents
- **Learnings for future iterations:**
  - Debounce pattern: Use `useRef<NodeJS.Timeout | null>` for timer, clear with `clearTimeout()` before setting new timeout
  - Search mode toggle: Use boolean `isSearchMode` state to switch between folder view and search results
  - Path context in search: Join vehicle_name and folder_name with ` > ` for breadcrumb-style display
  - Search results can be displayed in same grid/list view as documents - just create matching components
  - Clear search: Reset all search state (`query`, `results`, `mode`, `total`) in single function
---

## 2026-01-27 05:30 - US-011
- **What was implemented:** Added tree search filter with debounce, auto-expand, and text highlighting
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `debouncedTreeSearch` state for debounced search value
    - Added `treeSearchDebounceRef` for 150ms debounce timer
    - Added `searchExpandedVehicles` and `searchExpandedFolders` sets for auto-expansion
    - Created `handleTreeSearchChange()` with 150ms debounce
    - Created `clearTreeSearch()` to reset all search state
    - Added effect to auto-expand parent vehicles/folders when children match
    - Created `effectiveExpandedVehicles` and `effectiveExpandedFolders` memos combining manual + search expansion
    - Added `highlightText()` helper that wraps matches in `<mark>` with yellow background
    - Updated `renderVehicleNode()` and `renderSidebarTreeNode()` to use effective expanded sets
    - Updated vehicle/folder name rendering to use `highlightText()` when searching
    - Improved empty state: shows search icon, query text, "Try different search term", clear button
    - Updated sidebar search input to use new handlers
- **Learnings for future iterations:**
  - Separate debounced value from input value: `treeSearchQuery` for UI, `debouncedTreeSearch` for filtering
  - Auto-expand pattern: Traverse hierarchy collecting IDs of nodes that match or have matching descendants
  - Keep manual expansion separate from search expansion to restore state when clearing search
  - `<mark>` element is semantic HTML5 for highlighting - screen readers announce it correctly
  - Yellow highlight with dark mode support: `bg-yellow-300 dark:bg-yellow-500/40`
---

## 2026-01-27 02:15 - US-012
- **What was implemented:** Added checkbox selection to documents for bulk operations
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `selectedDocuments` state as `Set<string>` of document IDs
    - Created `toggleDocumentSelection()` handler for individual selection
    - Created `selectAllDocuments()` handler using `filteredDocuments` IDs
    - Created `clearSelection()` handler to reset selection
    - Updated `navigateToFolder()` to clear selection when changing folders
    - Passed selection props to `FolderNavigator`
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added selection props interface: `selectedDocuments`, `onToggleSelection`, `onSelectAll`, `onClearSelection`
    - Added "[N] selected" badge in toolbar using shadcn Badge component
    - Added "Select All" checkbox in Documents section header
    - Added checkbox column to list view table header with responsive grid columns
    - Updated `DocumentListRow` with `isSelected`, `onSelectToggle`, `showCheckbox` props
    - Added checkbox to list rows with `stopPropagation` to prevent preview
    - Added selection highlighting with `bg-primary/5`
  - `versotech-portal/src/components/documents/document-card.tsx`:
    - Added `isSelected` and `onSelectToggle` props to interface
    - Added checkbox rendering with shadcn Checkbox component
    - Added selection highlighting with `bg-primary/5 border-primary/50`
    - Used `stopPropagation` on checkbox wrapper to prevent preview trigger
- **Learnings for future iterations:**
  - Selection state as `Set<string>` provides O(1) add/delete/has operations
  - Use `stopPropagation()` on checkbox click handlers to prevent parent onClick (preview)
  - Clear selection when navigating folders to avoid stale references
  - `selectAllDocuments` must be defined after `filteredDocuments` useMemo (variable ordering matters)
  - Responsive grid columns for checkbox: `grid-cols-[40px_1fr_100px_140px_80px]` vs `grid-cols-[1fr_100px_140px_80px]`
  - Selection count badge uses `bg-primary/10 text-primary border-primary/20` for subtle emphasis
---

## 2026-01-27 06:30 - US-013
- **What was implemented:** Added bulk actions dropdown for selected documents
- **Files changed:**
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added `ChevronDown`, `FolderInput`, `Archive` icon imports from lucide-react
    - Added bulk action props to interface: `onBulkMove`, `onBulkDelete`, `onBulkDownload`
    - Created dropdown menu in toolbar with shadcn DropdownMenu component
    - Button shows "Actions" with ChevronDown icon, disabled when no selection
    - Menu items: "Move to..." (FolderInput icon), "Delete" (Trash2 icon, destructive style), "Download ZIP" (Archive icon)
    - Dropdown uses `asChild` pattern with Button component for proper styling
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `handleBulkMove`, `handleBulkDelete`, `handleBulkDownload` placeholder callbacks
    - Each shows toast notification: "[Action] X document(s) - coming soon"
    - Passed bulk action props to FolderNavigator component
- **Learnings for future iterations:**
  - Bulk actions dropdown pattern: Show button always but disable when `selectedDocuments.size === 0`
  - Use `asChild` prop on DropdownMenuTrigger with Button component for consistent styling
  - Destructive menu items use `className="text-destructive focus:text-destructive"` pattern
  - Placeholder handlers with `toast.info()` provide user feedback while functionality is pending
  - Icon choices: FolderInput for move, Trash2 for delete, Archive for ZIP download
---

## 2026-01-27 08:00 - US-014
- **What was implemented:** Bulk move dialog with folder tree picker
- **Files changed:**
  - `versotech-portal/src/components/documents/bulk-move-dialog.tsx` - New component:
    - Dialog with vehicle hierarchy and folder tree from parseVehicleHierarchy
    - Reuses tree rendering pattern from sidebar for consistent UX
    - Shows progress during move: "Moving X/Y..."
    - Sequential PATCH calls with progress tracking
    - Success toast: "Moved N document(s) to [folder]"
    - Clears selection after move completes
    - Handles partial failures with warning toast
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `bulkMoveDialogOpen` state
    - Updated `handleBulkMove` to open dialog instead of placeholder toast
    - Added `BulkMoveDialog` to component render tree
- **Learnings for future iterations:**
  - Bulk operations with progress: Use sequential API calls (not Promise.all) to show progress "Moving X/Y"
  - Folder picker pattern: Reuse vehicle hierarchy + folder tree rendering for consistent UX
  - Handle partial failures gracefully: Count successes/failures, show appropriate toast (success, warning, or error)
  - Selection clearing: Clear selection after successful operation via callback prop
---

## 2026-01-27 10:30 - US-015
- **What was implemented:** Bulk delete dialog with confirmation and sequential deletion
- **Files changed:**
  - `versotech-portal/src/components/documents/bulk-delete-dialog.tsx` - New component:
    - AlertDialog with destructive styling (AlertTriangle icon, red delete button)
    - Shows "Delete [N] documents? This cannot be undone." message
    - Lists first 5 document names with FileText icons
    - Shows "...and N more" for additional documents
    - Sequential DELETE calls with progress tracking ("Deleting X/Y...")
    - Handles partial failures with appropriate toasts (success, warning, error)
    - Clears selection after operation completes
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added import for `BulkDeleteDialog`
    - Added `bulkDeleteDialogOpen` state
    - Added `selectedDocumentNames` memo to get names of selected documents
    - Updated `handleBulkDelete` to open dialog instead of placeholder toast
    - Added `BulkDeleteDialog` to component render tree with all required props
- **Learnings for future iterations:**
  - Use AlertDialog (not Dialog) for destructive confirmation dialogs - provides proper a11y semantics
  - AlertDialogDescription with `asChild` allows complex content (divs) while maintaining semantics
  - Destructive button styling: Use `variant="destructive"` on Button component
  - Document name lookup: Create a memo that filters `filteredDocuments` by `selectedDocuments` Set
  - Reuse patterns from BulkMoveDialog for consistency: sequential operations, progress tracking, partial failure handling
---

## 2026-01-27 12:00 - US-016
- **What was implemented:** Created bulk download ZIP endpoint for downloading multiple documents
- **Files changed:**
  - `versotech-portal/src/app/api/staff/documents/bulk-download/route.ts` - New endpoint:
    - POST handler accepting `{ document_ids: string[] }` (1-100 documents)
    - Validates staff role (staff_admin, staff_ops, staff_rm, ceo)
    - Fetches document metadata (id, name, file_key) from documents table
    - Filters out external links (documents without file_key)
    - Downloads files from Supabase storage using `serviceSupabase.storage.download()`
    - Creates ZIP using `archiver` package with zlib level 5 compression
    - Handles duplicate filenames by adding suffix (e.g., "file (2).pdf")
    - Returns ZIP with Content-Type: application/zip and Content-Disposition attachment
    - Filename format: `documents-YYYY-MM-DD.zip`
    - Includes headers: X-Documents-Count, X-Errors-Count for client feedback
  - `versotech-portal/package.json` - Added `archiver` dependency
- **Learnings for future iterations:**
  - Use `archiver('zip', { zlib: { level: 5 } })` for balanced compression speed/size
  - Supabase storage download: `.storage.from(bucket).download(file_key)` returns Blob data
  - Convert Blob to Buffer: `Buffer.from(await blob.arrayBuffer())`
  - Collect archive chunks using `archive.on('data', chunk => chunks.push(new Uint8Array(chunk)))`
  - Wait for archive completion: `await archive.finalize()` + promise on `archive.on('end')`
  - Zod v4 uses `.issues` not `.errors` for validation error details
  - Duplicate filename handling: Track used names in Map, append ` (N)` before extension
---

## 2026-01-27 10:45 - US-017
- **What was implemented:** Implemented bulk download ZIP UI functionality
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx` - Updated `handleBulkDownload` callback:
    - Changed from placeholder toast to full async implementation
    - Shows loading toast "Preparing download..." using `toast.loading()`
    - Calls POST `/api/staff/documents/bulk-download` with selected document IDs
    - Handles response blob and extracts filename from Content-Disposition header
    - Creates temporary URL with `URL.createObjectURL()` and triggers browser download
    - Cleans up with `URL.revokeObjectURL()` to free memory
    - Shows success toast with document count from X-Documents-Count header
    - Clears selection after successful download
    - Handles errors with appropriate toast messages
- **Learnings for future iterations:**
  - Browser file download pattern: `response.blob()` → `URL.createObjectURL()` → create `<a>` element → `click()` → `URL.revokeObjectURL()`
  - Always call `URL.revokeObjectURL()` after download to prevent memory leaks
  - Use `toast.loading()` which returns an ID, then `toast.dismiss(id)` for clean loading state management
  - Extract filename from Content-Disposition header with regex: `/filename="([^"]+)"/`
  - Add `clearSelection` to useCallback dependencies when calling it inside the callback
---

## 2026-01-27 14:45 - US-018
- **What was implemented:** Added drag-and-drop upload zone to main content area
- **Files changed:**
  - `versotech-portal/src/components/documents/document-upload-dialog.tsx`:
    - Added `initialFiles?: File[]` prop to interface
    - Added useEffect to process initialFiles when dialog opens with pre-populated files
    - Allows external drag-drop to pass files directly into upload dialog
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `isDragOver`, `droppedFiles`, `dragCounterRef` state for drag tracking
    - Defined `ALLOWED_EXTENSIONS` (pdf, docx, xlsx, txt, jpg, jpeg, png) and `MAX_FILE_SIZE` (50MB)
    - Created `validateDroppedFiles()` function to validate file type and size
    - Added `handleDragEnter`, `handleDragLeave`, `handleDragOver`, `handleDrop` handlers
    - Drop handler validates files, shows toast errors for invalid files, opens upload dialog with valid files
    - Created `handleUploadDialogChange` to clear dropped files when dialog closes
    - Added drag event handlers to `<main>` element
    - Added visual overlay with blue dashed border, backdrop blur, and "Drop files to upload" message
    - Overlay includes animated upload icon and lists allowed file types
- **Learnings for future iterations:**
  - Drag-drop counter pattern: Use `dragCounterRef` to track enter/leave events correctly (prevents flickering when dragging over child elements)
  - Check both `e.dataTransfer.items.length > 0` AND `e.dataTransfer.types.includes('Files')` for robust file detection
  - React synthetic events from programmatic dispatch may not trigger state updates like real user interactions
  - File validation before opening dialog: Validate at drop time, show errors for rejected files, only open dialog with valid files
  - Pass pre-populated files via prop (`initialFiles`) rather than trying to modify dialog state from outside
---

## 2026-01-27 15:30 - US-019
- **What was implemented:** Added drag-drop to tree folders for file upload
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added state: `treeDragOverFolderId`, `uploadTargetFolderId`, `uploadTargetFolderName`
    - Created `handleTreeFolderDragEnter`, `handleTreeFolderDragLeave`, `handleTreeFolderDragOver`, `handleTreeFolderDrop` handlers
    - Updated `renderSidebarTreeNode` with drag event handlers and ring-2 ring-primary highlight
    - Modified upload dialog to use target folder when dropping on tree node
    - Updated `handleUploadDialogChange` to clear target folder state on close
- **Learnings for future iterations:**
  - Tree folder drag-drop pattern: Track drag-over state by folder ID, apply highlight class conditionally
  - Use `e.relatedTarget` check in dragLeave to avoid flickering when entering child elements
  - Pre-select upload target folder: Store folder ID/name in state, pass to upload dialog when specified
  - Toast notification on drop provides immediate feedback: "Uploading to [folder name]"
  - Drag handlers work on collapsed folders because they're attached to the visible folder row element
---

## 2026-01-27 16:02 - US-020
- **What was implemented:** Added document drag to move functionality
- **Files changed:**
  - `versotech-portal/src/components/documents/document-card.tsx`:
    - Added drag props interface: `isDragging`, `onDragStart`, `onDragEnd`
    - Added `handleDragStart` handler setting dataTransfer with document ID/name
    - Added `draggable` attribute, cursor-grab styling, opacity when dragging
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added drag props to `FolderNavigatorProps`: `draggingDocumentId`, `onDocumentDragStart`, `onDocumentDragEnd`
    - Updated `DocumentListRow` with drag props and handlers
    - Passed drag props through to DocumentCard and DocumentListRow components
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added state: `draggingDocumentId`, `draggingDocumentName`
    - Created `handleDocumentDragStart`, `handleDocumentDragEnd` handlers
    - Extended `handleTreeFolderDrop` to detect document moves vs file uploads
    - Inline move logic: PATCH API call, optimistic UI update, toast notifications
    - Pass drag props to FolderNavigator
- **Learnings for future iterations:**
  - Document vs file drag detection: Use custom MIME type `application/x-document-id` in dataTransfer to distinguish from native file drops
  - Optimistic updates: Remove document from current view immediately, reload on success/error for consistency
  - Avoid circular callback dependencies: Define move logic inline in drop handler instead of separate useCallback to avoid "used before declaration" errors
  - Same tree folder highlight works for both file uploads and document moves - just extended the drop handler logic
---

## 2026-01-27 17:00 - US-021
- **What was implemented:** Display tags on documents as badges in grid and list views
- **Files changed:**
  - `versotech-portal/src/types/documents.ts`:
    - Added `tags?: string[] | null` field to Document interface
    - Added `current_version?: number | null` for future versioning feature
    - Added `document_expiry_date?: string | null` for expiry warnings feature
  - `versotech-portal/src/components/documents/tag-badges.tsx` - New component:
    - Displays up to maxVisible tags (default 2) as slate-colored badges with Tag icon
    - Shows "+N" badge for overflow with Tooltip listing all hidden tags
    - Returns null for empty/null tags array (no visual clutter)
    - Supports 'default' and 'sm' size variants
  - `versotech-portal/src/components/documents/document-card.tsx`:
    - Imported TagBadges component
    - Added TagBadges below the existing badges section for grid view
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Imported TagBadges component
    - Updated table header to add "Tags" column (between Name and Size)
    - Updated grid columns from `[40px_1fr_100px_140px_80px]` to `[40px_1fr_150px_100px_140px_80px]`
    - Added Tags column to DocumentListRow with TagBadges size="sm"
    - Added tags to search results: SearchResultCard shows tags below path, SearchResultRow has Tags column
- **Learnings for future iterations:**
  - Tag display component pattern: Return null for empty arrays (acceptance: "Empty tags = show nothing")
  - Tooltip overflow pattern: Use TooltipProvider + Tooltip + TooltipTrigger with Badge + TooltipContent for overflow info
  - Grid column sizing: Add 150px for tags column - enough for 2 badges + overflow indicator
  - Slate color for tags: `border-slate-200 bg-slate-50 text-slate-700 dark:border-slate-700 dark:bg-slate-800/50 dark:text-slate-300` provides neutral, non-semantic appearance
---

## 2026-01-27 18:30 - US-022
- **What was implemented:** Created tags list API endpoint for autocomplete
- **Files changed:**
  - Created Supabase RPC function `get_distinct_document_tags()` via migration:
    - Uses `SELECT DISTINCT unnest(tags) FROM documents ORDER BY tag`
    - Returns unique tags sorted alphabetically
    - STABLE and SECURITY DEFINER for performance and RLS bypass
  - `versotech-portal/src/app/api/staff/documents/tags/route.ts` - New endpoint:
    - GET handler with staff authentication via `authenticateStaffForDocuments()`
    - Calls `serviceSupabase.rpc('get_distinct_document_tags')` for efficient query
    - Returns `{ tags: string[] }` response format
    - Error handling with appropriate HTTP status codes
- **Learnings for future iterations:**
  - For array unnesting queries, use RPC function with `unnest()` - Supabase query builder doesn't support this directly
  - Pattern: `SELECT DISTINCT unnest(array_column) as item FROM table ORDER BY item` for unique array values
  - RPC functions with STABLE modifier can be optimized by PostgreSQL query planner
  - Current tags in test DB: executed, nda, signed
---

## 2026-01-27 19:30 - US-023
- **What was implemented:** Added tag management popover for adding/removing document tags
- **Files changed:**
  - `versotech-portal/src/components/documents/tag-management-popover.tsx` - New component:
    - Popover with current tags displayed as removable badges
    - Command/Input combo for autocomplete from `/api/staff/documents/tags`
    - Enter key adds new tag (creates if not in suggestions)
    - X button on badge removes tag
    - Saves immediately via PATCH `/api/staff/documents/[id]`
    - Toast notifications for success/error feedback
    - Loading states for fetching tags and saving
  - `versotech-portal/src/components/documents/document-card.tsx`:
    - Added `Tag` icon import and `onTagsUpdated` prop
    - Added TagManagementPopover with DropdownMenuItem trigger after Rename option
    - Passes document ID, name, tags and update callback
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added `Tag` icon import and TagManagementPopover import
    - Added `onTagsUpdated` prop to interface and destructured props
    - Added TagManagementPopover to DocumentListRow dropdown menu
    - Passed `onTagsUpdated` through to DocumentCard and DocumentListRow
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `tags?: string[]` to StaffDocument interface
    - Created `handleTagsUpdated` callback to update local state optimistically
    - Passed `onTagsUpdated={handleTagsUpdated}` to FolderNavigator
- **Learnings for future iterations:**
  - Popover-in-dropdown pattern: Use `onSelect={(e) => e.preventDefault()}` on DropdownMenuItem to prevent closing when clicking to open popover
  - Optimistic UI updates: Update local state immediately after API call to provide instant feedback
  - Command component filtering: Set `shouldFilter={false}` when doing custom filtering to prevent cmdk from double-filtering
  - Tag autocomplete: Combine "create new" option (shown when input doesn't match existing) with existing tag suggestions
  - Unified tag management: Same component works in both grid view (DocumentCard) and list view (DocumentListRow) menus
---

## 2026-01-27 20:27 - US-024
- **What was implemented:** Added tag filter dropdown for filtering documents by tags
- **Files changed:**
  - `versotech-portal/src/components/documents/tag-filter-dropdown.tsx` - New component:
    - Multi-select dropdown using Popover + Command from shadcn/ui
    - Fetches available tags from `/api/staff/documents/tags` on mount
    - Checkboxes for each tag with visual selection state
    - Badge showing selected count on trigger button
    - "Clear filters" button appears when tags are selected
    - Accessible keyboard navigation via Command component
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added `TagFilterDropdown` import
    - Added `selectedTagFilters` and `onTagFiltersChange` props to interface
    - Integrated TagFilterDropdown in toolbar next to search input
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `selectedTagFilters` state (Set<string>)
    - Updated useEffect to load `?tags=` param from URL on mount
    - Created `handleTagFiltersChange` callback that updates state and URL
    - Updated `filteredDocuments` memo to filter by tags (ANY match)
    - Passed tag filter props to FolderNavigator
- **Learnings for future iterations:**
  - URL state for Set: Convert Set to array for URL with `Array.from(tags).join(',')`, parse back with `tagsParam.split(',').filter(t => t.trim())`
  - Multi-select filter UX: Show badge count on trigger, use checkboxes inside Command items, add clear button in footer
  - Filter logic choice: "ANY" matching (`tags.some()`) is more intuitive for multi-select filters than "ALL" matching
  - Command component checkbox pattern: Wrap custom checkbox div inside CommandItem, use `onSelect` for toggling
---

## 2026-01-27 22:30 - US-025
- **What was implemented:** Added version history panel with right-side Sheet slide-out
- **Files changed:**
  - `versotech-portal/src/components/documents/version-history-sheet.tsx` - New component:
    - Sheet with SheetContent side="right" for slide-out panel
    - Fetches versions from `/api/staff/documents/[id]/versions` on open
    - Displays version list with: version number, date (formatted), uploader name, file size
    - "Current" badge on current version with highlighted styling
    - Download button for each version
    - Empty states for no versions (single version documents)
    - Loading and error states with retry button
  - `versotech-portal/src/components/documents/document-card.tsx`:
    - Added `History` icon import from lucide-react
    - Added `onVersionHistory` prop to interface
    - Added "Version History" menu item after "Manage Tags" in dropdown
    - Calls `onVersionHistory(document.id, displayName, document.current_version || 1)`
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added `History` icon import
    - Added `onVersionHistory` prop to FolderNavigatorProps interface
    - Passed `onVersionHistory` to DocumentCard and DocumentListRow components
    - Added "Version History" menu item to DocumentListRow dropdown
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Imported VersionHistorySheet component
    - Added version history state: `versionHistoryOpen`, `versionHistoryDocId`, `versionHistoryDocName`, `versionHistoryCurrentVersion`
    - Added `current_version` field to StaffDocument interface
    - Created `handleVersionHistory` callback to open sheet with document info
    - Passed `onVersionHistory={handleVersionHistory}` to FolderNavigator
    - Rendered VersionHistorySheet in dialogs section
- **Learnings for future iterations:**
  - Sheet slide-out pattern: Use `SheetContent side="right"` with controlled open state for detail panels
  - Version history API already existed at `/api/staff/documents/[id]/versions` with GET (list) and POST (upload)
  - Database schema `document_versions`: id, document_id, version_number, file_key, file_size_bytes, mime_type, changes_description, created_by, created_at
  - Current version highlight: Use `bg-primary/5 border-primary/30` for subtle highlight of current version
  - Empty state for single version: Show friendly message "Upload a new version to see version history"
---

## 2026-01-27 23:30 - US-026
- **What was implemented:** Added upload new version functionality
- **Files changed:**
  - `versotech-portal/src/components/documents/document-card.tsx`:
    - Added `Upload` icon import
    - Added `onUploadNewVersion` prop to interface
    - Added "Upload New Version" menu item after "Version History" in dropdown
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added `onUploadNewVersion` prop to FolderNavigatorProps interface
    - Passed prop through to DocumentCard and DocumentListRow components
    - Added "Upload New Version" menu item to DocumentListRow dropdown
  - `versotech-portal/src/components/documents/version-history-sheet.tsx`:
    - Added `refreshKey` prop to interface (incremented to trigger refetch)
    - Added `refreshKey` to useEffect dependency array for fetch trigger
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added upload version state: `uploadVersionDocId`, `uploadVersionDocName`, `isUploadingVersion`, `versionHistoryRefreshKey`
    - Added `versionFileInputRef` for hidden file input
    - Created `handleUploadNewVersion` callback (stores doc info, triggers file input click)
    - Created `handleVersionFileSelected` callback:
      - Validates file type (PDF, DOCX, XLSX, TXT, JPEG, PNG) and size (50MB max)
      - POSTs FormData to `/api/staff/documents/[id]/versions`
      - Shows loading toast during upload, success toast with version number
      - Updates local document state with new current_version
      - Increments `versionHistoryRefreshKey` to refresh panel if open
    - Added hidden `<input type="file">` element with accept attribute
    - Passed `onUploadNewVersion` to FolderNavigator
    - Passed `refreshKey` to VersionHistorySheet
- **Learnings for future iterations:**
  - Hidden file input pattern: Use ref + hidden input, call `ref.current?.click()` to trigger
  - File input accept attribute: Use MIME types or extensions like `.pdf,.docx,.xlsx,.txt,.jpg,.jpeg,.png`
  - FormData for file upload: `formData.append('file', file)` then POST with body: formData (no Content-Type header needed - browser sets multipart boundary)
  - React file input reset: Set `inputRef.current.value = ''` to allow re-selecting same file
  - RefreshKey pattern: Add numeric prop to component, include in useEffect deps, increment from parent to trigger refetch
  - Optimistic local state update: Update document array in state immediately after successful API call for instant feedback
---

## 2026-01-27 23:45 - US-027
- **What was implemented:** Added version badge display on documents with multiple versions
- **Files changed:**
  - `versotech-portal/src/components/documents/document-card.tsx`:
    - Added version badge button next to document name in grid view
    - Badge shows "v{N}" when current_version > 1
    - Clicking badge opens version history panel
    - Uses small, gray styling with theme variables (bg-muted, text-muted-foreground)
    - Has hover states (hover:bg-accent) for interactivity
    - Uses stopPropagation to prevent triggering document preview
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added same version badge to DocumentListRow component for list view
    - Badge appears after document name, before tags column
    - Same styling and behavior as grid view badge
- **Learnings for future iterations:**
  - Version badge pattern: Use conditional render `{document.current_version && document.current_version > 1 && (...)}` to only show for versioned docs
  - Subtle badge styling: `bg-muted text-muted-foreground border-border` provides a non-prominent appearance that doesn't compete with semantic badges
  - Click handler on badge must call `stopPropagation()` to prevent parent onClick (document preview) from firing
  - `flex-shrink-0` on badges prevents them from being squished when document names are long
---

## 2026-01-27 - US-028
- **What was implemented:** Added expired document warnings throughout the document management system
- **Files changed:**
  - `versotech-portal/src/components/documents/document-card.tsx`:
    - Added AlertTriangle icon import from lucide-react
    - Added Tooltip imports from @/components/ui/tooltip
    - Added `isDocumentExpired()` helper to check if document_expiry_date < today
    - Added `formatExpiryDate()` helper for date formatting
    - Added amber AlertTriangle icon with tooltip in grid view card showing "Expired on [date]"
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added same imports (AlertTriangle, Tooltip components)
    - Added same helper functions for expiry check and formatting
    - Added expired warning to DocumentListRow in list view
    - Added expired warning to SearchResultCard (grid search results)
    - Added expired warning to SearchResultRow (list search results)
  - `versotech-portal/src/components/documents/DocumentViewerFullscreen.tsx`:
    - Added AlertTriangle icon import
    - Added expiry check helper functions
    - Added amber banner below toolbar: "This document expired on [date]"
    - Changed layout to flexbox with flex-1 viewport for proper banner spacing
- **Learnings for future iterations:**
  - Expired document warning pattern: Use `isDocumentExpired(document.document_expiry_date)` to conditionally render warning
  - Amber color for warnings: `text-amber-500` for icon, `bg-amber-50 border-amber-200 text-amber-800` for banner
  - TooltipProvider wrapping: Each Tooltip needs its own TooltipProvider when used inside mapped components
  - Flexbox layout for dynamic content: Use `flex flex-col` on container with `flex-1 min-h-0` on content area to handle optional banners
  - Document remains accessible: Expired warning is purely informational - no blocking behavior
---

## 2026-01-27 - US-029
- **What was implemented:** Added CONFIDENTIAL badge and watermark overlay for confidential documents
- **Files changed:**
  - `versotech-portal/src/components/documents/document-card.tsx`:
    - Changed "Watermarked" badge to "CONFIDENTIAL" with red color styling
    - Badge uses `border-red-200 bg-red-50 text-red-700` with dark mode variants
  - `versotech-portal/src/components/documents/navigation/FolderNavigator.tsx`:
    - Added Shield icon import from lucide-react
    - Added CONFIDENTIAL badge to DocumentListRow (list view)
    - Added CONFIDENTIAL badge to SearchResultCard (grid search results)
    - Added CONFIDENTIAL badge to SearchResultRow (list search results)
    - Used `!!result.watermark` to fix TypeScript error with `unknown` type
  - `versotech-portal/src/components/documents/DocumentViewerFullscreen.tsx`:
    - Added `relative` positioning to main viewport container
    - Added diagonal watermark overlay with "CONFIDENTIAL - VERSO Holdings" text
    - Watermark positioned center, rotated -45deg, 30% opacity
    - Uses `pointer-events-none` to allow clicking through to PDF
- **Learnings for future iterations:**
  - Confidential badge pattern: Use red color scheme for confidential/security indicators (`border-red-200 bg-red-50 text-red-700`)
  - Dark mode for red badges: `dark:border-red-900 dark:bg-red-950 dark:text-red-400`
  - TypeScript `unknown` type in JSX: Use `!!value` to convert to boolean for conditional rendering
  - Watermark overlay pattern: Use absolute positioning over iframe with `pointer-events-none` to allow interaction with underlying content
  - CSS transform for diagonal text: `transform: 'rotate(-45deg)'` with inline style for rotation
---

## 2026-01-27 17:30 - US-030
- **What was implemented:** Added right-click context menu to folder tree nodes in sidebar
- **Files changed:**
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added ContextMenu, ContextMenuContent, ContextMenuItem, ContextMenuSeparator, ContextMenuTrigger imports
    - Added Pencil, Trash2 icon imports from lucide-react
    - Updated `renderSidebarTreeNode` to wrap folder rows with ContextMenu
    - Added `canDelete` logic: only custom folders without documents can be deleted
    - Menu items: "New Subfolder" (opens CreateFolderDialog), "Rename" (opens RenameFolderDialog), "Delete" (with disabled state logic)
    - Delete shows "(System folder)" or "(Has documents)" indicator when disabled
  - `versotech-portal/src/components/documents/rename-folder-dialog.tsx`:
    - Removed hardcoded dark theme classes (bg-zinc-900, border-white/10, text-white, etc.)
    - Dialog now properly inherits theme from shadcn components
- **Learnings for future iterations:**
  - ContextMenu pattern: Wrap the triggerable element with `<ContextMenuTrigger asChild>` and place `<ContextMenuContent>` as sibling
  - ContextMenuItem supports `variant="destructive"` for delete/danger actions
  - ContextMenuItem supports `disabled` prop for conditional enabling
  - Delete logic for folders: Check both `folder_type === 'custom'` AND `document_count === 0`
  - Show explanation text in disabled menu items (e.g., "(System folder)") to help users understand why action is unavailable
---

## 2026-01-27 21:00 - US-031
- **What was implemented:** Added "Deals" virtual node under each vehicle in sidebar tree with lazy loading
- **Files changed:**
  - `versotech-portal/src/app/api/deals/route.ts`:
    - Added `vehicle_id` query parameter support to GET endpoint
    - Filters deals by vehicle_id when provided
  - `versotech-portal/src/app/api/staff/documents/route.ts`:
    - Added `deal_id` query parameter support
    - Filters documents by deal_id when provided
    - Added deal_id to filters_applied response
  - `versotech-portal/src/components/documents/staff-documents-client.tsx`:
    - Added `Briefcase` icon import from lucide-react
    - Added `Deal` interface with id, name, status, vehicle_id fields
    - Added state: `expandedDealsNodes` (Set<string>), `vehicleDeals` (Map<string, Deal[]>), `loadingDeals` (Set<string>), `selectedDealId` (string | null)
    - Created `fetchDealsForVehicle()` callback for lazy loading deals from API
    - Created `toggleDealsNode()` callback to expand/collapse deals node and trigger fetch
    - Created `navigateToDeal()` callback to filter documents by deal_id
    - Created `clearDealFilter()` callback (for future use)
    - Created `renderDealsNode()` function to render virtual "Deals" node with Briefcase icon (purple)
    - Updated `renderVehicleNode()` to include renderDealsNode() for each vehicle
    - Updated `navigateToFolder()` and `navigateToVehicle()` to clear selectedDealId
    - Updated `loadDocuments()` to include deal_id filter param
    - Shows deal status badges (draft=gray, active=green, closed=blue)
    - Shows loading spinner (Loader2) while fetching deals
    - Shows "No deals for this vehicle" message when empty
- **Learnings for future iterations:**
  - Virtual node pattern: Create virtual container nodes (like "Deals") that don't exist in the database but organize related items
  - Lazy loading pattern: Only fetch data when parent node is expanded - track loading state per node with Set<string>
  - Cache loaded data: Store fetched deals in Map<vehicleId, Deal[]> to avoid re-fetching on collapse/expand cycles
  - Deal filtering: Pass deal_id to document API to filter documents associated with specific deals
  - Clear context on navigation: When navigating to a different folder or vehicle, clear the deal filter to avoid stale results
  - Status badge colors: Use green for active, gray for draft, blue for closed - consistent with other status indicators in codebase
---
