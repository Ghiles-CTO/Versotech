{
  "project": "VERSO Fee System Redesign",
  "branchName": "ralph/fee-system-redesign",
  "description": "Fee System Redesign - Unify Fees page with Deal page structure, fix fee event calculations, add commission schedules, update dashboard with expense metrics, and improve reconciliation views.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add deal selector to Fees page",
      "description": "As a staff member, I want to select a deal on the Fees page so that I can view fee plans scoped to that specific deal.",
      "acceptanceCriteria": [
        "Deal selector dropdown at top of Fees page",
        "Dropdown shows all deals user has access to (query from deals table)",
        "Selecting a deal filters all fee plans to that deal",
        "Default to no selection with prompt 'Select a deal to view fee plans'",
        "URL updates with deal query param (/fees?deal_id=xxx)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Group fee plans by entity type",
      "description": "As a staff member, I want fee plans grouped by entity type (Introducer, Partner, Commercial Partner) so I can easily find and manage them.",
      "acceptanceCriteria": [
        "Fee plans grouped into 3 collapsible sections: Introducers, Partners, Commercial Partners",
        "Each section shows count of fee plans (e.g., 'Introducers (3)')",
        "Empty sections show 'No fee plans' message",
        "Groups match the structure on Deal page's Fee Plans tab",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Add fee plan status badges",
      "description": "As a staff member, I want consistent status badges on the Fees page so I can quickly see plan states.",
      "acceptanceCriteria": [
        "Status badge on each fee plan card",
        "Badge colors match Deal page: Draft (gray), Sent (blue), Pending Signature (yellow), Accepted (green), Rejected (red)",
        "Badge shows status text (e.g., 'Accepted')",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Port agreement generation to Fees page",
      "description": "As a staff member, I want to generate introducer/partner agreements from the Fees page so I don't have to navigate to the Deal page.",
      "acceptanceCriteria": [
        "Generate Agreement button on each fee plan card (for plans with entity assigned)",
        "Button disabled for plans without required entity data",
        "Clicking button calls existing /api/staff/fees/plans/[id]/generate-agreement endpoint",
        "Shows loading spinner during generation",
        "On success, shows toast 'Agreement generated' and refreshes plan status",
        "On error, shows error toast with message",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Port PDF preview/download to Fees page",
      "description": "As a staff member, I want to preview and download agreement PDFs from the Fees page so I can review terms without navigating away.",
      "acceptanceCriteria": [
        "Preview PDF button on fee plans with generated agreements (agreement_pdf_url not null)",
        "Clicking opens PDF in modal viewer (reuse existing PdfViewer component if available)",
        "Download PDF button downloads the file",
        "Buttons hidden for plans without generated PDFs",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Audit subscription fee calculation",
      "description": "As a developer, I need to verify subscription fees are calculated correctly so investors are charged the right amount.",
      "acceptanceCriteria": [
        "Review subscription-fee-calculator.ts in /src/lib/ or similar location",
        "Confirm subscription fee = commitment × (subscription_fee_bps / 10000)",
        "Fee event created with fee_type = 'subscription'",
        "base_amount set to commitment value",
        "rate_bps set to the rate used",
        "computed_amount set to calculated fee",
        "Add unit test for subscription fee calculation if test file exists",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Fix management fee period calculation",
      "description": "As a developer, I need management fees calculated correctly with proper period dates so quarterly fees are accurate.",
      "acceptanceCriteria": [
        "Management fee formula: base_amount × (rate_bps / 10000) × (period_days / 365)",
        "period_start_date and period_end_date set correctly for each period",
        "Pro-rata calculation for partial periods",
        "Verify formula in accrue_quarterly_management_fees() or equivalent function",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Fix performance fee hurdle calculation",
      "description": "As a developer, I need performance fees to respect hurdle rates so carried interest is calculated correctly.",
      "acceptanceCriteria": [
        "profit = exit_proceeds - contributed_capital",
        "hurdle_return = contributed_capital × (hurdle_bps / 10000) × years_held",
        "profit_above_hurdle = profit - hurdle_return",
        "performance_fee = profit_above_hurdle × (carry_bps / 10000) only if positive, else 0",
        "Support tiered rates if tier1 and tier2 fields exist",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Link fee events to arranger",
      "description": "As a developer, I need fee events linked to the arranger so revenue flows are properly attributed.",
      "acceptanceCriteria": [
        "payee_arranger_id field populated on all new fee events",
        "Value derived from deals.arranger_entity_id",
        "Create migration to backfill existing fee events with NULL payee_arranger_id if needed",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Add investor fee schedule section",
      "description": "As a staff member, I want to see upcoming investor fees (management, performance) so I can forecast revenue.",
      "acceptanceCriteria": [
        "Investor Fees section in Schedule tab (or new schedule page if doesn't exist)",
        "Shows fee events with status = 'accrued' and future period_start_date",
        "Columns: Deal, Investor, Fee Type, Amount, Period Start, Period End",
        "Sortable by date",
        "Grouped by deal then investor",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Add introducer commission schedule",
      "description": "As a staff member, I want to see upcoming introducer commission payments so I can forecast expenses.",
      "acceptanceCriteria": [
        "Introducer Commissions section in Schedule tab",
        "Query introducer_commissions where status IN ('accrued', 'invoice_requested')",
        "Columns: Introducer Name, Deal, Investor, Amount, Status, Created Date",
        "Grouped by introducer then deal",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Add partner commission schedule",
      "description": "As a staff member, I want to see upcoming partner commission payments so I can forecast partner expenses.",
      "acceptanceCriteria": [
        "Partner Commissions section in Schedule tab",
        "Query partner_commissions where status IN ('accrued', 'invoice_requested')",
        "Columns: Partner Name, Deal, Investor, Amount, Status, Created Date",
        "Grouped by partner then deal",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Add commercial partner commission schedule",
      "description": "As a staff member, I want to see upcoming commercial partner commission payments so I can forecast all commission expenses.",
      "acceptanceCriteria": [
        "Commercial Partner Commissions section in Schedule tab",
        "Query commercial_partner_commissions where status IN ('accrued', 'invoice_requested')",
        "Columns: Commercial Partner Name, Deal, Investor, Amount, Status, Created Date",
        "Grouped by commercial partner then deal",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Add schedule filtering controls",
      "description": "As a staff member, I want to filter the schedule by deal, entity, and date range so I can focus on relevant data.",
      "acceptanceCriteria": [
        "Deal filter dropdown (multi-select)",
        "Entity filter dropdown (multi-select, shows all introducers/partners/commercial partners)",
        "Date range picker (from/to dates)",
        "Filters apply to all schedule sections",
        "Filters persist in URL query params",
        "Clear filters button",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Add commission KPIs to dashboard",
      "description": "As a staff member, I want to see commission expense metrics alongside revenue so I have a complete financial picture.",
      "acceptanceCriteria": [
        "New Commissions section on dashboard (can be separate card or section)",
        "Shows: Total Commissions Owed, Total Paid YTD, Pending Invoice",
        "Data aggregated from all 3 commission tables (introducer, partner, commercial_partner)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Show commission breakdown by entity type",
      "description": "As a staff member, I want to see commission totals broken down by entity type so I know where expenses are going.",
      "acceptanceCriteria": [
        "Within Commissions section, show breakdown: Introducers $X, Partners $X, Commercial Partners $X",
        "Each shows total owed amount",
        "Clickable to navigate to respective reconciliation view (or placeholder)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Update fees dashboard API with commission summary",
      "description": "As a developer, I need the dashboard API to return commission metrics so the frontend can display them.",
      "acceptanceCriteria": [
        "Update /api/staff/fees/dashboard or create new endpoint",
        "Return commission_summary object with: total_owed, total_accrued, total_invoiced, total_paid_ytd",
        "Include by_entity_type breakdown: { introducer: {owed, paid}, partner: {owed, paid}, commercial_partner: {owed, paid} }",
        "Query all 3 commission tables and aggregate",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Add reconciliation navigation links",
      "description": "As a staff member, I want quick links to reconciliation views from the dashboard so I can investigate discrepancies.",
      "acceptanceCriteria": [
        "View Reconciliation link in Commissions section",
        "Link navigates to /arranger-reconciliation or equivalent",
        "View Invoices link in Revenue section (if exists)",
        "Link navigates to /reconciliation or equivalent",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Add commission tracking to lawyer reconciliation",
      "description": "As a lawyer, I want to see all commission statuses in my reconciliation view so I can track pending payments.",
      "acceptanceCriteria": [
        "Commission Status tab in lawyer reconciliation page (if exists at /lawyer-reconciliation)",
        "Shows all commissions from all 3 tables (introducer, partner, commercial_partner)",
        "Columns: Entity Type, Entity Name, Deal, Investor, Amount, Status, Invoice URL",
        "Filter by status (Accrued, Invoice Requested, Invoiced, Paid)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-020",
      "title": "Verify arranger reconciliation structure",
      "description": "As an arranger, I want separate tabs for each entity type so I can manage commissions efficiently.",
      "acceptanceCriteria": [
        "Verify three tabs exist in arranger reconciliation: Introducers, Partners, Commercial Partners",
        "Each tab queries respective commission table",
        "Columns: Entity Name, Deal, Investor, Amount, Basis Type, Rate, Status",
        "Action buttons: Request Invoice, Mark Paid (if not already implemented)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Add reconciliation summary view",
      "description": "As a staff member, I want a summary view showing overall reconciliation status so I can quickly assess financial health.",
      "acceptanceCriteria": [
        "Summary section at top of reconciliation page",
        "Shows: Total Outstanding, Total Matched, Total Unmatched",
        "Progress indicator (pie chart or progress bar) showing match percentage",
        "Updates based on current filter selection",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Audit invoice generation accuracy",
      "description": "As a developer, I need to verify invoice amounts match fee event totals so investors are billed correctly.",
      "acceptanceCriteria": [
        "Review invoice generation flow in /api/staff/invoices or similar",
        "Verify: invoice.total = SUM(fee_events.computed_amount) for linked events",
        "Add validation that warns/errors if totals don't match",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Add invoice discrepancy warnings",
      "description": "As a staff member, I want to see warnings when invoice amounts don't match expected fees so I can investigate.",
      "acceptanceCriteria": [
        "Warning badge/icon on invoices where total != SUM(linked fee_events)",
        "Clicking badge shows discrepancy details in popover or modal",
        "Warning appears in invoice list view",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Clarify invoice UI labeling",
      "description": "As a staff member, I want clear labeling that invoices are for investors so there's no confusion with entity invoices.",
      "acceptanceCriteria": [
        "Page title updated to 'Investor Invoices'",
        "Add helper text: 'Invoices sent to investors for fee collection'",
        "Ensure entity invoice uploads are in separate commission flow (not on this page)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Verify spread fee calculation",
      "description": "As a developer, I need spread fees calculated and recorded so secondary trade markups are tracked.",
      "acceptanceCriteria": [
        "Spread fee event created when spread is applied to trade",
        "fee_type = 'spread_markup' for spread fees",
        "computed_amount = spread amount from trade data",
        "Fee event linked to subscription via allocation_id",
        "Typecheck passes"
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    }
  ]
}
