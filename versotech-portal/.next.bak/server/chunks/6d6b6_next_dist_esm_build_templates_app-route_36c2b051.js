module.exports=[792655,e=>{"use strict";var t=e.i(779444),r=e.i(698261),a=e.i(821776),i=e.i(796417),s=e.i(856890),n=e.i(26996),o=e.i(436944),l=e.i(88281),d=e.i(765944),_=e.i(984788),u=e.i(237011),c=e.i(712007),p=e.i(777657),m=e.i(13180),f=e.i(273827),y=e.i(193695);e.i(947956);var g=e.i(36217),h=e.i(414131),v=e.i(433669),x=e.i(38896),R=e.i(221640),b=e.i(911357),w=e.i(233793),E=e.i(107854);async function S(e,{params:t}){try{let e=await (0,x.getCurrentUser)();if(!e)return h.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=(0,v.createServiceClient)();if(!await (0,R.isSuperAdmin)(r,e.id))return h.NextResponse.json({success:!1,error:"Forbidden"},{status:403});let{id:a}=await t,{data:i,error:s}=await r.from("profiles").select("id, display_name, email, role, title, phone, office_location, avatar_url, created_at, last_login_at, password_set, is_super_admin, signature_specimen_url, deleted_at, bio").eq("id",a).single();if(s||!i)return console.error("[admin/users/[id]] Profile error:",s),h.NextResponse.json({success:!1,error:"User not found"},{status:404});let[n,o,l,d,_,u]=await Promise.all([r.from("investor_users").select("user_id, investor_id, role, is_primary, can_sign, ceo_approval_status, investors:investors!investor_users_investor_id_fkey(id, legal_name)").eq("user_id",a),r.from("partner_users").select("user_id, partner_id, role, is_primary, can_sign, ceo_approval_status, partners:partners!partner_users_partner_fk(id, name, legal_name)").eq("user_id",a),r.from("lawyer_users").select("user_id, lawyer_id, role, is_primary, can_sign, ceo_approval_status, lawyers:lawyers!lawyer_users_lawyer_fk(id, firm_name, display_name)").eq("user_id",a),r.from("commercial_partner_users").select("user_id, commercial_partner_id, role, is_primary, can_sign, ceo_approval_status, commercial_partners:commercial_partners!commercial_partner_users_cp_fk(id, name, legal_name)").eq("user_id",a),r.from("introducer_users").select("user_id, introducer_id, role, is_primary, can_sign, ceo_approval_status, introducers:introducers!introducer_users_introducer_fk(id, legal_name)").eq("user_id",a),r.from("arranger_users").select("user_id, arranger_id, role, is_primary, can_sign, ceo_approval_status, arranger_entities:arranger_entities!arranger_users_arranger_fk(id, legal_name)").eq("user_id",a)]),c=[],p=e=>Array.isArray(e)?e[0]:e;if(n.data)for(let e of n.data){let t=p(e.investors);t&&c.push({id:t.id,name:t.legal_name||"Unnamed Investor",type:"investor",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status})}if(o.data)for(let e of o.data){let t=p(e.partners);t&&c.push({id:t.id,name:t.name||t.legal_name||"Unnamed Partner",type:"partner",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status})}if(l.data)for(let e of l.data){let t=p(e.lawyers);t&&c.push({id:t.id,name:t.firm_name||t.display_name||"Unnamed Law Firm",type:"lawyer",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status})}if(d.data)for(let e of d.data){let t=p(e.commercial_partners);t&&c.push({id:t.id,name:t.name||t.legal_name||"Unnamed Commercial Partner",type:"commercial_partner",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status})}if(_.data)for(let e of _.data){let t=p(e.introducers);t&&c.push({id:t.id,name:t.legal_name||"Unnamed Introducer",type:"introducer",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status})}if(u.data)for(let e of u.data){let t=p(e.arranger_entities);t&&c.push({id:t.id,name:t.legal_name||"Unnamed Arranger",type:"arranger",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status})}let m=null,f=null;if(i.email){let e=`
        email,
        kyc_status,
        first_name,
        middle_name,
        middle_initial,
        last_name,
        name_suffix,
        date_of_birth,
        country_of_birth,
        nationality,
        phone_mobile,
        phone_office,
        residential_street,
        residential_line_2,
        residential_city,
        residential_state,
        residential_postal_code,
        residential_country,
        is_us_citizen,
        is_us_taxpayer,
        us_taxpayer_id,
        country_of_tax_residency,
        tax_id_number,
        id_type,
        id_number,
        id_issue_date,
        id_expiry_date,
        id_issuing_country,
        proof_of_address_date,
        proof_of_address_expiry
      `,[t,a,s,n,o,l]=await Promise.all([r.from("investor_members").select(e).eq("email",i.email).limit(1).maybeSingle(),r.from("partner_members").select(e).eq("email",i.email).limit(1).maybeSingle(),r.from("lawyer_members").select(e).eq("email",i.email).limit(1).maybeSingle(),r.from("introducer_members").select(e).eq("email",i.email).limit(1).maybeSingle(),r.from("arranger_members").select(e).eq("email",i.email).limit(1).maybeSingle(),r.from("commercial_partner_members").select(e).eq("email",i.email).limit(1).maybeSingle()]),d=[t.data,a.data,s.data,n.data,o.data,l.data].filter(Boolean),_={approved:5,submitted:4,pending:3,rejected:2,expired:1};d.sort((e,t)=>{let r=_[e?.kyc_status||""]||0;return(_[t?.kyc_status||""]||0)-r});let u=d[0];u&&(m={status:u.kyc_status,idType:u.id_type,idExpiry:u.id_expiry_date,idExpiryWarning:(0,w.getIdExpiryWarning)(u.id_expiry_date),nationality:u.nationality,taxResidency:u.country_of_tax_residency,isUsPerson:u.is_us_citizen||!1},f={kyc_status:u.kyc_status,first_name:u.first_name,middle_name:u.middle_name,middle_initial:u.middle_initial,last_name:u.last_name,name_suffix:u.name_suffix,date_of_birth:u.date_of_birth,country_of_birth:u.country_of_birth,nationality:u.nationality,email:u.email,phone_mobile:u.phone_mobile,phone_office:u.phone_office,residential_street:u.residential_street,residential_line_2:u.residential_line_2,residential_city:u.residential_city,residential_state:u.residential_state,residential_postal_code:u.residential_postal_code,residential_country:u.residential_country,is_us_citizen:u.is_us_citizen,is_us_taxpayer:u.is_us_taxpayer,us_taxpayer_id:u.us_taxpayer_id,country_of_tax_residency:u.country_of_tax_residency,tax_id_number:u.tax_id_number,id_type:u.id_type,id_number:u.id_number,id_issue_date:u.id_issue_date,id_expiry_date:u.id_expiry_date,id_issuing_country:u.id_issuing_country,proof_of_address_date:u.proof_of_address_date,proof_of_address_expiry:u.proof_of_address_expiry})}let y={id:i.id,displayName:i.display_name||"Unknown",email:i.email||"",systemRole:i.role||"investor",title:i.title,phone:i.phone,officeLocation:i.office_location,avatarUrl:i.avatar_url,createdAt:i.created_at,lastLoginAt:i.last_login_at,passwordSet:i.password_set||!1,isSuperAdmin:i.is_super_admin||!1,hasSignature:!!i.signature_specimen_url,isDeleted:!!i.deleted_at,entities:c,entityCount:c.length,kyc:m};return h.NextResponse.json({success:!0,data:y,fullKyc:f})}catch(t){console.error("[admin/users/[id]] GET Error:",t);let e=t instanceof Error?t.message:"Failed to fetch user";return h.NextResponse.json({success:!1,error:e},{status:500})}}let C=E.z.object({display_name:E.z.string().min(1).max(100).optional(),title:E.z.string().max(100).nullable().optional(),phone:E.z.string().max(50).nullable().optional(),office_location:E.z.string().max(100).nullable().optional()});async function A(e,{params:t}){try{let r=await (0,x.getCurrentUser)();if(!r)return h.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let a=(0,v.createServiceClient)();if(!await (0,R.isSuperAdmin)(a,r.id))return h.NextResponse.json({success:!1,error:"Forbidden"},{status:403});let{id:i}=await t,s=await e.json(),n=C.safeParse(s);if(!n.success)return h.NextResponse.json({success:!1,error:"Invalid input",details:n.error.flatten()},{status:400});if(0===Object.keys(n.data).length)return h.NextResponse.json({success:!1,error:"No fields provided for update"},{status:400});let{data:o,error:l}=await a.from("profiles").select("display_name, title, phone, office_location, email").eq("id",i).single();if(l||!o)return h.NextResponse.json({success:!1,error:"User not found"},{status:404});let{error:d}=await a.from("profiles").update(n.data).eq("id",i);if(d)return console.error("[admin/users/[id]] PATCH Update error:",d),h.NextResponse.json({success:!1,error:"Failed to update user"},{status:500});return await b.auditLogger.log({actor_user_id:r.id,action:"profile_updated",entity:b.AuditEntities.PROFILES,entity_id:i,metadata:{target_email:o.email,before:{display_name:o.display_name,title:o.title,phone:o.phone,office_location:o.office_location},after:n.data}}),h.NextResponse.json({success:!0,message:"User updated successfully"})}catch(t){console.error("[admin/users/[id]] PATCH Error:",t);let e=t instanceof Error?t.message:"Failed to update user";return h.NextResponse.json({success:!1,error:e},{status:500})}}e.s(["GET",()=>S,"PATCH",()=>A],506107);var P=e.i(506107);let N=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/admin/users/[id]/route",pathname:"/api/admin/users/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/admin/users/[id]/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:U,workUnitAsyncStorage:T,serverHooks:q}=N;function k(){return(0,a.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:T})}async function j(e,t,a){N.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let h="/api/admin/users/[id]/route";h=h.replace(/\/index$/,"")||"/";let v=await N.prepare(e,t,{srcPage:h,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:x,params:R,nextConfig:b,parsedUrl:w,isDraftMode:E,prerenderManifest:S,routerServerContext:C,isOnDemandRevalidate:A,revalidateOnlyGenerated:P,resolvedPathname:U,clientReferenceManifest:T,serverActionsManifest:q}=v,k=(0,o.normalizeAppPath)(h),j=!!(S.dynamicRoutes[k]||S.routes[U]),O=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,w,!1):t.end("This page could not be found"),null);if(j&&!E){let e=!!S.routes[U],t=S.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await O();throw new y.NoFallbackError}}let H=null;!j||N.isDev||E||(H="/index"===(H=U)?"/":H);let I=!0===N.isDev||!j,F=j&&!I;q&&T&&(0,n.setManifestsSingleton)({page:h,clientReferenceManifest:T,serverActionsManifest:q});let D=e.method||"GET",z=(0,s.getTracer)(),M=z.getActiveScopeSpan(),L={params:R,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:I,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>N.onRequestError(e,t,a,i,C)},sharedContext:{buildId:x}},$=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),B=d.NextRequestAdapter.fromNodeNextRequest($,(0,d.signalFromNodeResponse)(t));try{let n=async e=>N.handle(B,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=z.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==_.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${D} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${D} ${h}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var s,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&A&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await n(i);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!j)return await (0,c.sendResponse)($,K,s,L.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:h,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:A})},!1,C),t}},_=await N.handleResponse({req:e,nextConfig:b,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:P,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!j)return null;if((null==_||null==(s=_.value)?void 0:s.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==_||null==(l=_.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":_.isMiss?"MISS":_.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,p.fromNodeOutgoingHttpHeaders)(_.value.headers);return o&&j||y.delete(f.NEXT_CACHE_TAGS_HEADER),!_.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,m.getCacheControlHeader)(_.cacheControl)),await (0,c.sendResponse)($,K,new Response(_.value.body,{headers:y,status:_.value.status||200})),null};M?await l(M):await z.withPropagatedContext(e.headers,()=>z.trace(_.BaseServerSpan.handleRequest,{spanName:`${D} ${h}`,kind:s.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:A})},!1,C),j)throw t;return await (0,c.sendResponse)($,K,new Response(null,{status:500})),null}}e.s(["handler",()=>j,"patchFetch",()=>k,"routeModule",()=>N,"serverHooks",()=>q,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>T],792655)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_36c2b051.js.map