{"version":3,"sources":["../../../../../versotech-portal/src/lib/supabase/smart-client.ts","../../../../../versotech-portal/src/components/entities/entities-page-enhanced.tsx/__nextjs-internal-proxy.mjs","../../../../../versotech-portal/src/app/%28staff%29/versotech/staff/entities/page.tsx"],"sourcesContent":["import { createClient } from './server'\n\n/**\n * Create an authenticated Supabase client\n * Returns the standard authenticated client that respects RLS policies\n */\nexport async function createSmartClient() {\n  return await createClient()\n}\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const EntitiesPageEnhanced = registerClientReference(\n    function() { throw new Error(\"Attempted to call EntitiesPageEnhanced() from the server but EntitiesPageEnhanced is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/components/entities/entities-page-enhanced.tsx\",\n    \"EntitiesPageEnhanced\",\n);\n","import { createSmartClient } from '@/lib/supabase/smart-client'\nimport { EntitiesPageEnhanced } from '@/components/entities/entities-page-enhanced'\nimport { getCurrentUser } from '@/lib/auth'\nimport { redirect } from 'next/navigation'\n\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nexport default async function EntitiesPage() {\n  // Check authentication first\n  const user = await getCurrentUser()\n  if (!user || !(user.role.startsWith('staff_') || user.role === 'ceo')) {\n    redirect('/versotech/login')\n  }\n\n  const supabase = await createSmartClient()\n\n  console.log('[EntitiesPage] Loading entities for user:', user.email, 'role:', user.role)\n\n  // Select all fields including the new CSV fields\n  const { data: entities, error } = await supabase\n    .from('vehicles')\n    .select('*')\n    .order('entity_code', { ascending: true, nullsFirst: false })\n\n  if (error) {\n    console.error('[EntitiesPage] Error loading entities:', error)\n  }\n\n  let enrichedEntities = entities || []\n\n  if (entities && entities.length > 0) {\n    const vehicleIds = entities.map((entity) => entity.id)\n\n    try {\n      const [\n        { data: investorLinks, error: investorLinksError },\n        { data: subscriptionRows, error: subscriptionError },\n        { data: openFlags, error: openFlagsError },\n        { data: latestEvents, error: latestEventsError }\n      ] = await Promise.all([\n        supabase\n          .from('entity_investors')\n          .select('vehicle_id, investor_id')\n          .in('vehicle_id', vehicleIds),\n        supabase\n          .from('subscriptions')\n          .select('vehicle_id, investor_id')\n          .in('vehicle_id', vehicleIds),\n        supabase\n          .from('entity_flags')\n          .select('vehicle_id')\n          .eq('status', 'open')\n          .in('vehicle_id', vehicleIds),\n        supabase\n          .from('entity_events')\n          .select('vehicle_id, created_at')\n          .in('vehicle_id', vehicleIds)\n      ])\n\n      if (investorLinksError) {\n        console.error('[EntitiesPage] investor link aggregate error:', investorLinksError)\n      }\n      if (subscriptionError) {\n        console.error('[EntitiesPage] subscription aggregate error:', subscriptionError)\n      }\n      if (openFlagsError) {\n        console.error('[EntitiesPage] flag aggregate error:', openFlagsError)\n      }\n      if (latestEventsError) {\n        console.error('[EntitiesPage] event aggregate error:', latestEventsError)\n      }\n\n      const investorCountMap = new Map<string, Set<string>>()\n      ;(investorLinks ?? []).forEach((row) => {\n        if (!row?.vehicle_id) return\n        const set = investorCountMap.get(row.vehicle_id) ?? new Set<string>()\n        if (row.investor_id) {\n          set.add(row.investor_id)\n        } else {\n          set.add(`entity-link-${row.vehicle_id}-${set.size}`)\n        }\n        investorCountMap.set(row.vehicle_id, set)\n      })\n      ;(subscriptionRows ?? []).forEach((row) => {\n        if (!row?.vehicle_id || !row?.investor_id) return\n        const set = investorCountMap.get(row.vehicle_id) ?? new Set<string>()\n        set.add(row.investor_id)\n        investorCountMap.set(row.vehicle_id, set)\n      })\n\n      const flagCountMap = new Map<string, number>()\n      ;(openFlags ?? []).forEach((row) => {\n        if (!row?.vehicle_id) return\n        flagCountMap.set(\n          row.vehicle_id,\n          (flagCountMap.get(row.vehicle_id) || 0) + 1\n        )\n      })\n\n      const lastEventMap = new Map<string, string>()\n      ;(latestEvents ?? []).forEach((row) => {\n        if (!row?.vehicle_id || !row?.created_at) return\n        const current = lastEventMap.get(row.vehicle_id)\n        if (!current || new Date(row.created_at) > new Date(current)) {\n          lastEventMap.set(row.vehicle_id, row.created_at)\n        }\n      })\n\n      enrichedEntities = entities.map((entity) => ({\n        ...entity,\n        investor_count: investorCountMap.get(entity.id)?.size || 0,\n        open_flag_count: flagCountMap.get(entity.id) || 0,\n        last_event_at: lastEventMap.get(entity.id) || null\n      }))\n    } catch (aggregateError) {\n      console.error('[EntitiesPage] Failed to load entity aggregates:', aggregateError)\n    }\n  }\n\n  console.log('[EntitiesPage] Loaded', enrichedEntities.length, 'entities')\n\n  return (\n    <EntitiesPageEnhanced entities={enrichedEntities} />\n    )\n}\n\n"],"names":[],"mappings":"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","ignoreList":[1]}