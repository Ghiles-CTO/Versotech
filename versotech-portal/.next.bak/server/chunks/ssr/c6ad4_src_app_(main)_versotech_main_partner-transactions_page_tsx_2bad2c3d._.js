module.exports=[597582,a=>{"use strict";var b=a.i(352584),c=a.i(611038),d=a.i(284169),e=a.i(15788),f=a.i(421908),g=a.i(663475),h=a.i(951870),i=a.i(771088),j=a.i(989002),k=a.i(478870),l=a.i(155508),m=a.i(966494),n=a.i(487068),o=a.i(3321),p=a.i(877918),q=a.i(618287),r=a.i(278541),s=a.i(425622),t=a.i(438436),u=a.i(899750),v=a.i(888987),w=a.i(201986),x=a.i(58834),y=a.i(497412);function z(a){return a?Array.isArray(a)?a[0]||null:a:null}function A(a){return a?new Date(a).getTime():0}function B(a){let b=a.filter(a=>a.subscription?.status==="committed"||a.subscription?.status==="active").length,c=a.filter(a=>a.subscription?.status==="pending").length,d=0;for(let b of a)b.subscription&&("committed"===b.subscription.status||"active"===b.subscription.status)&&(d+=b.subscription.commitment);let e=a.find(a=>a.subscription?.currency)?.subscription?.currency||"USD";return{totalReferrals:a.length,convertedCount:b,pendingCount:c,totalCommitmentValue:d,currency:e}}let C={active:"bg-green-100 text-green-800 border-green-200",committed:"bg-blue-100 text-blue-800 border-blue-200",pending:"bg-yellow-100 text-yellow-800 border-yellow-200",cancelled:"bg-gray-100 text-gray-800 border-gray-200"},D=[{label:"All Status",value:"all"},{label:"Active",value:"active"},{label:"Committed",value:"committed"},{label:"Pending",value:"pending"},{label:"Cancelled",value:"cancelled"}],E=[{label:"All Stages",value:"all"},{label:"Dispatched",value:"dispatched"},{label:"Interested",value:"interested"},{label:"Passed",value:"passed"},{label:"Approved (Pack)",value:"approved"},{label:"Signed",value:"signed"},{label:"Funded",value:"funded"}];function F(){let[a,F]=(0,c.useState)(null),[G,H]=(0,c.useState)([]),[I,J]=(0,c.useState)({totalReferrals:0,convertedCount:0,pendingCount:0,totalCommitmentValue:0,currency:"USD"}),[K,L]=(0,c.useState)(!0),[M,N]=(0,c.useState)(null),[O,P]=(0,c.useState)(""),[Q,R]=(0,c.useState)("all"),[S,T]=(0,c.useState)("all"),[U,V]=(0,c.useState)(!1),W=async()=>{if(!a)return void u.toast.error("Export is only available for partner users");try{V(!0);let a=await fetch("/api/partners/me/transactions/export");if(429===a.status)return void u.toast.error("Please wait 1 minute between export requests");if(!a.ok){let b=await a.json();throw Error(b.error||"Export failed")}let b=await a.blob(),c=window.URL.createObjectURL(b),d=document.createElement("a");d.href=c,d.download=`partner-transactions-${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(d),d.click(),window.URL.revokeObjectURL(c),document.body.removeChild(d),u.toast.success("Transactions exported successfully")}catch(a){console.error("[PartnerTransactionsPage] Export error:",a),u.toast.error(a instanceof Error?a.message:"Failed to export transactions")}finally{V(!1)}};(0,c.useEffect)(()=>{let a=(0,x.createClient)(),b=async b=>{let c=Array.from(new Set(b.map(a=>a.investor_id).filter(a=>!!a))),d=Array.from(new Set(b.map(a=>a.deal_id).filter(a=>!!a))),e=new Map,f=new Map;if(c.length>0&&d.length>0){let{data:b,error:f}=await a.from("subscriptions").select("id, investor_id, deal_id, commitment, currency, status, committed_at, created_at").in("investor_id",c).in("deal_id",d);if(f)throw f;for(let a of b||[]){var g,h;let b=(g=a.investor_id,h=a.deal_id,`${g}:${h}`),c=e.get(b),d=Math.max(A(c?.committed_at),A(c?.created_at)),f=Math.max(A(a.committed_at),A(a.created_at));(!c||f>=d)&&e.set(b,a)}}if(d.length>0){let{data:b}=await a.from("fee_plans").select(`
            deal_id,
            is_default,
            fee_components (
              kind,
              rate_bps,
              flat_amount,
              calc_method
            )
          `).in("deal_id",d).eq("is_active",!0);if(b)for(let a of b){let b=(a.fee_components||[]).find(a=>"referral"===a.kind||"success"===a.kind||"commission"===a.kind);if(b&&a.deal_id){let c=e.get(`${a.deal_id}`)||Array.from(e.values()).find(b=>b.deal_id===a.deal_id);f.set(a.deal_id,{rate_bps:b.rate_bps,flat_amount:b.flat_amount,currency:c?.currency||"USD",kind:b.kind})}}}return b.map(a=>{var b,c;let d=z(a.investor),g=z(a.deal),h=a.investor_id&&a.deal_id&&e.get((b=a.investor_id,c=a.deal_id,`${b}:${c}`))||null,i=`${a.deal_id||"no-deal"}-${a.investor_id||"no-investor"}`,j="dispatched";if(h){let b=h.status||"";"active"===b||"committed"===b?j="funded":"signed"===b?j="signed":"approved"===b?j="approved":"cancelled"===b||"rejected"===b?j="passed":a.interest_confirmed_at&&(j="interested")}else a.interest_confirmed_at&&(j="interested");return{id:i,investor:d?{id:d.id,legal_name:d.legal_name||"Unknown"}:null,deal:g?{id:g.id,name:g.name||"Unknown Deal",company_name:g.company_name??null,status:g.status||"unknown"}:null,subscription:h?{id:h.id,commitment:Number(h.commitment)||0,currency:h.currency||"USD",status:h.status||"pending",committed_at:h.committed_at}:null,referred_at:a.dispatched_at,role:a.role||"investor",investorStage:j,interest_confirmed_at:a.interest_confirmed_at,feeModel:g&&f.get(g.id)||null}})};async function c(){let{data:c,error:d}=await a.from("deal_memberships").select(`
          role,
          dispatched_at,
          interest_confirmed_at,
          deal_id,
          investor_id,
          referred_by_entity_id,
          investor:investor_id (
            id,
            legal_name
          ),
          deal:deal_id (
            id,
            name,
            company_name,
            status
          )
        `).eq("referred_by_entity_type","partner").order("dispatched_at",{ascending:!1}).limit(100);if(d)throw d;let e=await b(c||[]);H(e),J(B(e))}!async function(){try{L(!0);let{data:{user:d}}=await a.auth.getUser();if(!d)return void N("Not authenticated");let{data:e,error:f}=await a.from("partner_users").select("partner_id").eq("user_id",d.id).single();if(f||!e)return void await c();let{data:g,error:h}=await a.from("partners").select("id, name, legal_name, partner_type, status").eq("id",e.partner_id).single();if(h)throw h;F(g);let{data:i,error:j}=await a.from("deal_memberships").select(`
            role,
            dispatched_at,
            interest_confirmed_at,
            deal_id,
            investor_id,
            investor:investor_id (
              id,
              legal_name
            ),
            deal:deal_id (
              id,
              name,
              company_name,
              status
            )
          `).eq("referred_by_entity_id",e.partner_id).eq("referred_by_entity_type","partner").order("dispatched_at",{ascending:!1});if(j)throw j;let k=await b(i||[]);H(k),J(B(k)),N(null)}catch(a){console.error("[PartnerTransactionsPage] Error:",a),N(a instanceof Error?a.message:"Failed to load transactions")}finally{L(!1)}}()},[]);let X=G.filter(a=>{let b=a.subscription?.status||"no_subscription",c="all"===Q||b===Q,d="all"===S||a.investorStage===S,e=!O||a.investor?.legal_name?.toLowerCase().includes(O.toLowerCase())||a.deal?.name?.toLowerCase().includes(O.toLowerCase())||a.deal?.company_name?.toLowerCase().includes(O.toLowerCase());return c&&d&&e});return K?(0,b.jsxs)("div",{className:"flex items-center justify-center py-16",children:[(0,b.jsx)(o.Loader2,{className:"h-8 w-8 animate-spin text-muted-foreground"}),(0,b.jsx)("span",{className:"ml-3 text-muted-foreground",children:"Loading transactions..."})]}):M?(0,b.jsxs)("div",{className:"text-center py-16",children:[(0,b.jsx)(p.AlertCircle,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),(0,b.jsx)("h3",{className:"text-lg font-medium text-foreground mb-2",children:"Error Loading Transactions"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:M})]}):(0,b.jsxs)("div",{className:"p-6 space-y-6",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-2xl font-bold text-foreground",children:"Partner Transactions"}),(0,b.jsx)("p",{className:"text-muted-foreground mt-1",children:a?`Track referrals and investments as ${a.name}`:"View all partner-referred transactions across the platform"})]}),(0,b.jsx)("div",{className:"flex items-center gap-2",children:a&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)(f.Button,{variant:"outline",onClick:W,disabled:U||0===G.length,children:[U?(0,b.jsx)(o.Loader2,{className:"h-4 w-4 mr-2 animate-spin"}):(0,b.jsx)(s.Download,{className:"h-4 w-4 mr-2"}),"Export CSV"]}),(0,b.jsx)(e.Badge,{variant:"outline",className:"capitalize",children:a.partner_type})]})})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,b.jsxs)(d.Card,{children:[(0,b.jsx)(d.CardHeader,{className:"pb-2",children:(0,b.jsxs)(d.CardTitle,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[(0,b.jsx)(k.Users,{className:"h-4 w-4"}),"Total Referrals"]})}),(0,b.jsxs)(d.CardContent,{children:[(0,b.jsx)("div",{className:"text-2xl font-bold",children:I.totalReferrals}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"Investors referred to deals"})]})]}),(0,b.jsxs)(d.Card,{children:[(0,b.jsx)(d.CardHeader,{className:"pb-2",children:(0,b.jsxs)(d.CardTitle,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[(0,b.jsx)(m.TrendingUp,{className:"h-4 w-4"}),"Converted"]})}),(0,b.jsxs)(d.CardContent,{children:[(0,b.jsx)("div",{className:"text-2xl font-bold text-green-600",children:I.convertedCount}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"Successfully invested"})]})]}),(0,b.jsxs)(d.Card,{children:[(0,b.jsx)(d.CardHeader,{className:"pb-2",children:(0,b.jsxs)(d.CardTitle,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[(0,b.jsx)(j.ArrowRightLeft,{className:"h-4 w-4"}),"Pending"]})}),(0,b.jsxs)(d.CardContent,{children:[(0,b.jsx)("div",{className:"text-2xl font-bold text-orange-500",children:I.pendingCount}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"Awaiting completion"})]})]}),(0,b.jsxs)(d.Card,{children:[(0,b.jsx)(d.CardHeader,{className:"pb-2",children:(0,b.jsxs)(d.CardTitle,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[(0,b.jsx)(l.DollarSign,{className:"h-4 w-4"}),"Total Value"]})}),(0,b.jsxs)(d.CardContent,{children:[(0,b.jsx)("div",{className:"text-2xl font-bold",children:(0,w.formatCurrency)(I.totalCommitmentValue,I.currency)}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"Converted commitments"})]})]})]}),(0,b.jsx)(d.Card,{children:(0,b.jsx)(d.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"flex flex-col md:flex-row gap-4",children:[(0,b.jsx)("div",{className:"flex-1",children:(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)(n.Search,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,b.jsx)(g.Input,{placeholder:"Search by investor, deal, or company...",value:O,onChange:a=>P(a.target.value),className:"pl-10"})]})}),(0,b.jsxs)(h.Select,{value:Q,onValueChange:R,children:[(0,b.jsx)(h.SelectTrigger,{className:"w-full md:w-48",children:(0,b.jsx)(h.SelectValue,{placeholder:"Filter by status"})}),(0,b.jsx)(h.SelectContent,{children:D.map(a=>(0,b.jsx)(h.SelectItem,{value:a.value,children:a.label},a.value))})]}),(0,b.jsxs)(h.Select,{value:S,onValueChange:T,children:[(0,b.jsx)(h.SelectTrigger,{className:"w-full md:w-48",children:(0,b.jsx)(h.SelectValue,{placeholder:"Filter by stage"})}),(0,b.jsx)(h.SelectContent,{children:E.map(a=>(0,b.jsx)(h.SelectItem,{value:a.value,children:a.label},a.value))})]})]})})}),(0,b.jsxs)(d.Card,{children:[(0,b.jsxs)(d.CardHeader,{children:[(0,b.jsx)(d.CardTitle,{children:"Transactions"}),(0,b.jsxs)(d.CardDescription,{children:[X.length," transaction",1!==X.length?"s":""," found"]})]}),(0,b.jsx)(d.CardContent,{children:0===X.length?(0,b.jsxs)("div",{className:"border border-dashed border-muted rounded-lg py-12 flex flex-col items-center justify-center text-center space-y-2",children:[(0,b.jsx)(r.Building2,{className:"h-10 w-10 text-muted-foreground"}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:O||"all"!==Q||"all"!==S?"No transactions match your filters":"No partner transactions yet"}),!a&&0===G.length&&(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"Partner referrals will appear here when investors are referred via partner relationships"})]}):(0,b.jsx)("div",{className:"rounded-md border",children:(0,b.jsxs)(i.Table,{children:[(0,b.jsx)(i.TableHeader,{children:(0,b.jsxs)(i.TableRow,{children:[(0,b.jsx)(i.TableHead,{children:"Investor"}),(0,b.jsx)(i.TableHead,{children:"Deal"}),(0,b.jsx)(i.TableHead,{children:"Commitment"}),(0,b.jsx)(i.TableHead,{children:"Commission"}),(0,b.jsx)(i.TableHead,{children:"Status"}),(0,b.jsx)(i.TableHead,{children:"Stage"}),(0,b.jsx)(i.TableHead,{children:"Referred"}),(0,b.jsx)(i.TableHead,{className:"text-right",children:"Actions"})]})}),(0,b.jsx)(i.TableBody,{children:X.map(a=>(0,b.jsxs)(i.TableRow,{children:[(0,b.jsx)(i.TableCell,{children:a.investor?(0,b.jsx)("div",{className:"font-medium",children:a.investor.legal_name}):(0,b.jsx)("span",{className:"text-muted-foreground",children:"—"})}),(0,b.jsx)(i.TableCell,{children:a.deal?(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"font-medium",children:a.deal.name}),a.deal.company_name&&(0,b.jsx)("div",{className:"text-xs text-muted-foreground",children:a.deal.company_name})]}):(0,b.jsx)("span",{className:"text-muted-foreground",children:"—"})}),(0,b.jsx)(i.TableCell,{children:a.subscription?(0,b.jsx)("div",{className:"font-medium",children:(0,w.formatCurrency)(a.subscription.commitment,a.subscription.currency)}):(0,b.jsx)("span",{className:"text-muted-foreground text-sm",children:"Not subscribed"})}),(0,b.jsx)(i.TableCell,{children:a.feeModel?(0,b.jsxs)("div",{className:"flex items-center gap-1",children:[(0,b.jsx)(t.Percent,{className:"h-3 w-3 text-emerald-600"}),(0,b.jsx)("span",{className:"text-sm font-medium text-emerald-600",children:a.feeModel.rate_bps?`${(a.feeModel.rate_bps/100).toFixed(2)}%`:a.feeModel.flat_amount?(0,w.formatCurrency)(a.feeModel.flat_amount,a.feeModel.currency):"—"}),a.subscription&&a.feeModel.rate_bps&&(0,b.jsxs)("span",{className:"text-xs text-muted-foreground ml-1",children:["(~",(0,w.formatCurrency)(a.subscription.commitment*a.feeModel.rate_bps/1e4,a.subscription.currency),")"]})]}):(0,b.jsx)("span",{className:"text-muted-foreground text-xs",children:"Not set"})}),(0,b.jsx)(i.TableCell,{children:a.subscription?(0,b.jsx)(e.Badge,{variant:"outline",className:(0,v.cn)("capitalize",C[a.subscription.status]||C.pending),children:a.subscription.status.replace("_"," ")}):(0,b.jsx)(e.Badge,{variant:"outline",className:"text-gray-500",children:"Referred"})}),(0,b.jsx)(i.TableCell,{children:(0,b.jsx)(e.Badge,{variant:"outline",className:(0,v.cn)("capitalize","funded"===a.investorStage&&"bg-green-100 text-green-800 border-green-200","signed"===a.investorStage&&"bg-blue-100 text-blue-800 border-blue-200","approved"===a.investorStage&&"bg-purple-100 text-purple-800 border-purple-200","passed"===a.investorStage&&"bg-red-100 text-red-800 border-red-200","interested"===a.investorStage&&"bg-yellow-100 text-yellow-800 border-yellow-200","dispatched"===a.investorStage&&"bg-gray-100 text-gray-600 border-gray-200"),children:a.investorStage})}),(0,b.jsx)(i.TableCell,{children:a.referred_at?(0,w.formatDate)(a.referred_at):"—"}),(0,b.jsx)(i.TableCell,{className:"text-right",children:(0,b.jsx)("div",{className:"flex items-center justify-end gap-2",children:a.deal&&(0,b.jsx)(f.Button,{variant:"ghost",size:"sm",asChild:!0,children:(0,b.jsx)(y.default,{href:`/versotech_main/opportunities/${a.deal.id}`,children:(0,b.jsx)(q.ExternalLink,{className:"h-4 w-4"})})})})})]},a.id))})]})})})]})]})}a.s(["default",()=>F])}];

//# sourceMappingURL=c6ad4_src_app_%28main%29_versotech_main_partner-transactions_page_tsx_2bad2c3d._.js.map