{"version":3,"sources":["../../../../../versotech-portal/src/components/deals/deal-detail-client.tsx/__nextjs-internal-proxy.mjs","../../../../../versotech-portal/src/app/%28staff%29/versotech/staff/deals/%5Bid%5D/page.tsx"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const DealDetailClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call DealDetailClient() from the server but DealDetailClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/components/deals/deal-detail-client.tsx\",\n    \"DealDetailClient\",\n);\n","import { createServiceClient, createClient } from '@/lib/supabase/server'\nimport { requireStaffAuth } from '@/lib/auth'\nimport { redirect } from 'next/navigation'\nimport { DealDetailClient } from '@/components/deals/deal-detail-client'\n\nexport const dynamic = 'force-dynamic'\n\nexport default async function DealDetailPage({\n  params\n}: {\n  params: Promise<{ id: string }>\n}) {\n  const { id: dealId } = await params\n  \n  // Verify staff authentication and get user\n  const authSupabase = await createClient()\n  const { data: { user } } = await authSupabase.auth.getUser()\n  \n  if (!user) {\n    redirect('/versotech/login')\n  }\n  \n  // Get user profile for role\n  const { data: userProfile } = await authSupabase\n    .from('profiles')\n    .select('role')\n    .eq('id', user.id)\n    .single()\n  \n  if (!userProfile || !['staff_admin', 'staff_ops', 'staff_rm', 'ceo'].includes(userProfile.role)) {\n    redirect('/versotech/staff')\n  }\n  \n  const userRole = userProfile.role\n  \n  // Use service client to bypass RLS for staff users\n  const supabase = createServiceClient()\n\n  // Fetch deal with all related data\n  const { data: deal, error } = await supabase\n    .from('deals')\n    .select(`\n      *,\n      vehicles (\n        id,\n        name,\n        type,\n        currency\n      ),\n      deal_memberships (\n        user_id,\n        investor_id,\n        role,\n        invited_at,\n        accepted_at,\n        profiles:user_id (\n          id,\n          display_name,\n          email\n        ),\n        investors:investor_id (\n          id,\n          legal_name,\n          type\n        ),\n        invited_by_profile:invited_by (\n          display_name,\n          email\n        )\n      ),\n      fee_plans (\n        id,\n        name,\n        description,\n        is_default,\n        is_active,\n        fee_components (\n          id,\n          kind,\n          calc_method,\n          rate_bps,\n          flat_amount,\n          frequency,\n          payment_schedule,\n          duration_periods,\n          duration_unit,\n          hurdle_rate_bps,\n          has_catchup,\n          catchup_rate_bps,\n          has_high_water_mark,\n          tier_threshold_multiplier,\n          base_calculation,\n          notes\n        )\n      ),\n      share_lots (\n        id,\n        source_id,\n        units_total,\n        unit_cost,\n        units_remaining,\n        currency,\n        acquired_at,\n        lockup_until,\n        status,\n        share_sources:source_id (\n          id,\n          kind,\n          counterparty_name,\n          notes\n        )\n      )\n    `)\n    .eq('id', dealId)\n    .single()\n\n  if (error) {\n    console.error('[Deal Detail] Error fetching deal:', error)\n    redirect('/versotech/staff/deals')\n  }\n\n  if (!deal) {\n    console.error('[Deal Detail] Deal not found with ID:', dealId)\n    redirect('/versotech/staff/deals')\n  }\n\n  console.log('[Deal Detail] Deal loaded successfully:', deal.name)\n\n  // Fetch inventory summary\n  const { data: inventorySummary } = await supabase\n    .rpc('fn_deal_inventory_summary', { p_deal_id: dealId })\n\n  // Fetch deal-scoped documents\n  const { data: documents } = await supabase\n    .from('deal_data_room_documents')\n    .select(`\n      id,\n      file_key,\n      created_at,\n      created_by,\n      created_by_profile:created_by (\n        display_name\n      )\n    `)\n    .eq('deal_id', dealId)\n    .order('created_at', { ascending: false })\n\n  // Fetch term sheet versions\n  const { data: termSheets } = await supabase\n    .from('deal_fee_structures')\n    .select('*')\n    .eq('deal_id', dealId)\n    .order('created_at', { ascending: false })\n\n  // Fetch investor interest submissions\n  const { data: interests } = await supabase\n    .from('investor_deal_interest')\n    .select(`\n      *,\n      investors (\n        id,\n        legal_name\n      )\n    `)\n    .eq('deal_id', dealId)\n    .order('submitted_at', { ascending: false })\n\n  // Fetch data room access records\n  const { data: dataRoomAccess } = await supabase\n    .from('deal_data_room_access')\n    .select(`\n      *,\n      investors (\n        id,\n        legal_name\n      )\n    `)\n    .eq('deal_id', dealId)\n    .order('granted_at', { ascending: false })\n\n  // Fetch data room documents\n  const { data: dataRoomDocuments } = await supabase\n    .from('deal_data_room_documents')\n    .select('*')\n    .eq('deal_id', dealId)\n    .order('folder', { ascending: true })\n    .order('created_at', { ascending: true })\n\n  // Fetch subscription submissions\n  const { data: subscriptions } = await supabase\n    .from('deal_subscription_submissions')\n    .select(`\n      *,\n      investors (\n        id,\n        legal_name\n      )\n    `)\n    .eq('deal_id', dealId)\n    .order('submitted_at', { ascending: false })\n\n  const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString()\n\n  const { data: activityEvents } = await supabase\n    .from('deal_activity_events')\n    .select('event_type, occurred_at')\n    .eq('deal_id', dealId)\n    .gte('occurred_at', ninetyDaysAgo)\n\n  const activitySummary = (activityEvents ?? []).reduce<Record<string, number>>((acc, event) => {\n    acc[event.event_type] = (acc[event.event_type] ?? 0) + 1\n    return acc\n  }, {})\n\n  // Filter only active fee plans\n  const dealWithActiveFeePlans = {\n    ...deal,\n    fee_plans: (deal.fee_plans || []).filter((plan: any) => plan.is_active !== false)\n  }\n\n  return (\n    <DealDetailClient\n        deal={dealWithActiveFeePlans}\n        inventorySummary={inventorySummary?.[0] || {\n          total_units: 0,\n          available_units: 0,\n          reserved_units: 0,\n          allocated_units: 0\n        }}\n        documents={documents || []}\n        termSheets={termSheets || []}\n        interests={interests || []}\n        dataRoomAccess={dataRoomAccess || []}\n        dataRoomDocuments={dataRoomDocuments || []}\n        subscriptions={subscriptions || []}\n        activitySummary={activitySummary}\n        userProfile={{ role: userRole }}\n      />\n    )\n}\n"],"names":[],"mappings":"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","ignoreList":[0]}