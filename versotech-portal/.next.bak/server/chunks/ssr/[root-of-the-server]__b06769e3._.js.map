{"version":3,"sources":["../../../../../versotech-portal/src/app/%28staff%29/versotech/staff/versosign/versosign-page-client.tsx/__nextjs-internal-proxy.mjs","../../../../../versotech-portal/src/app/%28staff%29/versotech/staff/versosign/page.tsx"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const VersoSignPageClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call VersoSignPageClient() from the server but VersoSignPageClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/app/(staff)/versotech/staff/versosign/versosign-page-client.tsx\",\n    \"VersoSignPageClient\",\n);\n","import { createClient } from '@/lib/supabase/server'\r\nimport { VersoSignPageClient } from './versosign-page-client'\r\nimport { redirect } from 'next/navigation'\r\nimport { getCurrentUser } from '@/lib/auth'\r\n\r\nexport const dynamic = 'force-dynamic'\r\n\r\nexport interface SignatureInstructions {\r\n  type: 'signature' | 'manual_follow_up'\r\n  action_url?: string\r\n  signature_request_id?: string\r\n  document_id?: string\r\n  document_type?: string\r\n  signer_role?: string\r\n  signer_name?: string\r\n  signature_position?: 'party_a' | 'party_b'\r\n  signing_order?: number\r\n  requires_prior_signature?: 'party_a' | 'party_b'\r\n  investor_name?: string\r\n  investor_email?: string\r\n  action_required?: string\r\n}\r\n\r\nexport interface SignatureTask {\r\n  id: string\r\n  owner_user_id: string\r\n  kind: string\r\n  category: string | null\r\n  title: string\r\n  description: string | null\r\n  instructions: SignatureInstructions | null\r\n  priority: 'low' | 'medium' | 'high'\r\n  status: 'pending' | 'in_progress' | 'completed' | 'overdue' | 'waived' | 'blocked'\r\n  due_at: string | null\r\n  started_at: string | null\r\n  completed_at: string | null\r\n  created_at: string\r\n  updated_at: string | null\r\n  related_entity_type: string | null\r\n  related_entity_id: string | null\r\n  metadata: {\r\n    subscription_id?: string\r\n    document_id?: string\r\n    investor_id?: string\r\n    vehicle_id?: string\r\n    investor_name?: string\r\n    issue?: string\r\n  } | null\r\n  // Computed flag: true if the linked signature request has expired\r\n  _expired?: boolean\r\n}\r\n\r\nexport interface ExpiredSignature {\r\n  id: string\r\n  signer_name: string\r\n  signer_email: string\r\n  document_type: string\r\n  token_expires_at: string\r\n  created_at: string\r\n  investor_id: string\r\n  investor?: {\r\n    display_name: string | null\r\n    legal_name: string | null\r\n  }\r\n}\r\n\r\nexport interface SignatureGroup {\r\n  category: 'countersignatures' | 'follow_ups' | 'other' | 'expired'\r\n  title: string\r\n  description: string\r\n  tasks: SignatureTask[]\r\n  expiredSignatures?: ExpiredSignature[]\r\n}\r\n\r\nexport default async function StaffSignaturesPage() {\r\n  const user = await getCurrentUser()\r\n\r\n  if (!user || !(user.role?.startsWith('staff_') || user.role === 'ceo')) {\r\n    redirect('/versotech/login')\r\n  }\r\n\r\n  const supabase = await createClient()\r\n\r\n  // Fetch all signature-related tasks for this staff member\r\n  const { data: allTasks } = await supabase\r\n    .from('tasks')\r\n    .select('*')\r\n    .eq('owner_user_id', user.id)\r\n    .in('kind', ['countersignature', 'subscription_pack_signature', 'other'])\r\n    .order('due_at', { ascending: true, nullsFirst: false })\r\n\r\n  // Filter out pending/in_progress tasks where the linked signature request has expired\r\n  // This prevents showing \"Sign Document\" for expired signature requests\r\n  let tasks = allTasks || []\r\n\r\n  if (tasks.length > 0) {\r\n    // Get signature request IDs for pending tasks\r\n    const pendingTasksWithSignatureRef = tasks.filter(\r\n      t => (t.status === 'pending' || t.status === 'in_progress') &&\r\n           t.related_entity_type === 'signature_request' &&\r\n           t.related_entity_id\r\n    )\r\n\r\n    if (pendingTasksWithSignatureRef.length > 0) {\r\n      const signatureRequestIds = pendingTasksWithSignatureRef.map(t => t.related_entity_id)\r\n\r\n      // Check which signature requests are expired\r\n      const { data: expiredSigRequests } = await supabase\r\n        .from('signature_requests')\r\n        .select('id')\r\n        .in('id', signatureRequestIds)\r\n        .eq('status', 'expired')\r\n\r\n      const expiredIds = new Set((expiredSigRequests || []).map(s => s.id))\r\n\r\n      // Filter out tasks with expired signature requests from actionable view\r\n      // Move them to a separate \"expired tasks\" category\r\n      tasks = tasks.map(t => {\r\n        if (expiredIds.has(t.related_entity_id) &&\r\n            (t.status === 'pending' || t.status === 'in_progress')) {\r\n          // Mark as expired for UI purposes (don't mutate DB here)\r\n          return { ...t, _expired: true }\r\n        }\r\n        return t\r\n      })\r\n    }\r\n  }\r\n\r\n  // Fetch expired signature requests\r\n  const { data: expiredSignatures } = await supabase\r\n    .from('signature_requests')\r\n    .select(`\r\n      id, signer_name, signer_email, document_type,\r\n      token_expires_at, created_at, investor_id,\r\n      investor:investors(display_name, legal_name)\r\n    `)\r\n    .eq('status', 'expired')\r\n    .order('token_expires_at', { ascending: false })\r\n    .limit(50)\r\n\r\n  // Sort by priority (high → medium → low), then by due_at\r\n  const priorityOrder: Record<string, number> = { high: 0, medium: 1, low: 2 }\r\n  const sortedTasks = ((tasks as SignatureTask[]) || []).sort((a, b) => {\r\n    const pA = priorityOrder[a.priority] ?? 99\r\n    const pB = priorityOrder[b.priority] ?? 99\r\n    if (pA !== pB) return pA - pB\r\n    if (!a.due_at && !b.due_at) return 0\r\n    if (!a.due_at) return 1\r\n    if (!b.due_at) return -1\r\n    return new Date(a.due_at).getTime() - new Date(b.due_at).getTime()\r\n  })\r\n\r\n  // Separate expired tasks from actionable tasks\r\n  const actionableTasks = sortedTasks.filter(t => !t._expired)\r\n  const expiredTasks = sortedTasks.filter(t => t._expired)\r\n\r\n  // Group tasks by type\r\n  const signatureGroups: SignatureGroup[] = [\r\n    {\r\n      category: 'countersignatures',\r\n      title: 'Pending Countersignatures',\r\n      description: 'Subscription agreements awaiting your countersignature',\r\n      // Only show non-expired tasks in actionable view\r\n      tasks: actionableTasks.filter(t =>\r\n        t.kind === 'countersignature' &&\r\n        (t.status === 'pending' || t.status === 'in_progress')\r\n      )\r\n    },\r\n    {\r\n      category: 'follow_ups',\r\n      title: 'Manual Follow-ups Required',\r\n      description: 'Investors without platform accounts - manual intervention needed',\r\n      tasks: actionableTasks.filter(t =>\r\n        t.metadata?.issue === 'investor_no_user_account' &&\r\n        t.status === 'pending'\r\n      )\r\n    },\r\n    {\r\n      category: 'other',\r\n      title: 'Completed Signatures',\r\n      description: 'Recently completed signature tasks',\r\n      tasks: sortedTasks.filter(t =>\r\n        (t.kind === 'countersignature' || t.kind === 'subscription_pack_signature') &&\r\n        t.status === 'completed'\r\n      ).slice(0, 10) // Show last 10 completed\r\n    },\r\n    {\r\n      category: 'expired',\r\n      title: 'Expired Signatures',\r\n      description: 'Signature requests that have expired - may need to be resent',\r\n      // Include both expired signature requests AND tasks with expired signatures\r\n      tasks: expiredTasks,\r\n      expiredSignatures: (expiredSignatures as unknown as ExpiredSignature[]) || []\r\n    }\r\n  ]\r\n\r\n  // Get stats for dashboard (only count actionable tasks)\r\n  const stats = {\r\n    pending: actionableTasks.filter(t => t.status === 'pending').length,\r\n    in_progress: actionableTasks.filter(t => t.status === 'in_progress').length,\r\n    completed_today: sortedTasks.filter(t =>\r\n      t.status === 'completed' &&\r\n      t.completed_at &&\r\n      new Date(t.completed_at).toDateString() === new Date().toDateString()\r\n    ).length,\r\n    overdue: actionableTasks.filter(t =>\r\n      t.status === 'pending' &&\r\n      t.due_at &&\r\n      new Date(t.due_at) < new Date()\r\n    ).length,\r\n    expired: (expiredSignatures || []).length + expiredTasks.length\r\n  }\r\n\r\n  return (\r\n    <VersoSignPageClient\r\n      userId={user.id}\r\n      signatureGroups={signatureGroups}\r\n      stats={stats}\r\n    />\r\n  )\r\n}"],"names":[],"mappings":"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","ignoreList":[0]}