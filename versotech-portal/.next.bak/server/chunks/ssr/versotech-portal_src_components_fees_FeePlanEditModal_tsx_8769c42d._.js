module.exports=[283732,a=>{"use strict";var b=a.i(352584),c=a.i(611038),d=a.i(359976),e=a.i(392009),f=a.i(470305),g=a.i(421908),h=a.i(663475),i=a.i(249464),j=a.i(951870),k=a.i(266828),l=a.i(15788),m=a.i(405708),n=a.i(134303),o=a.i(3321),p=a.i(838086),q=a.i(168118),r=a.i(816854),s=a.i(155508),t=a.i(689680),u=a.i(696661),v=a.i(278541),w=a.i(877918);function x({dealId:a,value:d,onChange:e,required:f=!0,disabled:g=!1}){let[h,k]=(0,c.useState)(!1),[m,n]=(0,c.useState)([]),[p,q]=(0,c.useState)(null);(0,c.useEffect)(()=>{a?s(a):(n([]),e(void 0,null))},[a]);let s=async a=>{k(!0),q(null);try{let b=await fetch(`/api/deals/${a}/fee-structures?status=published`);if(!b.ok)throw Error("Failed to load term sheets");let c=(await b.json()).term_sheets||[];n(c),d&&!c.find(a=>a.id===d)&&e(void 0,null)}catch(a){console.error("Error loading term sheets:",a),q("Failed to load term sheets"),n([])}finally{k(!1)}},t=a=>null==a?"-":`${a}%`,u=m.find(a=>a.id===d);return a?(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(i.Label,{className:"text-foreground font-medium",children:["Term Sheet ",f&&(0,b.jsx)("span",{className:"text-red-500 dark:text-red-400",children:"*"})]}),h?(0,b.jsxs)("div",{className:"flex items-center gap-2 text-muted-foreground h-11 px-3 border border-border rounded-md bg-muted/50",children:[(0,b.jsx)(o.Loader2,{className:"h-4 w-4 animate-spin"}),(0,b.jsx)("span",{className:"text-sm",children:"Loading term sheets..."})]}):p?(0,b.jsxs)("div",{className:"flex items-center gap-2 text-red-500 dark:text-red-400 text-sm bg-red-500/10 p-3 rounded border border-red-500/30",children:[(0,b.jsx)(w.AlertCircle,{className:"h-4 w-4"}),(0,b.jsx)("span",{children:p})]}):0===m.length?(0,b.jsxs)("div",{className:"flex items-center gap-2 text-amber-600 dark:text-amber-400 text-sm bg-amber-500/10 p-3 rounded border border-amber-500/30",children:[(0,b.jsx)(w.AlertCircle,{className:"h-4 w-4"}),(0,b.jsx)("span",{children:"No published term sheets available for this deal. Create and publish a term sheet first."})]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)(j.Select,{value:d||"none",onValueChange:a=>{if("none"===a)e(void 0,null);else{let b=m.find(b=>b.id===a);e(a,b||null)}},disabled:g,children:[(0,b.jsx)(j.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-11",children:(0,b.jsx)(j.SelectValue,{placeholder:"Select a term sheet"})}),(0,b.jsxs)(j.SelectContent,{className:"bg-popover border-border",children:[!f&&(0,b.jsx)(j.SelectItem,{value:"none",children:"No term sheet"}),m.map(a=>(0,b.jsx)(j.SelectItem,{value:a.id,children:(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(r.FileText,{className:"h-4 w-4 text-muted-foreground"}),(0,b.jsxs)("span",{children:["Version ",a.version]}),a.term_sheet_date&&(0,b.jsxs)("span",{className:"text-muted-foreground text-xs",children:["(",new Date(a.term_sheet_date).toLocaleDateString(),")"]})]})},a.id))]})]}),u&&(0,b.jsxs)("div",{className:"bg-muted/50 border border-border rounded-md p-3 mt-2",children:[(0,b.jsx)("p",{className:"text-xs text-muted-foreground mb-2 font-medium",children:"Term Sheet Fee Limits:"}),(0,b.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,b.jsxs)(l.Badge,{variant:"outline",className:"text-xs border-blue-500/30 text-blue-600 dark:text-blue-400",children:["Subscription: ",t(u.subscription_fee_percent)]}),(0,b.jsxs)(l.Badge,{variant:"outline",className:"text-xs border-green-500/30 text-green-600 dark:text-green-400",children:["Management: ",t(u.management_fee_percent)]}),(0,b.jsxs)(l.Badge,{variant:"outline",className:"text-xs border-purple-500/30 text-purple-600 dark:text-purple-400",children:["Performance: ",t(u.carried_interest_percent)]})]}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-2",children:"Fee model values must not exceed these limits."})]})]})]}):(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(i.Label,{className:"text-foreground font-medium",children:["Term Sheet ",f&&(0,b.jsx)("span",{className:"text-red-500 dark:text-red-400",children:"*"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 text-amber-600 dark:text-amber-400 text-sm bg-amber-500/10 p-3 rounded border border-amber-500/30",children:[(0,b.jsx)(w.AlertCircle,{className:"h-4 w-4"}),(0,b.jsx)("span",{children:"Select a deal first to see available term sheets"})]})]})}var y=a.i(478870),z=a.i(871057);function A({dealId:a,entityType:d,onEntityTypeChange:e,entityId:f,onEntityIdChange:g,required:h=!0,disabled:k=!1,excludeTypes:l=[]}){let[m,n]=(0,c.useState)(!1),[p,q]=(0,c.useState)([]),[r,s]=(0,c.useState)(null);(0,c.useEffect)(()=>{a&&d?t(a,d):(q([]),g(void 0))},[a,d]);let t=async(a,b)=>{n(!0),s(null);try{let c="";switch(b){case"introducer":c=`/api/deals/${a}/introducers`;break;case"partner":c=`/api/deals/${a}/partners`;break;case"commercial_partner":c=`/api/deals/${a}/commercial-partners`}let d=await fetch(c);if(!d.ok){console.warn(`Entity endpoint ${c} not available, trying fallback`),await u(b);return}let e=await d.json(),h=e.introducers||e.partners||e.commercial_partners||[];if(0===h.length&&e.data&&Array.isArray(e.data)&&(h=e.data.filter(a=>a.entity_type===b.replace("_","")).map(a=>({id:a.entity_id,name:a.entity_name,email:a.entity_email}))),0===h.length){console.log(`No ${b}s found for deal, loading all ${b}s from admin endpoint`),await u(b);return}q(h),f&&!h.find(a=>a.id===f)&&g(void 0)}catch(a){console.error("Error loading entities:",a),await u(b)}finally{n(!1)}},u=async a=>{try{let b="";switch(a){case"introducer":b="/api/admin/introducers";break;case"partner":b="/api/admin/partners";break;case"commercial_partner":b="/api/admin/commercial-partners"}let c=await fetch(b);if(!c.ok)throw Error(`Failed to load ${a}s`);let d=await c.json(),e=(d.introducers||d.partners||d.commercial_partners||d.data||[]).map(a=>({id:a.id,name:a.name||a.legal_name||a.company_name||a.contact_name,email:a.email||a.contact_email,company_name:a.company_name||a.legal_name}));q(e)}catch(b){console.error("Error in fallback loading:",b),s(`Failed to load ${a}s`),q([])}},x=a=>{switch(a){case"introducer":return"Introducer";case"partner":return"Partner";case"commercial_partner":return"Commercial Partner"}};return a?(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(i.Label,{className:"text-white font-medium",children:["Entity Type ",h&&(0,b.jsx)("span",{className:"text-red-400",children:"*"})]}),(0,b.jsxs)(j.Select,{value:d||"none",onValueChange:a=>{"none"===a?e(void 0):e(a),g(void 0)},disabled:k,children:[(0,b.jsx)(j.SelectTrigger,{className:"bg-black border-gray-700 text-white h-11",children:(0,b.jsx)(j.SelectValue,{placeholder:"Select entity type"})}),(0,b.jsxs)(j.SelectContent,{className:"bg-black border-gray-700 text-white",children:[!h&&(0,b.jsx)(j.SelectItem,{value:"none",children:"No entity"}),!l.includes("introducer")&&(0,b.jsx)(j.SelectItem,{value:"introducer",children:(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(y.Users,{className:"h-4 w-4 text-blue-400"}),(0,b.jsx)("span",{children:"Introducer"})]})}),!l.includes("partner")&&(0,b.jsx)(j.SelectItem,{value:"partner",children:(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(v.Building2,{className:"h-4 w-4 text-green-400"}),(0,b.jsx)("span",{children:"Partner"})]})}),!l.includes("commercial_partner")&&(0,b.jsx)(j.SelectItem,{value:"commercial_partner",children:(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(z.Briefcase,{className:"h-4 w-4 text-purple-400"}),(0,b.jsx)("span",{children:"Commercial Partner"})]})})]})]})]}),d&&(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(i.Label,{className:"text-white font-medium",children:[x(d)," ",h&&(0,b.jsx)("span",{className:"text-red-400",children:"*"})]}),m?(0,b.jsxs)("div",{className:"flex items-center gap-2 text-gray-400 h-11 px-3 border border-gray-700 rounded-md bg-black",children:[(0,b.jsx)(o.Loader2,{className:"h-4 w-4 animate-spin"}),(0,b.jsxs)("span",{className:"text-sm",children:["Loading ",d,"s..."]})]}):r?(0,b.jsxs)("div",{className:"flex items-center gap-2 text-red-400 text-sm bg-red-500/10 p-3 rounded border border-red-500/30",children:[(0,b.jsx)(w.AlertCircle,{className:"h-4 w-4"}),(0,b.jsx)("span",{children:r})]}):0===p.length?(0,b.jsxs)("div",{className:"flex items-center gap-2 text-amber-400 text-sm bg-amber-500/10 p-3 rounded border border-amber-500/30",children:[(0,b.jsx)(w.AlertCircle,{className:"h-4 w-4"}),(0,b.jsxs)("span",{children:["No ",d,"s available. Add ",d,"s to the system first."]})]}):(0,b.jsxs)(j.Select,{value:f||"none",onValueChange:a=>{"none"===a?g(void 0):g(a)},disabled:k,children:[(0,b.jsx)(j.SelectTrigger,{className:"bg-black border-gray-700 text-white h-11",children:(0,b.jsx)(j.SelectValue,{placeholder:`Select ${x(d)}`})}),(0,b.jsxs)(j.SelectContent,{className:"bg-black border-gray-700 text-white max-h-60",children:[!h&&(0,b.jsx)(j.SelectItem,{value:"none",children:"No selection"}),p.map(a=>(0,b.jsx)(j.SelectItem,{value:a.id,children:(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(a=>{switch(a){case"introducer":return(0,b.jsx)(y.Users,{className:"h-4 w-4"});case"partner":return(0,b.jsx)(v.Building2,{className:"h-4 w-4"});case"commercial_partner":return(0,b.jsx)(z.Briefcase,{className:"h-4 w-4"});default:return null}})(d),(0,b.jsx)("span",{children:a.name||a.company_name}),a.email&&(0,b.jsxs)("span",{className:"text-gray-400 text-xs",children:["(",a.email,")"]})]})},a.id))]})]})]})]}):(0,b.jsx)("div",{className:"space-y-4",children:(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(i.Label,{className:"text-white font-medium",children:["Entity Type ",h&&(0,b.jsx)("span",{className:"text-red-400",children:"*"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 text-amber-400 text-sm bg-amber-500/10 p-3 rounded border border-amber-500/30",children:[(0,b.jsx)(w.AlertCircle,{className:"h-4 w-4"}),(0,b.jsx)("span",{children:"Select a deal first to assign an entity"})]})]})})}let B=[{value:"subscription",label:"Subscription Fee",color:"blue"},{value:"management",label:"Management Fee",color:"green"},{value:"performance",label:"Performance Fee",color:"purple"},{value:"flat",label:"Flat Fee",color:"amber"},{value:"spread_markup",label:"Spread/Markup",color:"cyan"},{value:"other",label:"Other",color:"gray"}],C=[{value:"percent_of_investment",label:"% of Investment"},{value:"percent_per_annum",label:"% per Annum"},{value:"percent_of_profit",label:"% of Profit"},{value:"fixed_amount",label:"Fixed Amount"}],D=["British Virgin Islands","England and Wales","Cayman Islands","Delaware, USA","Singapore"],E={duration_months:36,non_circumvention_months:null,non_circumvention_indefinite:!0,governing_law:"British Virgin Islands",vat_number:"",intro_payment_days:3,perf_payment_days:10,has_catchup:!1,has_high_water_mark:!1,has_no_cap:!0};function F({title:a,icon:c,isOpen:f,onToggle:g,children:h,badge:i,status:j}){return(0,b.jsxs)("div",{className:"border border-border rounded-2xl overflow-hidden bg-card shadow-lg",children:[(0,b.jsxs)("button",{type:"button",onClick:g,className:"w-full px-8 py-6 flex items-center justify-between hover:bg-muted/60 transition-colors",children:[(0,b.jsxs)("div",{className:"flex items-center gap-5",children:[(0,b.jsx)("div",{className:"text-blue-500 dark:text-blue-400 p-2 bg-blue-500/10 rounded-lg",children:c}),(0,b.jsx)("span",{className:"font-bold text-foreground text-xl",children:a}),i&&(0,b.jsx)(l.Badge,{variant:"outline",className:"text-sm border-border text-foreground px-3 py-1 font-medium",children:i})]}),(0,b.jsxs)("div",{className:"flex items-center gap-5",children:["complete"===j&&(0,b.jsx)("div",{className:"w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center",children:(0,b.jsx)(u.Check,{className:"w-5 h-5 text-green-500 dark:text-green-400"})}),"error"===j&&(0,b.jsx)("div",{className:"w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center",children:(0,b.jsx)(p.AlertTriangle,{className:"w-5 h-5 text-red-500 dark:text-red-400"})}),(0,b.jsx)(d.motion.div,{animate:{rotate:180*!!f},transition:{duration:.2},className:"p-1",children:(0,b.jsx)(q.ChevronDown,{className:"w-6 h-6 text-muted-foreground"})})]})]}),(0,b.jsx)(e.AnimatePresence,{children:f&&(0,b.jsx)(d.motion.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.25,ease:"easeInOut"},children:(0,b.jsx)("div",{className:"px-8 pb-8 pt-6 border-t border-border bg-muted/30",children:h})})})]})}function G({component:a,index:d,onChange:e,onRemove:f,termSheetLimits:k}){let l=B.find(b=>b.value===a.kind),m=a.rate_bps?(a.rate_bps/100).toFixed(2):null,o=(0,c.useMemo)(()=>{if(!k||!a.rate_bps)return!1;let b=k[a.kind];return!!b&&a.rate_bps/100>b},[k,a.rate_bps,a.kind]);return(0,b.jsxs)("div",{className:`border-2 rounded-2xl p-6 bg-card ${(()=>{switch(l?.color){case"blue":return"border-blue-500/40";case"green":return"border-green-500/40";case"purple":return"border-purple-500/40";case"amber":return"border-amber-500/40";case"cyan":return"border-cyan-500/40";default:return"border-border"}})()} transition-all hover:bg-muted/60`,children:[(0,b.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,b.jsxs)("div",{className:"flex items-center gap-5",children:[(0,b.jsx)("div",{className:`w-12 h-12 rounded-xl ${(()=>{switch(l?.color){case"blue":return"bg-blue-500/20 text-blue-400";case"green":return"bg-green-500/20 text-green-400";case"purple":return"bg-purple-500/20 text-purple-400";case"amber":return"bg-amber-500/20 text-amber-400";case"cyan":return"bg-cyan-500/20 text-cyan-400";default:return"bg-muted text-muted-foreground"}})()} flex items-center justify-center font-bold text-lg`,children:d+1}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)(i.Label,{className:"text-sm text-muted-foreground",children:"Fee Type"}),(0,b.jsxs)(j.Select,{value:a.kind,onValueChange:a=>e({kind:a}),children:[(0,b.jsx)(j.SelectTrigger,{className:"w-64 bg-muted/50 border-border text-foreground h-12 text-base font-medium",children:(0,b.jsx)(j.SelectValue,{})}),(0,b.jsx)(j.SelectContent,{className:"bg-popover border-border",children:B.map(a=>(0,b.jsx)(j.SelectItem,{value:a.value,className:"text-base py-3",children:a.label},a.value))})]})]})]}),(0,b.jsx)(g.Button,{type:"button",variant:"ghost",size:"icon",onClick:f,className:"text-muted-foreground hover:text-red-500 dark:hover:text-red-400 hover:bg-red-500/10 h-12 w-12 rounded-xl",children:(0,b.jsx)(n.Trash2,{className:"w-6 h-6"})})]}),(0,b.jsxs)("div",{className:"grid grid-cols-4 gap-6",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(i.Label,{className:"text-sm text-muted-foreground font-medium",children:"Calculation Method"}),(0,b.jsxs)(j.Select,{value:a.calc_method,onValueChange:a=>e({calc_method:a}),children:[(0,b.jsx)(j.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-12 text-base",children:(0,b.jsx)(j.SelectValue,{})}),(0,b.jsx)(j.SelectContent,{className:"bg-popover border-border",children:C.map(a=>(0,b.jsx)(j.SelectItem,{value:a.value,className:"text-base py-2.5",children:a.label},a.value))})]})]}),"fixed_amount"===a.calc_method?(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(i.Label,{className:"text-sm text-muted-foreground font-medium",children:"Amount (USD)"}),(0,b.jsx)(h.Input,{type:"number",step:"0.01",min:"0",value:a.flat_amount||"",onChange:a=>e({flat_amount:a.target.value?Number(a.target.value):void 0}),placeholder:"5,000.00",className:"bg-muted/50 border-border text-foreground h-12 text-lg font-mono"}),a.flat_amount&&(0,b.jsxs)("p",{className:"text-base text-green-600 dark:text-green-400 font-semibold",children:["$",a.flat_amount.toLocaleString()]})]}):(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(i.Label,{className:"text-sm text-muted-foreground font-medium",children:"Rate (Basis Points)"}),(0,b.jsx)(h.Input,{type:"number",value:a.rate_bps||"",onChange:a=>e({rate_bps:a.target.value?Number(a.target.value):void 0}),placeholder:"200",className:`bg-muted/50 border-border text-foreground h-12 text-lg font-mono ${o?"border-red-500 bg-red-500/10":""}`}),m&&(0,b.jsxs)("p",{className:`text-base font-semibold ${o?"text-red-500 dark:text-red-400":"text-blue-600 dark:text-blue-400"}`,children:["= ",m,"%",o&&" ⚠️ exceeds limit"]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(i.Label,{className:"text-sm text-muted-foreground font-medium",children:"Payment Schedule"}),(0,b.jsxs)(j.Select,{value:a.payment_schedule||"upfront",onValueChange:a=>e({payment_schedule:a}),children:[(0,b.jsx)(j.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-12 text-base",children:(0,b.jsx)(j.SelectValue,{})}),(0,b.jsxs)(j.SelectContent,{className:"bg-popover border-border",children:[(0,b.jsx)(j.SelectItem,{value:"upfront",className:"text-base py-2.5",children:"Upfront"}),(0,b.jsx)(j.SelectItem,{value:"recurring",className:"text-base py-2.5",children:"Recurring"}),(0,b.jsx)(j.SelectItem,{value:"on_demand",className:"text-base py-2.5",children:"On Demand"})]})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(i.Label,{className:"text-sm text-muted-foreground font-medium",children:"Notes"}),(0,b.jsx)(h.Input,{value:a.notes||"",onChange:a=>e({notes:a.target.value}),placeholder:"Optional notes...",className:"bg-muted/50 border-border text-foreground h-12 text-base"})]})]})]})}function H({open:a,onClose:l,onSuccess:n,feePlan:q,dealId:u,initialTermSheetId:w}){let[y,z]=(0,c.useState)(!1),[B,C]=(0,c.useState)(null),[H,I]=(0,c.useState)({basic:!0,components:!0,agreement:!1}),[J,K]=(0,c.useState)([]),[L,M]=(0,c.useState)([]),[N,O]=(0,c.useState)(""),[P,Q]=(0,c.useState)(""),[R,S]=(0,c.useState)(u),[T,U]=(0,c.useState)(!0),[V,W]=(0,c.useState)(w),[X,Y]=(0,c.useState)(null),[Z,$]=(0,c.useState)(),[_,aa]=(0,c.useState)(),[ab,ac]=(0,c.useState)([]),[ad,ae]=(0,c.useState)(E),af=!!q,ag=ab.some(a=>"performance"===a.kind),ah=ab.some(a=>"subscription"===a.kind),ai=(0,c.useMemo)(()=>{if(X)return{subscription:X.subscription_fee_percent||void 0,management:X.management_fee_percent||void 0,performance:X.carried_interest_percent||void 0}},[X]),aj=N.trim()&&R&&V&&Z&&_,ak=0===L.length;(0,c.useEffect)(()=>{a&&am()},[a]),(0,c.useEffect)(()=>{if(a)if(q){O(q.name),Q(q.description||""),S(q.deal_id||void 0),U(q.is_active),W(q.term_sheet_id||void 0),q.introducer_id?($("introducer"),aa(q.introducer_id)):q.partner_id?($("partner"),aa(q.partner_id)):q.commercial_partner_id&&($("commercial_partner"),aa(q.commercial_partner_id)),ae({duration_months:q.agreement_duration_months??36,non_circumvention_months:q.non_circumvention_months??null,non_circumvention_indefinite:null==q.non_circumvention_months,governing_law:q.governing_law??"British Virgin Islands",vat_number:q.vat_registration_number??"",intro_payment_days:3,perf_payment_days:10,hurdle_rate_bps:void 0,has_catchup:!1,catchup_rate_bps:void 0,has_high_water_mark:!1,has_no_cap:!0,performance_cap_percent:void 0});let a=q.components||[],b=a.find(a=>"subscription"===a.kind),c=a.find(a=>"performance"===a.kind);b&&ae(a=>({...a,intro_payment_days:b.payment_days_after_event??3})),c&&ae(a=>({...a,perf_payment_days:c.payment_days_after_event??10,hurdle_rate_bps:c.hurdle_rate_bps,has_catchup:c.has_catchup??!1,catchup_rate_bps:c.catchup_rate_bps,has_high_water_mark:c.has_high_water_mark??!1,has_no_cap:c.has_no_cap??!0,performance_cap_percent:c.performance_cap_percent})),ac(a.map(a=>({id:a.id,kind:a.kind,calc_method:a.calc_method||"percent_of_investment",frequency:a.frequency||"one_time",rate_bps:a.rate_bps,flat_amount:a.flat_amount,notes:a.notes||"",payment_schedule:a.payment_schedule||"upfront",duration_periods:a.duration_periods,duration_unit:a.duration_unit})))}else al()},[a,q,u,w]),(0,c.useEffect)(()=>{X&&ab.length>0?M(function(a,b){let c=[];for(let e of a){var d;if(!e.rate_bps)continue;let a=null==(d=e.rate_bps)?null:d/100;if(null!==a)switch(e.kind){case"subscription":null!==b.subscription_fee_percent&&void 0!==b.subscription_fee_percent&&a>b.subscription_fee_percent&&c.push(`Subscription fee (${a}%) exceeds term sheet limit (${b.subscription_fee_percent}%)`);break;case"management":null!==b.management_fee_percent&&void 0!==b.management_fee_percent&&a>b.management_fee_percent&&c.push(`Management fee (${a}%) exceeds term sheet limit (${b.management_fee_percent}%)`);break;case"performance":null!==b.carried_interest_percent&&void 0!==b.carried_interest_percent&&a>b.carried_interest_percent&&c.push(`Performance fee (${a}%) exceeds term sheet limit (${b.carried_interest_percent}%)`)}}return c}(ab,X)):M([])},[ab,X]),(0,c.useEffect)(()=>{Z&&_&&I(a=>({...a,agreement:!0}))},[Z,_]);let al=(0,c.useCallback)(()=>{O(""),Q(""),S(u),U(!0),W(w),Y(null),$(void 0),aa(void 0),ac([]),ae(E),C(null),M([]),I({basic:!0,components:!0,agreement:!1})},[u,w]),am=async()=>{try{let a=await fetch("/api/deals"),b=await a.json();K(b.deals||[])}catch(a){console.error("Error loading deals:",a)}},an=a=>{I(b=>({...b,[a]:!b[a]}))},ao=()=>{ac([...ab,{kind:"subscription",calc_method:"percent_of_investment",frequency:"one_time",payment_schedule:"upfront"}])},ap=a=>{ae(b=>({...b,...a}))},aq=async()=>{if(!N.trim())return void C("Plan name is required");if(!R)return void C("A deal must be selected");if(!V)return void C("A term sheet must be selected");if(!Z||!_)return void C("An entity must be selected");if(L.length>0)return void C(`Fee values exceed term sheet limits: ${L.join("; ")}`);z(!0),C(null);try{let a=ab.map(a=>{let{id:b,notes:c,...d}=a,e={...d,notes:c?.trim()||void 0,has_catchup:!1,has_high_water_mark:!1,...b&&b.length>10?{id:b}:{}};return"subscription"===a.kind?{...e,payment_days_after_event:ad.intro_payment_days}:"performance"===a.kind?{...e,payment_days_after_event:ad.perf_payment_days,hurdle_rate_bps:ad.hurdle_rate_bps||void 0,has_catchup:ad.has_catchup,catchup_rate_bps:ad.has_catchup?ad.catchup_rate_bps:void 0,has_high_water_mark:ad.has_high_water_mark,has_no_cap:ad.has_no_cap,performance_cap_percent:ad.has_no_cap?void 0:ad.performance_cap_percent}:e}),b={name:N.trim(),description:P.trim()||void 0,deal_id:R,term_sheet_id:V,...{introducer_id:"introducer"===Z?_:void 0,partner_id:"partner"===Z?_:void 0,commercial_partner_id:"commercial_partner"===Z?_:void 0},is_active:T,agreement_duration_months:ad.duration_months,non_circumvention_months:ad.non_circumvention_indefinite?null:ad.non_circumvention_months,governing_law:ad.governing_law,vat_registration_number:ad.vat_number.trim()||null,components:a},c=q?`/api/staff/fees/plans/${q.id}`:"/api/staff/fees/plans",d=await fetch(c,{method:q?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(!d.ok){let a=await d.json().catch(()=>({error:`HTTP ${d.status}`})),b=a.error||"Failed to save",c=a.details?`
${a.details}`:"";throw Error(`${b}${c}`)}n()}catch(a){C(a instanceof Error?a.message:"Failed to save fee plan")}finally{z(!1)}};return(0,b.jsx)(f.Dialog,{open:a,onOpenChange:a=>!a&&l(),children:(0,b.jsxs)(f.DialogContent,{showCloseButton:!1,className:"!max-w-[1400px] !w-[96vw] !max-h-[94vh] !p-0 bg-background border-border text-foreground overflow-hidden flex flex-col",children:[(0,b.jsx)(f.DialogHeader,{className:"px-10 py-6 border-b border-border bg-gradient-to-r from-blue-500/5 dark:from-blue-900/10 via-muted/30 to-transparent shrink-0",children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(f.DialogTitle,{className:"text-2xl font-bold text-foreground tracking-tight",children:af?"Edit Fee Plan":"Create New Fee Plan"}),(0,b.jsx)("p",{className:"text-base text-muted-foreground mt-2",children:af?"Modify fee structure and agreement terms":"Define a fee structure for a partner or introducer agreement"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-6",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3 bg-muted/50 px-4 py-2 rounded-lg border border-border",children:[(0,b.jsx)(k.Checkbox,{id:"is_active",checked:T,onCheckedChange:a=>U(a),className:"border-border h-5 w-5"}),(0,b.jsx)(i.Label,{htmlFor:"is_active",className:"text-sm text-muted-foreground cursor-pointer font-medium",children:"Plan Active"})]}),(0,b.jsx)(g.Button,{type:"button",variant:"ghost",size:"icon",onClick:l,className:"h-10 w-10 text-muted-foreground hover:text-foreground hover:bg-muted rounded-lg",children:(0,b.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,b.jsx)("path",{d:"M18 6 6 18"}),(0,b.jsx)("path",{d:"m6 6 12 12"})]})})]})]})}),(0,b.jsx)(e.AnimatePresence,{children:B&&(0,b.jsx)(d.motion.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"px-10 py-4 bg-red-500/10 border-b border-red-500/30 shrink-0",children:(0,b.jsxs)("div",{className:"flex items-center gap-3 text-red-400",children:[(0,b.jsx)(p.AlertTriangle,{className:"w-5 h-5 shrink-0"}),(0,b.jsx)("span",{className:"text-base",children:B})]})})}),(0,b.jsxs)("div",{className:"flex-1 overflow-y-auto px-10 py-8 space-y-6",children:[(0,b.jsx)(F,{title:"Basic Information",icon:(0,b.jsx)(r.FileText,{className:"w-5 h-5"}),isOpen:H.basic,onToggle:()=>an("basic"),status:aj?"complete":void 0,children:(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-8",children:[(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsxs)(i.Label,{className:"text-base text-foreground font-medium",children:["Plan Name ",(0,b.jsx)("span",{className:"text-red-500 dark:text-red-400",children:"*"})]}),(0,b.jsx)(h.Input,{value:N,onChange:a=>O(a.target.value),placeholder:"e.g., Standard Introducer Fee Plan",className:"bg-muted/50 border-border text-foreground h-12 text-base focus:border-blue-500 focus:ring-1 focus:ring-blue-500/30"})]}),(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsx)(i.Label,{className:"text-base text-foreground font-medium",children:"Description"}),(0,b.jsx)(h.Input,{value:P,onChange:a=>Q(a.target.value),placeholder:"Optional description of this fee arrangement...",className:"bg-muted/50 border-border text-foreground h-12 text-base focus:border-blue-500"})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-3 gap-8",children:[(0,b.jsx)("div",{className:"space-y-3",children:u?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(i.Label,{className:"text-base text-foreground font-medium",children:"Deal"}),(0,b.jsxs)("div",{className:"flex items-center gap-3 px-4 py-3 bg-muted/50 border border-border rounded-lg text-foreground h-12",children:[(0,b.jsx)(v.Building2,{className:"w-5 h-5 text-blue-500 dark:text-blue-400"}),(0,b.jsx)("span",{className:"text-base truncate",children:J.find(a=>a.id===u)?.name||"Loading..."})]})]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)(i.Label,{className:"text-base text-foreground font-medium",children:["Deal ",(0,b.jsx)("span",{className:"text-red-500 dark:text-red-400",children:"*"})]}),(0,b.jsxs)(j.Select,{value:R||"",onValueChange:a=>{S(a||void 0),W(void 0),Y(null),$(void 0),aa(void 0)},children:[(0,b.jsx)(j.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-12 text-base",children:(0,b.jsx)(j.SelectValue,{placeholder:"Select a deal"})}),(0,b.jsx)(j.SelectContent,{className:"bg-popover border-border",children:J.map(a=>(0,b.jsx)(j.SelectItem,{value:a.id,className:"text-base py-2.5",children:a.name},a.id))})]})]})}),(0,b.jsx)("div",{className:"space-y-3",children:(0,b.jsx)(x,{dealId:R,value:V,onChange:(a,b)=>{W(a),Y(b)},required:!0})}),(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsxs)(i.Label,{className:"text-base text-foreground font-medium",children:["Entity Type ",(0,b.jsx)("span",{className:"text-red-500 dark:text-red-400",children:"*"})]}),(0,b.jsxs)(j.Select,{value:Z||"",onValueChange:a=>{$(a||void 0),aa(void 0)},disabled:!R,children:[(0,b.jsx)(j.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-12 text-base",children:(0,b.jsx)(j.SelectValue,{placeholder:R?"Select type":"Select deal first"})}),(0,b.jsxs)(j.SelectContent,{className:"bg-popover border-border",children:[(0,b.jsx)(j.SelectItem,{value:"introducer",className:"text-base py-2.5",children:"Introducer"}),(0,b.jsx)(j.SelectItem,{value:"partner",className:"text-base py-2.5",children:"Partner"})]})]})]})]}),Z&&R&&(0,b.jsx)("div",{className:"pt-4 border-t border-border",children:(0,b.jsx)(A,{dealId:R,entityType:Z,onEntityTypeChange:$,entityId:_,onEntityIdChange:aa,required:!0,excludeTypes:["commercial_partner"]})})]})}),(0,b.jsx)(F,{title:"Fee Components",icon:(0,b.jsx)(s.DollarSign,{className:"w-5 h-5"}),isOpen:H.components,onToggle:()=>an("components"),badge:`${ab.length} component${1!==ab.length?"s":""}`,status:ab.length>0?ak?"complete":"error":void 0,children:(0,b.jsxs)("div",{className:"space-y-4",children:[L.length>0&&(0,b.jsx)("div",{className:"p-3 bg-red-500/10 border border-red-500/30 rounded-lg",children:(0,b.jsxs)("div",{className:"flex items-start gap-2",children:[(0,b.jsx)(p.AlertTriangle,{className:"w-4 h-4 text-red-400 mt-0.5"}),(0,b.jsxs)("div",{className:"text-sm text-red-400",children:[(0,b.jsx)("p",{className:"font-medium",children:"Fees exceed term sheet limits:"}),(0,b.jsx)("ul",{className:"mt-1 space-y-1",children:L.map((a,c)=>(0,b.jsxs)("li",{children:["• ",a]},c))})]})]})}),0===ab.length?(0,b.jsxs)("div",{className:"text-center py-8 border-2 border-dashed border-border rounded-lg",children:[(0,b.jsx)(s.DollarSign,{className:"w-8 h-8 text-muted-foreground mx-auto mb-2"}),(0,b.jsx)("p",{className:"text-muted-foreground text-sm",children:"No fee components defined"}),(0,b.jsxs)(g.Button,{type:"button",onClick:ao,variant:"outline",size:"sm",className:"mt-3 border-border text-muted-foreground hover:bg-muted",children:[(0,b.jsx)(m.Plus,{className:"w-4 h-4 mr-2"}),"Add First Component"]})]}):(0,b.jsxs)("div",{className:"space-y-3",children:[ab.map((a,c)=>(0,b.jsx)(G,{component:a,index:c,onChange:a=>{ac(b=>{let d=[...b];return d[c]={...d[c],...a},d})},onRemove:()=>{ac(a=>a.filter((a,b)=>b!==c))},termSheetLimits:ai},c)),(0,b.jsxs)(g.Button,{type:"button",onClick:ao,variant:"outline",size:"sm",className:"w-full border-border border-dashed text-muted-foreground hover:bg-muted hover:text-foreground",children:[(0,b.jsx)(m.Plus,{className:"w-4 h-4 mr-2"}),"Add Component"]})]})]})}),("introducer"===Z||"partner"===Z)&&(0,b.jsx)(F,{title:"Agreement Terms",icon:(0,b.jsx)(t.ScrollText,{className:"w-5 h-5"}),isOpen:H.agreement,onToggle:()=>an("agreement"),badge:"introducer"===Z?"DOC 3":"Placement",children:(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("h4",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[(0,b.jsx)("div",{className:"w-2 h-2 rounded-full bg-blue-500"}),"General Terms"]}),(0,b.jsxs)("div",{className:"grid grid-cols-3 gap-4 pl-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Agreement Duration"}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(h.Input,{type:"number",min:"1",value:ad.duration_months,onChange:a=>ap({duration_months:Number(a.target.value)||36}),className:"bg-muted/50 border-border text-foreground h-9 w-20"}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:"months"})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Non-Circumvention"}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(k.Checkbox,{checked:ad.non_circumvention_indefinite,onCheckedChange:a=>{ap({non_circumvention_indefinite:!!a,non_circumvention_months:a?null:24})},className:"border-border"}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:"Indefinite"}),!ad.non_circumvention_indefinite&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(h.Input,{type:"number",min:"1",value:ad.non_circumvention_months||"",onChange:a=>ap({non_circumvention_months:Number(a.target.value)||null}),className:"bg-muted/50 border-border text-foreground h-8 w-16"}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:"mo"})]})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Governing Law"}),(0,b.jsxs)(j.Select,{value:ad.governing_law,onValueChange:a=>ap({governing_law:a}),children:[(0,b.jsx)(j.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-9 text-xs",children:(0,b.jsx)(j.SelectValue,{})}),(0,b.jsx)(j.SelectContent,{className:"bg-popover border-border",children:D.map(a=>(0,b.jsx)(j.SelectItem,{value:a,className:"text-xs",children:a},a))})]})]})]})]}),ah&&(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("h4",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[(0,b.jsx)("div",{className:"w-2 h-2 rounded-full bg-green-500"}),"Introduction Fee Payment"]}),(0,b.jsx)("div",{className:"pl-4",children:(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Payment After Closing"}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(h.Input,{type:"number",min:"1",max:"90",value:ad.intro_payment_days,onChange:a=>ap({intro_payment_days:Number(a.target.value)||3}),className:"bg-muted/50 border-border text-foreground h-9 w-20"}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:"business days after share certificate"})]})]})})]}),ag&&(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("h4",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[(0,b.jsx)("div",{className:"w-2 h-2 rounded-full bg-purple-500"}),"Performance Fee (Carried Interest)"]}),(0,b.jsxs)("div",{className:"pl-4 space-y-4",children:[(0,b.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Payment After Redemption"}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(h.Input,{type:"number",min:"1",max:"90",value:ad.perf_payment_days,onChange:a=>ap({perf_payment_days:Number(a.target.value)||10}),className:"bg-muted/50 border-border text-foreground h-9 w-20"}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:"days"})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Hurdle Rate"}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(h.Input,{type:"number",min:"0",value:ad.hurdle_rate_bps||"",onChange:a=>ap({hurdle_rate_bps:a.target.value?Number(a.target.value):void 0}),placeholder:"800",className:"bg-muted/50 border-border text-foreground h-9 w-24"}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:"bps"})]}),ad.hurdle_rate_bps&&(0,b.jsxs)("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:["= ",(ad.hurdle_rate_bps/100).toFixed(2),"%"]})]})]}),(0,b.jsxs)("div",{className:"flex flex-wrap gap-6",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(k.Checkbox,{checked:ad.has_catchup,onCheckedChange:a=>ap({has_catchup:!!a}),className:"border-border"}),(0,b.jsx)("span",{className:"text-sm text-muted-foreground",children:"GP Catchup"}),ad.has_catchup&&(0,b.jsxs)("div",{className:"flex items-center gap-1 ml-2",children:[(0,b.jsx)(h.Input,{type:"number",value:ad.catchup_rate_bps||"",onChange:a=>ap({catchup_rate_bps:a.target.value?Number(a.target.value):void 0}),className:"bg-muted/50 border-border text-foreground h-8 w-20"}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:"bps"})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(k.Checkbox,{checked:ad.has_high_water_mark,onCheckedChange:a=>ap({has_high_water_mark:!!a}),className:"border-border"}),(0,b.jsx)("span",{className:"text-sm text-muted-foreground",children:"High Water Mark"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(k.Checkbox,{checked:ad.has_no_cap,onCheckedChange:a=>{ap({has_no_cap:!!a,performance_cap_percent:a?void 0:20})},className:"border-border"}),(0,b.jsx)("span",{className:"text-sm text-muted-foreground",children:"No Cap"}),!ad.has_no_cap&&(0,b.jsxs)("div",{className:"flex items-center gap-1 ml-2",children:[(0,b.jsx)(h.Input,{type:"number",step:"0.1",min:"0",max:"100",value:ad.performance_cap_percent||"",onChange:a=>ap({performance_cap_percent:a.target.value?Number(a.target.value):void 0}),className:"bg-muted/50 border-border text-foreground h-8 w-16"}),(0,b.jsx)("span",{className:"text-xs text-muted-foreground",children:"%"})]})]})]})]})]}),(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("h4",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[(0,b.jsx)("div",{className:"w-2 h-2 rounded-full bg-amber-500"}),"VAT Information"]}),(0,b.jsx)("div",{className:"pl-4",children:(0,b.jsxs)("div",{className:"space-y-2 max-w-xs",children:[(0,b.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"VAT Registration Number"}),(0,b.jsx)(h.Input,{value:ad.vat_number,onChange:a=>ap({vat_number:a.target.value}),placeholder:"e.g., GB123456789",className:"bg-muted/50 border-border text-foreground h-9"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"Leave blank if not VAT registered"})]})})]})]})})]}),(0,b.jsxs)("div",{className:"px-10 py-6 border-t border-border bg-muted/60 flex items-center justify-between shrink-0",children:[(0,b.jsxs)("div",{className:"text-base text-muted-foreground",children:[(0,b.jsx)("span",{className:"font-semibold text-foreground text-lg",children:ab.length})," fee component",1!==ab.length?"s":""," defined",L.length>0&&(0,b.jsxs)("span",{className:"text-red-500 dark:text-red-400 ml-4 inline-flex items-center gap-2",children:[(0,b.jsx)(p.AlertTriangle,{className:"w-5 h-5"}),L.length," validation error",1!==L.length?"s":""]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-5",children:[(0,b.jsx)(g.Button,{type:"button",variant:"outline",onClick:l,disabled:y,className:"border-border text-foreground hover:bg-muted h-12 px-8 text-base font-medium",children:"Cancel"}),(0,b.jsx)(g.Button,{type:"button",onClick:aq,disabled:y||!aj||L.length>0,className:"bg-blue-600 hover:bg-blue-500 h-12 px-10 min-w-[180px] text-base font-semibold shadow-lg shadow-blue-500/20",children:y?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(o.Loader2,{className:"w-5 h-5 mr-2 animate-spin"}),"Saving..."]}):(0,b.jsx)(b.Fragment,{children:af?"Update Fee Plan":"Create Fee Plan"})})]})]})]})})}a.s(["default",()=>H],283732)}];

//# sourceMappingURL=versotech-portal_src_components_fees_FeePlanEditModal_tsx_8769c42d._.js.map