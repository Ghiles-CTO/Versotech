{"version":3,"sources":["../../../../../versotech-portal/src/components/deals/deal-detail-client.tsx/__nextjs-internal-proxy.mjs","../../../../../versotech-portal/src/app/%28main%29/versotech_main/deals/%5Bid%5D/page.tsx"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const DealDetailClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call DealDetailClient() from the server but DealDetailClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/components/deals/deal-detail-client.tsx\",\n    \"DealDetailClient\",\n);\n","import { createClient, createServiceClient } from '@/lib/supabase/server'\r\nimport { notFound, redirect } from 'next/navigation'\r\nimport { DealDetailClient } from '@/components/deals/deal-detail-client'\r\nimport { checkStaffAccess } from '@/lib/auth'\r\n\r\nexport const dynamic = 'force-dynamic'\r\n\r\ninterface PageParams {\r\n  params: Promise<{ id: string }>\r\n}\r\n\r\n/**\r\n * Staff Deal Detail Page\r\n *\r\n * CEO/Staff view for managing a deal including:\r\n * - Deal overview and metadata\r\n * - 11 tabs: Overview, Term Sheet, Interests, Data Room, Inventory, Members, Fees, Subscriptions, Documents, FAQ, Activity\r\n * - Full investor journey tracking\r\n */\r\nexport default async function DealDetailPage({ params }: PageParams) {\r\n  const { id: dealId } = await params\r\n  const clientSupabase = await createClient()\r\n  const { data: { user }, error: userError } = await clientSupabase.auth.getUser()\r\n\r\n  if (!user || userError) {\r\n    redirect('/versotech_main/login')\r\n  }\r\n\r\n  // Check staff access via personas\r\n  const hasStaffAccess = await checkStaffAccess(user.id)\r\n  const serviceSupabase = createServiceClient()\r\n\r\n  if (!hasStaffAccess) {\r\n    redirect('/versotech_main/deals')\r\n  }\r\n\r\n  // Get user profile for role\r\n  const { data: userProfile } = await clientSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const userRole = userProfile?.role || 'staff_ops'\r\n\r\n  // Fetch arranger entities for edit dropdown\r\n  // Note: arranger_entities has no 'company_name' - use legal_name only\r\n  const { data: arrangerEntities } = await serviceSupabase\r\n    .from('arranger_entities')\r\n    .select('id, legal_name')\r\n    .eq('status', 'active')\r\n    .order('legal_name')\r\n\r\n  // Fetch deal with all related data\r\n  const { data: deal, error: dealError } = await serviceSupabase\r\n    .from('deals')\r\n    .select(`\r\n      *,\r\n      vehicles (\r\n        id,\r\n        name,\r\n        type,\r\n        currency\r\n      ),\r\n      arranger_entities:arranger_entity_id (\r\n        id,\r\n        legal_name\r\n      ),\r\n      deal_memberships (\r\n        user_id,\r\n        investor_id,\r\n        role,\r\n        invited_at,\r\n        accepted_at,\r\n        dispatched_at,\r\n        viewed_at,\r\n        interest_confirmed_at,\r\n        nda_signed_at,\r\n        data_room_granted_at,\r\n        profiles:user_id (\r\n          id,\r\n          display_name,\r\n          email\r\n        ),\r\n        investors:investor_id (\r\n          id,\r\n          legal_name,\r\n          type,\r\n          kyc_status\r\n        ),\r\n        invited_by_profile:invited_by (\r\n          display_name,\r\n          email\r\n        )\r\n      ),\r\n      fee_plans (\r\n        id,\r\n        deal_id,\r\n        name,\r\n        description,\r\n        is_default,\r\n        is_active,\r\n        term_sheet_id,\r\n        introducer_id,\r\n        partner_id,\r\n        commercial_partner_id,\r\n        status,\r\n        accepted_at,\r\n        generated_agreement_id,\r\n        generated_placement_agreement_id,\r\n        agreement_duration_months,\r\n        non_circumvention_months,\r\n        governing_law,\r\n        vat_registration_number,\r\n        fee_components (\r\n          id,\r\n          kind,\r\n          calc_method,\r\n          rate_bps,\r\n          flat_amount,\r\n          frequency,\r\n          payment_schedule,\r\n          duration_periods,\r\n          duration_unit,\r\n          hurdle_rate_bps,\r\n          has_catchup,\r\n          catchup_rate_bps,\r\n          has_high_water_mark,\r\n          has_no_cap,\r\n          performance_cap_percent,\r\n          payment_days_after_event,\r\n          tier_threshold_multiplier,\r\n          base_calculation,\r\n          notes\r\n        ),\r\n        term_sheet:term_sheet_id (\r\n          id,\r\n          version,\r\n          status,\r\n          term_sheet_date,\r\n          subscription_fee_percent,\r\n          management_fee_percent,\r\n          carried_interest_percent\r\n        ),\r\n        introducer:introducer_id (\r\n          id,\r\n          legal_name,\r\n          contact_name,\r\n          email\r\n        ),\r\n        partner:partner_id (\r\n          id,\r\n          name,\r\n          legal_name,\r\n          contact_name,\r\n          contact_email\r\n        ),\r\n        commercial_partner:commercial_partner_id (\r\n          id,\r\n          name,\r\n          legal_name,\r\n          contact_name,\r\n          contact_email\r\n        ),\r\n        introducer_agreement:generated_agreement_id (\r\n          id,\r\n          reference_number,\r\n          status,\r\n          pdf_url\r\n        ),\r\n        placement_agreement:generated_placement_agreement_id (\r\n          id,\r\n          reference_number,\r\n          status,\r\n          pdf_url\r\n        )\r\n      ),\r\n      share_lots (\r\n        id,\r\n        source_id,\r\n        units_total,\r\n        unit_cost,\r\n        units_remaining,\r\n        currency,\r\n        acquired_at,\r\n        lockup_until,\r\n        status,\r\n        share_sources:source_id (\r\n          id,\r\n          kind,\r\n          counterparty_name,\r\n          notes\r\n        )\r\n      )\r\n    `)\r\n    .eq('id', dealId)\r\n    .single()\r\n\r\n  if (dealError || !deal) {\r\n    notFound()\r\n  }\r\n\r\n  // Fetch inventory summary\r\n  const { data: inventorySummary } = await serviceSupabase\r\n    .rpc('fn_deal_inventory_summary', { p_deal_id: dealId })\r\n\r\n  // Fetch deal-scoped documents\r\n  const { data: documents } = await serviceSupabase\r\n    .from('deal_data_room_documents')\r\n    .select(`\r\n      id,\r\n      file_key,\r\n      created_at,\r\n      created_by,\r\n      created_by_profile:created_by (\r\n        display_name\r\n      )\r\n    `)\r\n    .eq('deal_id', dealId)\r\n    .order('created_at', { ascending: false })\r\n\r\n  // Fetch term sheet versions\r\n  const { data: termSheets } = await serviceSupabase\r\n    .from('deal_fee_structures')\r\n    .select('*')\r\n    .eq('deal_id', dealId)\r\n    .order('created_at', { ascending: false })\r\n\r\n  // Fetch investor interest submissions\r\n  const { data: interests } = await serviceSupabase\r\n    .from('investor_deal_interest')\r\n    .select(`\r\n      *,\r\n      investors (\r\n        id,\r\n        legal_name\r\n      )\r\n    `)\r\n    .eq('deal_id', dealId)\r\n    .order('submitted_at', { ascending: false })\r\n\r\n  // Fetch data room access records\r\n  const { data: dataRoomAccess } = await serviceSupabase\r\n    .from('deal_data_room_access')\r\n    .select(`\r\n      *,\r\n      investors (\r\n        id,\r\n        legal_name\r\n      )\r\n    `)\r\n    .eq('deal_id', dealId)\r\n    .order('granted_at', { ascending: false })\r\n\r\n  // Fetch data room documents\r\n  const { data: dataRoomDocuments } = await serviceSupabase\r\n    .from('deal_data_room_documents')\r\n    .select('*')\r\n    .eq('deal_id', dealId)\r\n    .order('folder', { ascending: true })\r\n    .order('created_at', { ascending: true })\r\n\r\n  // Fetch subscription submissions (for Subscriptions tab)\r\n  const { data: subscriptionSubmissions } = await serviceSupabase\r\n    .from('deal_subscription_submissions')\r\n    .select(`\r\n      *,\r\n      investors (\r\n        id,\r\n        legal_name\r\n      )\r\n    `)\r\n    .eq('deal_id', dealId)\r\n    .order('submitted_at', { ascending: false })\r\n\r\n  // Fetch subscriptions with journey tracking fields (for Members tab journey)\r\n  const { data: subscriptionsForJourney } = await serviceSupabase\r\n    .from('subscriptions')\r\n    .select(`\r\n      id,\r\n      investor_id,\r\n      commitment,\r\n      funded_amount,\r\n      status,\r\n      pack_generated_at,\r\n      pack_sent_at,\r\n      signed_at,\r\n      funded_at\r\n    `)\r\n    .eq('deal_id', dealId)\r\n\r\n  // Fetch activity events for summary (last 90 days)\r\n  const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString()\r\n\r\n  const { data: activityEvents } = await serviceSupabase\r\n    .from('deal_activity_events')\r\n    .select('event_type, occurred_at')\r\n    .eq('deal_id', dealId)\r\n    .gte('occurred_at', ninetyDaysAgo)\r\n\r\n  const activitySummary = (activityEvents ?? []).reduce<Record<string, number>>((acc, event) => {\r\n    acc[event.event_type] = (acc[event.event_type] ?? 0) + 1\r\n    return acc\r\n  }, {})\r\n\r\n  // Filter only active fee plans\r\n  const dealWithActiveFeePlans = {\r\n    ...deal,\r\n    fee_plans: (deal.fee_plans || []).filter((plan: any) => plan.is_active !== false)\r\n  }\r\n\r\n  return (\r\n    <DealDetailClient\r\n      deal={dealWithActiveFeePlans}\r\n      inventorySummary={inventorySummary?.[0] || {\r\n        total_units: 0,\r\n        available_units: 0,\r\n        reserved_units: 0,\r\n        allocated_units: 0\r\n      }}\r\n      documents={documents || []}\r\n      termSheets={termSheets || []}\r\n      interests={interests || []}\r\n      dataRoomAccess={dataRoomAccess || []}\r\n      dataRoomDocuments={dataRoomDocuments || []}\r\n      subscriptions={subscriptionSubmissions || []}\r\n      subscriptionsForJourney={subscriptionsForJourney || []}\r\n      activitySummary={activitySummary}\r\n      userProfile={{ role: userRole }}\r\n      arrangerEntities={arrangerEntities || []}\r\n    />\r\n  )\r\n}\r\n"],"names":[],"mappings":"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","ignoreList":[0]}