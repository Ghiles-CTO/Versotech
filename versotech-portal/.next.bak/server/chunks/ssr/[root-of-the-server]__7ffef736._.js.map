{"version":3,"sources":["../../../../../versotech-portal/src/components/staff/introducers/introducer-detail-client.tsx/__nextjs-internal-proxy.mjs","../../../../../versotech-portal/src/app/%28staff%29/versotech/staff/introducers/%5Bid%5D/page.tsx"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const IntroducerDetailClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call IntroducerDetailClient() from the server but IntroducerDetailClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/components/staff/introducers/introducer-detail-client.tsx\",\n    \"IntroducerDetailClient\",\n);\n","import { createServiceClient } from '@/lib/supabase/server'\r\nimport { requireStaffAuth } from '@/lib/auth'\r\nimport { notFound } from 'next/navigation'\r\nimport { IntroducerDetailClient } from '@/components/staff/introducers/introducer-detail-client'\r\n\r\nexport const dynamic = 'force-dynamic'\r\nexport const revalidate = 0\r\n\r\ntype IntroducerDetail = {\r\n  id: string\r\n  legal_name: string\r\n  contact_name: string | null\r\n  email: string | null\r\n  phone_mobile: string | null\r\n  phone_office: string | null\r\n  default_commission_bps: number | null\r\n  commission_cap_amount: number | null\r\n  payment_terms: string | null\r\n  status: string\r\n  kyc_status: string | null\r\n  notes: string | null\r\n  created_at: string | null\r\n  updated_at: string | null\r\n}\r\n\r\ntype Introduction = {\r\n  id: string\r\n  prospect_email: string | null\r\n  status: string\r\n  introduced_at: string | null\r\n  deal: {\r\n    id: string\r\n    name: string\r\n  } | null\r\n  investor: {\r\n    id: string\r\n    legal_name: string\r\n  } | null\r\n}\r\n\r\ntype Commission = {\r\n  id: string\r\n  accrual_amount: number\r\n  status: string\r\n  paid_at: string | null\r\n  created_at: string\r\n  deal_id: string | null\r\n  investor_id: string | null\r\n  investor?: {\r\n    legal_name: string\r\n  } | null\r\n  deal?: {\r\n    name: string\r\n  } | null\r\n}\r\n\r\ntype Agreement = {\r\n  id: string\r\n  status: string\r\n  reference_number: string | null\r\n  default_commission_bps: number | null\r\n  agreement_date: string | null\r\n  effective_date: string | null\r\n  expiry_date: string | null\r\n  special_terms: string | null\r\n  signed_date: string | null\r\n  pdf_url: string | null\r\n  deal_id: string | null\r\n  fee_plan_id: string | null\r\n  created_at: string\r\n  updated_at: string\r\n  deal?: {\r\n    id: string\r\n    name: string\r\n  } | null\r\n}\r\n\r\nexport default async function IntroducerDetailPage({\r\n  params\r\n}: {\r\n  params: Promise<{ id: string }>\r\n}) {\r\n  const { id } = await params\r\n\r\n  await requireStaffAuth()\r\n  const serviceClient = createServiceClient()\r\n\r\n  // Fetch introducer details\r\n  const { data: introducer, error } = await serviceClient\r\n    .from('introducers')\r\n    .select('*')\r\n    .eq('id', id)\r\n    .single()\r\n\r\n  if (error || !introducer) {\r\n    console.error('[Introducer Detail] Error:', error)\r\n    notFound()\r\n  }\r\n\r\n  // Fetch introductions separately to avoid Supabase nested query issues\r\n  const { data: introductionsData } = await serviceClient\r\n    .from('introductions')\r\n    .select(`\r\n      id,\r\n      prospect_email,\r\n      prospect_investor_id,\r\n      status,\r\n      introduced_at,\r\n      deal_id\r\n    `)\r\n    .eq('introducer_id', id)\r\n    .order('introduced_at', { ascending: false })\r\n\r\n  // Fetch deal names for introductions\r\n  const dealIds = (introductionsData || [])\r\n    .map(i => i.deal_id)\r\n    .filter((id): id is string => id != null)\r\n\r\n  let dealsMap: Record<string, { id: string; name: string }> = {}\r\n  if (dealIds.length > 0) {\r\n    const { data: dealsData } = await serviceClient\r\n      .from('deals')\r\n      .select('id, name')\r\n      .in('id', dealIds)\r\n\r\n    dealsMap = (dealsData || []).reduce((acc, d) => {\r\n      acc[d.id] = { id: d.id, name: d.name }\r\n      return acc\r\n    }, {} as Record<string, { id: string; name: string }>)\r\n  }\r\n\r\n  // Fetch investor names for introductions\r\n  const introInvestorIds = (introductionsData || [])\r\n    .map(i => i.prospect_investor_id)\r\n    .filter((id): id is string => id != null)\r\n\r\n  let introInvestorsMap: Record<string, { id: string; legal_name: string }> = {}\r\n  if (introInvestorIds.length > 0) {\r\n    const { data: investorsData } = await serviceClient\r\n      .from('investors')\r\n      .select('id, legal_name')\r\n      .in('id', introInvestorIds)\r\n\r\n    introInvestorsMap = (investorsData || []).reduce((acc, inv) => {\r\n      acc[inv.id] = { id: inv.id, legal_name: inv.legal_name }\r\n      return acc\r\n    }, {} as Record<string, { id: string; legal_name: string }>)\r\n  }\r\n\r\n  const introductions: Introduction[] = (introductionsData || []).map(i => ({\r\n    id: i.id,\r\n    prospect_email: i.prospect_email,\r\n    status: i.status || 'pending',\r\n    introduced_at: i.introduced_at,\r\n    deal: i.deal_id ? dealsMap[i.deal_id] || null : null,\r\n    investor: i.prospect_investor_id ? introInvestorsMap[i.prospect_investor_id] || null : null,\r\n  }))\r\n\r\n  // Fetch commissions separately\r\n  const { data: commissionsData } = await serviceClient\r\n    .from('introducer_commissions')\r\n    .select(`\r\n      id,\r\n      accrual_amount,\r\n      status,\r\n      paid_at,\r\n      created_at,\r\n      deal_id,\r\n      investor_id\r\n    `)\r\n    .eq('introducer_id', id)\r\n    .order('created_at', { ascending: false })\r\n\r\n  // Fetch investor names for commissions\r\n  const commissionInvestorIds = (commissionsData || [])\r\n    .map(c => c.investor_id)\r\n    .filter((id): id is string => id != null)\r\n\r\n  let commissionInvestorsMap: Record<string, { legal_name: string }> = {}\r\n  if (commissionInvestorIds.length > 0) {\r\n    const { data: investorsData } = await serviceClient\r\n      .from('investors')\r\n      .select('id, legal_name')\r\n      .in('id', commissionInvestorIds)\r\n\r\n    commissionInvestorsMap = (investorsData || []).reduce((acc, inv) => {\r\n      acc[inv.id] = { legal_name: inv.legal_name }\r\n      return acc\r\n    }, {} as Record<string, { legal_name: string }>)\r\n  }\r\n\r\n  // Fetch deal names for commissions\r\n  const commissionDealIds = (commissionsData || [])\r\n    .map(c => c.deal_id)\r\n    .filter((id): id is string => id != null)\r\n\r\n  let commissionDealsMap: Record<string, { name: string }> = {}\r\n  if (commissionDealIds.length > 0) {\r\n    const { data: commissionDealsData } = await serviceClient\r\n      .from('deals')\r\n      .select('id, name')\r\n      .in('id', commissionDealIds)\r\n\r\n    commissionDealsMap = (commissionDealsData || []).reduce((acc, d) => {\r\n      acc[d.id] = { name: d.name }\r\n      return acc\r\n    }, {} as Record<string, { name: string }>)\r\n  }\r\n\r\n  const commissions: Commission[] = (commissionsData || []).map(c => {\r\n    const investor = c.investor_id ? commissionInvestorsMap[c.investor_id] : null\r\n    const deal = c.deal_id ? commissionDealsMap[c.deal_id] : null\r\n\r\n    return {\r\n      id: c.id,\r\n      accrual_amount: Number(c.accrual_amount) || 0,\r\n      status: c.status || 'accrued',\r\n      paid_at: c.paid_at,\r\n      created_at: c.created_at,\r\n      deal_id: c.deal_id,\r\n      investor_id: c.investor_id,\r\n      investor: investor || undefined,\r\n      deal: deal || undefined,\r\n    }\r\n  })\r\n\r\n  // Fetch agreements with deal info and PDF URL\r\n  const { data: agreementsData } = await serviceClient\r\n    .from('introducer_agreements')\r\n    .select(`\r\n      id,\r\n      status,\r\n      reference_number,\r\n      default_commission_bps,\r\n      agreement_date,\r\n      effective_date,\r\n      expiry_date,\r\n      special_terms,\r\n      signed_date,\r\n      pdf_url,\r\n      deal_id,\r\n      fee_plan_id,\r\n      created_at,\r\n      updated_at,\r\n      deal:deal_id (\r\n        id,\r\n        name\r\n      )\r\n    `)\r\n    .eq('introducer_id', id)\r\n    .order('created_at', { ascending: false })\r\n\r\n  const agreements: Agreement[] = (agreementsData || []).map((a: any) => ({\r\n    id: a.id,\r\n    status: a.status || 'draft',\r\n    reference_number: a.reference_number,\r\n    default_commission_bps: a.default_commission_bps,\r\n    agreement_date: a.agreement_date,\r\n    effective_date: a.effective_date,\r\n    expiry_date: a.expiry_date,\r\n    special_terms: a.special_terms,\r\n    signed_date: a.signed_date,\r\n    pdf_url: a.pdf_url,\r\n    deal_id: a.deal_id,\r\n    fee_plan_id: a.fee_plan_id,\r\n    created_at: a.created_at,\r\n    updated_at: a.updated_at,\r\n    deal: a.deal,\r\n  }))\r\n\r\n  // Calculate metrics\r\n  const totalIntroductions = introductions.length\r\n  const successfulAllocations = introductions.filter(i =>\r\n    ['allocated', 'converted'].includes(i.status)\r\n  ).length\r\n  const conversionRate = totalIntroductions > 0\r\n    ? (successfulAllocations / totalIntroductions) * 100\r\n    : 0\r\n\r\n  const totalCommissionPaid = commissions\r\n    .filter(c => c.status === 'paid')\r\n    .reduce((sum, c) => sum + c.accrual_amount, 0)\r\n\r\n  const pendingCommission = commissions\r\n    .filter(c => c.status === 'accrued' || c.status === 'invoiced')\r\n    .reduce((sum, c) => sum + c.accrual_amount, 0)\r\n\r\n  const metrics = {\r\n    totalIntroductions,\r\n    successfulAllocations,\r\n    conversionRate,\r\n    totalCommissionPaid,\r\n    pendingCommission,\r\n  }\r\n\r\n  const introducerData = introducer as IntroducerDetail\r\n\r\n  return (\r\n    <IntroducerDetailClient\r\n      introducer={introducerData}\r\n      metrics={metrics}\r\n      introductions={introductions}\r\n      commissions={commissions}\r\n      agreements={agreements}\r\n    />\r\n  )\r\n}\r\n"],"names":[],"mappings":"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","ignoreList":[0]}