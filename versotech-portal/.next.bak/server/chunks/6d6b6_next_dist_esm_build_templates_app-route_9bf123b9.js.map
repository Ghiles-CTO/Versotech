{"version":3,"sources":["../../../../versotech-portal/node_modules/next/dist/esm/build/templates/app-route.js","../../../../versotech-portal/src/app/api/investors/me/opportunities/%5Bid%5D/route.ts"],"sourcesContent":["import { AppRouteRouteModule } from \"next/dist/esm/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/esm/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/esm/server/lib/patch-fetch\";\nimport { addRequestMeta, getRequestMeta } from \"next/dist/esm/server/request-meta\";\nimport { getTracer, SpanKind } from \"next/dist/esm/server/lib/trace/tracer\";\nimport { setManifestsSingleton } from \"next/dist/esm/server/app-render/manifests-singleton\";\nimport { normalizeAppPath } from \"next/dist/esm/shared/lib/router/utils/app-paths\";\nimport { NodeNextRequest, NodeNextResponse } from \"next/dist/esm/server/base-http/node\";\nimport { NextRequestAdapter, signalFromNodeResponse } from \"next/dist/esm/server/web/spec-extension/adapters/next-request\";\nimport { BaseServerSpan } from \"next/dist/esm/server/lib/trace/constants\";\nimport { getRevalidateReason } from \"next/dist/esm/server/instrumentation/utils\";\nimport { sendResponse } from \"next/dist/esm/server/send-response\";\nimport { fromNodeOutgoingHttpHeaders, toNodeOutgoingHttpHeaders } from \"next/dist/esm/server/web/utils\";\nimport { getCacheControlHeader } from \"next/dist/esm/server/lib/cache-control\";\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from \"next/dist/esm/lib/constants\";\nimport { NoFallbackError } from \"next/dist/esm/shared/lib/no-fallback-error.external\";\nimport { CachedRouteKind } from \"next/dist/esm/server/response-cache\";\nimport * as userland from \"INNER_APP_ROUTE\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/investors/me/opportunities/[id]/route\",\n        pathname: \"/api/investors/me/opportunities/[id]\",\n        filename: \"route\",\n        bundlePath: \"\"\n    },\n    distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n    relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n    resolvedPagePath: \"[project]/versotech-portal/src/app/api/investors/me/opportunities/[id]/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\nexport async function handler(req, res, ctx) {\n    if (routeModule.isDev) {\n        addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint());\n    }\n    let srcPage = \"/api/investors/me/opportunities/[id]/route\";\n    // turbopack doesn't normalize `/index` in the page name\n    // so we need to to process dynamic routes properly\n    // TODO: fix turbopack providing differing value from webpack\n    if (process.env.TURBOPACK) {\n        srcPage = srcPage.replace(/\\/index$/, '') || '/';\n    } else if (srcPage === '/index') {\n        // we always normalize /index specifically\n        srcPage = '/';\n    }\n    const multiZoneDraftMode = process.env.__NEXT_MULTI_ZONE_DRAFT_MODE;\n    const prepareResult = await routeModule.prepare(req, res, {\n        srcPage,\n        multiZoneDraftMode\n    });\n    if (!prepareResult) {\n        res.statusCode = 400;\n        res.end('Bad Request');\n        ctx.waitUntil == null ? void 0 : ctx.waitUntil.call(ctx, Promise.resolve());\n        return null;\n    }\n    const { buildId, params, nextConfig, parsedUrl, isDraftMode, prerenderManifest, routerServerContext, isOnDemandRevalidate, revalidateOnlyGenerated, resolvedPathname, clientReferenceManifest, serverActionsManifest } = prepareResult;\n    const normalizedSrcPage = normalizeAppPath(srcPage);\n    let isIsr = Boolean(prerenderManifest.dynamicRoutes[normalizedSrcPage] || prerenderManifest.routes[resolvedPathname]);\n    const render404 = async ()=>{\n        // TODO: should route-module itself handle rendering the 404\n        if (routerServerContext == null ? void 0 : routerServerContext.render404) {\n            await routerServerContext.render404(req, res, parsedUrl, false);\n        } else {\n            res.end('This page could not be found');\n        }\n        return null;\n    };\n    if (isIsr && !isDraftMode) {\n        const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname]);\n        const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage];\n        if (prerenderInfo) {\n            if (prerenderInfo.fallback === false && !isPrerendered) {\n                if (nextConfig.experimental.adapterPath) {\n                    return await render404();\n                }\n                throw new NoFallbackError();\n            }\n        }\n    }\n    let cacheKey = null;\n    if (isIsr && !routeModule.isDev && !isDraftMode) {\n        cacheKey = resolvedPathname;\n        // ensure /index and / is normalized to one key\n        cacheKey = cacheKey === '/index' ? '/' : cacheKey;\n    }\n    const supportsDynamicResponse = // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true || // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr;\n    // This is a revalidation request if the request is for a static\n    // page and it is not being resumed from a postponed render and\n    // it is not a dynamic RSC request then it is a revalidation\n    // request.\n    const isStaticGeneration = isIsr && !supportsDynamicResponse;\n    // Before rendering (which initializes component tree modules), we have to\n    // set the reference manifests to our global store so Server Action's\n    // encryption util can access to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n        setManifestsSingleton({\n            page: srcPage,\n            clientReferenceManifest,\n            serverActionsManifest\n        });\n    }\n    const method = req.method || 'GET';\n    const tracer = getTracer();\n    const activeSpan = tracer.getActiveScopeSpan();\n    const context = {\n        params,\n        prerenderManifest,\n        renderOpts: {\n            experimental: {\n                authInterrupts: Boolean(nextConfig.experimental.authInterrupts)\n            },\n            cacheComponents: Boolean(nextConfig.cacheComponents),\n            supportsDynamicResponse,\n            incrementalCache: getRequestMeta(req, 'incrementalCache'),\n            cacheLifeProfiles: nextConfig.cacheLife,\n            waitUntil: ctx.waitUntil,\n            onClose: (cb)=>{\n                res.on('close', cb);\n            },\n            onAfterTaskError: undefined,\n            onInstrumentationRequestError: (error, _request, errorContext, silenceLog)=>routeModule.onRequestError(req, error, errorContext, silenceLog, routerServerContext)\n        },\n        sharedContext: {\n            buildId\n        }\n    };\n    const nodeNextReq = new NodeNextRequest(req);\n    const nodeNextRes = new NodeNextResponse(res);\n    const nextReq = NextRequestAdapter.fromNodeNextRequest(nodeNextReq, signalFromNodeResponse(res));\n    try {\n        const invokeRouteModule = async (span)=>{\n            return routeModule.handle(nextReq, context).finally(()=>{\n                if (!span) return;\n                span.setAttributes({\n                    'http.status_code': res.statusCode,\n                    'next.rsc': false\n                });\n                const rootSpanAttributes = tracer.getRootSpanAttributes();\n                // We were unable to get attributes, probably OTEL is not enabled\n                if (!rootSpanAttributes) {\n                    return;\n                }\n                if (rootSpanAttributes.get('next.span_type') !== BaseServerSpan.handleRequest) {\n                    console.warn(`Unexpected root span type '${rootSpanAttributes.get('next.span_type')}'. Please report this Next.js issue https://github.com/vercel/next.js`);\n                    return;\n                }\n                const route = rootSpanAttributes.get('next.route');\n                if (route) {\n                    const name = `${method} ${route}`;\n                    span.setAttributes({\n                        'next.route': route,\n                        'http.route': route,\n                        'next.span_name': name\n                    });\n                    span.updateName(name);\n                } else {\n                    span.updateName(`${method} ${srcPage}`);\n                }\n            });\n        };\n        const isMinimalMode = Boolean(process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode'));\n        const handleResponse = async (currentSpan)=>{\n            var _cacheEntry_value;\n            const responseGenerator = async ({ previousCacheEntry })=>{\n                try {\n                    if (!isMinimalMode && isOnDemandRevalidate && revalidateOnlyGenerated && !previousCacheEntry) {\n                        res.statusCode = 404;\n                        // on-demand revalidate always sets this header\n                        res.setHeader('x-nextjs-cache', 'REVALIDATED');\n                        res.end('This page could not be found');\n                        return null;\n                    }\n                    const response = await invokeRouteModule(currentSpan);\n                    req.fetchMetrics = context.renderOpts.fetchMetrics;\n                    let pendingWaitUntil = context.renderOpts.pendingWaitUntil;\n                    // Attempt using provided waitUntil if available\n                    // if it's not we fallback to sendResponse's handling\n                    if (pendingWaitUntil) {\n                        if (ctx.waitUntil) {\n                            ctx.waitUntil(pendingWaitUntil);\n                            pendingWaitUntil = undefined;\n                        }\n                    }\n                    const cacheTags = context.renderOpts.collectedTags;\n                    // If the request is for a static response, we can cache it so long\n                    // as it's not edge.\n                    if (isIsr) {\n                        const blob = await response.blob();\n                        // Copy the headers from the response.\n                        const headers = toNodeOutgoingHttpHeaders(response.headers);\n                        if (cacheTags) {\n                            headers[NEXT_CACHE_TAGS_HEADER] = cacheTags;\n                        }\n                        if (!headers['content-type'] && blob.type) {\n                            headers['content-type'] = blob.type;\n                        }\n                        const revalidate = typeof context.renderOpts.collectedRevalidate === 'undefined' || context.renderOpts.collectedRevalidate >= INFINITE_CACHE ? false : context.renderOpts.collectedRevalidate;\n                        const expire = typeof context.renderOpts.collectedExpire === 'undefined' || context.renderOpts.collectedExpire >= INFINITE_CACHE ? undefined : context.renderOpts.collectedExpire;\n                        // Create the cache entry for the response.\n                        const cacheEntry = {\n                            value: {\n                                kind: CachedRouteKind.APP_ROUTE,\n                                status: response.status,\n                                body: Buffer.from(await blob.arrayBuffer()),\n                                headers\n                            },\n                            cacheControl: {\n                                revalidate,\n                                expire\n                            }\n                        };\n                        return cacheEntry;\n                    } else {\n                        // send response without caching if not ISR\n                        await sendResponse(nodeNextReq, nodeNextRes, response, context.renderOpts.pendingWaitUntil);\n                        return null;\n                    }\n                } catch (err) {\n                    // if this is a background revalidate we need to report\n                    // the request error here as it won't be bubbled\n                    if (previousCacheEntry == null ? void 0 : previousCacheEntry.isStale) {\n                        const silenceLog = false;\n                        await routeModule.onRequestError(req, err, {\n                            routerKind: 'App Router',\n                            routePath: srcPage,\n                            routeType: 'route',\n                            revalidateReason: getRevalidateReason({\n                                isStaticGeneration,\n                                isOnDemandRevalidate\n                            })\n                        }, silenceLog, routerServerContext);\n                    }\n                    throw err;\n                }\n            };\n            const cacheEntry = await routeModule.handleResponse({\n                req,\n                nextConfig,\n                cacheKey,\n                routeKind: RouteKind.APP_ROUTE,\n                isFallback: false,\n                prerenderManifest,\n                isRoutePPREnabled: false,\n                isOnDemandRevalidate,\n                revalidateOnlyGenerated,\n                responseGenerator,\n                waitUntil: ctx.waitUntil,\n                isMinimalMode\n            });\n            // we don't create a cacheEntry for ISR\n            if (!isIsr) {\n                return null;\n            }\n            if ((cacheEntry == null ? void 0 : (_cacheEntry_value = cacheEntry.value) == null ? void 0 : _cacheEntry_value.kind) !== CachedRouteKind.APP_ROUTE) {\n                var _cacheEntry_value1;\n                throw Object.defineProperty(new Error(`Invariant: app-route received invalid cache entry ${cacheEntry == null ? void 0 : (_cacheEntry_value1 = cacheEntry.value) == null ? void 0 : _cacheEntry_value1.kind}`), \"__NEXT_ERROR_CODE\", {\n                    value: \"E701\",\n                    enumerable: false,\n                    configurable: true\n                });\n            }\n            if (!isMinimalMode) {\n                res.setHeader('x-nextjs-cache', isOnDemandRevalidate ? 'REVALIDATED' : cacheEntry.isMiss ? 'MISS' : cacheEntry.isStale ? 'STALE' : 'HIT');\n            }\n            // Draft mode should never be cached\n            if (isDraftMode) {\n                res.setHeader('Cache-Control', 'private, no-cache, no-store, max-age=0, must-revalidate');\n            }\n            const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers);\n            if (!(isMinimalMode && isIsr)) {\n                headers.delete(NEXT_CACHE_TAGS_HEADER);\n            }\n            // If cache control is already set on the response we don't\n            // override it to allow users to customize it via next.config\n            if (cacheEntry.cacheControl && !res.getHeader('Cache-Control') && !headers.get('Cache-Control')) {\n                headers.set('Cache-Control', getCacheControlHeader(cacheEntry.cacheControl));\n            }\n            await sendResponse(nodeNextReq, nodeNextRes, // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n            new Response(cacheEntry.value.body, {\n                headers,\n                status: cacheEntry.value.status || 200\n            }));\n            return null;\n        };\n        // TODO: activeSpan code path is for when wrapped by\n        // next-server can be removed when this is no longer used\n        if (activeSpan) {\n            await handleResponse(activeSpan);\n        } else {\n            await tracer.withPropagatedContext(req.headers, ()=>tracer.trace(BaseServerSpan.handleRequest, {\n                    spanName: `${method} ${srcPage}`,\n                    kind: SpanKind.SERVER,\n                    attributes: {\n                        'http.method': method,\n                        'http.target': req.url\n                    }\n                }, handleResponse));\n        }\n    } catch (err) {\n        if (!(err instanceof NoFallbackError)) {\n            const silenceLog = false;\n            await routeModule.onRequestError(req, err, {\n                routerKind: 'App Router',\n                routePath: normalizedSrcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                    isStaticGeneration,\n                    isOnDemandRevalidate\n                })\n            }, silenceLog, routerServerContext);\n        }\n        // rethrow so that we can handle serving error page\n        // If this is during static generation, throw the error again.\n        if (isIsr) throw err;\n        // Otherwise, send a 500 response.\n        await sendResponse(nodeNextReq, nodeNextRes, new Response(null, {\n            status: 500\n        }));\n        return null;\n    }\n}\n\n//# sourceMappingURL=app-route.js.map\n","import { createClient, createServiceClient } from '@/lib/supabase/server'\r\nimport { NextResponse } from 'next/server'\r\ninterface RouteParams {\r\n  params: Promise<{ id: string }>\r\n}\r\n\r\n/**\r\n * GET /api/investors/me/opportunities/:id\r\n * Fetch a single opportunity with full details, journey stages, and data room access\r\n *\r\n * For MODE 2 (commercial_partner_proxy): Pass ?client_investor_id=xxx to view client's dataroom\r\n */\r\nexport async function GET(request: Request, { params }: RouteParams) {\r\n  console.log('ðŸ”´ [opportunities/[id]] GET handler called')\r\n  const { id: dealId } = await params\r\n  console.log('ðŸ”´ [opportunities/[id]] dealId:', dealId)\r\n  const supabase = await createClient()\r\n  const serviceSupabase = createServiceClient()\r\n\r\n  // Get client_investor_id from query params for MODE 2 proxy access\r\n  const url = new URL(request.url)\r\n  const clientInvestorId = url.searchParams.get('client_investor_id')\r\n\r\n  try {\r\n    const { data: { user }, error: userError } = await supabase.auth.getUser()\r\n    if (userError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n    }\r\n\r\n    // Get user's membership for this deal first (security check)\r\n    // This works for ALL personas: investors, partners, introducers, CPs, lawyers, arrangers\r\n    const { data: membership } = await serviceSupabase\r\n      .from('deal_memberships')\r\n      .select('*')\r\n      .eq('deal_id', dealId)\r\n      .eq('user_id', user.id)\r\n      .maybeSingle()\r\n\r\n    // Get investor ID for this user (optional - only investors have this)\r\n    const { data: investorLinks } = await serviceSupabase\r\n      .from('investor_users')\r\n      .select('investor_id')\r\n      .eq('user_id', user.id)\r\n\r\n    const investorId = investorLinks?.[0]?.investor_id || null\r\n\r\n    // MODE 2: For commercial_partner_proxy role, allow viewing client's dataroom\r\n    let effectiveInvestorId = membership?.investor_id || investorId\r\n    let isProxyMode = false\r\n    let proxyClientName: string | null = null\r\n\r\n    if (clientInvestorId && membership?.role === 'commercial_partner_proxy') {\r\n      // Validate that this user's CP has access to the client\r\n      const { data: cpLink } = await serviceSupabase\r\n        .from('commercial_partner_users')\r\n        .select('commercial_partner_id')\r\n        .eq('user_id', user.id)\r\n        .maybeSingle()\r\n\r\n      if (cpLink) {\r\n        // Check if client is linked to this CP\r\n        const { data: clientLink } = await serviceSupabase\r\n          .from('commercial_partner_clients')\r\n          .select('id, client_name, client_investor_id')\r\n          .eq('commercial_partner_id', cpLink.commercial_partner_id)\r\n          .eq('client_investor_id', clientInvestorId)\r\n          .eq('is_active', true)\r\n          .maybeSingle()\r\n\r\n        if (clientLink) {\r\n          // Valid client - use their investor_id for dataroom access\r\n          effectiveInvestorId = clientInvestorId\r\n          isProxyMode = true\r\n          proxyClientName = clientLink.client_name\r\n          console.log('ðŸ”µ [opportunities/[id]] MODE 2: Viewing as proxy for client:', proxyClientName)\r\n        } else {\r\n          return NextResponse.json({ error: 'Client not authorized for this commercial partner' }, { status: 403 })\r\n        }\r\n      }\r\n    }\r\n\r\n    // Check if investor has access to this deal (must be a member or deal is public)\r\n    const { data: deal, error: dealError } = await serviceSupabase\r\n      .from('deals')\r\n      .select('*')\r\n      .eq('id', dealId)\r\n      .single()\r\n\r\n    if (dealError || !deal) {\r\n      console.error('[GET opportunity] Deal query failed:', { dealId, dealError, deal })\r\n      return NextResponse.json({ error: 'Deal not found' }, { status: 404 })\r\n    }\r\n\r\n    // DEBUG: Log what deal was fetched to verify correct data\r\n    console.log('ðŸ”µ [opportunities/[id]] Deal fetched:', {\r\n      requestedId: dealId,\r\n      returnedId: deal.id,\r\n      returnedName: deal.name,\r\n      match: dealId === deal.id\r\n    })\r\n\r\n    // Fetch vehicle separately if it exists\r\n    let vehicle = null\r\n    if (deal.vehicle_id) {\r\n      const { data: v } = await serviceSupabase\r\n        .from('vehicles')\r\n        .select('id, name, type, formation_date, currency')\r\n        .eq('id', deal.vehicle_id)\r\n        .single()\r\n      vehicle = v\r\n    }\r\n\r\n    const isDealOpen = deal.status === 'open' || deal.status === 'allocation_pending'\r\n\r\n    // Security: Only allow access if membership exists or deal is explicitly public\r\n    if (!membership && !isDealOpen) {\r\n      return NextResponse.json({ error: 'You do not have access to this opportunity' }, { status: 403 })\r\n    }\r\n\r\n    // Get data room access (use maybeSingle as record might not exist)\r\n    const { data: dataRoomAccess } = await serviceSupabase\r\n      .from('deal_data_room_access')\r\n      .select('*')\r\n      .eq('deal_id', dealId)\r\n      .eq('investor_id', effectiveInvestorId)\r\n      .is('revoked_at', null)\r\n      .order('granted_at', { ascending: false })\r\n      .limit(1)\r\n      .maybeSingle()\r\n\r\n    // Get subscription if exists (use maybeSingle as subscription might not exist)\r\n    const vehicleId = deal.vehicle_id\r\n    let subscription = null\r\n    let subscriptionSubmission: { id: string; status: string; submitted_at: string | null } | null = null\r\n    let subscriptionDocuments: {\r\n      nda: {\r\n        status: string\r\n        signatories: Array<{\r\n          name: string\r\n          email: string\r\n          status: string\r\n          signed_at: string | null\r\n        }>\r\n        unsigned_url: string | null\r\n        signed_url: string | null\r\n      }\r\n      subscription_pack: {\r\n        status: string\r\n        signatories: Array<{\r\n          name: string\r\n          email: string\r\n          status: string\r\n          signed_at: string | null\r\n        }>\r\n        unsigned_url: string | null\r\n        signed_url: string | null\r\n      }\r\n      certificate: {\r\n        status: string\r\n        url: string | null\r\n      } | null\r\n    } | null = null\r\n\r\n    // Query subscription by deal_id (NOT vehicle_id) to ensure deal-specific data\r\n    // Multiple deals can share the same vehicle_id, so using vehicle_id would\r\n    // return subscriptions from wrong deals (e.g., both Anthropic deals share a vehicle)\r\n    if (dealId) {\r\n      const { data: sub } = await serviceSupabase\r\n        .from('subscriptions')\r\n        .select(`\r\n          id,\r\n          status,\r\n          commitment,\r\n          currency,\r\n          funded_amount,\r\n          pack_generated_at,\r\n          pack_sent_at,\r\n          signed_at,\r\n          funded_at,\r\n          activated_at,\r\n          created_at\r\n        `)\r\n        .eq('deal_id', dealId)\r\n        .eq('investor_id', effectiveInvestorId)\r\n        .order('created_at', { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle()\r\n\r\n      subscription = sub\r\n\r\n      // Fetch signature documents for this subscription\r\n      if (sub) {\r\n        // Get NDA signature requests for this deal/investor\r\n        const { data: ndaSignatures } = await serviceSupabase\r\n          .from('signature_requests')\r\n          .select('id, signer_name, signer_email, status, signature_timestamp, unsigned_pdf_path, signed_pdf_path')\r\n          .eq('deal_id', dealId)\r\n          .eq('investor_id', effectiveInvestorId)\r\n          .eq('document_type', 'nda')\r\n          .order('created_at', { ascending: true })\r\n\r\n        // Get subscription pack signature requests\r\n        const { data: subPackSignatures } = await serviceSupabase\r\n          .from('signature_requests')\r\n          .select('id, signer_name, signer_email, status, signature_timestamp, unsigned_pdf_path, signed_pdf_path')\r\n          .eq('subscription_id', sub.id)\r\n          .eq('document_type', 'subscription')\r\n          .order('created_at', { ascending: true })\r\n\r\n        // Calculate NDA status\r\n        const ndaSigs = ndaSignatures || []\r\n        const ndaAllSigned = ndaSigs.length > 0 && ndaSigs.every(s => s.status === 'signed')\r\n        const ndaSomeSigned = ndaSigs.some(s => s.status === 'signed')\r\n        const ndaStatus = ndaAllSigned ? 'complete' : ndaSomeSigned ? 'partial' : ndaSigs.length > 0 ? 'pending' : 'not_started'\r\n\r\n        // Calculate subscription pack status\r\n        const subSigs = subPackSignatures || []\r\n        const subAllSigned = subSigs.length > 0 && subSigs.every(s => s.status === 'signed')\r\n        const subSomeSigned = subSigs.some(s => s.status === 'signed')\r\n        const subStatus = subAllSigned ? 'complete' : subSomeSigned ? 'partial' : subSigs.length > 0 ? 'pending' : 'not_started'\r\n\r\n        // Get the first available PDF paths (they're the same for all signatories of same doc type)\r\n        const ndaUnsignedPath = ndaSigs.find(s => s.unsigned_pdf_path)?.unsigned_pdf_path || null\r\n        const ndaSignedPath = ndaAllSigned ? ndaSigs.find(s => s.signed_pdf_path)?.signed_pdf_path : null\r\n        const subUnsignedPath = subSigs.find(s => s.unsigned_pdf_path)?.unsigned_pdf_path || null\r\n        const subSignedPath = subAllSigned ? subSigs.find(s => s.signed_pdf_path)?.signed_pdf_path : null\r\n\r\n        subscriptionDocuments = {\r\n          nda: {\r\n            status: ndaStatus,\r\n            signatories: ndaSigs.map(s => ({\r\n              name: s.signer_name,\r\n              email: s.signer_email,\r\n              status: s.status,\r\n              signed_at: s.signature_timestamp\r\n            })),\r\n            unsigned_url: ndaUnsignedPath,\r\n            signed_url: ndaSignedPath\r\n          },\r\n          subscription_pack: {\r\n            status: subStatus,\r\n            signatories: subSigs.map(s => ({\r\n              name: s.signer_name,\r\n              email: s.signer_email,\r\n              status: s.status,\r\n              signed_at: s.signature_timestamp\r\n            })),\r\n            unsigned_url: subUnsignedPath,\r\n            signed_url: subSignedPath\r\n          },\r\n          // Certificate - lookup from documents table if subscription is activated\r\n          certificate: await (async () => {\r\n            if (!sub.activated_at) return null\r\n\r\n            // Check for actual certificate document\r\n            const { data: certDoc } = await serviceSupabase\r\n              .from('documents')\r\n              .select('id, file_key')\r\n              .eq('subscription_id', sub.id)\r\n              .eq('type', 'certificate')\r\n              .maybeSingle()\r\n\r\n            if (certDoc) {\r\n              return {\r\n                status: 'available',\r\n                document_id: certDoc.id,\r\n                url: certDoc.file_key\r\n              }\r\n            }\r\n\r\n            // Certificate not yet generated\r\n            return {\r\n              status: 'generating',\r\n              document_id: null,\r\n              url: null\r\n            }\r\n          })()\r\n        }\r\n      }\r\n    }\r\n\r\n    if (effectiveInvestorId) {\r\n      const { data: submission } = await serviceSupabase\r\n        .from('deal_subscription_submissions')\r\n        .select('id, status, submitted_at')\r\n        .eq('deal_id', dealId)\r\n        .eq('investor_id', effectiveInvestorId)\r\n        .order('submitted_at', { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle()\r\n\r\n      subscriptionSubmission = submission ?? null\r\n    }\r\n\r\n    // Get journey stages using RPC function\r\n    const { data: journeyStages } = await serviceSupabase\r\n      .rpc('get_investor_journey_stage', {\r\n        p_deal_id: dealId,\r\n        p_investor_id: effectiveInvestorId\r\n      })\r\n\r\n    // Get fee structures for the deal\r\n    // PERSONA ACCESS RULES (per Fred's meeting requirements):\r\n    // - Introducers: CANNOT see term sheet (fee structures)\r\n    // - Lawyers: CANNOT see term sheet (fee structures)\r\n    // - All others (investors, partners, arrangers, CPs): CAN see term sheet\r\n    const isRestrictedFromTermSheet = membership?.role === 'introducer' || membership?.role === 'lawyer'\r\n\r\n    let feeStructures: any[] = []\r\n    if (!isRestrictedFromTermSheet) {\r\n      // Check if investor has an assigned term sheet (from dispatch)\r\n      if (membership?.term_sheet_id) {\r\n        // Fetch ONLY the assigned term sheet - this ensures different investor classes\r\n        // see their specific fee structure based on how they were dispatched\r\n        const { data: assignedTermSheet } = await serviceSupabase\r\n          .from('deal_fee_structures')\r\n          .select('*')\r\n          .eq('id', membership.term_sheet_id)\r\n          .single()\r\n\r\n        if (assignedTermSheet) {\r\n          feeStructures = [assignedTermSheet]\r\n        }\r\n      }\r\n\r\n      // Fallback: If no assigned term sheet or it wasn't found, get first published\r\n      // This handles backward compatibility for existing memberships\r\n      if (feeStructures.length === 0) {\r\n        const { data: fallbackTermSheet } = await serviceSupabase\r\n          .from('deal_fee_structures')\r\n          .select('*')\r\n          .eq('deal_id', dealId)\r\n          .eq('status', 'published')\r\n          .order('created_at', { ascending: true })\r\n          .limit(1)\r\n\r\n        feeStructures = fallbackTermSheet || []\r\n      }\r\n    }\r\n\r\n    // Get FAQs for the deal\r\n    const { data: faqs } = await serviceSupabase\r\n      .from('deal_faqs')\r\n      .select('*')\r\n      .eq('deal_id', dealId)\r\n      .order('display_order', { ascending: true })\r\n\r\n    // Get all authorized signatories for the investor entity\r\n    const { data: allSignatories } = await serviceSupabase\r\n      .from('investor_members')\r\n      .select('id')\r\n      .eq('investor_id', effectiveInvestorId)\r\n      .eq('role', 'authorized_signatory')\r\n      .eq('is_active', true)\r\n\r\n    // Check if ALL signatories have signed NDA for this deal (entity-level check)\r\n    // Per Fred's requirement: ALL signatories must sign before ANY entity user gets data room access\r\n    let allSignatoriesSignedNda = true\r\n    if (allSignatories && allSignatories.length > 0) {\r\n      const { data: ndaSignatures } = await serviceSupabase\r\n        .from('signature_requests')\r\n        .select('member_id')\r\n        .eq('deal_id', dealId)\r\n        .eq('investor_id', effectiveInvestorId)\r\n        .eq('document_type', 'nda')\r\n        .not('signature_timestamp', 'is', null)\r\n\r\n      const signedMemberIds = new Set((ndaSignatures || []).map(sig => sig.member_id))\r\n      allSignatoriesSignedNda = allSignatories.every(sig => signedMemberIds.has(sig.id))\r\n    }\r\n\r\n    // Get data room documents if investor has access\r\n    // PERSONA ACCESS RULES (per Fred's meeting requirements):\r\n    // - Introducers: NEVER get data room access\r\n    // - Lawyers: NEVER get data room access\r\n    // - Arrangers: AUTOMATIC access (no NDA required)\r\n    // - All others (investors, partners, CPs): Access after NDA signed\r\n    const isRestrictedFromDataRoom = membership?.role === 'introducer' || membership?.role === 'lawyer'\r\n    const isArrangerWithAutoAccess = membership?.role === 'arranger'\r\n\r\n    let dataRoomDocuments: any[] = []\r\n    let hasDataRoomAccess = false\r\n\r\n    if (isRestrictedFromDataRoom) {\r\n      // Introducers and lawyers NEVER get data room access\r\n      hasDataRoomAccess = false\r\n    } else if (isArrangerWithAutoAccess) {\r\n      // Arrangers get AUTOMATIC access - no NDA required (per Fred: \"doesn't need to sign an NDA so it's automatic\")\r\n      hasDataRoomAccess = true\r\n    } else {\r\n      // Check if access was already legitimately granted (grandfathering)\r\n      // This handles the case where new signatories are added AFTER NDA was signed\r\n      // - Expiry check is preserved (7-day access period still enforced)\r\n      // - Revocation check is preserved\r\n      // - New investors still need ALL signatories to sign before first access\r\n      const accessRecordValid = dataRoomAccess &&\r\n        !dataRoomAccess.revoked_at &&\r\n        (!dataRoomAccess.expires_at || new Date(dataRoomAccess.expires_at) > new Date())\r\n\r\n      const accessAlreadyGranted = membership?.data_room_granted_at && accessRecordValid\r\n\r\n      // Grant access if: already granted (grandfather) OR all current signatories have signed\r\n      hasDataRoomAccess = accessAlreadyGranted || (allSignatoriesSignedNda && accessRecordValid)\r\n    }\r\n\r\n    if (hasDataRoomAccess) {\r\n      const { data: docs } = await serviceSupabase\r\n        .from('deal_data_room_documents')\r\n        .select(`\r\n          id,\r\n          deal_id,\r\n          file_name,\r\n          file_key,\r\n          folder,\r\n          file_size_bytes,\r\n          mime_type,\r\n          document_notes,\r\n          created_at,\r\n          document_expires_at,\r\n          is_featured,\r\n          external_link\r\n        `)\r\n        .eq('deal_id', dealId)\r\n        .eq('visible_to_investors', true)\r\n        .order('folder', { ascending: true })\r\n        .order('file_name', { ascending: true })\r\n\r\n      const now = new Date()\r\n      dataRoomDocuments = (docs || [])\r\n        .filter(doc => !doc.document_expires_at || new Date(doc.document_expires_at) > now)\r\n        .map(doc => ({\r\n          id: doc.id,\r\n          file_name: doc.file_name || 'Document',\r\n          file_type: doc.mime_type || 'application/octet-stream',\r\n          file_size: doc.file_size_bytes ? Number(doc.file_size_bytes) : 0,\r\n          category: doc.folder || 'General',\r\n          description: doc.document_notes || null,\r\n          uploaded_at: doc.created_at,\r\n          is_featured: doc.is_featured || false,\r\n          external_link: doc.external_link || null,\r\n          file_key: doc.file_key || null\r\n        }))\r\n    }\r\n\r\n    // Get investor's authorized signatories\r\n    const { data: signatories } = await serviceSupabase\r\n      .from('investor_members')\r\n      .select('id, full_name, email, role')\r\n      .eq('investor_id', effectiveInvestorId)\r\n      .eq('role', 'authorized_signatory')\r\n      .eq('is_active', true)\r\n\r\n    // Calculate current journey stage\r\n    let currentStage = 0\r\n    if (subscription?.activated_at) currentStage = 10\r\n    else if (subscription?.funded_at) currentStage = 9\r\n    else if (subscription?.signed_at) currentStage = 8\r\n    else if (subscription?.pack_sent_at) currentStage = 7\r\n    else if (subscription?.pack_generated_at) currentStage = 6\r\n    else if (membership?.data_room_granted_at) currentStage = 5\r\n    else if (membership?.nda_signed_at) currentStage = 4\r\n    else if (membership?.interest_confirmed_at) currentStage = 3\r\n    else if (membership?.viewed_at) currentStage = 2\r\n    else if (membership?.dispatched_at) currentStage = 1\r\n\r\n    // Build the response\r\n    const hasPendingSubmission = subscriptionSubmission?.status === 'pending_review'\r\n\r\n    const opportunity = {\r\n      id: deal.id,\r\n      name: deal.name,\r\n      description: deal.description,\r\n      investment_thesis: deal.investment_thesis,\r\n      status: deal.status,\r\n      deal_type: deal.deal_type,\r\n      currency: deal.currency || 'USD',\r\n      minimum_investment: deal.minimum_investment,\r\n      maximum_investment: deal.maximum_investment,\r\n      target_amount: deal.target_amount,\r\n      raised_amount: deal.raised_amount,\r\n      offer_unit_price: deal.offer_unit_price,\r\n      open_at: deal.open_at,\r\n      close_at: deal.close_at,\r\n      company_name: deal.company_name,\r\n      company_logo_url: deal.company_logo_url,\r\n      company_website: deal.company_website,\r\n      sector: deal.sector,\r\n      stage: deal.stage,\r\n      location: deal.location,\r\n      stock_type: deal.stock_type,\r\n      deal_round: deal.deal_round,\r\n      vehicle: vehicle,\r\n\r\n      // Membership status\r\n      has_membership: !!membership,\r\n      membership: membership ? {\r\n        role: membership.role,\r\n        dispatched_at: membership.dispatched_at,\r\n        viewed_at: membership.viewed_at,\r\n        interest_confirmed_at: membership.interest_confirmed_at,\r\n        nda_signed_at: membership.nda_signed_at,\r\n        data_room_granted_at: membership.data_room_granted_at\r\n      } : null,\r\n\r\n      // Journey progress\r\n      journey: {\r\n        current_stage: currentStage,\r\n        stages: journeyStages || [],\r\n        summary: {\r\n          received: membership?.dispatched_at || null,\r\n          viewed: membership?.viewed_at || null,\r\n          interest_confirmed: membership?.interest_confirmed_at || null,\r\n          nda_signed: membership?.nda_signed_at || null,\r\n          data_room_access: membership?.data_room_granted_at || null,\r\n          pack_generated: subscription?.pack_generated_at || null,\r\n          pack_sent: subscription?.pack_sent_at || null,\r\n          signed: subscription?.signed_at || null,\r\n          funded: subscription?.funded_at || null,\r\n          active: subscription?.activated_at || null\r\n        }\r\n      },\r\n\r\n      // Data room access\r\n      data_room: {\r\n        has_access: hasDataRoomAccess,\r\n        access_details: dataRoomAccess ? {\r\n          granted_at: dataRoomAccess.granted_at,\r\n          expires_at: dataRoomAccess.expires_at,\r\n          auto_granted: dataRoomAccess.auto_granted\r\n        } : null,\r\n        documents: dataRoomDocuments,\r\n        requires_nda: !allSignatoriesSignedNda,\r\n        nda_status: {\r\n          all_signed: allSignatoriesSignedNda,\r\n          total_signatories: allSignatories?.length || 0,\r\n          message: allSignatories && allSignatories.length > 0 && !allSignatoriesSignedNda\r\n            ? `All ${allSignatories.length} authorized signatories must sign the NDA to unlock the data room`\r\n            : null\r\n        }\r\n      },\r\n\r\n      // Subscription status\r\n      subscription: subscription ? {\r\n        id: subscription.id,\r\n        status: subscription.status,\r\n        commitment: subscription.commitment,\r\n        currency: subscription.currency || deal.currency || 'USD',\r\n        funded_amount: subscription.funded_amount,\r\n        pack_generated_at: subscription.pack_generated_at,\r\n        pack_sent_at: subscription.pack_sent_at,\r\n        signed_at: subscription.signed_at,\r\n        funded_at: subscription.funded_at,\r\n        activated_at: subscription.activated_at,\r\n        created_at: subscription.created_at,\r\n        is_signed: !!subscription.signed_at,\r\n        is_funded: !!subscription.funded_at,\r\n        is_active: !!subscription.activated_at,\r\n        documents: subscriptionDocuments\r\n      } : null,\r\n      subscription_submission: subscriptionSubmission,\r\n\r\n      // Fee structures\r\n      fee_structures: feeStructures || [],\r\n\r\n      // FAQs\r\n      faqs: faqs || [],\r\n\r\n      // Signatories for NDA/subscription signing\r\n      signatories: signatories || [],\r\n\r\n      // Computed flags for UI\r\n      // Only show express interest for users with an investor persona\r\n      can_express_interest: effectiveInvestorId !== null && !membership?.interest_confirmed_at,\r\n      can_sign_nda: !!membership?.interest_confirmed_at && !membership?.nda_signed_at,\r\n      can_access_data_room: hasDataRoomAccess,\r\n      // SECURITY FIX: Only allow subscription for roles that permit investing\r\n      // commercial_partner_proxy has its own endpoint at /api/commercial-partners/proxy-subscribe\r\n      // Must have an investor profile (effectiveInvestorId) to be able to subscribe\r\n      can_subscribe: effectiveInvestorId !== null && !subscription && !hasPendingSubmission && isDealOpen && (\r\n        !membership?.role || // Public deal without membership (user still needs investor profile - checked above)\r\n        ['investor', 'partner_investor', 'introducer_investor', 'commercial_partner_investor', 'co_investor'].includes(membership.role)\r\n      ),\r\n      // Indicate if user is tracking-only (cannot invest)\r\n      is_tracking_only: !!membership?.role && !['investor', 'partner_investor', 'introducer_investor', 'commercial_partner_investor', 'co_investor'].includes(membership.role),\r\n      can_sign_subscription: subscription?.pack_sent_at && !subscription?.signed_at,\r\n\r\n      // MODE 2: Proxy mode info for commercial partners viewing on behalf of clients\r\n      proxy_mode: isProxyMode ? {\r\n        is_proxy: true,\r\n        client_name: proxyClientName,\r\n        client_investor_id: clientInvestorId\r\n      } : null,\r\n\r\n      // Indicate if user can use proxy mode (has commercial_partner_proxy role)\r\n      can_use_proxy_mode: membership?.role === 'commercial_partner_proxy',\r\n\r\n      // PERSONA-BASED ACCESS CONTROLS (per Fred's meeting requirements)\r\n      // These flags tell the frontend which sections to hide/show\r\n      access_controls: {\r\n        // Introducers and lawyers cannot see the term sheet\r\n        can_view_term_sheet: !isRestrictedFromTermSheet,\r\n        // Introducers and lawyers never get data room access\r\n        can_view_data_room: !isRestrictedFromDataRoom,\r\n        // Arrangers get automatic access without NDA\r\n        has_auto_data_room_access: isArrangerWithAutoAccess,\r\n        // Reason for restrictions (for UI messaging)\r\n        restriction_reason: isRestrictedFromTermSheet || isRestrictedFromDataRoom\r\n          ? `As ${membership?.role === 'introducer' ? 'an introducer' : 'a lawyer'}, you do not have access to ${isRestrictedFromTermSheet && isRestrictedFromDataRoom ? 'the term sheet or data room' : isRestrictedFromTermSheet ? 'the term sheet' : 'the data room'} for this deal.`\r\n          : null\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({ opportunity })\r\n  } catch (error) {\r\n    console.error('Unexpected error in GET /api/investors/me/opportunities/:id:', error)\r\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/investors/me/opportunities/:id\r\n * Record view or express interest in an opportunity\r\n */\r\nexport async function POST(request: Request, { params }: RouteParams) {\r\n  const { id: dealId } = await params\r\n  const supabase = await createClient()\r\n  const serviceSupabase = createServiceClient()\r\n\r\n  try {\r\n    const { data: { user }, error: userError } = await supabase.auth.getUser()\r\n    if (userError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n    }\r\n\r\n    const body = await request.json()\r\n    const action = body.action as string\r\n\r\n    // Validate action\r\n    const validActions = ['view', 'express_interest']\r\n    if (!validActions.includes(action)) {\r\n      return NextResponse.json({ error: 'Invalid action' }, { status: 400 })\r\n    }\r\n\r\n    // Get investor ID\r\n    const { data: investorLinks } = await serviceSupabase\r\n      .from('investor_users')\r\n      .select('investor_id')\r\n      .eq('user_id', user.id)\r\n\r\n    if (!investorLinks || investorLinks.length === 0) {\r\n      return NextResponse.json({ error: 'No investor profile found' }, { status: 404 })\r\n    }\r\n\r\n    const investorId = investorLinks[0].investor_id\r\n\r\n    // Check if membership exists (use user_id for PK)\r\n    const { data: existingMembership } = await serviceSupabase\r\n      .from('deal_memberships')\r\n      .select('*')\r\n      .eq('deal_id', dealId)\r\n      .eq('user_id', user.id)\r\n      .single()\r\n\r\n    if (action === 'view') {\r\n      if (existingMembership) {\r\n        // Update viewed_at if not already set\r\n        if (!existingMembership.viewed_at) {\r\n          await serviceSupabase\r\n            .from('deal_memberships')\r\n            .update({ viewed_at: new Date().toISOString() })\r\n            .eq('deal_id', dealId)\r\n            .eq('user_id', user.id)\r\n        }\r\n      } else {\r\n        // Create new membership with viewed_at (for direct view without dispatch)\r\n        await serviceSupabase\r\n          .from('deal_memberships')\r\n          .insert({\r\n            deal_id: dealId,\r\n            user_id: user.id,\r\n            investor_id: investorId,\r\n            role: 'investor',\r\n            viewed_at: new Date().toISOString()\r\n          })\r\n      }\r\n\r\n      return NextResponse.json({ success: true, action: 'viewed' })\r\n    }\r\n\r\n    if (action === 'express_interest') {\r\n      if (!existingMembership) {\r\n        // Create membership and express interest in one go\r\n        await serviceSupabase\r\n          .from('deal_memberships')\r\n          .insert({\r\n            deal_id: dealId,\r\n            user_id: user.id,\r\n            investor_id: investorId,\r\n            role: 'investor',\r\n            viewed_at: new Date().toISOString(),\r\n            interest_confirmed_at: new Date().toISOString()\r\n          })\r\n      } else if (!existingMembership.interest_confirmed_at) {\r\n        // Update existing membership\r\n        await serviceSupabase\r\n          .from('deal_memberships')\r\n          .update({\r\n            interest_confirmed_at: new Date().toISOString(),\r\n            viewed_at: existingMembership.viewed_at || new Date().toISOString()\r\n          })\r\n          .eq('deal_id', dealId)\r\n          .eq('user_id', user.id)\r\n      }\r\n\r\n      return NextResponse.json({ success: true, action: 'interest_expressed' })\r\n    }\r\n\r\n    return NextResponse.json({ error: 'Unknown action' }, { status: 400 })\r\n  } catch (error) {\r\n    console.error('Unexpected error in POST /api/investors/me/opportunities/:id:', error)\r\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","ignoreList":[0]}