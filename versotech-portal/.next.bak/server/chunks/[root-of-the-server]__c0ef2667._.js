module.exports=[430586,e=>{"use strict";let t={storage:{bucket:process.env.SIGNATURES_BUCKET||"signatures",paths:{unsigned:(e,t)=>`${e}/${t}_unsigned.pdf`,signed:(e,t)=>`${e}/${t}_signed.pdf`}},token:{lengthBytes:32,expiryDays:7},pdf:{signature:{width:150,height:50},table:{bottom:433,height:112},positions:{party_a:{xPercent:.292},party_b:{xPercent:.704}},metadata:{timestampFontSize:7,timestampOffsetY:12,signerNameOffsetY:22,textColor:{r:.3,g:.3,b:.3}}},email:{fromAddress:"signatures@versoholdings.com",replyTo:"support@versoholdings.com"}};e.s(["SIGNATURE_CONFIG",0,t])},821275,e=>{"use strict";var t=e.i(254799),r=e.i(430586);function n(){return t.default.randomBytes(r.SIGNATURE_CONFIG.token.lengthBytes).toString("hex")}function a(e){let t=new Date;return t.setDate(t.getDate()+(e||r.SIGNATURE_CONFIG.token.expiryDays)),t}function o(e){return new Date>new Date(e)}function s(){return"http://localhost:3000".replace(/\/+$/,"")}function i(e){let t=s();return`${t}/sign/${e}`}e.s(["calculateTokenExpiry",()=>a,"generateSignatureToken",()=>n,"generateSigningUrl",()=>i,"getAppUrl",()=>s,"isTokenExpired",()=>o])},415653,e=>{"use strict";async function t(e,t){try{let{data:r,error:n}=await e.from("subscriptions").select(`
        *,
        vehicle:vehicles (
          id,
          name
        ),
        fee_plan:fee_plans (
          id,
          components:fee_components (
            kind,
            frequency,
            payment_schedule
          )
        )
      `).eq("id",t).single();if(n||!r)return{success:!1,error:n?.message||"Subscription not found"};let a=[],o=r.fee_plan,s=e=>{if(!o||!o.components)return{frequency:"one_time",payment_schedule:"upfront"};let t=o.components.find(t=>t.kind===e);return{frequency:t?.frequency||"one_time",payment_schedule:t?.payment_schedule||"upfront"}},i=r.commitment||0;if(i>0&&a.push({fee_type:"flat",base_amount:i,computed_amount:i,rate_bps:null,frequency:"one_time",payment_schedule:"upfront",description:`Investment commitment - ${r.vehicle?.name||"vehicle"}`}),null!=r.subscription_fee_percent||null!=r.subscription_fee_amount){let e=r.commitment||0,{frequency:t,payment_schedule:n}=s("subscription"),o=null!=r.subscription_fee_amount?r.subscription_fee_amount:e*(r.subscription_fee_percent||0)/100;a.push({fee_type:"subscription",base_amount:e,computed_amount:o,rate_bps:r.subscription_fee_percent?Math.round(100*r.subscription_fee_percent):null,frequency:t,payment_schedule:n,description:`Subscription fee for ${r.commitment||0} commitment`})}if(null!=r.management_fee_percent||null!=r.management_fee_amount){let e=r.commitment||0,{frequency:t,payment_schedule:n}=s("management"),o=r.management_fee_frequency||t,i=null!=r.management_fee_amount?r.management_fee_amount:e*(r.management_fee_percent||0)/100;a.push({fee_type:"management",base_amount:e,computed_amount:i,rate_bps:r.management_fee_percent?Math.round(100*r.management_fee_percent):null,frequency:o,payment_schedule:n,description:`Management fee for ${r.commitment||0} commitment`})}if(null!=r.bd_fee_percent||null!=r.bd_fee_amount){let e=r.commitment||0,{frequency:t,payment_schedule:n}=s("bd_fee"),o=null!=r.bd_fee_amount?r.bd_fee_amount:e*(r.bd_fee_percent||0)/100;a.push({fee_type:"bd_fee",base_amount:e,computed_amount:o,rate_bps:r.bd_fee_percent?Math.round(100*r.bd_fee_percent):null,frequency:t,payment_schedule:n,description:`Broker-dealer fee for ${r.commitment||0} commitment`})}if(r.finra_fee_amount){let{frequency:e,payment_schedule:t}=s("finra_fee");a.push({fee_type:"finra_fee",base_amount:r.finra_fee_amount,computed_amount:r.finra_fee_amount,rate_bps:null,frequency:e,payment_schedule:t,description:"FINRA regulatory fee"})}if(r.spread_fee_amount){let{frequency:e,payment_schedule:t}=s("spread_markup");a.push({fee_type:"spread_markup",base_amount:r.spread_fee_amount,computed_amount:r.spread_fee_amount,rate_bps:null,frequency:e,payment_schedule:t,description:"Spread markup fee"})}if(r.performance_fee_tier1_percent||r.performance_fee_tier2_percent){let{frequency:e,payment_schedule:t}=s("performance"),n=r.commitment||0,o=r.current_nav||0,i=0,c=r.performance_fee_tier1_threshold||0,u=r.performance_fee_tier2_threshold||0,l=r.performance_fee_tier1_percent||0,p=r.performance_fee_tier2_percent||0;if(o>0&&n>0){let e=o-n;e>0&&(p>0&&e>u?i=p/100*e:l>0&&e>c&&(i=l/100*e))}let m="Performance fee";p>0&&u>0?m=`Performance fee (Tier 2: ${p}% above ${u} returns)`:l>0&&(m=`Performance fee (Tier 1: ${l}% above ${c||0} returns)`),a.push({fee_type:"performance",base_amount:o>0?o-n:0,computed_amount:i,rate_bps:p>0?Math.round(100*p):Math.round(100*l),frequency:e,payment_schedule:t,description:m})}return{success:!0,feeEvents:a}}catch(e){return console.error("Error calculating subscription fee events:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function r(e,t,r,n,a,o,s){try{if(!s?.skipDeduplication){let{data:r,error:n}=await e.from("fee_events").select("id").eq("allocation_id",t).limit(1);if(n)console.warn("[FEE EVENTS] Error checking existing fee events:",n.message);else if(r&&r.length>0)return console.log(`[FEE EVENTS] Fee events already exist for subscription ${t}, skipping creation`),{success:!0,feeEventIds:[],skipped:!0}}let{data:i}=await e.from("subscriptions").select("currency").eq("id",t).single(),c=i?.currency||"USD",u=null;if(a){let{data:t}=await e.from("fee_plans").select("created_by_arranger_id").eq("id",a).single();t?.created_by_arranger_id&&(u=t.created_by_arranger_id)}if(!u&&n){let{data:t}=await e.from("deals").select("arranger_entity_id").eq("id",n).single();t?.arranger_entity_id&&(u=t.arranger_entity_id)}let l={};if(a){let{data:t}=await e.from("fee_components").select("id, kind").eq("fee_plan_id",a);t&&t.forEach(e=>{l[e.kind]=e.id})}let p=o.map(e=>{let o="flat"===e.fee_type?null:l[e.fee_type]||null;return"flat"!==e.fee_type&&!o&&a&&console.warn(`‚ö†Ô∏è [FEE EVENTS] No component found for fee_type '${e.fee_type}' in fee plan ${a}. Fee event will be created without component link.`),{investor_id:r,deal_id:n,allocation_id:t,fee_component_id:o,fee_type:e.fee_type,event_date:new Date().toISOString(),base_amount:e.base_amount,computed_amount:e.computed_amount,rate_bps:e.rate_bps,currency:c,status:"accrued",notes:e.description,payee_arranger_id:u}}),{data:m,error:f}=await e.from("fee_events").insert(p).select("id");if(f)return{success:!1,error:f.message};return{success:!0,feeEventIds:m?.map(e=>e.id)||[]}}catch(e){return console.error("Error creating fee events:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}e.s(["calculateSubscriptionFeeEvents",()=>t,"createFeeEvents",()=>r])},816531,e=>{"use strict";function t(e){let t=e.match(/^party_([abc])(?:_(\d+))?$/);return t?{party:t[1],index:t[2]?parseInt(t[2],10):1}:(console.warn(`Unknown signature position format: ${e}, defaulting to party_a index 1`),{party:"a",index:1})}function r(e){return e.startsWith("party_a")}function n(e){return e.startsWith("party_b")}function a(e,r=1,n="nda"){let{party:o,index:s}=t(e);if("subscription"===n)throw Error("SIGNATURE_ERROR: Subscription documents use pre-calculated signature_placements. This function should not be called for subscription documents.");return"b"===o?{xPercent:.704,yFromBottom:433}:1===r?{xPercent:.292,yFromBottom:433}:{xPercent:.292,yFromBottom:520+(r-2)*50-(s-1)*100}}function o(e,t){return 1===t?`party_${e}`:`party_${e}_${t}`}function s(e){let t=[];for(let r=1;r<=e;r++)t.push(o("a",r));return t}e.s(["calculateSignaturePosition",()=>a,"getPartyAPositions",()=>s,"getSignaturePositionString",()=>o,"isPartyA",()=>r,"isPartyB",()=>n,"parseSignaturePosition",()=>t])},522734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},40697,e=>{e.v("/server/assets/pdf.worker.6654537e.mjs")},411164,e=>{"use strict";var t=e.i(522734),r=e.i(792509),n=e.i(430586);async function a(n){let a=await e.A(908258),o=[process.env.PDFJS_WORKER_SRC,new URL(e.R(40697)).toString(),new URL(e.R(40697)).toString()].filter(Boolean),s=o.find(e=>{try{let n=e.startsWith("file:")?(0,r.fileURLToPath)(e):e;return(0,t.existsSync)(n)}catch{return!1}})||o[0];a.GlobalWorkerOptions.workerSrc=s;let i=[];try{let e=a.getDocument({data:n,useSystemFonts:!0,disableFontFace:!0}),t=await e.promise;console.log(`üîç [ANCHOR] Scanning ${t.numPages} pages for SIG_ANCHOR markers...`);for(let e=1;e<=t.numPages;e++){let r=await t.getPage(e),n=await r.getTextContent(),a=r.getViewport({scale:1});for(let t of n.items){if(!("str"in t))continue;let r=t.str,n=r.includes("SIG_ANCHOR:"),o=r.includes("SIG ANCHOR:");if(!n&&!o)continue;let s=null;if(n){let e=r.match(/SIG_ANCHOR:(\S+)/);e&&(s=e[1])}else if(o){let e=r.match(/SIG ANCHOR:([a-z0-9_ ]+)/i);e&&(s=e[1].trim().replace(/ /g,"_"),console.log(`   üîß Normalized space-corrupted anchor: "${e[1]}" -> "${s}"`))}if(!s)continue;let c=t.transform[4],u=t.transform[5];i.push({anchorId:s,pageNumber:e,rawX:c,rawY:u,xPercent:c/a.width,yFromBottom:u,pageWidth:a.width,pageHeight:a.height}),console.log(`   üìç Found ${s} on page ${e} at (${c.toFixed(1)}, ${u.toFixed(1)}) - ${(c/a.width*100).toFixed(1)}% from left`)}}}catch(e){throw console.error("‚ùå [ANCHOR] PDF parsing error:",e),e}return console.log(`‚úÖ [ANCHOR] Found ${i.length} anchor(s) total`),i}function o(e,t){let r=new Set(e.map(e=>e.anchorId)),n=t.filter(e=>!r.has(e));if(n.length>0){let e=Array.from(r).join(", ")||"(none)";throw Error(`MISSING_ANCHORS: ${n.join(", ")}. Found: ${e}`)}}function s(e,t,r="subscription"){let a=function(e,t="subscription"){return"introducer_agreement"===t?[{anchorId:e,label:"introducer_agreement"}]:e.startsWith("party_a")?[{anchorId:`${e}_form`,label:"subscription_form"},{anchorId:e,label:"main_agreement"}]:"party_b"===e?[{anchorId:"party_b_form",label:"subscription_form"},{anchorId:"party_b_wire",label:"wire_instructions"},{anchorId:"party_b",label:"main_agreement"},{anchorId:"party_b_tcs",label:"tcs"}]:"party_c"===e?[{anchorId:"party_c",label:"main_agreement"},{anchorId:"party_c_tcs",label:"tcs"}]:(console.warn(`‚ö†Ô∏è [ANCHOR] Unknown position: ${e}`),[])}(t,r),o=[];for(let s of(console.log(`üìç [PLACEMENT] Calculating placements for ${t} (${r}, anchor-based Y)...`),a)){let a=e.find(e=>e.anchorId===s.anchorId);if(a){let e="introducer_agreement"===r?a.xPercent:function(e,t,r="subscription"){return e.startsWith("party_a")?"subscription_form"===t?.63:.29:"party_b"===e?"tcs"===t?.43:"main_agreement"===t?.29:"subscription_form"===t?.2:.25:"party_c"===e&&"tcs"===t?.43:.29}(t,s.label,r),i=function(e,t,r="subscription"){let{metadata:a}=n.SIGNATURE_CONFIG.pdf,o="wire_instructions"===t?14:a.signerNameOffsetY;return e.rawY+o+4}(a,s.label,r);console.log(`   üîç [ANCHOR] ${s.anchorId} on page ${a.pageNumber}`),console.log(`      Anchor position (for reference): (${a.rawX.toFixed(0)}pt, ${a.rawY.toFixed(0)}pt)`),console.log(`   üìç [PLACEMENT] ${t} -> page ${a.pageNumber}`),console.log(`      FIXED X: ${(100*e).toFixed(0)}% | ANCHOR Y: ${i.toFixed(0)}pt (${s.label})`),o.push({page:a.pageNumber,x:e,y:i,label:s.label}),console.log(`   ‚úì ${s.anchorId} -> page ${a.pageNumber}, x=${(100*e).toFixed(0)}%, y=${i.toFixed(0)}pt (${s.label})`)}else console.warn(`   ‚ö†Ô∏è Anchor not found: ${s.anchorId} (expected for ${t})`)}return console.log(`‚úÖ [PLACEMENT] Created ${o.length} placement(s) for ${t}`),o}function i(e){let t=["party_a"];for(let r=1;r<=e;r++){let e=1===r?"party_b":`party_b_${r}`;t.push(e)}return t}e.s(["detectAnchors",()=>a,"getPlacementsFromAnchors",()=>s,"getRequiredAnchorsForIntroducerAgreement",()=>i,"validateRequiredAnchors",()=>o])},28885,e=>{"use strict";var t=e.i(430586);class r{supabase;constructor(e){this.supabase=e}async uploadUnsignedPDF(e,r,n,a){let o=t.SIGNATURE_CONFIG.storage.paths.unsigned(e,r),{data:s,error:i}=await this.supabase.storage.from(t.SIGNATURE_CONFIG.storage.bucket).upload(o,n,{contentType:"application/pdf",metadata:a});if(i)throw Error(`Failed to upload unsigned PDF: ${i.message}`);return s.path}async uploadSignedPDF(e,r,n,a){let o=t.SIGNATURE_CONFIG.storage.paths.signed(e,r),{data:s,error:i}=await this.supabase.storage.from(t.SIGNATURE_CONFIG.storage.bucket).upload(o,n,{contentType:"application/pdf",metadata:a});if(i)throw Error(`Failed to upload signed PDF: ${i.message}`);return s.path}async downloadPDF(e){let r=e.startsWith("subscriptions/")||e.startsWith("introducer-agreements/")||e.startsWith("placement-agreements/")?"deal-documents":t.SIGNATURE_CONFIG.storage.bucket,{data:n,error:a}=await this.supabase.storage.from(r).download(e);if(a)throw Error(`Failed to download PDF: ${a.message}`);return new Uint8Array(await n.arrayBuffer())}async getSignedUrl(e,r=3600){let n=e.startsWith("subscriptions/")||e.startsWith("introducer-agreements/")||e.startsWith("placement-agreements/")?"deal-documents":t.SIGNATURE_CONFIG.storage.bucket,{data:a,error:o}=await this.supabase.storage.from(n).createSignedUrl(e,r);if(o)throw Error(`Failed to create signed URL: ${o.message}`);return a.signedUrl}}async function n(e){let t=await fetch(e);if(!t.ok)throw Error(`Failed to download PDF: ${t.statusText}`);return new Uint8Array(await t.arrayBuffer())}e.s(["SignatureStorageManager",()=>r,"downloadPDFFromUrl",()=>n])}];

//# sourceMappingURL=%5Broot-of-the-server%5D__c0ef2667._.js.map