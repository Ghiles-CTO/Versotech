{"version":3,"sources":["../../../../versotech-portal/src/lib/supabase/server.ts","../../../../versotech-portal/src/lib/audit.ts","../../../../versotech-portal/src/lib/api-auth.ts","../../../../versotech-portal/src/lib/fees/subscription-fee-calculator.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n","import { createClient } from './supabase/server'\r\n\r\nexport interface AuditLogEntry {\r\n  actor_user_id?: string\r\n  action: string\r\n  entity: string\r\n  entity_id?: string\r\n  metadata?: Record<string, any>\r\n}\r\n\r\nclass AuditLogger {\r\n  private static instance: AuditLogger\r\n\r\n  static getInstance(): AuditLogger {\r\n    if (!AuditLogger.instance) {\r\n      AuditLogger.instance = new AuditLogger()\r\n    }\r\n    return AuditLogger.instance\r\n  }\r\n\r\n  async log(entry: AuditLogEntry): Promise<void> {\r\n    try {\r\n      const supabase = await createClient()\r\n\r\n      // Insert into audit_logs with correct column names\r\n      await supabase.from('audit_logs').insert({\r\n        event_type: 'system',\r\n        actor_id: entry.actor_user_id || null,\r\n        action: entry.action,\r\n        entity_type: entry.entity,\r\n        entity_id: entry.entity_id || null,\r\n        action_details: entry.metadata || null,\r\n        timestamp: new Date().toISOString()\r\n      })\r\n\r\n    } catch (error) {\r\n      console.error('Audit logging failed:', error)\r\n      // Don't throw to avoid breaking the main operation\r\n    }\r\n  }\r\n\r\n  async logMany(entries: AuditLogEntry[]): Promise<void> {\r\n    for (const entry of entries) {\r\n      await this.log(entry)\r\n    }\r\n  }\r\n}\r\n\r\nexport const auditLogger = AuditLogger.getInstance()\r\n\r\n// Common audit actions as constants\r\nexport const AuditActions = {\r\n  // Authentication\r\n  LOGIN: 'login',\r\n  LOGOUT: 'logout',\r\n  PASSWORD_CHANGE: 'password_change',\r\n\r\n  // Data operations\r\n  CREATE: 'create',\r\n  READ: 'read', \r\n  UPDATE: 'update',\r\n  DELETE: 'delete',\r\n\r\n  // Documents\r\n  DOCUMENT_UPLOAD: 'document_upload',\r\n  DOCUMENT_DOWNLOAD: 'document_download',\r\n  DOCUMENT_DELETE: 'document_delete',\r\n\r\n  // Workflows\r\n  WORKFLOW_TRIGGER: 'workflow_trigger',\r\n  WORKFLOW_COMPLETED: 'workflow_completed',\r\n  WORKFLOW_FAILED: 'workflow_failed',\r\n\r\n  // System operations\r\n  USER_CREATED: 'user_created',\r\n  PROFILE_UPDATED: 'profile_updated',\r\n  ROLE_CHANGED: 'role_changed',\r\n\r\n  // Business operations\r\n  SUBSCRIPTION_CREATED: 'subscription_created',\r\n  CAPITAL_CALL_CREATED: 'capital_call_created',\r\n  DISTRIBUTION_CREATED: 'distribution_created',\r\n  REPORT_REQUESTED: 'report_requested',\r\n  MESSAGE_SENT: 'message_sent',\r\n\r\n  // Commission lifecycle (GAP-7)\r\n  COMMISSION_CREATED: 'commission_created',\r\n  COMMISSION_ACCRUED: 'commission_accrued',\r\n  COMMISSION_INVOICE_REQUESTED: 'commission_invoice_requested',\r\n  COMMISSION_INVOICED: 'commission_invoiced',\r\n  COMMISSION_PAID: 'commission_paid',\r\n  COMMISSION_CANCELLED: 'commission_cancelled',\r\n\r\n  // Agreement events (GAP-8)\r\n  AGREEMENT_CREATED: 'agreement_created',\r\n  AGREEMENT_SENT: 'agreement_sent',\r\n  AGREEMENT_APPROVED: 'agreement_approved',\r\n  AGREEMENT_SIGNED: 'agreement_signed',\r\n  AGREEMENT_ACTIVATED: 'agreement_activated',\r\n  AGREEMENT_REJECTED: 'agreement_rejected',\r\n  AGREEMENT_EXPIRED: 'agreement_expired'\r\n} as const\r\n\r\n// Entity types\r\nexport const AuditEntities = {\r\n  USERS: 'users',\r\n  PROFILES: 'profiles',\r\n  INVESTORS: 'investors',\r\n  VEHICLES: 'vehicles',\r\n  SUBSCRIPTIONS: 'subscriptions',\r\n  POSITIONS: 'positions',\r\n  DOCUMENTS: 'documents',\r\n  WORKFLOWS: 'workflows',\r\n  WORKFLOW_RUNS: 'workflow_runs',\r\n  CONVERSATIONS: 'conversations',\r\n  MESSAGES: 'messages',\r\n  REQUEST_TICKETS: 'request_tickets',\r\n  CAPITAL_CALLS: 'capital_calls',\r\n  DISTRIBUTIONS: 'distributions',\r\n  DEALS: 'deals',\r\n  // RESERVATIONS: 'reservations', // Deprecated - removed from workflow\r\n  ALLOCATIONS: 'allocations',\r\n  FEE_EVENTS: 'fee_events',\r\n  INVOICES: 'invoices',\r\n  BANK_TRANSACTIONS: 'bank_transactions',\r\n  PAYMENTS: 'payments',\r\n  ARRANGER: 'arranger_entities',\r\n  INTRODUCER: 'introducers',\r\n  PARTNER: 'partners',\r\n  COMMERCIAL_PARTNER: 'commercial_partners',\r\n  FEE_PLANS: 'arranger_fee_plans',\r\n  CEO_ENTITY: 'ceo_entity',\r\n  CEO_USERS: 'ceo_users',\r\n  // Commission entities (GAP-7)\r\n  INTRODUCER_COMMISSIONS: 'introducer_commissions',\r\n  PARTNER_COMMISSIONS: 'partner_commissions',\r\n  COMMERCIAL_PARTNER_COMMISSIONS: 'commercial_partner_commissions',\r\n  // Agreement entities (GAP-8)\r\n  INTRODUCER_AGREEMENTS: 'introducer_agreements',\r\n  PARTNER_AGREEMENTS: 'partner_agreements',\r\n  COMMERCIAL_PARTNER_AGREEMENTS: 'commercial_partner_agreements',\r\n  // Introductions\r\n  INTRODUCTIONS: 'introductions',\r\n} as const\r\n\r\n","/**\r\n * Helper to get authenticated user from Supabase auth\r\n * Works with both createClient() and createServiceClient()\r\n */\r\nexport async function getAuthenticatedUser(supabase: any) {\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n\r\n  return {\r\n    user,\r\n    error: authError\r\n  }\r\n}\r\n\r\n/**\r\n * Get user role from database profile\r\n */\r\nexport async function getUserRole(supabase: any, user: any): Promise<string | null> {\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  return profile?.role || null\r\n}\r\n\r\n/**\r\n * Check if user has a specific permission OR is CEO (CEO bypasses all permission checks)\r\n *\r\n * This centralizes permission checking so that:\r\n * 1. CEO users automatically have ALL permissions without needing staff_permissions entries\r\n * 2. Regular staff users need explicit permissions in staff_permissions table\r\n *\r\n * @param supabase - Supabase client (can be regular or service client)\r\n * @param userId - The user's ID\r\n * @param requiredPermissions - Array of permissions (user needs ANY of these, not all)\r\n * @returns true if user has permission or is CEO\r\n */\r\nexport async function hasPermission(\r\n  supabase: any,\r\n  userId: string,\r\n  requiredPermissions: string[]\r\n): Promise<boolean> {\r\n  // First, check if user is CEO - CEO bypasses all permission checks\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', userId)\r\n    .single()\r\n\r\n  if (profile?.role === 'ceo') {\r\n    return true // CEO has all permissions\r\n  }\r\n\r\n  // Also check if user has CEO persona (for multi_persona users)\r\n  const { data: ceoUser } = await supabase\r\n    .from('ceo_users')\r\n    .select('user_id')\r\n    .eq('user_id', userId)\r\n    .maybeSingle()\r\n\r\n  if (ceoUser) {\r\n    return true // User is in ceo_users table, has all permissions\r\n  }\r\n\r\n  // For non-CEO users, check staff_permissions table\r\n  const { data: permission } = await supabase\r\n    .from('staff_permissions')\r\n    .select('permission')\r\n    .eq('user_id', userId)\r\n    .in('permission', requiredPermissions)\r\n    .limit(1)\r\n    .maybeSingle()\r\n\r\n  return !!permission\r\n}\r\n\r\n/**\r\n * Check if user has super_admin permission OR is CEO\r\n * Convenience function for the most common permission check\r\n */\r\nexport async function isSuperAdmin(supabase: any, userId: string): Promise<boolean> {\r\n  return hasPermission(supabase, userId, ['super_admin'])\r\n}\r\n\r\n/**\r\n * Check if user is staff using both profile role AND persona system\r\n *\r\n * Users can have staff access through:\r\n * 1. Legacy role field: 'staff_*' or 'ceo' in profiles.role\r\n * 2. Persona system: staff or ceo persona via get_user_personas RPC\r\n */\r\nexport async function isStaffUser(supabase: any, user: any): Promise<boolean> {\r\n  // First check legacy role field\r\n  const role = await getUserRole(supabase, user)\r\n  if (role && (role.startsWith('staff_') || role === 'ceo')) {\r\n    return true\r\n  }\r\n\r\n  // For multi_persona users, check personas via RPC\r\n  if (role === 'multi_persona') {\r\n    try {\r\n      const { data: personas } = await supabase.rpc('get_user_personas', {\r\n        p_user_id: user.id\r\n      })\r\n\r\n      if (personas && Array.isArray(personas)) {\r\n        return personas.some(\r\n          (p: any) => p.persona_type === 'staff' || p.persona_type === 'ceo'\r\n        )\r\n      }\r\n    } catch (err) {\r\n      console.error('[isStaffUser] Error checking personas:', err)\r\n    }\r\n  }\r\n\r\n  return false\r\n}\r\n","/**\r\n * Subscription Fee Calculator\r\n * Calculates fee events from subscription data\r\n *\r\n * Source of Truth: Subscription table (amounts)\r\n * Frequency Source: Fee plan (if linked)\r\n */\r\n\r\nimport { SupabaseClient } from '@supabase/supabase-js';\r\n\r\ninterface SubscriptionFees {\r\n  subscription_fee_percent?: number | null;\r\n  subscription_fee_amount?: number | null;\r\n  spread_fee_amount?: number | null;\r\n  bd_fee_percent?: number | null;\r\n  bd_fee_amount?: number | null;\r\n  finra_fee_amount?: number | null;\r\n  management_fee_percent?: number | null;\r\n  management_fee_amount?: number | null;\r\n  management_fee_frequency?: string | null;\r\n  performance_fee_tier1_percent?: number | null;\r\n  performance_fee_tier1_threshold?: number | null;\r\n  performance_fee_tier2_percent?: number | null;\r\n  performance_fee_tier2_threshold?: number | null;\r\n}\r\n\r\ninterface FeeEvent {\r\n  fee_type: 'subscription' | 'management' | 'performance' | 'spread_markup' | 'bd_fee' | 'finra_fee' | 'flat' | 'other';\r\n  base_amount: number;\r\n  computed_amount: number;\r\n  rate_bps?: number | null;\r\n  frequency: 'one_time' | 'quarterly' | 'annual' | 'monthly' | 'on_exit';\r\n  payment_schedule: 'upfront' | 'recurring' | 'on_demand';\r\n  description: string;\r\n}\r\n\r\n/**\r\n * Calculate fee events for a subscription\r\n * @param supabase - Supabase client\r\n * @param subscriptionId - Subscription ID\r\n * @returns Array of fee events to be created\r\n */\r\nexport async function calculateSubscriptionFeeEvents(\r\n  supabase: SupabaseClient,\r\n  subscriptionId: string\r\n): Promise<{ success: boolean; feeEvents?: FeeEvent[]; error?: string }> {\r\n  try {\r\n    // Fetch subscription with fee plan and vehicle\r\n    const { data: subscription, error: subError } = await supabase\r\n      .from('subscriptions')\r\n      .select(`\r\n        *,\r\n        vehicle:vehicles (\r\n          id,\r\n          name\r\n        ),\r\n        fee_plan:fee_plans (\r\n          id,\r\n          components:fee_components (\r\n            kind,\r\n            frequency,\r\n            payment_schedule\r\n          )\r\n        )\r\n      `)\r\n      .eq('id', subscriptionId)\r\n      .single();\r\n\r\n    if (subError || !subscription) {\r\n      return { success: false, error: subError?.message || 'Subscription not found' };\r\n    }\r\n\r\n    const feeEvents: FeeEvent[] = [];\r\n    const fees = subscription as SubscriptionFees;\r\n    const feePlan = (subscription as any).fee_plan;\r\n\r\n    // Helper to get frequency/payment_schedule from fee plan\r\n    const getFrequencyInfo = (kind: string) => {\r\n      if (!feePlan || !feePlan.components) {\r\n        // No fee plan: default to one_time/upfront\r\n        return { frequency: 'one_time' as const, payment_schedule: 'upfront' as const };\r\n      }\r\n\r\n      const component = feePlan.components.find((c: any) => c.kind === kind);\r\n      return {\r\n        frequency: component?.frequency || 'one_time' as const,\r\n        payment_schedule: component?.payment_schedule || 'upfront' as const,\r\n      };\r\n    };\r\n\r\n    // 0. COMMITMENT AMOUNT (the investment itself)\r\n    // This is the primary payment - the investor's actual commitment to the vehicle\r\n    const commitmentAmount = subscription.commitment || 0;\r\n    if (commitmentAmount > 0) {\r\n      feeEvents.push({\r\n        fee_type: 'flat',\r\n        base_amount: commitmentAmount,\r\n        computed_amount: commitmentAmount,\r\n        rate_bps: null,\r\n        frequency: 'one_time',\r\n        payment_schedule: 'upfront',\r\n        description: `Investment commitment - ${(subscription as any).vehicle?.name || 'vehicle'}`,\r\n      });\r\n    }\r\n\r\n    // 1. Subscription Fee\r\n    // Note: Check for != null to properly handle explicit 0 values (0 means \"no fee\")\r\n    if (fees.subscription_fee_percent != null || fees.subscription_fee_amount != null) {\r\n      const baseAmount = subscription.commitment || 0;\r\n      const { frequency, payment_schedule } = getFrequencyInfo('subscription');\r\n\r\n      // Use explicit amount if provided (even if 0), otherwise calculate from percent\r\n      const computedAmount = fees.subscription_fee_amount != null\r\n        ? fees.subscription_fee_amount\r\n        : (baseAmount * (fees.subscription_fee_percent || 0) / 100);\r\n\r\n      feeEvents.push({\r\n        fee_type: 'subscription',\r\n        base_amount: baseAmount,\r\n        computed_amount: computedAmount,\r\n        rate_bps: fees.subscription_fee_percent ? Math.round(fees.subscription_fee_percent * 100) : null,\r\n        frequency,\r\n        payment_schedule,\r\n        description: `Subscription fee for ${subscription.commitment || 0} commitment`,\r\n      });\r\n    }\r\n\r\n    // 2. Management Fee\r\n    // Note: Check for != null to properly handle explicit 0 values (0 means \"no fee\")\r\n    if (fees.management_fee_percent != null || fees.management_fee_amount != null) {\r\n      const baseAmount = subscription.commitment || 0;\r\n      const { frequency, payment_schedule } = getFrequencyInfo('management');\r\n\r\n      // Use subscription's frequency if specified, otherwise use fee plan\r\n      const finalFrequency = fees.management_fee_frequency || frequency;\r\n\r\n      // Use explicit amount if provided (even if 0), otherwise calculate from percent\r\n      const computedAmount = fees.management_fee_amount != null\r\n        ? fees.management_fee_amount\r\n        : (baseAmount * (fees.management_fee_percent || 0) / 100);\r\n\r\n      feeEvents.push({\r\n        fee_type: 'management',\r\n        base_amount: baseAmount,\r\n        computed_amount: computedAmount,\r\n        rate_bps: fees.management_fee_percent ? Math.round(fees.management_fee_percent * 100) : null,\r\n        frequency: finalFrequency as any,\r\n        payment_schedule,\r\n        description: `Management fee for ${subscription.commitment || 0} commitment`,\r\n      });\r\n    }\r\n\r\n    // 3. BD Fee (Broker-Dealer)\r\n    // Note: Check for != null to properly handle explicit 0 values (0 means \"no fee\")\r\n    if (fees.bd_fee_percent != null || fees.bd_fee_amount != null) {\r\n      const baseAmount = subscription.commitment || 0;\r\n      const { frequency, payment_schedule } = getFrequencyInfo('bd_fee');\r\n\r\n      // Use explicit amount if provided (even if 0), otherwise calculate from percent\r\n      const computedAmount = fees.bd_fee_amount != null\r\n        ? fees.bd_fee_amount\r\n        : (baseAmount * (fees.bd_fee_percent || 0) / 100);\r\n\r\n      feeEvents.push({\r\n        fee_type: 'bd_fee',\r\n        base_amount: baseAmount,\r\n        computed_amount: computedAmount,\r\n        rate_bps: fees.bd_fee_percent ? Math.round(fees.bd_fee_percent * 100) : null,\r\n        frequency,\r\n        payment_schedule,\r\n        description: `Broker-dealer fee for ${subscription.commitment || 0} commitment`,\r\n      });\r\n    }\r\n\r\n    // 4. FINRA Fee\r\n    if (fees.finra_fee_amount) {\r\n      const { frequency, payment_schedule } = getFrequencyInfo('finra_fee');\r\n\r\n      feeEvents.push({\r\n        fee_type: 'finra_fee',\r\n        base_amount: fees.finra_fee_amount,\r\n        computed_amount: fees.finra_fee_amount,\r\n        rate_bps: null,\r\n        frequency,\r\n        payment_schedule,\r\n        description: 'FINRA regulatory fee',\r\n      });\r\n    }\r\n\r\n    // 5. Spread Fee\r\n    if (fees.spread_fee_amount) {\r\n      const { frequency, payment_schedule } = getFrequencyInfo('spread_markup');\r\n\r\n      feeEvents.push({\r\n        fee_type: 'spread_markup',\r\n        base_amount: fees.spread_fee_amount,\r\n        computed_amount: fees.spread_fee_amount,\r\n        rate_bps: null,\r\n        frequency,\r\n        payment_schedule,\r\n        description: 'Spread markup fee',\r\n      });\r\n    }\r\n\r\n    // 6. Performance Fee (Tier 1 and Tier 2)\r\n    if (fees.performance_fee_tier1_percent || fees.performance_fee_tier2_percent) {\r\n      const { frequency, payment_schedule } = getFrequencyInfo('performance');\r\n\r\n      // Calculate actual performance fee if NAV exists\r\n      const commitment = subscription.commitment || 0;\r\n      const nav = (subscription as any).current_nav || 0;\r\n      let performanceFee = 0;\r\n      const tier1Threshold = fees.performance_fee_tier1_threshold || 0;\r\n      const tier2Threshold = fees.performance_fee_tier2_threshold || 0;\r\n      const tier1Percent = fees.performance_fee_tier1_percent || 0;\r\n      const tier2Percent = fees.performance_fee_tier2_percent || 0;\r\n\r\n      // Calculate returns-based performance fee (same logic as overview page)\r\n      if (nav > 0 && commitment > 0) {\r\n        const returns = nav - commitment;\r\n        if (returns > 0) {\r\n          if (tier2Percent > 0 && returns > tier2Threshold) {\r\n            performanceFee = returns * (tier2Percent / 100);\r\n          } else if (tier1Percent > 0 && returns > tier1Threshold) {\r\n            performanceFee = returns * (tier1Percent / 100);\r\n          }\r\n        }\r\n      }\r\n\r\n      // Create description based on which tier applies\r\n      let description = 'Performance fee';\r\n      if (tier2Percent > 0 && tier2Threshold > 0) {\r\n        description = `Performance fee (Tier 2: ${tier2Percent}% above ${tier2Threshold} returns)`;\r\n      } else if (tier1Percent > 0) {\r\n        description = `Performance fee (Tier 1: ${tier1Percent}% above ${tier1Threshold || 0} returns)`;\r\n      }\r\n\r\n      feeEvents.push({\r\n        fee_type: 'performance',\r\n        base_amount: nav > 0 ? nav - commitment : 0,\r\n        computed_amount: performanceFee,\r\n        rate_bps: tier2Percent > 0 ? Math.round(tier2Percent * 100) : Math.round(tier1Percent * 100),\r\n        frequency,\r\n        payment_schedule,\r\n        description,\r\n      });\r\n    }\r\n\r\n    return { success: true, feeEvents };\r\n  } catch (error) {\r\n    console.error('Error calculating subscription fee events:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Unknown error',\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Create fee event records in database\r\n * @param supabase - Supabase client\r\n * @param subscriptionId - Subscription ID\r\n * @param feeEvents - Calculated fee events\r\n * @returns Created fee event IDs\r\n */\r\nexport async function createFeeEvents(\r\n  supabase: SupabaseClient,\r\n  subscriptionId: string,\r\n  investorId: string,\r\n  dealId: string | null,\r\n  feePlanId: string | null,\r\n  feeEvents: FeeEvent[],\r\n  options?: { skipDeduplication?: boolean }\r\n): Promise<{ success: boolean; feeEventIds?: string[]; error?: string; skipped?: boolean }> {\r\n  try {\r\n    // Deduplication check: Skip if fee events already exist for this subscription\r\n    // This prevents double-charging if createFeeEvents is called multiple times\r\n    if (!options?.skipDeduplication) {\r\n      const { data: existingEvents, error: checkError } = await supabase\r\n        .from('fee_events')\r\n        .select('id')\r\n        .eq('allocation_id', subscriptionId)\r\n        .limit(1);\r\n\r\n      if (checkError) {\r\n        console.warn('[FEE EVENTS] Error checking existing fee events:', checkError.message);\r\n        // Continue anyway - better to risk duplicates than fail silently\r\n      } else if (existingEvents && existingEvents.length > 0) {\r\n        console.log(`[FEE EVENTS] Fee events already exist for subscription ${subscriptionId}, skipping creation`);\r\n        return { success: true, feeEventIds: [], skipped: true };\r\n      }\r\n    }\r\n\r\n    // Fetch subscription to get currency\r\n    const { data: subscription } = await supabase\r\n      .from('subscriptions')\r\n      .select('currency')\r\n      .eq('id', subscriptionId)\r\n      .single();\r\n\r\n    const currency = subscription?.currency || 'USD';\r\n\r\n    // Determine payee_arranger_id - first check fee_plan, then deal\r\n    let payeeArrangerId: string | null = null;\r\n\r\n    // Check if fee_plan was created by an arranger\r\n    if (feePlanId) {\r\n      const { data: feePlan } = await supabase\r\n        .from('fee_plans')\r\n        .select('created_by_arranger_id')\r\n        .eq('id', feePlanId)\r\n        .single();\r\n\r\n      if (feePlan?.created_by_arranger_id) {\r\n        payeeArrangerId = feePlan.created_by_arranger_id;\r\n      }\r\n    }\r\n\r\n    // If no arranger from fee_plan, check deal\r\n    if (!payeeArrangerId && dealId) {\r\n      const { data: deal } = await supabase\r\n        .from('deals')\r\n        .select('arranger_entity_id')\r\n        .eq('id', dealId)\r\n        .single();\r\n\r\n      if (deal?.arranger_entity_id) {\r\n        payeeArrangerId = deal.arranger_entity_id;\r\n      }\r\n    }\r\n\r\n    // If we have a fee plan, fetch its components to link properly\r\n    const componentMap: Record<string, string> = {};\r\n    if (feePlanId) {\r\n      const { data: components } = await supabase\r\n        .from('fee_components')\r\n        .select('id, kind')\r\n        .eq('fee_plan_id', feePlanId);\r\n\r\n      if (components) {\r\n        // Map fee_type to component_id\r\n        components.forEach((comp: any) => {\r\n          componentMap[comp.kind] = comp.id;\r\n        });\r\n      }\r\n    }\r\n\r\n    const inserts = feeEvents.map((fe) => {\r\n      // Match fee_type to fee_component_id\r\n      // fee_type 'flat' (commitment) doesn't get a component_id\r\n      const feeComponentId = fe.fee_type === 'flat' ? null : componentMap[fe.fee_type] || null;\r\n\r\n      // Warn if fee type expected a component but none found\r\n      if (fe.fee_type !== 'flat' && !feeComponentId && feePlanId) {\r\n        console.warn(\r\n          `⚠️ [FEE EVENTS] No component found for fee_type '${fe.fee_type}' in fee plan ${feePlanId}. ` +\r\n          `Fee event will be created without component link.`\r\n        );\r\n      }\r\n\r\n      return {\r\n        investor_id: investorId,\r\n        deal_id: dealId,\r\n        allocation_id: subscriptionId, // Link to subscription\r\n        fee_component_id: feeComponentId, // NOW PROPERLY LINKED!\r\n        fee_type: fe.fee_type,\r\n        event_date: new Date().toISOString(),\r\n        base_amount: fe.base_amount,\r\n        computed_amount: fe.computed_amount,\r\n        rate_bps: fe.rate_bps,\r\n        currency: currency, // Use subscription currency\r\n        status: 'accrued', // Ready to be invoiced\r\n        notes: fe.description,\r\n        payee_arranger_id: payeeArrangerId, // Link to arranger for payment requests\r\n      };\r\n    });\r\n\r\n    const { data, error } = await supabase\r\n      .from('fee_events')\r\n      .insert(inserts)\r\n      .select('id');\r\n\r\n    if (error) {\r\n      return { success: false, error: error.message };\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      feeEventIds: data?.map((d) => d.id) || [],\r\n    };\r\n  } catch (error) {\r\n    console.error('Error creating fee events:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Unknown error',\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}