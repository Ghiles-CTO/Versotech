module.exports=[195619,e=>{"use strict";var t=e.i(779444),i=e.i(698261),r=e.i(821776),n=e.i(796417),a=e.i(856890),o=e.i(26996),s=e.i(436944),l=e.i(88281),d=e.i(765944),c=e.i(984788),u=e.i(237011),p=e.i(712007),m=e.i(777657),_=e.i(13180),v=e.i(273827),f=e.i(193695);e.i(947956);var y=e.i(36217),g=e.i(414131),h=e.i(433669),R=e.i(400589);let w={partner:{table:"partner_commissions",userTable:"partner_users",entityIdField:"partner_id",entityTable:"partners"},introducer:{table:"introducer_commissions",userTable:"introducer_users",entityIdField:"introducer_id",entityTable:"introducers"},"commercial-partner":{table:"commercial_partner_commissions",userTable:"commercial_partner_users",entityIdField:"commercial_partner_id",entityTable:"commercial_partners"}};async function x(e,{params:t}){try{let{type:e,id:i}=await t;if(!w[e])return g.NextResponse.json({error:`Invalid commission type: ${e}`},{status:400});let r=await (0,h.createClient)(),n=(0,h.createServiceClient)(),{data:{user:a}}=await r.auth.getUser();if(!a)return g.NextResponse.json({error:"Unauthorized"},{status:401});let o=w[e],{data:s,error:l}=await n.from(o.table).select("id, invoice_id, arranger_id, "+o.entityIdField).eq("id",i).single();if(l||!s)return g.NextResponse.json({error:"Commission not found"},{status:404});if(!s.invoice_id)return g.NextResponse.json({error:"No invoice uploaded for this commission"},{status:404});let[d,c]=await Promise.all([n.from("arranger_users").select("arranger_id").eq("user_id",a.id).eq("arranger_id",s.arranger_id).maybeSingle(),n.from(o.userTable).select(o.entityIdField.replace("_id","_id")).eq("user_id",a.id).eq(o.entityIdField.replace("_id","_id"),s[o.entityIdField]).maybeSingle()]),u=!!d.data,p=!!c.data;if(!u&&!p)return g.NextResponse.json({error:"Not authorized to view this invoice"},{status:403});let{data:m,error:_}=await n.storage.from("commission-invoices").createSignedUrl(s.invoice_id,3600);if(_)return console.error("[commission-invoice] Error generating signed URL:",_),g.NextResponse.json({error:"Failed to generate download URL"},{status:500});return g.NextResponse.json({data:{url:m.signedUrl,path:s.invoice_id,expires_in:3600}})}catch(e){return console.error("[commission-invoice] GET error:",e),g.NextResponse.json({error:"Internal server error"},{status:500})}}async function N(e,{params:t}){try{let{type:i,id:r}=await t;if(!w[i])return g.NextResponse.json({error:`Invalid commission type: ${i}`},{status:400});let n=await (0,h.createClient)(),a=(0,h.createServiceClient)(),{data:{user:o}}=await n.auth.getUser();if(!o)return g.NextResponse.json({error:"Unauthorized"},{status:401});let s=w[i],{data:l,error:d}=await a.from(s.table).select(`id, status, arranger_id, deal_id, investor_id, accrual_amount, currency, ${s.entityIdField}`).eq("id",r).single();if(d||!l)return g.NextResponse.json({error:"Commission not found"},{status:404});let{data:c,error:u}=await a.from(s.userTable).select("*").eq("user_id",o.id).eq(s.entityIdField.replace("_id","_id"),l[s.entityIdField]).maybeSingle();if(u||!c)return g.NextResponse.json({error:"Not authorized to upload invoice for this commission"},{status:403});if(!["invoice_requested","rejected"].includes(l.status))return g.NextResponse.json({error:`Cannot upload invoice for commission with status '${l.status}'. Status must be 'invoice_requested' or 'rejected'.`},{status:400});let p=(await e.formData()).get("file");if(!p)return g.NextResponse.json({error:"No file provided"},{status:400});if(!["application/pdf","image/png","image/jpeg"].includes(p.type))return g.NextResponse.json({error:`Invalid file type: ${p.type}. Allowed types: PDF, PNG, JPEG`},{status:400});if(p.size>0xa00000)return g.NextResponse.json({error:"File too large. Maximum size is 10MB."},{status:400});let m=p.name.split(".").pop()||"pdf",_=Date.now(),v=`invoice-${_}.${m}`,f=`${i}/${l.arranger_id}/${r}/${v}`,y=await p.arrayBuffer(),x=new Uint8Array(y),{data:N,error:b}=await a.storage.from("commission-invoices").upload(f,x,{contentType:p.type,upsert:!1});if(b)return console.error("[commission-invoice] Upload error:",b),g.NextResponse.json({error:"Failed to upload invoice"},{status:500});let{data:E,error:C}=await a.from(s.table).update({invoice_id:f,status:"invoice_submitted",rejection_reason:null,rejected_by:null,rejected_at:null,updated_at:new Date().toISOString()}).eq("id",r).select().single();if(C)return console.error("[commission-invoice] Update error:",C),await a.storage.from("commission-invoices").remove([f]),g.NextResponse.json({error:"Failed to update commission"},{status:500});let{data:I}=await a.from("arranger_users").select("user_id").eq("arranger_id",l.arranger_id),{data:S}=await a.from(s.entityTable).select("name, legal_name").eq("id",l[s.entityIdField]).single(),T=S?.name||S?.legal_name||"Entity";if(I&&I.length>0){let e=I.map(e=>({user_id:e.user_id,investor_id:null,title:"Invoice Received",message:`${T} has submitted their invoice for commission payment (approval required).`,link:"/versotech_main/payment-requests",type:"info"}));await a.from("investor_notifications").insert(e),console.log("[commission-invoice] Sent",e.length,"notifications to arranger users")}let q=await (0,R.getCeoSigner)(a);await a.from("approvals").update({status:"cancelled",resolved_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("entity_type","commission_invoice").eq("entity_id",r).eq("status","pending");let j=`Invoice submitted for ${T} (${i}) commission`,{error:A}=await a.from("approvals").insert({entity_type:"commission_invoice",entity_id:r,action:"approve",requested_by:o.id,assigned_to:q?.id||null,status:"pending",priority:"medium",request_reason:j,related_deal_id:l.deal_id||null,related_investor_id:l.investor_id||null,entity_metadata:{commission_type:i,commission_id:r,entity_id:l[s.entityIdField],entity_name:T,deal_id:l.deal_id||null,investor_id:l.investor_id||null,amount:l.accrual_amount,currency:l.currency,invoice_id:f}});return A&&console.error("[commission-invoice] Failed to create approval:",A),await a.from("audit_logs").insert({event_type:"commission",action:"invoice_uploaded",entity_type:s.table.replace("_commissions","_commission"),entity_id:r,actor_id:o.id,action_details:{description:"Invoice uploaded for commission",file_path:f,file_type:p.type,file_size:p.size,commission_type:i},timestamp:new Date().toISOString()}),g.NextResponse.json({success:!0,message:"Invoice uploaded successfully",data:{invoice_id:f,status:"invoice_submitted"}})}catch(e){return console.error("[commission-invoice] POST error:",e),g.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>x,"POST",()=>N],271170);var b=e.i(271170);let E=new t.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/commissions/[type]/[id]/invoice/route",pathname:"/api/commissions/[type]/[id]/invoice",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/commissions/[type]/[id]/invoice/route.ts",nextConfigOutput:"",userland:b}),{workAsyncStorage:C,workUnitAsyncStorage:I,serverHooks:S}=E;function T(){return(0,r.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:I})}async function q(e,t,r){E.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/commissions/[type]/[id]/invoice/route";g=g.replace(/\/index$/,"")||"/";let h=await E.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!h)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:w,nextConfig:x,parsedUrl:N,isDraftMode:b,prerenderManifest:C,routerServerContext:I,isOnDemandRevalidate:S,revalidateOnlyGenerated:T,resolvedPathname:q,clientReferenceManifest:j,serverActionsManifest:A}=h,P=(0,s.normalizeAppPath)(g),O=!!(C.dynamicRoutes[P]||C.routes[q]),U=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,N,!1):t.end("This page could not be found"),null);if(O&&!b){let e=!!C.routes[q],t=C.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await U();throw new f.NoFallbackError}}let F=null;!O||E.isDev||b||(F="/index"===(F=q)?"/":F);let $=!0===E.isDev||!O,D=O&&!$;A&&j&&(0,o.setManifestsSingleton)({page:g,clientReferenceManifest:j,serverActionsManifest:A});let H=e.method||"GET",k=(0,a.getTracer)(),M=k.getActiveScopeSpan(),z={params:w,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,r,n)=>E.onRequestError(e,t,r,n,I)},sharedContext:{buildId:R}},K=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let o=async e=>E.handle(G,z).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=k.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=i.get("next.route");if(r){let t=`${H} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${g}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var a,l;let d=async({previousCacheEntry:i})=>{try{if(!s&&S&&T&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(n);e.fetchMetrics=z.renderOpts.fetchMetrics;let l=z.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let d=z.renderOpts.collectedTags;if(!O)return await (0,p.sendResponse)(K,B,a,z.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[v.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==z.renderOpts.collectedRevalidate&&!(z.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&z.renderOpts.collectedRevalidate,r=void 0===z.renderOpts.collectedExpire||z.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:z.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:r}}}}catch(t){throw(null==i?void 0:i.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:S})},!1,I),t}},c=await E.handleResponse({req:e,nextConfig:x,cacheKey:F,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:s});if(!O)return null;if((null==c||null==(a=c.value)?void 0:a.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",S?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&O||f.delete(v.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,_.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(K,B,new Response(c.value.body,{headers:f,status:c.value.status||200})),null};M?await l(M):await k.withPropagatedContext(e.headers,()=>k.trace(c.BaseServerSpan.handleRequest,{spanName:`${H} ${g}`,kind:a.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:S})},!1,I),O)throw t;return await (0,p.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>T,"routeModule",()=>E,"serverHooks",()=>S,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>I],195619)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_63cf86a7.js.map