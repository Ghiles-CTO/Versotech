module.exports=[540925,e=>{"use strict";var t=e.i(779444),r=e.i(698261),a=e.i(821776),n=e.i(796417),i=e.i(856890),l=e.i(26996),o=e.i(436944),d=e.i(88281),s=e.i(765944),m=e.i(984788),_=e.i(237011),u=e.i(712007),c=e.i(777657),p=e.i(13180),f=e.i(273827),y=e.i(193695);e.i(947956);var g=e.i(36217),w=e.i(433669),h=e.i(414131),b=e.i(221640);let v=["proof_of_address","signatory_proof_of_address","member_proof_of_address","utility_bill","bank_statement","tax_bill","council_tax","rental_agreement","mortgage_statement"];async function x(e){try{let t=await (0,w.createClient)(),{data:{user:r},error:a}=await t.auth.getUser();if(a||!r)return h.NextResponse.json({error:"Unauthorized"},{status:401});if(!await (0,b.isStaffUser)(t,r.id))return h.NextResponse.json({error:"Staff access required"},{status:403});let{searchParams:n}=new URL(e.url),i=parseInt(n.get("days")||"30",10),l="false"!==n.get("include_expired"),o="false"!==n.get("include_stale"),d=n.get("entity_type"),s=Math.min(parseInt(n.get("limit")||"100",10),500),m=(0,w.createServiceClient)(),_=new Date,u=_.toISOString().split("T")[0],c=E(i),p=E(-90),f=m.from("documents").select(`
        id,
        name,
        type,
        document_expiry_date,
        document_date,
        validation_status,
        owner_investor_id,
        arranger_entity_id,
        partner_id,
        introducer_id,
        lawyer_id,
        commercial_partner_id,
        investor_member_id,
        arranger_member_id,
        partner_member_id,
        introducer_member_id,
        lawyer_member_id,
        commercial_partner_member_id,
        created_at
      `).not("document_expiry_date","is",null).order("document_expiry_date",{ascending:!0}).limit(s);f=l?f.lte("document_expiry_date",c):f.gte("document_expiry_date",u).lte("document_expiry_date",c);let y=m.from("documents").select(`
        id,
        name,
        type,
        document_expiry_date,
        document_date,
        validation_status,
        owner_investor_id,
        arranger_entity_id,
        partner_id,
        introducer_id,
        lawyer_id,
        commercial_partner_id,
        investor_member_id,
        arranger_member_id,
        partner_member_id,
        introducer_member_id,
        lawyer_member_id,
        commercial_partner_member_id,
        created_at
      `).in("type",v).not("document_date","is",null).lt("document_date",p).order("document_date",{ascending:!0}).limit(s),[g,x]=await Promise.all([f,o?y:Promise.resolve({data:[],error:null})]);if(g.error)return console.error("Expiry documents query error:",g.error),h.NextResponse.json({error:"Failed to fetch documents"},{status:500});let C=await Promise.all((g.data||[]).map(async e=>{let t=await R(m,e),r=e.document_expiry_date?Math.floor((new Date(e.document_expiry_date).getTime()-_.getTime())/864e5):null,a=e.document_date?Math.floor((_.getTime()-new Date(e.document_date).getTime())/864e5):null;return{id:e.id,name:e.name,type:e.type,document_expiry_date:e.document_expiry_date,document_date:e.document_date,validation_status:e.validation_status,days_until_expiry:r,days_since_document_date:a,entity_type:t.type,entity_id:t.id,entity_name:t.name,member_id:t.memberId,member_name:t.memberName,is_stale:!1}})),T=await Promise.all((x.data||[]).map(async e=>{let t=await R(m,e),r=e.document_date?Math.floor((_.getTime()-new Date(e.document_date).getTime())/864e5):null;return{id:e.id,name:e.name,type:e.type,document_expiry_date:e.document_expiry_date,document_date:e.document_date,validation_status:e.validation_status,days_until_expiry:null,days_since_document_date:r,entity_type:t.type,entity_id:t.id,entity_name:t.name,member_id:t.memberId,member_name:t.memberName,is_stale:!0}})),I=d?C.filter(e=>e.entity_type===d):C,N=d?T.filter(e=>e.entity_type===d):T,A=I.filter(e=>(e.days_until_expiry??0)<0),P=I.filter(e=>(e.days_until_expiry??0)>=0),q=new Set(I.map(e=>e.id)),S=N.filter(e=>!q.has(e.id));return h.NextResponse.json({expired:A,expiring_soon:P,stale:S,summary:{total:I.length+S.length,expired_count:A.length,expiring_soon_count:P.length,stale_count:S.length,days_window:i}})}catch(e){return console.error("Expiring documents error:",e),h.NextResponse.json({error:"Internal server error"},{status:500})}}async function R(e,t){if(t.owner_investor_id){let{data:r}=await e.from("investors").select("legal_name").eq("id",t.owner_investor_id).single(),a=null;if(t.investor_member_id){let{data:r}=await e.from("investor_members").select("full_name, first_name, last_name").eq("id",t.investor_member_id).single();a=r?.full_name||`${r?.first_name||""} ${r?.last_name||""}`.trim()}return{type:"investor",id:t.owner_investor_id,name:r?.legal_name||"Unknown Investor",memberId:t.investor_member_id,memberName:a}}if(t.arranger_entity_id){let{data:r}=await e.from("arranger_entities").select("legal_name").eq("id",t.arranger_entity_id).single(),a=null;if(t.arranger_member_id){let{data:r}=await e.from("arranger_members").select("full_name, first_name, last_name").eq("id",t.arranger_member_id).single();a=r?.full_name||`${r?.first_name||""} ${r?.last_name||""}`.trim()}return{type:"arranger",id:t.arranger_entity_id,name:r?.legal_name||"Unknown Arranger",memberId:t.arranger_member_id,memberName:a}}if(t.partner_id){let{data:r}=await e.from("partners").select("name").eq("id",t.partner_id).single(),a=null;if(t.partner_member_id){let{data:r}=await e.from("partner_members").select("full_name, first_name, last_name").eq("id",t.partner_member_id).single();a=r?.full_name||`${r?.first_name||""} ${r?.last_name||""}`.trim()}return{type:"partner",id:t.partner_id,name:r?.name||"Unknown Partner",memberId:t.partner_member_id,memberName:a}}if(t.introducer_id){let{data:r}=await e.from("introducers").select("legal_name").eq("id",t.introducer_id).single(),a=null;if(t.introducer_member_id){let{data:r}=await e.from("introducer_members").select("full_name, first_name, last_name").eq("id",t.introducer_member_id).single();a=r?.full_name||`${r?.first_name||""} ${r?.last_name||""}`.trim()}return{type:"introducer",id:t.introducer_id,name:r?.legal_name||"Unknown Introducer",memberId:t.introducer_member_id,memberName:a}}if(t.lawyer_id){let{data:r}=await e.from("lawyers").select("firm_name").eq("id",t.lawyer_id).single(),a=null;if(t.lawyer_member_id){let{data:r}=await e.from("lawyer_members").select("full_name, first_name, last_name").eq("id",t.lawyer_member_id).single();a=r?.full_name||`${r?.first_name||""} ${r?.last_name||""}`.trim()}return{type:"lawyer",id:t.lawyer_id,name:r?.firm_name||"Unknown Lawyer",memberId:t.lawyer_member_id,memberName:a}}if(t.commercial_partner_id){let{data:r}=await e.from("commercial_partners").select("name").eq("id",t.commercial_partner_id).single(),a=null;if(t.commercial_partner_member_id){let{data:r}=await e.from("commercial_partner_members").select("full_name, first_name, last_name").eq("id",t.commercial_partner_member_id).single();a=r?.full_name||`${r?.first_name||""} ${r?.last_name||""}`.trim()}return{type:"commercial_partner",id:t.commercial_partner_id,name:r?.name||"Unknown Commercial Partner",memberId:t.commercial_partner_member_id,memberName:a}}return{type:"unknown",id:"",name:"Unknown Entity",memberId:null,memberName:null}}function E(e){let t=new Date;return t.setDate(t.getDate()+e),t.toISOString().split("T")[0]}e.s(["GET",()=>x],167746);var C=e.i(167746);let T=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/staff/compliance/expiring-documents/route",pathname:"/api/staff/compliance/expiring-documents",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/staff/compliance/expiring-documents/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:I,workUnitAsyncStorage:N,serverHooks:A}=T;function P(){return(0,a.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:N})}async function q(e,t,a){T.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/staff/compliance/expiring-documents/route";w=w.replace(/\/index$/,"")||"/";let h=await T.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!h)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:b,params:v,nextConfig:x,parsedUrl:R,isDraftMode:E,prerenderManifest:C,routerServerContext:I,isOnDemandRevalidate:N,revalidateOnlyGenerated:A,resolvedPathname:P,clientReferenceManifest:q,serverActionsManifest:S}=h,U=(0,o.normalizeAppPath)(w),O=!!(C.dynamicRoutes[U]||C.routes[P]),k=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,R,!1):t.end("This page could not be found"),null);if(O&&!E){let e=!!C.routes[P],t=C.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await k();throw new y.NoFallbackError}}let $=null;!O||T.isDev||E||($="/index"===($=P)?"/":$);let D=!0===T.isDev||!O,H=O&&!D;S&&q&&(0,l.setManifestsSingleton)({page:w,clientReferenceManifest:q,serverActionsManifest:S});let M=e.method||"GET",j=(0,i.getTracer)(),F=j.getActiveScopeSpan(),K={params:v,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>T.onRequestError(e,t,a,n,I)},sharedContext:{buildId:b}},L=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),G=s.NextRequestAdapter.fromNodeNextRequest(L,(0,s.signalFromNodeResponse)(t));try{let l=async e=>T.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${M} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${w}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),d=async n=>{var i,d;let s=async({previousCacheEntry:r})=>{try{if(!o&&N&&A&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await l(n);e.fetchMetrics=K.renderOpts.fetchMetrics;let d=K.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let s=K.renderOpts.collectedTags;if(!O)return await (0,u.sendResponse)(L,B,i,K.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,c.toNodeOutgoingHttpHeaders)(i.headers);s&&(t[f.NEXT_CACHE_TAGS_HEADER]=s),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,I),t}},m=await T.handleResponse({req:e,nextConfig:x,cacheKey:$,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:A,responseGenerator:s,waitUntil:a.waitUntil,isMinimalMode:o});if(!O)return null;if((null==m||null==(i=m.value)?void 0:i.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==m||null==(d=m.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",N?"REVALIDATED":m.isMiss?"MISS":m.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,c.fromNodeOutgoingHttpHeaders)(m.value.headers);return o&&O||y.delete(f.NEXT_CACHE_TAGS_HEADER),!m.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,p.getCacheControlHeader)(m.cacheControl)),await (0,u.sendResponse)(L,B,new Response(m.value.body,{headers:y,status:m.value.status||200})),null};F?await d(F):await j.withPropagatedContext(e.headers,()=>j.trace(m.BaseServerSpan.handleRequest,{spanName:`${M} ${w}`,kind:i.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},d))}catch(t){if(t instanceof y.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,I),O)throw t;return await (0,u.sendResponse)(L,B,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>P,"routeModule",()=>T,"serverHooks",()=>A,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>N],540925)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_645b7c66.js.map