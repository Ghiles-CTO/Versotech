module.exports=[554615,e=>{"use strict";var t=e.i(779444),r=e.i(698261),a=e.i(821776),i=e.i(796417),n=e.i(856890),s=e.i(26996),o=e.i(436944),l=e.i(88281),d=e.i(765944),c=e.i(984788),u=e.i(237011),p=e.i(712007),m=e.i(777657),_=e.i(13180),y=e.i(273827),g=e.i(193695);e.i(947956);var v=e.i(36217),f=e.i(414131),w=e.i(433669),h=e.i(107854),R=e.i(821275),x=e.i(898451);let b={investor:"investor_users",arranger:"arranger_users",lawyer:"lawyer_users",introducer:"introducer_users",partner:"partner_users",commercial_partner:"commercial_partner_users"},E={investor:"investors",arranger:"arranger_entities",lawyer:"lawyers",introducer:"introducers",partner:"partners",commercial_partner:"commercial_partners"},N={investor:"investor_id",arranger:"arranger_id",lawyer:"lawyer_id",introducer:"introducer_id",partner:"partner_id",commercial_partner:"commercial_partner_id"},C={investor:["admin","member","viewer"],arranger:["admin","member","viewer"],lawyer:["admin","member","viewer"],partner:["admin","member","viewer"],introducer:["admin","contact","payment_contact","legal_contact"],commercial_partner:["admin","contact","billing_contact","technical_contact"]},A={investor:"member",arranger:"member",lawyer:"member",partner:"member",introducer:"contact",commercial_partner:"contact"},S={investor:{select:"legal_name",primary:"legal_name"},arranger:{select:"legal_name",primary:"legal_name"},lawyer:{select:"firm_name, display_name",primary:"firm_name",fallback:"display_name"},introducer:{select:"legal_name",primary:"legal_name"},partner:{select:"legal_name, name",primary:"legal_name",fallback:"name"},commercial_partner:{select:"legal_name, name",primary:"legal_name",fallback:"name"}},I=h.z.object({entity_type:h.z.enum(["investor","arranger","lawyer","introducer","partner","commercial_partner"]),entity_id:h.z.string().uuid("Invalid entity ID"),email:h.z.string().email("Invalid email address"),display_name:h.z.string().min(2,"Display name must be at least 2 characters"),title:h.z.string().nullable().optional(),role:h.z.string().nullable().optional(),is_primary:h.z.boolean().default(!1),is_signatory:h.z.boolean().optional().default(!1),can_sign:h.z.boolean().optional().default(!1)});async function O(e){try{let t=await (0,w.createClient)(),{data:{user:r}}=await t.auth.getUser();if(!r)return f.NextResponse.json({error:"Unauthorized"},{status:401});let a=(0,w.createServiceClient)(),{data:i}=await a.from("staff_permissions").select("permission").eq("user_id",r.id).in("permission",["super_admin","manage_investors"]);if(!i||0===i.length)return f.NextResponse.json({error:"Insufficient permissions"},{status:403});let n=await e.json(),s=I.parse(n),{entity_type:o,entity_id:l,email:d,display_name:c,title:u,is_primary:p,is_signatory:m,can_sign:_}=s,y=s.role||A[o],g=C[o];if(!g.includes(y))return f.NextResponse.json({error:`Invalid role '${y}' for ${o}. Valid roles: ${g.join(", ")}`},{status:400});let v=E[o],{data:h,error:O}=await a.from(v).select("id").eq("id",l).single();if(O||!h)return f.NextResponse.json({error:`${o} entity not found`},{status:404});let{data:k}=await a.from("profiles").select("id").eq("email",d).single();if(k){let e=b[o],t=N[o],{data:i}=await a.from(e).select("user_id").eq("user_id",k.id).eq(t,l).single();if(i)return f.NextResponse.json({error:"User is already linked to this entity"},{status:400});let n={user_id:k.id,[t]:l,role:y,is_primary:p,created_at:new Date().toISOString()};"lawyer"===o&&(n.can_sign=_);let{error:s}=await a.from(e).insert(n);if(s)return console.error("Link creation error:",s),f.NextResponse.json({error:"Failed to link user to entity"},{status:500});return await a.from("audit_logs").insert({event_type:"authorization",actor_id:r.id,action:"entity_user_linked",entity_type:o,entity_id:l,action_details:{user_id:k.id,email:d,role:y,is_primary:p},timestamp:new Date().toISOString()}),f.NextResponse.json({success:!0,user_id:k.id,message:`Existing user linked to ${o.replace("_"," ")}`,is_new_user:!1})}let q=S[o],{data:T,error:P}=await a.from(v).select(q.select).eq("id",l).single();if(P||!T)return f.NextResponse.json({error:"Failed to get entity details"},{status:500});let j=T[q.primary]||(q.fallback?T[q.fallback]:null)||"Unknown Entity",{data:U}=await a.from("profiles").select("display_name, email").eq("id",r.id).single(),D=U?.display_name||U?.email||"A team member",{data:H}=await a.from("member_invitations").select("id, status").eq("entity_type",o).eq("entity_id",l).eq("email",d.toLowerCase()).eq("status","pending").maybeSingle();if(H)return f.NextResponse.json({error:"A pending invitation already exists for this email. Use resend to send again.",existing_invitation_id:H.id},{status:400});let{data:$,error:z}=await a.from("member_invitations").insert({entity_type:o,entity_id:l,entity_name:j,email:d.toLowerCase(),role:y,is_signatory:m||_,invited_by:r.id,invited_by_name:D,status:"pending",expires_at:new Date(Date.now()+6048e5).toISOString(),sent_at:new Date().toISOString(),reminder_count:0,last_reminded_at:null,metadata:{display_name:c}}).select().single();if(z||!$)return console.error("Invitation creation error:",z),f.NextResponse.json({error:"Failed to create invitation"},{status:500});let F=`${(0,R.getAppUrl)()}/invitation/accept?token=${$.invitation_token}`,M=await (0,x.sendInvitationEmail)({email:d,inviteeName:c,entityName:j,entityType:o,role:y,inviterName:D,acceptUrl:F,expiresAt:$.expires_at});if(!M.success){console.error("Failed to send invitation email:",M.error);try{await a.from("member_invitations").delete().eq("id",$.id)}catch(e){console.error("Failed to cleanup invitation after email failure:",e)}return f.NextResponse.json({error:"Invitation email failed to send. Please verify the email domain and try again."},{status:502})}return await a.from("audit_logs").insert({event_type:"authorization",actor_id:r.id,action:"entity_user_invited",entity_type:o,entity_id:l,action_details:{invitation_id:$.id,email:d,display_name:c,role:y,is_primary:p,is_signatory:m,email_sent:M.success},timestamp:new Date().toISOString()}),f.NextResponse.json({success:!0,invitation_id:$.id,message:`Invitation sent to ${d}`,is_new_user:!0,email_sent:!0,accept_url:F})}catch(e){if(console.error("Entity invite error:",e),e instanceof h.z.ZodError)return f.NextResponse.json({error:e.issues[0].message},{status:400});return f.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["POST",()=>O],451634);var k=e.i(451634);let q=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/admin/entity-invite/route",pathname:"/api/admin/entity-invite",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/admin/entity-invite/route.ts",nextConfigOutput:"",userland:k}),{workAsyncStorage:T,workUnitAsyncStorage:P,serverHooks:j}=q;function U(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:P})}async function D(e,t,a){q.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/admin/entity-invite/route";f=f.replace(/\/index$/,"")||"/";let w=await q.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:h,params:R,nextConfig:x,parsedUrl:b,isDraftMode:E,prerenderManifest:N,routerServerContext:C,isOnDemandRevalidate:A,revalidateOnlyGenerated:S,resolvedPathname:I,clientReferenceManifest:O,serverActionsManifest:k}=w,T=(0,o.normalizeAppPath)(f),P=!!(N.dynamicRoutes[T]||N.routes[I]),j=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,b,!1):t.end("This page could not be found"),null);if(P&&!E){let e=!!N.routes[I],t=N.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await j();throw new g.NoFallbackError}}let U=null;!P||q.isDev||E||(U="/index"===(U=I)?"/":U);let D=!0===q.isDev||!P,H=P&&!D;k&&O&&(0,s.setManifestsSingleton)({page:f,clientReferenceManifest:O,serverActionsManifest:k});let $=e.method||"GET",z=(0,n.getTracer)(),F=z.getActiveScopeSpan(),M={params:R,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>q.onRequestError(e,t,a,i,C)},sharedContext:{buildId:h}},K=new l.NodeNextRequest(e),L=new l.NodeNextResponse(t),B=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let s=async e=>q.handle(B,M).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=z.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${$} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${f}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var n,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&A&&S&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(i);e.fetchMetrics=M.renderOpts.fetchMetrics;let l=M.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=M.renderOpts.collectedTags;if(!P)return await (0,p.sendResponse)(K,L,n,M.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[y.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,a=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await q.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})},!1,C),t}},c=await q.handleResponse({req:e,nextConfig:x,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:S,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!P)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&P||g.delete(y.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,_.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(K,L,new Response(c.value.body,{headers:g,status:c.value.status||200})),null};F?await l(F):await z.withPropagatedContext(e.headers,()=>z.trace(c.BaseServerSpan.handleRequest,{spanName:`${$} ${f}`,kind:n.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await q.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})},!1,C),P)throw t;return await (0,p.sendResponse)(K,L,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>U,"routeModule",()=>q,"serverHooks",()=>j,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>P],554615)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_3110d6b3.js.map