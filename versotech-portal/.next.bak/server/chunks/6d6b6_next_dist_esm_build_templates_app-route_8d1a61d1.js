module.exports=[776854,e=>{"use strict";var t=e.i(779444),r=e.i(698261),a=e.i(821776),s=e.i(796417),i=e.i(856890),n=e.i(26996),o=e.i(436944),l=e.i(88281),c=e.i(765944),d=e.i(984788),u=e.i(237011),p=e.i(712007),h=e.i(777657),v=e.i(13180),g=e.i(273827),m=e.i(193695);e.i(947956);var _=e.i(36217),f=e.i(433669),y=e.i(221640),R=e.i(911357),w=e.i(414131),E=e.i(185325);async function T(e,t,r){if(!r.length)return;let a=r.map(e=>e.id),s=[];for(let e=0;e<a.length;e+=100)s.push(a.slice(e,e+100));let i=new Map;for(let a of(await Promise.all(s.map(async r=>{let{data:a,error:s}=await e.rpc("get_conversation_unread_counts",{p_user_id:t,p_conversation_ids:r});if(s)return void console.error("Error fetching unread counts:",s);for(let e of a||[])e?.conversation_id&&i.set(e.conversation_id,Number(e.unread_count)||0)})),r))a.unreadCount=i.get(a.id)??0}async function b(e){try{var t;let r,a,s,i,n,o,l,c,d,u=await (0,f.createClient)(),{user:p,error:h}=await (0,y.getAuthenticatedUser)(u);if(h||!p)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{filters:v,includeMessages:g,limit:m,offset:_}=(r=((t=new URL(e.url)).searchParams.get("visibility")||"all").toLowerCase(),a=(t.searchParams.get("type")||"all").toLowerCase(),s=t.searchParams.get("search")||"",i="true"===t.searchParams.get("unread"),n="false"!==t.searchParams.get("includeMessages"),o=Math.min(Math.max(parseInt(t.searchParams.get("limit")||"50",10)||50,1),100),l=Math.max(parseInt(t.searchParams.get("offset")||"0",10)||0,0),c=t.searchParams.get("dealId")||void 0,{filters:{visibility:["all","investor","internal","deal"].includes(r)?r:"all",type:["all","dm","group","deal_room","broadcast"].includes(a)?a:"all",search:s.trim().toLowerCase()||void 0,dealId:c,unreadOnly:i},unreadOnly:i,includeMessages:n,limit:o,offset:l}),R=Math.min(Math.max(4*m,100),500),b=await (0,y.isStaffUser)(u,p),C=(0,f.createServiceClient)(),P=(d=`
    id,
    subject,
    preview,
    type,
    visibility,
    owner_team,
    deal_id,
    created_by,
    created_at,
    updated_at,
    last_message_at,
    last_message_id,
    archived_at,
    metadata,
    conversation_participants (
      conversation_id,
      user_id,
      participant_role,
      joined_at,
      last_read_at,
      last_notified_at,
      is_muted,
      is_pinned,
      profiles:user_id (
        id,
        display_name,
        email,
        role,
        avatar_url
      )
    )
  `,g?`${d},
    messages (
      id,
      conversation_id,
      sender_id,
      body,
      message_type,
      file_key,
      reply_to_message_id,
      metadata,
      created_at,
      edited_at,
      deleted_at,
      sender:sender_id (
        id,
        display_name,
        email,
        role,
        avatar_url
      )
    )
  `:d),S=C.from("conversations").select(P).order("last_message_at",{ascending:!1,nullsFirst:!1}).limit(R);g&&(S=S.order("created_at",{foreignTable:"messages",ascending:!1}).limit(1,{foreignTable:"messages"}));let{data:A,error:O}=await S;if(O)return console.error("Error fetching conversations:",O),w.NextResponse.json({error:"Failed to fetch conversations"},{status:500});let x=(A||[]).filter(e=>{let t=(e.conversation_participants||[]).some(e=>e?.user_id===p.id);return(!!b||!!t)&&("all"===v.visibility||e.visibility===v.visibility)&&("all"===v.type||e.type===v.type)&&(!v.dealId||e.deal_id===v.dealId)}).map(e=>(0,E.normalizeConversation)(e));await T(C,p.id,x);let N=x;v.unreadOnly&&(N=N.filter(e=>e.unreadCount>0)),v.search&&(N=N.filter(e=>{let t=[];return e.subject&&t.push(e.subject),e.preview&&t.push(e.preview),e.ownerTeam&&t.push(e.ownerTeam),e.participants.forEach(e=>{e.displayName&&t.push(e.displayName),e.email&&t.push(e.email)}),e.latestMessage?.body&&t.push(e.latestMessage.body),t.some(e=>e.toLowerCase().includes(v.search))})),N.sort((e,t)=>{let r=e.lastMessageAt?new Date(e.lastMessageAt).getTime():new Date(e.createdAt).getTime();return(t.lastMessageAt?new Date(t.lastMessageAt).getTime():new Date(t.createdAt).getTime())-r});let I=N.length,M=N.slice(_,_+m);return w.NextResponse.json({conversations:M,pagination:{total:I,limit:m,offset:_,has_more:_+M.length<I},filters:{visibility:v.visibility,type:v.type,unread_only:v.unreadOnly||!1,search:v.search||null}})}catch(e){return console.error("Conversations API error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}async function C(e){console.log("[POST /api/conversations] ========== START ==========");try{console.log("[POST /api/conversations] Request received");let t=await (0,f.createClient)();console.log("[POST /api/conversations] Supabase client created");let{user:r,error:a}=await (0,y.getAuthenticatedUser)(t);if(console.log("[POST /api/conversations] getAuthenticatedUser result:",{user:r?.id,error:a?.message}),a||!r)return console.error("[POST /api/conversations] Auth error:",a),w.NextResponse.json({error:"Unauthorized",details:a?.message},{status:401});console.log("[POST /api/conversations] Authenticated user:",r.id);let s=r.id;r.user_metadata?.role;let i=await e.json();console.log("[POST /api/conversations] Request body:",i);let{subject:n,participant_ids:o,type:l="dm",initial_message:c,visibility:d}=i;if(!o||0===o.length)return w.NextResponse.json({error:"At least one participant is required"},{status:400});let u=[...new Set([s,...o])],p=d;p||(p="group"===l?"internal":"dm"===l||"broadcast"===l?"investor":"internal"),console.log("[POST /api/conversations] Creating conversation with:",{subject:n,created_by:s,type:l,visibility:p});let h=(0,f.createServiceClient)(),{data:v,error:g}=await h.from("conversations").insert({subject:n,created_by:s,type:l,visibility:p}).select().single();if(g)return console.error("[POST /api/conversations] Error creating conversation:",{error:g,message:g.message,details:g.details,hint:g.hint,code:g.code}),w.NextResponse.json({error:"Failed to create conversation",details:g.message||String(g),hint:g.hint||"Check RLS policies on conversations table",code:g.code},{status:500});console.log("[POST /api/conversations] Conversation created successfully:",v.id);let m=u.map(e=>({conversation_id:v.id,user_id:e}));console.log("[POST /api/conversations] Adding participants:",{count:u.length,participantIds:u,inserts:m});let{data:_,error:E}=await h.from("conversation_participants").insert(m).select();if(console.log("[POST /api/conversations] Participants result:",{success:!E,added:_?.length,error:E}),E)return console.error("[POST /api/conversations] Error adding participants:",E),w.NextResponse.json({error:"Failed to add participants",details:E.message||E,hint:"Check RLS policies on conversation_participants table"},{status:500});if(c){let{error:e}=await t.from("messages").insert({conversation_id:v.id,sender_id:s,body:c});e&&console.error("Error sending initial message:",e)}return await R.auditLogger.log({actor_user_id:s,action:R.AuditActions.CREATE,entity:R.AuditEntities.CONVERSATIONS,entity_id:v.id,metadata:{subject:n,type:l,participant_count:u.length,has_initial_message:!!c}}),w.NextResponse.json({success:!0,conversation:{id:v.id,subject:v.subject,type:v.type,visibility:v.visibility,participant_count:u.length}})}catch(t){console.error("[POST /api/conversations] ========== CAUGHT ERROR =========="),console.error("[POST /api/conversations] Error type:",typeof t),console.error("[POST /api/conversations] Error:",t),t instanceof Error&&(console.error("[POST /api/conversations] Error message:",t.message),console.error("[POST /api/conversations] Error stack:",t.stack));let e={error:"Internal server error",details:t instanceof Error?t.message:String(t),errorType:typeof t,timestamp:new Date().toISOString()};return console.error("[POST /api/conversations] Returning error response:",e),w.NextResponse.json(e,{status:500})}}e.s(["GET",()=>b,"POST",()=>C],218684);var P=e.i(218684);let S=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/conversations/route",pathname:"/api/conversations",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/conversations/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:A,workUnitAsyncStorage:O,serverHooks:x}=S;function N(){return(0,a.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:O})}async function I(e,t,a){S.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/conversations/route";f=f.replace(/\/index$/,"")||"/";let y=await S.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:w,nextConfig:E,parsedUrl:T,isDraftMode:b,prerenderManifest:C,routerServerContext:P,isOnDemandRevalidate:A,revalidateOnlyGenerated:O,resolvedPathname:x,clientReferenceManifest:N,serverActionsManifest:I}=y,M=(0,o.normalizeAppPath)(f),j=!!(C.dynamicRoutes[M]||C.routes[x]),U=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,T,!1):t.end("This page could not be found"),null);if(j&&!b){let e=!!C.routes[x],t=C.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await U();throw new m.NoFallbackError}}let k=null;!j||S.isDev||b||(k="/index"===(k=x)?"/":k);let D=!0===S.isDev||!j,H=j&&!D;I&&N&&(0,n.setManifestsSingleton)({page:f,clientReferenceManifest:N,serverActionsManifest:I});let q=e.method||"GET",L=(0,i.getTracer)(),F=L.getActiveScopeSpan(),$={params:w,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,s)=>S.onRequestError(e,t,a,s,P)},sharedContext:{buildId:R}},K=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),G=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let n=async e=>S.handle(G,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${f}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var i,l;let c=async({previousCacheEntry:r})=>{try{if(!o&&A&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(s);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=$.renderOpts.collectedTags;if(!j)return await (0,p.sendResponse)(K,B,i,$.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,a=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:_.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})},!1,P),t}},d=await S.handleResponse({req:e,nextConfig:E,cacheKey:k,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:O,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:o});if(!j)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==_.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&j||m.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,v.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(K,B,new Response(d.value.body,{headers:m,status:d.value.status||200})),null};F?await l(F):await L.withPropagatedContext(e.headers,()=>L.trace(d.BaseServerSpan.handleRequest,{spanName:`${q} ${f}`,kind:i.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})},!1,P),j)throw t;return await (0,p.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>N,"routeModule",()=>S,"serverHooks",()=>x,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>O],776854)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_8d1a61d1.js.map