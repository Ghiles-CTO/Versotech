{"version":3,"sources":["../../../../versotech-portal/src/app/api/approvals/%5Bid%5D/action/route.ts","../../../../versotech-portal/node_modules/next/dist/esm/build/templates/app-route.js","../../../../versotech-portal/src/lib/subscription/certificate-trigger.ts","../../../../versotech-portal/src/lib/deals/deal-close-handler.ts"],"sourcesContent":["import { createClient, createServiceClient } from '@/lib/supabase/server'\r\nimport { requireStaffAuth } from '@/lib/auth'\r\nimport { auditLogger, AuditActions } from '@/lib/audit'\r\nimport { NextResponse } from 'next/server'\r\nimport { triggerWorkflow } from '@/lib/trigger-workflow'\r\nimport { createSignatureRequest } from '@/lib/signature/client'\r\nimport { getCeoSigner } from '@/lib/staff/ceo-signer'\r\nimport { sendInvitationEmail } from '@/lib/email/resend-service'\r\nimport { getAppUrl } from '@/lib/signature/token'\r\nimport { handleDealClose, handleTermsheetClose } from '@/lib/deals/deal-close-handler'\r\n\r\n/**\r\n * Generate subscription pack filename with standardized format:\r\n * {ENTITY_CODE} - SUBSCRIPTION PACK - {INVESTMENT_NAME} - {INVESTOR_NAME} - {DDMMYY}.docx\r\n *\r\n * Example: \"VC206 - SUBSCRIPTION PACK - OPEN AI - Ghiless Business Ventures LLC - 121125.docx\"\r\n */\r\nfunction generateSubscriptionPackFilename(\r\n  entityCode: string,\r\n  investmentName: string,\r\n  investorName: string,\r\n  submittedAt: string | Date\r\n): string {\r\n  // Format date as DDMMYY\r\n  const date = new Date(submittedAt)\r\n  const day = date.getUTCDate().toString().padStart(2, '0')\r\n  const month = (date.getUTCMonth() + 1).toString().padStart(2, '0')\r\n  const year = date.getUTCFullYear().toString().slice(-2)\r\n  const formattedDate = `${day}${month}${year}`\r\n\r\n  // Clean up names (remove special chars, collapse multiple spaces)\r\n  const cleanEntityCode = entityCode.trim()\r\n  const cleanInvestmentName = investmentName.trim().replace(/\\s+/g, ' ')\r\n  const cleanInvestorName = investorName.trim().replace(/\\s+/g, ' ')\r\n\r\n  return `${cleanEntityCode} - SUBSCRIPTION PACK - ${cleanInvestmentName} - ${cleanInvestorName} - ${formattedDate}`\r\n}\r\n\r\n/**\r\n * Determine file extension from mime type\r\n */\r\nfunction getFileExtension(mimeType: string): string {\r\n  if (mimeType === 'application/pdf') return '.pdf'\r\n  if (mimeType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') return '.docx'\r\n  if (mimeType.includes('word')) return '.docx'\r\n  return '.pdf' // Default to PDF since that's our new output_format default\r\n}\r\n\r\nexport async function POST(\r\n  request: Request,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const { id } = await params\r\n    const body = await request.json()\r\n    const { action, notes, rejection_reason } = body\r\n\r\n    // Validate action\r\n    if (!['approve', 'reject'].includes(action)) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid action. Must be approve or reject.' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Check authentication\r\n    const user = await requireStaffAuth()\r\n    const supabase = await createClient()\r\n    const serviceSupabase = createServiceClient()\r\n\r\n    // Get approval details with related data\r\n    const { data: approval, error: fetchError } = await serviceSupabase\r\n      .from('approvals')\r\n      .select(`\r\n        *,\r\n        requested_by_profile:profiles!approvals_requested_by_fkey(id, display_name, email),\r\n        related_investor:investors!approvals_related_investor_id_fkey(id, legal_name),\r\n        related_deal:deals!approvals_related_deal_id_fkey(id, name)\r\n      `)\r\n      .eq('id', id)\r\n      .single()\r\n\r\n    if (fetchError || !approval) {\r\n      console.error('Approval fetch error:', fetchError)\r\n      return NextResponse.json(\r\n        { error: 'Approval not found' },\r\n        { status: 404 }\r\n      )\r\n    }\r\n\r\n    // Check if approval is already processed (preliminary check)\r\n    if (approval.status !== 'pending') {\r\n      return NextResponse.json(\r\n        { error: 'Approval has already been processed' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Start transaction\r\n    const now = new Date().toISOString()\r\n    let transactionError = null\r\n    let transactionSuccess = true\r\n    let notificationData = null\r\n\r\n    // Calculate processing time in hours\r\n    const createdAt = new Date(approval.created_at)\r\n    const nowDate = new Date(now)\r\n    const processingTimeHours = (nowDate.getTime() - createdAt.getTime()) / (1000 * 60 * 60)\r\n\r\n    // Update approval status\r\n    const updateData: any = {\r\n      status: action === 'approve' ? 'approved' : 'rejected',\r\n      approved_by: user.id,\r\n      approved_at: now,\r\n      resolved_at: now,\r\n      updated_at: now,\r\n      actual_processing_time_hours: Math.round(processingTimeHours * 100) / 100 // Round to 2 decimals\r\n    }\r\n\r\n    // Add notes if provided\r\n    if (notes) {\r\n      updateData.notes = notes\r\n    }\r\n\r\n    // Add rejection reason if rejecting\r\n    if (action === 'reject' && rejection_reason) {\r\n      updateData.rejection_reason = rejection_reason\r\n    }\r\n\r\n    // OPTIMISTIC LOCK: Only update if status is still 'pending'\r\n    // This prevents race conditions where two staff members approve simultaneously\r\n    const { data: updatedApproval, error: updateError, count } = await serviceSupabase\r\n      .from('approvals')\r\n      .update(updateData, { count: 'exact' })\r\n      .eq('id', id)\r\n      .eq('status', 'pending')  // ‚Üê OPTIMISTIC LOCK\r\n      .select()\r\n      .single()\r\n\r\n    // Check if update succeeded (row was actually updated)\r\n    if (count === 0 || !updatedApproval) {\r\n      console.warn(`Approval ${id} was already processed by another user`)\r\n      return NextResponse.json(\r\n        { error: 'This approval was already processed by another user. Please refresh the page.' },\r\n        { status: 409 }  // 409 Conflict\r\n      )\r\n    }\r\n\r\n    if (updateError) {\r\n      console.error('Approval update error:', updateError)\r\n      return NextResponse.json(\r\n        { error: 'Failed to update approval' },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    // Handle entity-specific actions on approval\r\n    if (action === 'approve') {\r\n      const result = await handleEntityApproval(\r\n        serviceSupabase,\r\n        approval,\r\n        user.id,\r\n        request,\r\n        user\r\n      )\r\n\r\n      if (!result.success) {\r\n        transactionError = result.error\r\n        transactionSuccess = false\r\n\r\n        // ROLLBACK: If entity logic fails, rollback approval to 'pending'\r\n        console.error(`Entity approval failed for ${approval.entity_type}:`, result.error)\r\n        console.log('Rolling back approval to pending status...')\r\n\r\n        const { error: rollbackError } = await serviceSupabase\r\n          .from('approvals')\r\n          .update({\r\n            status: 'pending',\r\n            approved_by: null,\r\n            approved_at: null,\r\n            resolved_at: null,\r\n            notes: `Auto-rollback: ${result.error}. Original approver: ${user.id}`,\r\n            updated_at: new Date().toISOString()\r\n          })\r\n          .eq('id', id)\r\n\r\n        if (rollbackError) {\r\n          console.error('CRITICAL: Rollback failed:', rollbackError)\r\n          // Log to audit trail for manual intervention\r\n          await auditLogger.log({\r\n            actor_user_id: user.id,\r\n            action: 'approval_rollback_failed',\r\n            entity: 'approvals',\r\n            entity_id: id,\r\n            metadata: {\r\n              original_error: result.error,\r\n              rollback_error: rollbackError.message,\r\n              severity: 'critical'\r\n            }\r\n          })\r\n\r\n          // Return critical error - rollback failed\r\n          return NextResponse.json(\r\n            {\r\n              success: false,\r\n              error: `CRITICAL: Approval failed AND rollback failed. The approval may be in an inconsistent state. Manual intervention required. Contact support immediately with Approval ID: ${id}`,\r\n              details: {\r\n                approval_error: result.error,\r\n                rollback_error: rollbackError.message,\r\n                approval_id: id\r\n              }\r\n            },\r\n            { status: 500 }\r\n          )\r\n        }\r\n\r\n        // Rollback succeeded\r\n        return NextResponse.json(\r\n          {\r\n            success: false,\r\n            error: `Failed to process approval: ${result.error}. The approval has been rolled back to pending status. Please try again or contact support.`\r\n          },\r\n          { status: 500 }\r\n        )\r\n      } else if (result.notificationData) {\r\n        notificationData = result.notificationData\r\n      }\r\n    } else if (action === 'reject') {\r\n      // Handle rejection\r\n      await handleEntityRejection(serviceSupabase, approval, rejection_reason || '', user.id)\r\n    }\r\n\r\n    // Audit log\r\n    await auditLogger.log({\r\n      actor_user_id: user.id,\r\n      action: action === 'approve' ? 'approval_approved' : 'approval_rejected',\r\n      entity: 'approvals',\r\n      entity_id: id,\r\n      metadata: {\r\n        entity_type: approval.entity_type,\r\n        entity_id: approval.entity_id,\r\n        notes,\r\n        rejection_reason\r\n      }\r\n    })\r\n\r\n    // Create notification for requester\r\n    if (approval.requested_by) {\r\n      const notificationMessage = action === 'approve'\r\n        ? `Your ${approval.entity_type} request has been approved`\r\n        : `Your ${approval.entity_type} request has been rejected`\r\n\r\n      await serviceSupabase\r\n        .from('investor_notifications')\r\n        .insert({\r\n          user_id: approval.requested_by,\r\n          title: `${approval.entity_type} ${action}d`,\r\n          message: notificationMessage,\r\n          type: action === 'approve' ? 'approval_granted' : 'approval_rejected',\r\n          metadata: {\r\n            approval_id: id,\r\n            entity_type: approval.entity_type,\r\n            entity_id: approval.entity_id,\r\n            rejection_reason: rejection_reason || undefined,\r\n            notes: notes || undefined\r\n          }\r\n        })\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: transactionSuccess,\r\n      message: action === 'approve'\r\n        ? 'Approval confirmed successfully'\r\n        : 'Approval rejected successfully',\r\n      error: transactionError,\r\n      notificationData\r\n    })\r\n  } catch (error) {\r\n    console.error('Approval action error:', error)\r\n    return NextResponse.json(\r\n      { error: 'Internal server error' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n// Handle entity-specific approval actions\r\nasync function handleEntityApproval(\r\n  supabase: any,\r\n  approval: any,\r\n  actorId: string,\r\n  request?: Request,\r\n  user?: any\r\n): Promise<{ success: boolean; error?: string; notificationData?: any }> {\r\n  try {\r\n    const entityType = approval.entity_type\r\n    const entityId = approval.entity_id\r\n    const metadata = approval.entity_metadata || {}\r\n\r\n    switch (entityType) {\r\n      case 'allocation':\r\n        // Finalize allocation (call DB function if exists)\r\n        const { error: allocationError } = await supabase\r\n          .from('allocations')\r\n          .update({\r\n            status: 'approved',\r\n            approved_by: actorId,\r\n            approved_at: new Date().toISOString()\r\n          })\r\n          .eq('id', entityId)\r\n\r\n        if (allocationError) {\r\n          console.error('Error approving allocation:', allocationError)\r\n          return { success: false, error: 'Failed to approve allocation' }\r\n        }\r\n        break\r\n\r\n      case 'investor_onboarding':\r\n        // Update investor KYC status\r\n        const { error: kycError } = await supabase\r\n          .from('investors')\r\n          .update({\r\n            kyc_status: 'approved',\r\n            kyc_approved_at: new Date().toISOString(),\r\n            kyc_approved_by: actorId\r\n          })\r\n          .eq('id', entityId)\r\n\r\n        if (kycError) {\r\n          console.error('Error updating KYC status:', kycError)\r\n          return { success: false, error: 'Failed to update KYC status' }\r\n        }\r\n\r\n        // Create user account for investor if doesn't exist\r\n        if (metadata.email) {\r\n          const { data: existingProfile } = await supabase\r\n            .from('profiles')\r\n            .select('id')\r\n            .eq('email', metadata.email)\r\n            .single()\r\n\r\n          if (!existingProfile) {\r\n            // Generate temporary password\r\n            const tempPassword = Math.random().toString(36).slice(-8) + 'Aa1!'\r\n\r\n            // Note: In production, this would trigger email verification\r\n            const { error: profileError } = await supabase\r\n              .from('profiles')\r\n              .insert({\r\n                email: metadata.email,\r\n                display_name: metadata.display_name || metadata.email.split('@')[0],\r\n                role: 'investor',\r\n                is_active: true,\r\n                metadata: {\r\n                  investor_id: entityId,\r\n                  temp_password: tempPassword,\r\n                  needs_password_reset: true\r\n                }\r\n              })\r\n\r\n            if (profileError) {\r\n              console.error('Error creating investor profile:', profileError)\r\n              // Don't fail the approval, just log\r\n            }\r\n\r\n            // Link investor to the new profile\r\n            const { data: newProfile } = await supabase\r\n              .from('profiles')\r\n              .select('id')\r\n              .eq('email', metadata.email)\r\n              .single()\r\n\r\n            if (newProfile) {\r\n              await supabase\r\n                .from('investor_users')\r\n                .insert({\r\n                  investor_id: entityId,\r\n                  user_id: newProfile.id,\r\n                  role: 'primary',\r\n                  is_active: true\r\n                })\r\n            }\r\n          }\r\n        }\r\n        break\r\n\r\n      case 'deal':\r\n        // Update deal status\r\n        const { error: dealError } = await supabase\r\n          .from('deals')\r\n          .update({\r\n            status: metadata.target_status || 'approved',\r\n            approved_by: actorId,\r\n            approved_at: new Date().toISOString()\r\n          })\r\n          .eq('id', entityId)\r\n\r\n        if (dealError) {\r\n          console.error('Error approving deal:', dealError)\r\n          return { success: false, error: 'Failed to approve deal' }\r\n        }\r\n        break\r\n\r\n      case 'deal_close': {\r\n        const { data: deal, error: closeDealError } = await supabase\r\n          .from('deals')\r\n          .select('id, name, close_at')\r\n          .eq('id', entityId)\r\n          .single()\r\n\r\n        if (closeDealError || !deal) {\r\n          console.error('Error loading deal for close approval:', closeDealError)\r\n          return { success: false, error: 'Failed to load deal for closing' }\r\n        }\r\n\r\n        if (!deal.close_at) {\r\n          return { success: false, error: 'Deal has no closing date set' }\r\n        }\r\n\r\n        const closingDate = new Date(deal.close_at)\r\n        const closeResult = await handleDealClose(supabase, entityId, closingDate)\r\n\r\n        if (!closeResult.success) {\r\n          const message = closeResult.errors.length > 0\r\n            ? closeResult.errors.join('; ')\r\n            : 'Failed to process deal close'\r\n          return { success: false, error: message }\r\n        }\r\n\r\n        return {\r\n          success: true,\r\n          notificationData: {\r\n            type: 'deal_close_processed',\r\n            deal_id: entityId,\r\n            deal_name: deal.name\r\n          }\r\n        }\r\n      }\r\n\r\n      case 'termsheet_close': {\r\n        // entity_id is the termsheet ID (deal_fee_structures.id)\r\n        // This processes only subscriptions linked to this specific termsheet\r\n        const termsheetCloseResult = await handleTermsheetClose(supabase, entityId)\r\n\r\n        if (!termsheetCloseResult.success) {\r\n          const message = termsheetCloseResult.errors.length > 0\r\n            ? termsheetCloseResult.errors.join('; ')\r\n            : 'Failed to process termsheet close'\r\n          return { success: false, error: message }\r\n        }\r\n\r\n        return {\r\n          success: true,\r\n          notificationData: {\r\n            type: 'termsheet_close_processed',\r\n            termsheet_id: entityId,\r\n            deal_id: termsheetCloseResult.dealId,\r\n            subscriptions_activated: termsheetCloseResult.subscriptionsActivated,\r\n            certificates_triggered: termsheetCloseResult.certificatesTriggered,\r\n            commissions_created: termsheetCloseResult.commissionsCreated\r\n          }\r\n        }\r\n      }\r\n\r\n      case 'deal_interest':\r\n      case 'deal_interest_nda':\r\n        // Update investor deal interest status\r\n        const { error: interestError } = await supabase\r\n          .from('investor_deal_interest')\r\n          .update({\r\n            status: 'approved',\r\n            updated_at: new Date().toISOString()\r\n          })\r\n          .eq('id', entityId)\r\n\r\n        if (interestError) {\r\n          console.error('Error approving deal interest:', interestError)\r\n          return { success: false, error: 'Failed to approve deal interest' }\r\n        }\r\n\r\n        // Fetch deal interest details for NDA workflow\r\n        const { data: dealInterest } = await supabase\r\n          .from('investor_deal_interest')\r\n          .select(`\r\n            *,\r\n            deal:deals!inner(\r\n              id,\r\n              name\r\n            )\r\n          `)\r\n          .eq('id', entityId)\r\n          .single()\r\n\r\n        console.log('üîç DEBUG: dealInterest:', dealInterest ? 'EXISTS' : 'NULL')\r\n\r\n        if (dealInterest) {\r\n          // Auto-trigger NDA workflow after interest approval\r\n          try {\r\n            // Fetch complete investor and deal data for NDA\r\n            const { data: investorData } = await supabase\r\n              .from('investors')\r\n              .select('*, profiles!investors_created_by_fkey(display_name)')\r\n              .eq('id', dealInterest.investor_id)\r\n              .single()\r\n\r\n            const { data: dealData } = await supabase\r\n              .from('deals')\r\n              .select('*, vehicle:vehicles(*)')\r\n              .eq('id', dealInterest.deal_id)\r\n              .single()\r\n\r\n            console.log('üîç DEBUG: Data check:', {\r\n              hasInvestor: !!investorData,\r\n              hasDeal: !!dealData,\r\n              hasUser: !!user\r\n            })\r\n\r\n            if (investorData && dealData && user) {\r\n              const ceoSigner = await getCeoSigner(supabase)\r\n              if (!ceoSigner) {\r\n                console.warn('[approvals] No CEO signer found, defaulting to approver profile')\r\n              }\r\n\r\n              const countersignerName = ceoSigner?.displayName || user.displayName || user.email?.split('@')[0] || 'Authorized Signatory'\r\n              const countersignerTitle = ceoSigner?.title || 'Authorized Signatory'\r\n\r\n              const vehicle = dealData.vehicle\r\n              const vehicleName = vehicle?.name || 'Vehicle Name'\r\n              const rawEntityCode = vehicle?.entity_code || ''\r\n              const rawSeriesCode = vehicle?.series_short_title || ''\r\n              const rawSeriesNumber = vehicle?.series_number || ''\r\n              const seriesCode = rawSeriesCode || (rawEntityCode ? rawEntityCode.replace(/\\d+/g, '') : '')\r\n              const seriesNumber = rawSeriesNumber || (rawEntityCode ? rawEntityCode.replace(/\\D+/g, '') : '')\r\n              const derivedEntityCode = [seriesCode, seriesNumber].filter(Boolean).join('')\r\n              const seriesEntityCode = rawEntityCode || derivedEntityCode || 'VC206'\r\n              const projectSeriesLabel = [seriesCode, seriesNumber].filter(Boolean).join(' ')\r\n              const projectDescription = `VERSO Capital 2 SCSP ${vehicleName}${projectSeriesLabel ? ` Series ${projectSeriesLabel}` : ''}${seriesEntityCode ? ` (\"${seriesEntityCode}\")` : ''}`\r\n              const investmentName = dealData.name || dealData.description || vehicle?.investment_name || 'Investment Opportunity'\r\n\r\n              const city = investorData.city?.trim()\r\n              const country = investorData.country?.trim()\r\n              const partyACityCountry = [city, country].filter(Boolean).join(' / ') || 'Country to be provided'\r\n\r\n              const vehicleAddress = vehicle?.address || '2, Avenue Charles de Gaulle ‚Äì L-1653'\r\n              const vehicleDomicile = vehicle?.domicile || 'Luxembourg, LU'\r\n\r\n              let managingPartnerName = countersignerName\r\n              let managingPartnerTitle = countersignerTitle\r\n              if (vehicle?.managing_partner_id) {\r\n                const { data: managingPartner, error: managingPartnerError } = await supabase\r\n                  .from('profiles')\r\n                  .select('display_name, title')\r\n                  .eq('id', vehicle.managing_partner_id)\r\n                  .single()\r\n\r\n                if (managingPartnerError) {\r\n                  console.warn('[approvals] Failed to load managing partner profile:', managingPartnerError.message)\r\n                }\r\n\r\n                if (managingPartner?.display_name) {\r\n                  managingPartnerName = managingPartner.display_name\r\n                }\r\n                if (managingPartner?.title) {\r\n                  managingPartnerTitle = managingPartner.title\r\n                }\r\n              }\r\n\r\n              const now = new Date()\r\n              const executionDate = `${String(now.getDate()).padStart(2, '0')} / ${String(now.getMonth() + 1).padStart(2, '0')} / ${now.getFullYear()}`\r\n\r\n              // ========================================================\r\n              // MULTI-SIGNATORY NDA SUPPORT\r\n              // For entity investors: generate 1 NDA per authorized signatory\r\n              // For individual investors: generate 1 NDA for the investor\r\n              // ========================================================\r\n\r\n              // Determine if this is an entity investor (has type and is not 'individual')\r\n              const isEntityInvestor = investorData.type && investorData.type !== 'individual'\r\n              console.log('üë• [NDA] Investor type detection:', {\r\n                type: investorData.type,\r\n                isEntity: isEntityInvestor\r\n              })\r\n\r\n              // Build list of signatories\r\n              interface NdaSignatory {\r\n                member_id: string | null\r\n                full_name: string\r\n                email: string\r\n                title: string | null\r\n              }\r\n\r\n              let signatories: NdaSignatory[] = []\r\n\r\n              if (isEntityInvestor) {\r\n                // Load authorized signatories for entity investors\r\n                const { data: members, error: membersError } = await supabase\r\n                  .from('investor_members')\r\n                  .select('id, full_name, email, role_title')\r\n                  .eq('investor_id', investorData.id)\r\n                  .eq('is_signatory', true)\r\n                  .eq('is_active', true)\r\n\r\n                if (membersError) {\r\n                  console.warn('[NDA] Failed to load investor members:', membersError.message)\r\n                }\r\n\r\n                if (members && members.length > 0) {\r\n                  signatories = members.map((m: { id: string; full_name: string | null; email: string | null; role_title: string | null }) => ({\r\n                    member_id: m.id,\r\n                    full_name: m.full_name || 'Authorized Signatory',\r\n                    email: m.email || investorData.email, // Fallback to investor email\r\n                    title: m.role_title || 'Authorized Representative'\r\n                  }))\r\n                  console.log(`üë• [NDA] Found ${signatories.length} authorized signatories for entity`)\r\n                } else {\r\n                  // Fallback: use investor's representative if no signatories marked\r\n                  console.warn('[NDA] No signatories marked for entity, using representative fallback')\r\n                  signatories = [{\r\n                    member_id: null,\r\n                    full_name: investorData.representative_name || investorData.legal_name || 'Authorized Representative',\r\n                    email: investorData.email,\r\n                    title: investorData.representative_title || 'Authorized Representative'\r\n                  }]\r\n                }\r\n              } else {\r\n                // Individual investor - single signatory\r\n                signatories = [{\r\n                  member_id: null,\r\n                  full_name: investorData.legal_name || investorData.display_name || 'Investor',\r\n                  email: investorData.email,\r\n                  title: null\r\n                }]\r\n                console.log('üë§ [NDA] Individual investor - single signatory')\r\n              }\r\n\r\n              console.log(`üîî [NDA] Processing ${signatories.length} NDA(s) for: ${investorData.legal_name}`)\r\n\r\n              // Loop through each signatory and generate their NDA\r\n              for (const signatory of signatories) {\r\n                console.log(`üìÑ [NDA] Generating NDA for signatory: ${signatory.full_name} (${signatory.email})`)\r\n\r\n                // Prepare NDA payload with signatory-specific fields\r\n                const ndaPayload = {\r\n                  series_number: seriesNumber || seriesEntityCode,\r\n                  project_description: projectDescription,\r\n                  investment_description: investmentName,\r\n                  series_entity_code: seriesEntityCode,\r\n                  vehicle_name: vehicleName,\r\n                  series_code: seriesCode,\r\n                  series_numeric: seriesNumber,\r\n                  investment_name: investmentName,\r\n                  vehicle_managing_partner_name: managingPartnerName,\r\n                  vehicle_managing_partner_title: managingPartnerTitle,\r\n\r\n                  // Party A (Investor) - uses signatory-specific data\r\n                  party_a_name: investorData.legal_name || investorData.display_name,\r\n                  party_a_registered_address: investorData.registered_address || 'Address to be provided',\r\n                  party_a_city_country: partyACityCountry,\r\n                  party_a_representative_name: signatory.full_name,\r\n                  party_a_representative_title: signatory.title || 'Authorized Representative',\r\n\r\n                  // Party B (VERSO)\r\n                  party_b_name: projectDescription,\r\n                  party_b_registered_address: vehicleAddress,\r\n                  party_b_city_country: vehicleDomicile,\r\n                  party_b_representative_name: managingPartnerName,\r\n                  party_b_representative_title: managingPartnerTitle,\r\n\r\n                  // Execution details - uses signatory's email for data room\r\n                  dataroom_email: signatory.email,\r\n                  execution_date: executionDate,\r\n                  zoho_sign_document_id: '' // Auto-generated by n8n\r\n                }\r\n\r\n                // Trigger NDA workflow for this signatory\r\n                const result = await triggerWorkflow({\r\n                  workflowKey: 'process-nda',\r\n                  payload: ndaPayload,\r\n                  entityType: 'deal_interest_nda',\r\n                  entityId: dealInterest.id,\r\n                  user: {\r\n                    id: user.id,\r\n                    email: user.email,\r\n                    displayName: user.displayName,\r\n                    role: user.role,\r\n                    title: user.title\r\n                  }\r\n                })\r\n\r\n                if (!result.success) {\r\n                  console.error(`‚ùå [NDA] Failed to trigger NDA workflow for ${signatory.full_name}:`, result.error)\r\n                  continue // Try next signatory\r\n                }\r\n\r\n                console.log(`‚úÖ [NDA] Workflow triggered for ${signatory.full_name}:`, {\r\n                  workflow_run_id: result.workflow_run_id\r\n                })\r\n\r\n                // Create signature requests if n8n returned Google Drive file\r\n                if (result.n8n_response && result.workflow_run_id) {\r\n                  const googleDriveFile = Array.isArray(result.n8n_response)\r\n                    ? result.n8n_response[0]\r\n                    : result.n8n_response\r\n\r\n                  try {\r\n                    // Create investor signature request (PARTY A) with member_id\r\n                    const investorSigPayload = {\r\n                      workflow_run_id: result.workflow_run_id,\r\n                      investor_id: investorData.id,\r\n                      member_id: signatory.member_id || undefined, // Track specific signatory\r\n                      deal_id: dealInterest.deal_id,\r\n                      signer_email: signatory.email,\r\n                      signer_name: signatory.full_name,\r\n                      document_type: 'nda' as const,\r\n                      google_drive_file_id: googleDriveFile.id,\r\n                      google_drive_url: googleDriveFile.webContentLink || googleDriveFile.webViewLink,\r\n                      signer_role: 'investor' as const,\r\n                      signature_position: 'party_a' as const\r\n                    }\r\n\r\n                    console.log('üîç [NDA] Investor signature request:', {\r\n                      signatory: signatory.full_name,\r\n                      member_id: signatory.member_id\r\n                    })\r\n\r\n                    const investorSigResult = await createSignatureRequest(investorSigPayload, supabase)\r\n\r\n                    if (investorSigResult.success) {\r\n                      console.log(`üìß [NDA] Investor signature request created for ${signatory.full_name}`)\r\n                    } else {\r\n                      console.error(`Failed to create investor signature request for ${signatory.full_name}:`, investorSigResult.error)\r\n                    }\r\n\r\n                    // Create admin signature request (PARTY B) for this NDA document\r\n                    const adminSigPayload = {\r\n                      workflow_run_id: result.workflow_run_id,\r\n                      investor_id: investorData.id,\r\n                      deal_id: dealInterest.deal_id,\r\n                      signer_email: ceoSigner?.email || user.email,\r\n                      signer_name: countersignerName,\r\n                      document_type: 'nda' as const,\r\n                      google_drive_file_id: googleDriveFile.id,\r\n                      google_drive_url: googleDriveFile.webContentLink || googleDriveFile.webViewLink,\r\n                      signer_role: 'admin' as const,\r\n                      signature_position: 'party_b' as const\r\n                    }\r\n\r\n                    const adminSigResult = await createSignatureRequest(adminSigPayload, supabase)\r\n\r\n                    if (adminSigResult.success) {\r\n                      console.log(`üìß [NDA] Admin signature request created for ${signatory.full_name}'s NDA`)\r\n                    } else {\r\n                      console.error(`Failed to create admin signature request:`, adminSigResult.error)\r\n                    }\r\n                  } catch (sigError) {\r\n                    console.error(`Error creating signature requests for ${signatory.full_name}:`, sigError)\r\n                    // Continue to next signatory\r\n                  }\r\n                } else {\r\n                  console.warn(`‚ö†Ô∏è [NDA] No workflow_run_id or n8n_response for ${signatory.full_name}`)\r\n                }\r\n              }\r\n\r\n              console.log(`‚úÖ [NDA] Completed processing ${signatories.length} NDA(s) for ${investorData.legal_name}`)\r\n            } else {\r\n              console.log('‚ö†Ô∏è Skipping NDA workflow - missing data:', {\r\n                hasInvestor: !!investorData,\r\n                hasDeal: !!dealData,\r\n                hasUser: !!user\r\n              })\r\n            }\r\n          } catch (ndaError) {\r\n            console.error('‚ùå Error triggering NDA workflow:', ndaError)\r\n            // Don't fail the approval if NDA trigger fails\r\n          }\r\n        } else {\r\n          console.log('‚ö†Ô∏è No deal interest found for entityId:', entityId)\r\n        }\r\n        break\r\n\r\n      case 'data_room_access_extension':\r\n        // Extend data room access by 7 days\r\n        const { data: currentAccess } = await supabase\r\n          .from('deal_data_room_access')\r\n          .select('expires_at')\r\n          .eq('id', entityId)\r\n          .single()\r\n\r\n        if (!currentAccess) {\r\n          return { success: false, error: 'Access record not found' }\r\n        }\r\n\r\n        // Calculate new expiry: add 7 days to current expiry (not from now)\r\n        const currentExpiry = new Date(currentAccess.expires_at)\r\n        const newExpiry = new Date(currentExpiry)\r\n        newExpiry.setDate(newExpiry.getDate() + 7)\r\n\r\n        const { error: extendError } = await supabase\r\n          .from('deal_data_room_access')\r\n          .update({\r\n            expires_at: newExpiry.toISOString(),\r\n            notes: `Extended by 7 days upon approval on ${new Date().toLocaleDateString()}`\r\n          })\r\n          .eq('id', entityId)\r\n\r\n        if (extendError) {\r\n          console.error('Error extending data room access:', extendError)\r\n          return { success: false, error: 'Failed to extend data room access' }\r\n        }\r\n\r\n        console.log('‚úÖ Data room access extended:', {\r\n          access_id: entityId,\r\n          old_expiry: currentAccess.expires_at,\r\n          new_expiry: newExpiry.toISOString()\r\n        })\r\n        break\r\n\r\n      case 'deal_subscription':\r\n        // Update subscription submission status\r\n        const { error: subError } = await supabase\r\n          .from('deal_subscription_submissions')\r\n          .update({\r\n            status: 'approved',\r\n            approved_by: actorId,\r\n            approved_at: new Date().toISOString()\r\n          })\r\n          .eq('id', entityId)\r\n\r\n        if (subError) {\r\n          console.error('Error approving subscription submission:', subError)\r\n          return { success: false, error: 'Failed to approve subscription submission' }\r\n        }\r\n\r\n        // Create formal subscription from submission\r\n        const { data: submission } = await supabase\r\n          .from('deal_subscription_submissions')\r\n          .select(`\r\n            *,\r\n            deal:deals!inner(\r\n              id,\r\n              name,\r\n              vehicle_id,\r\n              currency,\r\n              company_name,\r\n              company_logo_url,\r\n              vehicle:vehicles(\r\n                entity_code,\r\n                investment_name,\r\n                name\r\n              )\r\n            ),\r\n            investor:investors!inner(\r\n              display_name,\r\n              legal_name\r\n            )\r\n          `)\r\n          .eq('id', entityId)\r\n          .single()\r\n\r\n        if (submission && submission.deal?.vehicle_id) {\r\n          // Extract amount from payload_json\r\n          const amount = submission.payload_json?.amount || submission.payload_json?.subscription_amount || 0\r\n\r\n          // Check if subscription already exists\r\n          const { data: existingSub } = await supabase\r\n            .from('subscriptions')\r\n            .select('id')\r\n            .eq('investor_id', submission.investor_id)\r\n            .eq('vehicle_id', submission.deal.vehicle_id)\r\n            .eq('deal_id', submission.deal_id)\r\n            .single()\r\n\r\n          let subscriptionId = existingSub?.id\r\n\r\n          if (!existingSub) {\r\n            // Fetch deal's default fee plan to auto-link\r\n            const { data: defaultFeePlan } = await supabase\r\n              .from('fee_plans')\r\n              .select('id')\r\n              .eq('deal_id', submission.deal_id)\r\n              .eq('is_default', true)\r\n              .eq('is_active', true)\r\n              .single()\r\n\r\n            // Fetch fee structure BEFORE creating subscription to copy fee fields\r\n            // This ensures the subscription record has the correct fee percentages for fee event calculation\r\n            // NOTE: Use order().limit(1) instead of .maybeSingle() because deals can have multiple published fee structures\r\n            const { data: feeStructureForSub } = await supabase\r\n              .from('deal_fee_structures')\r\n              .select('subscription_fee_percent, management_fee_percent, carried_interest_percent, price_per_share_text, price_per_share, cost_per_share, payment_deadline_days')\r\n              .eq('deal_id', submission.deal_id)\r\n              .eq('status', 'published')\r\n              .order('created_at', { ascending: false })\r\n              .limit(1)\r\n              .single()\r\n\r\n            // Get latest valuation for fallback price_per_share\r\n            const { data: latestValuation } = await supabase\r\n              .from('valuations')\r\n              .select('nav_per_unit')\r\n              .eq('vehicle_id', submission.deal.vehicle_id)\r\n              .order('as_of_date', { ascending: false })\r\n              .limit(1)\r\n              .maybeSingle()\r\n\r\n            // Get fee components for management_fee_frequency and performance threshold\r\n            let managementFeeFrequency: string | null = null\r\n            let performanceFeeThreshold: number | null = null\r\n            if (defaultFeePlan?.id) {\r\n              const { data: feeComponents } = await supabase\r\n                .from('fee_components')\r\n                .select('kind, frequency, hurdle_rate_bps')\r\n                .eq('fee_plan_id', defaultFeePlan.id)\r\n                .in('kind', ['management', 'performance'])\r\n\r\n              if (feeComponents) {\r\n                const mgmtComponent = feeComponents.find((c: { kind: string; frequency?: string | null; hurdle_rate_bps?: number | null }) => c.kind === 'management')\r\n                const perfComponent = feeComponents.find((c: { kind: string; frequency?: string | null; hurdle_rate_bps?: number | null }) => c.kind === 'performance')\r\n                managementFeeFrequency = mgmtComponent?.frequency || null\r\n                // Convert hurdle_rate_bps (basis points) to percentage\r\n                performanceFeeThreshold = perfComponent?.hurdle_rate_bps\r\n                  ? perfComponent.hurdle_rate_bps / 100\r\n                  : null\r\n              }\r\n            }\r\n\r\n            // Check for introduction (introducer linking)\r\n            const { data: introduction } = await supabase\r\n              .from('introductions')\r\n              .select('id, introducer_id')\r\n              .eq('prospect_investor_id', submission.investor_id)\r\n              .eq('deal_id', submission.deal_id)\r\n              .in('status', ['allocated', 'joined'])\r\n              .maybeSingle()\r\n\r\n            // Calculate price_per_share: use numeric field from fee structure, fallback to text parsing, then valuation\r\n            let pricePerShare: number | null = null\r\n            // Prefer numeric price_per_share field\r\n            if (feeStructureForSub?.price_per_share != null && feeStructureForSub.price_per_share > 0) {\r\n              pricePerShare = feeStructureForSub.price_per_share\r\n            }\r\n            // Fallback: parse from text field (for backwards compatibility)\r\n            else if (feeStructureForSub?.price_per_share_text) {\r\n              const parsed = parseFloat(feeStructureForSub.price_per_share_text.replace(/[^\\d.]/g, ''))\r\n              if (!isNaN(parsed) && parsed > 0) {\r\n                pricePerShare = parsed\r\n              }\r\n            }\r\n            // Final fallback: use latest valuation NAV\r\n            if (pricePerShare === null && latestValuation?.nav_per_unit) {\r\n              pricePerShare = latestValuation.nav_per_unit\r\n            }\r\n\r\n            // Get cost_per_share from fee structure (CEO-set acquisition cost)\r\n            const costPerShare: number | null = feeStructureForSub?.cost_per_share ?? null\r\n\r\n            // Calculate num_shares (draft - staff can adjust later)\r\n            const numShares = pricePerShare ? Math.floor(amount / pricePerShare) : null\r\n\r\n            // Calculate spread (price - cost) and spread fee amount\r\n            // Use explicit null checks to handle zero values correctly\r\n            const spreadPerShare = (pricePerShare !== null && costPerShare !== null && pricePerShare > 0 && costPerShare >= 0)\r\n              ? pricePerShare - costPerShare\r\n              : null\r\n            const spreadFeeAmount = (spreadPerShare !== null && numShares !== null && numShares > 0)\r\n              ? spreadPerShare * numShares\r\n              : null\r\n\r\n            // Pre-calculate subscription fee amount for fee events consistency\r\n            // Normalize percent: if > 1, it's whole number format (2 = 2%), convert to decimal\r\n            const feePercent = feeStructureForSub?.subscription_fee_percent || 0\r\n            const normalizedPercent = feePercent > 1 ? feePercent / 100 : feePercent\r\n            const subscriptionFeeAmount = normalizedPercent > 0\r\n              ? amount * normalizedPercent\r\n              : null\r\n\r\n            // Calculate funding deadline\r\n            const fundingDueAt = feeStructureForSub?.payment_deadline_days\r\n              ? new Date(Date.now() + feeStructureForSub.payment_deadline_days * 24 * 60 * 60 * 1000).toISOString().split('T')[0]\r\n              : null\r\n\r\n            const { data: newSubscription, error: createSubError } = await supabase\r\n              .from('subscriptions')\r\n              .insert({\r\n                investor_id: submission.investor_id,\r\n                vehicle_id: submission.deal.vehicle_id,\r\n                deal_id: submission.deal_id,\r\n                fee_plan_id: defaultFeePlan?.id || null,\r\n                commitment: amount,\r\n                currency: submission.deal.currency || 'USD',\r\n                status: 'pending',\r\n                subscription_date: new Date().toISOString(),\r\n                effective_date: submission.effective_date || new Date().toISOString(),\r\n                acknowledgement_notes: `Approved from submission ${submission.id}. Awaiting subscription pack signature.`,\r\n                // Copy fee fields from deal_fee_structures for fee event calculation\r\n                subscription_fee_percent: feeStructureForSub?.subscription_fee_percent ?? null,\r\n                management_fee_percent: feeStructureForSub?.management_fee_percent ?? null,\r\n                performance_fee_tier1_percent: feeStructureForSub?.carried_interest_percent ?? null,\r\n                // NEW: Populate additional fields for complete subscription record\r\n                opportunity_name: submission.deal.vehicle?.investment_name || submission.deal.name,\r\n                price_per_share: pricePerShare,\r\n                cost_per_share: costPerShare,\r\n                spread_per_share: spreadPerShare,\r\n                spread_fee_amount: spreadFeeAmount,\r\n                num_shares: numShares,\r\n                subscription_fee_amount: subscriptionFeeAmount,\r\n                management_fee_frequency: managementFeeFrequency,\r\n                performance_fee_tier1_threshold: performanceFeeThreshold,\r\n                funding_due_at: fundingDueAt,\r\n                introducer_id: introduction?.introducer_id || null,\r\n                introduction_id: introduction?.id || null,\r\n              })\r\n              .select()\r\n              .single()\r\n\r\n            if (createSubError || !newSubscription) {\r\n              console.error('Error creating subscription:', createSubError)\r\n              return { success: false, error: 'Failed to create subscription' }\r\n            }\r\n\r\n            subscriptionId = newSubscription.id\r\n\r\n            // Link subscription back to submission for easy lookup\r\n            await supabase\r\n              .from('deal_subscription_submissions')\r\n              .update({ formal_subscription_id: subscriptionId })\r\n              .eq('id', submission.id)\r\n          }\r\n\r\n            // AUTO-TRIGGER SUBSCRIPTION PACK WORKFLOW\r\n            try {\r\n              // Fetch all required data for subscription pack\r\n              const { data: investorData } = await supabase\r\n                .from('investors')\r\n                .select('legal_name, type, registered_address, entity_identifier')\r\n                .eq('id', submission.investor_id)\r\n                .single()\r\n\r\n              // Fetch counterparty entity if this is an entity subscription\r\n              let counterpartyEntity = null\r\n              if (submission.subscription_type === 'entity' && submission.counterparty_entity_id) {\r\n                const { data: entityData } = await supabase\r\n                  .from('investor_counterparty')\r\n                  .select('*')\r\n                  .eq('id', submission.counterparty_entity_id)\r\n                  .single()\r\n                counterpartyEntity = entityData\r\n              }\r\n\r\n              // Build signatories array for multi-signatory subscription packs\r\n              // Each signatory includes a 'number' field for template display (1, 2, 3...)\r\n              let signatories: { name: string; title: string; number: number }[] = []\r\n              // Check BOTH: submission type OR investor's actual type (entity/institutional)\r\n              const isEntityInvestor = submission.subscription_type === 'entity' ||\r\n                                       investorData?.type === 'entity' ||\r\n                                       investorData?.type === 'institutional'\r\n              if (isEntityInvestor && submission.investor_id) {\r\n                // For entity investors: get authorized signatories from investor_members\r\n                const { data: members } = await supabase\r\n                  .from('investor_members')\r\n                  .select('id, full_name, email, role_title')\r\n                  .eq('investor_id', submission.investor_id)\r\n                  .eq('is_signatory', true)\r\n                  .eq('is_active', true)\r\n\r\n                if (members && members.length > 0) {\r\n                  signatories = members.map((m: { full_name: string | null; role_title: string | null }, index: number) => ({\r\n                    name: m.full_name || '',\r\n                    title: m.role_title || 'Authorized Signatory',\r\n                    number: index + 1\r\n                  }))\r\n                  console.log(`üë• [SUBSCRIPTION PACK] Found ${signatories.length} authorized signatories for entity`)\r\n                } else {\r\n                  // Fallback: use entity representative if no signatories marked\r\n                  signatories = [{\r\n                    name: counterpartyEntity?.representative_name || investorData?.legal_name || '',\r\n                    title: counterpartyEntity?.representative_title || 'Authorized Representative',\r\n                    number: 1\r\n                  }]\r\n                  console.warn('[SUBSCRIPTION PACK] No signatories marked, using representative fallback')\r\n                }\r\n              } else {\r\n                // For individual investors: single signatory\r\n                signatories = [{\r\n                  name: investorData?.legal_name || '',\r\n                  title: 'Investor',\r\n                  number: 1\r\n                }]\r\n              }\r\n\r\n              // Generate pre-rendered HTML for signatories (n8n doesn't support Handlebars {{#each}})\r\n              // ANCHOR ID CONVENTION: First subscriber is 'party_a', subsequent are 'party_a_2', 'party_a_3', etc.\r\n              const getAnchorId = (number: number, suffix?: string): string => {\r\n                const base = number === 1 ? 'party_a' : `party_a_${number}`\r\n                return suffix ? `${base}_${suffix}` : base\r\n              }\r\n\r\n              // ANCHOR CSS: Invisible anchors placed ON the signature line\r\n              //\r\n              // APPROACH:\r\n              // - Keep anchors in the PDF text layer (for PDF.js extraction)\r\n              // - Position anchors at the signature line using absolute positioning\r\n              // - Use tiny white text so anchors remain invisible\r\n              //\r\n              // IMPORTANT: Anchors are now used for PAGE + Y placement (anchor-based Y).\r\n              // Avoid off-page positioning so anchor Y is accurate.\r\n              const ANCHOR_CSS = 'position:absolute;left:0;top:0;font-size:1px;line-height:1px;color:#ffffff;opacity:0.01;'\r\n\r\n              // Page 2 - Subscription Form: Subscriber signatures with anchors (right column)\r\n              // Parent div needs position:relative for anchor's position:absolute to work\r\n              const signatoriesFormHtml = signatories.map(s => `\r\n            <div class=\"signature-block-inline\" style=\"position:relative;margin-bottom: 0.5cm;\">\r\n                <div class=\"signature-line\" style=\"position:relative;\"><span style=\"${ANCHOR_CSS}\">SIG_ANCHOR:${getAnchorId(s.number, 'form')}</span></div>\r\n                Name: ${s.name}<br>\r\n                Title: ${s.title}\r\n            </div>`).join('')\r\n\r\n              // Page 12 - Main Agreement: Subscriber signatures with anchors\r\n              // Increased spacing: min-height 4cm, margin-top 3cm for ~85pt signature space\r\n              // Parent div needs position:relative for anchor's position:absolute to work\r\n              const signatoriesSignatureHtml = signatories.map(s => `\r\n<div class=\"signature-block\" style=\"position:relative;margin-bottom: 1.5cm; min-height: 4cm;\">\r\n    <p><strong>The Subscriber</strong>, represented by Authorized Signatory ${s.number}</p>\r\n    <div class=\"signature-line main-line\" style=\"margin-top: 3cm; position:relative;\"><span style=\"${ANCHOR_CSS}\">SIG_ANCHOR:${getAnchorId(s.number)}</span></div>\r\n    <p style=\"margin-top: 0.3cm;\">Name: ${s.name}<br>\r\n    Title: ${s.title}</p>\r\n</div>`).join('')\r\n\r\n              // Legacy: Keep signatoriesTableHtml for backwards compatibility (no anchors)\r\n              const signatoriesTableHtml = signatories.map(s => `\r\n            <div style=\"margin-bottom: 0.5cm;\">\r\n                <div class=\"signature-line\"></div>\r\n                Name: ${s.name}<br>\r\n                Title: ${s.title}\r\n            </div>`).join('')\r\n\r\n              // NOTE: issuer and arranger signature HTML with anchors are generated after feeStructure is fetched\r\n\r\n              const { data: vehicleData } = await supabase\r\n                .from('vehicles')\r\n                .select('series_number, name, series_short_title, investment_name, issuer_gp_name, issuer_gp_rcc_number, issuer_rcc_number, issuer_website')\r\n                .eq('id', submission.deal.vehicle_id)\r\n                .single()\r\n\r\n              // NOTE: Use order().limit(1) instead of .maybeSingle() because deals can have multiple published fee structures\r\n              const { data: feeStructure } = await supabase\r\n                .from('deal_fee_structures')\r\n                .select('*')\r\n                .eq('deal_id', submission.deal_id)\r\n                .eq('status', 'published')\r\n                .order('created_at', { ascending: false })\r\n                .limit(1)\r\n                .single()\r\n\r\n              if (investorData && vehicleData && feeStructure && user) {\r\n                // Calculate subscription details\r\n                // Default to $1.00 per share if price_per_share_text is missing (makes certificate count = subscription amount)\r\n                const parsedPrice = parseFloat(feeStructure.price_per_share_text?.replace(/[^\\d.]/g, '') || '0')\r\n                const pricePerShare = parsedPrice > 0 ? parsedPrice : 1.00\r\n                if (!feeStructure.price_per_share_text || parsedPrice <= 0) {\r\n                  console.warn('‚ö†Ô∏è [SUBSCRIPTION PACK] Missing price_per_share_text for deal:', submission.deal_id, '- defaulting to $1.00')\r\n                }\r\n                const certificatesCount = Math.floor(amount / pricePerShare)\r\n                // Fee percentages are stored as whole numbers (2.0 = 2%, 25.0 = 25%)\r\n                const subscriptionFeeRate = feeStructure.subscription_fee_percent || 0\r\n                // Divide by 100 to convert percentage to decimal for calculation\r\n                const subscriptionFeeAmount = amount * (subscriptionFeeRate / 100)\r\n                const totalSubscriptionPrice = amount + subscriptionFeeAmount\r\n\r\n                // Format dates\r\n                const agreementDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })\r\n                const paymentDeadlineDays = feeStructure.payment_deadline_days || 10\r\n                const paymentDeadlineDate = new Date(Date.now() + paymentDeadlineDays * 24 * 60 * 60 * 1000)\r\n                  .toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })\r\n\r\n                // Determine subscriber info (use entity if entity subscription, otherwise investor)\r\n                const subscriberName = counterpartyEntity\r\n                  ? counterpartyEntity.legal_name\r\n                  : investorData.legal_name\r\n\r\n                const subscriberType = counterpartyEntity\r\n                  ? counterpartyEntity.entity_type.replace(/_/g, ' ').toUpperCase()\r\n                  : (investorData.type || 'Corporate Entity')\r\n\r\n                const subscriberAddress = counterpartyEntity && counterpartyEntity.registered_address\r\n                  ? [\r\n                      counterpartyEntity.registered_address.street,\r\n                      [\r\n                        counterpartyEntity.registered_address.city,\r\n                        counterpartyEntity.registered_address.state,\r\n                        counterpartyEntity.registered_address.postal_code\r\n                      ].filter(Boolean).join(', '),\r\n                      counterpartyEntity.registered_address.country\r\n                    ].filter(Boolean).join(', ')\r\n                  : (investorData.registered_address || '')\r\n\r\n                const subscriberBlock = counterpartyEntity\r\n                  ? `${counterpartyEntity.legal_name}, a ${counterpartyEntity.entity_type.replace(/_/g, ' ')} with registered office at ${subscriberAddress}`\r\n                  : `${investorData.legal_name}, ${investorData.type || 'entity'} with registered office at ${investorData.registered_address || ''}`\r\n\r\n                // Pre-rendered HTML for issuer (party_b) and arranger (party_c) signature blocks\r\n                // These include SIG_ANCHOR markers for signature positioning\r\n                // Page 12 - Main Agreement: Issuer signature with anchor\r\n                // Increased spacing: min-height 4cm, margin-top 3cm for ~85pt signature space\r\n                // Parent div needs position:relative for anchor's position:absolute to work\r\n                const issuerSignatureHtml = `\r\n<div class=\"signature-block\" style=\"position:relative;margin-bottom: 1.5cm; min-height: 4cm;\">\r\n    <p><strong>The Issuer, VERSO Capital 2 SCSP</strong>, duly represented by its general partner <strong>VERSO Capital 2 GP SARL</strong></p>\r\n    <div class=\"signature-line main-line\" style=\"margin-top: 3cm; position:relative;\"><span style=\"${ANCHOR_CSS}\">SIG_ANCHOR:party_b</span></div>\r\n    <p style=\"margin-top: 0.3cm;\">Name: ${feeStructure.issuer_signatory_name || 'Alexandre M√ºller'}<br>\r\n    Title: ${feeStructure.issuer_signatory_title || 'Authorized Signatory'}</p>\r\n</div>`\r\n\r\n                // Page 12 - Main Agreement: Arranger signature with anchor\r\n                // Increased spacing: min-height 4cm, margin-top 3cm for ~85pt signature space\r\n                // Parent div needs position:relative for anchor's position:absolute to work\r\n                const arrangerSignatureHtml = `\r\n<div class=\"signature-block\" style=\"position:relative;margin-bottom: 1.5cm; min-height: 4cm;\">\r\n    <p><strong>The Attorney, Verso Management Ltd.</strong>, for the purpose of the powers granted under Clause 6</p>\r\n    <div class=\"signature-line main-line\" style=\"margin-top: 3cm; position:relative;\"><span style=\"${ANCHOR_CSS}\">SIG_ANCHOR:party_c</span></div>\r\n    <p style=\"margin-top: 0.3cm;\">Name: ${feeStructure.arranger_person_name || 'Julien Machot'}<br>\r\n    Title: ${feeStructure.arranger_person_title || 'Director'}</p>\r\n</div>`\r\n\r\n                // Warn about incomplete address data (helps identify data quality issues)\r\n                if (counterpartyEntity) {\r\n                  const addr = counterpartyEntity.registered_address\r\n                  if (!addr || !addr.street || !addr.country) {\r\n                    console.warn('‚ö†Ô∏è [SUBSCRIPTION PACK] Entity has incomplete address:', {\r\n                      entity: counterpartyEntity.legal_name,\r\n                      missing: [!addr?.street && 'street', !addr?.country && 'country'].filter(Boolean)\r\n                    })\r\n                  }\r\n                } else if (!investorData.registered_address) {\r\n                  console.warn('‚ö†Ô∏è [SUBSCRIPTION PACK] Investor missing registered_address:', investorData.legal_name)\r\n                }\r\n\r\n                const subscriberTitle = counterpartyEntity && counterpartyEntity.representative_title\r\n                  ? counterpartyEntity.representative_title\r\n                  : 'Authorized Representative'\r\n\r\n                // Representative name: prefer entity rep, fallback to entity name, then investor name\r\n                const subscriberRepName = counterpartyEntity?.representative_name\r\n                  || counterpartyEntity?.legal_name\r\n                  || investorData.legal_name\r\n\r\n                // Build comprehensive subscription pack payload\r\n                const subscriptionPayload = {\r\n                  // Output format: 'pdf' for direct PDF, 'docx' for editable Word doc\r\n                  output_format: 'pdf',\r\n\r\n                  // Series & Investment info\r\n                  series_number: vehicleData.series_number || '',\r\n                  series_title: vehicleData.investment_name || vehicleData.name,\r\n                  series_short_title: vehicleData.series_short_title || '',\r\n                  ultimate_investment: submission.deal.company_name || submission.deal.name,\r\n\r\n                  // Subscriber info (entity if entity subscription, otherwise investor)\r\n                  subscriber_name: subscriberName,\r\n                  subscriber_type: subscriberType,\r\n                  subscriber_address: subscriberAddress,\r\n                  subscriber_block: subscriberBlock,\r\n                  subscriber_title: subscriberTitle,\r\n                  subscriber_representative_name: subscriberRepName,\r\n\r\n                  // Investment branding\r\n                  investment_logo_url: submission.deal.company_logo_url || '',\r\n\r\n                  // Financial details\r\n                  certificates_count: certificatesCount.toString(),\r\n                  price_per_share: pricePerShare.toFixed(2),\r\n                  subscription_amount: amount.toFixed(2),\r\n                  // Fee rates are already stored as percentages (2.0 = 2%), no multiplication needed\r\n                  subscription_fee_rate: `${subscriptionFeeRate.toFixed(2)}%`,\r\n                  subscription_fee_amount: subscriptionFeeAmount.toFixed(2),\r\n                  subscription_fee_text: `${subscriptionFeeRate.toFixed(2)}% upfront subscription fee`,\r\n                  total_subscription_price: totalSubscriptionPrice.toFixed(2),\r\n\r\n                  // Currency\r\n                  currency_code: submission.deal.currency || 'USD',\r\n                  currency_long: submission.deal.currency === 'USD' ? 'United States Dollars' : submission.deal.currency,\r\n\r\n                  // Fee structures - values are already percentages (2.0 = 2%, 25.0 = 25%)\r\n                  management_fee_text: `${(feeStructure.management_fee_percent || 0).toFixed(2)}% of net asset value per annum, calculated and payable quarterly`,\r\n                  performance_fee_text: `${(feeStructure.carried_interest_percent || 0).toFixed(2)}% performance fee on realized gains`,\r\n                  escrow_fee_text: feeStructure.escrow_fee_text || 'As per escrow agreement',\r\n\r\n                  // Legal clauses - values are already percentages\r\n                  management_fee_clause: feeStructure.management_fee_clause || `The Issuer shall charge a Management Fee of ${(feeStructure.management_fee_percent || 0).toFixed(2)}% per annum of the net asset value of the Series, calculated on a quarterly basis and payable quarterly in advance.`,\r\n                  performance_fee_clause: feeStructure.performance_fee_clause || `The Issuer shall be entitled to a Performance Fee equal to ${(feeStructure.carried_interest_percent || 0).toFixed(2)}% of the net profits generated by the Series.`,\r\n\r\n                  // Wire/Escrow instructions\r\n                  wire_bank_name: feeStructure.wire_bank_name || 'Banque de Luxembourg',\r\n                  wire_bank_address: feeStructure.wire_bank_address || '14, boulevard Royal, L-2449 Luxembourg, Grand Duchy of Luxembourg',\r\n                  wire_account_holder: feeStructure.wire_account_holder || 'Elvinger Hoss Prussen - Escrow Account',\r\n                  wire_escrow_agent: feeStructure.wire_escrow_agent || 'Elvinger Hoss Prussen',\r\n                  wire_law_firm_address: feeStructure.wire_law_firm_address || '2 Place Winston Churchill, L-1340 Luxembourg, Grand Duchy of Luxembourg',\r\n                  wire_iban: feeStructure.wire_iban || 'LU28 0019 4855 4447 1000',\r\n                  wire_bic: feeStructure.wire_bic || 'BLUXLULL',\r\n                  wire_reference: feeStructure.wire_reference_format?.replace('{series}', vehicleData.series_number || '') || `${vehicleData.series_number}-${vehicleData.series_short_title}`,\r\n                  wire_description: feeStructure.wire_description_format || `Escrow account for ${vehicleData.name}`,\r\n                  wire_arranger: feeStructure.exclusive_arranger || 'VERSO Management Ltd',\r\n                  wire_contact_email: feeStructure.wire_contact_email || 'subscription@verso.capital',\r\n\r\n                  // Issuer info\r\n                  issuer_gp_name: vehicleData.issuer_gp_name || 'VERSO Capital 2 GP SARL',\r\n                  issuer_gp_rcc_number: vehicleData.issuer_gp_rcc_number || '',\r\n                  issuer_rcc_number: vehicleData.issuer_rcc_number || '',\r\n                  issuer_website: vehicleData.issuer_website || 'www.verso.capital',\r\n                  issuer_name: feeStructure.issuer_signatory_name || 'Alexandre M√ºller',\r\n                  issuer_title: feeStructure.issuer_signatory_title || 'Authorized Signatory',\r\n\r\n                  // Dates & deadlines\r\n                  agreement_date: agreementDate,\r\n                  payment_deadline_days: paymentDeadlineDays.toString(),\r\n                  payment_deadline_date: paymentDeadlineDate,\r\n                  issue_within_business_days: (feeStructure.issue_within_business_days || 5).toString(),\r\n\r\n                  // Recitals\r\n                  recital_b_html: feeStructure.recital_b_html || `(B) The Issuer intends to issue Certificates which shall track equity interests in ${submission.deal.company_name || submission.deal.name}, and the Subscriber intends to subscribe for ${certificatesCount} Certificates.`,\r\n\r\n                  // Arranger\r\n                  arranger_name: feeStructure.arranger_person_name || 'Julien Machot',\r\n                  arranger_title: feeStructure.arranger_person_title || 'Director',\r\n                  arranger_company_name: feeStructure.exclusive_arranger || 'VERSO Management',\r\n\r\n                  // LPA & Certificates details\r\n                  // Note: lpa_date and max_aggregate_amount columns don't exist in vehicles table yet\r\n                  lpa_date: '',\r\n                  max_aggregate_amount: '100,000,000',\r\n\r\n                  // Accession Undertaking (Appendix) fields\r\n                  selling_subscriber_name: subscriberName,\r\n                  accession_holder_name: subscriberName,\r\n                  accession_signatory_name: signatories[0]?.name || '',\r\n                  accession_signatory_title: signatories[0]?.title || '',\r\n\r\n                  // Multi-signatory support: pre-rendered HTML (n8n doesn't support Handlebars loops)\r\n                  // All signature blocks include SIG_ANCHOR markers for precise signature positioning\r\n                  signatories_table_html: signatoriesTableHtml,  // Legacy: no anchors\r\n                  signatories_form_html: signatoriesFormHtml,    // Page 2: subscriber form signatures with anchors\r\n                  signatories_signature_html: signatoriesSignatureHtml, // Page 12: subscriber main agreement signatures\r\n                  issuer_signature_html: issuerSignatureHtml,    // Page 12: issuer main agreement signature\r\n                  arranger_signature_html: arrangerSignatureHtml  // Page 12: arranger main agreement signature\r\n                }\r\n\r\n                console.log('üîî Triggering Subscription Pack workflow:', {\r\n                  investor: investorData.legal_name,\r\n                  deal: submission.deal.name,\r\n                  series: vehicleData.series_number,\r\n                  amount: amount\r\n                })\r\n\r\n                const result = await triggerWorkflow({\r\n                  workflowKey: 'generate-subscription-pack',\r\n                  payload: subscriptionPayload,\r\n                  entityType: 'deal_subscription',\r\n                  entityId: submission.id,\r\n                  user: {\r\n                    id: user.id,\r\n                    email: user.email,\r\n                    displayName: user.displayName,\r\n                    role: user.role,\r\n                    title: user.title\r\n                  }\r\n                })\r\n\r\n                if (!result.success) {\r\n                  console.error('‚ùå Failed to trigger Subscription Pack workflow:', result.error)\r\n                } else {\r\n                  console.log('‚úÖ Subscription Pack workflow triggered successfully:', {\r\n                    investor: investorData.legal_name,\r\n                    workflow_run_id: result.workflow_run_id\r\n                  })\r\n\r\n                  // Handle n8n response with binary file\r\n                  if (result.n8n_response) {\r\n                    try {\r\n                      const n8nResponse = result.n8n_response\r\n                      console.log('üì¶ n8n response structure:', Object.keys(n8nResponse))\r\n                      console.log('üì¶ Full n8n response:', JSON.stringify(n8nResponse, null, 2))\r\n\r\n                      // Extract data for filename generation\r\n                      const entityCode = submission.deal?.vehicle?.entity_code || 'UNKNOWN'\r\n                      const investmentName = submission.deal?.vehicle?.investment_name || 'INVESTMENT'\r\n                      const investorName = submission.investor?.display_name || submission.investor?.legal_name || 'INVESTOR'\r\n                      const submittedAt = submission.submitted_at\r\n\r\n                      console.log('üìù Filename components:', { entityCode, investmentName, investorName, submittedAt })\r\n\r\n                      // Check if response contains binary file data\r\n                      let fileBuffer: Buffer\r\n                      let fileName: string\r\n                      let mimeType: string\r\n\r\n                      if (n8nResponse.binary) {\r\n                        // Binary buffer format (preferred - from triggerWorkflow binary handling)\r\n                        fileBuffer = Buffer.from(n8nResponse.binary)\r\n                        mimeType = n8nResponse.mimeType || 'application/pdf'\r\n                        const baseName = generateSubscriptionPackFilename(entityCode, investmentName, investorName, submittedAt)\r\n                        fileName = n8nResponse.filename || (baseName + getFileExtension(mimeType))\r\n                        console.log('‚úÖ Received binary data, buffer size:', fileBuffer.length, 'mimeType:', mimeType)\r\n                      } else if (n8nResponse.raw && typeof n8nResponse.raw === 'string' && n8nResponse.raw.length > 0) {\r\n                        // Binary wrapped in { raw: \"...\" } format (from triggerWorkflow text handling)\r\n                        // Use 'latin1' encoding to preserve binary data (1-to-1 byte mapping)\r\n                        fileBuffer = Buffer.from(n8nResponse.raw, 'latin1')\r\n                        // Detect PDF from file signature\r\n                        const sig = fileBuffer.slice(0, 4).toString('hex')\r\n                        mimeType = sig === '25504446' ? 'application/pdf' : 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'\r\n                        const baseName = generateSubscriptionPackFilename(entityCode, investmentName, investorName, submittedAt)\r\n                        fileName = baseName + getFileExtension(mimeType)\r\n                        console.log('‚úÖ Received binary data in raw format, buffer size:', fileBuffer.length, 'detected mimeType:', mimeType)\r\n                      } else if (n8nResponse.data) {\r\n                        // Base64 string format\r\n                        fileBuffer = Buffer.from(n8nResponse.data, 'base64')\r\n                        mimeType = n8nResponse.mimeType || 'application/pdf'\r\n                        const baseName = generateSubscriptionPackFilename(entityCode, investmentName, investorName, submittedAt)\r\n                        fileName = n8nResponse.filename || (baseName + getFileExtension(mimeType))\r\n                      } else if (typeof n8nResponse === 'string' && n8nResponse.length > 0) {\r\n                        // Direct string format (n8n returns binary as string)\r\n                        fileBuffer = Buffer.from(n8nResponse, 'latin1')\r\n                        // Detect PDF from file signature\r\n                        const sig = fileBuffer.slice(0, 4).toString('hex')\r\n                        mimeType = sig === '25504446' ? 'application/pdf' : 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'\r\n                        const baseName = generateSubscriptionPackFilename(entityCode, investmentName, investorName, submittedAt)\r\n                        fileName = baseName + getFileExtension(mimeType)\r\n                        console.log('‚úÖ Received binary data as string, buffer size:', fileBuffer.length, 'detected mimeType:', mimeType)\r\n                      } else {\r\n                        throw new Error('No binary data in n8n response')\r\n                      }\r\n\r\n                      // Verify file signature matches expected type\r\n                      const signature = fileBuffer.slice(0, 4).toString('hex')\r\n                      console.log('üìÑ Document file signature:', signature, '| Expected:', fileName.endsWith('.pdf') ? '25504446 (PDF)' : '504b0304 (DOCX)')\r\n\r\n                      const isPdf = signature === '25504446' // %PDF\r\n                      const isDocx = signature === '504b0304' // PK (ZIP)\r\n\r\n                      if (fileName.endsWith('.pdf') && !isPdf) {\r\n                        console.warn('‚ö†Ô∏è Warning: PDF file signature mismatch. Expected: 25504446, Got:', signature)\r\n                      } else if (fileName.endsWith('.docx') && !isDocx) {\r\n                        console.warn('‚ö†Ô∏è Warning: DOCX file signature mismatch. Expected: 504b0304, Got:', signature)\r\n                      } else {\r\n                        console.log('‚úÖ File signature valid for', fileName)\r\n                      }\r\n\r\n                      // Upload to Supabase Storage (deal-documents bucket)\r\n                      const fileKey = `subscriptions/${submission.id}/draft/${fileName}`\r\n                      const { error: uploadError } = await supabase.storage\r\n                        .from('deal-documents')\r\n                        .upload(fileKey, fileBuffer, {\r\n                          contentType: mimeType,\r\n                          upsert: false\r\n                        })\r\n\r\n                      if (uploadError) {\r\n                        console.error('‚ùå Failed to upload subscription pack:', uploadError)\r\n                      } else {\r\n                        console.log('‚úÖ Subscription pack uploaded to storage:', fileKey)\r\n\r\n                        // Look up the Subscription Documents folder for this vehicle\r\n                        let subscriptionFolderId: string | null = null\r\n                        if (submission.deal.vehicle_id) {\r\n                          const { data: subFolder } = await supabase\r\n                            .from('document_folders')\r\n                            .select('id')\r\n                            .eq('vehicle_id', submission.deal.vehicle_id)\r\n                            .eq('name', 'Subscription Documents')\r\n                            .single()\r\n                          subscriptionFolderId = subFolder?.id || null\r\n                        }\r\n\r\n                        // Create document record linked to both submission and subscription\r\n                        // Store countersigner info so we don't have to ask again at signing time\r\n                        const countersignerName = feeStructure?.issuer_signatory_name || 'Alexandre M√ºller'\r\n                        const countersignerTitle = feeStructure?.issuer_signatory_title || 'Authorized Signatory'\r\n\r\n                        const { data: docRecord, error: docError } = await supabase\r\n                          .from('documents')\r\n                          .insert({\r\n                            subscription_id: subscriptionId,\r\n                            subscription_submission_id: submission.id,\r\n                            deal_id: submission.deal_id,\r\n                            vehicle_id: submission.deal.vehicle_id,\r\n                            folder_id: subscriptionFolderId,\r\n                            type: 'subscription_draft',\r\n                            name: `Subscription Pack (Draft) - ${investmentName} - ${investorName}`,\r\n                            file_key: fileKey,\r\n                            mime_type: mimeType,\r\n                            file_size_bytes: fileBuffer.length,\r\n                            status: 'draft',\r\n                            current_version: 1,\r\n                            created_by: user.id,\r\n                            // Countersigner info - stored at generation time, read at signing time\r\n                            countersigner_type: 'ceo',\r\n                            countersigner_name: countersignerName,\r\n                            countersigner_title: countersignerTitle\r\n                          })\r\n                          .select()\r\n                          .single()\r\n\r\n                        if (docError) {\r\n                          console.error('‚ùå Failed to create document record:', docError)\r\n                        } else {\r\n                          console.log('‚úÖ Subscription pack document created:', docRecord.id)\r\n\r\n                          const packGeneratedAt = new Date().toISOString()\r\n                          await supabase\r\n                            .from('subscriptions')\r\n                            .update({ pack_generated_at: packGeneratedAt })\r\n                            .eq('id', subscriptionId)\r\n                            .is('pack_generated_at', null)\r\n\r\n                          // Update workflow_run with document_id in output_data\r\n                          await supabase\r\n                            .from('workflow_runs')\r\n                            .update({\r\n                              output_data: {\r\n                                ...result.n8n_response,\r\n                                document_id: docRecord.id,\r\n                                file_key: fileKey\r\n                              }\r\n                            })\r\n                            .eq('id', result.workflow_run_id)\r\n                        }\r\n                      }\r\n                    } catch (docError) {\r\n                      console.error('‚ùå Error processing subscription pack document:', docError)\r\n                      // Don't fail the approval if document processing fails\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            } catch (workflowError) {\r\n              console.error('Error triggering Subscription Pack workflow:', workflowError)\r\n              // Don't fail the approval if workflow trigger fails\r\n            }\r\n\r\n          return {\r\n            success: true,\r\n            notificationData: {\r\n              type: 'subscription_approved',\r\n              deal_name: submission.deal.name,\r\n              amount: amount\r\n            }\r\n          }\r\n        }\r\n        break\r\n\r\n      case 'commission_invoice': {\r\n        const commissionType = metadata.commission_type\r\n        const commissionConfig: Record<string, { table: string }> = {\r\n          introducer: { table: 'introducer_commissions' },\r\n          partner: { table: 'partner_commissions' },\r\n          'commercial-partner': { table: 'commercial_partner_commissions' },\r\n          commercial_partner: { table: 'commercial_partner_commissions' },\r\n        }\r\n\r\n        const config = commissionConfig[commissionType]\r\n        if (!config) {\r\n          return { success: false, error: `Unsupported commission type: ${commissionType}` }\r\n        }\r\n\r\n        const { data: commission, error: commissionError } = await supabase\r\n          .from(config.table)\r\n          .select('id, status')\r\n          .eq('id', entityId)\r\n          .single()\r\n\r\n        if (commissionError || !commission) {\r\n          return { success: false, error: 'Commission not found' }\r\n        }\r\n\r\n        if (commission.status !== 'invoice_submitted') {\r\n          return { success: false, error: `Commission status must be invoice_submitted (current: ${commission.status})` }\r\n        }\r\n\r\n        const { error: updateError } = await supabase\r\n          .from(config.table)\r\n          .update({\r\n            status: 'invoiced',\r\n            approved_by: actorId,\r\n            approved_at: new Date().toISOString(),\r\n            rejection_reason: null,\r\n            rejected_by: null,\r\n            rejected_at: null,\r\n            updated_at: new Date().toISOString()\r\n          })\r\n          .eq('id', entityId)\r\n\r\n        if (updateError) {\r\n          console.error('Error approving commission invoice:', updateError)\r\n          return { success: false, error: 'Failed to approve commission invoice' }\r\n        }\r\n        break\r\n      }\r\n\r\n      case 'document':\r\n        // Update document status\r\n        const { error: docError } = await supabase\r\n          .from('documents')\r\n          .update({\r\n            status: 'approved',\r\n            approved_by: actorId,\r\n            approved_at: new Date().toISOString()\r\n          })\r\n          .eq('id', entityId)\r\n\r\n        if (docError) {\r\n          console.error('Error approving document:', docError)\r\n          return { success: false, error: 'Failed to approve document' }\r\n        }\r\n        break\r\n\r\n      case 'wire_instruction':\r\n        // Update wire instruction status\r\n        const { error: wireError } = await supabase\r\n          .from('wire_instructions')\r\n          .update({\r\n            status: 'approved',\r\n            approved_by: actorId,\r\n            approved_at: new Date().toISOString()\r\n          })\r\n          .eq('id', entityId)\r\n\r\n        if (wireError) {\r\n          console.error('Error approving wire instruction:', wireError)\r\n          return { success: false, error: 'Failed to approve wire instruction' }\r\n        }\r\n        break\r\n\r\n      case 'sale_request':\r\n        // Approve investor sale request - updates status to 'approved'\r\n        // CEO can then work on finding a buyer\r\n        const { error: saleApproveError } = await supabase\r\n          .from('investor_sale_requests')\r\n          .update({\r\n            status: 'approved',\r\n            approved_at: new Date().toISOString()\r\n          })\r\n          .eq('id', entityId)\r\n\r\n        if (saleApproveError) {\r\n          console.error('Error approving sale request:', saleApproveError)\r\n          return { success: false, error: 'Failed to approve sale request' }\r\n        }\r\n\r\n        console.log('Sale request approved:', entityId)\r\n        break\r\n\r\n      case 'gdpr_deletion_request':\r\n        // GDPR Article 17 - Right to Erasure\r\n        // Soft-delete user data and anonymize records\r\n        const userId = entityId // entityId is the user_id for GDPR requests\r\n\r\n        // Get user profile for audit\r\n        const { data: userProfile } = await supabase\r\n          .from('profiles')\r\n          .select('email, display_name')\r\n          .eq('id', userId)\r\n          .single()\r\n\r\n        if (!userProfile) {\r\n          return { success: false, error: 'User profile not found' }\r\n        }\r\n\r\n        const anonymizedEmail = `deleted_${userId.substring(0, 8)}@anonymized.local`\r\n        const anonymizedName = `Deleted User ${userId.substring(0, 8)}`\r\n\r\n        // 1. Anonymize profile (soft delete)\r\n        const { error: profileAnonymizeError } = await supabase\r\n          .from('profiles')\r\n          .update({\r\n            display_name: anonymizedName,\r\n            full_name: anonymizedName,\r\n            email: anonymizedEmail,\r\n            phone: null,\r\n            avatar_url: null,\r\n            is_active: false,\r\n            metadata: {\r\n              gdpr_deleted: true,\r\n              deleted_at: new Date().toISOString(),\r\n              original_email_hash: Buffer.from(userProfile.email || '').toString('base64').substring(0, 16),\r\n              approved_by: actorId\r\n            }\r\n          })\r\n          .eq('id', userId)\r\n\r\n        if (profileAnonymizeError) {\r\n          console.error('Error anonymizing profile:', profileAnonymizeError)\r\n          return { success: false, error: 'Failed to anonymize profile' }\r\n        }\r\n\r\n        // 2. Anonymize investor record if exists\r\n        const { data: investorUser } = await supabase\r\n          .from('investor_users')\r\n          .select('investor_id')\r\n          .eq('user_id', userId)\r\n          .single()\r\n\r\n        if (investorUser?.investor_id) {\r\n          await supabase\r\n            .from('investors')\r\n            .update({\r\n              legal_name: anonymizedName,\r\n              display_name: anonymizedName,\r\n              email: anonymizedEmail,\r\n              phone: null,\r\n              registered_address: null,\r\n              representative_name: null,\r\n              is_deleted: true,\r\n              deleted_at: new Date().toISOString()\r\n            })\r\n            .eq('id', investorUser.investor_id)\r\n        }\r\n\r\n        // 3. Clear notifications for this user\r\n        await supabase\r\n          .from('investor_notifications')\r\n          .delete()\r\n          .eq('user_id', userId)\r\n\r\n        // 4. Anonymize audit logs actor name (keep logs for compliance but anonymize)\r\n        await supabase\r\n          .from('audit_logs')\r\n          .update({\r\n            action_details: supabase.rpc('jsonb_set', {\r\n              target: 'action_details',\r\n              path: '{actor_anonymized}',\r\n              value: '\"true\"'\r\n            })\r\n          })\r\n          .eq('actor_id', userId)\r\n\r\n        // 5. Notify the user that deletion is complete\r\n        // (They may still have access briefly until session expires)\r\n        console.log('GDPR deletion completed for user:', userId)\r\n\r\n        // Create audit log for GDPR deletion\r\n        await auditLogger.log({\r\n          actor_user_id: actorId,\r\n          action: 'gdpr_deletion_completed',\r\n          entity: 'profile',\r\n          entity_id: userId,\r\n          metadata: {\r\n            original_email_hash: Buffer.from(userProfile.email || '').toString('base64').substring(0, 16),\r\n            approval_id: approval.id,\r\n            gdpr_article: '17'\r\n          }\r\n        })\r\n\r\n        return {\r\n          success: true,\r\n          notificationData: {\r\n            type: 'gdpr_deletion_completed',\r\n            user_id: userId\r\n          }\r\n        }\r\n\r\n      case 'arranger_profile_update':\r\n        // Apply arranger profile update changes\r\n        const requestedChanges = metadata.requested_changes || {}\r\n        const arrangerEntityId = entityId\r\n\r\n        // Build update object with only provided fields\r\n        // Note: arranger_entities uses email/phone/address (not contact_email/contact_phone)\r\n        const arrangerUpdates: Record<string, any> = {}\r\n        if (requestedChanges.email) arrangerUpdates.email = requestedChanges.email\r\n        if (requestedChanges.phone) arrangerUpdates.phone = requestedChanges.phone\r\n        if (requestedChanges.address) arrangerUpdates.address = requestedChanges.address\r\n\r\n        if (Object.keys(arrangerUpdates).length > 0) {\r\n          arrangerUpdates.updated_at = new Date().toISOString()\r\n\r\n          const { error: arrangerUpdateError } = await supabase\r\n            .from('arranger_entities')\r\n            .update(arrangerUpdates)\r\n            .eq('id', arrangerEntityId)\r\n\r\n          if (arrangerUpdateError) {\r\n            console.error('Error updating arranger profile:', arrangerUpdateError)\r\n            return { success: false, error: 'Failed to update arranger profile' }\r\n          }\r\n        }\r\n\r\n        // Notify the arranger who requested the update\r\n        if (approval.requested_by) {\r\n          await supabase.from('investor_notifications').insert({\r\n            user_id: approval.requested_by,\r\n            investor_id: null,\r\n            title: 'Profile Update Approved',\r\n            message: 'Your profile update request has been approved and applied.',\r\n            link: '/versotech_main/arranger-profile',\r\n          })\r\n        }\r\n\r\n        return {\r\n          success: true,\r\n          notificationData: {\r\n            type: 'arranger_profile_updated',\r\n            arranger_id: arrangerEntityId\r\n          }\r\n        }\r\n\r\n      case 'member_invitation':\r\n        // CEO approved member invitation - now send the actual invitation email\r\n        const invitationId = entityId\r\n\r\n        // Get the invitation details\r\n        const { data: invitation, error: inviteFetchError } = await supabase\r\n          .from('member_invitations')\r\n          .select('*')\r\n          .eq('id', invitationId)\r\n          .single()\r\n\r\n        if (inviteFetchError || !invitation) {\r\n          console.error('Error fetching invitation:', inviteFetchError)\r\n          return { success: false, error: 'Member invitation not found' }\r\n        }\r\n\r\n        if (invitation.status !== 'pending_approval') {\r\n          return { success: false, error: 'Invitation is not pending approval' }\r\n        }\r\n\r\n        // Update invitation status to 'pending' (ready for acceptance)\r\n        // Reset expiry to 7 days from now since approval may have taken time\r\n        const newExpiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()\r\n        const sentAt = new Date().toISOString()\r\n\r\n        const { error: inviteUpdateError } = await supabase\r\n          .from('member_invitations')\r\n          .update({\r\n            status: 'pending',\r\n            expires_at: newExpiresAt,\r\n            sent_at: sentAt,\r\n            reminder_count: 0,\r\n            last_reminded_at: null\r\n          })\r\n          .eq('id', invitationId)\r\n\r\n        if (inviteUpdateError) {\r\n          console.error('Error updating invitation status:', inviteUpdateError)\r\n          return { success: false, error: 'Failed to update invitation status' }\r\n        }\r\n\r\n        // Send the invitation email\r\n        const acceptUrl = `${getAppUrl()}/invitation/accept?token=${invitation.invitation_token}`\r\n\r\n        console.log('[member_invitation] Sending invitation email:', {\r\n          email: invitation.email,\r\n          entityName: invitation.entity_name,\r\n          acceptUrl: acceptUrl\r\n        })\r\n\r\n        const emailResult = await sendInvitationEmail({\r\n          email: invitation.email,\r\n          inviteeName: undefined,\r\n          entityName: invitation.entity_name || metadata.entity_name || 'the organization',\r\n          entityType: invitation.entity_type,\r\n          role: invitation.role,\r\n          inviterName: invitation.invited_by_name || 'A team member',\r\n          acceptUrl: acceptUrl,\r\n          expiresAt: newExpiresAt\r\n        })\r\n\r\n        if (!emailResult.success) {\r\n          console.error('[member_invitation] Failed to send invitation email:', emailResult.error)\r\n          // Log more details for debugging\r\n          console.error('[member_invitation] Email details:', {\r\n            to: invitation.email,\r\n            acceptUrl,\r\n            entityType: invitation.entity_type\r\n          })\r\n          // Don't fail - invitation is approved, email can be resent\r\n        } else {\r\n          console.log('[member_invitation] Email sent successfully:', emailResult.messageId)\r\n        }\r\n\r\n        // Notify the inviter that their invitation was approved\r\n        if (invitation.invited_by) {\r\n          await supabase.from('investor_notifications').insert({\r\n            user_id: invitation.invited_by,\r\n            title: 'Member Invitation Approved',\r\n            message: `Your invitation to ${invitation.email} has been approved and sent.`,\r\n            type: 'member_invitation_approved',\r\n            data: {\r\n              invitation_id: invitationId,\r\n              invitee_email: invitation.email,\r\n              entity_type: invitation.entity_type\r\n            }\r\n          })\r\n        }\r\n\r\n        console.log('‚úÖ Member invitation approved and email sent:', {\r\n          invitation_id: invitationId,\r\n          email: invitation.email,\r\n          entity_type: invitation.entity_type,\r\n          email_sent: emailResult.success\r\n        })\r\n\r\n        return {\r\n          success: true,\r\n          notificationData: {\r\n            type: 'member_invitation_approved',\r\n            invitation_id: invitationId,\r\n            email: invitation.email,\r\n            email_sent: emailResult.success\r\n          }\r\n        }\r\n\r\n      default:\r\n        console.log(`No specific approval handler for entity type: ${entityType}`)\r\n    }\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error('Entity approval handler error:', error)\r\n    return { success: false, error: 'Failed to process entity approval' }\r\n  }\r\n}\r\n\r\n// Handle entity-specific rejection actions\r\nasync function handleEntityRejection(\r\n  supabase: any,\r\n  approval: any,\r\n  reason: string,\r\n  actorId: string\r\n): Promise<void> {\r\n  try {\r\n    const entityType = approval.entity_type\r\n    const entityId = approval.entity_id\r\n\r\n    // REMOVED: 'deal_commitment' case - table deleted\r\n\r\n    if (entityType === 'deal_interest') {\r\n      await supabase\r\n        .from('investor_deal_interest')\r\n        .update({\r\n          status: 'rejected',\r\n          rejection_reason: reason,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', entityId)\r\n    }\r\n\r\n    if (entityType === 'deal_subscription') {\r\n      await supabase\r\n        .from('deal_subscription_submissions')\r\n        .update({\r\n          status: 'rejected',\r\n          rejection_reason: reason,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', entityId)\r\n    }\r\n\r\n    if (entityType === 'investor_onboarding') {\r\n      await supabase\r\n        .from('investors')\r\n        .update({\r\n          kyc_status: 'rejected',\r\n          kyc_rejected_reason: reason,\r\n          kyc_rejected_at: new Date().toISOString()\r\n        })\r\n        .eq('id', entityId)\r\n    }\r\n\r\n    if (entityType === 'allocation') {\r\n      await supabase\r\n        .from('allocations')\r\n        .update({\r\n          status: 'rejected',\r\n          rejection_reason: reason\r\n        })\r\n        .eq('id', entityId)\r\n    }\r\n\r\n    if (entityType === 'deal_close') {\r\n      // No side effects on rejection; deal remains open until re-approved.\r\n      return\r\n    }\r\n\r\n    if (entityType === 'termsheet_close') {\r\n      // No side effects on rejection; termsheet remains unprocessed until re-approved.\r\n      // A new approval can be created by the cron job or manually.\r\n      return\r\n    }\r\n\r\n    if (entityType === 'sale_request') {\r\n      await supabase\r\n        .from('investor_sale_requests')\r\n        .update({\r\n          status: 'rejected',\r\n          rejection_reason: reason,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', entityId)\r\n    }\r\n\r\n    if (entityType === 'gdpr_deletion_request') {\r\n      // Notify user their deletion request was rejected\r\n      await supabase\r\n        .from('investor_notifications')\r\n        .insert({\r\n          user_id: entityId, // entityId is the user_id for GDPR requests\r\n          title: 'Deletion Request Rejected',\r\n          message: `Your account deletion request was rejected. Reason: ${reason || 'No reason provided'}`,\r\n          type: 'gdpr_request_rejected',\r\n          metadata: {\r\n            approval_id: approval.id,\r\n            rejection_reason: reason\r\n          }\r\n        })\r\n    }\r\n\r\n    if (entityType === 'arranger_profile_update') {\r\n      // Notify arranger their profile update was rejected\r\n      if (approval.requested_by) {\r\n        await supabase.from('investor_notifications').insert({\r\n          user_id: approval.requested_by,\r\n          investor_id: null,\r\n          title: 'Profile Update Rejected',\r\n          message: `Your profile update request was rejected. ${reason ? `Reason: ${reason}` : ''}`,\r\n          link: '/versotech_main/arranger-profile',\r\n        })\r\n      }\r\n    }\r\n\r\n    if (entityType === 'member_invitation') {\r\n      // Update invitation status to 'rejected'\r\n      await supabase\r\n        .from('member_invitations')\r\n        .update({\r\n          status: 'rejected'\r\n        })\r\n        .eq('id', entityId)\r\n\r\n      // Notify the inviter that their invitation was rejected\r\n      if (approval.requested_by) {\r\n        const metadata = approval.entity_metadata || {}\r\n        await supabase.from('investor_notifications').insert({\r\n          user_id: approval.requested_by,\r\n          title: 'Member Invitation Rejected',\r\n          message: `Your invitation to ${metadata.email || 'the user'} was rejected. ${reason ? `Reason: ${reason}` : ''}`,\r\n          type: 'member_invitation_rejected',\r\n          metadata: {\r\n            invitation_id: entityId,\r\n            invitee_email: metadata.email,\r\n            entity_type: metadata.entity_type,\r\n            rejection_reason: reason\r\n          }\r\n        })\r\n      }\r\n    }\r\n\r\n    if (entityType === 'commission_invoice') {\r\n      const metadata = approval.entity_metadata || {}\r\n      const commissionType = metadata.commission_type\r\n      const commissionConfig: Record<string, { table: string; userTable: string; entityIdField: string; notificationType: string }> = {\r\n        introducer: {\r\n          table: 'introducer_commissions',\r\n          userTable: 'introducer_users',\r\n          entityIdField: 'introducer_id',\r\n          notificationType: 'introducer_invoice_rejected',\r\n        },\r\n        partner: {\r\n          table: 'partner_commissions',\r\n          userTable: 'partner_users',\r\n          entityIdField: 'partner_id',\r\n          notificationType: 'partner_rejected',\r\n        },\r\n        'commercial-partner': {\r\n          table: 'commercial_partner_commissions',\r\n          userTable: 'commercial_partner_users',\r\n          entityIdField: 'commercial_partner_id',\r\n          notificationType: 'cp_invoice_rejected',\r\n        },\r\n        commercial_partner: {\r\n          table: 'commercial_partner_commissions',\r\n          userTable: 'commercial_partner_users',\r\n          entityIdField: 'commercial_partner_id',\r\n          notificationType: 'cp_invoice_rejected',\r\n        },\r\n      }\r\n\r\n      const config = commissionConfig[commissionType]\r\n      if (!config) {\r\n        console.error('Unsupported commission type in rejection:', commissionType)\r\n        return\r\n      }\r\n\r\n      // Update commission status to rejected\r\n      await supabase\r\n        .from(config.table)\r\n        .update({\r\n          status: 'rejected',\r\n          rejection_reason: reason || null,\r\n          rejected_by: actorId,\r\n          rejected_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('id', entityId)\r\n\r\n      // Send rejection notification to entity users\r\n      // Fetch commission to get entity_id for user lookup\r\n      const { data: commission } = await supabase\r\n        .from(config.table)\r\n        .select('*')\r\n        .eq('id', entityId)\r\n        .single()\r\n\r\n      if (commission) {\r\n        const commissionEntityId = commission[config.entityIdField]\r\n        const { data: entityUsers } = await supabase\r\n          .from(config.userTable)\r\n          .select('user_id')\r\n          .eq(config.entityIdField, commissionEntityId)\r\n\r\n        if (entityUsers && entityUsers.length > 0) {\r\n          const formattedAmount = metadata.amount && metadata.currency\r\n            ? new Intl.NumberFormat('en-US', {\r\n                style: 'currency',\r\n                currency: metadata.currency,\r\n              }).format(metadata.amount)\r\n            : 'your commission'\r\n\r\n          const notifications = entityUsers.map((eu: { user_id: string }) => ({\r\n            user_id: eu.user_id,\r\n            investor_id: null,\r\n            title: 'Invoice Requires Changes',\r\n            message: `Your invoice for ${formattedAmount} was rejected.${reason ? ` Reason: ${reason}` : ''} Please resubmit with corrections.`,\r\n            link: '/versotech_main/my-commissions',\r\n            type: config.notificationType,\r\n          }))\r\n\r\n          await supabase.from('investor_notifications').insert(notifications)\r\n          console.log('[rejection] Sent', notifications.length, 'rejection notifications for', commissionType)\r\n        }\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error('Entity rejection handler error:', error)\r\n    // Don't fail the rejection, just log\r\n  }\r\n}\r\n\r\nexport async function DELETE(\r\n  request: Request,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const { id } = await params\r\n    await requireStaffAuth()\r\n    const supabase = await createClient()\r\n\r\n    // Soft delete the approval\r\n    const { error } = await supabase\r\n      .from('approvals')\r\n      .update({\r\n        deleted_at: new Date().toISOString()\r\n      })\r\n      .eq('id', id)\r\n\r\n    if (error) {\r\n      console.error('Approval deletion error:', error)\r\n      return NextResponse.json(\r\n        { error: 'Failed to delete approval' },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    return NextResponse.json({ success: true })\r\n  } catch (error) {\r\n    console.error('Approval deletion error:', error)\r\n    return NextResponse.json(\r\n      { error: 'Internal server error' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n","import { AppRouteRouteModule } from \"next/dist/esm/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/esm/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/esm/server/lib/patch-fetch\";\nimport { addRequestMeta, getRequestMeta } from \"next/dist/esm/server/request-meta\";\nimport { getTracer, SpanKind } from \"next/dist/esm/server/lib/trace/tracer\";\nimport { setManifestsSingleton } from \"next/dist/esm/server/app-render/manifests-singleton\";\nimport { normalizeAppPath } from \"next/dist/esm/shared/lib/router/utils/app-paths\";\nimport { NodeNextRequest, NodeNextResponse } from \"next/dist/esm/server/base-http/node\";\nimport { NextRequestAdapter, signalFromNodeResponse } from \"next/dist/esm/server/web/spec-extension/adapters/next-request\";\nimport { BaseServerSpan } from \"next/dist/esm/server/lib/trace/constants\";\nimport { getRevalidateReason } from \"next/dist/esm/server/instrumentation/utils\";\nimport { sendResponse } from \"next/dist/esm/server/send-response\";\nimport { fromNodeOutgoingHttpHeaders, toNodeOutgoingHttpHeaders } from \"next/dist/esm/server/web/utils\";\nimport { getCacheControlHeader } from \"next/dist/esm/server/lib/cache-control\";\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from \"next/dist/esm/lib/constants\";\nimport { NoFallbackError } from \"next/dist/esm/shared/lib/no-fallback-error.external\";\nimport { CachedRouteKind } from \"next/dist/esm/server/response-cache\";\nimport * as userland from \"INNER_APP_ROUTE\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/approvals/[id]/action/route\",\n        pathname: \"/api/approvals/[id]/action\",\n        filename: \"route\",\n        bundlePath: \"\"\n    },\n    distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n    relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n    resolvedPagePath: \"[project]/versotech-portal/src/app/api/approvals/[id]/action/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\nexport async function handler(req, res, ctx) {\n    if (routeModule.isDev) {\n        addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint());\n    }\n    let srcPage = \"/api/approvals/[id]/action/route\";\n    // turbopack doesn't normalize `/index` in the page name\n    // so we need to to process dynamic routes properly\n    // TODO: fix turbopack providing differing value from webpack\n    if (process.env.TURBOPACK) {\n        srcPage = srcPage.replace(/\\/index$/, '') || '/';\n    } else if (srcPage === '/index') {\n        // we always normalize /index specifically\n        srcPage = '/';\n    }\n    const multiZoneDraftMode = process.env.__NEXT_MULTI_ZONE_DRAFT_MODE;\n    const prepareResult = await routeModule.prepare(req, res, {\n        srcPage,\n        multiZoneDraftMode\n    });\n    if (!prepareResult) {\n        res.statusCode = 400;\n        res.end('Bad Request');\n        ctx.waitUntil == null ? void 0 : ctx.waitUntil.call(ctx, Promise.resolve());\n        return null;\n    }\n    const { buildId, params, nextConfig, parsedUrl, isDraftMode, prerenderManifest, routerServerContext, isOnDemandRevalidate, revalidateOnlyGenerated, resolvedPathname, clientReferenceManifest, serverActionsManifest } = prepareResult;\n    const normalizedSrcPage = normalizeAppPath(srcPage);\n    let isIsr = Boolean(prerenderManifest.dynamicRoutes[normalizedSrcPage] || prerenderManifest.routes[resolvedPathname]);\n    const render404 = async ()=>{\n        // TODO: should route-module itself handle rendering the 404\n        if (routerServerContext == null ? void 0 : routerServerContext.render404) {\n            await routerServerContext.render404(req, res, parsedUrl, false);\n        } else {\n            res.end('This page could not be found');\n        }\n        return null;\n    };\n    if (isIsr && !isDraftMode) {\n        const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname]);\n        const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage];\n        if (prerenderInfo) {\n            if (prerenderInfo.fallback === false && !isPrerendered) {\n                if (nextConfig.experimental.adapterPath) {\n                    return await render404();\n                }\n                throw new NoFallbackError();\n            }\n        }\n    }\n    let cacheKey = null;\n    if (isIsr && !routeModule.isDev && !isDraftMode) {\n        cacheKey = resolvedPathname;\n        // ensure /index and / is normalized to one key\n        cacheKey = cacheKey === '/index' ? '/' : cacheKey;\n    }\n    const supportsDynamicResponse = // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true || // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr;\n    // This is a revalidation request if the request is for a static\n    // page and it is not being resumed from a postponed render and\n    // it is not a dynamic RSC request then it is a revalidation\n    // request.\n    const isStaticGeneration = isIsr && !supportsDynamicResponse;\n    // Before rendering (which initializes component tree modules), we have to\n    // set the reference manifests to our global store so Server Action's\n    // encryption util can access to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n        setManifestsSingleton({\n            page: srcPage,\n            clientReferenceManifest,\n            serverActionsManifest\n        });\n    }\n    const method = req.method || 'GET';\n    const tracer = getTracer();\n    const activeSpan = tracer.getActiveScopeSpan();\n    const context = {\n        params,\n        prerenderManifest,\n        renderOpts: {\n            experimental: {\n                authInterrupts: Boolean(nextConfig.experimental.authInterrupts)\n            },\n            cacheComponents: Boolean(nextConfig.cacheComponents),\n            supportsDynamicResponse,\n            incrementalCache: getRequestMeta(req, 'incrementalCache'),\n            cacheLifeProfiles: nextConfig.cacheLife,\n            waitUntil: ctx.waitUntil,\n            onClose: (cb)=>{\n                res.on('close', cb);\n            },\n            onAfterTaskError: undefined,\n            onInstrumentationRequestError: (error, _request, errorContext, silenceLog)=>routeModule.onRequestError(req, error, errorContext, silenceLog, routerServerContext)\n        },\n        sharedContext: {\n            buildId\n        }\n    };\n    const nodeNextReq = new NodeNextRequest(req);\n    const nodeNextRes = new NodeNextResponse(res);\n    const nextReq = NextRequestAdapter.fromNodeNextRequest(nodeNextReq, signalFromNodeResponse(res));\n    try {\n        const invokeRouteModule = async (span)=>{\n            return routeModule.handle(nextReq, context).finally(()=>{\n                if (!span) return;\n                span.setAttributes({\n                    'http.status_code': res.statusCode,\n                    'next.rsc': false\n                });\n                const rootSpanAttributes = tracer.getRootSpanAttributes();\n                // We were unable to get attributes, probably OTEL is not enabled\n                if (!rootSpanAttributes) {\n                    return;\n                }\n                if (rootSpanAttributes.get('next.span_type') !== BaseServerSpan.handleRequest) {\n                    console.warn(`Unexpected root span type '${rootSpanAttributes.get('next.span_type')}'. Please report this Next.js issue https://github.com/vercel/next.js`);\n                    return;\n                }\n                const route = rootSpanAttributes.get('next.route');\n                if (route) {\n                    const name = `${method} ${route}`;\n                    span.setAttributes({\n                        'next.route': route,\n                        'http.route': route,\n                        'next.span_name': name\n                    });\n                    span.updateName(name);\n                } else {\n                    span.updateName(`${method} ${srcPage}`);\n                }\n            });\n        };\n        const isMinimalMode = Boolean(process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode'));\n        const handleResponse = async (currentSpan)=>{\n            var _cacheEntry_value;\n            const responseGenerator = async ({ previousCacheEntry })=>{\n                try {\n                    if (!isMinimalMode && isOnDemandRevalidate && revalidateOnlyGenerated && !previousCacheEntry) {\n                        res.statusCode = 404;\n                        // on-demand revalidate always sets this header\n                        res.setHeader('x-nextjs-cache', 'REVALIDATED');\n                        res.end('This page could not be found');\n                        return null;\n                    }\n                    const response = await invokeRouteModule(currentSpan);\n                    req.fetchMetrics = context.renderOpts.fetchMetrics;\n                    let pendingWaitUntil = context.renderOpts.pendingWaitUntil;\n                    // Attempt using provided waitUntil if available\n                    // if it's not we fallback to sendResponse's handling\n                    if (pendingWaitUntil) {\n                        if (ctx.waitUntil) {\n                            ctx.waitUntil(pendingWaitUntil);\n                            pendingWaitUntil = undefined;\n                        }\n                    }\n                    const cacheTags = context.renderOpts.collectedTags;\n                    // If the request is for a static response, we can cache it so long\n                    // as it's not edge.\n                    if (isIsr) {\n                        const blob = await response.blob();\n                        // Copy the headers from the response.\n                        const headers = toNodeOutgoingHttpHeaders(response.headers);\n                        if (cacheTags) {\n                            headers[NEXT_CACHE_TAGS_HEADER] = cacheTags;\n                        }\n                        if (!headers['content-type'] && blob.type) {\n                            headers['content-type'] = blob.type;\n                        }\n                        const revalidate = typeof context.renderOpts.collectedRevalidate === 'undefined' || context.renderOpts.collectedRevalidate >= INFINITE_CACHE ? false : context.renderOpts.collectedRevalidate;\n                        const expire = typeof context.renderOpts.collectedExpire === 'undefined' || context.renderOpts.collectedExpire >= INFINITE_CACHE ? undefined : context.renderOpts.collectedExpire;\n                        // Create the cache entry for the response.\n                        const cacheEntry = {\n                            value: {\n                                kind: CachedRouteKind.APP_ROUTE,\n                                status: response.status,\n                                body: Buffer.from(await blob.arrayBuffer()),\n                                headers\n                            },\n                            cacheControl: {\n                                revalidate,\n                                expire\n                            }\n                        };\n                        return cacheEntry;\n                    } else {\n                        // send response without caching if not ISR\n                        await sendResponse(nodeNextReq, nodeNextRes, response, context.renderOpts.pendingWaitUntil);\n                        return null;\n                    }\n                } catch (err) {\n                    // if this is a background revalidate we need to report\n                    // the request error here as it won't be bubbled\n                    if (previousCacheEntry == null ? void 0 : previousCacheEntry.isStale) {\n                        const silenceLog = false;\n                        await routeModule.onRequestError(req, err, {\n                            routerKind: 'App Router',\n                            routePath: srcPage,\n                            routeType: 'route',\n                            revalidateReason: getRevalidateReason({\n                                isStaticGeneration,\n                                isOnDemandRevalidate\n                            })\n                        }, silenceLog, routerServerContext);\n                    }\n                    throw err;\n                }\n            };\n            const cacheEntry = await routeModule.handleResponse({\n                req,\n                nextConfig,\n                cacheKey,\n                routeKind: RouteKind.APP_ROUTE,\n                isFallback: false,\n                prerenderManifest,\n                isRoutePPREnabled: false,\n                isOnDemandRevalidate,\n                revalidateOnlyGenerated,\n                responseGenerator,\n                waitUntil: ctx.waitUntil,\n                isMinimalMode\n            });\n            // we don't create a cacheEntry for ISR\n            if (!isIsr) {\n                return null;\n            }\n            if ((cacheEntry == null ? void 0 : (_cacheEntry_value = cacheEntry.value) == null ? void 0 : _cacheEntry_value.kind) !== CachedRouteKind.APP_ROUTE) {\n                var _cacheEntry_value1;\n                throw Object.defineProperty(new Error(`Invariant: app-route received invalid cache entry ${cacheEntry == null ? void 0 : (_cacheEntry_value1 = cacheEntry.value) == null ? void 0 : _cacheEntry_value1.kind}`), \"__NEXT_ERROR_CODE\", {\n                    value: \"E701\",\n                    enumerable: false,\n                    configurable: true\n                });\n            }\n            if (!isMinimalMode) {\n                res.setHeader('x-nextjs-cache', isOnDemandRevalidate ? 'REVALIDATED' : cacheEntry.isMiss ? 'MISS' : cacheEntry.isStale ? 'STALE' : 'HIT');\n            }\n            // Draft mode should never be cached\n            if (isDraftMode) {\n                res.setHeader('Cache-Control', 'private, no-cache, no-store, max-age=0, must-revalidate');\n            }\n            const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers);\n            if (!(isMinimalMode && isIsr)) {\n                headers.delete(NEXT_CACHE_TAGS_HEADER);\n            }\n            // If cache control is already set on the response we don't\n            // override it to allow users to customize it via next.config\n            if (cacheEntry.cacheControl && !res.getHeader('Cache-Control') && !headers.get('Cache-Control')) {\n                headers.set('Cache-Control', getCacheControlHeader(cacheEntry.cacheControl));\n            }\n            await sendResponse(nodeNextReq, nodeNextRes, // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n            new Response(cacheEntry.value.body, {\n                headers,\n                status: cacheEntry.value.status || 200\n            }));\n            return null;\n        };\n        // TODO: activeSpan code path is for when wrapped by\n        // next-server can be removed when this is no longer used\n        if (activeSpan) {\n            await handleResponse(activeSpan);\n        } else {\n            await tracer.withPropagatedContext(req.headers, ()=>tracer.trace(BaseServerSpan.handleRequest, {\n                    spanName: `${method} ${srcPage}`,\n                    kind: SpanKind.SERVER,\n                    attributes: {\n                        'http.method': method,\n                        'http.target': req.url\n                    }\n                }, handleResponse));\n        }\n    } catch (err) {\n        if (!(err instanceof NoFallbackError)) {\n            const silenceLog = false;\n            await routeModule.onRequestError(req, err, {\n                routerKind: 'App Router',\n                routePath: normalizedSrcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                    isStaticGeneration,\n                    isOnDemandRevalidate\n                })\n            }, silenceLog, routerServerContext);\n        }\n        // rethrow so that we can handle serving error page\n        // If this is during static generation, throw the error again.\n        if (isIsr) throw err;\n        // Otherwise, send a 500 response.\n        await sendResponse(nodeNextReq, nodeNextRes, new Response(null, {\n            status: 500\n        }));\n        return null;\n    }\n}\n\n//# sourceMappingURL=app-route.js.map\n","/**\r\n * Certificate Trigger Utility\r\n * Triggers certificate generation when subscription becomes active\r\n *\r\n * COMPREHENSIVE PAYLOAD: Sends ALL data n8n needs to generate the certificate\r\n * without requiring n8n to query the database.\r\n */\r\n\r\nimport { triggerWorkflow } from '@/lib/trigger-workflow'\r\nimport { convertHtmlToPdf } from '@/lib/gotenberg/convert'\r\nimport { SupabaseClient } from '@supabase/supabase-js'\r\nimport crypto from 'crypto'\r\n\r\ninterface TriggerCertificateParams {\r\n  supabase: SupabaseClient\r\n  subscriptionId: string\r\n  investorId: string\r\n  vehicleId: string\r\n  commitment: number\r\n  fundedAmount: number\r\n  shares?: number | null\r\n  pricePerShare?: number | null\r\n  profile: {\r\n    id: string\r\n    email?: string | null\r\n    display_name?: string | null\r\n    role?: string | null\r\n    title?: string | null\r\n  }\r\n}\r\n\r\n/**\r\n * Format date as \"Month Day, Year\" (e.g., \"December 16, 2025\")\r\n */\r\nfunction formatCertificateDate(date: Date): string {\r\n  return date.toLocaleDateString('en-US', {\r\n    year: 'numeric',\r\n    month: 'long',\r\n    day: 'numeric'\r\n  })\r\n}\r\n\r\n/**\r\n * Derive investor display name based on type\r\n * - Entity: use legal_name\r\n * - Individual: use \"First Last\" format\r\n */\r\nfunction getInvestorDisplayName(investor: {\r\n  type: string | null\r\n  legal_name: string | null\r\n  first_name: string | null\r\n  last_name: string | null\r\n}): string {\r\n  if (investor.type === 'individual') {\r\n    const firstName = investor.first_name?.trim() || ''\r\n    const lastName = investor.last_name?.trim() || ''\r\n    if (firstName || lastName) {\r\n      return `${firstName} ${lastName}`.trim()\r\n    }\r\n  }\r\n  return investor.legal_name || 'Unknown Investor'\r\n}\r\n\r\n/**\r\n * Triggers certificate generation for a newly activated subscription\r\n * This is a fire-and-forget operation - failures are logged but don't block the caller\r\n *\r\n * IDEMPOTENCY: Will skip if subscription already has activated_at set\r\n */\r\nexport async function triggerCertificateGeneration({\r\n  supabase,\r\n  subscriptionId,\r\n  investorId,\r\n  vehicleId,\r\n  commitment,\r\n  fundedAmount,\r\n  shares,\r\n  pricePerShare,\r\n  profile\r\n}: TriggerCertificateParams): Promise<void> {\r\n  try {\r\n    // IDEMPOTENCY CHECK: Fetch subscription with all related data needed for certificate\r\n    const { data: subscription, error: fetchError } = await supabase\r\n      .from('subscriptions')\r\n      .select(`\r\n        id,\r\n        status,\r\n        activated_at,\r\n        subscription_number,\r\n        units,\r\n        num_shares,\r\n        deal_id,\r\n        investor:investors!subscriptions_investor_id_fkey (\r\n          id,\r\n          legal_name,\r\n          type,\r\n          first_name,\r\n          last_name\r\n        ),\r\n        vehicle:vehicles!subscriptions_vehicle_id_fkey (\r\n          id,\r\n          name,\r\n          series_number,\r\n          registration_number,\r\n          logo_url,\r\n          address\r\n        ),\r\n        deal:deals!subscriptions_deal_id_fkey (\r\n          id,\r\n          name,\r\n          company_name,\r\n          close_at,\r\n          vehicle_id\r\n        )\r\n      `)\r\n      .eq('id', subscriptionId)\r\n      .single()\r\n\r\n    if (fetchError || !subscription) {\r\n      console.error(`‚ùå Subscription ${subscriptionId} not found:`, fetchError)\r\n      return\r\n    }\r\n\r\n    // IDEMPOTENCY: Check if certificate already exists for this subscription\r\n    // This prevents duplicate certificate generation on retry/re-run\r\n    const { data: existingCert } = await supabase\r\n      .from('documents')\r\n      .select('id')\r\n      .eq('subscription_id', subscriptionId)\r\n      .eq('type', 'certificate')\r\n      .limit(1)\r\n      .maybeSingle()\r\n\r\n    if (existingCert) {\r\n      console.log(`‚ÑπÔ∏è Certificate already exists for subscription ${subscriptionId} (doc: ${existingCert.id}), skipping`)\r\n      return\r\n    }\r\n\r\n    // Verify subscription status is 'active' or 'funded' (funded when called during activation)\r\n    if (!['active', 'funded'].includes(subscription.status)) {\r\n      console.warn(`‚ö†Ô∏è Cannot trigger certificate for subscription ${subscriptionId} - status is '${subscription.status}', expected 'active' or 'funded'`)\r\n      return\r\n    }\r\n\r\n    // Get vehicle data - prefer subscription.vehicle, fall back to deal.vehicle\r\n    // Type assertions needed due to Supabase query type inference treating joins as arrays\r\n    type VehicleType = { id: string; name: string; series_number: string; registration_number: string; logo_url: string | null; address: string | null }\r\n    let vehicleData = subscription.vehicle as unknown as VehicleType | null\r\n    const dealData = subscription.deal as unknown as { id: string; name: string; company_name: string; close_at: string; vehicle_id: string } | null\r\n    if (!vehicleData && dealData?.vehicle_id) {\r\n      const { data: dealVehicle } = await supabase\r\n        .from('vehicles')\r\n        .select('id, name, series_number, registration_number, logo_url, address')\r\n        .eq('id', dealData.vehicle_id)\r\n        .single()\r\n      vehicleData = dealVehicle as VehicleType | null\r\n    }\r\n\r\n    if (!vehicleData) {\r\n      console.error(`‚ùå No vehicle found for subscription ${subscriptionId}`)\r\n      return\r\n    }\r\n\r\n    // Fetch deal fee structure for product description (the \"structure\" field)\r\n    // Also fetch termsheet completion_date for the certificate date\r\n    let productDescription = ''\r\n    let termsheetCompletionDate: Date | null = null\r\n\r\n    if (subscription.deal_id) {\r\n      // First, try to get the termsheet linked to this subscription via deal_memberships\r\n      const { data: membership } = await supabase\r\n        .from('deal_memberships')\r\n        .select('term_sheet_id')\r\n        .eq('deal_id', subscription.deal_id)\r\n        .eq('investor_id', investorId)\r\n        .maybeSingle()\r\n\r\n      if (membership?.term_sheet_id) {\r\n        // Get the termsheet's completion_date and structure\r\n        const { data: termsheet } = await supabase\r\n          .from('deal_fee_structures')\r\n          .select('structure, completion_date')\r\n          .eq('id', membership.term_sheet_id)\r\n          .single()\r\n\r\n        if (termsheet) {\r\n          if (termsheet.structure) {\r\n            productDescription = termsheet.structure\r\n          }\r\n          if (termsheet.completion_date) {\r\n            termsheetCompletionDate = new Date(termsheet.completion_date)\r\n          }\r\n        }\r\n      }\r\n\r\n      // Fallback: if no termsheet found, get any published fee structure\r\n      if (!productDescription) {\r\n        const { data: feeStructure } = await supabase\r\n          .from('deal_fee_structures')\r\n          .select('structure, completion_date')\r\n          .eq('deal_id', subscription.deal_id)\r\n          .eq('status', 'published')\r\n          .order('created_at', { ascending: false })\r\n          .limit(1)\r\n          .maybeSingle()\r\n\r\n        if (feeStructure?.structure) {\r\n          productDescription = feeStructure.structure\r\n        }\r\n        if (!termsheetCompletionDate && feeStructure?.completion_date) {\r\n          termsheetCompletionDate = new Date(feeStructure.completion_date)\r\n        }\r\n      }\r\n    }\r\n\r\n    // NOTE: activated_at is set by the caller (handleTermsheetClose/handleDealClose)\r\n    // We no longer set it here to avoid the race condition where we'd skip certificate\r\n    // generation because activated_at was already set by our own caller.\r\n\r\n    // Build investor display name based on type\r\n    // Type assertion needed due to Supabase query type inference\r\n    type InvestorType = { type: string | null; legal_name: string | null; first_name: string | null; last_name: string | null }\r\n    const investorData = subscription.investor as unknown as InvestorType | null\r\n    const investorName = investorData\r\n      ? getInvestorDisplayName(investorData)\r\n      : 'Unknown Investor'\r\n\r\n    // Get certificate date: prefer termsheet completion_date, fall back to deal close_at, then today\r\n    const certificateDate = termsheetCompletionDate\r\n      || (dealData?.close_at ? new Date(dealData.close_at) : new Date())\r\n\r\n    // Determine logo type: VERSO Capital 2 uses text \"VERSO\" in League Spartan font\r\n    const isVersoCapital2 = vehicleData.name?.toLowerCase().includes('verso capital 2') || false\r\n\r\n    // Build comprehensive certificate payload\r\n    const certificatePayload = {\r\n      // === LOGO DATA ===\r\n      // VERSO Capital 2 uses \"VERSO\" text in League Spartan font, others use logo image\r\n      logo_type: isVersoCapital2 ? 'text' : 'image',\r\n      logo_text: isVersoCapital2 ? 'VERSO' : '',\r\n      logo_font: 'League Spartan',\r\n      vehicle_logo_url: !isVersoCapital2 ? (vehicleData.logo_url || '') : '',\r\n\r\n      // === CERTIFICATE NUMBER (format: VC{series_number}SH{subscription_number}) ===\r\n      series_number: vehicleData.series_number || '',\r\n      subscription_number: subscription.subscription_number || '',\r\n\r\n      // === UNITS/CERTIFICATES ===\r\n      units: subscription.units || subscription.num_shares || shares || 0,\r\n\r\n      // === DATE (TERMSHEET COMPLETION DATE - formatted as \"Month Day, Year\") ===\r\n      close_at: formatCertificateDate(certificateDate),\r\n\r\n      // === ISSUER SECTION DATA ===\r\n      vehicle_name: vehicleData.name || '',\r\n      company_name: dealData?.company_name || dealData?.name || '',\r\n      vehicle_registration_number: vehicleData.registration_number || '',\r\n\r\n      // === CERTIFICATION TEXT DATA ===\r\n      investor_name: investorName,\r\n      num_shares: subscription.num_shares || shares || 0,\r\n      structure: productDescription, // e.g., \"Shares of Series B Preferred Stock of X.AI\"\r\n\r\n      // === SIGNATURE TABLE DATA (NO SIGNATURE IMAGES - handled via VERSOSign) ===\r\n      vehicle_address: vehicleData.address || '',\r\n\r\n      // Signatory names/titles for the signature blocks (images added later via VERSOSign)\r\n      // Signatory 1 (LEFT) = CEO, signs first\r\n      signatory_1_name: 'Mr Julien Machot',\r\n      signatory_1_title: 'Managing Partner',\r\n      signatory_1_signature_url: '', // EMPTY - signatures added via VERSOSign\r\n\r\n      // Signatory 2 (RIGHT) = Second authorized signatory, signs after CEO\r\n      signatory_2_name: 'G.A. Giles', // For testing - will be lawyer in production\r\n      signatory_2_title: 'Authorized Signatory',\r\n      signatory_2_signature_url: '', // EMPTY - signatures added via VERSOSign\r\n\r\n      // === METADATA (useful for n8n workflow) ===\r\n      subscription_id: subscriptionId,\r\n      investor_id: investorId,\r\n      vehicle_id: vehicleId,\r\n      deal_id: subscription.deal_id || '',\r\n      commitment_amount: commitment,\r\n      funded_amount: fundedAmount,\r\n      price_per_share: pricePerShare || null,\r\n      certificate_date: certificateDate.toISOString().split('T')[0],\r\n      include_watermark: false // Activated subscriptions get clean certificates\r\n    }\r\n\r\n    console.log('üìú Triggering Certificate Generation:', {\r\n      subscription_id: subscriptionId,\r\n      investor: investorName,\r\n      certificate_number: `VC${vehicleData.series_number}SH${subscription.subscription_number}`,\r\n      units: certificatePayload.units,\r\n      logo_type: certificatePayload.logo_type,\r\n      close_at: certificatePayload.close_at,\r\n      vehicle_name: certificatePayload.vehicle_name,\r\n      company_name: certificatePayload.company_name\r\n    })\r\n\r\n    // Trigger certificate generation workflow\r\n    const result = await triggerWorkflow({\r\n      workflowKey: 'generate-investment-certificate',\r\n      payload: certificatePayload,\r\n      entityType: 'subscription',\r\n      entityId: subscriptionId,\r\n      user: {\r\n        id: profile.id,\r\n        email: profile.email || '',\r\n        displayName: profile.display_name || undefined,\r\n        role: profile.role || 'staff_admin',\r\n        title: profile.title || undefined\r\n      }\r\n    })\r\n\r\n    if (!result.success) {\r\n      console.warn(`‚ö†Ô∏è Certificate workflow not configured: ${result.error}`)\r\n    } else {\r\n      console.log(`‚úÖ Certificate generation triggered for subscription ${subscriptionId}`)\r\n\r\n      // === HANDLE PDF RESPONSE FROM N8N ===\r\n      // Same pattern as introducer agreement (generate-agreement/route.ts)\r\n      if (result.n8n_response) {\r\n        try {\r\n          const n8nResponse = result.n8n_response\r\n          console.log('üì¶ n8n certificate response keys:', Object.keys(n8nResponse))\r\n\r\n          // Extract PDF buffer from various response formats\r\n          let pdfBuffer: Buffer | null = null\r\n\r\n          if (n8nResponse.binary && Buffer.isBuffer(n8nResponse.binary)) {\r\n            // Direct buffer from trigger-workflow.ts binary handling (Content-Type: application/pdf)\r\n            pdfBuffer = n8nResponse.binary\r\n            console.log('üìÑ Found PDF in binary format (direct buffer)')\r\n          } else if (n8nResponse.data) {\r\n            // n8n \"data\" field - could be Buffer, base64 string, or raw binary string\r\n            if (Buffer.isBuffer(n8nResponse.data)) {\r\n              // Direct Buffer\r\n              pdfBuffer = n8nResponse.data\r\n              console.log('üìÑ Found PDF in data (Buffer) format')\r\n            } else if (typeof n8nResponse.data === 'string') {\r\n              // String - check if it's raw PDF or base64\r\n              if (n8nResponse.data.startsWith('%PDF')) {\r\n                // Raw PDF binary as string (latin1 encoding)\r\n                pdfBuffer = Buffer.from(n8nResponse.data, 'latin1')\r\n                console.log('üìÑ Found PDF in data (raw binary string) format')\r\n              } else {\r\n                // Assume base64-encoded\r\n                pdfBuffer = Buffer.from(n8nResponse.data, 'base64')\r\n                console.log('üìÑ Found PDF in data (base64) format')\r\n              }\r\n            }\r\n          } else if (n8nResponse.raw && typeof n8nResponse.raw === 'string') {\r\n            // Latin1-encoded string (when Content-Type not set correctly)\r\n            pdfBuffer = Buffer.from(n8nResponse.raw, 'latin1')\r\n            console.log('üìÑ Found PDF in raw (latin1) format')\r\n          } else if (typeof n8nResponse === 'string') {\r\n            // Direct string response\r\n            pdfBuffer = Buffer.from(n8nResponse, 'latin1')\r\n            console.log('üìÑ Found PDF as direct string')\r\n          } else if (n8nResponse.html && typeof n8nResponse.html === 'string') {\r\n            // n8n returned HTML instead of PDF - convert locally using Gotenberg\r\n            console.log('üìÑ n8n returned HTML, converting to PDF via portal Gotenberg...')\r\n            const conversionResult = await convertHtmlToPdf(n8nResponse.html, 'certificate.html')\r\n            if (conversionResult.success && conversionResult.pdfBuffer) {\r\n              pdfBuffer = conversionResult.pdfBuffer\r\n              console.log('‚úÖ HTML converted to PDF via portal Gotenberg')\r\n            } else {\r\n              console.error('‚ùå Portal Gotenberg conversion failed:', conversionResult.error)\r\n            }\r\n          }\r\n\r\n          if (pdfBuffer && pdfBuffer.length > 0) {\r\n            // Verify PDF signature (PDF files start with %PDF)\r\n            const signature = pdfBuffer.slice(0, 4).toString()\r\n            console.log('üìÑ File signature:', signature, 'size:', pdfBuffer.length, 'bytes')\r\n\r\n            if (signature !== '%PDF') {\r\n              console.warn('‚ö†Ô∏è File does not appear to be a valid PDF (signature:', signature, ')')\r\n            }\r\n\r\n            // === NAMING PATTERN: VCXXXSHXXX - LASTNAME FIRSTNAME or ENTITY NAME ===\r\n            // Format investor name based on type\r\n            let formattedInvestorName: string\r\n            if (investorData?.type === 'individual') {\r\n              // For individuals: LASTNAME FIRSTNAME (uppercase)\r\n              const lastName = (investorData.last_name || '').trim().toUpperCase()\r\n              const firstName = (investorData.first_name || '').trim().toUpperCase()\r\n              formattedInvestorName = `${lastName} ${firstName}`.trim() || 'UNKNOWN'\r\n            } else {\r\n              // For entities: ENTITY NAME (uppercase)\r\n              formattedInvestorName = (investorData?.legal_name || 'UNKNOWN').toUpperCase()\r\n            }\r\n            // Sanitize for filename\r\n            const safeInvestorName = formattedInvestorName\r\n              .replace(/[^a-zA-Z0-9 ]/g, '')\r\n              .substring(0, 50)\r\n            const certificateNumber = `VC${vehicleData.series_number}SH${subscription.subscription_number}`\r\n            const fileName = `${certificateNumber} - ${safeInvestorName}.pdf`\r\n\r\n            // === STORAGE: subscriptions/{id}/certificates/{filename}.pdf ===\r\n            const fileKey = `subscriptions/${subscriptionId}/certificates/${fileName}`\r\n            const { error: uploadError } = await supabase.storage\r\n              .from('deal-documents')\r\n              .upload(fileKey, pdfBuffer, {\r\n                contentType: 'application/pdf',\r\n                upsert: true\r\n              })\r\n\r\n            if (uploadError) {\r\n              console.error('‚ùå Failed to upload certificate PDF:', uploadError)\r\n            } else {\r\n              console.log('‚úÖ Certificate PDF uploaded:', fileKey)\r\n\r\n              // === CREATE DOCUMENT RECORD ===\r\n              // Find Subscription Documents folder for this vehicle\r\n              let subscriptionFolderId: string | null = null\r\n              if (vehicleId) {\r\n                const { data: subFolder } = await supabase\r\n                  .from('document_folders')\r\n                  .select('id')\r\n                  .eq('vehicle_id', vehicleId)\r\n                  .eq('name', 'Subscription Documents')\r\n                  .single()\r\n                subscriptionFolderId = subFolder?.id || null\r\n              }\r\n\r\n              // Create document record with status 'pending_signature'\r\n              const { data: document, error: docError } = await supabase\r\n                .from('documents')\r\n                .insert({\r\n                  subscription_id: subscriptionId,\r\n                  deal_id: subscription.deal_id,\r\n                  vehicle_id: vehicleId,\r\n                  folder_id: subscriptionFolderId,\r\n                  type: 'certificate',\r\n                  name: fileName,\r\n                  file_key: fileKey,\r\n                  mime_type: 'application/pdf',\r\n                  file_size_bytes: pdfBuffer.length,\r\n                  status: 'pending_signature', // Hidden from investor until signed\r\n                  current_version: 1,\r\n                  ready_for_signature: true,\r\n                  created_by: profile.id\r\n                })\r\n                .select('id')\r\n                .single()\r\n\r\n              if (docError) {\r\n                console.error('‚ùå Failed to create document record:', docError)\r\n              } else {\r\n                console.log('‚úÖ Document record created:', document.id)\r\n\r\n                // Update subscription with certificate path and document ID\r\n                await supabase\r\n                  .from('subscriptions')\r\n                  .update({ certificate_pdf_path: fileKey })\r\n                  .eq('id', subscriptionId)\r\n\r\n                // === CREATE SIGNATURE WORKFLOW ===\r\n                // Signature order: CEO signs FIRST (party_a, left), Second signatory signs SECOND (party_b, right)\r\n\r\n                // Get CEO signer (signs FIRST - party_a, left position on certificate)\r\n                const { data: ceoProfile } = await supabase\r\n                  .from('profiles')\r\n                  .select('id, email, display_name')\r\n                  .eq('role', 'ceo')\r\n                  .limit(1)\r\n                  .single()\r\n\r\n                const ceoSigner = ceoProfile ? {\r\n                  user_id: ceoProfile.id,\r\n                  email: ceoProfile.email || '',\r\n                  name: ceoProfile.display_name || 'CEO'\r\n                } : null\r\n\r\n                // Get second signatory (signs SECOND - party_b, right position on certificate)\r\n                // For now, use a designated staff member. Later this can be the assigned lawyer.\r\n                let secondSigner: { user_id: string; email: string; name: string } | null = null\r\n\r\n                // First try to get assigned lawyer for this deal\r\n                if (subscription.deal_id) {\r\n                  const { data: lawyerAssignment } = await supabase\r\n                    .from('deal_lawyer_assignments')\r\n                    .select(`\r\n                      lawyer:lawyers!deal_lawyer_assignments_lawyer_id_fkey (\r\n                        id,\r\n                        legal_name,\r\n                        email,\r\n                        user_id\r\n                      )\r\n                    `)\r\n                    .eq('deal_id', subscription.deal_id)\r\n                    .limit(1)\r\n                    .maybeSingle()\r\n\r\n                  if (lawyerAssignment?.lawyer) {\r\n                    const lawyer = lawyerAssignment.lawyer as unknown as { id: string; legal_name: string; email: string; user_id: string }\r\n                    secondSigner = {\r\n                      user_id: lawyer.user_id,\r\n                      email: lawyer.email,\r\n                      name: lawyer.legal_name\r\n                    }\r\n                  }\r\n                }\r\n\r\n                // Fallback: If no lawyer assigned, use G.A. Giles (CTO) as second signatory for testing\r\n                if (!secondSigner) {\r\n                  const { data: fallbackSigner } = await supabase\r\n                    .from('profiles')\r\n                    .select('id, email, display_name')\r\n                    .eq('email', 'cto@versoholdings.com')\r\n                    .single()\r\n\r\n                  if (fallbackSigner) {\r\n                    secondSigner = {\r\n                      user_id: fallbackSigner.id,\r\n                      email: fallbackSigner.email || '',\r\n                      name: 'G.A. Giles' // Display name for certificate\r\n                    }\r\n                  }\r\n                }\r\n\r\n                // Create signature requests for both signers\r\n                const tokenExpiry = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) // 30 days\r\n\r\n                // CEO signature (party_a) - signs FIRST (left position on certificate)\r\n                if (ceoSigner) {\r\n                  const ceoToken = crypto.randomBytes(32).toString('hex')\r\n                  const { data: ceoSigRequest, error: ceoSigError } = await supabase\r\n                    .from('signature_requests')\r\n                    .insert({\r\n                      investor_id: investorId,\r\n                      document_id: document.id,\r\n                      subscription_id: subscriptionId,\r\n                      deal_id: subscription.deal_id,\r\n                      document_type: 'certificate',\r\n                      signer_email: ceoSigner.email,\r\n                      signer_name: ceoSigner.name,\r\n                      signer_role: 'ceo',\r\n                      signature_position: 'party_a',\r\n                      signing_token: ceoToken,\r\n                      token_expires_at: tokenExpiry.toISOString(),\r\n                      unsigned_pdf_path: fileKey,\r\n                      unsigned_pdf_size: pdfBuffer.length,\r\n                      status: 'pending',\r\n                      created_by: profile.id\r\n                    })\r\n                    .select('id')\r\n                    .single()\r\n\r\n                  if (ceoSigError) {\r\n                    console.error('‚ùå Failed to create CEO signature request:', ceoSigError)\r\n                  } else {\r\n                    console.log('‚úÖ CEO signature request created (party_a, signs first)')\r\n\r\n                    // Create task for CEO in VERSOSign\r\n                    const signingUrl = `${process.env.NEXT_PUBLIC_APP_URL}/versotech_main/versosign?token=${ceoToken}`\r\n                    const { error: ceoTaskError } = await supabase.from('tasks').insert({\r\n                      owner_user_id: ceoSigner.user_id,\r\n                      kind: 'countersignature',\r\n                      category: 'compliance',\r\n                      title: `Sign Certificate: ${investorName}`,\r\n                      description: `Sign equity certificate for ${investorName} - ${dealData?.company_name || 'Investment'}`,\r\n                      status: 'pending',\r\n                      priority: 'high',\r\n                      related_entity_type: 'signature_request',\r\n                      related_entity_id: ceoSigRequest.id,\r\n                      related_deal_id: subscription.deal_id,\r\n                      due_at: tokenExpiry.toISOString(),\r\n                      instructions: {\r\n                        type: 'signature',\r\n                        action_url: signingUrl,\r\n                        signature_request_id: ceoSigRequest.id,\r\n                        document_type: 'certificate',\r\n                        investor_name: investorName,\r\n                        signer_name: ceoSigner.name,\r\n                        signer_role: 'ceo',\r\n                        signature_position: 'party_a',\r\n                        signing_order: 1\r\n                      }\r\n                    })\r\n\r\n                    if (ceoTaskError) {\r\n                      console.error('‚ö†Ô∏è Failed to create CEO task:', ceoTaskError)\r\n                    } else {\r\n                      console.log('‚úÖ CEO VERSOSign task created')\r\n                    }\r\n                  }\r\n                } else {\r\n                  console.error('‚ùå No CEO found in system - this should never happen!')\r\n                }\r\n\r\n                // Second signatory (party_b) - signs SECOND (right position on certificate)\r\n                if (secondSigner) {\r\n                  const secondToken = crypto.randomBytes(32).toString('hex')\r\n                  // Allowed signer_role values: investor, admin, lawyer, ceo\r\n                  const signerRole = secondSigner.email.includes('lawyer') || secondSigner.name.toLowerCase().includes('lawyer') ? 'lawyer' : 'admin'\r\n                  const { data: secondSigRequest, error: secondSigError } = await supabase\r\n                    .from('signature_requests')\r\n                    .insert({\r\n                      investor_id: investorId,\r\n                      document_id: document.id,\r\n                      subscription_id: subscriptionId,\r\n                      deal_id: subscription.deal_id,\r\n                      document_type: 'certificate',\r\n                      signer_email: secondSigner.email,\r\n                      signer_name: secondSigner.name,\r\n                      signer_role: signerRole,\r\n                      signature_position: 'party_b',\r\n                      signing_token: secondToken,\r\n                      token_expires_at: tokenExpiry.toISOString(),\r\n                      unsigned_pdf_path: fileKey,\r\n                      unsigned_pdf_size: pdfBuffer.length,\r\n                      status: 'pending',\r\n                      created_by: profile.id\r\n                    })\r\n                    .select('id')\r\n                    .single()\r\n\r\n                  if (secondSigError) {\r\n                    console.error('‚ùå Failed to create second signatory request:', secondSigError)\r\n                  } else {\r\n                    console.log(`‚úÖ Second signatory request created (party_b, ${secondSigner.name})`)\r\n\r\n                    // Create task for second signatory in VERSOSign\r\n                    const signingUrl = `${process.env.NEXT_PUBLIC_APP_URL}/versotech_main/versosign?token=${secondToken}`\r\n                    const { error: secondTaskError } = await supabase.from('tasks').insert({\r\n                      owner_user_id: secondSigner.user_id,\r\n                      kind: 'countersignature',\r\n                      category: 'compliance',\r\n                      title: `Sign Certificate: ${investorName}`,\r\n                      description: `Sign equity certificate for ${investorName} - ${dealData?.company_name || 'Investment'}. Awaiting CEO signature first.`,\r\n                      status: 'pending',\r\n                      priority: 'high',\r\n                      related_entity_type: 'signature_request',\r\n                      related_entity_id: secondSigRequest.id,\r\n                      related_deal_id: subscription.deal_id,\r\n                      due_at: tokenExpiry.toISOString(),\r\n                      instructions: {\r\n                        type: 'signature',\r\n                        action_url: signingUrl,\r\n                        signature_request_id: secondSigRequest.id,\r\n                        document_type: 'certificate',\r\n                        investor_name: investorName,\r\n                        signer_name: secondSigner.name,\r\n                        signer_role: signerRole,\r\n                        signature_position: 'party_b',\r\n                        signing_order: 2,\r\n                        requires_prior_signature: 'party_a'\r\n                      }\r\n                    })\r\n\r\n                    if (secondTaskError) {\r\n                      console.error('‚ö†Ô∏è Failed to create second signatory task:', secondTaskError)\r\n                    } else {\r\n                      console.log(`‚úÖ Second signatory VERSOSign task created for ${secondSigner.name}`)\r\n                    }\r\n                  }\r\n                } else {\r\n                  console.warn('‚ö†Ô∏è No second signatory found - certificate will have only CEO signature')\r\n                }\r\n\r\n                console.log(`üìú Certificate workflow initiated: ${fileName}`)\r\n                console.log(`   - Document ID: ${document.id}`)\r\n                console.log(`   - Status: pending_signature (hidden from investor)`)\r\n                console.log(`   - Awaiting: CEO (party_a) ‚Üí Second Signatory (party_b) signatures`)\r\n              }\r\n            }\r\n          } else {\r\n            console.warn('‚ö†Ô∏è No binary PDF data found in n8n response')\r\n          }\r\n        } catch (pdfError) {\r\n          console.error('‚ùå Error processing certificate PDF from n8n:', pdfError)\r\n          // Don't fail - the subscription is activated, PDF can be regenerated\r\n        }\r\n      }\r\n    }\r\n\r\n    // Create notification for ALL investor users (not just first one)\r\n    const { data: investorUsers, error: usersError } = await supabase\r\n      .from('investor_users')\r\n      .select('user_id')\r\n      .eq('investor_id', investorId)\r\n\r\n    if (usersError) {\r\n      console.error(`‚ùå Failed to fetch investor users for notification:`, usersError)\r\n    } else if (!investorUsers || investorUsers.length === 0) {\r\n      console.warn(`‚ö†Ô∏è No investor_users found for investor ${investorId} - cannot create notification`)\r\n    } else {\r\n      // Create notifications for all users linked to this investor\r\n      const notifications = investorUsers.map(iu => ({\r\n        user_id: iu.user_id,\r\n        investor_id: investorId,\r\n        type: 'investment_activated',\r\n        title: 'Investment Activated',\r\n        message: 'Your investment is now active. Your equity certificate will be available shortly.',\r\n        link: '/versotech_main/portfolio'\r\n      }))\r\n\r\n      const { error: notifError } = await supabase\r\n        .from('investor_notifications')\r\n        .insert(notifications)\r\n\r\n      if (notifError) {\r\n        console.error(`‚ùå Failed to create investor notifications:`, notifError)\r\n      } else {\r\n        console.log(`‚úÖ Created ${notifications.length} notification(s) for investor ${investorId}`)\r\n      }\r\n    }\r\n\r\n    // NOTIFY ASSIGNED LAWYERS about certificate issuance\r\n    // First, get the deal_id from the subscription\r\n    const { data: subWithDeal, error: subDealError } = await supabase\r\n      .from('subscriptions')\r\n      .select('deal_id')\r\n      .eq('id', subscriptionId)\r\n      .single()\r\n\r\n    if (subDealError || !subWithDeal?.deal_id) {\r\n      console.warn(`‚ö†Ô∏è Could not get deal_id for lawyer notification:`, subDealError)\r\n    } else {\r\n      // Get lawyers assigned to this deal\r\n      const { data: lawyerAssignments, error: assignError } = await supabase\r\n        .from('deal_lawyer_assignments')\r\n        .select('lawyer_id')\r\n        .eq('deal_id', subWithDeal.deal_id)\r\n\r\n      if (assignError) {\r\n        console.error(`‚ùå Failed to fetch lawyer assignments:`, assignError)\r\n      } else if (lawyerAssignments && lawyerAssignments.length > 0) {\r\n        const lawyerIds = lawyerAssignments.map((a: any) => a.lawyer_id)\r\n\r\n        // Get lawyer users\r\n        const { data: lawyerUsers, error: lawyerUsersError } = await supabase\r\n          .from('lawyer_users')\r\n          .select('user_id, lawyer_id')\r\n          .in('lawyer_id', lawyerIds)\r\n\r\n        if (lawyerUsersError) {\r\n          console.error(`‚ùå Failed to fetch lawyer users:`, lawyerUsersError)\r\n        } else if (lawyerUsers && lawyerUsers.length > 0) {\r\n          // Get investor name for notification\r\n          const { data: investorForNotif } = await supabase\r\n            .from('investors')\r\n            .select('display_name, legal_name')\r\n            .eq('id', investorId)\r\n            .single()\r\n\r\n          const investorNameForNotif = investorForNotif?.display_name || investorForNotif?.legal_name || 'An investor'\r\n\r\n          // Create notifications for lawyers\r\n          const lawyerNotifications = lawyerUsers.map((lu: any) => ({\r\n            user_id: lu.user_id,\r\n            investor_id: null,\r\n            type: 'certificate_issued',\r\n            title: 'Certificate Issued',\r\n            message: `Investment certificate issued for ${investorNameForNotif}. The subscription is now fully active.`,\r\n            link: '/versotech_main/subscription-packs'\r\n          }))\r\n\r\n          const { error: lawyerNotifError } = await supabase\r\n            .from('investor_notifications')\r\n            .insert(lawyerNotifications)\r\n\r\n          if (lawyerNotifError) {\r\n            console.error(`‚ùå Failed to create lawyer notifications:`, lawyerNotifError)\r\n          } else {\r\n            console.log(`‚úÖ Created ${lawyerNotifications.length} lawyer notification(s) for certificate issuance`)\r\n          }\r\n        }\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(`‚ùå Certificate trigger failed for subscription ${subscriptionId}:`, error)\r\n    // Don't throw - this is a non-critical operation\r\n  }\r\n}\r\n","/**\r\n * Deal Close Handler\r\n *\r\n * Handles the business logic when a deal reaches its closing date.\r\n * Per Fred's requirements (2024):\r\n * - Certificates are generated on deal closing date (NOT on funded status)\r\n * - Invoice request capability is enabled on deal closing date\r\n * - Notifications are sent to introducers/partners\r\n *\r\n * This is idempotent - if a deal has already been processed (closed_processed_at is set),\r\n * it will be skipped.\r\n */\r\n\r\nimport { SupabaseClient } from '@supabase/supabase-js'\r\nimport { triggerCertificateGeneration } from '@/lib/subscription/certificate-trigger'\r\nimport { createInvestorNotification } from '@/lib/notifications'\r\nimport { auditLogger, AuditActions, AuditEntities } from '@/lib/audit'\r\n\r\nexport interface DealCloseResult {\r\n  success: boolean\r\n  dealId: string\r\n  subscriptionsActivated: number\r\n  positionsCreated: number\r\n  commissionsCreated: number\r\n  certificatesTriggered: number\r\n  feePlansEnabled: number\r\n  notificationsSent: number\r\n  accrualNotificationsSent: number  // GAP-5: Track commission accrual notifications\r\n  errors: string[]\r\n}\r\n\r\n/**\r\n * GAP-5 & GAP-7: Helper to send commission accrual notification and create audit log\r\n */\r\nasync function sendCommissionAccrualNotification(\r\n  supabase: SupabaseClient,\r\n  params: {\r\n    entityType: 'introducer' | 'partner' | 'commercial_partner'\r\n    entityId: string\r\n    dealId: string\r\n    dealName: string\r\n    investorName: string\r\n    commissionAmount: number\r\n    currency: string\r\n    commissionId?: string\r\n  }\r\n): Promise<number> {\r\n  let notificationsSent = 0\r\n\r\n  try {\r\n    // Determine user table and entity table based on type\r\n    const userTable = `${params.entityType}_users` as 'introducer_users' | 'partner_users' | 'commercial_partner_users'\r\n    const entityIdField = `${params.entityType}_id`\r\n\r\n    // Get all users linked to this entity\r\n    const { data: entityUsers } = await supabase\r\n      .from(userTable)\r\n      .select('user_id')\r\n      .eq(entityIdField, params.entityId)\r\n\r\n    if (entityUsers && entityUsers.length > 0) {\r\n      const formattedAmount = new Intl.NumberFormat('en-US', {\r\n        style: 'currency',\r\n        currency: params.currency || 'USD',\r\n      }).format(params.commissionAmount)\r\n\r\n      for (const eu of entityUsers) {\r\n        try {\r\n          await createInvestorNotification({\r\n            userId: eu.user_id,\r\n            title: 'Commission Earned',\r\n            message: `You've earned a ${formattedAmount} commission for ${params.investorName}'s investment in ${params.dealName}.`,\r\n            link: '/versotech_main/my-commissions',\r\n            type: 'introducer_commission_accrued',\r\n            sendEmailNotification: true,\r\n            dealId: params.dealId,\r\n          })\r\n          notificationsSent++\r\n        } catch (error) {\r\n          console.error(`[deal-close] Failed to send accrual notification to user ${eu.user_id}:`, error)\r\n        }\r\n      }\r\n    }\r\n\r\n    // GAP-7: Create audit log for commission creation\r\n    const entityMapping = {\r\n      'introducer': AuditEntities.INTRODUCER_COMMISSIONS,\r\n      'partner': AuditEntities.PARTNER_COMMISSIONS,\r\n      'commercial_partner': AuditEntities.COMMERCIAL_PARTNER_COMMISSIONS,\r\n    }\r\n\r\n    await auditLogger.log({\r\n      action: AuditActions.COMMISSION_ACCRUED,\r\n      entity: entityMapping[params.entityType],\r\n      entity_id: params.commissionId,\r\n      metadata: {\r\n        entity_type: params.entityType,\r\n        entity_id: params.entityId,\r\n        deal_id: params.dealId,\r\n        deal_name: params.dealName,\r\n        investor_name: params.investorName,\r\n        commission_amount: params.commissionAmount,\r\n        currency: params.currency,\r\n        created_by: 'deal_close_handler',\r\n      },\r\n    })\r\n  } catch (error) {\r\n    console.error('[deal-close] Error sending accrual notification:', error)\r\n  }\r\n\r\n  return notificationsSent\r\n}\r\n\r\n/**\r\n * Process a deal that has reached its closing date.\r\n *\r\n * Actions performed:\r\n * 1. Generate certificates for all funded subscriptions\r\n * 2. Enable invoice_requests on all accepted fee plans\r\n * 3. Send notifications to introducers/partners that invoice requests are now available\r\n *\r\n * @param supabase - Supabase client (should be service client for admin access)\r\n * @param dealId - The deal ID to process\r\n * @param closingDate - The closing date (for logging/reference)\r\n */\r\nexport async function handleDealClose(\r\n  supabase: SupabaseClient,\r\n  dealId: string,\r\n  closingDate: Date\r\n): Promise<DealCloseResult> {\r\n  const result: DealCloseResult = {\r\n    success: false,\r\n    dealId,\r\n    subscriptionsActivated: 0,\r\n    positionsCreated: 0,\r\n    commissionsCreated: 0,\r\n    certificatesTriggered: 0,\r\n    feePlansEnabled: 0,\r\n    notificationsSent: 0,\r\n    accrualNotificationsSent: 0,\r\n    errors: [],\r\n  }\r\n\r\n  try {\r\n    // Verify deal exists and hasn't been processed yet\r\n    const { data: deal, error: dealError } = await supabase\r\n      .from('deals')\r\n      .select('id, name, company_name, status, close_at, closed_processed_at, vehicle_id, arranger_entity_id, currency')\r\n      .eq('id', dealId)\r\n      .single()\r\n\r\n    if (dealError || !deal) {\r\n      result.errors.push(`Deal not found: ${dealError?.message || 'Unknown error'}`)\r\n      return result\r\n    }\r\n\r\n    // Idempotency check - skip if already processed\r\n    if (deal.closed_processed_at) {\r\n      console.log(`[deal-close] Deal ${dealId} already processed at ${deal.closed_processed_at}, skipping`)\r\n      result.success = true // Not an error, just already done\r\n      return result\r\n    }\r\n\r\n    console.log(`[deal-close] Processing deal ${dealId} (${deal.name}) closing date: ${closingDate.toISOString()}`)\r\n\r\n    // Step 1: Activate funded subscriptions, create positions, and generate certificates\r\n    // Get all funded subscriptions that haven't been activated yet\r\n    const { data: subscriptions, error: subError } = await supabase\r\n      .from('subscriptions')\r\n      .select(`\r\n        id,\r\n        investor_id,\r\n        vehicle_id,\r\n        commitment,\r\n        funded_amount,\r\n        currency,\r\n        num_shares,\r\n        units,\r\n        price_per_share,\r\n        cost_per_share,\r\n        status,\r\n        activated_at,\r\n        investor:investors(\r\n          id,\r\n          display_name,\r\n          legal_name\r\n        )\r\n      `)\r\n      .eq('deal_id', dealId)\r\n      .eq('status', 'funded') // Only funded subscriptions awaiting activation\r\n      .is('activated_at', null) // Not yet activated\r\n\r\n    if (subError) {\r\n      result.errors.push(`Failed to fetch subscriptions: ${subError.message}`)\r\n    } else if (subscriptions && subscriptions.length > 0) {\r\n      console.log(`[deal-close] Found ${subscriptions.length} funded subscriptions to activate`)\r\n\r\n      // Get a system profile for triggering (or use first available staff)\r\n      const { data: systemProfile } = await supabase\r\n        .from('profiles')\r\n        .select('id, email, display_name, role, title')\r\n        .eq('role', 'staff_admin')\r\n        .limit(1)\r\n        .single()\r\n\r\n      const triggerProfile = systemProfile || {\r\n        id: 'system',\r\n        email: 'system@versoholdings.com',\r\n        display_name: 'System',\r\n        role: 'system',\r\n        title: 'Automated Process',\r\n      }\r\n\r\n      for (const sub of subscriptions) {\r\n        try {\r\n          // Step 1a: Calculate and lock spread values if not already set\r\n          const pricePerShare = Number(sub.price_per_share) || null\r\n          const costPerShare = Number(sub.cost_per_share) || null\r\n          const numShares = sub.num_shares || sub.units || null\r\n\r\n          // Calculate spread values if we have both price and cost\r\n          let spreadPerShare: number | null = null\r\n          let spreadFeeAmount: number | null = null\r\n          if (pricePerShare && costPerShare && pricePerShare > 0 && costPerShare > 0) {\r\n            spreadPerShare = pricePerShare - costPerShare\r\n            if (numShares && numShares > 0) {\r\n              spreadFeeAmount = spreadPerShare * Number(numShares)\r\n            }\r\n          }\r\n\r\n          // Step 1b: Update subscription status to 'active' and capture final spread values\r\n          const { error: statusError } = await supabase\r\n            .from('subscriptions')\r\n            .update({\r\n              status: 'active',\r\n              activated_at: new Date().toISOString(),\r\n              // Lock spread values at close time\r\n              ...(spreadPerShare !== null && { spread_per_share: spreadPerShare }),\r\n              ...(spreadFeeAmount !== null && { spread_fee_amount: spreadFeeAmount }),\r\n            })\r\n            .eq('id', sub.id)\r\n\r\n          if (statusError) {\r\n            result.errors.push(`Failed to activate subscription ${sub.id}: ${statusError.message}`)\r\n            continue\r\n          }\r\n          result.subscriptionsActivated++\r\n          console.log(`[deal-close] Activated subscription ${sub.id}`)\r\n\r\n          // Step 1b: Create position for this subscription\r\n          const fundedAmount = Number(sub.funded_amount) || 0\r\n          let positionUnits = sub.num_shares || sub.units\r\n          if (!positionUnits && sub.price_per_share) {\r\n            positionUnits = fundedAmount / Number(sub.price_per_share)\r\n          } else if (!positionUnits && sub.cost_per_share) {\r\n            positionUnits = fundedAmount / Number(sub.cost_per_share)\r\n          }\r\n\r\n          const initialNav = sub.price_per_share || sub.cost_per_share\r\n\r\n          if (positionUnits && positionUnits > 0) {\r\n            // Check if position already exists\r\n            const { data: existingPosition } = await supabase\r\n              .from('positions')\r\n              .select('id')\r\n              .eq('investor_id', sub.investor_id)\r\n              .eq('vehicle_id', sub.vehicle_id || deal.vehicle_id)\r\n              .maybeSingle()\r\n\r\n            if (!existingPosition) {\r\n              const { error: positionError } = await supabase\r\n                .from('positions')\r\n                .insert({\r\n                  investor_id: sub.investor_id,\r\n                  vehicle_id: sub.vehicle_id || deal.vehicle_id,\r\n                  units: positionUnits,\r\n                  cost_basis: fundedAmount,\r\n                  last_nav: initialNav,\r\n                  as_of_date: new Date().toISOString(),\r\n                })\r\n\r\n              if (positionError) {\r\n                result.errors.push(`Failed to create position for subscription ${sub.id}: ${positionError.message}`)\r\n              } else {\r\n                result.positionsCreated++\r\n                console.log(`[deal-close] Created position for subscription ${sub.id}: ${positionUnits} units`)\r\n              }\r\n            } else {\r\n              console.log(`[deal-close] Position already exists for subscription ${sub.id}`)\r\n            }\r\n          }\r\n\r\n          // Step 1c: Create introducer/partner/commercial partner commissions (based on assigned fee plan)\r\n          try {\r\n            const { data: dealMembership } = await supabase\r\n              .from('deal_memberships')\r\n              .select('referred_by_entity_id, referred_by_entity_type, assigned_fee_plan_id')\r\n              .eq('deal_id', dealId)\r\n              .eq('investor_id', sub.investor_id)\r\n              .order('dispatched_at', { ascending: false })\r\n              .limit(1)\r\n              .maybeSingle()\r\n\r\n            let canProcess =\r\n              !!dealMembership?.referred_by_entity_type && !!dealMembership.referred_by_entity_id\r\n\r\n            if (!canProcess) {\r\n              // No referral = no commission\r\n            }\r\n\r\n            if (canProcess && dealMembership) {\r\n              const feePlanId = dealMembership.assigned_fee_plan_id\r\n              if (!feePlanId) {\r\n                result.errors.push(`Commission skipped for subscription ${sub.id}: no assigned fee plan`)\r\n                canProcess = false\r\n              }\r\n\r\n              const { data: feePlan } = canProcess && feePlanId\r\n                ? await supabase\r\n                    .from('fee_plans')\r\n                    .select('id, status, is_active, introducer_id, partner_id, commercial_partner_id, fee_components(id, kind, rate_bps)')\r\n                    .eq('id', feePlanId)\r\n                    .eq('deal_id', dealId)\r\n                    .maybeSingle()\r\n                : { data: null }\r\n\r\n              if (canProcess && (!feePlan || !feePlan.is_active || feePlan.status !== 'accepted')) {\r\n                result.errors.push(`Commission skipped for subscription ${sub.id}: fee plan not accepted or inactive`)\r\n                canProcess = false\r\n              }\r\n\r\n              const entityMatch = canProcess && feePlan && dealMembership.referred_by_entity_type === 'introducer'\r\n                ? feePlan.introducer_id === dealMembership.referred_by_entity_id\r\n                : canProcess && feePlan && dealMembership.referred_by_entity_type === 'partner'\r\n                  ? feePlan.partner_id === dealMembership.referred_by_entity_id\r\n                  : canProcess && feePlan\r\n                    ? feePlan.commercial_partner_id === dealMembership.referred_by_entity_id\r\n                    : false\r\n\r\n              if (canProcess && !entityMatch) {\r\n                result.errors.push(`Commission skipped for subscription ${sub.id}: fee plan does not match referrer`)\r\n                canProcess = false\r\n              }\r\n\r\n              const components = canProcess && feePlan ? (feePlan.fee_components as any[]) || [] : []\r\n              const subscriptionComponent = components.find((c: any) => c.kind === 'subscription')\r\n              const rateBps = subscriptionComponent?.rate_bps || 0\r\n\r\n              if (canProcess && (!rateBps || rateBps <= 0)) {\r\n                result.errors.push(`Commission skipped for subscription ${sub.id}: fee plan has no subscription fee rate`)\r\n                canProcess = false\r\n              }\r\n\r\n              if (!canProcess) {\r\n                // Skip commission creation for this subscription\r\n              } else {\r\n              // IMPORTANT: Commission basis is ALWAYS 'invested_amount' (funded_amount)\r\n              // Per PRD: Commission basis NEVER includes management_fee\r\n              // Commissions are calculated as: funded_amount √ó (rate_bps / 10000)\r\n              const commissionAmount = (fundedAmount * rateBps) / 10000\r\n              const currency = sub.currency || deal.currency || 'USD'\r\n              const now = new Date().toISOString()\r\n\r\n              if (dealMembership.referred_by_entity_type === 'introducer') {\r\n                // Enforce active signed introducer agreement\r\n                const today = new Date().toISOString().split('T')[0]\r\n                const { data: activeAgreement } = await supabase\r\n                  .from('introducer_agreements')\r\n                  .select('id')\r\n                  .eq('introducer_id', dealMembership.referred_by_entity_id)\r\n                  .eq('fee_plan_id', feePlanId)\r\n                  .eq('status', 'active')\r\n                  .not('signed_date', 'is', null)\r\n                  .or(`expiry_date.is.null,expiry_date.gte.${today}`)\r\n                  .maybeSingle()\r\n\r\n                if (!activeAgreement) {\r\n                  result.errors.push(`Commission skipped for subscription ${sub.id}: introducer agreement not active`)\r\n                } else {\r\n                  const { data: existingCommission } = await supabase\r\n                    .from('introducer_commissions')\r\n                    .select('id')\r\n                    .eq('introducer_id', dealMembership.referred_by_entity_id)\r\n                    .eq('deal_id', dealId)\r\n                    .eq('investor_id', sub.investor_id)\r\n                    .maybeSingle()\r\n\r\n                  if (!existingCommission) {\r\n                    const { data: newCommission } = await supabase.from('introducer_commissions').insert({\r\n                      introducer_id: dealMembership.referred_by_entity_id,\r\n                      deal_id: dealId,\r\n                      investor_id: sub.investor_id,\r\n                      arranger_id: deal.arranger_entity_id || null,\r\n                      fee_plan_id: feePlanId,\r\n                      basis_type: 'invested_amount',\r\n                      rate_bps: rateBps,\r\n                      base_amount: fundedAmount,\r\n                      accrual_amount: commissionAmount,\r\n                      currency,\r\n                      status: 'accrued',\r\n                      created_at: now,\r\n                    }).select('id').single()\r\n\r\n                    result.commissionsCreated++\r\n\r\n                    // GAP-5 & GAP-7: Send commission accrual notification and audit log\r\n                    const investor = sub.investor as { display_name?: string; legal_name?: string } | null\r\n                    const investorName = investor?.display_name || investor?.legal_name || 'Investor'\r\n                    const accrualNotifications = await sendCommissionAccrualNotification(supabase, {\r\n                      entityType: 'introducer',\r\n                      entityId: dealMembership.referred_by_entity_id,\r\n                      dealId,\r\n                      dealName: deal.name || 'Deal',\r\n                      investorName,\r\n                      commissionAmount,\r\n                      currency,\r\n                      commissionId: newCommission?.id,\r\n                    })\r\n                    result.accrualNotificationsSent += accrualNotifications\r\n                  }\r\n                }\r\n              } else if (dealMembership.referred_by_entity_type === 'partner') {\r\n                const { data: existingCommission } = await supabase\r\n                  .from('partner_commissions')\r\n                  .select('id')\r\n                  .eq('partner_id', dealMembership.referred_by_entity_id)\r\n                  .eq('deal_id', dealId)\r\n                  .eq('investor_id', sub.investor_id)\r\n                  .maybeSingle()\r\n\r\n                if (!existingCommission) {\r\n                  const { data: newCommission } = await supabase.from('partner_commissions').insert({\r\n                    partner_id: dealMembership.referred_by_entity_id,\r\n                    deal_id: dealId,\r\n                    investor_id: sub.investor_id,\r\n                    arranger_id: deal.arranger_entity_id || null,\r\n                    fee_plan_id: feePlanId,\r\n                    basis_type: 'invested_amount',\r\n                    rate_bps: rateBps,\r\n                    base_amount: fundedAmount,\r\n                    accrual_amount: commissionAmount,\r\n                    currency,\r\n                    status: 'accrued',\r\n                    created_at: now,\r\n                  }).select('id').single()\r\n\r\n                  result.commissionsCreated++\r\n\r\n                  // GAP-5 & GAP-7: Send commission accrual notification and audit log\r\n                  const investor = sub.investor as { display_name?: string; legal_name?: string } | null\r\n                  const investorName = investor?.display_name || investor?.legal_name || 'Investor'\r\n                  const accrualNotifications = await sendCommissionAccrualNotification(supabase, {\r\n                    entityType: 'partner',\r\n                    entityId: dealMembership.referred_by_entity_id,\r\n                    dealId,\r\n                    dealName: deal.name || 'Deal',\r\n                    investorName,\r\n                    commissionAmount,\r\n                    currency,\r\n                    commissionId: newCommission?.id,\r\n                  })\r\n                  result.accrualNotificationsSent += accrualNotifications\r\n                }\r\n              } else if (dealMembership.referred_by_entity_type === 'commercial_partner') {\r\n                if (!deal.arranger_entity_id) {\r\n                  result.errors.push(`Commission skipped for subscription ${sub.id}: missing arranger for commercial partner`)\r\n                } else {\r\n                  const { data: existingCommission } = await supabase\r\n                    .from('commercial_partner_commissions')\r\n                    .select('id')\r\n                    .eq('commercial_partner_id', dealMembership.referred_by_entity_id)\r\n                    .eq('deal_id', dealId)\r\n                    .eq('investor_id', sub.investor_id)\r\n                    .maybeSingle()\r\n\r\n                  if (!existingCommission) {\r\n                    const { data: newCommission } = await supabase.from('commercial_partner_commissions').insert({\r\n                      commercial_partner_id: dealMembership.referred_by_entity_id,\r\n                      deal_id: dealId,\r\n                      investor_id: sub.investor_id,\r\n                      arranger_id: deal.arranger_entity_id,\r\n                      fee_plan_id: feePlanId,\r\n                      basis_type: 'invested_amount',\r\n                      rate_bps: rateBps,\r\n                      base_amount: fundedAmount,\r\n                      accrual_amount: commissionAmount,\r\n                      currency,\r\n                      status: 'accrued',\r\n                      created_at: now,\r\n                    }).select('id').single()\r\n\r\n                    result.commissionsCreated++\r\n\r\n                    // GAP-5 & GAP-7: Send commission accrual notification and audit log\r\n                    const investor = sub.investor as { display_name?: string; legal_name?: string } | null\r\n                    const investorName = investor?.display_name || investor?.legal_name || 'Investor'\r\n                    const accrualNotifications = await sendCommissionAccrualNotification(supabase, {\r\n                      entityType: 'commercial_partner',\r\n                      entityId: dealMembership.referred_by_entity_id,\r\n                      dealId,\r\n                      dealName: deal.name || 'Deal',\r\n                      investorName,\r\n                      commissionAmount,\r\n                      currency,\r\n                      commissionId: newCommission?.id,\r\n                    })\r\n                    result.accrualNotificationsSent += accrualNotifications\r\n                  }\r\n                }\r\n              }\r\n            }\r\n            }\r\n          } catch (commError) {\r\n            const msg = commError instanceof Error ? commError.message : 'Unknown error'\r\n            result.errors.push(`Commission creation failed for subscription ${sub.id}: ${msg}`)\r\n          }\r\n\r\n          // Step 1d: Trigger certificate generation\r\n          await triggerCertificateGeneration({\r\n            supabase,\r\n            subscriptionId: sub.id,\r\n            investorId: sub.investor_id,\r\n            vehicleId: sub.vehicle_id || deal.vehicle_id,\r\n            commitment: sub.commitment || 0,\r\n            fundedAmount: fundedAmount,\r\n            shares: sub.num_shares || sub.units,\r\n            pricePerShare: sub.price_per_share,\r\n            profile: triggerProfile,\r\n          })\r\n          result.certificatesTriggered++\r\n        } catch (subError) {\r\n          const msg = subError instanceof Error ? subError.message : 'Unknown error'\r\n          result.errors.push(`Processing failed for subscription ${sub.id}: ${msg}`)\r\n        }\r\n      }\r\n    }\r\n\r\n    // Step 2: Enable invoice_requests on all accepted fee plans\r\n    const now = new Date().toISOString()\r\n    const { data: feePlans, error: feePlanError } = await supabase\r\n      .from('fee_plans')\r\n      .update({\r\n        invoice_requests_enabled: true,\r\n        invoice_requests_enabled_at: now,\r\n      })\r\n      .eq('deal_id', dealId)\r\n      .eq('status', 'accepted')\r\n      .eq('invoice_requests_enabled', false) // Only update those not already enabled\r\n      .select('id, introducer_id, partner_id, commercial_partner_id, name')\r\n\r\n    if (feePlanError) {\r\n      result.errors.push(`Failed to enable invoice requests: ${feePlanError.message}`)\r\n    } else if (feePlans) {\r\n      result.feePlansEnabled = feePlans.length\r\n      console.log(`[deal-close] Enabled invoice requests for ${feePlans.length} fee plans`)\r\n\r\n      // Step 3: Send notifications to introducers/partners\r\n      for (const feePlan of feePlans) {\r\n        try {\r\n          await sendDealCloseNotification(supabase, feePlan, deal)\r\n          result.notificationsSent++\r\n        } catch (notifError) {\r\n          const msg = notifError instanceof Error ? notifError.message : 'Unknown error'\r\n          result.errors.push(`Notification failed for fee plan ${feePlan.id}: ${msg}`)\r\n        }\r\n      }\r\n    }\r\n\r\n    // Mark deal as processed (idempotency)\r\n    const { error: updateError } = await supabase\r\n      .from('deals')\r\n      .update({ closed_processed_at: now })\r\n      .eq('id', dealId)\r\n\r\n    if (updateError) {\r\n      result.errors.push(`Failed to mark deal as processed: ${updateError.message}`)\r\n    }\r\n\r\n    result.success = result.errors.length === 0\r\n    console.log(`[deal-close] Completed processing deal ${dealId}:`, {\r\n      certificates: result.certificatesTriggered,\r\n      feePlansEnabled: result.feePlansEnabled,\r\n      notifications: result.notificationsSent,\r\n      errors: result.errors.length,\r\n    })\r\n\r\n    return result\r\n  } catch (error) {\r\n    const msg = error instanceof Error ? error.message : 'Unknown error'\r\n    result.errors.push(`Unexpected error: ${msg}`)\r\n    console.error(`[deal-close] Unexpected error processing deal ${dealId}:`, error)\r\n    return result\r\n  }\r\n}\r\n\r\n/**\r\n * Send notification to introducer/partner that invoice requests are now available\r\n */\r\nasync function sendDealCloseNotification(\r\n  supabase: SupabaseClient,\r\n  feePlan: {\r\n    id: string\r\n    introducer_id: string | null\r\n    partner_id: string | null\r\n    commercial_partner_id: string | null\r\n    name: string\r\n  },\r\n  deal: {\r\n    id: string\r\n    name: string\r\n    company_name: string | null\r\n  }\r\n): Promise<void> {\r\n  let entityTable: string | null = null\r\n  let entityId: string | null = null\r\n  let entityType: string | null = null\r\n  let userTable: string | null = null\r\n\r\n  if (feePlan.introducer_id) {\r\n    entityTable = 'introducers'\r\n    entityId = feePlan.introducer_id\r\n    entityType = 'introducer'\r\n    userTable = 'introducer_users'\r\n  } else if (feePlan.partner_id) {\r\n    entityTable = 'partners'\r\n    entityId = feePlan.partner_id\r\n    entityType = 'partner'\r\n    userTable = 'partner_users'\r\n  } else if (feePlan.commercial_partner_id) {\r\n    entityTable = 'commercial_partners'\r\n    entityId = feePlan.commercial_partner_id\r\n    entityType = 'commercial_partner'\r\n    userTable = 'commercial_partner_users'\r\n  }\r\n\r\n  if (!entityTable || !entityId || !userTable) {\r\n    console.warn(`[deal-close] Fee plan ${feePlan.id} has no linked entity`)\r\n    return\r\n  }\r\n\r\n  // Get users linked to this entity\r\n  const { data: entityUsers, error: usersError } = await supabase\r\n    .from(userTable)\r\n    .select('user_id')\r\n    .eq(`${entityType}_id`, entityId)\r\n\r\n  if (usersError) {\r\n    console.error(`[deal-close] Failed to fetch ${entityType} users:`, usersError)\r\n    return\r\n  }\r\n\r\n  if (!entityUsers || entityUsers.length === 0) {\r\n    console.warn(`[deal-close] No users found for ${entityType} ${entityId}`)\r\n    return\r\n  }\r\n\r\n  const dealName = deal.company_name || deal.name\r\n  const title = 'Deal Closed - Invoice Requests Available'\r\n  const message = `The deal \"${dealName}\" has reached its closing date. You can now submit invoice requests for your fee agreement \"${feePlan.name}\".`\r\n  const link = '/versotech_main/fee-plans'\r\n\r\n  // Send notification to all users linked to this entity\r\n  for (const { user_id } of entityUsers) {\r\n    try {\r\n      await createInvestorNotification({\r\n        userId: user_id,\r\n        title,\r\n        message,\r\n        link,\r\n        type: 'introducer_invoice_sent', // Reusing existing type for invoice availability\r\n        sendEmailNotification: true,\r\n        dealId: deal.id,\r\n      })\r\n    } catch (error) {\r\n      console.error(`[deal-close] Failed to create notification for user ${user_id}:`, error)\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Check if a deal has reached its closing date and hasn't been processed yet\r\n */\r\nexport function isDealReadyForClose(deal: {\r\n  close_at: string | null\r\n  closed_processed_at: string | null\r\n  status: string\r\n}): boolean {\r\n  // Must have a closing date\r\n  if (!deal.close_at) return false\r\n\r\n  // Must not already be processed\r\n  if (deal.closed_processed_at) return false\r\n\r\n  // Deal must be in an appropriate status (not draft, not already fully closed)\r\n  const validStatuses = ['active', 'closing', 'collecting', 'closed']\r\n  if (!validStatuses.includes(deal.status)) return false\r\n\r\n  // Check if closing date has passed\r\n  const closingDate = new Date(deal.close_at)\r\n  const now = new Date()\r\n\r\n  // Use UTC comparison for consistency\r\n  const closingDateUtc = Date.UTC(\r\n    closingDate.getUTCFullYear(),\r\n    closingDate.getUTCMonth(),\r\n    closingDate.getUTCDate()\r\n  )\r\n  const nowUtc = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())\r\n\r\n  return nowUtc >= closingDateUtc\r\n}\r\n\r\n/**\r\n * Result interface for termsheet close operations\r\n */\r\nexport interface TermsheetCloseResult {\r\n  success: boolean\r\n  termsheetId: string\r\n  dealId: string\r\n  subscriptionsActivated: number\r\n  positionsCreated: number\r\n  commissionsCreated: number\r\n  certificatesTriggered: number\r\n  feePlansEnabled: number\r\n  notificationsSent: number\r\n  accrualNotificationsSent: number  // GAP-5: Track commission accrual notifications\r\n  errors: string[]\r\n}\r\n\r\n/**\r\n * Process a TERMSHEET that has reached its completion date.\r\n *\r\n * This is the per-termsheet version of handleDealClose. Since a deal can have\r\n * multiple termsheets (with different completion dates), each termsheet is\r\n * processed independently when its completion_date is reached.\r\n *\r\n * Actions performed:\r\n * 1. Activate subscriptions linked to this termsheet (via deal_memberships.term_sheet_id)\r\n * 2. Create positions for activated subscriptions\r\n * 3. Generate certificates for those subscriptions\r\n * 4. Create commissions for fee_plans linked to this termsheet\r\n * 5. Enable invoice_requests on fee_plans linked to this termsheet\r\n * 6. Send notifications to introducers/partners\r\n *\r\n * @param supabase - Supabase client (should be service client for admin access)\r\n * @param termsheetId - The termsheet ID to process (deal_fee_structures.id)\r\n */\r\nexport async function handleTermsheetClose(\r\n  supabase: SupabaseClient,\r\n  termsheetId: string\r\n): Promise<TermsheetCloseResult> {\r\n  const result: TermsheetCloseResult = {\r\n    success: false,\r\n    termsheetId,\r\n    dealId: '',\r\n    subscriptionsActivated: 0,\r\n    positionsCreated: 0,\r\n    commissionsCreated: 0,\r\n    certificatesTriggered: 0,\r\n    feePlansEnabled: 0,\r\n    notificationsSent: 0,\r\n    accrualNotificationsSent: 0,\r\n    errors: [],\r\n  }\r\n\r\n  try {\r\n    // Fetch termsheet with deal info\r\n    const { data: termsheet, error: termsheetError } = await supabase\r\n      .from('deal_fee_structures')\r\n      .select(`\r\n        id,\r\n        deal_id,\r\n        version,\r\n        status,\r\n        completion_date,\r\n        closed_processed_at,\r\n        subscription_fee_percent,\r\n        deal:deals!deal_fee_structures_deal_id_fkey (\r\n          id,\r\n          name,\r\n          company_name,\r\n          status,\r\n          currency,\r\n          vehicle_id,\r\n          arranger_entity_id\r\n        )\r\n      `)\r\n      .eq('id', termsheetId)\r\n      .single()\r\n\r\n    if (termsheetError || !termsheet) {\r\n      result.errors.push(`Termsheet not found: ${termsheetError?.message || 'Unknown error'}`)\r\n      return result\r\n    }\r\n\r\n    result.dealId = termsheet.deal_id\r\n    const deal = termsheet.deal as any\r\n\r\n    // Idempotency check - skip if already processed\r\n    if (termsheet.closed_processed_at) {\r\n      console.log(`[termsheet-close] Termsheet ${termsheetId} already processed at ${termsheet.closed_processed_at}, skipping`)\r\n      result.success = true\r\n      return result\r\n    }\r\n\r\n    console.log(`[termsheet-close] Processing termsheet ${termsheetId} (${deal?.name} v${termsheet.version})`)\r\n\r\n    // Step 1: Get investor IDs linked to THIS termsheet via deal_memberships\r\n    // Then fetch their funded subscriptions separately (no FK between tables)\r\n    const { data: linkedMemberships, error: membershipError } = await supabase\r\n      .from('deal_memberships')\r\n      .select('investor_id, referred_by_entity_id, referred_by_entity_type, assigned_fee_plan_id')\r\n      .eq('deal_id', termsheet.deal_id)\r\n      .eq('term_sheet_id', termsheetId)\r\n\r\n    if (membershipError) {\r\n      result.errors.push(`Failed to fetch deal memberships: ${membershipError.message}`)\r\n      return result\r\n    }\r\n\r\n    const linkedInvestorIds = (linkedMemberships || []).map(m => m.investor_id).filter(Boolean)\r\n\r\n    if (linkedInvestorIds.length === 0) {\r\n      console.log(`[termsheet-close] No investors linked to termsheet ${termsheetId}`)\r\n    }\r\n\r\n    // Step 1b: Get funded subscriptions for those investors\r\n    let subscriptions: any[] = []\r\n    let subError: any = null\r\n\r\n    if (linkedInvestorIds.length > 0) {\r\n      const { data: subs, error: fetchError } = await supabase\r\n        .from('subscriptions')\r\n        .select(`\r\n          id,\r\n          investor_id,\r\n          vehicle_id,\r\n          commitment,\r\n          funded_amount,\r\n          currency,\r\n          num_shares,\r\n          units,\r\n          price_per_share,\r\n          cost_per_share,\r\n          status,\r\n          activated_at,\r\n          investor:investors(\r\n            id,\r\n            display_name,\r\n            legal_name\r\n          )\r\n        `)\r\n        .eq('deal_id', termsheet.deal_id)\r\n        .eq('status', 'funded')\r\n        .is('activated_at', null)\r\n        .in('investor_id', linkedInvestorIds)\r\n\r\n      subscriptions = subs || []\r\n      subError = fetchError\r\n\r\n      // Attach membership data to each subscription for commission processing\r\n      subscriptions = subscriptions.map(sub => ({\r\n        ...sub,\r\n        deal_membership: linkedMemberships?.find(m => m.investor_id === sub.investor_id) || null\r\n      }))\r\n    }\r\n\r\n    if (subError) {\r\n      result.errors.push(`Failed to fetch subscriptions: ${subError.message}`)\r\n    } else if (subscriptions && subscriptions.length > 0) {\r\n      console.log(`[termsheet-close] Found ${subscriptions.length} funded subscriptions linked to termsheet ${termsheetId}`)\r\n\r\n      // Get a system profile for triggering\r\n      const { data: systemProfile } = await supabase\r\n        .from('profiles')\r\n        .select('id, email, display_name, role, title')\r\n        .eq('role', 'staff_admin')\r\n        .limit(1)\r\n        .single()\r\n\r\n      const triggerProfile = systemProfile || {\r\n        id: 'system',\r\n        email: 'system@versoholdings.com',\r\n        display_name: 'System',\r\n        role: 'system',\r\n        title: 'Automated Process',\r\n      }\r\n\r\n      for (const sub of subscriptions) {\r\n        // deal_membership was attached during the two-step query above\r\n        const dealMembership = sub.deal_membership\r\n\r\n        try {\r\n          // Step 1a: Calculate and lock spread values if not already set\r\n          const pricePerShare = Number(sub.price_per_share) || null\r\n          const costPerShare = Number(sub.cost_per_share) || null\r\n          const numShares = sub.num_shares || sub.units || null\r\n\r\n          // Calculate spread values if we have both price and cost\r\n          let spreadPerShare: number | null = null\r\n          let spreadFeeAmount: number | null = null\r\n          if (pricePerShare && costPerShare && pricePerShare > 0 && costPerShare > 0) {\r\n            spreadPerShare = pricePerShare - costPerShare\r\n            if (numShares && numShares > 0) {\r\n              spreadFeeAmount = spreadPerShare * Number(numShares)\r\n            }\r\n          }\r\n\r\n          // Step 1b: Update subscription status to 'active' and capture final spread values\r\n          const { error: statusError } = await supabase\r\n            .from('subscriptions')\r\n            .update({\r\n              status: 'active',\r\n              activated_at: new Date().toISOString(),\r\n              // Lock spread values at close time\r\n              ...(spreadPerShare !== null && { spread_per_share: spreadPerShare }),\r\n              ...(spreadFeeAmount !== null && { spread_fee_amount: spreadFeeAmount }),\r\n            })\r\n            .eq('id', sub.id)\r\n\r\n          if (statusError) {\r\n            result.errors.push(`Failed to activate subscription ${sub.id}: ${statusError.message}`)\r\n            continue\r\n          }\r\n          result.subscriptionsActivated++\r\n          console.log(`[termsheet-close] Activated subscription ${sub.id}`)\r\n\r\n          // Step 1b: Create position for this subscription\r\n          const fundedAmount = Number(sub.funded_amount) || 0\r\n          let positionUnits = sub.num_shares || sub.units\r\n          if (!positionUnits && sub.price_per_share) {\r\n            positionUnits = fundedAmount / Number(sub.price_per_share)\r\n          } else if (!positionUnits && sub.cost_per_share) {\r\n            positionUnits = fundedAmount / Number(sub.cost_per_share)\r\n          }\r\n\r\n          if (positionUnits && positionUnits > 0) {\r\n            const { data: existingPosition } = await supabase\r\n              .from('positions')\r\n              .select('id')\r\n              .eq('investor_id', sub.investor_id)\r\n              .eq('vehicle_id', sub.vehicle_id || deal.vehicle_id)\r\n              .maybeSingle()\r\n\r\n            if (!existingPosition) {\r\n              const { error: positionError } = await supabase\r\n                .from('positions')\r\n                .insert({\r\n                  investor_id: sub.investor_id,\r\n                  vehicle_id: sub.vehicle_id || deal.vehicle_id,\r\n                  units: positionUnits,\r\n                  cost_basis: fundedAmount,\r\n                  last_nav: sub.price_per_share || sub.cost_per_share,\r\n                  as_of_date: new Date().toISOString(),\r\n                })\r\n\r\n              if (positionError) {\r\n                result.errors.push(`Failed to create position for subscription ${sub.id}: ${positionError.message}`)\r\n              } else {\r\n                result.positionsCreated++\r\n                console.log(`[termsheet-close] Created position for subscription ${sub.id}: ${positionUnits} units`)\r\n              }\r\n            }\r\n          }\r\n\r\n          // Step 1c: Create commissions (based on fee plan linked to this termsheet)\r\n          if (dealMembership?.referred_by_entity_type && dealMembership.referred_by_entity_id) {\r\n            const feePlanId = dealMembership.assigned_fee_plan_id\r\n            if (feePlanId) {\r\n              const { data: feePlan } = await supabase\r\n                .from('fee_plans')\r\n                .select('id, status, is_active, introducer_id, partner_id, commercial_partner_id, fee_components(id, kind, rate_bps)')\r\n                .eq('id', feePlanId)\r\n                .eq('term_sheet_id', termsheetId)\r\n                .maybeSingle()\r\n\r\n              if (feePlan && feePlan.is_active && feePlan.status === 'accepted') {\r\n                const components = (feePlan.fee_components as any[]) || []\r\n                const subscriptionComponent = components.find((c: any) => c.kind === 'subscription')\r\n                const rateBps = subscriptionComponent?.rate_bps || 0\r\n\r\n                if (rateBps > 0) {\r\n                  // IMPORTANT: Commission basis is ALWAYS 'invested_amount' (funded_amount)\r\n                  // Per PRD: Commission basis NEVER includes management_fee\r\n                  // Commissions are calculated as: funded_amount √ó (rate_bps / 10000)\r\n                  const commissionAmount = (fundedAmount * rateBps) / 10000\r\n                  const currency = sub.currency || deal.currency || 'USD'\r\n                  const now = new Date().toISOString()\r\n\r\n                  // Create commission based on referrer type\r\n                  if (dealMembership.referred_by_entity_type === 'introducer' && feePlan.introducer_id === dealMembership.referred_by_entity_id) {\r\n                    const { data: existingCommission } = await supabase\r\n                      .from('introducer_commissions')\r\n                      .select('id')\r\n                      .eq('introducer_id', dealMembership.referred_by_entity_id)\r\n                      .eq('deal_id', termsheet.deal_id)\r\n                      .eq('investor_id', sub.investor_id)\r\n                      .maybeSingle()\r\n\r\n                    if (!existingCommission) {\r\n                      const { data: newCommission } = await supabase.from('introducer_commissions').insert({\r\n                        introducer_id: dealMembership.referred_by_entity_id,\r\n                        deal_id: termsheet.deal_id,\r\n                        investor_id: sub.investor_id,\r\n                        arranger_id: deal.arranger_entity_id || null,\r\n                        fee_plan_id: feePlanId,\r\n                        basis_type: 'invested_amount',\r\n                        rate_bps: rateBps,\r\n                        base_amount: fundedAmount,\r\n                        accrual_amount: commissionAmount,\r\n                        currency,\r\n                        status: 'accrued',\r\n                        created_at: now,\r\n                      }).select('id').single()\r\n                      result.commissionsCreated++\r\n\r\n                      // GAP-5 & GAP-7: Send commission accrual notification and audit log\r\n                      const investor = sub.investor as { display_name?: string; legal_name?: string } | null\r\n                      const investorName = investor?.display_name || investor?.legal_name || 'Investor'\r\n                      const accrualNotifications = await sendCommissionAccrualNotification(supabase, {\r\n                        entityType: 'introducer',\r\n                        entityId: dealMembership.referred_by_entity_id,\r\n                        dealId: termsheet.deal_id,\r\n                        dealName: deal.name || 'Deal',\r\n                        investorName,\r\n                        commissionAmount,\r\n                        currency,\r\n                        commissionId: newCommission?.id,\r\n                      })\r\n                      result.accrualNotificationsSent += accrualNotifications\r\n                    }\r\n                  } else if (dealMembership.referred_by_entity_type === 'partner' && feePlan.partner_id === dealMembership.referred_by_entity_id) {\r\n                    const { data: existingCommission } = await supabase\r\n                      .from('partner_commissions')\r\n                      .select('id')\r\n                      .eq('partner_id', dealMembership.referred_by_entity_id)\r\n                      .eq('deal_id', termsheet.deal_id)\r\n                      .eq('investor_id', sub.investor_id)\r\n                      .maybeSingle()\r\n\r\n                    if (!existingCommission) {\r\n                      const { data: newCommission } = await supabase.from('partner_commissions').insert({\r\n                        partner_id: dealMembership.referred_by_entity_id,\r\n                        deal_id: termsheet.deal_id,\r\n                        investor_id: sub.investor_id,\r\n                        arranger_id: deal.arranger_entity_id || null,\r\n                        fee_plan_id: feePlanId,\r\n                        basis_type: 'invested_amount',\r\n                        rate_bps: rateBps,\r\n                        base_amount: fundedAmount,\r\n                        accrual_amount: commissionAmount,\r\n                        currency,\r\n                        status: 'accrued',\r\n                        created_at: now,\r\n                      }).select('id').single()\r\n                      result.commissionsCreated++\r\n\r\n                      // GAP-5 & GAP-7: Send commission accrual notification and audit log\r\n                      const investor = sub.investor as { display_name?: string; legal_name?: string } | null\r\n                      const investorName = investor?.display_name || investor?.legal_name || 'Investor'\r\n                      const accrualNotifications = await sendCommissionAccrualNotification(supabase, {\r\n                        entityType: 'partner',\r\n                        entityId: dealMembership.referred_by_entity_id,\r\n                        dealId: termsheet.deal_id,\r\n                        dealName: deal.name || 'Deal',\r\n                        investorName,\r\n                        commissionAmount,\r\n                        currency,\r\n                        commissionId: newCommission?.id,\r\n                      })\r\n                      result.accrualNotificationsSent += accrualNotifications\r\n                    }\r\n                  } else if (dealMembership.referred_by_entity_type === 'commercial_partner' && feePlan.commercial_partner_id === dealMembership.referred_by_entity_id && deal.arranger_entity_id) {\r\n                    const { data: existingCommission } = await supabase\r\n                      .from('commercial_partner_commissions')\r\n                      .select('id')\r\n                      .eq('commercial_partner_id', dealMembership.referred_by_entity_id)\r\n                      .eq('deal_id', termsheet.deal_id)\r\n                      .eq('investor_id', sub.investor_id)\r\n                      .maybeSingle()\r\n\r\n                    if (!existingCommission) {\r\n                      const { data: newCommission } = await supabase.from('commercial_partner_commissions').insert({\r\n                        commercial_partner_id: dealMembership.referred_by_entity_id,\r\n                        deal_id: termsheet.deal_id,\r\n                        investor_id: sub.investor_id,\r\n                        arranger_id: deal.arranger_entity_id,\r\n                        fee_plan_id: feePlanId,\r\n                        basis_type: 'invested_amount',\r\n                        rate_bps: rateBps,\r\n                        base_amount: fundedAmount,\r\n                        accrual_amount: commissionAmount,\r\n                        currency,\r\n                        status: 'accrued',\r\n                        created_at: now,\r\n                      }).select('id').single()\r\n                      result.commissionsCreated++\r\n\r\n                      // GAP-5 & GAP-7: Send commission accrual notification and audit log\r\n                      const investor = sub.investor as { display_name?: string; legal_name?: string } | null\r\n                      const investorName = investor?.display_name || investor?.legal_name || 'Investor'\r\n                      const accrualNotifications = await sendCommissionAccrualNotification(supabase, {\r\n                        entityType: 'commercial_partner',\r\n                        entityId: dealMembership.referred_by_entity_id,\r\n                        dealId: termsheet.deal_id,\r\n                        dealName: deal.name || 'Deal',\r\n                        investorName,\r\n                        commissionAmount,\r\n                        currency,\r\n                        commissionId: newCommission?.id,\r\n                      })\r\n                      result.accrualNotificationsSent += accrualNotifications\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n\r\n          // Step 1d: Trigger certificate generation\r\n          await triggerCertificateGeneration({\r\n            supabase,\r\n            subscriptionId: sub.id,\r\n            investorId: sub.investor_id,\r\n            vehicleId: sub.vehicle_id || deal.vehicle_id,\r\n            commitment: sub.commitment || 0,\r\n            fundedAmount,\r\n            shares: sub.num_shares || sub.units,\r\n            pricePerShare: sub.price_per_share,\r\n            profile: triggerProfile,\r\n          })\r\n          result.certificatesTriggered++\r\n        } catch (subError) {\r\n          const msg = subError instanceof Error ? subError.message : 'Unknown error'\r\n          result.errors.push(`Processing failed for subscription ${sub.id}: ${msg}`)\r\n        }\r\n      }\r\n    } else {\r\n      console.log(`[termsheet-close] No funded subscriptions found for termsheet ${termsheetId}`)\r\n    }\r\n\r\n    // Step 2: Enable invoice_requests on fee_plans linked to THIS termsheet\r\n    const now = new Date().toISOString()\r\n    const { data: feePlans, error: feePlanError } = await supabase\r\n      .from('fee_plans')\r\n      .update({\r\n        invoice_requests_enabled: true,\r\n        invoice_requests_enabled_at: now,\r\n      })\r\n      .eq('deal_id', termsheet.deal_id)\r\n      .eq('term_sheet_id', termsheetId)\r\n      .eq('status', 'accepted')\r\n      .eq('invoice_requests_enabled', false)\r\n      .select('id, introducer_id, partner_id, commercial_partner_id, name')\r\n\r\n    if (feePlanError) {\r\n      result.errors.push(`Failed to enable invoice requests: ${feePlanError.message}`)\r\n    } else if (feePlans) {\r\n      result.feePlansEnabled = feePlans.length\r\n      console.log(`[termsheet-close] Enabled invoice requests for ${feePlans.length} fee plans`)\r\n\r\n      // Step 3: Send notifications to introducers/partners\r\n      for (const feePlan of feePlans) {\r\n        try {\r\n          await sendTermsheetCloseNotification(supabase, feePlan, deal, termsheet.version)\r\n          result.notificationsSent++\r\n        } catch (notifError) {\r\n          const msg = notifError instanceof Error ? notifError.message : 'Unknown error'\r\n          result.errors.push(`Notification failed for fee plan ${feePlan.id}: ${msg}`)\r\n        }\r\n      }\r\n    }\r\n\r\n    // Step 4: Mark TERMSHEET as processed (idempotency)\r\n    const { error: updateError } = await supabase\r\n      .from('deal_fee_structures')\r\n      .update({ closed_processed_at: now })\r\n      .eq('id', termsheetId)\r\n\r\n    if (updateError) {\r\n      result.errors.push(`Failed to mark termsheet as processed: ${updateError.message}`)\r\n    }\r\n\r\n    result.success = result.errors.length === 0\r\n    console.log(`[termsheet-close] Completed processing termsheet ${termsheetId}:`, {\r\n      subscriptions: result.subscriptionsActivated,\r\n      certificates: result.certificatesTriggered,\r\n      feePlansEnabled: result.feePlansEnabled,\r\n      notifications: result.notificationsSent,\r\n      errors: result.errors.length,\r\n    })\r\n\r\n    return result\r\n  } catch (error) {\r\n    const msg = error instanceof Error ? error.message : 'Unknown error'\r\n    result.errors.push(`Unexpected error: ${msg}`)\r\n    console.error(`[termsheet-close] Unexpected error processing termsheet ${termsheetId}:`, error)\r\n    return result\r\n  }\r\n}\r\n\r\n/**\r\n * Send notification to introducer/partner that invoice requests are now available (termsheet version)\r\n */\r\nasync function sendTermsheetCloseNotification(\r\n  supabase: SupabaseClient,\r\n  feePlan: {\r\n    id: string\r\n    introducer_id: string | null\r\n    partner_id: string | null\r\n    commercial_partner_id: string | null\r\n    name: string\r\n  },\r\n  deal: {\r\n    id: string\r\n    name: string\r\n    company_name: string | null\r\n  },\r\n  termsheetVersion: number\r\n): Promise<void> {\r\n  let entityType: string | null = null\r\n  let entityId: string | null = null\r\n  let userTable: string | null = null\r\n\r\n  if (feePlan.introducer_id) {\r\n    entityType = 'introducer'\r\n    entityId = feePlan.introducer_id\r\n    userTable = 'introducer_users'\r\n  } else if (feePlan.partner_id) {\r\n    entityType = 'partner'\r\n    entityId = feePlan.partner_id\r\n    userTable = 'partner_users'\r\n  } else if (feePlan.commercial_partner_id) {\r\n    entityType = 'commercial_partner'\r\n    entityId = feePlan.commercial_partner_id\r\n    userTable = 'commercial_partner_users'\r\n  }\r\n\r\n  if (!entityType || !entityId || !userTable) {\r\n    return\r\n  }\r\n\r\n  const { data: entityUsers } = await supabase\r\n    .from(userTable)\r\n    .select('user_id')\r\n    .eq(`${entityType}_id`, entityId)\r\n\r\n  if (!entityUsers || entityUsers.length === 0) {\r\n    return\r\n  }\r\n\r\n  const dealName = deal.company_name || deal.name\r\n  const title = 'Termsheet Closed - Invoice Requests Available'\r\n  const message = `The termsheet v${termsheetVersion} for \"${dealName}\" has reached its completion date. You can now submit invoice requests for your fee agreement \"${feePlan.name}\".`\r\n  const link = '/versotech_main/fee-plans'\r\n\r\n  for (const { user_id } of entityUsers) {\r\n    try {\r\n      await createInvestorNotification({\r\n        userId: user_id,\r\n        title,\r\n        message,\r\n        link,\r\n        type: 'introducer_invoice_sent',\r\n        sendEmailNotification: true,\r\n        dealId: deal.id,\r\n      })\r\n    } catch (error) {\r\n      console.error(`[termsheet-close] Failed to create notification for user ${user_id}:`, error)\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","ignoreList":[1]}