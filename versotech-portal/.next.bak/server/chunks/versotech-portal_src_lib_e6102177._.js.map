{"version":3,"sources":["../../../../versotech-portal/src/lib/email/resend-service.ts","../../../../versotech-portal/src/lib/notifications.ts"],"sourcesContent":["/**\r\n * Email Service - Resend API Integration\r\n *\r\n * Centralized email sending service for all platform notifications.\r\n * Uses Resend API for reliable email delivery with proper error handling.\r\n */\r\n\r\ninterface EmailOptions {\r\n  to: string | string[]\r\n  subject: string\r\n  html: string\r\n  from?: string\r\n}\r\n\r\ninterface EmailResult {\r\n  success: boolean\r\n  messageId?: string\r\n  error?: string\r\n}\r\n\r\n// Use Resend's shared domain for testing until client verifies versoholdings.com\r\n// Change to 'VERSO <noreply@versoholdings.com>' after domain verification\r\nconst DEFAULT_FROM = process.env.EMAIL_FROM || 'VERSO <onboarding@resend.dev>'\r\nconst RESEND_API_KEY = process.env.RESEND_API_KEY\r\n\r\n// Validate API key at module load time in production\r\nif (process.env.NODE_ENV === 'production') {\r\n  if (!RESEND_API_KEY) {\r\n    console.error('CRITICAL: RESEND_API_KEY not configured in production')\r\n  } else if (RESEND_API_KEY === 're_your_resend_api_key_here') {\r\n    console.error('CRITICAL: RESEND_API_KEY cannot use example value in production. Please set a valid Resend API key.')\r\n  } else if (RESEND_API_KEY.startsWith('re_test_')) {\r\n    console.error('CRITICAL: RESEND_API_KEY cannot use test key in production. Please set a valid production Resend API key.')\r\n  }\r\n}\r\n\r\n/**\r\n * Send an email using Resend API\r\n */\r\nexport async function sendEmail(options: EmailOptions): Promise<EmailResult> {\r\n  try {\r\n    if (!RESEND_API_KEY || RESEND_API_KEY === 're_your_resend_api_key_here') {\r\n      console.error('Resend API key not configured')\r\n      return {\r\n        success: false,\r\n        error: 'Email service not configured. Please set RESEND_API_KEY environment variable.',\r\n      }\r\n    }\r\n\r\n    // Additional runtime check for test keys\r\n    if (RESEND_API_KEY.startsWith('re_test_')) {\r\n      console.error('Test API key detected - emails will not be delivered')\r\n      return {\r\n        success: false,\r\n        error: 'Test API key cannot be used for sending real emails.',\r\n      }\r\n    }\r\n\r\n    const fromAddress = options.from || DEFAULT_FROM\r\n    const response = await fetch('https://api.resend.com/emails', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${RESEND_API_KEY}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({\r\n        from: fromAddress,\r\n        to: options.to,\r\n        subject: options.subject,\r\n        html: options.html,\r\n      }),\r\n    })\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.error('Resend API error:', errorText)\r\n      return {\r\n        success: false,\r\n        error: `Email send failed: ${response.status} ${response.statusText}`,\r\n      }\r\n    }\r\n\r\n    const data = await response.json()\r\n    if (process.env.NODE_ENV !== 'production') {\r\n      console.info('[resend] Email sent', {\r\n        id: data.id,\r\n        from: fromAddress,\r\n        to: options.to,\r\n        subject: options.subject\r\n      })\r\n    }\r\n    return {\r\n      success: true,\r\n      messageId: data.id,\r\n    }\r\n  } catch (error: any) {\r\n    console.error('Email sending error:', error)\r\n    return {\r\n      success: false,\r\n      error: error.message || 'Unknown email error',\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Send staff invitation email with login credentials\r\n */\r\nexport async function sendStaffInvitation(params: {\r\n  email: string\r\n  displayName: string\r\n  title: string\r\n  tempPassword: string\r\n  loginUrl: string\r\n}): Promise<EmailResult> {\r\n  const html = `\r\n    <!DOCTYPE html>\r\n    <html>\r\n    <head>\r\n      <style>\r\n        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n        .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n        .header { background: #1a1a2e; color: white; padding: 30px; text-align: center; }\r\n        .content { background: #f4f4f4; padding: 30px; }\r\n        .button { background: #6366f1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; margin: 20px 0; }\r\n        .credentials { background: white; padding: 20px; border-left: 4px solid #6366f1; margin: 20px 0; }\r\n        .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }\r\n      </style>\r\n    </head>\r\n    <body>\r\n      <div class=\"container\">\r\n        <div class=\"header\">\r\n          <h1>Welcome to VERSO</h1>\r\n        </div>\r\n        <div class=\"content\">\r\n          <h2>Hi ${params.displayName},</h2>\r\n          <p>You've been invited to join VERSO as a <strong>${params.title}</strong>.</p>\r\n\r\n          <div class=\"credentials\">\r\n            <h3>Your Login Credentials</h3>\r\n            <p><strong>Email:</strong> ${params.email}</p>\r\n            <p><strong>Temporary Password:</strong> <code style=\"background: #f0f0f0; padding: 4px 8px; border-radius: 4px;\">${params.tempPassword}</code></p>\r\n          </div>\r\n\r\n          <p><strong>Important:</strong> Please change your password immediately after your first login for security purposes.</p>\r\n\r\n          <a href=\"${params.loginUrl}\" class=\"button\">Login to VERSO</a>\r\n\r\n          <p>If you have any questions, please contact your administrator.</p>\r\n        </div>\r\n        <div class=\"footer\">\r\n          <p>&copy; ${new Date().getFullYear()} VERSO. All rights reserved.</p>\r\n          <p>This is an automated message, please do not reply.</p>\r\n        </div>\r\n      </div>\r\n    </body>\r\n    </html>\r\n  `\r\n\r\n  return sendEmail({\r\n    to: params.email,\r\n    subject: 'Welcome to VERSO - Your Account Details',\r\n    html,\r\n  })\r\n}\r\n\r\n/**\r\n * Send password reset email\r\n * Uses clean, minimal design matching VERSO brand\r\n */\r\nexport async function sendPasswordResetEmail(params: {\r\n  email: string\r\n  displayName?: string\r\n  resetUrl: string\r\n}): Promise<EmailResult> {\r\n  const displayName = params.displayName || params.email.split('@')[0]\r\n\r\n  const html = `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <!--[if mso]>\r\n  <style type=\"text/css\">\r\n    body, table, td {font-family: Arial, Helvetica, sans-serif !important;}\r\n  </style>\r\n  <![endif]-->\r\n  <link href=\"https://fonts.googleapis.com/css2?family=League+Spartan:wght@700;800&display=swap\" rel=\"stylesheet\">\r\n  <style>\r\n    body {\r\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\r\n      line-height: 1.7;\r\n      color: #1a1a1a;\r\n      background: #ffffff;\r\n      margin: 0;\r\n      padding: 0;\r\n    }\r\n    .container {\r\n      max-width: 600px;\r\n      margin: 0 auto;\r\n      padding: 50px 40px;\r\n      background: #ffffff;\r\n    }\r\n    .logo-container {\r\n      text-align: center;\r\n      margin-bottom: 50px;\r\n      padding-bottom: 30px;\r\n      border-bottom: 1px solid #f0f0f0;\r\n    }\r\n    .logo {\r\n      font-family: 'League Spartan', Arial, Helvetica, sans-serif;\r\n      font-size: 48px;\r\n      font-weight: 800;\r\n      letter-spacing: 8px;\r\n      color: #000000;\r\n      text-transform: uppercase;\r\n      margin: 0;\r\n    }\r\n    .greeting {\r\n      font-size: 16px;\r\n      margin-bottom: 30px;\r\n    }\r\n    .content {\r\n      font-size: 15px;\r\n      color: #333333;\r\n    }\r\n    .content p {\r\n      margin-bottom: 20px;\r\n    }\r\n    .alert-box {\r\n      background: #fef3cd;\r\n      border-left: 4px solid #ffc107;\r\n      padding: 15px 20px;\r\n      margin: 25px 0;\r\n      font-size: 14px;\r\n    }\r\n    .button-container {\r\n      text-align: center;\r\n      margin: 45px 0;\r\n    }\r\n    .button {\r\n      display: inline-block;\r\n      background: #000000;\r\n      color: #ffffff !important;\r\n      padding: 16px 40px;\r\n      text-decoration: none;\r\n      border-radius: 4px;\r\n      font-weight: 600;\r\n      font-size: 14px;\r\n      letter-spacing: 1px;\r\n      text-transform: uppercase;\r\n    }\r\n    .footer {\r\n      margin-top: 50px;\r\n      padding-top: 30px;\r\n      border-top: 1px solid #f0f0f0;\r\n      font-size: 12px;\r\n      color: #999999;\r\n      text-align: center;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <div class=\"logo-container\">\r\n      <div class=\"logo\">VERSO</div>\r\n    </div>\r\n\r\n    <div class=\"greeting\">Dear ${displayName},</div>\r\n\r\n    <div class=\"content\">\r\n      <p>We received a request to reset the password for your VERSO account.</p>\r\n      <p>Click the button below to create a new password. For security reasons, this link will expire in 1 hour.</p>\r\n    </div>\r\n\r\n    <div class=\"button-container\">\r\n      <a href=\"${params.resetUrl}\" class=\"button\">Reset Password</a>\r\n    </div>\r\n\r\n    <div class=\"content\">\r\n      <div class=\"alert-box\">\r\n        <strong>Didn't request this?</strong><br>\r\n        If you didn't request a password reset, you can safely ignore this email. Your password will remain unchanged.\r\n      </div>\r\n      <p style=\"font-size: 13px; color: #666666;\">If you're having trouble clicking the button, copy and paste the following link into your browser:</p>\r\n      <p style=\"font-size: 12px; color: #999999; word-break: break-all;\">${params.resetUrl}</p>\r\n    </div>\r\n\r\n    <div class=\"footer\">\r\n      &copy; ${new Date().getFullYear()} VERSO. All rights reserved.\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n  `\r\n\r\n  return sendEmail({\r\n    to: params.email,\r\n    subject: 'Reset Your Password - VERSO',\r\n    html,\r\n  })\r\n}\r\n\r\n/**\r\n * Send security alert email (account changes, permission changes, etc.)\r\n */\r\nexport async function sendSecurityAlertEmail(params: {\r\n  email: string\r\n  displayName: string\r\n  alertType: 'account_deactivated' | 'permissions_changed' | 'password_changed'\r\n  details: string\r\n}): Promise<EmailResult> {\r\n  const alertTitles = {\r\n    account_deactivated: 'Account Deactivated',\r\n    permissions_changed: 'Account Permissions Changed',\r\n    password_changed: 'Password Changed',\r\n  }\r\n\r\n  const html = `\r\n    <!DOCTYPE html>\r\n    <html>\r\n    <head>\r\n      <style>\r\n        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n        .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n        .header { background: #dc2626; color: white; padding: 30px; text-align: center; }\r\n        .content { background: #f4f4f4; padding: 30px; }\r\n        .alert { background: #fef2f2; border-left: 4px solid #dc2626; padding: 15px; margin: 20px 0; }\r\n        .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }\r\n      </style>\r\n    </head>\r\n    <body>\r\n      <div class=\"container\">\r\n        <div class=\"header\">\r\n          <h1>Security Alert</h1>\r\n        </div>\r\n        <div class=\"content\">\r\n          <h2>Hi ${params.displayName},</h2>\r\n\r\n          <div class=\"alert\">\r\n            <h3>${alertTitles[params.alertType]}</h3>\r\n            <p>${params.details}</p>\r\n          </div>\r\n\r\n          <p>If you did not authorize this change or have any concerns, please contact your administrator immediately.</p>\r\n\r\n          <p><strong>Action taken:</strong> ${new Date().toLocaleString()}</p>\r\n        </div>\r\n        <div class=\"footer\">\r\n          <p>&copy; ${new Date().getFullYear()} VERSO. All rights reserved.</p>\r\n          <p>This is an automated security alert, please do not reply.</p>\r\n        </div>\r\n      </div>\r\n    </body>\r\n    </html>\r\n  `\r\n\r\n  return sendEmail({\r\n    to: params.email,\r\n    subject: `Security Alert: ${alertTitles[params.alertType]} - VERSO`,\r\n    html,\r\n  })\r\n}\r\n\r\n/**\r\n * Send invitation email to join the platform\r\n * Uses clean, minimal design matching VERSO brand\r\n * Note: Does not include invitee name for privacy - just a simple invite to join\r\n */\r\nexport async function sendInvitationEmail(params: {\r\n  email: string\r\n  inviteeName?: string\r\n  entityName: string\r\n  entityType: string\r\n  role: string\r\n  inviterName: string\r\n  acceptUrl: string\r\n  expiresAt: string\r\n}): Promise<EmailResult> {\r\n  const isInvestor = params.entityType === 'investor'\r\n  const isStaff = params.entityType === 'staff' || ['staff_admin', 'staff_ops', 'staff_rm', 'ceo'].includes(params.role)\r\n\r\n  // Role display names\r\n  const roleDisplayNames: Record<string, string> = {\r\n    staff_admin: 'Staff Administrator',\r\n    staff_ops: 'Operations Staff',\r\n    staff_rm: 'Relationship Manager',\r\n    ceo: 'Chief Executive Officer',\r\n    member: 'Member',\r\n    admin: 'Administrator',\r\n    owner: 'Owner',\r\n    signatory: 'Authorized Signatory',\r\n  }\r\n\r\n  const displayRole = roleDisplayNames[params.role] || params.role\r\n\r\n  // Investor-specific content\r\n  const investorContent = `\r\n    <p>You have been invited to join <strong>${params.entityName}</strong> on the VERSO Investment Platform.</p>\r\n    <p>This secure platform provides you with comprehensive access to your investment portfolio, performance analytics, and exclusive deal opportunities.</p>\r\n    <p>Click the button below to set up your account and access the platform.</p>\r\n  `\r\n\r\n  // Staff-specific content\r\n  const staffContent = `\r\n    <p>You have been invited to join <strong>VERSO</strong> as a <strong>${displayRole}</strong>.</p>\r\n    <p>As a member of the VERSO team, you'll have access to investor management, deal operations, and administrative tools.</p>\r\n    <p>Click the button below to set up your password and access your dashboard.</p>\r\n  `\r\n\r\n  // Other professionals (lawyer, arranger, partner, etc.)\r\n  const professionalContent = `\r\n    <p>You have been invited to join <strong>${params.entityName}</strong> on the VERSO Platform.</p>\r\n    <p>This platform provides access to deal management, document processing, and collaboration tools for your organization.</p>\r\n    <p>Click the button below to set up your account and get started.</p>\r\n  `\r\n\r\n  // Select the appropriate content\r\n  const emailContent = isInvestor ? investorContent : (isStaff ? staffContent : professionalContent)\r\n\r\n  const html = `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <!--[if mso]>\r\n  <style type=\"text/css\">\r\n    body, table, td {font-family: Arial, Helvetica, sans-serif !important;}\r\n  </style>\r\n  <![endif]-->\r\n  <link href=\"https://fonts.googleapis.com/css2?family=League+Spartan:wght@700;800&display=swap\" rel=\"stylesheet\">\r\n  <style>\r\n    body {\r\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\r\n      line-height: 1.7;\r\n      color: #1a1a1a;\r\n      background: #ffffff;\r\n      margin: 0;\r\n      padding: 0;\r\n    }\r\n    .container {\r\n      max-width: 600px;\r\n      margin: 0 auto;\r\n      padding: 50px 40px;\r\n      background: #ffffff;\r\n    }\r\n    .logo-container {\r\n      text-align: center;\r\n      margin-bottom: 50px;\r\n      padding-bottom: 30px;\r\n      border-bottom: 1px solid #f0f0f0;\r\n    }\r\n    .logo {\r\n      font-family: 'League Spartan', Arial, Helvetica, sans-serif;\r\n      font-size: 48px;\r\n      font-weight: 800;\r\n      letter-spacing: 8px;\r\n      color: #000000;\r\n      text-transform: uppercase;\r\n      margin: 0;\r\n    }\r\n    .content {\r\n      font-size: 15px;\r\n      color: #333333;\r\n    }\r\n    .content p {\r\n      margin-bottom: 20px;\r\n    }\r\n    .button-container {\r\n      text-align: center;\r\n      margin: 45px 0;\r\n    }\r\n    .button {\r\n      display: inline-block;\r\n      background: #000000;\r\n      color: #ffffff !important;\r\n      padding: 16px 40px;\r\n      text-decoration: none;\r\n      border-radius: 4px;\r\n      font-weight: 600;\r\n      font-size: 14px;\r\n      letter-spacing: 1px;\r\n      text-transform: uppercase;\r\n    }\r\n    .footer {\r\n      margin-top: 50px;\r\n      padding-top: 30px;\r\n      border-top: 1px solid #f0f0f0;\r\n      font-size: 12px;\r\n      color: #999999;\r\n      text-align: center;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <div class=\"logo-container\">\r\n      <div class=\"logo\">VERSO</div>\r\n    </div>\r\n\r\n    <div class=\"content\">\r\n      ${emailContent}\r\n    </div>\r\n\r\n    <div class=\"button-container\">\r\n      <a href=\"${params.acceptUrl}\" class=\"button\">Accept Invitation</a>\r\n    </div>\r\n\r\n    <div class=\"footer\">\r\n      &copy; ${new Date().getFullYear()} VERSO. All rights reserved.\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n  `\r\n\r\n  // Subject line varies by type\r\n  const subject = isStaff\r\n    ? `Welcome to VERSO - You've been invited as ${displayRole}`\r\n    : isInvestor\r\n      ? `You've been invited to join ${params.entityName} on VERSO`\r\n      : `You've been invited to join ${params.entityName} on VERSO`\r\n\r\n  return sendEmail({\r\n    to: params.email,\r\n    subject,\r\n    html,\r\n  })\r\n}\r\n\r\n/**\r\n * Send signature request email with signing link\r\n */\r\nexport async function sendSignatureRequestEmail(params: {\r\n  email: string\r\n  signerName: string\r\n  documentType: string\r\n  signingUrl: string\r\n  expiresAt: string\r\n}): Promise<EmailResult> {\r\n  const expiryDate = new Date(params.expiresAt)\r\n  const daysUntilExpiry = Math.ceil((expiryDate.getTime() - Date.now()) / (24 * 60 * 60 * 1000))\r\n\r\n  const documentTypeLabels: Record<string, string> = {\r\n    nda: 'Non-Disclosure Agreement',\r\n    subscription: 'Subscription Agreement',\r\n    amendment: 'Amendment',\r\n    other: 'Document'\r\n  }\r\n\r\n  const documentLabel = documentTypeLabels[params.documentType] || 'Document'\r\n\r\n  const html = `\r\n    <!DOCTYPE html>\r\n    <html>\r\n    <head>\r\n      <style>\r\n        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n        .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n        .header { background: #1a1a2e; color: white; padding: 30px; text-align: center; }\r\n        .content { background: #f4f4f4; padding: 30px; }\r\n        .button { background: #6366f1; color: white; padding: 14px 28px; text-decoration: none; border-radius: 6px; display: inline-block; margin: 20px 0; font-weight: 600; }\r\n        .alert-box { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 15px; margin: 20px 0; }\r\n        .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }\r\n      </style>\r\n    </head>\r\n    <body>\r\n      <div class=\"container\">\r\n        <div class=\"header\">\r\n          <h1>Document Ready for Signature</h1>\r\n        </div>\r\n        <div class=\"content\">\r\n          <h2>Hi ${params.signerName},</h2>\r\n          <p>Your <strong>${documentLabel}</strong> is ready for your electronic signature.</p>\r\n\r\n          <div class=\"alert-box\">\r\n            <p><strong>‚è∞ Time Sensitive:</strong> This signature link expires in ${daysUntilExpiry} days (${expiryDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}).</p>\r\n          </div>\r\n\r\n          <p>To review and sign the document, click the button below:</p>\r\n\r\n          <a href=\"${params.signingUrl}\" class=\"button\">Review and Sign Document</a>\r\n\r\n          <p style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 14px; color: #666;\">\r\n            <strong>What happens next?</strong><br>\r\n            1. Click the link above to view the document<br>\r\n            2. Review the content carefully<br>\r\n            3. Draw or upload your signature<br>\r\n            4. Submit to complete the signing process\r\n          </p>\r\n\r\n          <p style=\"font-size: 13px; color: #666; margin-top: 20px;\">\r\n            If you have any questions, please contact VERSO support.\r\n          </p>\r\n        </div>\r\n        <div class=\"footer\">\r\n          <p>&copy; ${new Date().getFullYear()} VERSO. All rights reserved.</p>\r\n          <p>This is an automated message, please do not reply.</p>\r\n        </div>\r\n      </div>\r\n    </body>\r\n    </html>\r\n  `\r\n\r\n  return sendEmail({\r\n    to: params.email,\r\n    subject: `${documentLabel} Ready for Your Signature - VERSO`,\r\n    html,\r\n  })\r\n}\r\n","import { createServiceClient } from '@/lib/supabase/server'\r\nimport { sendEmail } from '@/lib/email/resend-service'\r\n\r\n/**\r\n * Notification types for categorizing investor notifications.\r\n */\r\nexport type NotificationType =\r\n  | 'kyc_status'\r\n  | 'deal_invite'\r\n  | 'deal_access'\r\n  | 'document'\r\n  | 'task'\r\n  | 'capital_call'\r\n  | 'approval'\r\n  | 'subscription'\r\n  | 'nda_complete'\r\n  | 'certificate_issued'\r\n  | 'escrow_confirmed'\r\n  | 'system'\r\n  // Introducer notification types (PRD Section 6.6)\r\n  | 'introducer_agreement_signed'      // Row 86: Agreement signed\r\n  | 'introducer_agreement_rejected'    // Row 88: Agreement rejected\r\n  | 'introducer_agreement_pending'     // Agreement pending signature\r\n  | 'introducer_pack_sent'             // Row 91: Pack sent to referred investor\r\n  | 'introducer_pack_approved'         // Row 92: Pack approved by referred investor\r\n  | 'introducer_pack_signed'           // Row 93: Pack signed by referred investor\r\n  | 'introducer_escrow_funded'         // Row 94: Escrow funded by referred investor\r\n  | 'introducer_invoice_requested'     // Invoice requested by arranger\r\n  | 'introducer_invoice_sent'          // Row 95: Invoice submitted\r\n  | 'introducer_payment_sent'          // Row 96: Payment sent\r\n  | 'introducer_commission_accrued'    // Commission accrued\r\n  | 'introducer_invoice_approved'      // Row 103: Invoice approved by CEO\r\n  | 'introducer_invoice_rejected'      // Row 104: Invoice rejected (request for change)\r\n  | 'introducer_payment_confirmed'     // Row 105: Payment confirmed\r\n  // Partner notification types (PRD Section 5.6)\r\n  | 'partner_commission_accrued'\r\n  | 'partner_invoice_requested'\r\n  | 'partner_invoice_submitted'\r\n  | 'partner_invoiced'\r\n  | 'partner_paid'\r\n  | 'partner_rejected'\r\n  // Commercial partner notification types\r\n  | 'cp_commission_accrued'\r\n  | 'cp_invoice_requested'\r\n  | 'cp_invoice_submitted'\r\n  | 'cp_invoice_approved'\r\n  | 'cp_invoice_rejected'\r\n  | 'cp_payment_confirmed'\r\n  // Deal share types (PRD Rows 95-96)\r\n  | 'deal_shared'\r\n  | 'partner_deal_share'\r\n\r\nexport interface CreateNotificationParams {\r\n  /** The user_id (profile) to notify */\r\n  userId: string\r\n  /** Optional investor_id if this notification relates to a specific investor entity */\r\n  investorId?: string\r\n  /** Notification title (displayed prominently) */\r\n  title: string\r\n  /** Notification message body */\r\n  message: string\r\n  /** Optional link for navigation when clicked */\r\n  link?: string\r\n  /** Notification type for categorization */\r\n  type: NotificationType\r\n  /** Additional metadata to store with the notification */\r\n  extraMetadata?: Record<string, unknown>\r\n  /** Whether to also send an email (default: true for important notifications) */\r\n  sendEmailNotification?: boolean\r\n  /** User ID who triggered this notification (for \"assigned by me\" filtering) */\r\n  createdBy?: string\r\n  /** Related deal ID for deal-specific notifications */\r\n  dealId?: string\r\n}\r\n\r\n// Notification types that should trigger email notifications\r\nconst EMAIL_NOTIFICATION_TYPES: NotificationType[] = [\r\n  'certificate_issued',\r\n  'subscription',\r\n  'capital_call',\r\n  'escrow_confirmed',\r\n  'deal_invite',\r\n  'kyc_status',\r\n  // GAP-13 FIX: Add introducer notification types for email delivery\r\n  'introducer_agreement_signed',\r\n  'introducer_agreement_pending',\r\n  'introducer_commission_accrued',\r\n  'introducer_invoice_sent',\r\n  'introducer_payment_confirmed',\r\n  // Partner notification types\r\n  'partner_commission_accrued',\r\n  'partner_paid',\r\n  // Commercial partner notification types\r\n  'cp_commission_accrued',\r\n  'cp_invoice_requested',\r\n  'cp_invoice_submitted',\r\n  'cp_invoice_approved',\r\n  'cp_invoice_rejected',\r\n  'cp_payment_confirmed',\r\n]\r\n\r\n/**\r\n * Creates an investor notification and optionally sends an email.\r\n * Uses the service client to bypass RLS for admin operations.\r\n *\r\n * @example\r\n * await createInvestorNotification({\r\n *   userId: 'user-uuid',\r\n *   investorId: 'investor-uuid',\r\n *   title: 'KYC Approved',\r\n *   message: 'Your KYC documents have been approved.',\r\n *   link: '/versoholdings/documents',\r\n *   type: 'kyc_status'\r\n * })\r\n */\r\nexport async function createInvestorNotification(params: CreateNotificationParams): Promise<void> {\r\n  const supabase = createServiceClient()\r\n\r\n  // Create database notification with all fields including new columns\r\n  const { error } = await supabase.from('investor_notifications').insert({\r\n    user_id: params.userId,\r\n    investor_id: params.investorId ?? null,\r\n    title: params.title,\r\n    message: params.message,\r\n    link: params.link ?? null,\r\n    type: params.type,\r\n    created_by: params.createdBy ?? null,\r\n    deal_id: params.dealId ?? null\r\n  })\r\n\r\n  if (error) {\r\n    console.error('[notifications] Failed to create notification:', error)\r\n    throw new Error(`Failed to create notification: ${error.message}`)\r\n  }\r\n\r\n  // Send email for important notification types\r\n  const shouldSendEmail = params.sendEmailNotification !== false &&\r\n    EMAIL_NOTIFICATION_TYPES.includes(params.type)\r\n\r\n  if (shouldSendEmail) {\r\n    try {\r\n      // Get user email\r\n      const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('email, display_name')\r\n        .eq('id', params.userId)\r\n        .single()\r\n\r\n      if (profile?.email) {\r\n        const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://app.versoholdings.com'\r\n        const fullLink = params.link ? `${appUrl}${params.link}` : appUrl\r\n\r\n        await sendEmail({\r\n          to: profile.email,\r\n          subject: `${params.title} - VERSO Holdings`,\r\n          html: generateNotificationEmail({\r\n            recipientName: profile.display_name || 'Investor',\r\n            title: params.title,\r\n            message: params.message,\r\n            link: fullLink,\r\n            type: params.type\r\n          })\r\n        })\r\n        console.log(`[notifications] Email sent to ${profile.email} for ${params.type}`)\r\n      }\r\n    } catch (emailError) {\r\n      console.error('[notifications] Failed to send email notification:', emailError)\r\n      // Don't throw - email failure shouldn't block the notification creation\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Creates notifications for all users linked to an investor entity\r\n */\r\nexport async function createInvestorNotificationForAll(params: Omit<CreateNotificationParams, 'userId'> & { investorId: string }): Promise<void> {\r\n  const supabase = createServiceClient()\r\n\r\n  // Get all users linked to this investor\r\n  const { data: investorUsers } = await supabase\r\n    .from('investor_users')\r\n    .select('user_id')\r\n    .eq('investor_id', params.investorId)\r\n\r\n  if (!investorUsers || investorUsers.length === 0) {\r\n    console.warn(`[notifications] No users found for investor ${params.investorId}`)\r\n    return\r\n  }\r\n\r\n  // Create notification for each user\r\n  for (const iu of investorUsers) {\r\n    await createInvestorNotification({\r\n      ...params,\r\n      userId: iu.user_id\r\n    })\r\n  }\r\n}\r\n\r\n/**\r\n * Generate HTML email for notification\r\n */\r\nfunction generateNotificationEmail(params: {\r\n  recipientName: string\r\n  title: string\r\n  message: string\r\n  link: string\r\n  type: NotificationType\r\n}): string {\r\n  const typeColors: Partial<Record<NotificationType, string>> = {\r\n    // Core types\r\n    certificate_issued: '#10b981', // green\r\n    subscription: '#6366f1', // indigo\r\n    capital_call: '#f59e0b', // amber\r\n    escrow_confirmed: '#10b981', // green\r\n    deal_invite: '#8b5cf6', // purple\r\n    kyc_status: '#3b82f6', // blue\r\n    deal_access: '#6366f1',\r\n    document: '#6366f1',\r\n    task: '#f59e0b',\r\n    approval: '#10b981',\r\n    nda_complete: '#10b981',\r\n    system: '#6b7280',\r\n  // Introducer types (PRD Section 6.6)\r\n  introducer_agreement_signed: '#10b981',\r\n  introducer_agreement_rejected: '#ef4444',\r\n  introducer_agreement_pending: '#f59e0b',\r\n  introducer_pack_sent: '#6366f1',\r\n  introducer_pack_approved: '#10b981',\r\n  introducer_pack_signed: '#10b981',\r\n  introducer_escrow_funded: '#10b981',\r\n  introducer_invoice_requested: '#6366f1',\r\n  introducer_invoice_sent: '#6366f1',\r\n  introducer_payment_sent: '#10b981',\r\n  introducer_commission_accrued: '#8b5cf6',\r\n  introducer_invoice_approved: '#10b981',\r\n  introducer_invoice_rejected: '#ef4444',\r\n  introducer_payment_confirmed: '#10b981',\r\n  // Partner types (PRD Section 5.6)\r\n  partner_commission_accrued: '#8b5cf6',\r\n  partner_invoice_requested: '#6366f1',\r\n  partner_invoice_submitted: '#6366f1',\r\n  partner_invoiced: '#10b981',\r\n  partner_paid: '#10b981',\r\n  partner_rejected: '#ef4444',\r\n  // Commercial partner types\r\n  cp_commission_accrued: '#8b5cf6',\r\n  cp_invoice_requested: '#6366f1',\r\n  cp_invoice_submitted: '#6366f1',\r\n  cp_invoice_approved: '#10b981',\r\n  cp_invoice_rejected: '#ef4444',\r\n  cp_payment_confirmed: '#10b981',\r\n    // Deal share types\r\n    deal_shared: '#3b82f6',\r\n    partner_deal_share: '#3b82f6'\r\n  }\r\n\r\n  const accentColor = typeColors[params.type] || '#6366f1'\r\n\r\n  // All styles are inline for email client compatibility (Gmail, Outlook strip <style> tags)\r\n  return `\r\n    <!DOCTYPE html>\r\n    <html>\r\n    <head>\r\n      <meta charset=\"utf-8\">\r\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    </head>\r\n    <body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333333; margin: 0; padding: 0; background-color: #f4f4f4;\">\r\n      <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background-color: #f4f4f4;\">\r\n        <tr>\r\n          <td align=\"center\" style=\"padding: 20px 0;\">\r\n            <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"max-width: 600px; margin: 0 auto; background-color: #ffffff;\">\r\n              <!-- Header -->\r\n              <tr>\r\n                <td style=\"background-color: #1a1a2e; color: #ffffff; padding: 30px; text-align: center;\">\r\n                  <h1 style=\"margin: 0; font-size: 24px; font-weight: bold; color: #ffffff;\">VERSO Holdings</h1>\r\n                </td>\r\n              </tr>\r\n              <!-- Accent Bar -->\r\n              <tr>\r\n                <td style=\"height: 4px; background-color: ${accentColor};\"></td>\r\n              </tr>\r\n              <!-- Content -->\r\n              <tr>\r\n                <td style=\"background-color: #ffffff; padding: 30px;\">\r\n                  <h2 style=\"color: #1a1a2e; margin-top: 0; margin-bottom: 16px; font-size: 20px;\">${params.title}</h2>\r\n                  <p style=\"margin: 0 0 16px 0; color: #333333;\">Hi ${params.recipientName},</p>\r\n\r\n                  <!-- Message Box -->\r\n                  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"margin: 20px 0;\">\r\n                    <tr>\r\n                      <td style=\"background-color: #f8fafc; border-left: 4px solid ${accentColor}; padding: 20px;\">\r\n                        <p style=\"margin: 0; color: #333333;\">${params.message}</p>\r\n                      </td>\r\n                    </tr>\r\n                  </table>\r\n\r\n                  <!-- Button -->\r\n                  <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"margin: 20px 0;\">\r\n                    <tr>\r\n                      <td style=\"background-color: ${accentColor}; border-radius: 6px;\">\r\n                        <a href=\"${params.link}\" style=\"display: inline-block; padding: 14px 28px; color: #ffffff; text-decoration: none; font-weight: 600; font-size: 14px;\">View in Portal</a>\r\n                      </td>\r\n                    </tr>\r\n                  </table>\r\n\r\n                  <p style=\"color: #666666; font-size: 14px; margin-top: 30px; margin-bottom: 0;\">\r\n                    If you have any questions, please contact our team through the platform.\r\n                  </p>\r\n                </td>\r\n              </tr>\r\n              <!-- Footer -->\r\n              <tr>\r\n                <td style=\"background-color: #f8fafc; text-align: center; padding: 20px;\">\r\n                  <p style=\"margin: 0 0 8px 0; color: #666666; font-size: 12px;\">&copy; ${new Date().getFullYear()} VERSO Holdings. All rights reserved.</p>\r\n                  <p style=\"margin: 0; color: #666666; font-size: 12px;\">This is an automated notification. Please do not reply to this email.</p>\r\n                </td>\r\n              </tr>\r\n            </table>\r\n          </td>\r\n        </tr>\r\n      </table>\r\n    </body>\r\n    </html>\r\n  `\r\n}\r\n\r\n/**\r\n * Helper to resolve the primary user_id for an investor.\r\n * Returns the first user linked to the investor (by created_at).\r\n */\r\nexport async function getInvestorPrimaryUserId(investorId: string): Promise<string | null> {\r\n  const supabase = createServiceClient()\r\n\r\n  const { data, error } = await supabase\r\n    .from('investor_users')\r\n    .select('user_id')\r\n    .eq('investor_id', investorId)\r\n    .order('created_at', { ascending: true })\r\n    .limit(1)\r\n\r\n  if (error) {\r\n    console.error('[notifications] Failed to resolve investor user:', error)\r\n    return null\r\n  }\r\n\r\n  return data?.[0]?.user_id ?? null\r\n}\r\n"],"names":[],"mappings":"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"}