module.exports=[493142,e=>{"use strict";var t=e.i(779444),a=e.i(698261),n=e.i(821776),i=e.i(796417),r=e.i(856890),o=e.i(26996),s=e.i(436944),l=e.i(88281),c=e.i(765944),d=e.i(984788),u=e.i(237011),p=e.i(712007),m=e.i(777657),_=e.i(13180),f=e.i(273827),g=e.i(193695);e.i(947956);var h=e.i(36217),v=e.i(414131),y=e.i(433669),w=e.i(38896);async function x(e){try{let t=await (0,w.getCurrentUser)();if(!t)return v.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:a}=new URL(e.url),n=Math.min(Math.max(parseInt(a.get("days")||"30",10),7),90),i=(0,y.createServiceClient)(),{data:r}=await i.from("staff_permissions").select("permission").eq("user_id",t.id).eq("permission","super_admin").single();if(!r)return v.NextResponse.json({error:"Forbidden"},{status:403});let[o,s,l,c,d,u,p,m,_,f,g,h,x,C]=await Promise.all([i.from("subscriptions").select("id, commitment, funded_amount, current_nav, spread_fee_amount, subscription_fee_amount, management_fee_amount, status, subscription_date").in("status",["active","committed","funded"]).limit(5e4),i.from("investors").select("id, status, created_at, kyc_status, type, country",{count:"exact"}).eq("status","active").limit(5e4),i.from("deals").select("id, status, target_amount, raised_amount").limit(5e3),Promise.all([i.from("approvals").select("id",{count:"exact"}).eq("status","pending"),i.from("tasks").select("id",{count:"exact"}).in("status",["pending","overdue"]),i.from("investors").select("id",{count:"exact"}).eq("kyc_status","pending")]),i.from("fee_events").select("id, fee_type, computed_amount, created_at").gte("created_at",new Date(Date.now()-31536e6).toISOString()).limit(1e4),Promise.all([i.from("investor_deal_interest").select("id",{count:"exact",head:!0}),i.from("deal_data_room_access").select("id",{count:"exact",head:!0}).is("revoked_at",null),i.from("deal_subscription_submissions").select("id",{count:"exact",head:!0}).in("status",["pending_review","approved","pending"]),i.from("subscriptions").select("id",{count:"exact",head:!0}).gt("funded_amount",0)]),i.from("investors").select("type, kyc_status, country").eq("status","active").limit(5e4),i.from("investors").select("id, legal_name, kyc_expiry_date, kyc_status").eq("status","active").not("kyc_expiry_date","is",null).gte("kyc_expiry_date",new Date().toISOString().split("T")[0]).lte("kyc_expiry_date",new Date(Date.now()+7776e6).toISOString().split("T")[0]),R(i),k(i),E(i),S(i),D(i),b(i,n)]),T=o.data||[],O=T.reduce((e,t)=>e+(t.current_nav||t.commitment||0),0),A=T.reduce((e,t)=>e+(t.commitment||0),0),I=T.reduce((e,t)=>e+(t.funded_amount||0),0),P=A>0?Math.round(I/A*100):0,N=T.reduce((e,t)=>e+(t.spread_fee_amount||0),0),q=T.reduce((e,t)=>e+(t.subscription_fee_amount||0),0),U=T.reduce((e,t)=>e+(t.management_fee_amount||0),0),M=s.data||[],j=s.count||0,H=M.filter(e=>{let t=new Date(e.created_at),a=new Date;return t.getMonth()===a.getMonth()&&t.getFullYear()===a.getFullYear()}).length,$=l.data||[],K=$.filter(e=>"open"===e.status||"allocation_pending"===e.status).length,F=$.filter(e=>"open"===e.status||"allocation_pending"===e.status).reduce((e,t)=>e+(t.target_amount||0),0),[Y,L,B]=c,G=Y.count||0,z=L.count||0,V=B.count||0,X=d.data||[],W={};X.forEach(e=>{let t=new Date(e.created_at),a=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`;W[a]||(W[a]={month:a,subscription_fees:0,management_fees:0,performance_fees:0,spread_fees:0,total:0});let n=e.computed_amount||0;"subscription"===e.fee_type?W[a].subscription_fees+=n:"management"===e.fee_type?W[a].management_fees+=n:"performance"===e.fee_type?W[a].performance_fees+=n:"spread"===e.fee_type&&(W[a].spread_fees+=n),W[a].total+=n});let Q=Object.values(W).sort((e,t)=>e.month.localeCompare(t.month)),[Z,J,ee,et]=u,ea={interest:Z.count||0,nda_signed:J.count||0,submitted:ee.count||0,funded:et.count||0},en={draft:{count:0,value:0},open:{count:0,value:0},allocation_pending:{count:0,value:0},closed:{count:0,value:0},cancelled:{count:0,value:0}};$.forEach(e=>{let t=e.status;en[t]&&(en[t].count++,en[t].value+=e.target_amount||0)});let ei=p.data||[],er={},eo={},es={};ei.forEach(e=>{let t=e.type||"Unknown";er[t]=(er[t]||0)+1;let a=e.kyc_status||"not_started";eo[a]=(eo[a]||0)+1;let n=e.country||"Unknown";es[n]=(es[n]||0)+1});let el=Object.entries(er).map(([e,t])=>({type:e,count:t})),ec=Object.entries(eo).map(([e,t])=>({status:e,count:t})),ed=Object.entries(es).map(([e,t])=>({country:e,count:t})).sort((e,t)=>t.count-e.count).slice(0,5),eu=(m.data||[]).map(e=>{let t=new Date(e.kyc_expiry_date),a=new Date,n=Math.ceil((t.getTime()-a.getTime())/864e5),i="medium";return n<=7?i="critical":n<=30&&(i="high"),{id:e.id,type:"kyc_expiry",severity:i,investor_id:e.id,investor_name:e.legal_name,details:`KYC expires in ${n} days`,due_date:e.kyc_expiry_date,days_until_due:n,created_at:new Date().toISOString()}}),ep=eu.filter(e=>"critical"===e.severity),em=eu.filter(e=>"high"===e.severity),e_=eu.filter(e=>"medium"===e.severity),ef={critical:ep.length>0?[{id:"kyc-critical",category:"kyc",title:"KYC Expiring (Critical)",description:`${ep.length} investors with KYC expiring within 7 days`,count:ep.length,link:"/versotech/staff/investors?kyc_status=expiring"}]:[],high:[...G>0?[{id:"approvals",category:"approval",title:"Pending Approvals",description:`${G} approvals waiting for review`,count:G,link:"/versotech/staff/approvals"}]:[],...em.length>0?[{id:"kyc-high",category:"kyc",title:"KYC Expiring Soon",description:`${em.length} investors with KYC expiring within 30 days`,count:em.length,link:"/versotech/staff/investors?kyc_status=expiring"}]:[]],medium:[...z>0?[{id:"tasks",category:"task",title:"Pending Tasks",description:`${z} tasks requiring attention`,count:z,link:"/versotech/staff/tasks"}]:[],...e_.length>0?[{id:"kyc-medium",category:"kyc",title:"KYC Expiring (90 days)",description:`${e_.length} investors with KYC expiring within 90 days`,count:e_.length,link:"/versotech/staff/investors?kyc_status=expiring"}]:[]]};return v.NextResponse.json({success:!0,data:{kpis:{aum:{value:O,commitment:A,funded:I,funding_rate:P,change_mtd:null,trend:null},revenue:{total:N+q+U,spread_fees:N,subscription_fees:q,management_fees:U},investors:{active:j,new_mtd:H,trend:H>0?"up":null},deals:{open:K,pipeline_value:F,trend:null},pending:{approvals:G,tasks:z,kyc:V}},charts:{revenueByMonth:Q,subscriptionPipeline:ea,dealsByStatus:en,investorsByType:el,investorsByKyc:ec,investorsByCountry:ed},alerts:ef,adminMetrics:{security:_,staffActivity:f,approvalQueue:g,workflowTrend:h,complianceForecast:x,userActivityTrend:C}}})}catch(e){return console.error("Dashboard metrics error:",e),v.NextResponse.json({error:"Failed to fetch dashboard metrics"},{status:500})}}async function R(e){let t=new Date,a=new Date(t.getTime()-864e5).toISOString(),n=new Date(t.getTime()-6048e5).toISOString(),{data:i}=await e.from("audit_logs").select("created_at").eq("action","failed_login_attempt").gte("created_at",n).limit(1e4),r=i?.filter(e=>new Date(e.created_at)>=new Date(a)).length||0,o=i?.length||0,{count:s}=await e.from("profiles").select("*",{count:"exact",head:!0}).gte("created_at",n),{count:l}=await e.from("approvals").select("*",{count:"exact",head:!0}).eq("status","pending");return{failed_logins_24h:r,failed_logins_7d:o,new_accounts_7d:s||0,pending_approvals:l||0}}async function k(e){let t=new Date(Date.now()-6048e5).toISOString(),{data:a}=await e.from("profiles").select("id, display_name, email").in("role",["staff_admin","staff_ops","staff_rm","ceo"]);if(!a?.length)return[];let n=a.map(e=>e.id),{data:i}=await e.from("audit_logs").select("actor_id, action, created_at").in("actor_id",n).gte("created_at",t).limit(5e4),r={};return n.forEach(e=>{r[e]={count:0,lastAction:null}}),i?.forEach(e=>{let t=r[e.actor_id];t&&(t.count++,(!t.lastAction||e.created_at>t.lastAction)&&(t.lastAction=e.created_at))}),a.map(e=>({staff_id:e.id,name:e.display_name||e.email?.split("@")[0]||"Unknown",action_count:r[e.id]?.count||0,last_action:r[e.id]?.lastAction})).sort((e,t)=>t.action_count-e.action_count)}async function E(e){let t=new Date,a=new Date(t.getTime()-864e5),n=new Date(t.getTime()-2592e5),i=new Date(t.getTime()-6048e5),{data:r}=await e.from("approvals").select("created_at").eq("status","pending").limit(1e4),o=0,s=0,l=0,c=0;return r?.forEach(e=>{let t=new Date(e.created_at);t>=a?o++:t>=n?s++:t>=i?l++:c++}),{under_1_day:o,days_1_to_3:s,days_3_to_7:l,over_7_days:c,total:r?.length||0}}async function S(e){let t=new Date(Date.now()-2592e6).toISOString(),{data:a}=await e.from("workflow_runs").select("status, created_at").gte("created_at",t).order("created_at",{ascending:!0}).limit(5e4),n={};return a?.forEach(e=>{let t=e.created_at.split("T")[0];n[t]||(n[t]={total:0,completed:0,failed:0}),n[t].total++,"completed"===e.status?n[t].completed++:"failed"===e.status&&n[t].failed++}),Object.entries(n).map(([e,t])=>({date:e,total_runs:t.total,completed:t.completed,failed:t.failed,success_rate:t.total>0?Math.round(t.completed/t.total*100):0}))}async function D(e){let t=new Date,a=new Date(t.getTime()+6048e5).toISOString(),n=new Date(t.getTime()+2592e6).toISOString(),i=new Date(t.getTime()+7776e6).toISOString(),{data:r}=await e.from("investors").select("kyc_expiry_date").not("kyc_expiry_date","is",null).gte("kyc_expiry_date",t.toISOString()).lte("kyc_expiry_date",i),o=0,s=0,l=0;return r?.forEach(e=>{let t=new Date(e.kyc_expiry_date);t<=new Date(a)?o++:t<=new Date(n)?s++:l++}),{next_7_days:o,next_30_days:s,next_90_days:l,total:r?.length||0}}async function b(e,t){let a=new Date(Date.now()-24*t*36e5).toISOString(),{data:n}=await e.from("audit_logs").select("actor_id, created_at").gte("created_at",a).not("actor_id","is",null).order("created_at",{ascending:!0}).limit(1e5),i={};for(let e=0;e<t;e++)i[new Date(Date.now()-(t-1-e)*864e5).toISOString().split("T")[0]]=new Set;return n?.forEach(e=>{let t=e.created_at.split("T")[0];i[t]&&e.actor_id&&i[t].add(e.actor_id)}),Object.entries(i).map(([e,t])=>({date:e,activeUsers:t.size,label:new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric"})}))}e.s(["GET",()=>x],231970);var C=e.i(231970);let T=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/admin/metrics/dashboard/route",pathname:"/api/admin/metrics/dashboard",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/admin/metrics/dashboard/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:O,workUnitAsyncStorage:A,serverHooks:I}=T;function P(){return(0,n.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:A})}async function N(e,t,n){T.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/admin/metrics/dashboard/route";v=v.replace(/\/index$/,"")||"/";let y=await T.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:w,params:x,nextConfig:R,parsedUrl:k,isDraftMode:E,prerenderManifest:S,routerServerContext:D,isOnDemandRevalidate:b,revalidateOnlyGenerated:C,resolvedPathname:O,clientReferenceManifest:A,serverActionsManifest:I}=y,P=(0,s.normalizeAppPath)(v),N=!!(S.dynamicRoutes[P]||S.routes[O]),q=async()=>((null==D?void 0:D.render404)?await D.render404(e,t,k,!1):t.end("This page could not be found"),null);if(N&&!E){let e=!!S.routes[O],t=S.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await q();throw new g.NoFallbackError}}let U=null;!N||T.isDev||E||(U="/index"===(U=O)?"/":U);let M=!0===T.isDev||!N,j=N&&!M;I&&A&&(0,o.setManifestsSingleton)({page:v,clientReferenceManifest:A,serverActionsManifest:I});let H=e.method||"GET",$=(0,r.getTracer)(),K=$.getActiveScopeSpan(),F={params:x,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,i)=>T.onRequestError(e,t,n,i,D)},sharedContext:{buildId:w}},Y=new l.NodeNextRequest(e),L=new l.NodeNextResponse(t),B=c.NextRequestAdapter.fromNodeNextRequest(Y,(0,c.signalFromNodeResponse)(t));try{let o=async e=>T.handle(B,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=$.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${v}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var r,l;let c=async({previousCacheEntry:a})=>{try{if(!s&&b&&C&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(i);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let c=F.renderOpts.collectedTags;if(!N)return await (0,p.sendResponse)(Y,L,r,F.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,n=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==a?void 0:a.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:b})},!1,D),t}},d=await T.handleResponse({req:e,nextConfig:R,cacheKey:U,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:C,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:s});if(!N)return null;if((null==d||null==(r=d.value)?void 0:r.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",b?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&N||g.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,_.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(Y,L,new Response(d.value.body,{headers:g,status:d.value.status||200})),null};K?await l(K):await $.withPropagatedContext(e.headers,()=>$.trace(d.BaseServerSpan.handleRequest,{spanName:`${H} ${v}`,kind:r.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:b})},!1,D),N)throw t;return await (0,p.sendResponse)(Y,L,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>P,"routeModule",()=>T,"serverHooks",()=>I,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>A],493142)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_25d8eb09.js.map