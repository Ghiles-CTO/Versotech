{"version":3,"sources":["../../../../versotech-portal/node_modules/next/dist/esm/build/templates/app-route.js","../../../../versotech-portal/src/app/api/subscriptions/%5Bid%5D/regenerate/route.ts"],"sourcesContent":["import { AppRouteRouteModule } from \"next/dist/esm/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/esm/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/esm/server/lib/patch-fetch\";\nimport { addRequestMeta, getRequestMeta } from \"next/dist/esm/server/request-meta\";\nimport { getTracer, SpanKind } from \"next/dist/esm/server/lib/trace/tracer\";\nimport { setManifestsSingleton } from \"next/dist/esm/server/app-render/manifests-singleton\";\nimport { normalizeAppPath } from \"next/dist/esm/shared/lib/router/utils/app-paths\";\nimport { NodeNextRequest, NodeNextResponse } from \"next/dist/esm/server/base-http/node\";\nimport { NextRequestAdapter, signalFromNodeResponse } from \"next/dist/esm/server/web/spec-extension/adapters/next-request\";\nimport { BaseServerSpan } from \"next/dist/esm/server/lib/trace/constants\";\nimport { getRevalidateReason } from \"next/dist/esm/server/instrumentation/utils\";\nimport { sendResponse } from \"next/dist/esm/server/send-response\";\nimport { fromNodeOutgoingHttpHeaders, toNodeOutgoingHttpHeaders } from \"next/dist/esm/server/web/utils\";\nimport { getCacheControlHeader } from \"next/dist/esm/server/lib/cache-control\";\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from \"next/dist/esm/lib/constants\";\nimport { NoFallbackError } from \"next/dist/esm/shared/lib/no-fallback-error.external\";\nimport { CachedRouteKind } from \"next/dist/esm/server/response-cache\";\nimport * as userland from \"INNER_APP_ROUTE\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/subscriptions/[id]/regenerate/route\",\n        pathname: \"/api/subscriptions/[id]/regenerate\",\n        filename: \"route\",\n        bundlePath: \"\"\n    },\n    distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n    relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n    resolvedPagePath: \"[project]/versotech-portal/src/app/api/subscriptions/[id]/regenerate/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\nexport async function handler(req, res, ctx) {\n    if (routeModule.isDev) {\n        addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint());\n    }\n    let srcPage = \"/api/subscriptions/[id]/regenerate/route\";\n    // turbopack doesn't normalize `/index` in the page name\n    // so we need to to process dynamic routes properly\n    // TODO: fix turbopack providing differing value from webpack\n    if (process.env.TURBOPACK) {\n        srcPage = srcPage.replace(/\\/index$/, '') || '/';\n    } else if (srcPage === '/index') {\n        // we always normalize /index specifically\n        srcPage = '/';\n    }\n    const multiZoneDraftMode = process.env.__NEXT_MULTI_ZONE_DRAFT_MODE;\n    const prepareResult = await routeModule.prepare(req, res, {\n        srcPage,\n        multiZoneDraftMode\n    });\n    if (!prepareResult) {\n        res.statusCode = 400;\n        res.end('Bad Request');\n        ctx.waitUntil == null ? void 0 : ctx.waitUntil.call(ctx, Promise.resolve());\n        return null;\n    }\n    const { buildId, params, nextConfig, parsedUrl, isDraftMode, prerenderManifest, routerServerContext, isOnDemandRevalidate, revalidateOnlyGenerated, resolvedPathname, clientReferenceManifest, serverActionsManifest } = prepareResult;\n    const normalizedSrcPage = normalizeAppPath(srcPage);\n    let isIsr = Boolean(prerenderManifest.dynamicRoutes[normalizedSrcPage] || prerenderManifest.routes[resolvedPathname]);\n    const render404 = async ()=>{\n        // TODO: should route-module itself handle rendering the 404\n        if (routerServerContext == null ? void 0 : routerServerContext.render404) {\n            await routerServerContext.render404(req, res, parsedUrl, false);\n        } else {\n            res.end('This page could not be found');\n        }\n        return null;\n    };\n    if (isIsr && !isDraftMode) {\n        const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname]);\n        const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage];\n        if (prerenderInfo) {\n            if (prerenderInfo.fallback === false && !isPrerendered) {\n                if (nextConfig.experimental.adapterPath) {\n                    return await render404();\n                }\n                throw new NoFallbackError();\n            }\n        }\n    }\n    let cacheKey = null;\n    if (isIsr && !routeModule.isDev && !isDraftMode) {\n        cacheKey = resolvedPathname;\n        // ensure /index and / is normalized to one key\n        cacheKey = cacheKey === '/index' ? '/' : cacheKey;\n    }\n    const supportsDynamicResponse = // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true || // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr;\n    // This is a revalidation request if the request is for a static\n    // page and it is not being resumed from a postponed render and\n    // it is not a dynamic RSC request then it is a revalidation\n    // request.\n    const isStaticGeneration = isIsr && !supportsDynamicResponse;\n    // Before rendering (which initializes component tree modules), we have to\n    // set the reference manifests to our global store so Server Action's\n    // encryption util can access to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n        setManifestsSingleton({\n            page: srcPage,\n            clientReferenceManifest,\n            serverActionsManifest\n        });\n    }\n    const method = req.method || 'GET';\n    const tracer = getTracer();\n    const activeSpan = tracer.getActiveScopeSpan();\n    const context = {\n        params,\n        prerenderManifest,\n        renderOpts: {\n            experimental: {\n                authInterrupts: Boolean(nextConfig.experimental.authInterrupts)\n            },\n            cacheComponents: Boolean(nextConfig.cacheComponents),\n            supportsDynamicResponse,\n            incrementalCache: getRequestMeta(req, 'incrementalCache'),\n            cacheLifeProfiles: nextConfig.cacheLife,\n            waitUntil: ctx.waitUntil,\n            onClose: (cb)=>{\n                res.on('close', cb);\n            },\n            onAfterTaskError: undefined,\n            onInstrumentationRequestError: (error, _request, errorContext, silenceLog)=>routeModule.onRequestError(req, error, errorContext, silenceLog, routerServerContext)\n        },\n        sharedContext: {\n            buildId\n        }\n    };\n    const nodeNextReq = new NodeNextRequest(req);\n    const nodeNextRes = new NodeNextResponse(res);\n    const nextReq = NextRequestAdapter.fromNodeNextRequest(nodeNextReq, signalFromNodeResponse(res));\n    try {\n        const invokeRouteModule = async (span)=>{\n            return routeModule.handle(nextReq, context).finally(()=>{\n                if (!span) return;\n                span.setAttributes({\n                    'http.status_code': res.statusCode,\n                    'next.rsc': false\n                });\n                const rootSpanAttributes = tracer.getRootSpanAttributes();\n                // We were unable to get attributes, probably OTEL is not enabled\n                if (!rootSpanAttributes) {\n                    return;\n                }\n                if (rootSpanAttributes.get('next.span_type') !== BaseServerSpan.handleRequest) {\n                    console.warn(`Unexpected root span type '${rootSpanAttributes.get('next.span_type')}'. Please report this Next.js issue https://github.com/vercel/next.js`);\n                    return;\n                }\n                const route = rootSpanAttributes.get('next.route');\n                if (route) {\n                    const name = `${method} ${route}`;\n                    span.setAttributes({\n                        'next.route': route,\n                        'http.route': route,\n                        'next.span_name': name\n                    });\n                    span.updateName(name);\n                } else {\n                    span.updateName(`${method} ${srcPage}`);\n                }\n            });\n        };\n        const isMinimalMode = Boolean(process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode'));\n        const handleResponse = async (currentSpan)=>{\n            var _cacheEntry_value;\n            const responseGenerator = async ({ previousCacheEntry })=>{\n                try {\n                    if (!isMinimalMode && isOnDemandRevalidate && revalidateOnlyGenerated && !previousCacheEntry) {\n                        res.statusCode = 404;\n                        // on-demand revalidate always sets this header\n                        res.setHeader('x-nextjs-cache', 'REVALIDATED');\n                        res.end('This page could not be found');\n                        return null;\n                    }\n                    const response = await invokeRouteModule(currentSpan);\n                    req.fetchMetrics = context.renderOpts.fetchMetrics;\n                    let pendingWaitUntil = context.renderOpts.pendingWaitUntil;\n                    // Attempt using provided waitUntil if available\n                    // if it's not we fallback to sendResponse's handling\n                    if (pendingWaitUntil) {\n                        if (ctx.waitUntil) {\n                            ctx.waitUntil(pendingWaitUntil);\n                            pendingWaitUntil = undefined;\n                        }\n                    }\n                    const cacheTags = context.renderOpts.collectedTags;\n                    // If the request is for a static response, we can cache it so long\n                    // as it's not edge.\n                    if (isIsr) {\n                        const blob = await response.blob();\n                        // Copy the headers from the response.\n                        const headers = toNodeOutgoingHttpHeaders(response.headers);\n                        if (cacheTags) {\n                            headers[NEXT_CACHE_TAGS_HEADER] = cacheTags;\n                        }\n                        if (!headers['content-type'] && blob.type) {\n                            headers['content-type'] = blob.type;\n                        }\n                        const revalidate = typeof context.renderOpts.collectedRevalidate === 'undefined' || context.renderOpts.collectedRevalidate >= INFINITE_CACHE ? false : context.renderOpts.collectedRevalidate;\n                        const expire = typeof context.renderOpts.collectedExpire === 'undefined' || context.renderOpts.collectedExpire >= INFINITE_CACHE ? undefined : context.renderOpts.collectedExpire;\n                        // Create the cache entry for the response.\n                        const cacheEntry = {\n                            value: {\n                                kind: CachedRouteKind.APP_ROUTE,\n                                status: response.status,\n                                body: Buffer.from(await blob.arrayBuffer()),\n                                headers\n                            },\n                            cacheControl: {\n                                revalidate,\n                                expire\n                            }\n                        };\n                        return cacheEntry;\n                    } else {\n                        // send response without caching if not ISR\n                        await sendResponse(nodeNextReq, nodeNextRes, response, context.renderOpts.pendingWaitUntil);\n                        return null;\n                    }\n                } catch (err) {\n                    // if this is a background revalidate we need to report\n                    // the request error here as it won't be bubbled\n                    if (previousCacheEntry == null ? void 0 : previousCacheEntry.isStale) {\n                        const silenceLog = false;\n                        await routeModule.onRequestError(req, err, {\n                            routerKind: 'App Router',\n                            routePath: srcPage,\n                            routeType: 'route',\n                            revalidateReason: getRevalidateReason({\n                                isStaticGeneration,\n                                isOnDemandRevalidate\n                            })\n                        }, silenceLog, routerServerContext);\n                    }\n                    throw err;\n                }\n            };\n            const cacheEntry = await routeModule.handleResponse({\n                req,\n                nextConfig,\n                cacheKey,\n                routeKind: RouteKind.APP_ROUTE,\n                isFallback: false,\n                prerenderManifest,\n                isRoutePPREnabled: false,\n                isOnDemandRevalidate,\n                revalidateOnlyGenerated,\n                responseGenerator,\n                waitUntil: ctx.waitUntil,\n                isMinimalMode\n            });\n            // we don't create a cacheEntry for ISR\n            if (!isIsr) {\n                return null;\n            }\n            if ((cacheEntry == null ? void 0 : (_cacheEntry_value = cacheEntry.value) == null ? void 0 : _cacheEntry_value.kind) !== CachedRouteKind.APP_ROUTE) {\n                var _cacheEntry_value1;\n                throw Object.defineProperty(new Error(`Invariant: app-route received invalid cache entry ${cacheEntry == null ? void 0 : (_cacheEntry_value1 = cacheEntry.value) == null ? void 0 : _cacheEntry_value1.kind}`), \"__NEXT_ERROR_CODE\", {\n                    value: \"E701\",\n                    enumerable: false,\n                    configurable: true\n                });\n            }\n            if (!isMinimalMode) {\n                res.setHeader('x-nextjs-cache', isOnDemandRevalidate ? 'REVALIDATED' : cacheEntry.isMiss ? 'MISS' : cacheEntry.isStale ? 'STALE' : 'HIT');\n            }\n            // Draft mode should never be cached\n            if (isDraftMode) {\n                res.setHeader('Cache-Control', 'private, no-cache, no-store, max-age=0, must-revalidate');\n            }\n            const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers);\n            if (!(isMinimalMode && isIsr)) {\n                headers.delete(NEXT_CACHE_TAGS_HEADER);\n            }\n            // If cache control is already set on the response we don't\n            // override it to allow users to customize it via next.config\n            if (cacheEntry.cacheControl && !res.getHeader('Cache-Control') && !headers.get('Cache-Control')) {\n                headers.set('Cache-Control', getCacheControlHeader(cacheEntry.cacheControl));\n            }\n            await sendResponse(nodeNextReq, nodeNextRes, // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n            new Response(cacheEntry.value.body, {\n                headers,\n                status: cacheEntry.value.status || 200\n            }));\n            return null;\n        };\n        // TODO: activeSpan code path is for when wrapped by\n        // next-server can be removed when this is no longer used\n        if (activeSpan) {\n            await handleResponse(activeSpan);\n        } else {\n            await tracer.withPropagatedContext(req.headers, ()=>tracer.trace(BaseServerSpan.handleRequest, {\n                    spanName: `${method} ${srcPage}`,\n                    kind: SpanKind.SERVER,\n                    attributes: {\n                        'http.method': method,\n                        'http.target': req.url\n                    }\n                }, handleResponse));\n        }\n    } catch (err) {\n        if (!(err instanceof NoFallbackError)) {\n            const silenceLog = false;\n            await routeModule.onRequestError(req, err, {\n                routerKind: 'App Router',\n                routePath: normalizedSrcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                    isStaticGeneration,\n                    isOnDemandRevalidate\n                })\n            }, silenceLog, routerServerContext);\n        }\n        // rethrow so that we can handle serving error page\n        // If this is during static generation, throw the error again.\n        if (isIsr) throw err;\n        // Otherwise, send a 500 response.\n        await sendResponse(nodeNextReq, nodeNextRes, new Response(null, {\n            status: 500\n        }));\n        return null;\n    }\n}\n\n//# sourceMappingURL=app-route.js.map\n","import { createClient, createServiceClient } from '@/lib/supabase/server'\nimport { auditLogger, AuditActions, AuditEntities } from '@/lib/audit'\nimport { NextResponse } from 'next/server'\nimport { triggerWorkflow } from '@/lib/trigger-workflow'\nimport { convertDocxToPdf } from '@/lib/gotenberg/convert'\nimport { getCeoSigner } from '@/lib/staff/ceo-signer'\n\nconst STAFF_ROLES = ['staff_admin', 'staff_ops', 'staff_rm', 'ceo']\n\n/**\n * Generate subscription pack filename with standardized format:\n * {ENTITY_CODE} - SUBSCRIPTION PACK - {INVESTMENT_NAME} - {INVESTOR_NAME} - {DDMMYY}.{extension}\n */\nfunction generateSubscriptionPackFilename(\n  entityCode: string,\n  investmentName: string,\n  investorName: string,\n  date: Date,\n  format: 'docx' | 'pdf' = 'docx'\n): string {\n  const day = date.getUTCDate().toString().padStart(2, '0')\n  const month = (date.getUTCMonth() + 1).toString().padStart(2, '0')\n  const year = date.getUTCFullYear().toString().slice(-2)\n  const formattedDate = `${day}${month}${year}`\n\n  const cleanEntityCode = entityCode.trim()\n  const cleanInvestmentName = investmentName.trim().replace(/\\s+/g, ' ')\n  const cleanInvestorName = investorName.trim().replace(/\\s+/g, ' ')\n\n  return `${cleanEntityCode} - SUBSCRIPTION PACK - ${cleanInvestmentName} - ${cleanInvestorName} - ${formattedDate}.${format}`\n}\n\n/**\n * POST /api/subscriptions/[id]/regenerate\n *\n * Regenerates a subscription pack using the CURRENT values from the subscriptions table.\n * This allows CEO to edit subscription details and regenerate the document with updated values.\n *\n * KEY DIFFERENCE from initial generation:\n * - Initial: Uses submission.payload_json.amount (staging data)\n * - Regenerate: Uses subscription.commitment (source of truth after edits)\n */\nexport async function POST(\n  request: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id: subscriptionId } = await params\n    const supabase = await createClient()\n    const serviceSupabase = createServiceClient()\n\n    // Parse request body for format selection\n    let outputFormat: 'docx' | 'pdf' = 'docx'\n    try {\n      const body = await request.json()\n      if (body.format === 'pdf' || body.format === 'docx') {\n        outputFormat = body.format\n      }\n    } catch {\n      // No body or invalid JSON - use default format\n    }\n    console.log('üìÑ [REGENERATE] Requested output format:', outputFormat)\n\n    // Check authentication\n    const { data: { user: authUser }, error: authError } = await supabase.auth.getUser()\n    if (authError || !authUser) {\n      return NextResponse.json(\n        { error: 'Unauthorized' },\n        { status: 401 }\n      )\n    }\n\n    // Check if user is staff\n    const { data: profile } = await supabase\n      .from('profiles')\n      .select('role, display_name, email')\n      .eq('id', authUser.id)\n      .single()\n\n    if (!profile || !STAFF_ROLES.includes(profile.role)) {\n      return NextResponse.json(\n        { error: 'Staff access required' },\n        { status: 403 }\n      )\n    }\n\n    // Build user object for workflow trigger\n    const user = {\n      id: authUser.id,\n      email: authUser.email || profile.email,\n      displayName: profile.display_name,\n      role: profile.role,\n      title: ''\n    }\n\n    // Fetch subscription with ALL related data needed for the pack\n    const { data: subscription, error: subError } = await serviceSupabase\n      .from('subscriptions')\n      .select(`\n        *,\n        investor:investors!subscriptions_investor_id_fkey (\n          id,\n          legal_name,\n          display_name,\n          type,\n          registered_address,\n          entity_identifier\n        ),\n        vehicle:vehicles!subscriptions_vehicle_id_fkey (\n          id,\n          name,\n          series_number,\n          series_short_title,\n          investment_name,\n          entity_code,\n          issuer_gp_name,\n          issuer_gp_rcc_number,\n          issuer_rcc_number,\n          issuer_website\n        ),\n        deal:deals!subscriptions_deal_id_fkey (\n          id,\n          name,\n          company_name,\n          company_logo_url,\n          currency,\n          vehicle_id\n        )\n      `)\n      .eq('id', subscriptionId)\n      .single()\n\n    if (subError || !subscription) {\n      console.error('Error fetching subscription:', subError)\n      return NextResponse.json(\n        { error: 'Subscription not found' },\n        { status: 404 }\n      )\n    }\n\n    // Regeneration requires deal_id (subscription must have come from approval flow)\n    if (!subscription.deal_id) {\n      return NextResponse.json(\n        { error: 'Cannot regenerate: subscription has no associated deal. Only subscriptions created through the approval workflow can be regenerated.' },\n        { status: 400 }\n      )\n    }\n\n    // Validate investor exists\n    if (!subscription.investor) {\n      return NextResponse.json(\n        { error: 'Cannot regenerate: subscription has no associated investor.' },\n        { status: 400 }\n      )\n    }\n\n    // Get vehicle - prefer subscription.vehicle, fall back to deal.vehicle\n    let vehicleData = subscription.vehicle\n    if (!vehicleData && subscription.deal?.vehicle_id) {\n      // Fetch vehicle from deal\n      const { data: dealVehicle } = await serviceSupabase\n        .from('vehicles')\n        .select('id, name, series_number, series_short_title, investment_name, entity_code, issuer_gp_name, issuer_gp_rcc_number, issuer_rcc_number, issuer_website')\n        .eq('id', subscription.deal.vehicle_id)\n        .single()\n      vehicleData = dealVehicle\n    }\n\n    if (!vehicleData) {\n      return NextResponse.json(\n        { error: 'Cannot regenerate: no vehicle found for this subscription.' },\n        { status: 400 }\n      )\n    }\n\n    // Fetch counterparty entity if linked via original submission\n    let counterpartyEntity = null\n    const { data: originalSubmission } = await serviceSupabase\n      .from('deal_subscription_submissions')\n      .select('id, subscription_type, counterparty_entity_id, submitted_at')\n      .eq('formal_subscription_id', subscriptionId)\n      .single()\n\n    if (originalSubmission?.subscription_type === 'entity' && originalSubmission?.counterparty_entity_id) {\n      const { data: entityData } = await serviceSupabase\n        .from('investor_counterparty')\n        .select('*')\n        .eq('id', originalSubmission.counterparty_entity_id)\n        .single()\n      counterpartyEntity = entityData\n    }\n\n    // Build signatories array for multi-signatory subscription packs\n    // Each signatory includes a 'number' field for template display (1, 2, 3...)\n    let signatories: { name: string; title: string; number: number }[] = []\n    // Check BOTH: submission type OR investor's actual type (entity/institutional)\n    const isEntityInvestor = originalSubmission?.subscription_type === 'entity' ||\n                             subscription.investor?.type === 'entity' ||\n                             subscription.investor?.type === 'institutional'\n    if (isEntityInvestor && subscription.investor_id) {\n      // For entity investors: get authorized signatories from investor_members\n      const { data: members } = await serviceSupabase\n        .from('investor_members')\n        .select('id, full_name, email, role_title')\n        .eq('investor_id', subscription.investor_id)\n        .eq('is_signatory', true)\n        .eq('is_active', true)\n\n      if (members && members.length > 0) {\n        signatories = members.map((m: { full_name: string | null; role_title: string | null }, index: number) => ({\n          name: m.full_name || '',\n          title: m.role_title || 'Authorized Signatory',\n          number: index + 1\n        }))\n        console.log(`üë• [REGENERATE] Found ${signatories.length} authorized signatories for entity`)\n      } else {\n        // Fallback: use entity representative if no signatories marked\n        signatories = [{\n          name: counterpartyEntity?.representative_name || subscription.investor?.legal_name || '',\n          title: counterpartyEntity?.representative_title || 'Authorized Representative',\n          number: 1\n        }]\n        console.warn('[REGENERATE] No signatories marked, using representative fallback')\n      }\n    } else {\n      // For individual investors: single signatory\n      signatories = [{\n        name: subscription.investor?.legal_name || '',\n        title: 'Investor',\n        number: 1\n      }]\n    }\n\n    // Generate pre-rendered HTML for signatories (n8n doesn't support Handlebars {{#each}})\n    // ANCHOR ID CONVENTION: First subscriber is 'party_a', subsequent are 'party_a_2', 'party_a_3', etc.\n    const getAnchorId = (number: number, suffix?: string): string => {\n      const base = number === 1 ? 'party_a' : `party_a_${number}`\n      return suffix ? `${base}_${suffix}` : base\n    }\n\n    // ANCHOR CSS: Invisible anchors placed ON the signature line\n    //\n    // APPROACH:\n    // - Keep anchors in the PDF text layer (for PDF.js extraction)\n    // - Position anchors at the signature line using absolute positioning\n    // - Use tiny white text so anchors remain invisible\n    //\n    // IMPORTANT: Anchors are now used for PAGE + Y placement (anchor-based Y).\n    // Avoid off-page positioning so anchor Y is accurate.\n    const ANCHOR_CSS = 'position:absolute;left:0;top:0;font-size:1px;line-height:1px;color:#ffffff;opacity:0.01;'\n\n    // Page 2 - Subscription Form: Subscriber signatures with anchors (right column)\n    // Parent div needs position:relative for anchor's position:absolute to work\n    const signatoriesFormHtml = signatories.map(s => `\n            <div class=\"signature-block-inline\" style=\"position:relative;margin-bottom: 0.5cm;\">\n                <div class=\"signature-line\" style=\"position:relative;\"><span style=\"${ANCHOR_CSS}\">SIG_ANCHOR:${getAnchorId(s.number, 'form')}</span></div>\n                Name: ${s.name}<br>\n                Title: ${s.title}\n            </div>`).join('')\n\n    // Page 12 - Main Agreement: Subscriber signatures with anchors\n    // Increased spacing: margin-bottom 1.5cm, min-height 4cm, margin-top 3cm on signature line\n    // This provides ~85pt of space for signature image (50pt) + timestamp (12pt) + name (12pt) + buffer (10pt)\n    // Parent div needs position:relative for anchor's position:absolute to work\n    const signatoriesSignatureHtml = signatories.map(s => `\n<div class=\"signature-block\" style=\"position:relative;margin-bottom: 1.5cm; min-height: 4cm;\">\n    <p><strong>The Subscriber</strong>, represented by Authorized Signatory ${s.number}</p>\n    <div class=\"signature-line main-line\" style=\"margin-top: 3cm; position:relative;\"><span style=\"${ANCHOR_CSS}\">SIG_ANCHOR:${getAnchorId(s.number)}</span></div>\n    <p style=\"margin-top: 0.3cm;\">Name: ${s.name}<br>\n    Title: ${s.title}</p>\n</div>`).join('')\n\n    // Legacy: Keep signatoriesTableHtml for backwards compatibility (no anchors)\n    const signatoriesTableHtml = signatories.map(s => `\n            <div style=\"margin-bottom: 0.5cm;\">\n                <div class=\"signature-line\"></div>\n                Name: ${s.name}<br>\n                Title: ${s.title}\n            </div>`).join('')\n\n    // Fetch fee structure for the deal (get most recent published one)\n    const { data: feeStructure } = await serviceSupabase\n      .from('deal_fee_structures')\n      .select('*')\n      .eq('deal_id', subscription.deal_id)\n      .eq('status', 'published')\n      .order('created_at', { ascending: false })\n      .limit(1)\n      .single()\n\n    if (!feeStructure) {\n      return NextResponse.json(\n        { error: 'No published fee structure found for this deal' },\n        { status: 400 }\n      )\n    }\n\n    // ============================================================\n    // FETCH ACTUAL SIGNERS FROM DATABASE (no more hardcoded names!)\n    // ============================================================\n\n    // Get CEO signer for issuer block (party_b)\n    const ceoSigner = await getCeoSigner(serviceSupabase)\n    const issuerName = ceoSigner?.displayName || feeStructure.issuer_signatory_name || ''\n    const issuerTitle = ceoSigner?.title || feeStructure.issuer_signatory_title || 'Authorized Signatory'\n    console.log('[REGENERATE] Issuer signer:', { name: issuerName, title: issuerTitle })\n\n    // Get arranger signer for arranger block (party_c)\n    let arrangerName = feeStructure.arranger_person_name || ''\n    let arrangerTitle = feeStructure.arranger_person_title || 'Director'\n\n    // Fetch arranger from deal's arranger entity\n    const { data: dealForArranger } = await serviceSupabase\n      .from('deals')\n      .select('arranger_entity_id')\n      .eq('id', subscription.deal_id)\n      .single()\n\n    if (dealForArranger?.arranger_entity_id) {\n      // Get arranger user who can sign\n      const { data: arrangerUser } = await serviceSupabase\n        .from('arranger_users')\n        .select('user_id, title')\n        .eq('arranger_id', dealForArranger.arranger_entity_id)\n        .eq('can_sign', true)\n        .order('is_primary', { ascending: false })\n        .limit(1)\n        .maybeSingle()\n\n      if (arrangerUser?.user_id) {\n        const { data: arrangerProfile } = await serviceSupabase\n          .from('profiles')\n          .select('display_name')\n          .eq('id', arrangerUser.user_id)\n          .single()\n\n        if (arrangerProfile?.display_name) {\n          arrangerName = arrangerProfile.display_name\n          arrangerTitle = arrangerUser.title || arrangerTitle\n          console.log('[REGENERATE] Arranger signer found:', { name: arrangerName, title: arrangerTitle })\n        }\n      }\n    }\n\n    // Hardcoded fallback if no arranger name found from any source\n    // This ensures the arranger block is never empty\n    if (!arrangerName) {\n      arrangerName = 'Julien Machot'\n      console.warn('[REGENERATE] Using hardcoded arranger fallback: Julien Machot')\n    }\n    console.log('[REGENERATE] Arranger signer:', { name: arrangerName, title: arrangerTitle })\n\n    // DEBUG: Log the ANCHOR_CSS to verify it's correct\n    console.log('[REGENERATE] ANCHOR_CSS:', ANCHOR_CSS)\n\n    // Pre-rendered HTML for issuer (party_b) and arranger (party_c) signature blocks\n    // These include SIG_ANCHOR markers for signature positioning\n    // Page 12 - Main Agreement: Issuer signature with anchor\n    // Increased spacing: min-height 4cm, margin-top 3cm for ~85pt signature space\n    // Parent div needs position:relative for anchor's position:absolute to work\n    const issuerSignatureHtml = `\n<div class=\"signature-block\" style=\"position:relative;margin-bottom: 1.5cm; min-height: 4cm;\">\n    <p><strong>The Issuer, VERSO Capital 2 SCSP</strong>, duly represented by its general partner <strong>VERSO Capital 2 GP SARL</strong></p>\n    <div class=\"signature-line main-line\" style=\"margin-top: 3cm; position:relative;\"><span style=\"${ANCHOR_CSS}\">SIG_ANCHOR:party_b</span></div>\n    <p style=\"margin-top: 0.3cm;\">Name: ${issuerName}<br>\n    Title: ${issuerTitle}</p>\n</div>`\n\n    // Page 12 - Main Agreement: Arranger signature with anchor\n    // Increased spacing: min-height 4cm, margin-top 3cm for ~85pt signature space\n    // Parent div needs position:relative for anchor's position:absolute to work\n    const arrangerSignatureHtml = `\n<div class=\"signature-block\" style=\"position:relative;margin-bottom: 1.5cm; min-height: 4cm;\">\n    <p><strong>The Attorney, Verso Management Ltd.</strong>, for the purpose of the powers granted under Clause 6</p>\n    <div class=\"signature-line main-line\" style=\"margin-top: 3cm; position:relative;\"><span style=\"${ANCHOR_CSS}\">SIG_ANCHOR:party_c</span></div>\n    <p style=\"margin-top: 0.3cm;\">Name: ${arrangerName}<br>\n    Title: ${arrangerTitle}</p>\n</div>`\n\n    // DEBUG: Log the generated HTML to verify anchors are present\n    console.log('[REGENERATE] ========== SIGNATURE HTML DEBUG ==========')\n    console.log('[REGENERATE] ANCHOR_CSS used:', ANCHOR_CSS)\n    console.log('[REGENERATE] issuerSignatureHtml contains party_b:', issuerSignatureHtml.includes('SIG_ANCHOR:party_b'))\n    console.log('[REGENERATE] arrangerSignatureHtml contains party_c:', arrangerSignatureHtml.includes('SIG_ANCHOR:party_c'))\n    console.log('[REGENERATE] arrangerSignatureHtml FULL:', arrangerSignatureHtml)\n    console.log('[REGENERATE] ==========================================')\n\n    // === KEY DIFFERENCE: Use subscription.commitment (source of truth) ===\n    const amount = Number(subscription.commitment) || 0\n    if (amount <= 0) {\n      return NextResponse.json(\n        { error: 'Subscription commitment amount must be greater than 0' },\n        { status: 400 }\n      )\n    }\n\n    // Calculate subscription details using SUBSCRIPTION table values\n    // Use subscription.price_per_share if set, otherwise fall back to fee structure\n    const subscriptionPricePerShare = Number(subscription.price_per_share)\n    const feeStructurePricePerShare = parseFloat(feeStructure.price_per_share_text?.replace(/[^\\d.]/g, '') || '0')\n    const pricePerShare = subscriptionPricePerShare > 0\n      ? subscriptionPricePerShare\n      : (feeStructurePricePerShare > 0 ? feeStructurePricePerShare : 1.00)\n\n    // Use subscription.num_shares if set, otherwise calculate\n    const numShares = Number(subscription.num_shares) > 0\n      ? Number(subscription.num_shares)\n      : Math.floor(amount / pricePerShare)\n\n    // Fee percentages are stored as whole numbers (2.0 = 2%, 25.0 = 25%)\n    const subscriptionFeeRate = Number(subscription.subscription_fee_percent) || feeStructure.subscription_fee_percent || 0\n    // Divide by 100 to convert percentage to decimal for calculation\n    const subscriptionFeeAmount = Number(subscription.subscription_fee_amount) || (amount * (subscriptionFeeRate / 100))\n    const totalSubscriptionPrice = amount + subscriptionFeeAmount\n\n    // Format dates\n    const agreementDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })\n    const paymentDeadlineDays = feeStructure.payment_deadline_days || 10\n    const paymentDeadlineDate = new Date(Date.now() + paymentDeadlineDays * 24 * 60 * 60 * 1000)\n      .toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })\n\n    // Determine subscriber info (use entity if entity subscription, otherwise investor)\n    const investorData = subscription.investor\n    // vehicleData already set above with fallback logic\n    const dealData = subscription.deal\n\n    const subscriberName = counterpartyEntity\n      ? counterpartyEntity.legal_name\n      : investorData.legal_name\n\n    const subscriberType = counterpartyEntity\n      ? counterpartyEntity.entity_type?.replace(/_/g, ' ').toUpperCase()\n      : (investorData.type || 'Corporate Entity')\n\n    const subscriberAddress = counterpartyEntity && counterpartyEntity.registered_address\n      ? [\n          counterpartyEntity.registered_address.street,\n          [\n            counterpartyEntity.registered_address.city,\n            counterpartyEntity.registered_address.state,\n            counterpartyEntity.registered_address.postal_code\n          ].filter(Boolean).join(', '),\n          counterpartyEntity.registered_address.country\n        ].filter(Boolean).join(', ')\n      : (investorData.registered_address || '')\n\n    const subscriberBlock = counterpartyEntity\n      ? `${counterpartyEntity.legal_name}, a ${counterpartyEntity.entity_type?.replace(/_/g, ' ')} with registered office at ${subscriberAddress}`\n      : `${investorData.legal_name}, ${investorData.type || 'entity'} with registered office at ${investorData.registered_address || ''}`\n\n    const subscriberTitle = counterpartyEntity?.representative_title || 'Authorized Representative'\n    const subscriberRepName = counterpartyEntity?.representative_name || counterpartyEntity?.legal_name || investorData.legal_name\n\n    // Build comprehensive subscription pack payload (same structure as initial generation)\n    const subscriptionPayload = {\n      // Output format: 'pdf' for direct PDF, 'docx' for editable Word doc\n      output_format: outputFormat,\n\n      // Series & Investment info\n      series_number: vehicleData?.series_number || '',\n      series_title: vehicleData?.investment_name || vehicleData?.name || '',\n      series_short_title: vehicleData?.series_short_title || '',\n      ultimate_investment: dealData?.company_name || dealData?.name || '',\n\n      // Subscriber info\n      subscriber_name: subscriberName,\n      subscriber_type: subscriberType,\n      subscriber_address: subscriberAddress,\n      subscriber_block: subscriberBlock,\n      subscriber_title: subscriberTitle,\n      subscriber_representative_name: subscriberRepName,\n\n      // Investment branding\n      investment_logo_url: dealData?.company_logo_url || '',\n\n      // Financial details - FROM SUBSCRIPTION TABLE (source of truth)\n      certificates_count: numShares.toString(),\n      price_per_share: pricePerShare.toFixed(2),\n      subscription_amount: amount.toFixed(2),\n      // Fee rates are already stored as percentages (2.0 = 2%), no multiplication needed\n      subscription_fee_rate: `${subscriptionFeeRate.toFixed(2)}%`,\n      subscription_fee_amount: subscriptionFeeAmount.toFixed(2),\n      subscription_fee_text: `${subscriptionFeeRate.toFixed(2)}% upfront subscription fee`,\n      total_subscription_price: totalSubscriptionPrice.toFixed(2),\n\n      // Currency\n      currency_code: subscription.currency || dealData?.currency || 'USD',\n      currency_long: (subscription.currency || dealData?.currency) === 'USD' ? 'United States Dollars' : (subscription.currency || dealData?.currency),\n\n      // Fee structures - values are already percentages (2.0 = 2%, 25.0 = 25%)\n      management_fee_text: `${(feeStructure.management_fee_percent || 0).toFixed(2)}% of net asset value per annum, calculated and payable quarterly`,\n      performance_fee_text: `${(feeStructure.carried_interest_percent || 0).toFixed(2)}% performance fee on realized gains`,\n      escrow_fee_text: feeStructure.escrow_fee_text || 'As per escrow agreement',\n\n      // Legal clauses - values are already percentages\n      management_fee_clause: feeStructure.management_fee_clause || `The Issuer shall charge a Management Fee of ${(feeStructure.management_fee_percent || 0).toFixed(2)}% per annum of the net asset value of the Series, calculated on a quarterly basis and payable quarterly in advance.`,\n      performance_fee_clause: feeStructure.performance_fee_clause || `The Issuer shall be entitled to a Performance Fee equal to ${(feeStructure.carried_interest_percent || 0).toFixed(2)}% of the net profits generated by the Series.`,\n\n      // Wire/Escrow instructions\n      wire_bank_name: feeStructure.wire_bank_name || 'Banque de Luxembourg',\n      wire_bank_address: feeStructure.wire_bank_address || '14, boulevard Royal, L-2449 Luxembourg, Grand Duchy of Luxembourg',\n      wire_account_holder: feeStructure.wire_account_holder || 'Elvinger Hoss Prussen - Escrow Account',\n      wire_escrow_agent: feeStructure.wire_escrow_agent || 'Elvinger Hoss Prussen',\n      wire_law_firm_address: feeStructure.wire_law_firm_address || '2 Place Winston Churchill, L-1340 Luxembourg, Grand Duchy of Luxembourg',\n      wire_iban: feeStructure.wire_iban || 'LU28 0019 4855 4447 1000',\n      wire_bic: feeStructure.wire_bic || 'BLUXLULL',\n      wire_reference: feeStructure.wire_reference_format?.replace('{series}', vehicleData?.series_number || '') || `${vehicleData?.series_number}-${vehicleData?.series_short_title}`,\n      wire_description: feeStructure.wire_description_format || `Escrow account for ${vehicleData?.name}`,\n      wire_arranger: feeStructure.exclusive_arranger || 'VERSO Management Ltd',\n      wire_contact_email: feeStructure.wire_contact_email || 'subscription@verso.capital',\n\n      // Issuer info (using dynamically fetched issuerName/issuerTitle)\n      issuer_gp_name: vehicleData?.issuer_gp_name || 'VERSO Capital 2 GP SARL',\n      issuer_gp_rcc_number: vehicleData?.issuer_gp_rcc_number || '',\n      issuer_rcc_number: vehicleData?.issuer_rcc_number || '',\n      issuer_website: vehicleData?.issuer_website || 'www.verso.capital',\n      issuer_name: issuerName,  // From getCeoSigner or feeStructure\n      issuer_title: issuerTitle, // From getCeoSigner or feeStructure\n\n      // Dates & deadlines\n      agreement_date: agreementDate,\n      payment_deadline_days: paymentDeadlineDays.toString(),\n      payment_deadline_date: paymentDeadlineDate,\n      issue_within_business_days: (feeStructure.issue_within_business_days || 5).toString(),\n\n      // Recitals\n      recital_b_html: feeStructure.recital_b_html || `(B) The Issuer intends to issue Certificates which shall track equity interests in ${dealData?.company_name || dealData?.name}, and the Subscriber intends to subscribe for ${numShares} Certificates.`,\n\n      // Arranger (using dynamically fetched arrangerName/arrangerTitle)\n      arranger_name: arrangerName,  // From arranger_users or feeStructure\n      arranger_title: arrangerTitle, // From arranger_users or feeStructure\n      arranger_company_name: feeStructure.exclusive_arranger || 'VERSO Management',\n\n      // LPA & Certificates details\n      // Note: lpa_date and max_aggregate_amount columns don't exist in vehicles table yet\n      lpa_date: '',\n      max_aggregate_amount: '100,000,000',\n\n      // Accession Undertaking (Appendix) fields\n      selling_subscriber_name: subscriberName,\n      accession_holder_name: subscriberName,\n      accession_signatory_name: signatories[0]?.name || '',\n      accession_signatory_title: signatories[0]?.title || '',\n\n      // Multi-signatory support: pre-rendered HTML (n8n doesn't support Handlebars loops)\n      // All signature blocks include SIG_ANCHOR markers for precise signature positioning\n      signatories_table_html: signatoriesTableHtml,  // Legacy: no anchors\n      signatories_form_html: signatoriesFormHtml,    // Page 2: subscriber form signatures with anchors\n      signatories_signature_html: signatoriesSignatureHtml, // Page 12: subscriber main agreement signatures\n      issuer_signature_html: issuerSignatureHtml,    // Page 12: issuer main agreement signature\n      arranger_signature_html: arrangerSignatureHtml, // Page 12: arranger main agreement signature\n\n      // Regeneration flag (useful for N8N to know this is a regeneration)\n      is_regeneration: true,\n      original_subscription_id: subscriptionId\n    }\n\n    console.log('üîÑ Triggering Subscription Pack REGENERATION:', {\n      subscription_id: subscriptionId,\n      investor: investorData.legal_name,\n      amount: amount,\n      num_shares: numShares,\n      price_per_share: pricePerShare\n    })\n\n    // Trigger N8N workflow\n    const result = await triggerWorkflow({\n      workflowKey: 'generate-subscription-pack',\n      payload: subscriptionPayload,\n      entityType: 'subscription_regeneration',\n      entityId: subscriptionId,\n      user: {\n        id: user.id,\n        email: user.email,\n        displayName: user.displayName,\n        role: user.role,\n        title: user.title\n      }\n    })\n\n    if (!result.success) {\n      console.error('‚ùå Failed to trigger Subscription Pack regeneration:', result.error)\n      return NextResponse.json(\n        { error: result.error || 'Failed to trigger document generation' },\n        { status: 500 }\n      )\n    }\n\n    console.log('‚úÖ Subscription Pack regeneration triggered:', {\n      workflow_run_id: result.workflow_run_id\n    })\n\n    // Handle n8n response with binary file\n    if (result.n8n_response) {\n      try {\n        const n8nResponse = result.n8n_response\n        console.log('üì¶ n8n regeneration response structure:', Object.keys(n8nResponse))\n\n        // Extract data for filename generation\n        const entityCode = vehicleData?.entity_code || 'UNKNOWN'\n        const investmentName = vehicleData?.investment_name || 'INVESTMENT'\n        const investorName = investorData?.display_name || investorData?.legal_name || 'INVESTOR'\n\n        // Check if response contains binary file data (N8N always returns DOCX)\n        let docxBuffer: Buffer\n\n        if (n8nResponse.raw && typeof n8nResponse.raw === 'string') {\n          docxBuffer = Buffer.from(n8nResponse.raw, 'latin1')\n        } else if (n8nResponse.binary) {\n          docxBuffer = Buffer.from(n8nResponse.binary)\n        } else if (n8nResponse.data) {\n          docxBuffer = Buffer.from(n8nResponse.data, 'base64')\n        } else if (typeof n8nResponse === 'string') {\n          docxBuffer = Buffer.from(n8nResponse, 'latin1')\n        } else {\n          throw new Error('No binary data in n8n response')\n        }\n\n        // Check file signature to determine actual format\n        // PDF signature: 25504446 (%PDF)\n        // DOCX/ZIP signature: 504b0304 (PK)\n        const signature = docxBuffer.slice(0, 4).toString('hex')\n        const isPDF = signature === '25504446'\n        const isDOCX = signature === '504b0304'\n        console.log('üìÑ N8N response file signature:', signature, isPDF ? '(PDF)' : isDOCX ? '(DOCX)' : '(unknown)', 'size:', docxBuffer.length)\n\n        // Prepare final output based on requested format\n        let fileBuffer: Buffer\n        let fileName: string\n        let mimeType: string\n\n        if (outputFormat === 'pdf') {\n          if (isPDF) {\n            // N8N already returned PDF - use directly without Gotenberg conversion\n            console.log('‚úÖ N8N returned PDF directly, skipping Gotenberg conversion')\n            fileBuffer = docxBuffer\n            fileName = generateSubscriptionPackFilename(entityCode, investmentName, investorName, new Date(), 'pdf')\n            mimeType = 'application/pdf'\n          } else {\n            // Convert DOCX to PDF using Gotenberg\n            console.log('üîÑ Converting DOCX to PDF via Gotenberg...')\n            const docxFileName = generateSubscriptionPackFilename(entityCode, investmentName, investorName, new Date(), 'docx')\n            const conversionResult = await convertDocxToPdf(docxBuffer, docxFileName)\n\n            if (!conversionResult.success || !conversionResult.pdfBuffer) {\n              console.error('‚ùå Gotenberg conversion failed:', conversionResult.error)\n              return NextResponse.json({\n                error: 'Document generated but PDF conversion failed',\n                details: conversionResult.error || 'Conversion service unavailable'\n              }, { status: 500 })\n            }\n\n            console.log('‚úÖ DOCX converted to PDF:', {\n              docx_size: docxBuffer.length,\n              pdf_size: conversionResult.pdfBuffer.length\n            })\n\n            fileBuffer = conversionResult.pdfBuffer\n            fileName = generateSubscriptionPackFilename(entityCode, investmentName, investorName, new Date(), 'pdf')\n            mimeType = 'application/pdf'\n          }\n        } else {\n          // Keep as DOCX\n          fileBuffer = docxBuffer\n          fileName = generateSubscriptionPackFilename(entityCode, investmentName, investorName, new Date(), 'docx')\n          mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'\n        }\n\n        console.log('üìÑ Final document:', { format: outputFormat, fileName, size: fileBuffer.length })\n\n        // Upload to Supabase Storage with regenerated- prefix\n        // Use service client to bypass RLS policies on storage bucket\n        const fileKey = `subscriptions/${subscriptionId}/regenerated/${Date.now()}-${fileName}`\n        const { error: uploadError } = await serviceSupabase.storage\n          .from('deal-documents')\n          .upload(fileKey, fileBuffer, {\n            contentType: mimeType,\n            upsert: false\n          })\n\n        if (uploadError) {\n          console.error('‚ùå Failed to upload regenerated subscription pack:', uploadError)\n          return NextResponse.json(\n            { error: 'Document generated but failed to upload' },\n            { status: 500 }\n          )\n        }\n\n        console.log('‚úÖ Regenerated subscription pack uploaded:', fileKey)\n\n        // Look up the Subscription Documents folder\n        let subscriptionFolderId: string | null = null\n        const vehicleIdForFolder = subscription.vehicle_id || vehicleData?.id\n        if (vehicleIdForFolder) {\n          // Use limit(1).maybeSingle() to handle duplicates gracefully\n          const { data: subFolder } = await serviceSupabase\n            .from('document_folders')\n            .select('id')\n            .eq('vehicle_id', vehicleIdForFolder)\n            .eq('name', 'Subscription Documents')\n            .limit(1)\n            .maybeSingle()\n          subscriptionFolderId = subFolder?.id || null\n          console.log('[REGENERATE] Folder lookup:', { vehicleIdForFolder, subscriptionFolderId })\n        }\n\n        // Create document record (use service client to bypass RLS)\n        const { data: docRecord, error: docError } = await serviceSupabase\n          .from('documents')\n          .insert({\n            subscription_id: subscriptionId,\n            subscription_submission_id: originalSubmission?.id || null,\n            deal_id: subscription.deal_id,\n            vehicle_id: vehicleIdForFolder,\n            folder_id: subscriptionFolderId,\n            type: 'subscription_draft',\n            name: `Subscription Pack (Regenerated) - ${investmentName} - ${investorName}`,\n            file_key: fileKey,\n            mime_type: mimeType,\n            file_size_bytes: fileBuffer.length,\n            status: 'draft',\n            current_version: 1,\n            created_by: user.id\n          })\n          .select()\n          .single()\n\n        if (docError) {\n          console.error('‚ùå Failed to create document record:', docError)\n        } else {\n          console.log('‚úÖ Regenerated document record created:', docRecord.id)\n        }\n\n        // Update subscription pack_generated_at (use service client to bypass RLS)\n        await serviceSupabase\n          .from('subscriptions')\n          .update({ pack_generated_at: new Date().toISOString() })\n          .eq('id', subscriptionId)\n\n        // Audit log\n        await auditLogger.log({\n          actor_user_id: user.id,\n          action: AuditActions.UPDATE,\n          entity: AuditEntities.SUBSCRIPTIONS,\n          entity_id: subscriptionId,\n          metadata: {\n            type: 'subscription_pack_regenerated',\n            amount: amount,\n            num_shares: numShares,\n            price_per_share: pricePerShare,\n            document_id: docRecord?.id,\n            output_format: outputFormat\n          }\n        })\n\n        return NextResponse.json({\n          success: true,\n          message: `Subscription pack regenerated successfully as ${outputFormat.toUpperCase()}`,\n          document_id: docRecord?.id,\n          file_key: fileKey,\n          format: outputFormat,\n          workflow_run_id: result.workflow_run_id\n        })\n      } catch (docError) {\n        console.error('‚ùå Error processing regenerated document:', docError)\n        return NextResponse.json(\n          { error: 'Document generated but failed to process' },\n          { status: 500 }\n        )\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: 'Regeneration workflow triggered',\n      workflow_run_id: result.workflow_run_id\n    })\n\n  } catch (error) {\n    console.error('Regeneration error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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","ignoreList":[0]}