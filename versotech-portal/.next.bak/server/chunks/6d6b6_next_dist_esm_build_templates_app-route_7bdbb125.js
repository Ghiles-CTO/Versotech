module.exports=[380362,e=>{"use strict";var t=e.i(779444),a=e.i(698261),n=e.i(821776),o=e.i(796417),s=e.i(856890),i=e.i(26996),r=e.i(436944),l=e.i(88281),c=e.i(765944),d=e.i(984788),u=e.i(237011),p=e.i(712007),h=e.i(777657),v=e.i(13180),m=e.i(273827),_=e.i(193695);e.i(947956);var g=e.i(36217),f=e.i(433669),b=e.i(911357),w=e.i(414131);async function y(e){let{searchParams:t}=new URL(e.url),a=t.get("type")||"nav_breakdown";try{let e=await (0,f.createClient)(),{data:{user:t},error:n}=await e.auth.getUser();if(n||!t)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{data:o}=await e.from("investor_users").select("investor_id").eq("user_id",t.id);if(!o||0===o.length)return w.NextResponse.json({items:[],total:0,kpiType:a,asOfDate:new Date().toISOString()});let s=o.map(e=>e.investor_id),i=[],r=0;console.log(`Processing KPI details for type: ${a}, investor IDs: ${s.length}`);let{data:l}=await e.from("positions").select("id, vehicle_id, units, cost_basis").in("investor_id",s).gt("units",0);switch(console.log(`Total holdings for investor: ${l?.length||0} positions`),a){case"nav_breakdown":let c,{data:d,error:u}=await e.rpc("get_investor_vehicle_breakdown",{investor_ids:s});if(c=d,console.log(`Vehicle breakdown query result: ${c?.length||0} vehicles, error:`,u),u){console.warn("Enhanced vehicle breakdown failed, using fallback:",u),console.log("Using manual fallback query for vehicle breakdown...");let{data:t,error:n}=await e.from("positions").select(`
              id,
              units,
              cost_basis,
              last_nav,
              as_of_date,
              vehicle_id,
              vehicles!inner (
                id,
                name,
                type,
                currency,
                domicile
              )
            `).in("investor_id",s).gt("units",0);if(console.log(`Fallback query result: ${t?.length||0} positions, error:`,n),n)return console.error("Fallback query also failed:",n),w.NextResponse.json({items:[],total:0,kpiType:a,asOfDate:new Date().toISOString(),error:"Failed to fetch vehicle data"});if(t){console.log(`Fallback positions data: ${t.length} positions found`);let a=t.map(e=>e.vehicle_id).filter(Boolean);console.log(`Looking up valuations for ${a.length} vehicles:`,a);let[n,o]=await Promise.allSettled([e.from("valuations").select("vehicle_id, nav_per_unit, as_of_date").in("vehicle_id",a).order("as_of_date",{ascending:!1}),e.from("subscriptions").select("vehicle_id, commitment, status, created_at").in("vehicle_id",a).in("investor_id",s)]),i="fulfilled"===n.status?n.value.data:[],r="fulfilled"===o.status?o.value.data:[];console.log(`Valuations query result: ${i?.length||0} valuations`),console.log(`Subscriptions query result: ${r?.length||0} subscriptions`);let l=i?.reduce((e,t)=>(e[t.vehicle_id]||(e[t.vehicle_id]=t),e),{})||{},d=r?.reduce((e,t)=>(e[t.vehicle_id]=t,e),{})||{};c=t.map(e=>{let t=e.vehicles,a=d[e.vehicle_id],n=l[e.vehicle_id],o=n?.nav_per_unit||e.last_nav||100,s=e.units*o;return console.log(`Processing vehicle ${t.name}: ${e.units} units @ $${o} = $${s}`),{vehicle_id:e.vehicle_id,vehicle_name:t.name,vehicle_type:t.type,current_value:s,cost_basis:e.cost_basis||0,units:e.units,unrealized_gain:s-(e.cost_basis||0),unrealized_gain_pct:e.cost_basis>0?(s-e.cost_basis)/e.cost_basis*100:0,commitment:a?.commitment||0,nav_per_unit:o,last_valuation_date:n?.as_of_date||e.as_of_date}}),console.log(`✅ Processed ${c.length} vehicle breakdowns successfully`)}else console.error("❌ Fallback query returned no data - this is a serious data issue"),c=[]}c&&c.length>0&&(r=(i=c.map(e=>({id:e.vehicle_id,name:e.vehicle_name,type:e.vehicle_type||"fund",value:parseFloat(e.current_value)||0,percentage:0,metadata:{units:parseFloat(e.units)||0,nav_per_unit:parseFloat(e.nav_per_unit)||0,cost_basis:parseFloat(e.cost_basis)||0,last_valuation_date:e.last_valuation_date,commitment:parseFloat(e.commitment)||0,currency:"USD"}}))).reduce((e,t)=>e+t.value,0),i=i.map(e=>({...e,percentage:r>0?e.value/r*100:0})));break;case"contributions_breakdown":let{data:p,error:h}=await e.from("cashflows").select(`
            vehicle_id,
            amount,
            date,
            vehicles (
              id,
              name,
              type
            )
          `).in("investor_id",s).eq("type","call").order("date",{ascending:!1});if(console.log(`Contributions query result: ${p?.length||0} cashflows, error:`,h),console.log("Contributions data sample:",p?.slice(0,2)),h||!p||0===p.length){console.warn("No cashflows data found, using position cost basis as fallback"),console.log("Attempting fallback query for contributions...");let{data:t,error:a}=await e.from("positions").select(`
              id,
              cost_basis,
              as_of_date,
              vehicles (
                id,
                name,
                type
              ),
              subscriptions!inner (
                id,
                commitment,
                status
              )
            `).in("investor_id",s).gt("cost_basis",0);if(console.log(`Positions fallback query result: ${t?.length||0} positions, error:`,a),t&&t.length>0)console.log("Using positions cost basis as contributions proxy for",t.length,"holdings"),i=t.map(e=>({id:e.vehicles.id,name:e.vehicles.name,type:e.vehicles.type||"fund",value:parseFloat(e.cost_basis)||0,percentage:0,metadata:{contribution_count:1,last_contribution_date:e.as_of_date,currency:"USD",cost_basis:parseFloat(e.cost_basis)||0,commitment:e.subscriptions?.commitment||0,status:e.subscriptions?.status||"active",note:"Estimated from cost basis (no cashflow records found)"}}));else{console.error("No positions data found either - this indicates a data issue"),console.log("Trying direct vehicle subscription query as final fallback...");let{data:t}=await e.from("subscriptions").select(`
                id,
                commitment,
                created_at,
                status,
                vehicles (
                  id,
                  name,
                  type
                )
              `).in("investor_id",s).eq("status","active");t&&t.length>0&&(console.log(`Final fallback: using ${t.length} subscription commitments`),i=t.map(e=>({id:e.vehicles.id,name:e.vehicles.name,type:e.vehicles.type||"fund",value:parseFloat(e.commitment)||0,percentage:0,metadata:{contribution_count:1,last_contribution_date:e.created_at,currency:"USD",commitment:parseFloat(e.commitment)||0,status:e.status,note:"Estimated from subscription commitment (no position or cashflow data found)"}})))}}else{console.log(`Processing ${p.length} actual cashflow contributions`);let e=p.reduce((e,t)=>{let a=t.vehicle_id;return e[a]||(e[a]={id:a,name:t.vehicles?.name||"Unknown Vehicle",type:t.vehicles?.type||"fund",value:0,count:0,last_date:t.date}),e[a].value+=parseFloat(t.amount)||0,e[a].count+=1,t.date>e[a].last_date&&(e[a].last_date=t.date),e},{});i=Object.values(e).map(e=>({id:e.id,name:e.name,type:e.type,value:e.value,percentage:0,metadata:{contribution_count:e.count,last_contribution_date:e.last_date,currency:"USD",source:"actual_cashflows"}})),console.log(`Processed contributions for ${i.length} vehicles from ${p.length} cashflows`)}i.length>0&&(r=i.reduce((e,t)=>e+t.value,0),i=i.map(e=>({...e,percentage:r>0?e.value/r*100:0})));break;case"distributions_breakdown":let{data:v,error:m}=await e.from("cashflows").select(`
            vehicle_id,
            amount,
            date,
            vehicles (
              id,
              name,
              type
            )
          `).in("investor_id",s).eq("type","distribution").order("date",{ascending:!1});if(m||!v||0===v.length)console.warn("No distribution cashflows found"),i=[],r=0;else{let e=v.reduce((e,t)=>{let a=t.vehicle_id;return e[a]||(e[a]={id:a,name:t.vehicles?.name||"Unknown Vehicle",type:t.vehicles?.type||"fund",value:0,count:0,last_date:t.date}),e[a].value+=parseFloat(t.amount)||0,e[a].count+=1,t.date>e[a].last_date&&(e[a].last_date=t.date),e},{});r=(i=Object.values(e).map(e=>({id:e.id,name:e.name,type:e.type,value:e.value,percentage:0,metadata:{distribution_count:e.count,last_distribution_date:e.last_date,currency:"USD"}}))).reduce((e,t)=>e+t.value,0),i=i.map(e=>({...e,percentage:r>0?e.value/r*100:0}))}break;case"deal_breakdown":let{data:_,error:g}=await e.from("allocations").select(`
            id,
            units,
            unit_price,
            status,
            deals (
              id,
              name,
              deal_type
            )
          `).in("investor_id",s).in("status",["approved","settled"]);g?(console.warn("Deals/allocations table not found or accessible:",g),i=[],r=0):_&&_.length>0?(r=(i=_.map(e=>({id:e.id,name:e.deals?.name||`Deal ${e.id.slice(-8)}`,type:e.deals?.deal_type||"deal",value:(parseFloat(e.units)||0)*(parseFloat(e.unit_price)||0),percentage:0,metadata:{units:parseFloat(e.units)||0,unit_price:parseFloat(e.unit_price)||0,status:e.status,currency:"USD"}}))).reduce((e,t)=>e+t.value,0),i=i.map(e=>({...e,percentage:r>0?e.value/r*100:0}))):(i=[],r=0);break;default:return w.NextResponse.json({error:"Unsupported KPI type"},{status:400})}i.sort((e,t)=>t.value-e.value),console.log(`KPI Details Final Result for ${a}:`,{itemCount:i.length,totalValue:r,sampleItems:i.slice(0,2).map(e=>({name:e.name,type:e.type,value:e.value,hasMetadata:!!e.metadata}))});let y=l?.length||0;return"nav_breakdown"===a&&(0===i.length&&y>0?console.error(`DATA MISMATCH: NAV breakdown returned 0 items but investor has ${y} holdings!`):i.length!==y?console.warn(`DATA MISMATCH: NAV breakdown returned ${i.length} items but investor has ${y} holdings`):console.log(`✅ DATA CONSISTENT: NAV breakdown returned ${i.length} items matching ${y} holdings`)),"contributions_breakdown"===a&&(0===i.length&&y>0?console.error(`DATA MISMATCH: Contributions breakdown returned 0 items but investor has ${y} holdings!`):console.log(`✅ Contributions breakdown returned ${i.length} items (may be less than ${y} holdings if some have no contributions)`)),await b.auditLogger.log({actor_user_id:t.id,action:b.AuditActions.READ,entity:"kpi_details",entity_id:t.id,metadata:{kpi_type:a,item_count:i.length,total_value:r,has_data:i.length>0}}),w.NextResponse.json({items:i,total:r,kpiType:a,asOfDate:new Date().toISOString(),debug:void 0})}catch(e){return console.error("KPI Details API error:",e),console.error("Error details:",{kpiType:a,errorMessage:e instanceof Error?e.message:"Unknown error",errorStack:e instanceof Error?e.stack:"No stack trace"}),w.NextResponse.json({error:"Internal server error",message:e instanceof Error?e.message:"Unknown error",debug:void 0},{status:500})}}e.s(["GET",()=>y],613432);var R=e.i(613432);let k=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/portfolio/kpi-details/route",pathname:"/api/portfolio/kpi-details",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/portfolio/kpi-details/route.ts",nextConfigOutput:"",userland:R}),{workAsyncStorage:E,workUnitAsyncStorage:A,serverHooks:C}=k;function $(){return(0,n.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:A})}async function S(e,t,n){k.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/portfolio/kpi-details/route";f=f.replace(/\/index$/,"")||"/";let b=await k.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!b)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:w,params:y,nextConfig:R,parsedUrl:E,isDraftMode:A,prerenderManifest:C,routerServerContext:$,isOnDemandRevalidate:S,revalidateOnlyGenerated:x,resolvedPathname:N,clientReferenceManifest:T,serverActionsManifest:D}=b,P=(0,r.normalizeAppPath)(f),U=!!(C.dynamicRoutes[P]||C.routes[N]),F=async()=>((null==$?void 0:$.render404)?await $.render404(e,t,E,!1):t.end("This page could not be found"),null);if(U&&!A){let e=!!C.routes[N],t=C.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await F();throw new _.NoFallbackError}}let I=null;!U||k.isDev||A||(I="/index"===(I=N)?"/":I);let O=!0===k.isDev||!U,q=U&&!O;D&&T&&(0,i.setManifestsSingleton)({page:f,clientReferenceManifest:T,serverActionsManifest:D});let H=e.method||"GET",M=(0,s.getTracer)(),j=M.getActiveScopeSpan(),K={params:y,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,o)=>k.onRequestError(e,t,n,o,$)},sharedContext:{buildId:w}},V=new l.NodeNextRequest(e),L=new l.NodeNextResponse(t),B=c.NextRequestAdapter.fromNodeNextRequest(V,(0,c.signalFromNodeResponse)(t));try{let i=async e=>k.handle(B,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=M.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${f}`)}),r=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var s,l;let c=async({previousCacheEntry:a})=>{try{if(!r&&S&&x&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(o);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let c=K.renderOpts.collectedTags;if(!U)return await (0,p.sendResponse)(V,L,s,K.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(s.headers);c&&(t[m.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,n=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==a?void 0:a.isStale)&&await k.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:S})},!1,$),t}},d=await k.handleResponse({req:e,nextConfig:R,cacheKey:I,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:x,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:r});if(!U)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});r||t.setHeader("x-nextjs-cache",S?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return r&&U||_.delete(m.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,v.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(V,L,new Response(d.value.body,{headers:_,status:d.value.status||200})),null};j?await l(j):await M.withPropagatedContext(e.headers,()=>M.trace(d.BaseServerSpan.handleRequest,{spanName:`${H} ${f}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await k.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:S})},!1,$),U)throw t;return await (0,p.sendResponse)(V,L,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>$,"routeModule",()=>k,"serverHooks",()=>C,"workAsyncStorage",()=>E,"workUnitAsyncStorage",()=>A],380362)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_7bdbb125.js.map