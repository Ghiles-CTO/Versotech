{"version":3,"sources":["../../../../versotech-portal/src/lib/supabase/server.ts","../../../../versotech-portal/src/lib/audit.ts","../../../../versotech-portal/src/lib/signature/config.ts","../../../../versotech-portal/src/lib/signature/anchor-detector.ts","../../../../versotech-portal/src/lib/signature/storage.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n","import { createClient } from './supabase/server'\r\n\r\nexport interface AuditLogEntry {\r\n  actor_user_id?: string\r\n  action: string\r\n  entity: string\r\n  entity_id?: string\r\n  metadata?: Record<string, any>\r\n}\r\n\r\nclass AuditLogger {\r\n  private static instance: AuditLogger\r\n\r\n  static getInstance(): AuditLogger {\r\n    if (!AuditLogger.instance) {\r\n      AuditLogger.instance = new AuditLogger()\r\n    }\r\n    return AuditLogger.instance\r\n  }\r\n\r\n  async log(entry: AuditLogEntry): Promise<void> {\r\n    try {\r\n      const supabase = await createClient()\r\n\r\n      // Insert into audit_logs with correct column names\r\n      await supabase.from('audit_logs').insert({\r\n        event_type: 'system',\r\n        actor_id: entry.actor_user_id || null,\r\n        action: entry.action,\r\n        entity_type: entry.entity,\r\n        entity_id: entry.entity_id || null,\r\n        action_details: entry.metadata || null,\r\n        timestamp: new Date().toISOString()\r\n      })\r\n\r\n    } catch (error) {\r\n      console.error('Audit logging failed:', error)\r\n      // Don't throw to avoid breaking the main operation\r\n    }\r\n  }\r\n\r\n  async logMany(entries: AuditLogEntry[]): Promise<void> {\r\n    for (const entry of entries) {\r\n      await this.log(entry)\r\n    }\r\n  }\r\n}\r\n\r\nexport const auditLogger = AuditLogger.getInstance()\r\n\r\n// Common audit actions as constants\r\nexport const AuditActions = {\r\n  // Authentication\r\n  LOGIN: 'login',\r\n  LOGOUT: 'logout',\r\n  PASSWORD_CHANGE: 'password_change',\r\n\r\n  // Data operations\r\n  CREATE: 'create',\r\n  READ: 'read', \r\n  UPDATE: 'update',\r\n  DELETE: 'delete',\r\n\r\n  // Documents\r\n  DOCUMENT_UPLOAD: 'document_upload',\r\n  DOCUMENT_DOWNLOAD: 'document_download',\r\n  DOCUMENT_DELETE: 'document_delete',\r\n\r\n  // Workflows\r\n  WORKFLOW_TRIGGER: 'workflow_trigger',\r\n  WORKFLOW_COMPLETED: 'workflow_completed',\r\n  WORKFLOW_FAILED: 'workflow_failed',\r\n\r\n  // System operations\r\n  USER_CREATED: 'user_created',\r\n  PROFILE_UPDATED: 'profile_updated',\r\n  ROLE_CHANGED: 'role_changed',\r\n\r\n  // Business operations\r\n  SUBSCRIPTION_CREATED: 'subscription_created',\r\n  CAPITAL_CALL_CREATED: 'capital_call_created',\r\n  DISTRIBUTION_CREATED: 'distribution_created',\r\n  REPORT_REQUESTED: 'report_requested',\r\n  MESSAGE_SENT: 'message_sent',\r\n\r\n  // Commission lifecycle (GAP-7)\r\n  COMMISSION_CREATED: 'commission_created',\r\n  COMMISSION_ACCRUED: 'commission_accrued',\r\n  COMMISSION_INVOICE_REQUESTED: 'commission_invoice_requested',\r\n  COMMISSION_INVOICED: 'commission_invoiced',\r\n  COMMISSION_PAID: 'commission_paid',\r\n  COMMISSION_CANCELLED: 'commission_cancelled',\r\n\r\n  // Agreement events (GAP-8)\r\n  AGREEMENT_CREATED: 'agreement_created',\r\n  AGREEMENT_SENT: 'agreement_sent',\r\n  AGREEMENT_APPROVED: 'agreement_approved',\r\n  AGREEMENT_SIGNED: 'agreement_signed',\r\n  AGREEMENT_ACTIVATED: 'agreement_activated',\r\n  AGREEMENT_REJECTED: 'agreement_rejected',\r\n  AGREEMENT_EXPIRED: 'agreement_expired'\r\n} as const\r\n\r\n// Entity types\r\nexport const AuditEntities = {\r\n  USERS: 'users',\r\n  PROFILES: 'profiles',\r\n  INVESTORS: 'investors',\r\n  VEHICLES: 'vehicles',\r\n  SUBSCRIPTIONS: 'subscriptions',\r\n  POSITIONS: 'positions',\r\n  DOCUMENTS: 'documents',\r\n  WORKFLOWS: 'workflows',\r\n  WORKFLOW_RUNS: 'workflow_runs',\r\n  CONVERSATIONS: 'conversations',\r\n  MESSAGES: 'messages',\r\n  REQUEST_TICKETS: 'request_tickets',\r\n  CAPITAL_CALLS: 'capital_calls',\r\n  DISTRIBUTIONS: 'distributions',\r\n  DEALS: 'deals',\r\n  // RESERVATIONS: 'reservations', // Deprecated - removed from workflow\r\n  ALLOCATIONS: 'allocations',\r\n  FEE_EVENTS: 'fee_events',\r\n  INVOICES: 'invoices',\r\n  BANK_TRANSACTIONS: 'bank_transactions',\r\n  PAYMENTS: 'payments',\r\n  ARRANGER: 'arranger_entities',\r\n  INTRODUCER: 'introducers',\r\n  PARTNER: 'partners',\r\n  COMMERCIAL_PARTNER: 'commercial_partners',\r\n  FEE_PLANS: 'arranger_fee_plans',\r\n  CEO_ENTITY: 'ceo_entity',\r\n  CEO_USERS: 'ceo_users',\r\n  // Commission entities (GAP-7)\r\n  INTRODUCER_COMMISSIONS: 'introducer_commissions',\r\n  PARTNER_COMMISSIONS: 'partner_commissions',\r\n  COMMERCIAL_PARTNER_COMMISSIONS: 'commercial_partner_commissions',\r\n  // Agreement entities (GAP-8)\r\n  INTRODUCER_AGREEMENTS: 'introducer_agreements',\r\n  PARTNER_AGREEMENTS: 'partner_agreements',\r\n  COMMERCIAL_PARTNER_AGREEMENTS: 'commercial_partner_agreements',\r\n  // Introductions\r\n  INTRODUCTIONS: 'introductions',\r\n} as const\r\n\r\n","/**\r\n * Centralized configuration for signature system\r\n */\r\n\r\nexport const SIGNATURE_CONFIG = {\r\n  storage: {\r\n    bucket: process.env.SIGNATURES_BUCKET || 'signatures',\r\n    paths: {\r\n      unsigned: (investorId: string, token: string) =>\r\n        `${investorId}/${token}_unsigned.pdf`,\r\n      signed: (investorId: string, token: string) =>\r\n        `${investorId}/${token}_signed.pdf`\r\n    }\r\n  },\r\n  token: {\r\n    lengthBytes: 32,\r\n    expiryDays: 7\r\n  },\r\n  pdf: {\r\n    signature: {\r\n      // Reduced from 180x70 to fit better in subscription pack signature fields\r\n      // and prevent overlap with surrounding text\r\n      width: 150,\r\n      height: 50\r\n    },\r\n    table: {\r\n      // Y position calibrated from actual NDA template (Page 5, US Letter 612√ó792pt)\r\n      // Signature boxes: y=433 from bottom, height=112\r\n      // Formula: signatureY = bottom + height/2 - sigHeight/2\r\n      // Target Y = 433 + 56 - 35 = 454 (centered in 112pt box)\r\n      bottom: 433,\r\n      height: 112\r\n    },\r\n    positions: {\r\n      // X positions calibrated from actual NDA template (Page 5)\r\n      // Party A (Investor): left box x=53, width=252 ‚Üí center=179 ‚Üí 179/612=0.292\r\n      party_a: { xPercent: 0.292 },\r\n      // Party B (VERSO): right box x=305, width=252 ‚Üí center=431 ‚Üí 431/612=0.704\r\n      party_b: { xPercent: 0.704 }\r\n    },\r\n    metadata: {\r\n      timestampFontSize: 7,\r\n      // Reduced offsets to keep metadata closer to signature\r\n      // and prevent overlap with content below\r\n      timestampOffsetY: 12,  // was 15\r\n      signerNameOffsetY: 22, // was 27\r\n      textColor: { r: 0.3, g: 0.3, b: 0.3 }\r\n    }\r\n  },\r\n  email: {\r\n    fromAddress: 'signatures@versoholdings.com',\r\n    replyTo: 'support@versoholdings.com'\r\n  }\r\n} as const\r\n","/**\n * Anchor Detection for Subscription Pack PDFs\n *\n * Scans a PDF for SIG_ANCHOR markers and returns their exact positions.\n * These positions are used to place signatures at the correct locations.\n *\n * ANCHOR NAMING CONVENTION (matches database signature_position):\n * - Subscribers: party_a, party_a_2, party_a_3, ... (first is 'party_a', NOT 'party_a_1')\n * - Issuer: party_b, party_b_form, party_b_wire, party_b_tcs\n * - Arranger: party_c, party_c_tcs\n * - Introducer agreements: party_a (VERSO/Arranger), party_b, party_b_2, ...\n */\n\nimport { existsSync } from 'fs'\nimport { fileURLToPath } from 'url'\nimport type { DocumentType, SignaturePlacementRecord } from './types'\nimport { SIGNATURE_CONFIG } from './config'\n\nexport interface DetectedAnchor {\n  anchorId: string       // e.g., 'party_a', 'party_b_tcs', 'party_a_2_form'\n  pageNumber: number     // 1-indexed page number\n  rawX: number           // X coordinate in points (from left of page)\n  rawY: number           // Y coordinate in points (from bottom of page - PDF native)\n  xPercent: number       // X as percentage of page width (0-1)\n  yFromBottom: number    // Y in points from bottom (same as rawY for PDF.js)\n  pageWidth: number      // Page width in points\n  pageHeight: number     // Page height in points\n}\n\n/**\n * Scan PDF for all SIG_ANCHOR markers\n *\n * The PDF.js library extracts text items with their transform matrices.\n * transform[4] = X position, transform[5] = Y position (from bottom of page)\n *\n * @param pdfBytes - Raw PDF bytes as Uint8Array\n * @returns Array of detected anchors with positions\n */\nexport async function detectAnchors(pdfBytes: Uint8Array): Promise<DetectedAnchor[]> {\n  // Dynamic import pdfjs-dist\n  const pdfjsLib = await import('pdfjs-dist/legacy/build/pdf.mjs')\n\n  // CRITICAL: Set worker path for Node.js/server-side usage\n  // Must be set BEFORE calling getDocument\n  const workerCandidates = [\n    process.env.PDFJS_WORKER_SRC,\n    new URL('pdfjs-dist/legacy/build/pdf.worker.mjs', import.meta.url).toString(),\n    new URL('../../../node_modules/pdfjs-dist/legacy/build/pdf.worker.mjs', import.meta.url).toString()\n  ].filter(Boolean) as string[]\n\n  const resolvedWorkerSrc = workerCandidates.find((candidate) => {\n    try {\n      const path = candidate.startsWith('file:')\n        ? fileURLToPath(candidate)\n        : candidate\n      return existsSync(path)\n    } catch {\n      return false\n    }\n  }) || workerCandidates[0]\n\n  pdfjsLib.GlobalWorkerOptions.workerSrc = resolvedWorkerSrc\n\n  const anchors: DetectedAnchor[] = []\n\n  try {\n    const loadingTask = pdfjsLib.getDocument({\n      data: pdfBytes,\n      useSystemFonts: true,\n      disableFontFace: true,\n    })\n\n    const pdf = await loadingTask.promise\n\n    console.log(`üîç [ANCHOR] Scanning ${pdf.numPages} pages for SIG_ANCHOR markers...`)\n\n    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {\n      const page = await pdf.getPage(pageNum)\n      const textContent = await page.getTextContent()\n      const viewport = page.getViewport({ scale: 1.0 })\n\n      for (const item of textContent.items) {\n        if (!('str' in item)) continue\n\n        const text = item.str\n\n        // Check for both formats:\n        // 1. Normal: SIG_ANCHOR:party_b_wire\n        // 2. Space-corrupted: SIG ANCHOR:party b wire (HTML-to-PDF renderer sometimes breaks underscores)\n        const hasNormalAnchor = text.includes('SIG_ANCHOR:')\n        const hasSpaceAnchor = text.includes('SIG ANCHOR:')\n\n        if (!hasNormalAnchor && !hasSpaceAnchor) continue\n\n        // Try normal format first, then space-corrupted format\n        let anchorId: string | null = null\n\n        if (hasNormalAnchor) {\n          const match = text.match(/SIG_ANCHOR:(\\S+)/)\n          if (match) {\n            anchorId = match[1]\n          }\n        } else if (hasSpaceAnchor) {\n          // Match space-corrupted format: \"SIG ANCHOR:party b wire\" or \"SIG ANCHOR:party c\"\n          // Capture everything after the colon until end or next significant separator\n          const match = text.match(/SIG ANCHOR:([a-z0-9_ ]+)/i)\n          if (match) {\n            // Normalize: convert spaces to underscores, trim\n            anchorId = match[1].trim().replace(/ /g, '_')\n            console.log(`   üîß Normalized space-corrupted anchor: \"${match[1]}\" -> \"${anchorId}\"`)\n          }\n        }\n\n        if (!anchorId) continue\n\n        const rawX = item.transform[4]\n        const rawY = item.transform[5]\n\n        anchors.push({\n          anchorId,\n          pageNumber: pageNum,\n          rawX,\n          rawY,\n          xPercent: rawX / viewport.width,\n          yFromBottom: rawY,\n          pageWidth: viewport.width,\n          pageHeight: viewport.height\n        })\n\n        console.log(`   üìç Found ${anchorId} on page ${pageNum} at (${rawX.toFixed(1)}, ${rawY.toFixed(1)}) - ${(rawX / viewport.width * 100).toFixed(1)}% from left`)\n      }\n    }\n  } catch (error) {\n    console.error('‚ùå [ANCHOR] PDF parsing error:', error)\n    throw error\n  }\n\n  console.log(`‚úÖ [ANCHOR] Found ${anchors.length} anchor(s) total`)\n  return anchors\n}\n\n/**\n * Get a specific anchor by ID\n *\n * @param anchors - Array of detected anchors\n * @param anchorId - The anchor ID to find\n * @returns The anchor, or throws if not found\n */\nexport function getAnchorById(anchors: DetectedAnchor[], anchorId: string): DetectedAnchor {\n  const anchor = anchors.find(a => a.anchorId === anchorId)\n  if (!anchor) {\n    const available = anchors.map(a => a.anchorId).join(', ') || '(none)'\n    throw new Error(`ANCHOR_NOT_FOUND: ${anchorId}. Available anchors: ${available}`)\n  }\n  return anchor\n}\n\n/**\n * Validate that all required anchors exist in the detected set\n *\n * @param anchors - Array of detected anchors\n * @param required - Array of anchor IDs that must be present\n * @throws Error if any required anchor is missing\n */\nexport function validateRequiredAnchors(anchors: DetectedAnchor[], required: string[]): void {\n  const found = new Set(anchors.map(a => a.anchorId))\n  const missing = required.filter(r => !found.has(r))\n\n  if (missing.length > 0) {\n    const available = Array.from(found).join(', ') || '(none)'\n    throw new Error(`MISSING_ANCHORS: ${missing.join(', ')}. Found: ${available}`)\n  }\n}\n\n/**\n * Get anchor patterns for a given signature position\n *\n * NAMING CONVENTION:\n * - Database uses: party_a, party_a_2, party_a_3 (first is 'party_a', NOT 'party_a_1')\n * - Anchors match the database convention exactly\n *\n * WHICH PAGES EACH PARTY SIGNS:\n * - Subscribers (party_a*): Page 2 (form), Page 12 (main)\n * - Issuer (party_b): Page 2 (form), Page 3 (wire), Page 12 (main), Page 39 (T&Cs)\n * - Arranger (party_c): Page 12 (main), Page 39 (T&Cs)\n *\n * @param position - Database signature_position value\n * @returns Array of anchor patterns with their labels\n */\nfunction getAnchorPatternsForPosition(\n  position: string,\n  documentType: DocumentType = 'subscription'\n): { anchorId: string; label: string }[] {\n  if (documentType === 'introducer_agreement') {\n    return [\n      { anchorId: position, label: 'introducer_agreement' }\n    ]\n  }\n\n  // Subscribers sign on: Page 2 (form), Page 12 (main)\n  if (position.startsWith('party_a')) {\n    // position is 'party_a', 'party_a_2', 'party_a_3', etc.\n    // Anchors use SAME base: 'party_a', 'party_a_2', 'party_a_3'\n    const base = position\n    return [\n      { anchorId: `${base}_form`, label: 'subscription_form' },\n      { anchorId: base, label: 'main_agreement' }\n    ]\n  }\n\n  // Issuer signs on: Page 2 (form), Page 3 (wire), Page 12 (main), Page 39 (T&Cs)\n  if (position === 'party_b') {\n    return [\n      { anchorId: 'party_b_form', label: 'subscription_form' },\n      { anchorId: 'party_b_wire', label: 'wire_instructions' },\n      { anchorId: 'party_b', label: 'main_agreement' },\n      { anchorId: 'party_b_tcs', label: 'tcs' }\n    ]\n  }\n\n  // Arranger signs on: Page 12 (main), Page 39 (T&Cs)\n  if (position === 'party_c') {\n    return [\n      { anchorId: 'party_c', label: 'main_agreement' },\n      { anchorId: 'party_c_tcs', label: 'tcs' }\n    ]\n  }\n\n  console.warn(`‚ö†Ô∏è [ANCHOR] Unknown position: ${position}`)\n  return []\n}\n\n/**\n * Get fixed X position for signature based on party type and page label\n *\n * RATIONALE: The anchor's raw X coordinate represents where the anchor TEXT starts,\n * not where the signature should go. Since anchors are placed at the start of cells/blocks,\n * they always report X near the left margin. Instead, we use FIXED positions based on\n * the known column layout of the subscription pack template:\n *\n * COLUMN POSITIONS:\n * - Form page: Issuer left column, Subscriber right column\n * - Main agreement: All parties stacked on the left\n * - T&Cs: Issuer/Arranger centered on signature page\n *\n * @param signaturePosition - The database signature_position value (party_a, party_b, party_c)\n * @param label - The page/section label (subscription_form, main_agreement, etc.)\n * @returns X position as percentage of page width (0-1)\n */\nfunction getSignatureXPosition(\n  signaturePosition: string,\n  label: string,\n  documentType: DocumentType = 'subscription'\n): number {\n  // Party A (Subscribers): Right column on form page, stacked-left on main agreement\n  if (signaturePosition.startsWith('party_a')) {\n    if (label === 'subscription_form') return 0.63  // Right column (form table)\n    return 0.29  // Stacked left (main agreement)\n  }\n\n  // Party B (Issuer): Left on form/wire/main, centered on T&Cs signature page\n  if (signaturePosition === 'party_b') {\n    if (label === 'tcs') return 0.43\n    if (label === 'main_agreement') return 0.29\n    if (label === 'subscription_form') return 0.20\n    return 0.25\n  }\n\n  // Party C (Arranger): Stacked left on main, centered on T&Cs signature page\n  if (signaturePosition === 'party_c') {\n    if (label === 'tcs') return 0.43\n    return 0.29\n  }\n\n  return 0.29  // Default to stacked-left alignment\n}\n\n/**\n * Get signature Y position from the anchor position\n *\n * Anchors are now placed ON the signature line. This function shifts the signature\n * image ABOVE the line so that the metadata (timestamp + signer name) sits just\n * above the line and does not overlap Name/Title text below.\n *\n * @param anchor - Detected anchor with rawY (line position)\n * @param label - Page/section label (used for compact layout offsets)\n * @returns Signature Y position in points from bottom of page\n */\nfunction getSignatureYFromAnchor(\n  anchor: DetectedAnchor,\n  label: string,\n  documentType: DocumentType = 'subscription'\n): number {\n  const { metadata } = SIGNATURE_CONFIG.pdf\n\n  // Keep in sync with embedSignatureMultipleLocations() compact layout offsets\n  const compactSignerOffset = 14\n  const signerOffset = label === 'wire_instructions'\n    ? compactSignerOffset\n    : metadata.signerNameOffsetY\n\n  const lineGap = 4\n  return anchor.rawY + signerOffset + lineGap\n}\n\n/**\n * Convert detected anchors to signature placements for a specific signer\n *\n * This is the main function used during signature request creation to\n * calculate where signatures should be placed based on detected anchors.\n *\n * POSITIONING STRATEGY (v5 - ANCHOR-BASED Y):\n * - X: Uses FIXED column positions based on party type and page label\n * - Y: Uses anchor position + offset (anchor is on the signature line)\n *\n * WHY ANCHOR-BASED Y:\n * Anchors are placed directly on the signature line, so anchor.yFromBottom is the\n * line position. We then offset upward so the signature image sits above the line.\n *\n * X POSITIONING (VC215-aligned):\n * - Party A (Subscribers): 63% on form, 29% on main agreement\n * - Party B (Issuer): 20% on form, 25% on wire, 29% on main, 43% on T&Cs\n * - Party C (Arranger): 29% on main, 43% on T&Cs\n *\n * @param anchors - All detected anchors from PDF\n * @param signaturePosition - The signer's position (e.g., 'party_a', 'party_b')\n * @returns Array of placements for this signer\n */\nexport function getPlacementsFromAnchors(\n  anchors: DetectedAnchor[],\n  signaturePosition: string,\n  documentType: DocumentType = 'subscription'\n): SignaturePlacementRecord[] {\n  // Map signature positions to their anchor patterns\n  const anchorPatterns = getAnchorPatternsForPosition(signaturePosition, documentType)\n  const placements: SignaturePlacementRecord[] = []\n\n  console.log(`üìç [PLACEMENT] Calculating placements for ${signaturePosition} (${documentType}, anchor-based Y)...`)\n\n  for (const pattern of anchorPatterns) {\n    const anchor = anchors.find(a => a.anchorId === pattern.anchorId)\n    if (anchor) {\n      const fixedX = documentType === 'introducer_agreement'\n        ? anchor.xPercent\n        : getSignatureXPosition(signaturePosition, pattern.label, documentType)\n\n      // Get signature Y position based on anchor line + offset\n      const signatureY = getSignatureYFromAnchor(anchor, pattern.label, documentType)\n\n      // Debug logging\n      console.log(`   üîç [ANCHOR] ${pattern.anchorId} on page ${anchor.pageNumber}`)\n      console.log(`      Anchor position (for reference): (${anchor.rawX.toFixed(0)}pt, ${anchor.rawY.toFixed(0)}pt)`)\n      console.log(`   üìç [PLACEMENT] ${signaturePosition} -> page ${anchor.pageNumber}`)\n      console.log(`      FIXED X: ${(fixedX * 100).toFixed(0)}% | ANCHOR Y: ${signatureY.toFixed(0)}pt (${pattern.label})`)\n\n      placements.push({\n        page: anchor.pageNumber,\n        x: fixedX,  // FIXED X position based on party/page\n        y: signatureY,  // Anchor-based Y position\n        label: pattern.label\n      })\n\n      console.log(`   ‚úì ${pattern.anchorId} -> page ${anchor.pageNumber}, x=${(fixedX * 100).toFixed(0)}%, y=${signatureY.toFixed(0)}pt (${pattern.label})`)\n    } else {\n      console.warn(`   ‚ö†Ô∏è Anchor not found: ${pattern.anchorId} (expected for ${signaturePosition})`)\n    }\n  }\n\n  console.log(`‚úÖ [PLACEMENT] Created ${placements.length} placement(s) for ${signaturePosition}`)\n  return placements\n}\n\n/**\n * Get required anchors for a subscription pack based on signatory count\n *\n * @param subscriberCount - Number of investor signatories (1-10)\n * @returns Array of all anchor IDs that should be present in the PDF\n */\nexport function getRequiredAnchorsForSubscriptionPack(subscriberCount: number): string[] {\n  const required: string[] = []\n\n  // Subscriber anchors (party_a, party_a_2, party_a_3, ...)\n  for (let i = 1; i <= subscriberCount; i++) {\n    const base = i === 1 ? 'party_a' : `party_a_${i}`\n    required.push(`${base}_form`)   // Page 2\n    required.push(base)              // Page 12\n  }\n\n  // Issuer anchors (party_b)\n  required.push('party_b_form')  // Page 2\n  required.push('party_b_wire')  // Page 3\n  required.push('party_b')       // Page 12\n  required.push('party_b_tcs')   // Page 39\n\n  // Arranger anchors (party_c)\n  required.push('party_c')       // Page 12\n  required.push('party_c_tcs')   // Page 39\n\n  return required\n}\n\n/**\n * Get required anchors for an introducer agreement based on signatory count\n *\n * @param signatoryCount - Number of introducer signers\n * @returns Array of anchor IDs that should be present in the PDF\n */\nexport function getRequiredAnchorsForIntroducerAgreement(signatoryCount: number): string[] {\n  const required: string[] = ['party_a']\n\n  for (let i = 1; i <= signatoryCount; i++) {\n    const base = i === 1 ? 'party_b' : `party_b_${i}`\n    required.push(base)\n  }\n\n  return required\n}\n\n/**\n * Helper to generate anchor ID matching database convention\n * First subscriber is 'party_a', subsequent are 'party_a_2', 'party_a_3', etc.\n *\n * @param number - 1-based signatory number\n * @param suffix - Optional suffix like 'form'\n * @returns Anchor ID string\n */\nexport function getSignatoryAnchorId(number: number, suffix?: string): string {\n  const base = number === 1 ? 'party_a' : `party_a_${number}`\n  return suffix ? `${base}_${suffix}` : base\n}\n","/**\r\n * Storage management for signature PDFs\r\n */\r\n\r\nimport type { SupabaseClient } from '@supabase/supabase-js'\r\nimport { SIGNATURE_CONFIG } from './config'\r\n\r\nexport class SignatureStorageManager {\r\n  constructor(private supabase: SupabaseClient) {}\r\n\r\n  /**\r\n   * Upload unsigned PDF to storage\r\n   */\r\n  async uploadUnsignedPDF(\r\n    investorId: string,\r\n    token: string,\r\n    pdfBytes: Uint8Array,\r\n    metadata: Record<string, string>\r\n  ): Promise<string> {\r\n    const path = SIGNATURE_CONFIG.storage.paths.unsigned(investorId, token)\r\n\r\n    const { data, error } = await this.supabase.storage\r\n      .from(SIGNATURE_CONFIG.storage.bucket)\r\n      .upload(path, pdfBytes, {\r\n        contentType: 'application/pdf',\r\n        metadata\r\n      })\r\n\r\n    if (error) {\r\n      throw new Error(`Failed to upload unsigned PDF: ${error.message}`)\r\n    }\r\n\r\n    return data.path\r\n  }\r\n\r\n  /**\r\n   * Upload signed PDF to storage\r\n   */\r\n  async uploadSignedPDF(\r\n    investorId: string,\r\n    token: string,\r\n    pdfBytes: Uint8Array,\r\n    metadata: Record<string, string>\r\n  ): Promise<string> {\r\n    const path = SIGNATURE_CONFIG.storage.paths.signed(investorId, token)\r\n\r\n    const { data, error } = await this.supabase.storage\r\n      .from(SIGNATURE_CONFIG.storage.bucket)\r\n      .upload(path, pdfBytes, {\r\n        contentType: 'application/pdf',\r\n        metadata\r\n      })\r\n\r\n    if (error) {\r\n      throw new Error(`Failed to upload signed PDF: ${error.message}`)\r\n    }\r\n\r\n    return data.path\r\n  }\r\n\r\n  /**\r\n   * Download PDF from storage\r\n   *\r\n   * Handles files from both 'signatures' and 'deal-documents' buckets:\r\n   * - Paths starting with 'subscriptions/', 'introducer-agreements/', 'placement-agreements/' are in 'deal-documents'\r\n   * - All other paths are in 'signatures' bucket\r\n   */\r\n  async downloadPDF(path: string): Promise<Uint8Array> {\r\n    // Determine bucket based on path pattern\r\n    const bucket = (path.startsWith('subscriptions/') || path.startsWith('introducer-agreements/') || path.startsWith('placement-agreements/'))\r\n      ? 'deal-documents'\r\n      : SIGNATURE_CONFIG.storage.bucket\r\n\r\n    const { data, error } = await this.supabase.storage\r\n      .from(bucket)\r\n      .download(path)\r\n\r\n    if (error) {\r\n      throw new Error(`Failed to download PDF: ${error.message}`)\r\n    }\r\n\r\n    return new Uint8Array(await data.arrayBuffer())\r\n  }\r\n\r\n  /**\r\n   * Get signed URL for PDF\r\n   *\r\n   * Handles files from both 'signatures' and 'deal-documents' buckets:\r\n   * - Paths starting with 'subscriptions/' are in 'deal-documents' (certificates)\r\n   * - All other paths are in 'signatures' bucket\r\n   */\r\n  async getSignedUrl(path: string, expirySeconds: number = 3600): Promise<string> {\r\n    // Determine bucket based on path pattern\r\n    // Documents in deal-documents bucket: subscriptions/, introducer-agreements/, placement-agreements/\r\n    const bucket = (path.startsWith('subscriptions/') || path.startsWith('introducer-agreements/') || path.startsWith('placement-agreements/'))\r\n      ? 'deal-documents'\r\n      : SIGNATURE_CONFIG.storage.bucket\r\n\r\n    const { data, error } = await this.supabase.storage\r\n      .from(bucket)\r\n      .createSignedUrl(path, expirySeconds)\r\n\r\n    if (error) {\r\n      throw new Error(`Failed to create signed URL: ${error.message}`)\r\n    }\r\n\r\n    return data.signedUrl\r\n  }\r\n}\r\n\r\n/**\r\n * Download PDF from external URL (e.g., Google Drive)\r\n */\r\nexport async function downloadPDFFromUrl(url: string): Promise<Uint8Array> {\r\n  const response = await fetch(url)\r\n\r\n  if (!response.ok) {\r\n    throw new Error(`Failed to download PDF: ${response.statusText}`)\r\n  }\r\n\r\n  return new Uint8Array(await response.arrayBuffer())\r\n}\r\n"],"names":[],"mappings":"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"}