module.exports=[23486,e=>{"use strict";var t=e.i(779444),i=e.i(698261),r=e.i(821776),a=e.i(796417),n=e.i(856890),o=e.i(26996),s=e.i(436944),d=e.i(88281),l=e.i(765944),c=e.i(984788),u=e.i(237011),_=e.i(712007),g=e.i(777657),m=e.i(13180),p=e.i(273827),f=e.i(193695);e.i(947956);var E=e.i(36217),v=e.i(414131),R=e.i(433669),h=e.i(254799);async function N(e){let t=await e.text(),i=e.headers.get("x-signature-verification")||e.headers.get("x-dropbox-signature")||e.headers.get("x-docusign-signature-1");if(!i)return console.error("âš ï¸ Webhook signature missing in headers"),v.NextResponse.json({error:"Unauthorized - no signature"},{status:401});let r=process.env.ESIGN_WEBHOOK_SECRET;if(!r)return console.error("âŒ ESIGN_WEBHOOK_SECRET not configured"),v.NextResponse.json({error:"Server configuration error"},{status:500});let a=h.default.createHmac("sha256",r).update(t).digest("hex");if(!h.default.timingSafeEqual(Buffer.from(i),Buffer.from(a)))return console.error("âŒ Invalid webhook signature"),v.NextResponse.json({error:"Unauthorized - invalid signature"},{status:401});let{signature_request_id:n,workflow_run_id:o,document_type:s,status:d}=JSON.parse(t);console.log("âœ… Signature webhook verified and received:",{signature_request_id:n,workflow_run_id:o,document_type:s,status:d});let l=(0,R.createServiceClient)();if("subscription"===s){let{data:e}=await l.from("signature_requests").select("id, subscription_id, deal_id, signer_role").eq("id",n).maybeSingle(),t=e?.signer_role;if(("admin"===t||"arranger"===t)&&e?.subscription_id){let{data:i}=await l.from("subscriptions").select(`
          id,
          deal_id,
          investor_id,
          investors (display_name, legal_name),
          deals (name)
        `).eq("id",e.subscription_id).single(),r=i?.deals?.name||"the deal",a=i?.investors?.display_name||i?.investors?.legal_name||"Investor";i?.deal_id&&await w(l,i.deal_id,{title:"Subscription Pack Countersigned",message:`${"arranger"===t?"Arranger":"CEO/Admin"} countersigned the subscription pack for ${a} (${r}).`,link:"/versotech_main/subscription-packs"})}}return"nda"===s&&await y(l,n,o),"subscription"===s&&await A(l,n,o),"placement_agreement"===s&&await T(l,n),"introducer_agreement"===s&&await b(l,n),v.NextResponse.json({success:!0})}async function w(e,t,i){let{data:r}=await e.from("deal_lawyer_assignments").select("lawyer_id").eq("deal_id",t),a=(r||[]).map(e=>e.lawyer_id).filter(Boolean);if(0===a.length){let{data:i}=await e.from("lawyers").select("id, assigned_deals").contains("assigned_deals",[t]);a=(i||[]).map(e=>e.id).filter(Boolean)}if(0===a.length)return;let{data:n}=await e.from("lawyer_users").select("user_id").in("lawyer_id",a);if(!n||0===n.length)return;let o=n.map(e=>({user_id:e.user_id,investor_id:null,title:i.title,message:i.message,link:i.link||"/versotech_main/subscription-packs"}));await e.from("investor_notifications").insert(o)}async function y(e,t,i){console.log("ðŸ”µ [NDA] Handling NDA completion for signature:",t);let{data:r}=await e.from("signature_requests").select("id, deal_id, investor_id, member_id, status").eq("id",t).single();if(!r)return void console.error("âŒ [NDA] Signature request not found:",t);let a=r.deal_id,n=r.investor_id;if(!a||!n)return void console.log("â­ï¸ [NDA] No deal_id or investor_id - not a Direct Subscribe flow");console.log("ðŸ“‹ [NDA] Processing for deal:",a,"investor:",n);let{data:o}=await e.from("signature_requests").select("id, status, signer_role").eq("deal_id",a).eq("investor_id",n).eq("document_type","nda").in("signer_role",["investor","authorized_signatory"]),s=o||[],d=s.length>0&&s.every(e=>"signed"===e.status);if(console.log("ðŸ“Š [NDA] Signature status:",{total:s.length,all_signed:d}),!d)return void console.log("â³ [NDA] Not all investor signatories have signed yet");let l=new Date().toISOString(),{data:c}=await e.from("subscriptions").select("id").eq("deal_id",a).eq("investor_id",n).in("status",["pending","committed"]).limit(1).maybeSingle(),u=!!c;console.log("ðŸ“‹ [NDA] Is Direct Subscribe path:",u,"subscription:",c?.id);let{data:_}=await e.from("investor_users").select("user_id").eq("investor_id",n);if(_&&_.length>0){let t=u?{nda_signed_at:l}:{nda_signed_at:l,data_room_granted_at:l};for(let i of _)await e.from("deal_memberships").update(t).eq("deal_id",a).eq("user_id",i.user_id);console.log("âœ… [NDA] Updated deal_memberships for",_.length,"user(s)")}if(u){if(console.log("â­ï¸ [NDA] Direct Subscribe path - skipping data room access grant"),_&&_.length>0){let{data:t}=await e.from("deals").select("name").eq("id",a).single();await e.from("investor_notifications").insert({user_id:_[0].user_id,investor_id:n,title:"NDA signed",message:`Your NDA for ${t?.name||"the deal"} is complete. Please complete the subscription pack signing.`,link:`/versotech_main/opportunities/${a}`,metadata:{type:"nda_complete_direct_subscribe",deal_id:a}}),console.log("âœ… [NDA] Direct Subscribe notification created")}}else{let t=new Date(Date.now()+6048e5).toISOString(),{error:i}=await e.from("deal_data_room_access").upsert({deal_id:a,investor_id:n,granted_at:l,expires_at:t,auto_granted:!0,revoked_at:null},{onConflict:"deal_id,investor_id"});if(i?console.error("âŒ [NDA] Failed to grant data room access:",i):console.log("âœ… [NDA] Data room access granted until:",t),_&&_.length>0){let{data:t}=await e.from("deals").select("name").eq("id",a).single();await e.from("investor_notifications").insert({user_id:_[0].user_id,investor_id:n,title:"Data room unlocked",message:`Your NDA for ${t?.name||"the deal"} is complete. The data room is now available.`,link:`/versotech_main/opportunities/${a}`,metadata:{type:"nda_complete",deal_id:a}}),console.log("âœ… [NDA] Notification created")}}console.log("ðŸŽ‰ [NDA] NDA completion processing finished")}async function A(e,t,i){console.log("ðŸ”µ [SUBSCRIPTION] Handling completion for signature:",t);let{data:r}=await e.from("signature_requests").select("id, subscription_id, investor_id, deal_id, status").eq("id",t).single();if(!r?.subscription_id){if(i){let{data:t}=await e.from("signature_requests").select("*").eq("workflow_run_id",i).order("created_at",{ascending:!0});if(t?.every(e=>"signed"===e.status)&&i){await e.from("documents").update({status:"signed"}).eq("id",i);let{data:t}=await e.from("documents").select("subscription_id").eq("id",i).single();if(t?.subscription_id){let r=new Date().toISOString();await e.from("subscriptions").update({status:"committed",signed_at:r,signed_doc_id:i,committed_at:r}).eq("id",t.subscription_id),console.log("âœ… [SUBSCRIPTION] Subscription committed (legacy flow):",t.subscription_id)}}}return}let a=r.subscription_id,{data:n}=await e.from("signature_requests").select("id, status, signer_role").eq("subscription_id",a).eq("document_type","subscription").in("signer_role",["investor","authorized_signatory"]),o=n||[],s=o.length>0&&o.every(e=>"signed"===e.status);if(console.log("ðŸ“Š [SUBSCRIPTION] Signature status:",{subscription_id:a,total:o.length,all_signed:s}),!s)return void console.log("â³ [SUBSCRIPTION] Not all investor signatories have signed yet");let d=new Date().toISOString(),{data:l,error:c}=await e.from("subscriptions").update({status:"committed",signed_at:d,committed_at:d}).eq("id",a).select("id, investor_id, deal_id, commitment, currency, vehicle_id").single();if(c)return void console.error("âŒ [SUBSCRIPTION] Failed to update subscription:",c);if(console.log("âœ… [SUBSCRIPTION] Subscription committed:",a),l){let{data:t}=await e.from("investor_users").select("user_id").eq("investor_id",l.investor_id).limit(1);if(t&&t.length>0){let{data:i}=await e.from("vehicles").select("name").eq("id",l.vehicle_id).single();await e.from("investor_notifications").insert({user_id:t[0].user_id,investor_id:l.investor_id,title:"Investment Commitment Confirmed",message:`Your subscription for ${i?.name||"the investment"} of ${l.commitment} ${l.currency} is now confirmed.`,link:"/versotech_main/portfolio",metadata:{type:"subscription_committed",subscription_id:a,deal_id:l.deal_id}}),console.log("âœ… [SUBSCRIPTION] Investor notification created")}let{data:i}=await e.from("investors").select("display_name, legal_name").eq("id",l.investor_id).single(),{data:r}=await e.from("vehicles").select("name").eq("id",l.vehicle_id).single(),n=i?.display_name||i?.legal_name||"An investor";l.deal_id&&await w(e,l.deal_id,{title:"Subscription Pack Signed",message:`${n} has signed the subscription pack for ${r?.name||"the deal"}. Commitment: ${l.commitment.toLocaleString()} ${l.currency}`,link:"/versotech_main/subscription-packs"})}await C(e,a),console.log("ðŸŽ‰ [SUBSCRIPTION] Subscription completion processing finished")}async function C(e,t){console.log("ðŸ“‹ [PUBLISH CHECK] Checking if subscription pack is fully signed:",t);let{data:i,error:r}=await e.from("signature_requests").select("id, status, signer_role, signature_position, document_id").eq("subscription_id",t).eq("document_type","subscription");if(r||!i||0===i.length)return void console.log("â­ï¸ [PUBLISH CHECK] No signature requests found for subscription");let a=i.every(e=>"signed"===e.status),n=i.filter(e=>"signed"===e.status).length;if(console.log(`ðŸ“Š [PUBLISH CHECK] Signature status: ${n}/${i.length} signed, all_complete=${a}`),!a)return void console.log("â³ [PUBLISH CHECK] Not all parties have signed yet");let o=i[0]?.document_id;if(!o)return void console.warn("âš ï¸ [PUBLISH CHECK] No document_id found on signature requests");let{error:s}=await e.from("documents").update({is_published:!0,status:"published",updated_at:new Date().toISOString()}).eq("id",o);s?console.error("âŒ [PUBLISH CHECK] Failed to publish document:",s):console.log("âœ… [PUBLISH CHECK] Document published! Investors can now see the signed subscription pack:",o)}async function T(e,t){console.log("ðŸ”µ [PLACEMENT AGREEMENT] Handling completion for signature:",t);let{data:i}=await e.from("signature_requests").select("id, placement_agreement_id, placement_id, signature_position, status").eq("id",t).single();if(!i?.placement_agreement_id)return void console.log("â­ï¸ [PLACEMENT AGREEMENT] No placement_agreement_id - skipping");let r=i.placement_agreement_id;console.log("ðŸ“‹ [PLACEMENT AGREEMENT] Processing for agreement:",r);let{data:a}=await e.from("placement_agreements").select(`
      *,
      commercial_partner:commercial_partner_id (
        id,
        legal_name,
        display_name
      )
    `).eq("id",r).single();if(!a)return void console.error("âŒ [PLACEMENT AGREEMENT] Agreement not found:",r);if("party_a"===i.signature_position){console.log("ðŸ‘” [PLACEMENT AGREEMENT] CEO (party_a) signed"),await e.from("placement_agreements").update({status:"pending_cp_signature",ceo_signature_request_id:t,updated_at:new Date().toISOString()}).eq("id",r);let{data:i}=await e.from("commercial_partner_users").select("user_id").eq("commercial_partner_id",a.commercial_partner_id);if(i&&i.length>0){let t=i.map(e=>({user_id:e.user_id,investor_id:null,title:"Placement Agreement Ready for Signature",message:"Your placement agreement has been signed by VERSO and is ready for your signature.",link:`/versotech_main/placement-agreements/${r}`,type:"placement_agreement",deal_id:null}));await e.from("investor_notifications").insert(t),console.log("âœ… [PLACEMENT AGREEMENT] Notified CP users")}}else if("party_b"===i.signature_position){console.log("ðŸ¢ [PLACEMENT AGREEMENT] CP (party_b) signed - activating agreement");let i=new Date().toISOString();await e.from("placement_agreements").update({status:"active",cp_signature_request_id:t,signed_date:i.split("T")[0],updated_at:i}).eq("id",r);let{data:n}=await e.from("commercial_partner_users").select("user_id").eq("commercial_partner_id",a.commercial_partner_id),o=a.commercial_partner?.legal_name||a.commercial_partner?.display_name||"Commercial Partner";if(n&&n.length>0){let t=n.map(e=>({user_id:e.user_id,investor_id:null,title:"Placement Agreement Active",message:"Your placement agreement is now fully executed and active.",link:`/versotech_main/placement-agreements/${r}`,type:"placement_agreement",deal_id:null}));await e.from("investor_notifications").insert(t),console.log("âœ… [PLACEMENT AGREEMENT] Notified CP users of activation")}let{data:s}=await e.from("profiles").select("id").eq("role","staff_admin").limit(5);if(s&&s.length>0){let t=s.map(e=>({user_id:e.id,investor_id:null,title:"Placement Agreement Executed",message:`Placement agreement with ${o} has been fully executed and is now active.`,link:`/versotech_main/placement-agreements/${r}`,type:"placement_agreement",deal_id:null}));await e.from("investor_notifications").insert(t),console.log("âœ… [PLACEMENT AGREEMENT] Notified staff users")}await e.from("audit_logs").insert({event_type:"commercial_partner",action:"placement_agreement_activated",entity_type:"placement_agreement",entity_id:r,actor_id:null,action_details:{description:"Placement agreement fully executed and activated",commercial_partner_id:a.commercial_partner_id,agreement_id:r,signature_request_id:t},timestamp:i})}console.log("ðŸŽ‰ [PLACEMENT AGREEMENT] Completion processing finished")}async function b(e,t){console.log("ðŸ”µ [INTRODUCER AGREEMENT] Handling completion for signature:",t);let{data:i}=await e.from("signature_requests").select("id, introducer_agreement_id, introducer_id, signer_role, signature_position, status, signed_pdf_path").eq("id",t).single();if(!i?.introducer_agreement_id)return void console.log("â­ï¸ [INTRODUCER AGREEMENT] No introducer_agreement_id - skipping");let r=i.introducer_agreement_id;console.log("ðŸ“‹ [INTRODUCER AGREEMENT] Processing for agreement:",r,"signer_role:",i.signer_role);let{data:a}=await e.from("introducer_agreements").select(`
      *,
      introducer:introducer_id (
        id,
        legal_name,
        email
      ),
      arranger:arranger_id (
        id,
        legal_name
      ),
      deal:deal_id (
        id,
        name,
        company_name
      )
    `).eq("id",r).single();if(!a)return void console.error("âŒ [INTRODUCER AGREEMENT] Agreement not found:",r);let n=new Date().toISOString(),o=a.introducer?.legal_name||"Introducer",s=a.introducer?.email||null,d=a.arranger?.legal_name||"Arranger",l=a.deal?.company_name||a.deal?.name||"Investment Opportunity";a.arranger_id;let c="arranger"===i.signer_role;if("arranger"===i.signer_role||"admin"===i.signer_role){console.log(`ðŸ‘” [INTRODUCER AGREEMENT] ${c?"Arranger":"CEO/Admin"} (party_a) signed`);let u={status:"pending_introducer_signature",updated_at:n};c?u.arranger_signature_request_id=t:u.ceo_signature_request_id=t;let{error:_}=await e.from("introducer_agreements").update(u).eq("id",r);_?console.error("âŒ [INTRODUCER AGREEMENT] Failed to update agreement status:",_):console.log("âœ… [INTRODUCER AGREEMENT] Agreement status updated to pending_introducer_signature");let{error:g}=await e.from("tasks").update({status:"completed",completed_at:n}).eq("related_entity_type","signature_request").eq("related_entity_id",t);g?console.warn("âš ï¸ [INTRODUCER AGREEMENT] Failed to complete CEO/Arranger task:",g):console.log("âœ… [INTRODUCER AGREEMENT] CEO/Arranger task marked as completed");let{data:m}=await e.from("introducer_users").select("user_id, user:user_id(email)").eq("introducer_id",a.introducer_id);if(m&&m.length>0){let t=c?d:"VERSO",n=m[0].user_id,u=m[0].user?.email,_=h.default.randomUUID(),g=new Date(Date.now()+12096e5),{data:p,error:f}=await e.from("signature_requests").insert({introducer_id:a.introducer_id,introducer_agreement_id:r,deal_id:a.deal_id,signer_email:s||u||"no-email@placeholder.com",signer_name:o,document_type:"introducer_agreement",signer_role:"introducer",signature_position:"party_b",signing_token:_,token_expires_at:g.toISOString(),unsigned_pdf_path:i.signed_pdf_path,status:"pending"}).select("id").single();if(f||!p)console.error("âŒ [INTRODUCER AGREEMENT] Failed to create introducer signature request:",f);else{console.log("âœ… [INTRODUCER AGREEMENT] Introducer signature request created:",p.id),await e.from("introducer_agreements").update({introducer_signature_request_id:p.id}).eq("id",r);let i=a.default_commission_bps?(a.default_commission_bps/100).toFixed(2):"0",s=a.performance_fee_bps?(a.performance_fee_bps/100).toFixed(2):null,d=s?`${i}% subscription fee, ${s}% performance fee`:`${i}% subscription fee`,c=`/sign/${_}`,{error:u}=await e.from("tasks").insert({owner_user_id:n,kind:"countersignature",category:"compliance",title:`Sign Your Introducer Agreement: ${l}`,description:`Please review and sign your introducer fee agreement.

â€¢ Deal: ${l}
â€¢ Your Commission: ${d}
â€¢ Reference: ${a.reference_number||"N/A"}

${t} has already signed. After you sign, the agreement becomes active.`,status:"pending",priority:"high",related_entity_type:"signature_request",related_entity_id:p.id,related_deal_id:a.deal_id,due_at:g.toISOString(),action_url:c,instructions:{type:"signature",action_url:c,signature_request_id:p.id,document_type:"introducer_agreement",introducer_id:a.introducer_id,introducer_name:o,deal_name:l,agreement_id:r,reference_number:a.reference_number,fee_summary:d}});u?console.error("âš ï¸ [INTRODUCER AGREEMENT] Failed to create introducer task:",u):console.log("âœ… [INTRODUCER AGREEMENT] Introducer task created in VERSOSign")}let E=m.map(e=>({user_id:e.user_id,investor_id:null,title:"Introducer Agreement Ready for Your Signature",message:`Your introducer agreement for ${l} has been signed by ${t} and is ready for your signature.`,link:"/versotech_main/versosign",type:"action_required"}));await e.from("investor_notifications").insert(E),console.log("âœ… [INTRODUCER AGREEMENT] Notified introducer users")}}else if("introducer"===i.signer_role){console.log("ðŸŽ‰ [INTRODUCER AGREEMENT] Introducer signed - activating agreement:",r);let{error:s}=await e.from("introducer_agreements").update({status:"active",introducer_signature_request_id:t,signed_date:n.split("T")[0],signed_pdf_url:i.signed_pdf_path,updated_at:n}).eq("id",r);if(s?console.error("âŒ [INTRODUCER AGREEMENT] Failed to activate agreement:",s):console.log("âœ… [INTRODUCER AGREEMENT] Agreement activated successfully"),a.fee_plan_id){console.log("ðŸ“‹ [INTRODUCER AGREEMENT] Updating linked fee plan to accepted:",a.fee_plan_id);let{data:t,error:i}=await e.from("fee_plans").select("id, status").eq("id",a.fee_plan_id).maybeSingle();if(i)console.error("âŒ [INTRODUCER AGREEMENT] Failed to fetch fee plan:",i);else if(t&&"accepted"!==t.status){let{data:t}=await e.from("introducer_users").select("user_id").eq("introducer_id",a.introducer_id).limit(1).maybeSingle(),{error:i}=await e.from("fee_plans").update({status:"accepted",accepted_at:n,accepted_by:t?.user_id||null,updated_at:n}).eq("id",a.fee_plan_id);i?console.error("âŒ [INTRODUCER AGREEMENT] Failed to update fee plan status:",i):(console.log("âœ… [INTRODUCER AGREEMENT] Fee plan marked as accepted"),await e.from("audit_logs").insert({event_type:"fee_plan",action:"accepted",entity_type:"fee_plans",entity_id:a.fee_plan_id,actor_id:t?.user_id||null,action_details:{description:"Fee plan accepted via introducer agreement signature",introducer_id:a.introducer_id,agreement_id:r},timestamp:n}))}else t&&console.log("â„¹ï¸ [INTRODUCER AGREEMENT] Fee plan already accepted, skipping update")}let{error:d}=await e.from("tasks").update({status:"completed",completed_at:n}).eq("related_entity_type","signature_request").eq("related_entity_id",t);d?console.warn("âš ï¸ [INTRODUCER AGREEMENT] Failed to complete introducer task:",d):console.log("âœ… [INTRODUCER AGREEMENT] Introducer task marked as completed");let{data:l}=await e.from("introducer_users").select("user_id").eq("introducer_id",a.introducer_id);if(l&&l.length>0){let t=l.map(e=>({user_id:e.user_id,investor_id:null,title:"Introducer Agreement Active",message:"Your introducer agreement is now fully executed and active. You can now receive investor referrals.",link:`/versotech_main/introducer-agreements/${r}`,type:"success"}));await e.from("investor_notifications").insert(t),console.log("âœ… [INTRODUCER AGREEMENT] Notified introducer users of activation")}if(a.arranger_id){let{data:t}=await e.from("arranger_users").select("user_id").eq("arranger_id",a.arranger_id);if(t&&t.length>0){let i=t.map(e=>({user_id:e.user_id,investor_id:null,title:"Introducer Agreement Executed",message:`Introducer agreement with ${o} is now fully executed and active.`,link:"/versotech_main/my-introducers",type:"success"}));await e.from("investor_notifications").insert(i),console.log("âœ… [INTRODUCER AGREEMENT] Notified arranger users")}}let{data:c}=await e.from("profiles").select("id").eq("role","staff_admin").limit(5);if(c&&c.length>0){let t=c.map(e=>({user_id:e.id,investor_id:null,title:"Introducer Agreement Executed",message:`Introducer agreement with ${o} has been fully executed and is now active.`,link:"/versotech_main/staff/introducers",type:"info"}));await e.from("investor_notifications").insert(t),console.log("âœ… [INTRODUCER AGREEMENT] Notified staff users")}await e.from("audit_logs").insert({event_type:"introducer",action:"agreement_activated",entity_type:"introducer_agreement",entity_id:r,actor_id:null,action_details:{description:"Introducer agreement fully executed and activated",introducer_id:a.introducer_id,introducer_name:o,arranger_id:a.arranger_id,agreement_id:r,signature_request_id:t},timestamp:n})}console.log("ðŸŽ‰ [INTRODUCER AGREEMENT] Completion processing finished")}e.s(["POST",()=>N],745785);var I=e.i(745785);let S=new t.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/signature/complete/route",pathname:"/api/signature/complete",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/signature/complete/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:q,workUnitAsyncStorage:O,serverHooks:D}=S;function P(){return(0,r.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:O})}async function U(e,t,r){S.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/signature/complete/route";v=v.replace(/\/index$/,"")||"/";let R=await S.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:h,params:N,nextConfig:w,parsedUrl:y,isDraftMode:A,prerenderManifest:C,routerServerContext:T,isOnDemandRevalidate:b,revalidateOnlyGenerated:I,resolvedPathname:q,clientReferenceManifest:O,serverActionsManifest:D}=R,P=(0,s.normalizeAppPath)(v),U=!!(C.dynamicRoutes[P]||C.routes[q]),k=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,y,!1):t.end("This page could not be found"),null);if(U&&!A){let e=!!C.routes[q],t=C.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await k();throw new f.NoFallbackError}}let M=null;!U||S.isDev||A||(M="/index"===(M=q)?"/":M);let x=!0===S.isDev||!U,$=U&&!x;D&&O&&(0,o.setManifestsSingleton)({page:v,clientReferenceManifest:O,serverActionsManifest:D});let G=e.method||"GET",H=(0,n.getTracer)(),B=H.getActiveScopeSpan(),F={params:N,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:x,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,r,a)=>S.onRequestError(e,t,r,a,T)},sharedContext:{buildId:h}},L=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),j=l.NextRequestAdapter.fromNodeNextRequest(L,(0,l.signalFromNodeResponse)(t));try{let o=async e=>S.handle(j,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=H.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=i.get("next.route");if(r){let t=`${G} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${G} ${v}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),d=async a=>{var n,d;let l=async({previousCacheEntry:i})=>{try{if(!s&&b&&I&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(a);e.fetchMetrics=F.renderOpts.fetchMetrics;let d=F.renderOpts.pendingWaitUntil;d&&r.waitUntil&&(r.waitUntil(d),d=void 0);let l=F.renderOpts.collectedTags;if(!U)return await (0,_.sendResponse)(L,K,n,F.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[p.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=p.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,r=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=p.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:r}}}}catch(t){throw(null==i?void 0:i.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:b})},!1,T),t}},c=await S.handleResponse({req:e,nextConfig:w,cacheKey:M,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:I,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:s});if(!U)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",b?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&U||f.delete(p.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,_.sendResponse)(L,K,new Response(c.value.body,{headers:f,status:c.value.status||200})),null};B?await d(B):await H.withPropagatedContext(e.headers,()=>H.trace(c.BaseServerSpan.handleRequest,{spanName:`${G} ${v}`,kind:n.SpanKind.SERVER,attributes:{"http.method":G,"http.target":e.url}},d))}catch(t){if(t instanceof f.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:b})},!1,T),U)throw t;return await (0,_.sendResponse)(L,K,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>P,"routeModule",()=>S,"serverHooks",()=>D,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>O],23486)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_032210a8.js.map