module.exports=[120635,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},918622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},270406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},193695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},433669,e=>{"use strict";e.i(814247);var t=e.i(150615),r=e.i(12049),a=e.i(57824);let n=async()=>{let e=await (0,a.cookies)();return(0,t.createServerClient)("https://ipguxdssecfexudnvtia.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ3V4ZHNzZWNmZXh1ZG52dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4MzcsImV4cCI6MjA3MzkzNzgzN30.AGxM_YW9hfxuu7xDpi_4xhOoRhYM7iGTS1vJ0z2FByE",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:a})=>{e.set(t,r,a)})}catch(e){}}}})};e.s(["createClient",0,n,"createServiceClient",0,()=>(0,r.createClient)("https://ipguxdssecfexudnvtia.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})])},444879,e=>{"use strict";var t=e.i(779444),r=e.i(698261),a=e.i(821776),n=e.i(796417),i=e.i(856890),s=e.i(26996),o=e.i(436944),l=e.i(88281),d=e.i(765944),c=e.i(984788),u=e.i(237011),p=e.i(712007),h=e.i(777657),g=e.i(13180),m=e.i(273827),f=e.i(193695);e.i(947956);var w=e.i(36217),x=e.i(414131),v=e.i(433669),_=e.i(38896);async function R(){try{let e=await (0,_.getCurrentUser)();if(!e)return x.NextResponse.json({error:"Unauthorized"},{status:401});let t=(0,v.createServiceClient)(),{data:r}=await t.from("staff_permissions").select("permission").eq("user_id",e.id).eq("permission","super_admin").single();if(!r)return x.NextResponse.json({error:"Forbidden"},{status:403});let a=new Date,n=new Date(a.getTime()-6048e5),i=new Date(a.getTime()-2592e6),s=new Date(a.getTime()-7776e6),o=new Date(a.getTime()-10368e6),{data:l}=await t.from("audit_logs").select("actor_id, created_at").gte("created_at",o.toISOString()).not("actor_id","is",null).order("created_at",{ascending:!0}).limit(5e5),d={};(l||[]).forEach(e=>{d[e.actor_id]||(d[e.actor_id]=[]),d[e.actor_id].push(new Date(e.created_at))});let c={};Object.entries(d).forEach(([e,t])=>{let r=t.sort((e,t)=>e.getTime()-t.getTime());c[e]={first:r[0],last:r[r.length-1]}});let u=new Set(Object.entries(c).filter(([,e])=>e.last>=n).map(([e])=>e)),p=new Date(a.getTime()-12096e5),h=Object.entries(c).filter(([,e])=>e.last>=p&&e.last<n),g=h.filter(([e])=>u.has(e)).length,m=h.length>0?Math.round(g/h.length*1e3)/10:0,f=new Date(a.getTime()-5184e6),w=Object.entries(c).filter(([,e])=>e.last>=f&&e.last<i),R=w.filter(([e])=>u.has(e)).length,y=w.length>0?Math.round(R/w.length*1e3)/10:0,C=Object.entries(c).filter(([,e])=>e.last>=o&&e.last<s),b=C.filter(([e])=>u.has(e)).length,k=C.length>0?Math.round(b/C.length*1e3)/10:0,O=Object.keys(c).length,S=Object.entries(c).filter(([,e])=>e.last<i).length,A=O>0?Math.round(S/O*1e3)/10:0,{data:j}=await t.from("profiles").select("id, display_name, email, created_at").not("deleted_at","is",null).is("deleted_at",null).order("created_at",{ascending:!1}),D=j||[],T=[];for(let e=4;e>=0;e--){let t=new Date(a);t.setDate(t.getDate()-(e+1)*7),t.setHours(0,0,0,0);let r=new Date(t);r.setDate(r.getDate()+7);let n=D.filter(e=>{let a=new Date(e.created_at);return a>=t&&a<r});if(0===n.length){T.push({cohort_week:E(t),week_0:0,week_1:0,week_2:0,week_3:0,week_4:0});continue}let i=new Set(n.map(e=>e.id)),s=[];for(let r=0;r<=4;r++){if(e-r<0){s.push(0);continue}let a=new Date(t);a.setDate(a.getDate()+7*r);let o=new Date(a);o.setDate(o.getDate()+7);let l=Object.entries(d).filter(([e,t])=>!!i.has(e)&&t.some(e=>e>=a&&e<o)).length,c=n.length>0?Math.round(l/n.length*100):0;s.push(c)}T.push({cohort_week:E(t),week_0:s[0],week_1:s[1],week_2:s[2],week_3:s[3],week_4:s[4]})}let I=Object.entries(c).filter(([,e])=>e.last<i).map(([e])=>e).slice(0,50),N={};if(I.length>0){let{data:e}=await t.from("profiles").select("id, display_name, email, created_at").in("id",I).is("deleted_at",null);e&&e.forEach(e=>{N[e.id]=e})}let P={};if(I.length>0){let{data:e}=await t.from("investor_users").select("user_id, investor_id").in("user_id",I);e&&e.forEach(e=>{P[e.user_id]||(P[e.user_id]=[]),P[e.user_id].push(e.investor_id)})}let q=[...new Set(Object.values(P).flat())],M={};if(q.length>0){let{data:e}=await t.from("subscriptions").select("investor_id, commitment").in("investor_id",q).in("status",["active","funded","completed"]);e&&e.forEach(e=>{let t=Number(e.commitment)||0;M[e.investor_id]=(M[e.investor_id]||0)+t})}let U=I.filter(e=>N[e]).map(e=>{let t=N[e],r=c[e],a=(P[e]||[]).reduce((e,t)=>e+(M[t]||0),0);return{id:e,name:t.display_name||t.email||"Unknown",email:t.email,lastActive:r.last.toISOString(),totalInvested:a}}).sort((e,t)=>t.totalInvested-e.totalInvested);return x.NextResponse.json({success:!0,data:{retentionRates:{day7:m,day30:y,day90:k},churnRate:A,cohortMatrix:T,atRiskUsers:U}})}catch(e){return console.error("Retention metrics error:",e),x.NextResponse.json({error:"Failed to fetch retention metrics"},{status:500})}}function E(e){let t=e.toLocaleString("en-US",{month:"short"}),r=e.getDate();return`${t} ${r}`}e.s(["GET",()=>R],322700);var y=e.i(322700);let C=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/admin/growth/retention/route",pathname:"/api/admin/growth/retention",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/admin/growth/retention/route.ts",nextConfigOutput:"",userland:y}),{workAsyncStorage:b,workUnitAsyncStorage:k,serverHooks:O}=C;function S(){return(0,a.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:k})}async function A(e,t,a){C.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/admin/growth/retention/route";x=x.replace(/\/index$/,"")||"/";let v=await C.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:_,params:R,nextConfig:E,parsedUrl:y,isDraftMode:b,prerenderManifest:k,routerServerContext:O,isOnDemandRevalidate:S,revalidateOnlyGenerated:A,resolvedPathname:j,clientReferenceManifest:D,serverActionsManifest:T}=v,I=(0,o.normalizeAppPath)(x),N=!!(k.dynamicRoutes[I]||k.routes[j]),P=async()=>((null==O?void 0:O.render404)?await O.render404(e,t,y,!1):t.end("This page could not be found"),null);if(N&&!b){let e=!!k.routes[j],t=k.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await P();throw new f.NoFallbackError}}let q=null;!N||C.isDev||b||(q="/index"===(q=j)?"/":q);let M=!0===C.isDev||!N,U=N&&!M;T&&D&&(0,s.setManifestsSingleton)({page:x,clientReferenceManifest:D,serverActionsManifest:T});let H=e.method||"GET",z=(0,i.getTracer)(),F=z.getActiveScopeSpan(),$={params:R,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>C.onRequestError(e,t,a,n,O)},sharedContext:{buildId:_}},G=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),Z=d.NextRequestAdapter.fromNodeNextRequest(G,(0,d.signalFromNodeResponse)(t));try{let s=async e=>C.handle(Z,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=z.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${x}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&S&&A&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=$.renderOpts.collectedTags;if(!N)return await (0,p.sendResponse)(G,K,i,$.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,a=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:S})},!1,O),t}},c=await C.handleResponse({req:e,nextConfig:E,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:A,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!N)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",S?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&N||f.delete(m.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(G,K,new Response(c.value.body,{headers:f,status:c.value.status||200})),null};F?await l(F):await z.withPropagatedContext(e.headers,()=>z.trace(c.BaseServerSpan.handleRequest,{spanName:`${H} ${x}`,kind:i.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:S})},!1,O),N)throw t;return await (0,p.sendResponse)(G,K,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>S,"routeModule",()=>C,"serverHooks",()=>O,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>k],444879)},261365,e=>{e.v(e=>Promise.resolve().then(()=>e(368899)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__590aaf35._.js.map