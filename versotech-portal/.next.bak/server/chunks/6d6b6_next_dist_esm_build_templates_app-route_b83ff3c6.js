module.exports=[615541,e=>{"use strict";var t=e.i(779444),r=e.i(698261),a=e.i(821776),n=e.i(796417),i=e.i(856890),o=e.i(26996),s=e.i(436944),l=e.i(88281),d=e.i(765944),u=e.i(984788),c=e.i(237011),p=e.i(712007),h=e.i(777657),g=e.i(13180),m=e.i(273827),f=e.i(193695);e.i(947956);var w=e.i(36217),_=e.i(414131),R=e.i(433669),v=e.i(38896);async function E(e){try{let t=await (0,v.getCurrentUser)();if(!t)return _.NextResponse.json({error:"Unauthorized"},{status:401});let r=(0,R.createServiceClient)(),{data:a}=await r.from("staff_permissions").select("permission").eq("user_id",t.id).eq("permission","super_admin").single();if(!a)return _.NextResponse.json({error:"Forbidden"},{status:403});let{searchParams:n}=new URL(e.url),i=n.get("groupBy")||"signup_month",o=["signup_week","signup_month","first_investment_month"].includes(i)?i:"signup_month",{data:s}=await r.from("profiles").select("id, created_at, display_name").is("deleted_at",null).order("created_at",{ascending:!0}),l=s||[],{data:d}=await r.from("investor_users").select("user_id, investor_id"),u={};d?.forEach(e=>{u[e.user_id]||(u[e.user_id]=[]),u[e.user_id].push(e.investor_id)});let{data:c}=await r.from("subscriptions").select("investor_id, commitment, created_at").order("created_at",{ascending:!0}),p={},h={};c?.forEach(e=>{let t=new Date(e.created_at);(!p[e.investor_id]||t<p[e.investor_id])&&(p[e.investor_id]=t);let r=Number(e.commitment)||0;h[e.investor_id]=(h[e.investor_id]||0)+r});let g=new Date,m=new Date(g.getTime()-10368e6),{data:f}=await r.from("audit_logs").select("actor_id, created_at").gte("created_at",m.toISOString()).not("actor_id","is",null).order("created_at",{ascending:!0}).limit(5e5),w={};f?.forEach(e=>{let t=new Date(e.created_at);(!w[e.actor_id]||t>w[e.actor_id])&&(w[e.actor_id]=t)});let E={};"signup_week"===o||"signup_month"===o?l.forEach(e=>{var t;let r,a,n,i=new Date(e.created_at),s="signup_week"===o?(r=(t=i).getFullYear(),a=new Date(r,0,1),n=Math.ceil((Math.floor((t.getTime()-a.getTime())/864e5)+1)/7),`${r}-W${String(n).padStart(2,"0")}`):C(i);E[s]||(E[s]=[]),E[s].push(e)}):l.forEach(e=>{let t=u[e.id]||[],r=null;if(t.forEach(e=>{let t=p[e];t&&(!r||t<r)&&(r=t)}),r){let t=C(r);E[t]||(E[t]=[]),E[t].push(e)}});let x=[];for(let e of Object.keys(E).sort()){let t=E[e],r=t.length;if(0===r)continue;let a=t.filter(e=>e.display_name&&""!==e.display_name.trim()).length,n=Math.round(a/r*1e3)/10,i=0,s=0,l=0,d=0;t.forEach(e=>{let t=u[e.id]||[];if(t.some(e=>p[e])){i++,t.forEach(e=>{s+=h[e]||0});let r=new Date(e.created_at),a=t.reduce((e,t)=>{let r=p[t];return r&&(!e||r<e)?r:e},null);if(null!==a){let e=Math.floor((a.getTime()-r.getTime())/864e5);l+=Math.max(0,e),d++}}});let c=Math.round(i/r*1e3)/10,m=i>0?Math.round(s/i):0,f=d>0?Math.round(l/d):null,_=T(e,o),R=new Date(_.getTime()+2592e6),v=new Date(_.getTime()+5184e6),C=new Date(_.getTime()+7776e6),y=t.filter(e=>{let t=w[e.id];if(!t)return!1;let r=new Date(R.getTime()-6048e5);return t>=r&&t<=R}).length,D=t.filter(e=>{let t=w[e.id];if(!t)return!1;let r=new Date(v.getTime()-6048e5);return t>=r&&t<=v}).length,S=t.filter(e=>{let t=w[e.id];if(!t)return!1;let r=new Date(C.getTime()-6048e5);return t>=r&&t<=C}).length,A=R<=g?Math.round(y/r*1e3)/10:-1,N=v<=g?Math.round(D/r*1e3)/10:-1,b=C<=g?Math.round(S/r*1e3)/10:-1;x.push({cohortName:function(e,t){if("signup_week"===t){let r=T(e,t),a=r.toLocaleString("en-US",{month:"short"}),n=r.getDate(),i=r.getFullYear();return`Week of ${a} ${n}, ${i}`}{let[t,r]=e.split("-");return new Date(parseInt(t),parseInt(r)-1,1).toLocaleString("en-US",{month:"short",year:"numeric"})}}(e,o),size:r,activationRate:n,investmentRate:c,avgInvestment:m,avgTimeToFirstInvestment:f,retention30d:A,retention60d:N,retention90d:b})}return _.NextResponse.json({success:!0,data:{groupBy:o,cohorts:x}})}catch(e){return console.error("Cohorts metrics error:",e),_.NextResponse.json({error:"Failed to fetch cohort metrics"},{status:500})}}function C(e){let t=e.getFullYear(),r=e.getMonth()+1;return`${t}-${String(r).padStart(2,"0")}`}function T(e,t){if("signup_week"===t){let[t,r]=e.split("-W"),a=parseInt(t),n=parseInt(r);return new Date(new Date(a,0,1).getTime()+(n-1)*6048e5)}{let[t,r]=e.split("-");return new Date(parseInt(t),parseInt(r)-1,1)}}e.s(["GET",()=>E],872126);var x=e.i(872126);let y=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/admin/growth/cohorts/route",pathname:"/api/admin/growth/cohorts",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/admin/growth/cohorts/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:D,workUnitAsyncStorage:S,serverHooks:A}=y;function N(){return(0,a.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:S})}async function b(e,t,a){y.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let _="/api/admin/growth/cohorts/route";_=_.replace(/\/index$/,"")||"/";let R=await y.prepare(e,t,{srcPage:_,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:E,nextConfig:C,parsedUrl:T,isDraftMode:x,prerenderManifest:D,routerServerContext:S,isOnDemandRevalidate:A,revalidateOnlyGenerated:N,resolvedPathname:b,clientReferenceManifest:M,serverActionsManifest:O}=R,P=(0,s.normalizeAppPath)(_),I=!!(D.dynamicRoutes[P]||D.routes[b]),U=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,T,!1):t.end("This page could not be found"),null);if(I&&!x){let e=!!D.routes[b],t=D.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await U();throw new f.NoFallbackError}}let k=null;!I||y.isDev||x||(k="/index"===(k=b)?"/":k);let H=!0===y.isDev||!I,q=I&&!H;O&&M&&(0,o.setManifestsSingleton)({page:_,clientReferenceManifest:M,serverActionsManifest:O});let $=e.method||"GET",F=(0,i.getTracer)(),j=F.getActiveScopeSpan(),K={params:E,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>y.onRequestError(e,t,a,n,S)},sharedContext:{buildId:v}},L=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),W=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let o=async e=>y.handle(W,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${$} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${_}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&A&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(n);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=K.renderOpts.collectedTags;if(!I)return await (0,p.sendResponse)(L,B,i,K.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await y.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:A})},!1,S),t}},u=await y.handleResponse({req:e,nextConfig:C,cacheKey:k,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!I)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",A?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&I||f.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(L,B,new Response(u.value.body,{headers:f,status:u.value.status||200})),null};j?await l(j):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${$} ${_}`,kind:i.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await y.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:A})},!1,S),I)throw t;return await (0,p.sendResponse)(L,B,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>N,"routeModule",()=>y,"serverHooks",()=>A,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>S],615541)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_b83ff3c6.js.map