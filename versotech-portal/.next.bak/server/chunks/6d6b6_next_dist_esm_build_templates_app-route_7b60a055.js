module.exports=[593157,e=>{"use strict";var t=e.i(779444),a=e.i(698261),i=e.i(821776),r=e.i(796417),n=e.i(856890),s=e.i(26996),o=e.i(436944),l=e.i(88281),d=e.i(765944),u=e.i(984788),c=e.i(237011),p=e.i(712007),_=e.i(777657),m=e.i(13180),f=e.i(273827),h=e.i(193695);e.i(947956);var g=e.i(36217),v=e.i(433669),y=e.i(414131),w=e.i(107854),b=e.i(221640),R=e.i(911357);async function E(e,{params:t}){try{let e=await (0,v.createClient)(),{id:a}=await t,{data:{user:i},error:r}=await e.auth.getUser();if(r||!i)return y.NextResponse.json({error:"Unauthorized"},{status:401});let{data:n}=await e.from("profiles").select("role").eq("id",i.id).single();if(!n)return y.NextResponse.json({error:"Profile not found"},{status:404});let{data:s,error:o}=await e.from("vehicles").select(`
        *,
        arranger_entity:arranger_entities!vehicles_arranger_entity_id_fkey (
          id,
          legal_name,
          email
        ),
        lawyer:lawyers!vehicles_lawyer_id_fkey (
          id,
          firm_name,
          display_name,
          primary_contact_email
        ),
        managing_partner:profiles!vehicles_managing_partner_id_fkey (
          id,
          display_name,
          email
        )
      `).eq("id",a).single();if(o||!s)return y.NextResponse.json({error:"Entity not found"},{status:404});let[{data:l},{data:d},{data:u},{data:c},{data:p},{data:_},{data:m}]=await Promise.all([e.from("entity_directors").select("*").eq("vehicle_id",a).order("created_at",{ascending:!1}),e.from("entity_stakeholders").select("*").eq("vehicle_id",a).order("created_at",{ascending:!1}),e.from("document_folders").select("id, parent_folder_id, name, path, folder_type, created_at, updated_at").eq("vehicle_id",a).order("path",{ascending:!0}),e.from("entity_flags").select("*").eq("vehicle_id",a).eq("is_resolved",!1).order("severity",{ascending:!0}),e.from("deals").select("id, name, status, deal_type, currency, created_at").eq("vehicle_id",a).order("created_at",{ascending:!1}),e.from("entity_events").select(`
          id,
          event_type,
          description,
          payload,
          created_at,
          changed_by_profile:profiles!entity_events_changed_by_fkey(id, display_name, email)
        `).eq("vehicle_id",a).order("created_at",{ascending:!1}).limit(50),e.from("entity_investors").select(`
          id,
          relationship_role,
          allocation_status,
          invite_sent_at,
          created_at,
          updated_at,
          notes,
          investor:investors (
            id,
            legal_name,
            display_name,
            type,
            email,
            country,
            status,
            onboarding_status,
            aml_risk_rating
          ),
          subscription:subscriptions (
            id,
            commitment,
            currency,
            status,
            effective_date,
            funding_due_at,
            units,
            acknowledgement_notes,
            created_at
          )
        `).eq("vehicle_id",a).order("created_at",{ascending:!1})]),f=!1,h=[];if("investor"===n.role){let{data:t}=await e.from("investor_users").select("investor_id").eq("user_id",i.id);if(t){h=t.map(e=>e.investor_id);let{data:i}=await e.from("subscriptions").select("id").eq("vehicle_id",a).in("investor_id",h).single();f=!!i}}else f=!0;if(!f)return y.NextResponse.json({error:"Access denied to this entity"},{status:403});let{data:g}=await e.from("valuations").select("*").eq("vehicle_id",a).order("as_of_date",{ascending:!1}),{data:w}=await e.from("capital_calls").select("*").eq("vehicle_id",a).order("due_date",{ascending:!1}),{data:b}=await e.from("distributions").select("*").eq("vehicle_id",a).order("date",{ascending:!1}),R=e.from("documents").select("id, type, created_at, created_by").eq("vehicle_id",a);if("investor"===n.role)if(h.length>0){let e=h.join(",");R=R.or(`owner_investor_id.in.(${e}),owner_investor_id.is.null`)}else R=R.is("owner_investor_id",null);let{data:E}=await R.order("created_at",{ascending:!1}),x=null,C=null,q=null;if("investor"===n.role){let{data:t}=await e.from("positions").select("*").eq("vehicle_id",a).in("investor_id",h).single();if(t){let e=g?.[0],a=t.units*(e?.nav_per_unit||t.last_nav||0),i=a-(t.cost_basis||0),r=t.cost_basis>0?i/t.cost_basis*100:0;x={units:t.units,costBasis:t.cost_basis,currentValue:Math.round(a),unrealizedGain:Math.round(i),unrealizedGainPct:Math.round(100*r)/100,lastUpdated:t.as_of_date}}let{data:i}=await e.from("subscriptions").select("*").eq("vehicle_id",a).in("investor_id",h).single();i&&(C={commitment:i.commitment,currency:i.currency,status:i.status,signedDate:i.created_at});let{data:r}=await e.from("cashflows").select("*").eq("vehicle_id",a).in("investor_id",h).order("date",{ascending:!1});if(r){let e=r.filter(e=>"call"===e.type).reduce((e,t)=>e+(t.amount||0),0),t=r.filter(e=>"distribution"===e.type).reduce((e,t)=>e+(t.amount||0),0);q={totalContributions:Math.round(e),totalDistributions:Math.round(t),unfundedCommitment:Math.round(Math.max(0,(C?.commitment||0)-e)),history:r.map(e=>({type:e.type,amount:e.amount,date:e.date,reference:e.ref_id}))}}}return y.NextResponse.json({entity:s,directors:l||[],stakeholders:d||[],folders:u||[],flags:c||[],deals:p||[],investors:m||[],entity_events:_||[],position:x,subscription:C,cashflows:q,valuations:g?.map(e=>({navTotal:e.nav_total,navPerUnit:e.nav_per_unit,asOfDate:e.as_of_date}))||[],capitalCalls:w?.map(e=>({id:e.id,name:e.name,callPct:e.call_pct,dueDate:e.due_date,status:e.status}))||[],distributions:b?.map(e=>({id:e.id,name:e.name,amount:e.amount,date:e.date,classification:e.classification}))||[],documents:E?.map(e=>({id:e.id,type:e.type,createdAt:e.created_at}))||[]})}catch(e){return console.error("Entity detail API error:",e),y.NextResponse.json({error:"Internal server error"},{status:500})}}let x=w.z.object({name:w.z.string().min(1,"Vehicle name is required").optional(),entity_code:w.z.string().optional().nullable(),platform:w.z.string().optional().nullable(),investment_name:w.z.string().optional().nullable(),former_entity:w.z.string().optional().nullable(),status:w.z.enum(["LIVE","CLOSED","TBD"]).optional().nullable(),type:w.z.enum(["fund","spv","securitization","note","venture_capital","private_equity","real_estate","other"]).optional(),domicile:w.z.string().optional().nullable(),currency:w.z.string().length(3,"Currency must be 3 letters").optional(),formation_date:w.z.string().optional().nullable(),legal_jurisdiction:w.z.string().optional().nullable(),registration_number:w.z.string().optional().nullable(),reporting_type:w.z.enum(["Not Required","Company Only","Online only","Company + Online"]).optional().nullable(),requires_reporting:w.z.boolean().optional().nullable(),notes:w.z.string().optional().nullable(),logo_url:w.z.string().url("Logo must be a valid URL").optional().nullable(),website_url:w.z.string().url("Website must be a valid URL").optional().nullable(),address:w.z.string().optional().nullable(),arranger_entity_id:w.z.string().uuid("Arranger must be a valid UUID").optional().nullable(),lawyer_id:w.z.string().uuid("Lawyer must be a valid UUID").optional().nullable(),managing_partner_id:w.z.string().uuid("Managing partner must be a valid UUID").optional().nullable()});async function C(e,{params:t}){try{let a=(0,v.createServiceClient)(),i=await (0,v.createClient)(),{id:r}=await t,{user:n,error:s}=await (0,b.getAuthenticatedUser)(i);if(s||!n)return y.NextResponse.json({error:"Unauthorized"},{status:401});if(!await (0,b.isStaffUser)(a,n))return y.NextResponse.json({error:"Staff access required"},{status:403});let o=await e.json(),l={...o,logo_url:"string"==typeof o.logo_url?o.logo_url.trim()||null:o.logo_url??null,website_url:"string"==typeof o.website_url?o.website_url.trim()||null:o.website_url??null},d=x.parse(l);if(0===Object.keys(d).length)return y.NextResponse.json({error:"No changes provided"},{status:400});let u={...d,currency:d.currency?d.currency.toUpperCase():void 0,legal_jurisdiction:d.legal_jurisdiction?.trim(),registration_number:d.registration_number?.trim(),notes:d.notes?.trim(),logo_url:void 0===d.logo_url?void 0:d.logo_url?.trim()||null,website_url:void 0===d.website_url?void 0:d.website_url?.trim()||null,address:d.address?.trim()||null,arranger_entity_id:d.arranger_entity_id||null,lawyer_id:d.lawyer_id||null,managing_partner_id:d.managing_partner_id||null},{data:c,error:p}=await a.from("vehicles").update(u).eq("id",r).select("*").single();if(p||!c)return console.error("Entity update error:",p),y.NextResponse.json({error:"Failed to update entity",details:p?.message},{status:500});return await R.auditLogger.log({actor_user_id:n.id,action:R.AuditActions.UPDATE,entity:R.AuditEntities.VEHICLES,entity_id:c.id,metadata:{endpoint:`/api/entities/${r}`,...d}}),await a.from("entity_events").insert({vehicle_id:r,event_type:"entity_updated",description:`Entity updated: ${Object.keys(d).join(", ")}`,changed_by:n.id}),y.NextResponse.json({entity:c})}catch(e){if(e instanceof w.z.ZodError)return y.NextResponse.json({error:"Invalid input",details:e.issues},{status:400});return console.error("Entity update API error:",e),y.NextResponse.json({error:"Internal server error"},{status:500})}}async function q(e,{params:t}){try{let e=(0,v.createServiceClient)(),a=await (0,v.createClient)(),{id:i}=await t,{user:r,error:n}=await (0,b.getAuthenticatedUser)(a);if(n||!r)return y.NextResponse.json({error:"Unauthorized"},{status:401});if(!await (0,b.isStaffUser)(e,r))return y.NextResponse.json({error:"Staff access required"},{status:403});let[{data:s,count:o},{data:l,count:d},{data:u,count:c},{data:p,count:_},{data:m,count:f},{data:h,count:g},{data:w,count:E},{data:x,count:C}]=await Promise.all([e.from("entity_directors").select("*",{count:"exact",head:!0}).eq("vehicle_id",i),e.from("entity_stakeholders").select("*",{count:"exact",head:!0}).eq("vehicle_id",i),e.from("entity_investors").select("*",{count:"exact",head:!0}).eq("vehicle_id",i),e.from("documents").select("*",{count:"exact",head:!0}).eq("vehicle_id",i),e.from("document_folders").select("*",{count:"exact",head:!0}).eq("vehicle_id",i),e.from("deals").select("*",{count:"exact",head:!0}).eq("vehicle_id",i),e.from("subscriptions").select("*",{count:"exact",head:!0}).eq("vehicle_id",i),e.from("valuations").select("*",{count:"exact",head:!0}).eq("vehicle_id",i)]),q={directors:o||0,stakeholders:d||0,investors:c||0,documents:_||0,folders:f||0,deals:g||0,subscriptions:E||0,valuations:C||0},N=Object.values(q).some(e=>e>0),{data:A}=await e.from("vehicles").select("name").eq("id",i).single();if(N)return y.NextResponse.json({error:"Cannot delete entity with dependencies",dependencies:q,entityName:A?.name||"Unknown"},{status:409});let{error:U}=await e.from("vehicles").delete().eq("id",i);if(U)return console.error("Entity delete error:",U),y.NextResponse.json({error:"Failed to delete entity",details:U.message},{status:500});return await R.auditLogger.log({actor_user_id:r.id,action:R.AuditActions.DELETE,entity:R.AuditEntities.VEHICLES,entity_id:i,metadata:{endpoint:`/api/entities/${i}`,entity_name:A?.name}}),y.NextResponse.json({success:!0,entityName:A?.name})}catch(e){return console.error("Entity delete API error:",e),y.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["DELETE",()=>q,"GET",()=>E,"PATCH",()=>C],829330);var N=e.i(829330);let A=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/entities/[id]/route",pathname:"/api/entities/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/entities/[id]/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:U,workUnitAsyncStorage:j,serverHooks:P}=A;function T(){return(0,i.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:j})}async function z(e,t,i){A.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/entities/[id]/route";v=v.replace(/\/index$/,"")||"/";let y=await A.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:w,params:b,nextConfig:R,parsedUrl:E,isDraftMode:x,prerenderManifest:C,routerServerContext:q,isOnDemandRevalidate:N,revalidateOnlyGenerated:U,resolvedPathname:j,clientReferenceManifest:P,serverActionsManifest:T}=y,z=(0,o.normalizeAppPath)(v),O=!!(C.dynamicRoutes[z]||C.routes[j]),I=async()=>((null==q?void 0:q.render404)?await q.render404(e,t,E,!1):t.end("This page could not be found"),null);if(O&&!x){let e=!!C.routes[j],t=C.dynamicRoutes[z];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await I();throw new h.NoFallbackError}}let S=null;!O||A.isDev||x||(S="/index"===(S=j)?"/":S);let k=!0===A.isDev||!O,D=O&&!k;T&&P&&(0,s.setManifestsSingleton)({page:v,clientReferenceManifest:P,serverActionsManifest:T});let H=e.method||"GET",M=(0,n.getTracer)(),L=M.getActiveScopeSpan(),$={params:b,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i,r)=>A.onRequestError(e,t,i,r,q)},sharedContext:{buildId:w}},F=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),V=d.NextRequestAdapter.fromNodeNextRequest(F,(0,d.signalFromNodeResponse)(t));try{let s=async e=>A.handle(V,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=M.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${H} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${v}`)}),o=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var n,l;let d=async({previousCacheEntry:a})=>{try{if(!o&&N&&U&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(r);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let d=$.renderOpts.collectedTags;if(!O)return await (0,p.sendResponse)(F,K,n,$.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,i=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==a?void 0:a.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:N})},!1,q),t}},u=await A.handleResponse({req:e,nextConfig:R,cacheKey:S,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:U,responseGenerator:d,waitUntil:i.waitUntil,isMinimalMode:o});if(!O)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,_.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&O||h.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(F,K,new Response(u.value.body,{headers:h,status:u.value.status||200})),null};L?await l(L):await M.withPropagatedContext(e.headers,()=>M.trace(u.BaseServerSpan.handleRequest,{spanName:`${H} ${v}`,kind:n.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:z,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:N})},!1,q),O)throw t;return await (0,p.sendResponse)(F,K,new Response(null,{status:500})),null}}e.s(["handler",()=>z,"patchFetch",()=>T,"routeModule",()=>A,"serverHooks",()=>P,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>j],593157)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_7b60a055.js.map