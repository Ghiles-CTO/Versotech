module.exports=[306048,e=>{"use strict";var t=e.i(779444),a=e.i(698261),i=e.i(821776),n=e.i(796417),r=e.i(856890),s=e.i(26996),o=e.i(436944),d=e.i(88281),l=e.i(765944),_=e.i(984788),u=e.i(237011),c=e.i(712007),p=e.i(777657),m=e.i(13180),g=e.i(273827),f=e.i(193695);e.i(947956);var v=e.i(36217),h=e.i(433669),w=e.i(414131);async function y(e,{params:t}){console.log("ðŸ”´ [opportunities/[id]] GET handler called");let{id:a}=await t;console.log("ðŸ”´ [opportunities/[id]] dealId:",a);let i=await (0,h.createClient)(),n=(0,h.createServiceClient)(),r=new URL(e.url).searchParams.get("client_investor_id");try{let{data:{user:e},error:t}=await i.auth.getUser();if(t||!e)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{data:s}=await n.from("deal_memberships").select("*").eq("deal_id",a).eq("user_id",e.id).maybeSingle(),{data:o}=await n.from("investor_users").select("investor_id").eq("user_id",e.id),d=o?.[0]?.investor_id||null,l=s?.investor_id||d,_=!1,u=null;if(r&&s?.role==="commercial_partner_proxy"){let{data:t}=await n.from("commercial_partner_users").select("commercial_partner_id").eq("user_id",e.id).maybeSingle();if(t){let{data:e}=await n.from("commercial_partner_clients").select("id, client_name, client_investor_id").eq("commercial_partner_id",t.commercial_partner_id).eq("client_investor_id",r).eq("is_active",!0).maybeSingle();if(!e)return w.NextResponse.json({error:"Client not authorized for this commercial partner"},{status:403});l=r,_=!0,u=e.client_name,console.log("ðŸ”µ [opportunities/[id]] MODE 2: Viewing as proxy for client:",u)}}let{data:c,error:p}=await n.from("deals").select("*").eq("id",a).single();if(p||!c)return console.error("[GET opportunity] Deal query failed:",{dealId:a,dealError:p,deal:c}),w.NextResponse.json({error:"Deal not found"},{status:404});console.log("ðŸ”µ [opportunities/[id]] Deal fetched:",{requestedId:a,returnedId:c.id,returnedName:c.name,match:a===c.id});let m=null;if(c.vehicle_id){let{data:e}=await n.from("vehicles").select("id, name, type, formation_date, currency").eq("id",c.vehicle_id).single();m=e}let g="open"===c.status||"allocation_pending"===c.status;if(!s&&!g)return w.NextResponse.json({error:"You do not have access to this opportunity"},{status:403});let{data:f}=await n.from("deal_data_room_access").select("*").eq("deal_id",a).eq("investor_id",l).is("revoked_at",null).order("granted_at",{ascending:!1}).limit(1).maybeSingle();c.vehicle_id;let v=null,h=null,y=null;if(a){let{data:e}=await n.from("subscriptions").select(`
          id,
          status,
          commitment,
          currency,
          funded_amount,
          pack_generated_at,
          pack_sent_at,
          signed_at,
          funded_at,
          activated_at,
          created_at
        `).eq("deal_id",a).eq("investor_id",l).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(v=e,e){let{data:t}=await n.from("signature_requests").select("id, signer_name, signer_email, status, signature_timestamp, unsigned_pdf_path, signed_pdf_path").eq("deal_id",a).eq("investor_id",l).eq("document_type","nda").order("created_at",{ascending:!0}),{data:i}=await n.from("signature_requests").select("id, signer_name, signer_email, status, signature_timestamp, unsigned_pdf_path, signed_pdf_path").eq("subscription_id",e.id).eq("document_type","subscription").order("created_at",{ascending:!0}),r=t||[],s=r.length>0&&r.every(e=>"signed"===e.status),o=r.some(e=>"signed"===e.status),d=s?"complete":o?"partial":r.length>0?"pending":"not_started",_=i||[],u=_.length>0&&_.every(e=>"signed"===e.status),c=_.some(e=>"signed"===e.status),p=u?"complete":c?"partial":_.length>0?"pending":"not_started",m=r.find(e=>e.unsigned_pdf_path)?.unsigned_pdf_path||null,g=s?r.find(e=>e.signed_pdf_path)?.signed_pdf_path:null,f=_.find(e=>e.unsigned_pdf_path)?.unsigned_pdf_path||null,v=u?_.find(e=>e.signed_pdf_path)?.signed_pdf_path:null;y={nda:{status:d,signatories:r.map(e=>({name:e.signer_name,email:e.signer_email,status:e.status,signed_at:e.signature_timestamp})),unsigned_url:m,signed_url:g},subscription_pack:{status:p,signatories:_.map(e=>({name:e.signer_name,email:e.signer_email,status:e.status,signed_at:e.signature_timestamp})),unsigned_url:f,signed_url:v},certificate:await (async()=>{if(!e.activated_at)return null;let{data:t}=await n.from("documents").select("id, file_key").eq("subscription_id",e.id).eq("type","certificate").maybeSingle();return t?{status:"available",document_id:t.id,url:t.file_key}:{status:"generating",document_id:null,url:null}})()}}}if(l){let{data:e}=await n.from("deal_subscription_submissions").select("id, status, submitted_at").eq("deal_id",a).eq("investor_id",l).order("submitted_at",{ascending:!1}).limit(1).maybeSingle();h=e??null}let{data:R}=await n.rpc("get_investor_journey_stage",{p_deal_id:a,p_investor_id:l}),x=s?.role==="introducer"||s?.role==="lawyer",q=[];if(!x){if(s?.term_sheet_id){let{data:e}=await n.from("deal_fee_structures").select("*").eq("id",s.term_sheet_id).single();e&&(q=[e])}if(0===q.length){let{data:e}=await n.from("deal_fee_structures").select("*").eq("deal_id",a).eq("status","published").order("created_at",{ascending:!0}).limit(1);q=e||[]}}let{data:b}=await n.from("deal_faqs").select("*").eq("deal_id",a).order("display_order",{ascending:!0}),{data:E}=await n.from("investor_members").select("id").eq("investor_id",l).eq("role","authorized_signatory").eq("is_active",!0),S=!0;if(E&&E.length>0){let{data:e}=await n.from("signature_requests").select("member_id").eq("deal_id",a).eq("investor_id",l).eq("document_type","nda").not("signature_timestamp","is",null),t=new Set((e||[]).map(e=>e.member_id));S=E.every(e=>t.has(e.id))}let k=s?.role==="introducer"||s?.role==="lawyer",C=s?.role==="arranger",N=[],A=!1;if(k)A=!1;else if(C)A=!0;else{let e=f&&!f.revoked_at&&(!f.expires_at||new Date(f.expires_at)>new Date);A=s?.data_room_granted_at&&e||S&&e}if(A){let{data:e}=await n.from("deal_data_room_documents").select(`
          id,
          deal_id,
          file_name,
          file_key,
          folder,
          file_size_bytes,
          mime_type,
          document_notes,
          created_at,
          document_expires_at,
          is_featured,
          external_link
        `).eq("deal_id",a).eq("visible_to_investors",!0).order("folder",{ascending:!0}).order("file_name",{ascending:!0}),t=new Date;N=(e||[]).filter(e=>!e.document_expires_at||new Date(e.document_expires_at)>t).map(e=>({id:e.id,file_name:e.file_name||"Document",file_type:e.mime_type||"application/octet-stream",file_size:e.file_size_bytes?Number(e.file_size_bytes):0,category:e.folder||"General",description:e.document_notes||null,uploaded_at:e.created_at,is_featured:e.is_featured||!1,external_link:e.external_link||null,file_key:e.file_key||null}))}let{data:D}=await n.from("investor_members").select("id, full_name, email, role").eq("investor_id",l).eq("role","authorized_signatory").eq("is_active",!0),O=0;v?.activated_at?O=10:v?.funded_at?O=9:v?.signed_at?O=8:v?.pack_sent_at?O=7:v?.pack_generated_at?O=6:s?.data_room_granted_at?O=5:s?.nda_signed_at?O=4:s?.interest_confirmed_at?O=3:s?.viewed_at?O=2:s?.dispatched_at&&(O=1);let T=h?.status==="pending_review",I={id:c.id,name:c.name,description:c.description,investment_thesis:c.investment_thesis,status:c.status,deal_type:c.deal_type,currency:c.currency||"USD",minimum_investment:c.minimum_investment,maximum_investment:c.maximum_investment,target_amount:c.target_amount,raised_amount:c.raised_amount,offer_unit_price:c.offer_unit_price,open_at:c.open_at,close_at:c.close_at,company_name:c.company_name,company_logo_url:c.company_logo_url,company_website:c.company_website,sector:c.sector,stage:c.stage,location:c.location,stock_type:c.stock_type,deal_round:c.deal_round,vehicle:m,has_membership:!!s,membership:s?{role:s.role,dispatched_at:s.dispatched_at,viewed_at:s.viewed_at,interest_confirmed_at:s.interest_confirmed_at,nda_signed_at:s.nda_signed_at,data_room_granted_at:s.data_room_granted_at}:null,journey:{current_stage:O,stages:R||[],summary:{received:s?.dispatched_at||null,viewed:s?.viewed_at||null,interest_confirmed:s?.interest_confirmed_at||null,nda_signed:s?.nda_signed_at||null,data_room_access:s?.data_room_granted_at||null,pack_generated:v?.pack_generated_at||null,pack_sent:v?.pack_sent_at||null,signed:v?.signed_at||null,funded:v?.funded_at||null,active:v?.activated_at||null}},data_room:{has_access:A,access_details:f?{granted_at:f.granted_at,expires_at:f.expires_at,auto_granted:f.auto_granted}:null,documents:N,requires_nda:!S,nda_status:{all_signed:S,total_signatories:E?.length||0,message:E&&E.length>0&&!S?`All ${E.length} authorized signatories must sign the NDA to unlock the data room`:null}},subscription:v?{id:v.id,status:v.status,commitment:v.commitment,currency:v.currency||c.currency||"USD",funded_amount:v.funded_amount,pack_generated_at:v.pack_generated_at,pack_sent_at:v.pack_sent_at,signed_at:v.signed_at,funded_at:v.funded_at,activated_at:v.activated_at,created_at:v.created_at,is_signed:!!v.signed_at,is_funded:!!v.funded_at,is_active:!!v.activated_at,documents:y}:null,subscription_submission:h,fee_structures:q||[],faqs:b||[],signatories:D||[],can_express_interest:null!==l&&!s?.interest_confirmed_at,can_sign_nda:!!s?.interest_confirmed_at&&!s?.nda_signed_at,can_access_data_room:A,can_subscribe:null!==l&&!v&&!T&&g&&(!s?.role||["investor","partner_investor","introducer_investor","commercial_partner_investor","co_investor"].includes(s.role)),is_tracking_only:!!s?.role&&!["investor","partner_investor","introducer_investor","commercial_partner_investor","co_investor"].includes(s.role),can_sign_subscription:v?.pack_sent_at&&!v?.signed_at,proxy_mode:_?{is_proxy:!0,client_name:u,client_investor_id:r}:null,can_use_proxy_mode:s?.role==="commercial_partner_proxy",access_controls:{can_view_term_sheet:!x,can_view_data_room:!k,has_auto_data_room_access:C,restriction_reason:x||k?`As ${s?.role==="introducer"?"an introducer":"a lawyer"}, you do not have access to ${x&&k?"the term sheet or data room":x?"the term sheet":"the data room"} for this deal.`:null}};return w.NextResponse.json({opportunity:I})}catch(e){return console.error("Unexpected error in GET /api/investors/me/opportunities/:id:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}async function R(e,{params:t}){let{id:a}=await t,i=await (0,h.createClient)(),n=(0,h.createServiceClient)();try{let{data:{user:t},error:r}=await i.auth.getUser();if(r||!t)return w.NextResponse.json({error:"Unauthorized"},{status:401});let s=(await e.json()).action;if(!["view","express_interest"].includes(s))return w.NextResponse.json({error:"Invalid action"},{status:400});let{data:o}=await n.from("investor_users").select("investor_id").eq("user_id",t.id);if(!o||0===o.length)return w.NextResponse.json({error:"No investor profile found"},{status:404});let d=o[0].investor_id,{data:l}=await n.from("deal_memberships").select("*").eq("deal_id",a).eq("user_id",t.id).single();if("view"===s)return l?l.viewed_at||await n.from("deal_memberships").update({viewed_at:new Date().toISOString()}).eq("deal_id",a).eq("user_id",t.id):await n.from("deal_memberships").insert({deal_id:a,user_id:t.id,investor_id:d,role:"investor",viewed_at:new Date().toISOString()}),w.NextResponse.json({success:!0,action:"viewed"});if("express_interest"===s)return l?l.interest_confirmed_at||await n.from("deal_memberships").update({interest_confirmed_at:new Date().toISOString(),viewed_at:l.viewed_at||new Date().toISOString()}).eq("deal_id",a).eq("user_id",t.id):await n.from("deal_memberships").insert({deal_id:a,user_id:t.id,investor_id:d,role:"investor",viewed_at:new Date().toISOString(),interest_confirmed_at:new Date().toISOString()}),w.NextResponse.json({success:!0,action:"interest_expressed"});return w.NextResponse.json({error:"Unknown action"},{status:400})}catch(e){return console.error("Unexpected error in POST /api/investors/me/opportunities/:id:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>y,"POST",()=>R],358211);var x=e.i(358211);let q=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/investors/me/opportunities/[id]/route",pathname:"/api/investors/me/opportunities/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/investors/me/opportunities/[id]/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:b,workUnitAsyncStorage:E,serverHooks:S}=q;function k(){return(0,i.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:E})}async function C(e,t,i){q.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let h="/api/investors/me/opportunities/[id]/route";h=h.replace(/\/index$/,"")||"/";let w=await q.prepare(e,t,{srcPage:h,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:y,params:R,nextConfig:x,parsedUrl:b,isDraftMode:E,prerenderManifest:S,routerServerContext:k,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,resolvedPathname:A,clientReferenceManifest:D,serverActionsManifest:O}=w,T=(0,o.normalizeAppPath)(h),I=!!(S.dynamicRoutes[T]||S.routes[A]),P=async()=>((null==k?void 0:k.render404)?await k.render404(e,t,b,!1):t.end("This page could not be found"),null);if(I&&!E){let e=!!S.routes[A],t=S.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await P();throw new f.NoFallbackError}}let U=null;!I||q.isDev||E||(U="/index"===(U=A)?"/":U);let j=!0===q.isDev||!I,H=I&&!j;O&&D&&(0,s.setManifestsSingleton)({page:h,clientReferenceManifest:D,serverActionsManifest:O});let M=e.method||"GET",$=(0,r.getTracer)(),z=$.getActiveScopeSpan(),F={params:R,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i,n)=>q.onRequestError(e,t,i,n,k)},sharedContext:{buildId:y}},G=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),L=l.NextRequestAdapter.fromNodeNextRequest(G,(0,l.signalFromNodeResponse)(t));try{let s=async e=>q.handle(L,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=$.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==_.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${M} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${h}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),d=async n=>{var r,d;let l=async({previousCacheEntry:a})=>{try{if(!o&&C&&N&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await s(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let d=F.renderOpts.pendingWaitUntil;d&&i.waitUntil&&(i.waitUntil(d),d=void 0);let l=F.renderOpts.collectedTags;if(!I)return await (0,c.sendResponse)(G,K,r,F.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(r.headers);l&&(t[g.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,i=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==a?void 0:a.isStale)&&await q.onRequestError(e,t,{routerKind:"App Router",routePath:h,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})},!1,k),t}},_=await q.handleResponse({req:e,nextConfig:x,cacheKey:U,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,responseGenerator:l,waitUntil:i.waitUntil,isMinimalMode:o});if(!I)return null;if((null==_||null==(r=_.value)?void 0:r.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==_||null==(d=_.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":_.isMiss?"MISS":_.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,p.fromNodeOutgoingHttpHeaders)(_.value.headers);return o&&I||f.delete(g.NEXT_CACHE_TAGS_HEADER),!_.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,m.getCacheControlHeader)(_.cacheControl)),await (0,c.sendResponse)(G,K,new Response(_.value.body,{headers:f,status:_.value.status||200})),null};z?await d(z):await $.withPropagatedContext(e.headers,()=>$.trace(_.BaseServerSpan.handleRequest,{spanName:`${M} ${h}`,kind:r.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},d))}catch(t){if(t instanceof f.NoFallbackError||await q.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})},!1,k),I)throw t;return await (0,c.sendResponse)(G,K,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>k,"routeModule",()=>q,"serverHooks",()=>S,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>E],306048)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_9bf123b9.js.map