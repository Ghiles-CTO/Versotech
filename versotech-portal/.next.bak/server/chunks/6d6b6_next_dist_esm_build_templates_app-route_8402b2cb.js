module.exports=[265849,e=>{"use strict";var t=e.i(779444),r=e.i(698261),a=e.i(821776),n=e.i(796417),s=e.i(856890),i=e.i(26996),o=e.i(436944),l=e.i(88281),d=e.i(765944),u=e.i(984788),c=e.i(237011),p=e.i(712007),f=e.i(777657),m=e.i(13180),_=e.i(273827),h=e.i(193695);e.i(947956);var g=e.i(36217),y=e.i(414131),w=e.i(433669),R=e.i(911357);async function E(e,t,r,a){let{data:n,error:s}=await e.rpc("get_user_personas",{p_user_id:t});if(console.log("ðŸ” [TERMSHEET ACCESS] userId:",t),console.log("ðŸ” [TERMSHEET ACCESS] personas:",JSON.stringify(n)),console.log("ðŸ” [TERMSHEET ACCESS] personaError:",s),s||!n||0===n.length)return console.log("ðŸ” [TERMSHEET ACCESS] No personas found, denying access"),{allowed:!1,reason:"No personas found"};let i=n.some(e=>"staff"===e.persona_type),o=n.some(e=>"ceo"===e.persona_type),l=n.find(e=>"investor"===e.persona_type),d=n.find(e=>"partner"===e.persona_type),u=n.find(e=>"commercial_partner"===e.persona_type),c=n.find(e=>"arranger"===e.persona_type);if(console.log("ðŸ” [TERMSHEET ACCESS] isStaff:",i,"isCeo:",o),i||o)return console.log("ðŸ” [TERMSHEET ACCESS] Granting access - staff/ceo"),{allowed:!0};let{data:p}=await e.from("deal_fee_structures").select("status").eq("id",a).eq("deal_id",r).single();if(!p||"published"!==p.status)return{allowed:!1,reason:"Term sheet not published"};if(l){let{data:t}=await e.from("deal_memberships").select("deal_id").eq("deal_id",r).eq("investor_id",l.entity_id).maybeSingle();if(t)return{allowed:!0}}if(d){let{data:t}=await e.from("fee_plans").select("id").eq("deal_id",r).eq("partner_id",d.entity_id).maybeSingle();if(t)return{allowed:!0};let{data:a}=await e.from("deal_memberships").select("deal_id").eq("deal_id",r).eq("referred_by_entity_type","partner").eq("referred_by_entity_id",d.entity_id).limit(1).maybeSingle();if(a)return{allowed:!0}}if(u){let{data:t}=await e.from("fee_plans").select("id").eq("deal_id",r).eq("commercial_partner_id",u.entity_id).maybeSingle();if(t)return{allowed:!0};let{data:a}=await e.from("deal_memberships").select("deal_id").eq("deal_id",r).eq("referred_by_entity_type","commercial_partner").eq("referred_by_entity_id",u.entity_id).limit(1).maybeSingle();if(a)return{allowed:!0}}if(c){let{data:t}=await e.from("deals").select("vehicle_id").eq("id",r).single();if(t?.vehicle_id){let{data:r}=await e.from("vehicles").select("arranger_entity_id").eq("id",t.vehicle_id).single();if(r?.arranger_entity_id===c.entity_id)return{allowed:!0}}}return{allowed:!1,reason:"Access denied"}}async function v(e,{params:t}){let{id:r,structureId:a}=await t,n=await (0,w.createClient)(),{data:{user:s},error:i}=await n.auth.getUser();if(i||!s)return y.NextResponse.json({error:"Unauthorized"},{status:401});let o=(0,w.createServiceClient)(),l=await E(o,s.id,r,a);if(!l.allowed)return y.NextResponse.json({error:l.reason||"Access denied"},{status:403});let{data:d,error:u}=await o.from("deal_fee_structures").select("term_sheet_attachment_key").eq("deal_id",r).eq("id",a).single();if(u||!d)return y.NextResponse.json({error:"Term sheet not found"},{status:404});if(!d.term_sheet_attachment_key)return y.NextResponse.json({error:"No attachment uploaded"},{status:404});let{data:c,error:p}=await o.storage.from("deal-documents").createSignedUrl(d.term_sheet_attachment_key,3600);return p||!c?.signedUrl?(console.error("Failed to create signed URL:",p),y.NextResponse.json({error:"Failed to generate preview URL"},{status:500})):y.NextResponse.json({url:c.signedUrl,key:d.term_sheet_attachment_key})}let C=new Set(["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/msword"]);async function S(e,{params:t}){let{id:r,structureId:a}=await t,n=await (0,w.createClient)(),{data:{user:s},error:i}=await n.auth.getUser();if(i||!s)return y.NextResponse.json({error:"Unauthorized"},{status:401});let{data:o}=await n.from("profiles").select("role").eq("id",s.id).single();if(!(o?.role?.startsWith("staff_")||o?.role==="ceo"))return y.NextResponse.json({error:"Staff access required"},{status:403});let l=(await e.formData()).get("file");if(!l)return y.NextResponse.json({error:"File is required"},{status:400});if(!C.has(l.type))return y.NextResponse.json({error:"Unsupported file type. Upload a PDF or DOCX term sheet."},{status:400});let d=(0,w.createServiceClient)(),{data:u,error:c}=await d.from("deal_fee_structures").select("term_sheet_attachment_key").eq("deal_id",r).eq("id",a).single();if(c||!u)return y.NextResponse.json({error:"Term sheet not found"},{status:404});let p="deal-documents",f=Date.now(),m=l.name.replace(/[^a-zA-Z0-9.-]/g,"_"),_=`term-sheets/${r}/${a}/${f}-${m}`;try{let e=await l.arrayBuffer(),t=Buffer.from(e),{error:n}=await d.storage.from(p).upload(_,t,{contentType:l.type,upsert:!1});if(n)return console.error("Failed to upload term sheet attachment",n),y.NextResponse.json({error:"Failed to upload term sheet attachment"},{status:500});let{error:i}=await d.from("deal_fee_structures").update({term_sheet_attachment_key:_,updated_at:new Date().toISOString()}).eq("id",a).eq("deal_id",r);if(i)return console.error("Failed to update deal_fee_structures with attachment",i),await d.storage.from(p).remove([_]),y.NextResponse.json({error:"Failed to update term sheet record"},{status:500});return u.term_sheet_attachment_key&&u.term_sheet_attachment_key!==_&&await d.storage.from(p).remove([u.term_sheet_attachment_key]),await R.auditLogger.log({actor_user_id:s.id,action:R.AuditActions.UPDATE,entity:R.AuditEntities.DEALS,entity_id:a,metadata:{type:"term_sheet_attachment_uploaded",deal_id:r,storage_key:_,file_name:l.name,file_size:l.size}}),y.NextResponse.json({success:!0,term_sheet_attachment_key:_})}catch(e){return console.error("Unexpected error uploading term sheet attachment",e),y.NextResponse.json({error:"Unexpected error uploading term sheet attachment"},{status:500})}}e.s(["GET",()=>v,"POST",()=>S,"dynamic",0,"force-dynamic"],352314);var x=e.i(352314);let A=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/deals/[id]/fee-structures/[structureId]/attachment/route",pathname:"/api/deals/[id]/fee-structures/[structureId]/attachment",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/deals/[id]/fee-structures/[structureId]/attachment/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:T,workUnitAsyncStorage:N,serverHooks:q}=A;function b(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:N})}async function U(e,t,a){A.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/deals/[id]/fee-structures/[structureId]/attachment/route";y=y.replace(/\/index$/,"")||"/";let w=await A.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:E,nextConfig:v,parsedUrl:C,isDraftMode:S,prerenderManifest:x,routerServerContext:T,isOnDemandRevalidate:N,revalidateOnlyGenerated:q,resolvedPathname:b,clientReferenceManifest:U,serverActionsManifest:P}=w,k=(0,o.normalizeAppPath)(y),O=!!(x.dynamicRoutes[k]||x.routes[b]),H=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,C,!1):t.end("This page could not be found"),null);if(O&&!S){let e=!!x.routes[b],t=x.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await H();throw new h.NoFallbackError}}let j=null;!O||A.isDev||S||(j="/index"===(j=b)?"/":j);let I=!0===A.isDev||!O,D=O&&!I;P&&U&&(0,i.setManifestsSingleton)({page:y,clientReferenceManifest:U,serverActionsManifest:P});let M=e.method||"GET",F=(0,s.getTracer)(),$=F.getActiveScopeSpan(),L={params:E,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:I,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>A.onRequestError(e,t,a,n,T)},sharedContext:{buildId:R}},K=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),z=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let i=async e=>A.handle(z,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${M} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${y}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var s,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&N&&q&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(n);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!O)return await (0,p.sendResponse)(K,B,s,L.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[_.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:N})},!1,T),t}},u=await A.handleResponse({req:e,nextConfig:v,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:q,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!O)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&O||h.delete(_.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(K,B,new Response(u.value.body,{headers:h,status:u.value.status||200})),null};$?await l($):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${M} ${y}`,kind:s.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:N})},!1,T),O)throw t;return await (0,p.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>b,"routeModule",()=>A,"serverHooks",()=>q,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>N],265849)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_8402b2cb.js.map