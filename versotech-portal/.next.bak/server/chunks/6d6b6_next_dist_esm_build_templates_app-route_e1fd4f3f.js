module.exports=[310412,e=>{"use strict";var t=e.i(779444),r=e.i(698261),i=e.i(821776),a=e.i(796417),n=e.i(856890),s=e.i(26996),o=e.i(436944),l=e.i(88281),d=e.i(765944),c=e.i(984788),_=e.i(237011),u=e.i(712007),p=e.i(777657),m=e.i(13180),f=e.i(273827),g=e.i(193695);e.i(947956);var y=e.i(36217),v=e.i(433669),b=e.i(38896),h=e.i(911357),w=e.i(414131),S=e.i(751966),q=e.i(964832),$=e.i(400589),I=e.i(898451),k=e.i(821275),D=e.i(66044),N=e.i(254799);async function C({supabase:e,subscriptionId:t,investorId:r,vehicleId:i,commitment:a,fundedAmount:n,shares:s,pricePerShare:o,profile:l}){try{let{data:d,error:c}=await e.from("subscriptions").select(`
        id,
        status,
        activated_at,
        subscription_number,
        units,
        num_shares,
        deal_id,
        investor:investors!subscriptions_investor_id_fkey (
          id,
          legal_name,
          type,
          first_name,
          last_name
        ),
        vehicle:vehicles!subscriptions_vehicle_id_fkey (
          id,
          name,
          series_number,
          registration_number,
          logo_url,
          address
        ),
        deal:deals!subscriptions_deal_id_fkey (
          id,
          name,
          company_name,
          close_at,
          vehicle_id
        )
      `).eq("id",t).single();if(c||!d)return void console.error(`‚ùå Subscription ${t} not found:`,c);let{data:_}=await e.from("documents").select("id").eq("subscription_id",t).eq("type","certificate").limit(1).maybeSingle();if(_)return void console.log(`‚ÑπÔ∏è Certificate already exists for subscription ${t} (doc: ${_.id}), skipping`);if(!["active","funded"].includes(d.status))return void console.warn(`‚ö†Ô∏è Cannot trigger certificate for subscription ${t} - status is '${d.status}', expected 'active' or 'funded'`);let u=d.vehicle,p=d.deal;if(!u&&p?.vehicle_id){let{data:t}=await e.from("vehicles").select("id, name, series_number, registration_number, logo_url, address").eq("id",p.vehicle_id).single();u=t}if(!u)return void console.error(`‚ùå No vehicle found for subscription ${t}`);let m="",f=null;if(d.deal_id){let{data:t}=await e.from("deal_memberships").select("term_sheet_id").eq("deal_id",d.deal_id).eq("investor_id",r).maybeSingle();if(t?.term_sheet_id){let{data:r}=await e.from("deal_fee_structures").select("structure, completion_date").eq("id",t.term_sheet_id).single();r&&(r.structure&&(m=r.structure),r.completion_date&&(f=new Date(r.completion_date)))}if(!m){let{data:t}=await e.from("deal_fee_structures").select("structure, completion_date").eq("deal_id",d.deal_id).eq("status","published").order("created_at",{ascending:!1}).limit(1).maybeSingle();t?.structure&&(m=t.structure),!f&&t?.completion_date&&(f=new Date(t.completion_date))}}let g=d.investor,y=g?function(e){if("individual"===e.type){let t=e.first_name?.trim()||"",r=e.last_name?.trim()||"";if(t||r)return`${t} ${r}`.trim()}return e.legal_name||"Unknown Investor"}(g):"Unknown Investor",v=f||(p?.close_at?new Date(p.close_at):new Date),b=u.name?.toLowerCase().includes("verso capital 2")||!1,h={logo_type:b?"text":"image",logo_text:b?"VERSO":"",logo_font:"League Spartan",vehicle_logo_url:!b&&u.logo_url||"",series_number:u.series_number||"",subscription_number:d.subscription_number||"",units:d.units||d.num_shares||s||0,close_at:v.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),vehicle_name:u.name||"",company_name:p?.company_name||p?.name||"",vehicle_registration_number:u.registration_number||"",investor_name:y,num_shares:d.num_shares||s||0,structure:m,vehicle_address:u.address||"",signatory_1_name:"Mr Julien Machot",signatory_1_title:"Managing Partner",signatory_1_signature_url:"",signatory_2_name:"G.A. Giles",signatory_2_title:"Authorized Signatory",signatory_2_signature_url:"",subscription_id:t,investor_id:r,vehicle_id:i,deal_id:d.deal_id||"",commitment_amount:a,funded_amount:n,price_per_share:o||null,certificate_date:v.toISOString().split("T")[0],include_watermark:!1};console.log("üìú Triggering Certificate Generation:",{subscription_id:t,investor:y,certificate_number:`VC${u.series_number}SH${d.subscription_number}`,units:h.units,logo_type:h.logo_type,close_at:h.close_at,vehicle_name:h.vehicle_name,company_name:h.company_name});let w=await (0,S.triggerWorkflow)({workflowKey:"generate-investment-certificate",payload:h,entityType:"subscription",entityId:t,user:{id:l.id,email:l.email||"",displayName:l.display_name||void 0,role:l.role||"staff_admin",title:l.title||void 0}});if(w.success){if(console.log(`‚úÖ Certificate generation triggered for subscription ${t}`),w.n8n_response)try{let a=w.n8n_response;console.log("üì¶ n8n certificate response keys:",Object.keys(a));let n=null;if(a.binary&&Buffer.isBuffer(a.binary))n=a.binary,console.log("üìÑ Found PDF in binary format (direct buffer)");else if(a.data)Buffer.isBuffer(a.data)?(n=a.data,console.log("üìÑ Found PDF in data (Buffer) format")):"string"==typeof a.data&&(a.data.startsWith("%PDF")?(n=Buffer.from(a.data,"latin1"),console.log("üìÑ Found PDF in data (raw binary string) format")):(n=Buffer.from(a.data,"base64"),console.log("üìÑ Found PDF in data (base64) format")));else if(a.raw&&"string"==typeof a.raw)n=Buffer.from(a.raw,"latin1"),console.log("üìÑ Found PDF in raw (latin1) format");else if("string"==typeof a)n=Buffer.from(a,"latin1"),console.log("üìÑ Found PDF as direct string");else if(a.html&&"string"==typeof a.html){console.log("üìÑ n8n returned HTML, converting to PDF via portal Gotenberg...");let e=await (0,D.convertHtmlToPdf)(a.html,"certificate.html");e.success&&e.pdfBuffer?(n=e.pdfBuffer,console.log("‚úÖ HTML converted to PDF via portal Gotenberg")):console.error("‚ùå Portal Gotenberg conversion failed:",e.error)}if(n&&n.length>0){let a,s=n.slice(0,4).toString();if(console.log("üìÑ File signature:",s,"size:",n.length,"bytes"),"%PDF"!==s&&console.warn("‚ö†Ô∏è File does not appear to be a valid PDF (signature:",s,")"),g?.type==="individual"){let e=(g.last_name||"").trim().toUpperCase(),t=(g.first_name||"").trim().toUpperCase();a=`${e} ${t}`.trim()||"UNKNOWN"}else a=(g?.legal_name||"UNKNOWN").toUpperCase();let o=a.replace(/[^a-zA-Z0-9 ]/g,"").substring(0,50),c=`VC${u.series_number}SH${d.subscription_number}`,_=`${c} - ${o}.pdf`,m=`subscriptions/${t}/certificates/${_}`,{error:f}=await e.storage.from("deal-documents").upload(m,n,{contentType:"application/pdf",upsert:!0});if(f)console.error("‚ùå Failed to upload certificate PDF:",f);else{console.log("‚úÖ Certificate PDF uploaded:",m);let a=null;if(i){let{data:t}=await e.from("document_folders").select("id").eq("vehicle_id",i).eq("name","Subscription Documents").single();a=t?.id||null}let{data:s,error:o}=await e.from("documents").insert({subscription_id:t,deal_id:d.deal_id,vehicle_id:i,folder_id:a,type:"certificate",name:_,file_key:m,mime_type:"application/pdf",file_size_bytes:n.length,status:"pending_signature",current_version:1,ready_for_signature:!0,created_by:l.id}).select("id").single();if(o)console.error("‚ùå Failed to create document record:",o);else{console.log("‚úÖ Document record created:",s.id),await e.from("subscriptions").update({certificate_pdf_path:m}).eq("id",t);let{data:i}=await e.from("profiles").select("id, email, display_name").eq("role","ceo").limit(1).single(),a=i?{user_id:i.id,email:i.email||"",name:i.display_name||"CEO"}:null,o=null;if(d.deal_id){let{data:t}=await e.from("deal_lawyer_assignments").select(`
                      lawyer:lawyers!deal_lawyer_assignments_lawyer_id_fkey (
                        id,
                        legal_name,
                        email,
                        user_id
                      )
                    `).eq("deal_id",d.deal_id).limit(1).maybeSingle();if(t?.lawyer){let e=t.lawyer;o={user_id:e.user_id,email:e.email,name:e.legal_name}}}if(!o){let{data:t}=await e.from("profiles").select("id, email, display_name").eq("email","cto@versoholdings.com").single();t&&(o={user_id:t.id,email:t.email||"",name:"G.A. Giles"})}let c=new Date(Date.now()+2592e6);if(a){let i=N.default.randomBytes(32).toString("hex"),{data:o,error:_}=await e.from("signature_requests").insert({investor_id:r,document_id:s.id,subscription_id:t,deal_id:d.deal_id,document_type:"certificate",signer_email:a.email,signer_name:a.name,signer_role:"ceo",signature_position:"party_a",signing_token:i,token_expires_at:c.toISOString(),unsigned_pdf_path:m,unsigned_pdf_size:n.length,status:"pending",created_by:l.id}).select("id").single();if(_)console.error("‚ùå Failed to create CEO signature request:",_);else{console.log("‚úÖ CEO signature request created (party_a, signs first)");let t=`http://localhost:3000/versotech_main/versosign?token=${i}`,{error:r}=await e.from("tasks").insert({owner_user_id:a.user_id,kind:"countersignature",category:"compliance",title:`Sign Certificate: ${y}`,description:`Sign equity certificate for ${y} - ${p?.company_name||"Investment"}`,status:"pending",priority:"high",related_entity_type:"signature_request",related_entity_id:o.id,related_deal_id:d.deal_id,due_at:c.toISOString(),instructions:{type:"signature",action_url:t,signature_request_id:o.id,document_type:"certificate",investor_name:y,signer_name:a.name,signer_role:"ceo",signature_position:"party_a",signing_order:1}});r?console.error("‚ö†Ô∏è Failed to create CEO task:",r):console.log("‚úÖ CEO VERSOSign task created")}}else console.error("‚ùå No CEO found in system - this should never happen!");if(o){let i=N.default.randomBytes(32).toString("hex"),a=o.email.includes("lawyer")||o.name.toLowerCase().includes("lawyer")?"lawyer":"admin",{data:_,error:u}=await e.from("signature_requests").insert({investor_id:r,document_id:s.id,subscription_id:t,deal_id:d.deal_id,document_type:"certificate",signer_email:o.email,signer_name:o.name,signer_role:a,signature_position:"party_b",signing_token:i,token_expires_at:c.toISOString(),unsigned_pdf_path:m,unsigned_pdf_size:n.length,status:"pending",created_by:l.id}).select("id").single();if(u)console.error("‚ùå Failed to create second signatory request:",u);else{console.log(`‚úÖ Second signatory request created (party_b, ${o.name})`);let t=`http://localhost:3000/versotech_main/versosign?token=${i}`,{error:r}=await e.from("tasks").insert({owner_user_id:o.user_id,kind:"countersignature",category:"compliance",title:`Sign Certificate: ${y}`,description:`Sign equity certificate for ${y} - ${p?.company_name||"Investment"}. Awaiting CEO signature first.`,status:"pending",priority:"high",related_entity_type:"signature_request",related_entity_id:_.id,related_deal_id:d.deal_id,due_at:c.toISOString(),instructions:{type:"signature",action_url:t,signature_request_id:_.id,document_type:"certificate",investor_name:y,signer_name:o.name,signer_role:a,signature_position:"party_b",signing_order:2,requires_prior_signature:"party_a"}});r?console.error("‚ö†Ô∏è Failed to create second signatory task:",r):console.log(`‚úÖ Second signatory VERSOSign task created for ${o.name}`)}}else console.warn("‚ö†Ô∏è No second signatory found - certificate will have only CEO signature");console.log(`üìú Certificate workflow initiated: ${_}`),console.log(`   - Document ID: ${s.id}`),console.log("   - Status: pending_signature (hidden from investor)"),console.log(`   - Awaiting: CEO (party_a) ‚Üí Second Signatory (party_b) signatures`)}}}else console.warn("‚ö†Ô∏è No binary PDF data found in n8n response")}catch(e){console.error("‚ùå Error processing certificate PDF from n8n:",e)}}else console.warn(`‚ö†Ô∏è Certificate workflow not configured: ${w.error}`);let{data:q,error:$}=await e.from("investor_users").select("user_id").eq("investor_id",r);if($)console.error(`‚ùå Failed to fetch investor users for notification:`,$);else if(q&&0!==q.length){let t=q.map(e=>({user_id:e.user_id,investor_id:r,type:"investment_activated",title:"Investment Activated",message:"Your investment is now active. Your equity certificate will be available shortly.",link:"/versotech_main/portfolio"})),{error:i}=await e.from("investor_notifications").insert(t);i?console.error(`‚ùå Failed to create investor notifications:`,i):console.log(`‚úÖ Created ${t.length} notification(s) for investor ${r}`)}else console.warn(`‚ö†Ô∏è No investor_users found for investor ${r} - cannot create notification`);let{data:I,error:k}=await e.from("subscriptions").select("deal_id").eq("id",t).single();if(k||!I?.deal_id)console.warn(`‚ö†Ô∏è Could not get deal_id for lawyer notification:`,k);else{let{data:t,error:i}=await e.from("deal_lawyer_assignments").select("lawyer_id").eq("deal_id",I.deal_id);if(i)console.error(`‚ùå Failed to fetch lawyer assignments:`,i);else if(t&&t.length>0){let i=t.map(e=>e.lawyer_id),{data:a,error:n}=await e.from("lawyer_users").select("user_id, lawyer_id").in("lawyer_id",i);if(n)console.error(`‚ùå Failed to fetch lawyer users:`,n);else if(a&&a.length>0){let{data:t}=await e.from("investors").select("display_name, legal_name").eq("id",r).single(),i=t?.display_name||t?.legal_name||"An investor",n=a.map(e=>({user_id:e.user_id,investor_id:null,type:"certificate_issued",title:"Certificate Issued",message:`Investment certificate issued for ${i}. The subscription is now fully active.`,link:"/versotech_main/subscription-packs"})),{error:s}=await e.from("investor_notifications").insert(n);s?console.error(`‚ùå Failed to create lawyer notifications:`,s):console.log(`‚úÖ Created ${n.length} lawyer notification(s) for certificate issuance`)}}}}catch(e){console.error(`‚ùå Certificate trigger failed for subscription ${t}:`,e)}}var E=e.i(627291);async function A(e,t){let r=0;try{let i=`${t.entityType}_users`,a=`${t.entityType}_id`,{data:n}=await e.from(i).select("user_id").eq(a,t.entityId);if(n&&n.length>0){let e=new Intl.NumberFormat("en-US",{style:"currency",currency:t.currency||"USD"}).format(t.commissionAmount);for(let i of n)try{await (0,E.createInvestorNotification)({userId:i.user_id,title:"Commission Earned",message:`You've earned a ${e} commission for ${t.investorName}'s investment in ${t.dealName}.`,link:"/versotech_main/my-commissions",type:"introducer_commission_accrued",sendEmailNotification:!0,dealId:t.dealId}),r++}catch(e){console.error(`[deal-close] Failed to send accrual notification to user ${i.user_id}:`,e)}}let s={introducer:h.AuditEntities.INTRODUCER_COMMISSIONS,partner:h.AuditEntities.PARTNER_COMMISSIONS,commercial_partner:h.AuditEntities.COMMERCIAL_PARTNER_COMMISSIONS};await h.auditLogger.log({action:h.AuditActions.COMMISSION_ACCRUED,entity:s[t.entityType],entity_id:t.commissionId,metadata:{entity_type:t.entityType,entity_id:t.entityId,deal_id:t.dealId,deal_name:t.dealName,investor_name:t.investorName,commission_amount:t.commissionAmount,currency:t.currency,created_by:"deal_close_handler"}})}catch(e){console.error("[deal-close] Error sending accrual notification:",e)}return r}async function R(e,t,r){let i={success:!1,dealId:t,subscriptionsActivated:0,positionsCreated:0,commissionsCreated:0,certificatesTriggered:0,feePlansEnabled:0,notificationsSent:0,accrualNotificationsSent:0,errors:[]};try{let{data:a,error:n}=await e.from("deals").select("id, name, company_name, status, close_at, closed_processed_at, vehicle_id, arranger_entity_id, currency").eq("id",t).single();if(n||!a)return i.errors.push(`Deal not found: ${n?.message||"Unknown error"}`),i;if(a.closed_processed_at)return console.log(`[deal-close] Deal ${t} already processed at ${a.closed_processed_at}, skipping`),i.success=!0,i;console.log(`[deal-close] Processing deal ${t} (${a.name}) closing date: ${r.toISOString()}`);let{data:s,error:o}=await e.from("subscriptions").select(`
        id,
        investor_id,
        vehicle_id,
        commitment,
        funded_amount,
        currency,
        num_shares,
        units,
        price_per_share,
        cost_per_share,
        status,
        activated_at,
        investor:investors(
          id,
          display_name,
          legal_name
        )
      `).eq("deal_id",t).eq("status","funded").is("activated_at",null);if(o)i.errors.push(`Failed to fetch subscriptions: ${o.message}`);else if(s&&s.length>0){console.log(`[deal-close] Found ${s.length} funded subscriptions to activate`);let{data:r}=await e.from("profiles").select("id, email, display_name, role, title").eq("role","staff_admin").limit(1).single(),n=r||{id:"system",email:"system@versoholdings.com",display_name:"System",role:"system",title:"Automated Process"};for(let r of s)try{let s=Number(r.price_per_share)||null,o=Number(r.cost_per_share)||null,l=r.num_shares||r.units||null,d=null,c=null;s&&o&&s>0&&o>0&&(d=s-o,l&&l>0&&(c=d*Number(l)));let{error:_}=await e.from("subscriptions").update({status:"active",activated_at:new Date().toISOString(),...null!==d&&{spread_per_share:d},...null!==c&&{spread_fee_amount:c}}).eq("id",r.id);if(_){i.errors.push(`Failed to activate subscription ${r.id}: ${_.message}`);continue}i.subscriptionsActivated++,console.log(`[deal-close] Activated subscription ${r.id}`);let u=Number(r.funded_amount)||0,p=r.num_shares||r.units;!p&&r.price_per_share?p=u/Number(r.price_per_share):!p&&r.cost_per_share&&(p=u/Number(r.cost_per_share));let m=r.price_per_share||r.cost_per_share;if(p&&p>0){let{data:t}=await e.from("positions").select("id").eq("investor_id",r.investor_id).eq("vehicle_id",r.vehicle_id||a.vehicle_id).maybeSingle();if(t)console.log(`[deal-close] Position already exists for subscription ${r.id}`);else{let{error:t}=await e.from("positions").insert({investor_id:r.investor_id,vehicle_id:r.vehicle_id||a.vehicle_id,units:p,cost_basis:u,last_nav:m,as_of_date:new Date().toISOString()});t?i.errors.push(`Failed to create position for subscription ${r.id}: ${t.message}`):(i.positionsCreated++,console.log(`[deal-close] Created position for subscription ${r.id}: ${p} units`))}}try{let{data:n}=await e.from("deal_memberships").select("referred_by_entity_id, referred_by_entity_type, assigned_fee_plan_id").eq("deal_id",t).eq("investor_id",r.investor_id).order("dispatched_at",{ascending:!1}).limit(1).maybeSingle(),s=!!n?.referred_by_entity_type&&!!n.referred_by_entity_id;if(s&&n){let o=n.assigned_fee_plan_id;o||(i.errors.push(`Commission skipped for subscription ${r.id}: no assigned fee plan`),s=!1);let{data:l}=s&&o?await e.from("fee_plans").select("id, status, is_active, introducer_id, partner_id, commercial_partner_id, fee_components(id, kind, rate_bps)").eq("id",o).eq("deal_id",t).maybeSingle():{data:null};!s||l&&l.is_active&&"accepted"===l.status||(i.errors.push(`Commission skipped for subscription ${r.id}: fee plan not accepted or inactive`),s=!1);let d=s&&l&&"introducer"===n.referred_by_entity_type?l.introducer_id===n.referred_by_entity_id:s&&l&&"partner"===n.referred_by_entity_type?l.partner_id===n.referred_by_entity_id:!!s&&!!l&&l.commercial_partner_id===n.referred_by_entity_id;s&&!d&&(i.errors.push(`Commission skipped for subscription ${r.id}: fee plan does not match referrer`),s=!1);let c=(s&&l&&l.fee_components||[]).find(e=>"subscription"===e.kind),_=c?.rate_bps||0;if(s&&(!_||_<=0)&&(i.errors.push(`Commission skipped for subscription ${r.id}: fee plan has no subscription fee rate`),s=!1),s){let s=u*_/1e4,l=r.currency||a.currency||"USD",d=new Date().toISOString();if("introducer"===n.referred_by_entity_type){let c=new Date().toISOString().split("T")[0],{data:p}=await e.from("introducer_agreements").select("id").eq("introducer_id",n.referred_by_entity_id).eq("fee_plan_id",o).eq("status","active").not("signed_date","is",null).or(`expiry_date.is.null,expiry_date.gte.${c}`).maybeSingle();if(p){let{data:c}=await e.from("introducer_commissions").select("id").eq("introducer_id",n.referred_by_entity_id).eq("deal_id",t).eq("investor_id",r.investor_id).maybeSingle();if(!c){let{data:c}=await e.from("introducer_commissions").insert({introducer_id:n.referred_by_entity_id,deal_id:t,investor_id:r.investor_id,arranger_id:a.arranger_entity_id||null,fee_plan_id:o,basis_type:"invested_amount",rate_bps:_,base_amount:u,accrual_amount:s,currency:l,status:"accrued",created_at:d}).select("id").single();i.commissionsCreated++;let p=r.investor,m=p?.display_name||p?.legal_name||"Investor",f=await A(e,{entityType:"introducer",entityId:n.referred_by_entity_id,dealId:t,dealName:a.name||"Deal",investorName:m,commissionAmount:s,currency:l,commissionId:c?.id});i.accrualNotificationsSent+=f}}else i.errors.push(`Commission skipped for subscription ${r.id}: introducer agreement not active`)}else if("partner"===n.referred_by_entity_type){let{data:c}=await e.from("partner_commissions").select("id").eq("partner_id",n.referred_by_entity_id).eq("deal_id",t).eq("investor_id",r.investor_id).maybeSingle();if(!c){let{data:c}=await e.from("partner_commissions").insert({partner_id:n.referred_by_entity_id,deal_id:t,investor_id:r.investor_id,arranger_id:a.arranger_entity_id||null,fee_plan_id:o,basis_type:"invested_amount",rate_bps:_,base_amount:u,accrual_amount:s,currency:l,status:"accrued",created_at:d}).select("id").single();i.commissionsCreated++;let p=r.investor,m=p?.display_name||p?.legal_name||"Investor",f=await A(e,{entityType:"partner",entityId:n.referred_by_entity_id,dealId:t,dealName:a.name||"Deal",investorName:m,commissionAmount:s,currency:l,commissionId:c?.id});i.accrualNotificationsSent+=f}}else if("commercial_partner"===n.referred_by_entity_type)if(a.arranger_entity_id){let{data:c}=await e.from("commercial_partner_commissions").select("id").eq("commercial_partner_id",n.referred_by_entity_id).eq("deal_id",t).eq("investor_id",r.investor_id).maybeSingle();if(!c){let{data:c}=await e.from("commercial_partner_commissions").insert({commercial_partner_id:n.referred_by_entity_id,deal_id:t,investor_id:r.investor_id,arranger_id:a.arranger_entity_id,fee_plan_id:o,basis_type:"invested_amount",rate_bps:_,base_amount:u,accrual_amount:s,currency:l,status:"accrued",created_at:d}).select("id").single();i.commissionsCreated++;let p=r.investor,m=p?.display_name||p?.legal_name||"Investor",f=await A(e,{entityType:"commercial_partner",entityId:n.referred_by_entity_id,dealId:t,dealName:a.name||"Deal",investorName:m,commissionAmount:s,currency:l,commissionId:c?.id});i.accrualNotificationsSent+=f}}else i.errors.push(`Commission skipped for subscription ${r.id}: missing arranger for commercial partner`)}}}catch(t){let e=t instanceof Error?t.message:"Unknown error";i.errors.push(`Commission creation failed for subscription ${r.id}: ${e}`)}await C({supabase:e,subscriptionId:r.id,investorId:r.investor_id,vehicleId:r.vehicle_id||a.vehicle_id,commitment:r.commitment||0,fundedAmount:u,shares:r.num_shares||r.units,pricePerShare:r.price_per_share,profile:n}),i.certificatesTriggered++}catch(t){let e=t instanceof Error?t.message:"Unknown error";i.errors.push(`Processing failed for subscription ${r.id}: ${e}`)}}let l=new Date().toISOString(),{data:d,error:c}=await e.from("fee_plans").update({invoice_requests_enabled:!0,invoice_requests_enabled_at:l}).eq("deal_id",t).eq("status","accepted").eq("invoice_requests_enabled",!1).select("id, introducer_id, partner_id, commercial_partner_id, name");if(c)i.errors.push(`Failed to enable invoice requests: ${c.message}`);else if(d)for(let t of(i.feePlansEnabled=d.length,console.log(`[deal-close] Enabled invoice requests for ${d.length} fee plans`),d))try{await F(e,t,a),i.notificationsSent++}catch(r){let e=r instanceof Error?r.message:"Unknown error";i.errors.push(`Notification failed for fee plan ${t.id}: ${e}`)}let{error:_}=await e.from("deals").update({closed_processed_at:l}).eq("id",t);return _&&i.errors.push(`Failed to mark deal as processed: ${_.message}`),i.success=0===i.errors.length,console.log(`[deal-close] Completed processing deal ${t}:`,{certificates:i.certificatesTriggered,feePlansEnabled:i.feePlansEnabled,notifications:i.notificationsSent,errors:i.errors.length}),i}catch(r){let e=r instanceof Error?r.message:"Unknown error";return i.errors.push(`Unexpected error: ${e}`),console.error(`[deal-close] Unexpected error processing deal ${t}:`,r),i}}async function F(e,t,r){let i=null,a=null,n=null,s=null;if(t.introducer_id?(i="introducers",a=t.introducer_id,n="introducer",s="introducer_users"):t.partner_id?(i="partners",a=t.partner_id,n="partner",s="partner_users"):t.commercial_partner_id&&(i="commercial_partners",a=t.commercial_partner_id,n="commercial_partner",s="commercial_partner_users"),!i||!a||!s)return void console.warn(`[deal-close] Fee plan ${t.id} has no linked entity`);let{data:o,error:l}=await e.from(s).select("user_id").eq(`${n}_id`,a);if(l)return void console.error(`[deal-close] Failed to fetch ${n} users:`,l);if(!o||0===o.length)return void console.warn(`[deal-close] No users found for ${n} ${a}`);let d=r.company_name||r.name,c=`The deal "${d}" has reached its closing date. You can now submit invoice requests for your fee agreement "${t.name}".`;for(let{user_id:e}of o)try{await (0,E.createInvestorNotification)({userId:e,title:"Deal Closed - Invoice Requests Available",message:c,link:"/versotech_main/fee-plans",type:"introducer_invoice_sent",sendEmailNotification:!0,dealId:r.id})}catch(t){console.error(`[deal-close] Failed to create notification for user ${e}:`,t)}}async function x(e,t){let r={success:!1,termsheetId:t,dealId:"",subscriptionsActivated:0,positionsCreated:0,commissionsCreated:0,certificatesTriggered:0,feePlansEnabled:0,notificationsSent:0,accrualNotificationsSent:0,errors:[]};try{let{data:i,error:a}=await e.from("deal_fee_structures").select(`
        id,
        deal_id,
        version,
        status,
        completion_date,
        closed_processed_at,
        subscription_fee_percent,
        deal:deals!deal_fee_structures_deal_id_fkey (
          id,
          name,
          company_name,
          status,
          currency,
          vehicle_id,
          arranger_entity_id
        )
      `).eq("id",t).single();if(a||!i)return r.errors.push(`Termsheet not found: ${a?.message||"Unknown error"}`),r;r.dealId=i.deal_id;let n=i.deal;if(i.closed_processed_at)return console.log(`[termsheet-close] Termsheet ${t} already processed at ${i.closed_processed_at}, skipping`),r.success=!0,r;console.log(`[termsheet-close] Processing termsheet ${t} (${n?.name} v${i.version})`);let{data:s,error:o}=await e.from("deal_memberships").select("investor_id, referred_by_entity_id, referred_by_entity_type, assigned_fee_plan_id").eq("deal_id",i.deal_id).eq("term_sheet_id",t);if(o)return r.errors.push(`Failed to fetch deal memberships: ${o.message}`),r;let l=(s||[]).map(e=>e.investor_id).filter(Boolean);0===l.length&&console.log(`[termsheet-close] No investors linked to termsheet ${t}`);let d=[],c=null;if(l.length>0){let{data:t,error:r}=await e.from("subscriptions").select(`
          id,
          investor_id,
          vehicle_id,
          commitment,
          funded_amount,
          currency,
          num_shares,
          units,
          price_per_share,
          cost_per_share,
          status,
          activated_at,
          investor:investors(
            id,
            display_name,
            legal_name
          )
        `).eq("deal_id",i.deal_id).eq("status","funded").is("activated_at",null).in("investor_id",l);d=t||[],c=r,d=d.map(e=>({...e,deal_membership:s?.find(t=>t.investor_id===e.investor_id)||null}))}if(c)r.errors.push(`Failed to fetch subscriptions: ${c.message}`);else if(d&&d.length>0){console.log(`[termsheet-close] Found ${d.length} funded subscriptions linked to termsheet ${t}`);let{data:a}=await e.from("profiles").select("id, email, display_name, role, title").eq("role","staff_admin").limit(1).single(),s=a||{id:"system",email:"system@versoholdings.com",display_name:"System",role:"system",title:"Automated Process"};for(let a of d){let o=a.deal_membership;try{let l=Number(a.price_per_share)||null,d=Number(a.cost_per_share)||null,c=a.num_shares||a.units||null,_=null,u=null;l&&d&&l>0&&d>0&&(_=l-d,c&&c>0&&(u=_*Number(c)));let{error:p}=await e.from("subscriptions").update({status:"active",activated_at:new Date().toISOString(),...null!==_&&{spread_per_share:_},...null!==u&&{spread_fee_amount:u}}).eq("id",a.id);if(p){r.errors.push(`Failed to activate subscription ${a.id}: ${p.message}`);continue}r.subscriptionsActivated++,console.log(`[termsheet-close] Activated subscription ${a.id}`);let m=Number(a.funded_amount)||0,f=a.num_shares||a.units;if(!f&&a.price_per_share?f=m/Number(a.price_per_share):!f&&a.cost_per_share&&(f=m/Number(a.cost_per_share)),f&&f>0){let{data:t}=await e.from("positions").select("id").eq("investor_id",a.investor_id).eq("vehicle_id",a.vehicle_id||n.vehicle_id).maybeSingle();if(!t){let{error:t}=await e.from("positions").insert({investor_id:a.investor_id,vehicle_id:a.vehicle_id||n.vehicle_id,units:f,cost_basis:m,last_nav:a.price_per_share||a.cost_per_share,as_of_date:new Date().toISOString()});t?r.errors.push(`Failed to create position for subscription ${a.id}: ${t.message}`):(r.positionsCreated++,console.log(`[termsheet-close] Created position for subscription ${a.id}: ${f} units`))}}if(o?.referred_by_entity_type&&o.referred_by_entity_id){let s=o.assigned_fee_plan_id;if(s){let{data:l}=await e.from("fee_plans").select("id, status, is_active, introducer_id, partner_id, commercial_partner_id, fee_components(id, kind, rate_bps)").eq("id",s).eq("term_sheet_id",t).maybeSingle();if(l&&l.is_active&&"accepted"===l.status){let t=(l.fee_components||[]).find(e=>"subscription"===e.kind),d=t?.rate_bps||0;if(d>0){let t=m*d/1e4,c=a.currency||n.currency||"USD",_=new Date().toISOString();if("introducer"===o.referred_by_entity_type&&l.introducer_id===o.referred_by_entity_id){let{data:l}=await e.from("introducer_commissions").select("id").eq("introducer_id",o.referred_by_entity_id).eq("deal_id",i.deal_id).eq("investor_id",a.investor_id).maybeSingle();if(!l){let{data:l}=await e.from("introducer_commissions").insert({introducer_id:o.referred_by_entity_id,deal_id:i.deal_id,investor_id:a.investor_id,arranger_id:n.arranger_entity_id||null,fee_plan_id:s,basis_type:"invested_amount",rate_bps:d,base_amount:m,accrual_amount:t,currency:c,status:"accrued",created_at:_}).select("id").single();r.commissionsCreated++;let u=a.investor,p=u?.display_name||u?.legal_name||"Investor",f=await A(e,{entityType:"introducer",entityId:o.referred_by_entity_id,dealId:i.deal_id,dealName:n.name||"Deal",investorName:p,commissionAmount:t,currency:c,commissionId:l?.id});r.accrualNotificationsSent+=f}}else if("partner"===o.referred_by_entity_type&&l.partner_id===o.referred_by_entity_id){let{data:l}=await e.from("partner_commissions").select("id").eq("partner_id",o.referred_by_entity_id).eq("deal_id",i.deal_id).eq("investor_id",a.investor_id).maybeSingle();if(!l){let{data:l}=await e.from("partner_commissions").insert({partner_id:o.referred_by_entity_id,deal_id:i.deal_id,investor_id:a.investor_id,arranger_id:n.arranger_entity_id||null,fee_plan_id:s,basis_type:"invested_amount",rate_bps:d,base_amount:m,accrual_amount:t,currency:c,status:"accrued",created_at:_}).select("id").single();r.commissionsCreated++;let u=a.investor,p=u?.display_name||u?.legal_name||"Investor",f=await A(e,{entityType:"partner",entityId:o.referred_by_entity_id,dealId:i.deal_id,dealName:n.name||"Deal",investorName:p,commissionAmount:t,currency:c,commissionId:l?.id});r.accrualNotificationsSent+=f}}else if("commercial_partner"===o.referred_by_entity_type&&l.commercial_partner_id===o.referred_by_entity_id&&n.arranger_entity_id){let{data:l}=await e.from("commercial_partner_commissions").select("id").eq("commercial_partner_id",o.referred_by_entity_id).eq("deal_id",i.deal_id).eq("investor_id",a.investor_id).maybeSingle();if(!l){let{data:l}=await e.from("commercial_partner_commissions").insert({commercial_partner_id:o.referred_by_entity_id,deal_id:i.deal_id,investor_id:a.investor_id,arranger_id:n.arranger_entity_id,fee_plan_id:s,basis_type:"invested_amount",rate_bps:d,base_amount:m,accrual_amount:t,currency:c,status:"accrued",created_at:_}).select("id").single();r.commissionsCreated++;let u=a.investor,p=u?.display_name||u?.legal_name||"Investor",f=await A(e,{entityType:"commercial_partner",entityId:o.referred_by_entity_id,dealId:i.deal_id,dealName:n.name||"Deal",investorName:p,commissionAmount:t,currency:c,commissionId:l?.id});r.accrualNotificationsSent+=f}}}}}}await C({supabase:e,subscriptionId:a.id,investorId:a.investor_id,vehicleId:a.vehicle_id||n.vehicle_id,commitment:a.commitment||0,fundedAmount:m,shares:a.num_shares||a.units,pricePerShare:a.price_per_share,profile:s}),r.certificatesTriggered++}catch(t){let e=t instanceof Error?t.message:"Unknown error";r.errors.push(`Processing failed for subscription ${a.id}: ${e}`)}}}else console.log(`[termsheet-close] No funded subscriptions found for termsheet ${t}`);let _=new Date().toISOString(),{data:u,error:p}=await e.from("fee_plans").update({invoice_requests_enabled:!0,invoice_requests_enabled_at:_}).eq("deal_id",i.deal_id).eq("term_sheet_id",t).eq("status","accepted").eq("invoice_requests_enabled",!1).select("id, introducer_id, partner_id, commercial_partner_id, name");if(p)r.errors.push(`Failed to enable invoice requests: ${p.message}`);else if(u)for(let t of(r.feePlansEnabled=u.length,console.log(`[termsheet-close] Enabled invoice requests for ${u.length} fee plans`),u))try{await O(e,t,n,i.version),r.notificationsSent++}catch(i){let e=i instanceof Error?i.message:"Unknown error";r.errors.push(`Notification failed for fee plan ${t.id}: ${e}`)}let{error:m}=await e.from("deal_fee_structures").update({closed_processed_at:_}).eq("id",t);return m&&r.errors.push(`Failed to mark termsheet as processed: ${m.message}`),r.success=0===r.errors.length,console.log(`[termsheet-close] Completed processing termsheet ${t}:`,{subscriptions:r.subscriptionsActivated,certificates:r.certificatesTriggered,feePlansEnabled:r.feePlansEnabled,notifications:r.notificationsSent,errors:r.errors.length}),r}catch(i){let e=i instanceof Error?i.message:"Unknown error";return r.errors.push(`Unexpected error: ${e}`),console.error(`[termsheet-close] Unexpected error processing termsheet ${t}:`,i),r}}async function O(e,t,r,i){let a=null,n=null,s=null;if(t.introducer_id?(a="introducer",n=t.introducer_id,s="introducer_users"):t.partner_id?(a="partner",n=t.partner_id,s="partner_users"):t.commercial_partner_id&&(a="commercial_partner",n=t.commercial_partner_id,s="commercial_partner_users"),!a||!n||!s)return;let{data:o}=await e.from(s).select("user_id").eq(`${a}_id`,n);if(!o||0===o.length)return;let l=r.company_name||r.name,d=`The termsheet v${i} for "${l}" has reached its completion date. You can now submit invoice requests for your fee agreement "${t.name}".`;for(let{user_id:e}of o)try{await (0,E.createInvestorNotification)({userId:e,title:"Termsheet Closed - Invoice Requests Available",message:d,link:"/versotech_main/fee-plans",type:"introducer_invoice_sent",sendEmailNotification:!0,dealId:r.id})}catch(t){console.error(`[termsheet-close] Failed to create notification for user ${e}:`,t)}}function T(e,t,r,i){let a=new Date(i),n=a.getUTCDate().toString().padStart(2,"0"),s=(a.getUTCMonth()+1).toString().padStart(2,"0"),o=a.getUTCFullYear().toString().slice(-2),l=`${n}${s}${o}`,d=e.trim(),c=t.trim().replace(/\s+/g," "),_=r.trim().replace(/\s+/g," ");return`${d} - SUBSCRIPTION PACK - ${c} - ${_} - ${l}`}function P(e){return"application/pdf"===e?".pdf":"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===e||e.includes("word")?".docx":".pdf"}async function j(e,{params:t}){try{let{id:r}=await t,{action:i,notes:a,rejection_reason:n}=await e.json();if(!["approve","reject"].includes(i))return w.NextResponse.json({error:"Invalid action. Must be approve or reject."},{status:400});let s=await (0,b.requireStaffAuth)();await (0,v.createClient)();let o=(0,v.createServiceClient)(),{data:l,error:d}=await o.from("approvals").select(`
        *,
        requested_by_profile:profiles!approvals_requested_by_fkey(id, display_name, email),
        related_investor:investors!approvals_related_investor_id_fkey(id, legal_name),
        related_deal:deals!approvals_related_deal_id_fkey(id, name)
      `).eq("id",r).single();if(d||!l)return console.error("Approval fetch error:",d),w.NextResponse.json({error:"Approval not found"},{status:404});if("pending"!==l.status)return w.NextResponse.json({error:"Approval has already been processed"},{status:400});let c=new Date().toISOString(),_=null,u=!0,p=null,m=new Date(l.created_at),f=(new Date(c).getTime()-m.getTime())/36e5,g={status:"approve"===i?"approved":"rejected",approved_by:s.id,approved_at:c,resolved_at:c,updated_at:c,actual_processing_time_hours:Math.round(100*f)/100};a&&(g.notes=a),"reject"===i&&n&&(g.rejection_reason=n);let{data:y,error:S,count:q}=await o.from("approvals").update(g,{count:"exact"}).eq("id",r).eq("status","pending").select().single();if(0===q||!y)return console.warn(`Approval ${r} was already processed by another user`),w.NextResponse.json({error:"This approval was already processed by another user. Please refresh the page."},{status:409});if(S)return console.error("Approval update error:",S),w.NextResponse.json({error:"Failed to update approval"},{status:500});if("approve"===i){let t=await U(o,l,s.id,e,s);if(t.success)t.notificationData&&(p=t.notificationData);else{_=t.error,u=!1,console.error(`Entity approval failed for ${l.entity_type}:`,t.error),console.log("Rolling back approval to pending status...");let{error:e}=await o.from("approvals").update({status:"pending",approved_by:null,approved_at:null,resolved_at:null,notes:`Auto-rollback: ${t.error}. Original approver: ${s.id}`,updated_at:new Date().toISOString()}).eq("id",r);if(e)return console.error("CRITICAL: Rollback failed:",e),await h.auditLogger.log({actor_user_id:s.id,action:"approval_rollback_failed",entity:"approvals",entity_id:r,metadata:{original_error:t.error,rollback_error:e.message,severity:"critical"}}),w.NextResponse.json({success:!1,error:`CRITICAL: Approval failed AND rollback failed. The approval may be in an inconsistent state. Manual intervention required. Contact support immediately with Approval ID: ${r}`,details:{approval_error:t.error,rollback_error:e.message,approval_id:r}},{status:500});return w.NextResponse.json({success:!1,error:`Failed to process approval: ${t.error}. The approval has been rolled back to pending status. Please try again or contact support.`},{status:500})}}else"reject"===i&&await M(o,l,n||"",s.id);if(await h.auditLogger.log({actor_user_id:s.id,action:"approve"===i?"approval_approved":"approval_rejected",entity:"approvals",entity_id:r,metadata:{entity_type:l.entity_type,entity_id:l.entity_id,notes:a,rejection_reason:n}}),l.requested_by){let e="approve"===i?`Your ${l.entity_type} request has been approved`:`Your ${l.entity_type} request has been rejected`;await o.from("investor_notifications").insert({user_id:l.requested_by,title:`${l.entity_type} ${i}d`,message:e,type:"approve"===i?"approval_granted":"approval_rejected",metadata:{approval_id:r,entity_type:l.entity_type,entity_id:l.entity_id,rejection_reason:n||void 0,notes:a||void 0}})}return w.NextResponse.json({success:u,message:"approve"===i?"Approval confirmed successfully":"Approval rejected successfully",error:_,notificationData:p})}catch(e){return console.error("Approval action error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}async function U(e,t,r,i,a){try{let i=t.entity_type,n=t.entity_id,s=t.entity_metadata||{};switch(i){case"allocation":let{error:o}=await e.from("allocations").update({status:"approved",approved_by:r,approved_at:new Date().toISOString()}).eq("id",n);if(o)return console.error("Error approving allocation:",o),{success:!1,error:"Failed to approve allocation"};break;case"investor_onboarding":let{error:l}=await e.from("investors").update({kyc_status:"approved",kyc_approved_at:new Date().toISOString(),kyc_approved_by:r}).eq("id",n);if(l)return console.error("Error updating KYC status:",l),{success:!1,error:"Failed to update KYC status"};if(s.email){let{data:t}=await e.from("profiles").select("id").eq("email",s.email).single();if(!t){let t=Math.random().toString(36).slice(-8)+"Aa1!",{error:r}=await e.from("profiles").insert({email:s.email,display_name:s.display_name||s.email.split("@")[0],role:"investor",is_active:!0,metadata:{investor_id:n,temp_password:t,needs_password_reset:!0}});r&&console.error("Error creating investor profile:",r);let{data:i}=await e.from("profiles").select("id").eq("email",s.email).single();i&&await e.from("investor_users").insert({investor_id:n,user_id:i.id,role:"primary",is_active:!0})}}break;case"deal":let{error:d}=await e.from("deals").update({status:s.target_status||"approved",approved_by:r,approved_at:new Date().toISOString()}).eq("id",n);if(d)return console.error("Error approving deal:",d),{success:!1,error:"Failed to approve deal"};break;case"deal_close":{let{data:t,error:r}=await e.from("deals").select("id, name, close_at").eq("id",n).single();if(r||!t)return console.error("Error loading deal for close approval:",r),{success:!1,error:"Failed to load deal for closing"};if(!t.close_at)return{success:!1,error:"Deal has no closing date set"};let i=new Date(t.close_at),a=await R(e,n,i);if(!a.success){let e=a.errors.length>0?a.errors.join("; "):"Failed to process deal close";return{success:!1,error:e}}return{success:!0,notificationData:{type:"deal_close_processed",deal_id:n,deal_name:t.name}}}case"termsheet_close":{let t=await x(e,n);if(!t.success){let e=t.errors.length>0?t.errors.join("; "):"Failed to process termsheet close";return{success:!1,error:e}}return{success:!0,notificationData:{type:"termsheet_close_processed",termsheet_id:n,deal_id:t.dealId,subscriptions_activated:t.subscriptionsActivated,certificates_triggered:t.certificatesTriggered,commissions_created:t.commissionsCreated}}}case"deal_interest":case"deal_interest_nda":let{error:c}=await e.from("investor_deal_interest").update({status:"approved",updated_at:new Date().toISOString()}).eq("id",n);if(c)return console.error("Error approving deal interest:",c),{success:!1,error:"Failed to approve deal interest"};let{data:_}=await e.from("investor_deal_interest").select(`
            *,
            deal:deals!inner(
              id,
              name
            )
          `).eq("id",n).single();if(console.log("üîç DEBUG: dealInterest:",_?"EXISTS":"NULL"),_)try{let{data:t}=await e.from("investors").select("*, profiles!investors_created_by_fkey(display_name)").eq("id",_.investor_id).single(),{data:r}=await e.from("deals").select("*, vehicle:vehicles(*)").eq("id",_.deal_id).single();if(console.log("üîç DEBUG: Data check:",{hasInvestor:!!t,hasDeal:!!r,hasUser:!!a}),t&&r&&a){let i=await (0,$.getCeoSigner)(e);i||console.warn("[approvals] No CEO signer found, defaulting to approver profile");let n=i?.displayName||a.displayName||a.email?.split("@")[0]||"Authorized Signatory",s=i?.title||"Authorized Signatory",o=r.vehicle,l=o?.name||"Vehicle Name",d=o?.entity_code||"",c=o?.series_short_title||"",u=o?.series_number||"",p=c||(d?d.replace(/\d+/g,""):""),m=u||(d?d.replace(/\D+/g,""):""),f=[p,m].filter(Boolean).join(""),g=d||f||"VC206",y=[p,m].filter(Boolean).join(" "),v=`VERSO Capital 2 SCSP ${l}${y?` Series ${y}`:""} ("${g}")`,b=r.name||r.description||o?.investment_name||"Investment Opportunity",h=t.city?.trim(),w=t.country?.trim(),I=[h,w].filter(Boolean).join(" / ")||"Country to be provided",k=o?.address||"2, Avenue Charles de Gaulle ‚Äì L-1653",D=o?.domicile||"Luxembourg, LU",N=n,C=s;if(o?.managing_partner_id){let{data:t,error:r}=await e.from("profiles").select("display_name, title").eq("id",o.managing_partner_id).single();r&&console.warn("[approvals] Failed to load managing partner profile:",r.message),t?.display_name&&(N=t.display_name),t?.title&&(C=t.title)}let E=new Date,A=`${String(E.getDate()).padStart(2,"0")} / ${String(E.getMonth()+1).padStart(2,"0")} / ${E.getFullYear()}`,R=t.type&&"individual"!==t.type;console.log("üë• [NDA] Investor type detection:",{type:t.type,isEntity:R});let F=[];if(R){let{data:r,error:i}=await e.from("investor_members").select("id, full_name, email, role_title").eq("investor_id",t.id).eq("is_signatory",!0).eq("is_active",!0);i&&console.warn("[NDA] Failed to load investor members:",i.message),r&&r.length>0?(F=r.map(e=>({member_id:e.id,full_name:e.full_name||"Authorized Signatory",email:e.email||t.email,title:e.role_title||"Authorized Representative"})),console.log(`üë• [NDA] Found ${F.length} authorized signatories for entity`)):(console.warn("[NDA] No signatories marked for entity, using representative fallback"),F=[{member_id:null,full_name:t.representative_name||t.legal_name||"Authorized Representative",email:t.email,title:t.representative_title||"Authorized Representative"}])}else F=[{member_id:null,full_name:t.legal_name||t.display_name||"Investor",email:t.email,title:null}],console.log("üë§ [NDA] Individual investor - single signatory");for(let r of(console.log(`üîî [NDA] Processing ${F.length} NDA(s) for: ${t.legal_name}`),F)){console.log(`üìÑ [NDA] Generating NDA for signatory: ${r.full_name} (${r.email})`);let s={series_number:m||g,project_description:v,investment_description:b,series_entity_code:g,vehicle_name:l,series_code:p,series_numeric:m,investment_name:b,vehicle_managing_partner_name:N,vehicle_managing_partner_title:C,party_a_name:t.legal_name||t.display_name,party_a_registered_address:t.registered_address||"Address to be provided",party_a_city_country:I,party_a_representative_name:r.full_name,party_a_representative_title:r.title||"Authorized Representative",party_b_name:v,party_b_registered_address:k,party_b_city_country:D,party_b_representative_name:N,party_b_representative_title:C,dataroom_email:r.email,execution_date:A,zoho_sign_document_id:""},o=await (0,S.triggerWorkflow)({workflowKey:"process-nda",payload:s,entityType:"deal_interest_nda",entityId:_.id,user:{id:a.id,email:a.email,displayName:a.displayName,role:a.role,title:a.title}});if(!o.success){console.error(`‚ùå [NDA] Failed to trigger NDA workflow for ${r.full_name}:`,o.error);continue}if(console.log(`‚úÖ [NDA] Workflow triggered for ${r.full_name}:`,{workflow_run_id:o.workflow_run_id}),o.n8n_response&&o.workflow_run_id){let s=Array.isArray(o.n8n_response)?o.n8n_response[0]:o.n8n_response;try{let l={workflow_run_id:o.workflow_run_id,investor_id:t.id,member_id:r.member_id||void 0,deal_id:_.deal_id,signer_email:r.email,signer_name:r.full_name,document_type:"nda",google_drive_file_id:s.id,google_drive_url:s.webContentLink||s.webViewLink,signer_role:"investor",signature_position:"party_a"};console.log("üîç [NDA] Investor signature request:",{signatory:r.full_name,member_id:r.member_id});let d=await (0,q.createSignatureRequest)(l,e);d.success?console.log(`üìß [NDA] Investor signature request created for ${r.full_name}`):console.error(`Failed to create investor signature request for ${r.full_name}:`,d.error);let c={workflow_run_id:o.workflow_run_id,investor_id:t.id,deal_id:_.deal_id,signer_email:i?.email||a.email,signer_name:n,document_type:"nda",google_drive_file_id:s.id,google_drive_url:s.webContentLink||s.webViewLink,signer_role:"admin",signature_position:"party_b"},u=await (0,q.createSignatureRequest)(c,e);u.success?console.log(`üìß [NDA] Admin signature request created for ${r.full_name}'s NDA`):console.error("Failed to create admin signature request:",u.error)}catch(e){console.error(`Error creating signature requests for ${r.full_name}:`,e)}}else console.warn(`‚ö†Ô∏è [NDA] No workflow_run_id or n8n_response for ${r.full_name}`)}console.log(`‚úÖ [NDA] Completed processing ${F.length} NDA(s) for ${t.legal_name}`)}else console.log("‚ö†Ô∏è Skipping NDA workflow - missing data:",{hasInvestor:!!t,hasDeal:!!r,hasUser:!!a})}catch(e){console.error("‚ùå Error triggering NDA workflow:",e)}else console.log("‚ö†Ô∏è No deal interest found for entityId:",n);break;case"data_room_access_extension":let{data:u}=await e.from("deal_data_room_access").select("expires_at").eq("id",n).single();if(!u)return{success:!1,error:"Access record not found"};let p=new Date(u.expires_at),m=new Date(p);m.setDate(m.getDate()+7);let{error:f}=await e.from("deal_data_room_access").update({expires_at:m.toISOString(),notes:`Extended by 7 days upon approval on ${new Date().toLocaleDateString()}`}).eq("id",n);if(f)return console.error("Error extending data room access:",f),{success:!1,error:"Failed to extend data room access"};console.log("‚úÖ Data room access extended:",{access_id:n,old_expiry:u.expires_at,new_expiry:m.toISOString()});break;case"deal_subscription":let{error:g}=await e.from("deal_subscription_submissions").update({status:"approved",approved_by:r,approved_at:new Date().toISOString()}).eq("id",n);if(g)return console.error("Error approving subscription submission:",g),{success:!1,error:"Failed to approve subscription submission"};let{data:y}=await e.from("deal_subscription_submissions").select(`
            *,
            deal:deals!inner(
              id,
              name,
              vehicle_id,
              currency,
              company_name,
              company_logo_url,
              vehicle:vehicles(
                entity_code,
                investment_name,
                name
              )
            ),
            investor:investors!inner(
              display_name,
              legal_name
            )
          `).eq("id",n).single();if(y&&y.deal?.vehicle_id){let t=y.payload_json?.amount||y.payload_json?.subscription_amount||0,{data:r}=await e.from("subscriptions").select("id").eq("investor_id",y.investor_id).eq("vehicle_id",y.deal.vehicle_id).eq("deal_id",y.deal_id).single(),i=r?.id;if(!r){let{data:r}=await e.from("fee_plans").select("id").eq("deal_id",y.deal_id).eq("is_default",!0).eq("is_active",!0).single(),{data:a}=await e.from("deal_fee_structures").select("subscription_fee_percent, management_fee_percent, carried_interest_percent, price_per_share_text, price_per_share, cost_per_share, payment_deadline_days").eq("deal_id",y.deal_id).eq("status","published").order("created_at",{ascending:!1}).limit(1).single(),{data:n}=await e.from("valuations").select("nav_per_unit").eq("vehicle_id",y.deal.vehicle_id).order("as_of_date",{ascending:!1}).limit(1).maybeSingle(),s=null,o=null;if(r?.id){let{data:t}=await e.from("fee_components").select("kind, frequency, hurdle_rate_bps").eq("fee_plan_id",r.id).in("kind",["management","performance"]);if(t){let e=t.find(e=>"management"===e.kind),r=t.find(e=>"performance"===e.kind);s=e?.frequency||null,o=r?.hurdle_rate_bps?r.hurdle_rate_bps/100:null}}let{data:l}=await e.from("introductions").select("id, introducer_id").eq("prospect_investor_id",y.investor_id).eq("deal_id",y.deal_id).in("status",["allocated","joined"]).maybeSingle(),d=null;if(a?.price_per_share!=null&&a.price_per_share>0)d=a.price_per_share;else if(a?.price_per_share_text){let e=parseFloat(a.price_per_share_text.replace(/[^\d.]/g,""));!isNaN(e)&&e>0&&(d=e)}null===d&&n?.nav_per_unit&&(d=n.nav_per_unit);let c=a?.cost_per_share??null,_=d?Math.floor(t/d):null,u=null!==d&&null!==c&&d>0&&c>=0?d-c:null,p=a?.subscription_fee_percent||0,m=p>1?p/100:p,f=m>0?t*m:null,g=a?.payment_deadline_days?new Date(Date.now()+24*a.payment_deadline_days*36e5).toISOString().split("T")[0]:null,{data:v,error:b}=await e.from("subscriptions").insert({investor_id:y.investor_id,vehicle_id:y.deal.vehicle_id,deal_id:y.deal_id,fee_plan_id:r?.id||null,commitment:t,currency:y.deal.currency||"USD",status:"pending",subscription_date:new Date().toISOString(),effective_date:y.effective_date||new Date().toISOString(),acknowledgement_notes:`Approved from submission ${y.id}. Awaiting subscription pack signature.`,subscription_fee_percent:a?.subscription_fee_percent??null,management_fee_percent:a?.management_fee_percent??null,performance_fee_tier1_percent:a?.carried_interest_percent??null,opportunity_name:y.deal.vehicle?.investment_name||y.deal.name,price_per_share:d,cost_per_share:c,spread_per_share:u,spread_fee_amount:null!==u&&null!==_&&_>0?u*_:null,num_shares:_,subscription_fee_amount:f,management_fee_frequency:s,performance_fee_tier1_threshold:o,funding_due_at:g,introducer_id:l?.introducer_id||null,introduction_id:l?.id||null}).select().single();if(b||!v)return console.error("Error creating subscription:",b),{success:!1,error:"Failed to create subscription"};i=v.id,await e.from("deal_subscription_submissions").update({formal_subscription_id:i}).eq("id",y.id)}try{let{data:r}=await e.from("investors").select("legal_name, type, registered_address, entity_identifier").eq("id",y.investor_id).single(),n=null;if("entity"===y.subscription_type&&y.counterparty_entity_id){let{data:t}=await e.from("investor_counterparty").select("*").eq("id",y.counterparty_entity_id).single();n=t}let s=[];if(("entity"===y.subscription_type||r?.type==="entity"||r?.type==="institutional")&&y.investor_id){let{data:t}=await e.from("investor_members").select("id, full_name, email, role_title").eq("investor_id",y.investor_id).eq("is_signatory",!0).eq("is_active",!0);t&&t.length>0?(s=t.map((e,t)=>({name:e.full_name||"",title:e.role_title||"Authorized Signatory",number:t+1})),console.log(`üë• [SUBSCRIPTION PACK] Found ${s.length} authorized signatories for entity`)):(s=[{name:n?.representative_name||r?.legal_name||"",title:n?.representative_title||"Authorized Representative",number:1}],console.warn("[SUBSCRIPTION PACK] No signatories marked, using representative fallback"))}else s=[{name:r?.legal_name||"",title:"Investor",number:1}];let o=(e,t)=>{let r=1===e?"party_a":`party_a_${e}`;return t?`${r}_${t}`:r},l="position:absolute;left:0;top:0;font-size:1px;line-height:1px;color:#ffffff;opacity:0.01;",d=s.map(e=>`
            <div class="signature-block-inline" style="position:relative;margin-bottom: 0.5cm;">
                <div class="signature-line" style="position:relative;"><span style="${l}">SIG_ANCHOR:${o(e.number,"form")}</span></div>
                Name: ${e.name}<br>
                Title: ${e.title}
            </div>`).join(""),c=s.map(e=>`
<div class="signature-block" style="position:relative;margin-bottom: 1.5cm; min-height: 4cm;">
    <p><strong>The Subscriber</strong>, represented by Authorized Signatory ${e.number}</p>
    <div class="signature-line main-line" style="margin-top: 3cm; position:relative;"><span style="${l}">SIG_ANCHOR:${o(e.number)}</span></div>
    <p style="margin-top: 0.3cm;">Name: ${e.name}<br>
    Title: ${e.title}</p>
</div>`).join(""),_=s.map(e=>`
            <div style="margin-bottom: 0.5cm;">
                <div class="signature-line"></div>
                Name: ${e.name}<br>
                Title: ${e.title}
            </div>`).join(""),{data:u}=await e.from("vehicles").select("series_number, name, series_short_title, investment_name, issuer_gp_name, issuer_gp_rcc_number, issuer_rcc_number, issuer_website").eq("id",y.deal.vehicle_id).single(),{data:p}=await e.from("deal_fee_structures").select("*").eq("deal_id",y.deal_id).eq("status","published").order("created_at",{ascending:!1}).limit(1).single();if(r&&u&&p&&a){let o=parseFloat(p.price_per_share_text?.replace(/[^\d.]/g,"")||"0"),m=o>0?o:1;(!p.price_per_share_text||o<=0)&&console.warn("‚ö†Ô∏è [SUBSCRIPTION PACK] Missing price_per_share_text for deal:",y.deal_id,"- defaulting to $1.00");let f=Math.floor(t/m),g=p.subscription_fee_percent||0,v=g/100*t,b=t+v,h=new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),w=p.payment_deadline_days||10,q=new Date(Date.now()+24*w*36e5).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),$=n?n.legal_name:r.legal_name,I=n?n.entity_type.replace(/_/g," ").toUpperCase():r.type||"Corporate Entity",k=n&&n.registered_address?[n.registered_address.street,[n.registered_address.city,n.registered_address.state,n.registered_address.postal_code].filter(Boolean).join(", "),n.registered_address.country].filter(Boolean).join(", "):r.registered_address||"",D=n?`${n.legal_name}, a ${n.entity_type.replace(/_/g," ")} with registered office at ${k}`:`${r.legal_name}, ${r.type||"entity"} with registered office at ${r.registered_address||""}`,N=`
<div class="signature-block" style="position:relative;margin-bottom: 1.5cm; min-height: 4cm;">
    <p><strong>The Issuer, VERSO Capital 2 SCSP</strong>, duly represented by its general partner <strong>VERSO Capital 2 GP SARL</strong></p>
    <div class="signature-line main-line" style="margin-top: 3cm; position:relative;"><span style="${l}">SIG_ANCHOR:party_b</span></div>
    <p style="margin-top: 0.3cm;">Name: ${p.issuer_signatory_name||"Alexandre M√ºller"}<br>
    Title: ${p.issuer_signatory_title||"Authorized Signatory"}</p>
</div>`,C=`
<div class="signature-block" style="position:relative;margin-bottom: 1.5cm; min-height: 4cm;">
    <p><strong>The Attorney, Verso Management Ltd.</strong>, for the purpose of the powers granted under Clause 6</p>
    <div class="signature-line main-line" style="margin-top: 3cm; position:relative;"><span style="${l}">SIG_ANCHOR:party_c</span></div>
    <p style="margin-top: 0.3cm;">Name: ${p.arranger_person_name||"Julien Machot"}<br>
    Title: ${p.arranger_person_title||"Director"}</p>
</div>`;if(n){let e=n.registered_address;e&&e.street&&e.country||console.warn("‚ö†Ô∏è [SUBSCRIPTION PACK] Entity has incomplete address:",{entity:n.legal_name,missing:[!e?.street&&"street",!e?.country&&"country"].filter(Boolean)})}else r.registered_address||console.warn("‚ö†Ô∏è [SUBSCRIPTION PACK] Investor missing registered_address:",r.legal_name);let E=n&&n.representative_title?n.representative_title:"Authorized Representative",A=n?.representative_name||n?.legal_name||r.legal_name,R={output_format:"pdf",series_number:u.series_number||"",series_title:u.investment_name||u.name,series_short_title:u.series_short_title||"",ultimate_investment:y.deal.company_name||y.deal.name,subscriber_name:$,subscriber_type:I,subscriber_address:k,subscriber_block:D,subscriber_title:E,subscriber_representative_name:A,investment_logo_url:y.deal.company_logo_url||"",certificates_count:f.toString(),price_per_share:m.toFixed(2),subscription_amount:t.toFixed(2),subscription_fee_rate:`${g.toFixed(2)}%`,subscription_fee_amount:v.toFixed(2),subscription_fee_text:`${g.toFixed(2)}% upfront subscription fee`,total_subscription_price:b.toFixed(2),currency_code:y.deal.currency||"USD",currency_long:"USD"===y.deal.currency?"United States Dollars":y.deal.currency,management_fee_text:`${(p.management_fee_percent||0).toFixed(2)}% of net asset value per annum, calculated and payable quarterly`,performance_fee_text:`${(p.carried_interest_percent||0).toFixed(2)}% performance fee on realized gains`,escrow_fee_text:p.escrow_fee_text||"As per escrow agreement",management_fee_clause:p.management_fee_clause||`The Issuer shall charge a Management Fee of ${(p.management_fee_percent||0).toFixed(2)}% per annum of the net asset value of the Series, calculated on a quarterly basis and payable quarterly in advance.`,performance_fee_clause:p.performance_fee_clause||`The Issuer shall be entitled to a Performance Fee equal to ${(p.carried_interest_percent||0).toFixed(2)}% of the net profits generated by the Series.`,wire_bank_name:p.wire_bank_name||"Banque de Luxembourg",wire_bank_address:p.wire_bank_address||"14, boulevard Royal, L-2449 Luxembourg, Grand Duchy of Luxembourg",wire_account_holder:p.wire_account_holder||"Elvinger Hoss Prussen - Escrow Account",wire_escrow_agent:p.wire_escrow_agent||"Elvinger Hoss Prussen",wire_law_firm_address:p.wire_law_firm_address||"2 Place Winston Churchill, L-1340 Luxembourg, Grand Duchy of Luxembourg",wire_iban:p.wire_iban||"LU28 0019 4855 4447 1000",wire_bic:p.wire_bic||"BLUXLULL",wire_reference:p.wire_reference_format?.replace("{series}",u.series_number||"")||`${u.series_number}-${u.series_short_title}`,wire_description:p.wire_description_format||`Escrow account for ${u.name}`,wire_arranger:p.exclusive_arranger||"VERSO Management Ltd",wire_contact_email:p.wire_contact_email||"subscription@verso.capital",issuer_gp_name:u.issuer_gp_name||"VERSO Capital 2 GP SARL",issuer_gp_rcc_number:u.issuer_gp_rcc_number||"",issuer_rcc_number:u.issuer_rcc_number||"",issuer_website:u.issuer_website||"www.verso.capital",issuer_name:p.issuer_signatory_name||"Alexandre M√ºller",issuer_title:p.issuer_signatory_title||"Authorized Signatory",agreement_date:h,payment_deadline_days:w.toString(),payment_deadline_date:q,issue_within_business_days:(p.issue_within_business_days||5).toString(),recital_b_html:p.recital_b_html||`(B) The Issuer intends to issue Certificates which shall track equity interests in ${y.deal.company_name||y.deal.name}, and the Subscriber intends to subscribe for ${f} Certificates.`,arranger_name:p.arranger_person_name||"Julien Machot",arranger_title:p.arranger_person_title||"Director",arranger_company_name:p.exclusive_arranger||"VERSO Management",lpa_date:"",max_aggregate_amount:"100,000,000",selling_subscriber_name:$,accession_holder_name:$,accession_signatory_name:s[0]?.name||"",accession_signatory_title:s[0]?.title||"",signatories_table_html:_,signatories_form_html:d,signatories_signature_html:c,issuer_signature_html:N,arranger_signature_html:C};console.log("üîî Triggering Subscription Pack workflow:",{investor:r.legal_name,deal:y.deal.name,series:u.series_number,amount:t});let F=await (0,S.triggerWorkflow)({workflowKey:"generate-subscription-pack",payload:R,entityType:"deal_subscription",entityId:y.id,user:{id:a.id,email:a.email,displayName:a.displayName,role:a.role,title:a.title}});if(F.success){if(console.log("‚úÖ Subscription Pack workflow triggered successfully:",{investor:r.legal_name,workflow_run_id:F.workflow_run_id}),F.n8n_response)try{let t,r,n,s=F.n8n_response;console.log("üì¶ n8n response structure:",Object.keys(s)),console.log("üì¶ Full n8n response:",JSON.stringify(s,null,2));let o=y.deal?.vehicle?.entity_code||"UNKNOWN",l=y.deal?.vehicle?.investment_name||"INVESTMENT",d=y.investor?.display_name||y.investor?.legal_name||"INVESTOR",c=y.submitted_at;if(console.log("üìù Filename components:",{entityCode:o,investmentName:l,investorName:d,submittedAt:c}),s.binary){t=Buffer.from(s.binary),n=s.mimeType||"application/pdf";let e=T(o,l,d,c);r=s.filename||e+P(n),console.log("‚úÖ Received binary data, buffer size:",t.length,"mimeType:",n)}else if(s.raw&&"string"==typeof s.raw&&s.raw.length>0){let e=(t=Buffer.from(s.raw,"latin1")).slice(0,4).toString("hex");n="25504446"===e?"application/pdf":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",r=T(o,l,d,c)+P(n),console.log("‚úÖ Received binary data in raw format, buffer size:",t.length,"detected mimeType:",n)}else if(s.data){t=Buffer.from(s.data,"base64"),n=s.mimeType||"application/pdf";let e=T(o,l,d,c);r=s.filename||e+P(n)}else if("string"==typeof s&&s.length>0){let e=(t=Buffer.from(s,"latin1")).slice(0,4).toString("hex");n="25504446"===e?"application/pdf":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",r=T(o,l,d,c)+P(n),console.log("‚úÖ Received binary data as string, buffer size:",t.length,"detected mimeType:",n)}else throw Error("No binary data in n8n response");let _=t.slice(0,4).toString("hex");console.log("üìÑ Document file signature:",_,"| Expected:",r.endsWith(".pdf")?"25504446 (PDF)":"504b0304 (DOCX)"),r.endsWith(".pdf")&&"25504446"!==_?console.warn("‚ö†Ô∏è Warning: PDF file signature mismatch. Expected: 25504446, Got:",_):r.endsWith(".docx")&&"504b0304"!==_?console.warn("‚ö†Ô∏è Warning: DOCX file signature mismatch. Expected: 504b0304, Got:",_):console.log("‚úÖ File signature valid for",r);let u=`subscriptions/${y.id}/draft/${r}`,{error:m}=await e.storage.from("deal-documents").upload(u,t,{contentType:n,upsert:!1});if(m)console.error("‚ùå Failed to upload subscription pack:",m);else{console.log("‚úÖ Subscription pack uploaded to storage:",u);let r=null;if(y.deal.vehicle_id){let{data:t}=await e.from("document_folders").select("id").eq("vehicle_id",y.deal.vehicle_id).eq("name","Subscription Documents").single();r=t?.id||null}let s=p?.issuer_signatory_name||"Alexandre M√ºller",o=p?.issuer_signatory_title||"Authorized Signatory",{data:c,error:_}=await e.from("documents").insert({subscription_id:i,subscription_submission_id:y.id,deal_id:y.deal_id,vehicle_id:y.deal.vehicle_id,folder_id:r,type:"subscription_draft",name:`Subscription Pack (Draft) - ${l} - ${d}`,file_key:u,mime_type:n,file_size_bytes:t.length,status:"draft",current_version:1,created_by:a.id,countersigner_type:"ceo",countersigner_name:s,countersigner_title:o}).select().single();if(_)console.error("‚ùå Failed to create document record:",_);else{console.log("‚úÖ Subscription pack document created:",c.id);let t=new Date().toISOString();await e.from("subscriptions").update({pack_generated_at:t}).eq("id",i).is("pack_generated_at",null),await e.from("workflow_runs").update({output_data:{...F.n8n_response,document_id:c.id,file_key:u}}).eq("id",F.workflow_run_id)}}}catch(e){console.error("‚ùå Error processing subscription pack document:",e)}}else console.error("‚ùå Failed to trigger Subscription Pack workflow:",F.error)}}catch(e){console.error("Error triggering Subscription Pack workflow:",e)}return{success:!0,notificationData:{type:"subscription_approved",deal_name:y.deal.name,amount:t}}}break;case"commission_invoice":{let t=s.commission_type,i={introducer:{table:"introducer_commissions"},partner:{table:"partner_commissions"},"commercial-partner":{table:"commercial_partner_commissions"},commercial_partner:{table:"commercial_partner_commissions"}}[t];if(!i)return{success:!1,error:`Unsupported commission type: ${t}`};let{data:a,error:o}=await e.from(i.table).select("id, status").eq("id",n).single();if(o||!a)return{success:!1,error:"Commission not found"};if("invoice_submitted"!==a.status)return{success:!1,error:`Commission status must be invoice_submitted (current: ${a.status})`};let{error:l}=await e.from(i.table).update({status:"invoiced",approved_by:r,approved_at:new Date().toISOString(),rejection_reason:null,rejected_by:null,rejected_at:null,updated_at:new Date().toISOString()}).eq("id",n);if(l)return console.error("Error approving commission invoice:",l),{success:!1,error:"Failed to approve commission invoice"};break}case"document":let{error:v}=await e.from("documents").update({status:"approved",approved_by:r,approved_at:new Date().toISOString()}).eq("id",n);if(v)return console.error("Error approving document:",v),{success:!1,error:"Failed to approve document"};break;case"wire_instruction":let{error:b}=await e.from("wire_instructions").update({status:"approved",approved_by:r,approved_at:new Date().toISOString()}).eq("id",n);if(b)return console.error("Error approving wire instruction:",b),{success:!1,error:"Failed to approve wire instruction"};break;case"sale_request":let{error:w}=await e.from("investor_sale_requests").update({status:"approved",approved_at:new Date().toISOString()}).eq("id",n);if(w)return console.error("Error approving sale request:",w),{success:!1,error:"Failed to approve sale request"};console.log("Sale request approved:",n);break;case"gdpr_deletion_request":let{data:D}=await e.from("profiles").select("email, display_name").eq("id",n).single();if(!D)return{success:!1,error:"User profile not found"};let N=`deleted_${n.substring(0,8)}@anonymized.local`,C=`Deleted User ${n.substring(0,8)}`,{error:E}=await e.from("profiles").update({display_name:C,full_name:C,email:N,phone:null,avatar_url:null,is_active:!1,metadata:{gdpr_deleted:!0,deleted_at:new Date().toISOString(),original_email_hash:Buffer.from(D.email||"").toString("base64").substring(0,16),approved_by:r}}).eq("id",n);if(E)return console.error("Error anonymizing profile:",E),{success:!1,error:"Failed to anonymize profile"};let{data:A}=await e.from("investor_users").select("investor_id").eq("user_id",n).single();return A?.investor_id&&await e.from("investors").update({legal_name:C,display_name:C,email:N,phone:null,registered_address:null,representative_name:null,is_deleted:!0,deleted_at:new Date().toISOString()}).eq("id",A.investor_id),await e.from("investor_notifications").delete().eq("user_id",n),await e.from("audit_logs").update({action_details:e.rpc("jsonb_set",{target:"action_details",path:"{actor_anonymized}",value:'"true"'})}).eq("actor_id",n),console.log("GDPR deletion completed for user:",n),await h.auditLogger.log({actor_user_id:r,action:"gdpr_deletion_completed",entity:"profile",entity_id:n,metadata:{original_email_hash:Buffer.from(D.email||"").toString("base64").substring(0,16),approval_id:t.id,gdpr_article:"17"}}),{success:!0,notificationData:{type:"gdpr_deletion_completed",user_id:n}};case"arranger_profile_update":let F=s.requested_changes||{},O={};if(F.email&&(O.email=F.email),F.phone&&(O.phone=F.phone),F.address&&(O.address=F.address),Object.keys(O).length>0){O.updated_at=new Date().toISOString();let{error:t}=await e.from("arranger_entities").update(O).eq("id",n);if(t)return console.error("Error updating arranger profile:",t),{success:!1,error:"Failed to update arranger profile"}}return t.requested_by&&await e.from("investor_notifications").insert({user_id:t.requested_by,investor_id:null,title:"Profile Update Approved",message:"Your profile update request has been approved and applied.",link:"/versotech_main/arranger-profile"}),{success:!0,notificationData:{type:"arranger_profile_updated",arranger_id:n}};case"member_invitation":let{data:j,error:U}=await e.from("member_invitations").select("*").eq("id",n).single();if(U||!j)return console.error("Error fetching invitation:",U),{success:!1,error:"Member invitation not found"};if("pending_approval"!==j.status)return{success:!1,error:"Invitation is not pending approval"};let M=new Date(Date.now()+6048e5).toISOString(),L=new Date().toISOString(),{error:B}=await e.from("member_invitations").update({status:"pending",expires_at:M,sent_at:L,reminder_count:0,last_reminded_at:null}).eq("id",n);if(B)return console.error("Error updating invitation status:",B),{success:!1,error:"Failed to update invitation status"};let z=`${(0,k.getAppUrl)()}/invitation/accept?token=${j.invitation_token}`;console.log("[member_invitation] Sending invitation email:",{email:j.email,entityName:j.entity_name,acceptUrl:z});let H=await (0,I.sendInvitationEmail)({email:j.email,inviteeName:void 0,entityName:j.entity_name||s.entity_name||"the organization",entityType:j.entity_type,role:j.role,inviterName:j.invited_by_name||"A team member",acceptUrl:z,expiresAt:M});return H.success?console.log("[member_invitation] Email sent successfully:",H.messageId):(console.error("[member_invitation] Failed to send invitation email:",H.error),console.error("[member_invitation] Email details:",{to:j.email,acceptUrl:z,entityType:j.entity_type})),j.invited_by&&await e.from("investor_notifications").insert({user_id:j.invited_by,title:"Member Invitation Approved",message:`Your invitation to ${j.email} has been approved and sent.`,type:"member_invitation_approved",data:{invitation_id:n,invitee_email:j.email,entity_type:j.entity_type}}),console.log("‚úÖ Member invitation approved and email sent:",{invitation_id:n,email:j.email,entity_type:j.entity_type,email_sent:H.success}),{success:!0,notificationData:{type:"member_invitation_approved",invitation_id:n,email:j.email,email_sent:H.success}};default:console.log(`No specific approval handler for entity type: ${i}`)}return{success:!0}}catch(e){return console.error("Entity approval handler error:",e),{success:!1,error:"Failed to process entity approval"}}}async function M(e,t,r,i){try{let a=t.entity_type,n=t.entity_id;if("deal_interest"===a&&await e.from("investor_deal_interest").update({status:"rejected",rejection_reason:r,updated_at:new Date().toISOString()}).eq("id",n),"deal_subscription"===a&&await e.from("deal_subscription_submissions").update({status:"rejected",rejection_reason:r,updated_at:new Date().toISOString()}).eq("id",n),"investor_onboarding"===a&&await e.from("investors").update({kyc_status:"rejected",kyc_rejected_reason:r,kyc_rejected_at:new Date().toISOString()}).eq("id",n),"allocation"===a&&await e.from("allocations").update({status:"rejected",rejection_reason:r}).eq("id",n),"deal_close"===a||"termsheet_close"===a)return;if("sale_request"===a&&await e.from("investor_sale_requests").update({status:"rejected",rejection_reason:r,updated_at:new Date().toISOString()}).eq("id",n),"gdpr_deletion_request"===a&&await e.from("investor_notifications").insert({user_id:n,title:"Deletion Request Rejected",message:`Your account deletion request was rejected. Reason: ${r||"No reason provided"}`,type:"gdpr_request_rejected",metadata:{approval_id:t.id,rejection_reason:r}}),"arranger_profile_update"===a&&t.requested_by&&await e.from("investor_notifications").insert({user_id:t.requested_by,investor_id:null,title:"Profile Update Rejected",message:`Your profile update request was rejected. ${r?`Reason: ${r}`:""}`,link:"/versotech_main/arranger-profile"}),"member_invitation"===a&&(await e.from("member_invitations").update({status:"rejected"}).eq("id",n),t.requested_by)){let i=t.entity_metadata||{};await e.from("investor_notifications").insert({user_id:t.requested_by,title:"Member Invitation Rejected",message:`Your invitation to ${i.email||"the user"} was rejected. ${r?`Reason: ${r}`:""}`,type:"member_invitation_rejected",metadata:{invitation_id:n,invitee_email:i.email,entity_type:i.entity_type,rejection_reason:r}})}if("commission_invoice"===a){let a=t.entity_metadata||{},s=a.commission_type,o={introducer:{table:"introducer_commissions",userTable:"introducer_users",entityIdField:"introducer_id",notificationType:"introducer_invoice_rejected"},partner:{table:"partner_commissions",userTable:"partner_users",entityIdField:"partner_id",notificationType:"partner_rejected"},"commercial-partner":{table:"commercial_partner_commissions",userTable:"commercial_partner_users",entityIdField:"commercial_partner_id",notificationType:"cp_invoice_rejected"},commercial_partner:{table:"commercial_partner_commissions",userTable:"commercial_partner_users",entityIdField:"commercial_partner_id",notificationType:"cp_invoice_rejected"}}[s];if(!o)return void console.error("Unsupported commission type in rejection:",s);await e.from(o.table).update({status:"rejected",rejection_reason:r||null,rejected_by:i,rejected_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",n);let{data:l}=await e.from(o.table).select("*").eq("id",n).single();if(l){let t=l[o.entityIdField],{data:i}=await e.from(o.userTable).select("user_id").eq(o.entityIdField,t);if(i&&i.length>0){let t=a.amount&&a.currency?new Intl.NumberFormat("en-US",{style:"currency",currency:a.currency}).format(a.amount):"your commission",n=i.map(e=>({user_id:e.user_id,investor_id:null,title:"Invoice Requires Changes",message:`Your invoice for ${t} was rejected.${r?` Reason: ${r}`:""} Please resubmit with corrections.`,link:"/versotech_main/my-commissions",type:o.notificationType}));await e.from("investor_notifications").insert(n),console.log("[rejection] Sent",n.length,"rejection notifications for",s)}}}}catch(e){console.error("Entity rejection handler error:",e)}}async function L(e,{params:t}){try{let{id:e}=await t;await (0,b.requireStaffAuth)();let r=await (0,v.createClient)(),{error:i}=await r.from("approvals").update({deleted_at:new Date().toISOString()}).eq("id",e);if(i)return console.error("Approval deletion error:",i),w.NextResponse.json({error:"Failed to delete approval"},{status:500});return w.NextResponse.json({success:!0})}catch(e){return console.error("Approval deletion error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["DELETE",()=>L,"POST",()=>j],38815);var B=e.i(38815);let z=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/approvals/[id]/action/route",pathname:"/api/approvals/[id]/action",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/approvals/[id]/action/route.ts",nextConfigOutput:"",userland:B}),{workAsyncStorage:H,workUnitAsyncStorage:G,serverHooks:K}=z;function V(){return(0,i.patchFetch)({workAsyncStorage:H,workUnitAsyncStorage:G})}async function Y(e,t,i){z.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/approvals/[id]/action/route";v=v.replace(/\/index$/,"")||"/";let b=await z.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!b)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:h,params:w,nextConfig:S,parsedUrl:q,isDraftMode:$,prerenderManifest:I,routerServerContext:k,isOnDemandRevalidate:D,revalidateOnlyGenerated:N,resolvedPathname:C,clientReferenceManifest:E,serverActionsManifest:A}=b,R=(0,o.normalizeAppPath)(v),F=!!(I.dynamicRoutes[R]||I.routes[C]),x=async()=>((null==k?void 0:k.render404)?await k.render404(e,t,q,!1):t.end("This page could not be found"),null);if(F&&!$){let e=!!I.routes[C],t=I.dynamicRoutes[R];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await x();throw new g.NoFallbackError}}let O=null;!F||z.isDev||$||(O="/index"===(O=C)?"/":O);let T=!0===z.isDev||!F,P=F&&!T;A&&E&&(0,s.setManifestsSingleton)({page:v,clientReferenceManifest:E,serverActionsManifest:A});let j=e.method||"GET",U=(0,n.getTracer)(),M=U.getActiveScopeSpan(),L={params:w,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:T,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i,a)=>z.onRequestError(e,t,i,a,k)},sharedContext:{buildId:h}},B=new l.NodeNextRequest(e),H=new l.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let s=async e=>z.handle(G,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=U.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${j} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${v}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var n,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&D&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(a);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!F)return await (0,u.sendResponse)(B,H,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,i=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==r?void 0:r.isStale)&&await z.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:D})},!1,k),t}},c=await z.handleResponse({req:e,nextConfig:S,cacheKey:O,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:i.waitUntil,isMinimalMode:o});if(!F)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",D?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),$&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,p.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&F||g.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,u.sendResponse)(B,H,new Response(c.value.body,{headers:g,status:c.value.status||200})),null};M?await l(M):await U.withPropagatedContext(e.headers,()=>U.trace(c.BaseServerSpan.handleRequest,{spanName:`${j} ${v}`,kind:n.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await z.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:D})},!1,k),F)throw t;return await (0,u.sendResponse)(B,H,new Response(null,{status:500})),null}}e.s(["handler",()=>Y,"patchFetch",()=>V,"routeModule",()=>z,"serverHooks",()=>K,"workAsyncStorage",()=>H,"workUnitAsyncStorage",()=>G],310412)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_e1fd4f3f.js.map