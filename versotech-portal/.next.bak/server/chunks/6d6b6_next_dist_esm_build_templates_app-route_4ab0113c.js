module.exports=[174631,e=>{"use strict";var t=e.i(779444),i=e.i(698261),r=e.i(821776),a=e.i(796417),n=e.i(856890),o=e.i(26996),s=e.i(436944),d=e.i(88281),l=e.i(765944),c=e.i(984788),u=e.i(237011),m=e.i(712007),p=e.i(777657),_=e.i(13180),f=e.i(273827),y=e.i(193695);e.i(947956);var h=e.i(36217),g=e.i(414131),v=e.i(433669),R=e.i(107854);let w=R.z.object({payment_reference:R.z.string().optional(),entity_type:R.z.enum(["partner","introducer","commercial_partner","commercial-partner"]).optional(),commission_type:R.z.enum(["partner","introducer","commercial-partner"]).optional()}),b={partner:{table:"partner_commissions",userTable:"partner_users",entityIdField:"partner_id",entityTable:"partners",commissionLink:"/versotech_main/my-commissions",arrangerLink:"/versotech_main/payment-requests"},introducer:{table:"introducer_commissions",userTable:"introducer_users",entityIdField:"introducer_id",entityTable:"introducers",commissionLink:"/versotech_main/my-commissions",arrangerLink:"/versotech_main/payment-requests"},commercial_partner:{table:"commercial_partner_commissions",userTable:"commercial_partner_users",entityIdField:"commercial_partner_id",entityTable:"commercial_partners",commissionLink:"/versotech_main/my-commissions",arrangerLink:"/versotech_main/payment-requests"}};async function E(e,{params:t}){try{let{id:i}=await t,r=await (0,v.createClient)(),a=(0,v.createServiceClient)(),{data:{user:n}}=await r.auth.getUser();if(!n)return g.NextResponse.json({error:"Unauthorized"},{status:401});let{data:o}=await r.from("profiles").select("role").eq("id",n.id).single();if(!(o?.role?.startsWith("staff_")||o?.role==="ceo"))return g.NextResponse.json({error:"Forbidden - Staff only"},{status:403});let s=await e.json().catch(()=>({})),d=w.safeParse(s),l=d.success?d.data:{},c=l.payment_reference,u="introducer";l.entity_type?u="commercial-partner"===l.entity_type?"commercial_partner":l.entity_type:l.commission_type&&(u="commercial-partner"===l.commission_type?"commercial_partner":l.commission_type);let m=b[u],{data:p,error:_}=await a.from(m.table).select(`
        id, status, accrual_amount, currency, arranger_id,
        ${m.entityIdField}
      `).eq("id",i).single();if(_||!p)return g.NextResponse.json({error:"Commission not found"},{status:404});let{error:f}=await a.from(m.table).update({status:"paid",paid_at:new Date().toISOString(),payment_reference:c||null}).eq("id",i);if(f)return console.error("Error marking commission as paid:",f),g.NextResponse.json({error:"Failed to mark commission as paid"},{status:500});let y=null;if("introducer"===u)try{let{data:e}=await a.from("introducer_commissions").select("introducer_id, deal_id, investor_id, fee_plan_id, rate_bps").eq("id",i).single();if(e){let{data:t}=await a.from("investors").select("email").eq("id",e.investor_id).single(),r=t?.email||null,o=null;if(r){let{data:t}=await a.from("introductions").select("id").eq("prospect_email",r).eq("deal_id",e.deal_id).maybeSingle();o=t}if(!o){let{data:t}=await a.from("introductions").select("id").eq("prospect_investor_id",e.investor_id).eq("deal_id",e.deal_id).maybeSingle();o=t}if(o)y=o.id,await a.from("introductions").update({prospect_investor_id:e.investor_id,status:"allocated"}).eq("id",o.id).is("prospect_investor_id",null),await a.from("introducer_commissions").update({introduction_id:o.id}).eq("id",i),console.log(`[mark-paid] Linked commission ${i} to existing introduction ${o.id}`);else{let t=r||`investor-${e.investor_id}@placeholder.local`,{data:o,error:s}=await a.from("introductions").insert({introducer_id:e.introducer_id,prospect_email:t,prospect_investor_id:e.investor_id,deal_id:e.deal_id,status:"allocated",introduced_at:new Date().toISOString().split("T")[0],commission_rate_override_bps:e.rate_bps,created_by:n.id}).select("id").single();if(o&&!s)y=o.id,await a.from("introducer_commissions").update({introduction_id:o.id}).eq("id",i),console.log(`[mark-paid] Created introduction ${o.id} for commission ${i}`);else if(s)if("23505"===s.code){let{data:r}=await a.from("introductions").select("id").eq("prospect_email",t).eq("deal_id",e.deal_id).maybeSingle();r&&(y=r.id,await a.from("introducer_commissions").update({introduction_id:r.id}).eq("id",i),console.log(`[mark-paid] Linked to existing introduction ${r.id} after constraint conflict`))}else console.error("[mark-paid] Error creating introduction:",s)}}}catch(e){console.error("[mark-paid] Error in introduction creation:",e)}let{data:h}=await a.from(m.entityTable).select("name, legal_name").eq("id",p[m.entityIdField]).single(),R=h?.name||h?.legal_name||"Entity",E=new Intl.NumberFormat("en-US",{style:"currency",currency:p.currency||"USD"}).format(p.accrual_amount),C=[],k="commercial_partner"===u?"cp_payment_confirmed":"partner"===u?"partner_paid":"introducer_payment_confirmed",{data:x}=await a.from(m.userTable).select("user_id").eq(m.entityIdField,p[m.entityIdField]);if(x&&x.length>0)for(let e of x)C.push({user_id:e.user_id,investor_id:null,title:"Payment Confirmed",message:`Your commission payment of ${E} has been processed.${c?` Reference: ${c}`:""}`,link:m.commissionLink,type:k});let{data:q}=await a.from("arranger_users").select("user_id").eq("arranger_id",p.arranger_id);if(q&&q.length>0)for(let e of q)C.push({user_id:e.user_id,investor_id:null,title:"Commission Payment Completed",message:`Payment of ${E} to ${R} has been confirmed.${c?` Reference: ${c}`:""}`,link:m.arrangerLink,type:k});return C.length>0&&(await a.from("investor_notifications").insert(C),console.log(`[mark-paid] Sent ${C.length} payment confirmation notifications`)),await a.from("audit_logs").insert({event_type:"commission",action:"marked_paid",entity_type:m.table.replace("_commissions","_commission"),entity_id:i,actor_id:n.id,action_details:{description:"Commission marked as paid",entity_type:u,amount:p.accrual_amount,currency:p.currency,payment_reference:c||null,notifications_sent:C.length,introduction_id:y},timestamp:new Date().toISOString()}),g.NextResponse.json({success:!0,message:"Commission marked as paid",notifications_sent:C.length,introduction_id:y})}catch(e){return console.error("Error in mark-paid route:",e),g.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["POST",()=>E],598991);var C=e.i(598991);let k=new t.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/staff/fees/commissions/[id]/mark-paid/route",pathname:"/api/staff/fees/commissions/[id]/mark-paid",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/staff/fees/commissions/[id]/mark-paid/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:x,workUnitAsyncStorage:q,serverHooks:S}=k;function T(){return(0,r.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:q})}async function N(e,t,r){k.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/staff/fees/commissions/[id]/mark-paid/route";g=g.replace(/\/index$/,"")||"/";let v=await k.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:w,nextConfig:b,parsedUrl:E,isDraftMode:C,prerenderManifest:x,routerServerContext:q,isOnDemandRevalidate:S,revalidateOnlyGenerated:T,resolvedPathname:N,clientReferenceManifest:A,serverActionsManifest:P}=v,I=(0,s.normalizeAppPath)(g),O=!!(x.dynamicRoutes[I]||x.routes[N]),$=async()=>((null==q?void 0:q.render404)?await q.render404(e,t,E,!1):t.end("This page could not be found"),null);if(O&&!C){let e=!!x.routes[N],t=x.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await $();throw new y.NoFallbackError}}let U=null;!O||k.isDev||C||(U="/index"===(U=N)?"/":U);let F=!0===k.isDev||!O,D=O&&!F;P&&A&&(0,o.setManifestsSingleton)({page:g,clientReferenceManifest:A,serverActionsManifest:P});let H=e.method||"GET",j=(0,n.getTracer)(),L=j.getActiveScopeSpan(),M={params:w,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:F,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,r,a)=>k.onRequestError(e,t,r,a,q)},sharedContext:{buildId:R}},K=new d.NodeNextRequest(e),z=new d.NodeNextResponse(t),B=l.NextRequestAdapter.fromNodeNextRequest(K,(0,l.signalFromNodeResponse)(t));try{let o=async e=>k.handle(B,M).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=j.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=i.get("next.route");if(r){let t=`${H} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${g}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),d=async a=>{var n,d;let l=async({previousCacheEntry:i})=>{try{if(!s&&S&&T&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(a);e.fetchMetrics=M.renderOpts.fetchMetrics;let d=M.renderOpts.pendingWaitUntil;d&&r.waitUntil&&(r.waitUntil(d),d=void 0);let l=M.renderOpts.collectedTags;if(!O)return await (0,m.sendResponse)(K,z,n,M.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[f.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,r=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:r}}}}catch(t){throw(null==i?void 0:i.isStale)&&await k.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:S})},!1,q),t}},c=await k.handleResponse({req:e,nextConfig:b,cacheKey:U,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:T,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:s});if(!O)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",S?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,p.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&O||y.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,_.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(K,z,new Response(c.value.body,{headers:y,status:c.value.status||200})),null};L?await d(L):await j.withPropagatedContext(e.headers,()=>j.trace(c.BaseServerSpan.handleRequest,{spanName:`${H} ${g}`,kind:n.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},d))}catch(t){if(t instanceof y.NoFallbackError||await k.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:S})},!1,q),O)throw t;return await (0,m.sendResponse)(K,z,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>T,"routeModule",()=>k,"serverHooks",()=>S,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>q],174631)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_4ab0113c.js.map