module.exports=[454543,e=>{"use strict";var t=e.i(779444),r=e.i(698261),a=e.i(821776),n=e.i(796417),i=e.i(856890),s=e.i(26996),o=e.i(436944),l=e.i(88281),d=e.i(765944),u=e.i(984788),c=e.i(237011),g=e.i(712007),p=e.i(777657),_=e.i(13180),m=e.i(273827),f=e.i(193695);e.i(947956);var R=e.i(36217),y=e.i(414131),h=e.i(433669),v=e.i(107854),E=e.i(400589),A=e.i(66044);let w=v.z.object({signatory_member_ids:v.z.array(v.z.string().uuid()).optional(),countersigner_type:v.z.enum(["ceo","arranger"]).optional().default("ceo"),arranger_id:v.z.string().uuid().optional()}).optional();async function N(e,{params:t}){let{id:r,documentId:a}=await t,n=await (0,h.createClient)(),{data:{user:i},error:s}=await n.auth.getUser();if(s||!i)return y.NextResponse.json({error:"Unauthorized"},{status:401});let{data:o}=await n.from("profiles").select("role, display_name, email").eq("id",i.id).single();if(!(o?.role?.startsWith("staff_")||o?.role==="ceo"))return y.NextResponse.json({error:"Staff access required"},{status:403});let l={};try{let t=await e.text();if(t&&(l=JSON.parse(t),!w.safeParse(l).success))return y.NextResponse.json({error:"Invalid request body"},{status:400})}catch{}let d=(0,h.createServiceClient)(),{data:u}=await d.from("documents").select("*").eq("id",a).eq("subscription_id",r).single();if(!u)return y.NextResponse.json({error:"Document not found"},{status:404});let c=u.mime_type?.includes("wordprocessingml")||u.mime_type?.includes("msword")||u.file_key?.toLowerCase().endsWith(".docx")||u.file_key?.toLowerCase().endsWith(".doc"),g="application/pdf"===u.mime_type||u.file_key?.toLowerCase().endsWith(".pdf"),p=u,_=a;if(g)console.log("‚úÖ [READY-FOR-SIGNATURE] Document is already PDF, skipping conversion");else if(c){console.log("üìÑ [READY-FOR-SIGNATURE] DOCX detected, converting to PDF via Gotenberg");let{data:e,error:t}=await d.storage.from("deal-documents").download(u.file_key);if(t||!e)return console.error("‚ùå Failed to download DOCX for conversion:",t),y.NextResponse.json({error:"Failed to download document for conversion",details:t?.message},{status:500});let a=Buffer.from(await e.arrayBuffer());console.log("üì• Downloaded DOCX:",{size:a.length});let n=u.name||"document.docx";n.toLowerCase().endsWith(".docx")||n.toLowerCase().endsWith(".doc")||(n=`${n}.docx`);let s=await (0,A.convertDocxToPdf)(a,n);if(!s.success||!s.pdfBuffer)return console.error("‚ùå Gotenberg conversion failed:",s.error),y.NextResponse.json({error:"Failed to convert DOCX to PDF",details:s.error||"Conversion service unavailable"},{status:500});console.log("‚úÖ DOCX converted to PDF:",{input_size:a.length,output_size:s.pdfBuffer.length});let o=u.file_key.replace(/\.(docx?|DOCX?)$/,".pdf"),l=o.includes("/converted/")?o:o.replace(/\/([^/]+)$/,"/converted/$1"),{error:c}=await d.storage.from("deal-documents").upload(l,s.pdfBuffer,{contentType:"application/pdf",upsert:!0});if(c)return console.error("‚ùå Failed to upload converted PDF:",c),y.NextResponse.json({error:"Failed to save converted PDF",details:c.message},{status:500});console.log("üì§ Uploaded converted PDF:",l);let g=(u.name||"Document").replace(/\.(docx?|DOCX?)$/i,".pdf"),{data:m,error:f}=await d.from("documents").insert({subscription_id:r,deal_id:u.deal_id,vehicle_id:u.vehicle_id,folder_id:u.folder_id,type:"subscription_pack",name:g,file_key:l,mime_type:"application/pdf",file_size_bytes:s.pdfBuffer.length,status:"final",ready_for_signature:!1,current_version:1,created_by:i.id}).select().single();if(f||!m)return console.error("‚ùå Failed to create PDF document record:",f),y.NextResponse.json({error:"Failed to create document record for converted PDF",details:f?.message},{status:500});console.log("‚úÖ Created PDF document record:",m.id),await d.from("documents").update({status:"draft",metadata:{converted_to_pdf:m.id,converted_at:new Date().toISOString()}}).eq("id",u.id),p=m,_=m.id,console.log("üîÑ Proceeding with converted PDF for signature:",{original_docx_id:u.id,new_pdf_id:m.id})}else if(u.mime_type&&!u.mime_type.includes("pdf"))return y.NextResponse.json({error:"Unsupported file format. Only PDF and DOCX files can be sent for signature.",details:`Current file type: ${u.mime_type}`},{status:400});console.log("üîç [READY-FOR-SIGNATURE] Fetching subscription...");let{data:m}=await d.from("subscriptions").select(`
      *,
      investor:investors(
        id,
        type,
        legal_name,
        display_name,
        email,
        investor_users!inner(user_id)
      ),
      vehicle:vehicles(id, name)
    `).eq("id",r).single();if(!m)return y.NextResponse.json({error:"Subscription not found"},{status:404});console.log("‚úÖ [READY-FOR-SIGNATURE] Subscription fetched:",{investor_type:m.investor?.type}),console.log("üîç [READY-FOR-SIGNATURE] Checking existing requests...");let{data:f}=await d.from("signature_requests").select("id, signer_role, status").eq("document_id",_).in("status",["pending","signed"]);if(f&&f.length>0){let e=f.filter(e=>"pending"===e.status).length,t=f.filter(e=>"signed"===e.status).length;return y.NextResponse.json({error:"Signature requests already exist for this document",details:`Found ${e} pending and ${t} signed signature request(s). Cannot create duplicates.`,existing_requests:f.map(e=>({id:e.id,role:e.signer_role,status:e.status}))},{status:409})}console.log("‚úÖ [READY-FOR-SIGNATURE] No existing requests, proceeding...");let{data:R}=await d.storage.from("deal-documents").createSignedUrl(p.file_key,604800);if(!R?.signedUrl)return y.NextResponse.json({error:"Failed to generate document URL"},{status:500});console.log("‚úÖ [READY-FOR-SIGNATURE] Got signed URL"),console.log("üîç [READY-FOR-SIGNATURE] Determining signatories...");let v=[];if(l.signatory_member_ids&&l.signatory_member_ids.length>0){let{data:e,error:t}=await d.from("investor_members").select("id, full_name, email").in("id",l.signatory_member_ids).eq("investor_id",m.investor_id).eq("is_active",!0);if(t||!e||0===e.length)return y.NextResponse.json({error:"Selected signatories not found",details:"Could not find the specified signatory members"},{status:400});v=e.map(e=>({id:e.id,full_name:e.full_name,email:e.email}))}else if("entity"===m.investor.type||"institutional"===m.investor.type){let{data:e}=await d.from("investor_members").select("id, full_name, email").eq("investor_id",m.investor_id).eq("is_signatory",!0).eq("is_active",!0);e&&e.length>0?(v=e.map(e=>({id:e.id,full_name:e.full_name,email:e.email})),console.log(`üë• [READY-FOR-SIGNATURE] Auto-fetched ${v.length} signatories for entity investor`)):(console.warn("[READY-FOR-SIGNATURE] Entity investor has no signatories marked, using investor name"),v=[{id:"investor_primary",full_name:m.investor.legal_name||m.investor.display_name,email:m.investor.email}])}else v=[{id:"investor_primary",full_name:m.investor.legal_name||m.investor.display_name,email:m.investor.email}];console.log("‚úÖ [READY-FOR-SIGNATURE] Signatories determined:",v.length);try{console.log("üîç [READY-FOR-SIGNATURE] Creating ISSUER (party_b) signature request...");let e=await (0,E.getCeoSigner)(d);if(!e||!e.email)return console.error("[ready-for-signature] CRITICAL: No CEO signer configured in ceo_users table"),y.NextResponse.json({error:"No CEO/Issuer signer configured. Please add a CEO user with can_sign=true in the CEO settings."},{status:400});let t=e.email,a=e.displayName;console.log("[ready-for-signature] Using configured CEO/Issuer signer for party_b:",{email:t,name:a}),console.log(`üîç [READY-FOR-SIGNATURE] Creating ISSUER signature request for ${a} (party_b)`);let n={investor_id:m.investor_id,signer_email:t,signer_name:a,document_type:"subscription",google_drive_url:R.signedUrl,signer_role:"admin",signature_position:"party_b",subscription_id:r,document_id:_,deal_id:m.deal_id},i=await fetch("http://localhost:3000/api/signature/request",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!i.ok){let e=await i.text();throw Error(`Failed to create Issuer (party_b) signature request: ${e}`)}let s=await i.json();console.log("‚úÖ [READY-FOR-SIGNATURE] Issuer (party_b) signature request created"),console.log("üîç [READY-FOR-SIGNATURE] Creating arranger (party_c) signature request..."),console.log("   Deal ID:",m.deal_id);let o=null,{data:l,error:u}=await d.from("deals").select("arranger_entity_id").eq("id",m.deal_id).single();if(u&&console.error("‚ùå [READY-FOR-SIGNATURE] Failed to fetch deal for arranger:",u.message),console.log("   Arranger entity ID:",l?.arranger_entity_id||"NOT SET"),!l?.arranger_entity_id)return console.error("‚ùå [READY-FOR-SIGNATURE] FATAL: No arranger entity linked to deal:",m.deal_id),y.NextResponse.json({error:"No arranger entity linked to this deal. Subscription packs require an arranger to sign as party_c. Please link an arranger entity to the deal."},{status:400});{let{data:e,error:t}=await d.from("arranger_entities").select("legal_name").eq("id",l.arranger_entity_id).single();t&&console.error("‚ùå [READY-FOR-SIGNATURE] Failed to fetch arranger entity:",t.message),console.log("   Arranger entity name:",e?.legal_name||"NOT FOUND");let{data:a,error:n}=await d.from("arranger_users").select("user_id").eq("arranger_id",l.arranger_entity_id).eq("can_sign",!0).eq("is_primary",!0).maybeSingle();n&&console.error("‚ùå [READY-FOR-SIGNATURE] Failed to fetch primary arranger user:",n.message),console.log("   Primary arranger user_id:",a?.user_id||"NOT FOUND");let i=a?.user_id;if(!i){console.log("   Looking for fallback arranger user with can_sign=true...");let{data:e,error:t}=await d.from("arranger_users").select("user_id").eq("arranger_id",l.arranger_entity_id).eq("can_sign",!0).limit(1).maybeSingle();t&&console.error("‚ùå [READY-FOR-SIGNATURE] Failed to fetch fallback arranger user:",t.message),i=e?.user_id,console.log("   Fallback arranger user_id:",i||"NOT FOUND")}if(!i)return console.error("‚ùå [READY-FOR-SIGNATURE] FATAL: No arranger user with can_sign=true found for arranger_id:",l.arranger_entity_id),y.NextResponse.json({error:`No arranger signer configured for ${e?.legal_name||"arranger entity"}. Please configure an arranger user with can_sign=true.`},{status:400});{let{data:t,error:a}=await d.from("profiles").select("email, display_name").eq("id",i).single();if(a&&console.error("‚ùå [READY-FOR-SIGNATURE] Failed to fetch arranger profile:",a.message),console.log("   Arranger profile:",t?.email,t?.display_name),!t?.email)return console.error("‚ùå [READY-FOR-SIGNATURE] FATAL: Arranger user has no email configured"),y.NextResponse.json({error:`Arranger user for ${e?.legal_name||"arranger entity"} has no email configured. Please update the arranger user's profile.`},{status:400});{let a={investor_id:m.investor_id,signer_email:t.email,signer_name:t.display_name||e?.legal_name||"Arranger",document_type:"subscription",google_drive_url:R.signedUrl,signer_role:"arranger",signature_position:"party_c",subscription_id:r,document_id:_,deal_id:m.deal_id};console.log("   Creating arranger signature request for:",t.email);let n=await fetch("http://localhost:3000/api/signature/request",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(n.ok)o=await n.json(),console.log("‚úÖ [READY-FOR-SIGNATURE] Arranger (party_c) signature request created:",o.signature_request_id);else{let e=await n.text();return console.error("‚ùå [READY-FOR-SIGNATURE] Failed to create arranger signature request:",e),y.NextResponse.json({error:"Failed to create arranger signature request",details:e},{status:500})}}}}console.log("üîç [READY-FOR-SIGNATURE] Creating investor signature requests (they sign AFTER company)...");let c=["party_a","party_a_2","party_a_3","party_a_4","party_a_5"],g=[];for(let e=0;e<v.length;e++){let t=v[e],a=c[e]||`party_a_${e+1}`;console.log(`üîç [READY-FOR-SIGNATURE] Creating investor signature ${e+1}/${v.length} for ${t.full_name}`);let n={investor_id:m.investor_id,signer_email:t.email,signer_name:t.full_name,document_type:"subscription",google_drive_url:R.signedUrl,signer_role:"investor",signature_position:a,subscription_id:r,document_id:_,deal_id:m.deal_id,member_id:"investor_primary"!==t.id?t.id:void 0,total_party_a_signatories:v.length},i=await fetch("http://localhost:3000/api/signature/request",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!i.ok){let e=await i.text();throw Error(`Failed to create investor signature request for ${t.full_name}: ${e}`)}let s=await i.json();g.push({signatory:t.full_name,email:t.email,...s})}console.log("‚úÖ [READY-FOR-SIGNATURE] All investor signatures created"),await d.from("documents").update({ready_for_signature:!0,status:"pending_signature",signature_status:"pending"}).eq("id",_);let p=new Date().toISOString();if(await d.from("subscriptions").update({pack_sent_at:p}).eq("id",r).is("pack_sent_at",null),await d.from("subscriptions").update({pack_generated_at:p}).eq("id",r).is("pack_generated_at",null),m.deal_id){let{data:e}=await d.from("deals").select("arranger_entity_id, name").eq("id",m.deal_id).single();if(e?.arranger_entity_id){let{data:t}=await d.from("arranger_users").select("user_id").eq("arranger_id",e.arranger_entity_id);if(t&&t.length>0){let r=m.investor?.display_name||m.investor?.legal_name||"Investor",a=e.name||"the deal",n=t.map(e=>({user_id:e.user_id,investor_id:null,title:"Subscription Pack Sent",message:`Subscription pack for ${r} (${a}) has been sent for signature.`,link:"/versotech_main/versosign"}));await d.from("investor_notifications").insert(n),console.log("üìß Notified arranger users about pack sent:",t.length)}}}return console.log("‚úÖ Multi-signatory signature requests created for subscription pack:",{document_id:_,investor_requests:g.length,issuer_request:s.signature_request_id,arranger_request:o?.signature_request_id||null}),y.NextResponse.json({success:!0,investor_signature_requests:g,issuer_request:s,issuer_name:a,arranger_request:o,countersigner_request:s,countersigner_type:"ceo",countersigner_name:a,total_signatories:v.length+1+ +!!o})}catch(e){return console.error("Error creating signature requests:",e),y.NextResponse.json({error:"Failed to initiate signature workflow",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}e.s(["POST",()=>N],232165);var O=e.i(232165);let S=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/subscriptions/[id]/documents/[documentId]/ready-for-signature/route",pathname:"/api/subscriptions/[id]/documents/[documentId]/ready-for-signature",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/subscriptions/[id]/documents/[documentId]/ready-for-signature/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:b,workUnitAsyncStorage:F,serverHooks:D}=S;function q(){return(0,a.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:F})}async function C(e,t,a){S.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/subscriptions/[id]/documents/[documentId]/ready-for-signature/route";y=y.replace(/\/index$/,"")||"/";let h=await S.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!h)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:E,nextConfig:A,parsedUrl:w,isDraftMode:N,prerenderManifest:O,routerServerContext:b,isOnDemandRevalidate:F,revalidateOnlyGenerated:D,resolvedPathname:q,clientReferenceManifest:C,serverActionsManifest:T}=h,x=(0,o.normalizeAppPath)(y),U=!!(O.dynamicRoutes[x]||O.routes[q]),I=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,w,!1):t.end("This page could not be found"),null);if(U&&!N){let e=!!O.routes[q],t=O.dynamicRoutes[x];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await I();throw new f.NoFallbackError}}let P=null;!U||S.isDev||N||(P="/index"===(P=q)?"/":P);let k=!0===S.isDev||!U,j=U&&!k;T&&C&&(0,s.setManifestsSingleton)({page:y,clientReferenceManifest:C,serverActionsManifest:T});let G=e.method||"GET",$=(0,i.getTracer)(),Y=$.getActiveScopeSpan(),H={params:E,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>S.onRequestError(e,t,a,n,b)},sharedContext:{buildId:v}},L=new l.NodeNextRequest(e),M=new l.NodeNextResponse(t),z=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let s=async e=>S.handle(z,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${G} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${G} ${y}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&F&&D&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=H.renderOpts.collectedTags;if(!U)return await (0,g.sendResponse)(L,M,i,H.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,a=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:F})},!1,b),t}},u=await S.handleResponse({req:e,nextConfig:A,cacheKey:P,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:F,revalidateOnlyGenerated:D,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!U)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",F?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,p.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&U||f.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,_.getCacheControlHeader)(u.cacheControl)),await (0,g.sendResponse)(L,M,new Response(u.value.body,{headers:f,status:u.value.status||200})),null};Y?await l(Y):await $.withPropagatedContext(e.headers,()=>$.trace(u.BaseServerSpan.handleRequest,{spanName:`${G} ${y}`,kind:i.SpanKind.SERVER,attributes:{"http.method":G,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:F})},!1,b),U)throw t;return await (0,g.sendResponse)(L,M,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>q,"routeModule",()=>S,"serverHooks",()=>D,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>F],454543)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_c34b84ed.js.map