module.exports=[57629,e=>{"use strict";var t=e.i(779444),r=e.i(698261),i=e.i(821776),a=e.i(796417),n=e.i(856890),s=e.i(26996),o=e.i(436944),d=e.i(88281),l=e.i(765944),u=e.i(984788),_=e.i(237011),p=e.i(712007),c=e.i(777657),f=e.i(13180),m=e.i(273827),h=e.i(193695);e.i(947956);var v=e.i(36217),y=e.i(433669),g=e.i(911357),b=e.i(414131),R=e.i(107854),w=e.i(221640),x=e.i(627291);let E=R.z.object({user_id:R.z.string().uuid().optional(),investor_id:R.z.string().uuid().optional(),email:R.z.string().email().optional(),role:R.z.enum(["investor","co_investor","partner_investor","introducer_investor","commercial_partner_investor","spouse","advisor","lawyer","banker","introducer","viewer","verso_staff"]),send_notification:R.z.boolean().default(!0),referred_by_entity_id:R.z.string().uuid().optional(),referred_by_entity_type:R.z.enum(["partner","introducer","commercial_partner"]).optional(),assigned_fee_plan_id:R.z.string().uuid().optional(),term_sheet_id:R.z.string().uuid().optional()}).refine(e=>e.user_id||e.investor_id||e.email,{message:"Must provide user_id, investor_id, or email"}).refine(e=>{let t=!!e.referred_by_entity_id;return!!e.referred_by_entity_type===t},{message:"Both referred_by_entity_id and referred_by_entity_type must be provided together"}).refine(e=>!e.referred_by_entity_id||!!e.assigned_fee_plan_id,{message:"assigned_fee_plan_id is required when adding member through an introducer/partner",path:["assigned_fee_plan_id"]});async function N(e,{params:t}){try{let e=await (0,y.createClient)(),{user:r,error:i}=await (0,w.getAuthenticatedUser)(e);if(i||!r)return b.NextResponse.json({error:"Unauthorized"},{status:401});let{id:a}=await t,{data:n,error:s}=await e.from("deal_memberships").select(`
        *,
        profiles:user_id (
          id,
          display_name,
          email
        ),
        investors:investor_id (
          id,
          legal_name,
          type
        ),
        invited_by_profile:invited_by (
          display_name,
          email
        ),
        assigned_fee_plan:assigned_fee_plan_id (
          id,
          name,
          status,
          introducer:introducer_id (id, legal_name, display_name),
          partner:partner_id (id, name, legal_name),
          commercial_partner:commercial_partner_id (id, name, legal_name)
        ),
        assigned_term_sheet:term_sheet_id (
          id,
          version,
          status,
          subscription_fee_percent,
          management_fee_percent,
          carried_interest_percent
        )
      `).eq("deal_id",a).order("invited_at",{ascending:!1});if(s)return console.error("Fetch members error:",s),b.NextResponse.json({error:"Failed to fetch members"},{status:500});return b.NextResponse.json({members:n||[]})}catch(e){return console.error("API /deals/[id]/members GET error:",e),b.NextResponse.json({error:"Internal server error"},{status:500})}}async function C(e,{params:t}){try{let r=(0,y.createServiceClient)(),i=await (0,y.createClient)(),{user:a,error:n}=await (0,w.getAuthenticatedUser)(i);if(n||!a)return b.NextResponse.json({error:"Unauthorized"},{status:401});if(!await (0,w.isStaffUser)(r,a))return b.NextResponse.json({error:"Staff access required"},{status:403});let{id:s}=await t,o=await e.json(),d=E.parse(o),l=d.user_id,u=d.investor_id;if(!l){if(d.email){let{data:e}=await r.from("profiles").select("id").eq("email",d.email).single();if(!e)return b.NextResponse.json({error:"User not found with provided email"},{status:404});l=e.id;let{data:t}=await r.from("investor_users").select("investor_id").eq("user_id",l).maybeSingle();t&&(u=t.investor_id)}else if(d.investor_id){let{data:e}=await r.from("investor_users").select("user_id").eq("investor_id",d.investor_id).limit(1).single();if(!e)return b.NextResponse.json({error:"No user found for provided investor"},{status:404});l=e.user_id,u=d.investor_id}}if(!l)return b.NextResponse.json({error:"Could not resolve user"},{status:400});if(d.referred_by_entity_id&&d.assigned_fee_plan_id){let e="partner"===d.referred_by_entity_type?{partner_id:d.referred_by_entity_id}:"introducer"===d.referred_by_entity_type?{introducer_id:d.referred_by_entity_id}:{commercial_partner_id:d.referred_by_entity_id},{data:t,error:i}=await r.from("fee_plans").select("id, status, is_active, partner_id, introducer_id, commercial_partner_id").eq("id",d.assigned_fee_plan_id).eq("deal_id",s).match(e).single();if(i||!t)return b.NextResponse.json({error:"Invalid fee plan",message:"The selected fee plan does not exist or does not belong to the specified entity for this deal."},{status:400});if(!t.is_active)return b.NextResponse.json({error:"Fee plan inactive",message:"The selected fee plan is no longer active. Please select a different fee plan."},{status:400});if("accepted"!==t.status)return b.NextResponse.json({error:"Fee plan not accepted",message:{draft:"The fee plan has not been sent to the entity yet. Please send it for approval first.",sent:"The fee plan has been sent but not yet accepted. Please wait for the entity to approve it.",rejected:"The fee plan was rejected by the entity. Please create and send a new fee plan.",pending_signature:"The fee plan is pending signature. Please wait for the signing process to complete."}[t.status]||`The fee plan status is '${t.status}'. Only accepted fee plans can be used.`},{status:400})}if(d.term_sheet_id){let{data:e,error:t}=await r.from("deal_fee_structures").select("id, status").eq("id",d.term_sheet_id).eq("deal_id",s).single();if(t||!e)return b.NextResponse.json({error:"Invalid term sheet",message:"The selected term sheet does not exist for this deal."},{status:400});if("published"!==e.status)return b.NextResponse.json({error:"Term sheet not published",message:"Only published term sheets can be assigned to investors."},{status:400})}let{data:_}=await r.from("deal_memberships").select("deal_id, user_id").eq("deal_id",s).eq("user_id",l).single();if(_)return b.NextResponse.json({error:"User is already a member of this deal"},{status:409});let{data:p,error:c}=await r.from("deal_memberships").insert({deal_id:s,user_id:l,investor_id:u,role:d.role,invited_by:a.id,accepted_at:new Date().toISOString(),referred_by_entity_id:d.referred_by_entity_id||null,referred_by_entity_type:d.referred_by_entity_type||null,assigned_fee_plan_id:d.assigned_fee_plan_id||null,term_sheet_id:d.term_sheet_id||null}).select(`
        *,
        profiles:user_id (
          id,
          display_name,
          email
        ),
        investors:investor_id (
          id,
          legal_name
        )
      `).single();if(c)return console.error("Create membership error:",c),b.NextResponse.json({error:"Failed to add member"},{status:500});if(d.send_notification&&l)try{let{data:e}=await r.from("deals").select("name").eq("id",s).single(),t=e?.name||"a deal";await (0,x.createInvestorNotification)({userId:l,investorId:u??void 0,title:"Deal Invitation",message:`You've been invited to view ${t}. Review the deal details and data room.`,link:`/versotech_main/opportunities/${s}`,type:"deal_invite",extraMetadata:{deal_id:s,role:d.role,invited_by:a.id}})}catch(e){console.error("[deal-members] Failed to send notification:",e)}return await g.auditLogger.log({actor_user_id:a.id,action:g.AuditActions.CREATE,entity:"deal_memberships",entity_id:s,metadata:{added_user_id:l,role:d.role,investor_id:u,referred_by_entity_id:d.referred_by_entity_id||null,referred_by_entity_type:d.referred_by_entity_type||null,assigned_fee_plan_id:d.assigned_fee_plan_id||null,term_sheet_id:d.term_sheet_id||null}}),b.NextResponse.json({membership:p},{status:201})}catch(e){if(e instanceof R.z.ZodError)return b.NextResponse.json({error:"Invalid request data",details:e.errors},{status:400});return console.error("API /deals/[id]/members POST error:",e),b.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>N,"POST",()=>C],532154);var T=e.i(532154);let A=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/deals/[id]/members/route",pathname:"/api/deals/[id]/members",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/deals/[id]/members/route.ts",nextConfigOutput:"",userland:T}),{workAsyncStorage:P,workUnitAsyncStorage:j,serverHooks:q}=A;function I(){return(0,i.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:j})}async function S(e,t,i){A.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/deals/[id]/members/route";y=y.replace(/\/index$/,"")||"/";let g=await A.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!g)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:b,params:R,nextConfig:w,parsedUrl:x,isDraftMode:E,prerenderManifest:N,routerServerContext:C,isOnDemandRevalidate:T,revalidateOnlyGenerated:P,resolvedPathname:j,clientReferenceManifest:q,serverActionsManifest:I}=g,S=(0,o.normalizeAppPath)(y),O=!!(N.dynamicRoutes[S]||N.routes[j]),U=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,x,!1):t.end("This page could not be found"),null);if(O&&!E){let e=!!N.routes[j],t=N.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await U();throw new h.NoFallbackError}}let H=null;!O||A.isDev||E||(H="/index"===(H=j)?"/":H);let k=!0===A.isDev||!O,D=O&&!k;I&&q&&(0,s.setManifestsSingleton)({page:y,clientReferenceManifest:q,serverActionsManifest:I});let z=e.method||"GET",F=(0,n.getTracer)(),M=F.getActiveScopeSpan(),$={params:R,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i,a)=>A.onRequestError(e,t,i,a,C)},sharedContext:{buildId:b}},K=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),L=l.NextRequestAdapter.fromNodeNextRequest(K,(0,l.signalFromNodeResponse)(t));try{let s=async e=>A.handle(L,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${z} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${z} ${y}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),d=async a=>{var n,d;let l=async({previousCacheEntry:r})=>{try{if(!o&&T&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(a);e.fetchMetrics=$.renderOpts.fetchMetrics;let d=$.renderOpts.pendingWaitUntil;d&&i.waitUntil&&(i.waitUntil(d),d=void 0);let l=$.renderOpts.collectedTags;if(!O)return await (0,p.sendResponse)(K,B,n,$.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,c.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,i=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==r?void 0:r.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:T})},!1,C),t}},u=await A.handleResponse({req:e,nextConfig:w,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:P,responseGenerator:l,waitUntil:i.waitUntil,isMinimalMode:o});if(!O)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",T?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,c.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&O||h.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(K,B,new Response(u.value.body,{headers:h,status:u.value.status||200})),null};M?await d(M):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${z} ${y}`,kind:n.SpanKind.SERVER,attributes:{"http.method":z,"http.target":e.url}},d))}catch(t){if(t instanceof h.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:T})},!1,C),O)throw t;return await (0,p.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>I,"routeModule",()=>A,"serverHooks",()=>q,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>j],57629)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_209366f9.js.map