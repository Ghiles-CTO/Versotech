module.exports=[918622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},270406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},193695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},433669,e=>{"use strict";e.i(814247);var t=e.i(150615),r=e.i(12049),i=e.i(57824);let n=async()=>{let e=await (0,i.cookies)();return(0,t.createServerClient)("https://ipguxdssecfexudnvtia.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ3V4ZHNzZWNmZXh1ZG52dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4MzcsImV4cCI6MjA3MzkzNzgzN30.AGxM_YW9hfxuu7xDpi_4xhOoRhYM7iGTS1vJ0z2FByE",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:i})=>{e.set(t,r,i)})}catch(e){}}}})};e.s(["createClient",0,n,"createServiceClient",0,()=>(0,r.createClient)("https://ipguxdssecfexudnvtia.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})])},911357,e=>{"use strict";var t=e.i(433669);class r{static instance;static getInstance(){return r.instance||(r.instance=new r),r.instance}async log(e){try{let r=await (0,t.createClient)();await r.from("audit_logs").insert({event_type:"system",actor_id:e.actor_user_id||null,action:e.action,entity_type:e.entity,entity_id:e.entity_id||null,action_details:e.metadata||null,timestamp:new Date().toISOString()})}catch(e){console.error("Audit logging failed:",e)}}async logMany(e){for(let t of e)await this.log(t)}}let i=r.getInstance();e.s(["AuditActions",0,{LOGIN:"login",LOGOUT:"logout",PASSWORD_CHANGE:"password_change",CREATE:"create",READ:"read",UPDATE:"update",DELETE:"delete",DOCUMENT_UPLOAD:"document_upload",DOCUMENT_DOWNLOAD:"document_download",DOCUMENT_DELETE:"document_delete",WORKFLOW_TRIGGER:"workflow_trigger",WORKFLOW_COMPLETED:"workflow_completed",WORKFLOW_FAILED:"workflow_failed",USER_CREATED:"user_created",PROFILE_UPDATED:"profile_updated",ROLE_CHANGED:"role_changed",SUBSCRIPTION_CREATED:"subscription_created",CAPITAL_CALL_CREATED:"capital_call_created",DISTRIBUTION_CREATED:"distribution_created",REPORT_REQUESTED:"report_requested",MESSAGE_SENT:"message_sent",COMMISSION_CREATED:"commission_created",COMMISSION_ACCRUED:"commission_accrued",COMMISSION_INVOICE_REQUESTED:"commission_invoice_requested",COMMISSION_INVOICED:"commission_invoiced",COMMISSION_PAID:"commission_paid",COMMISSION_CANCELLED:"commission_cancelled",AGREEMENT_CREATED:"agreement_created",AGREEMENT_SENT:"agreement_sent",AGREEMENT_APPROVED:"agreement_approved",AGREEMENT_SIGNED:"agreement_signed",AGREEMENT_ACTIVATED:"agreement_activated",AGREEMENT_REJECTED:"agreement_rejected",AGREEMENT_EXPIRED:"agreement_expired"},"AuditEntities",0,{USERS:"users",PROFILES:"profiles",INVESTORS:"investors",VEHICLES:"vehicles",SUBSCRIPTIONS:"subscriptions",POSITIONS:"positions",DOCUMENTS:"documents",WORKFLOWS:"workflows",WORKFLOW_RUNS:"workflow_runs",CONVERSATIONS:"conversations",MESSAGES:"messages",REQUEST_TICKETS:"request_tickets",CAPITAL_CALLS:"capital_calls",DISTRIBUTIONS:"distributions",DEALS:"deals",ALLOCATIONS:"allocations",FEE_EVENTS:"fee_events",INVOICES:"invoices",BANK_TRANSACTIONS:"bank_transactions",PAYMENTS:"payments",ARRANGER:"arranger_entities",INTRODUCER:"introducers",PARTNER:"partners",COMMERCIAL_PARTNER:"commercial_partners",FEE_PLANS:"arranger_fee_plans",CEO_ENTITY:"ceo_entity",CEO_USERS:"ceo_users",INTRODUCER_COMMISSIONS:"introducer_commissions",PARTNER_COMMISSIONS:"partner_commissions",COMMERCIAL_PARTNER_COMMISSIONS:"commercial_partner_commissions",INTRODUCER_AGREEMENTS:"introducer_agreements",PARTNER_AGREEMENTS:"partner_agreements",COMMERCIAL_PARTNER_AGREEMENTS:"commercial_partner_agreements",INTRODUCTIONS:"introductions"},"auditLogger",0,i])},254799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},751966,e=>{"use strict";var t=e.i(433669),r=e.i(254799);async function i({workflowKey:e,payload:i,entityType:n,entityId:a,user:s}){try{let o=(0,t.createServiceClient)(),{data:l,error:c}=await o.from("workflows").select("*").eq("key",e).eq("is_active",!0).single();if(c||!l)return console.error("Workflow not found:",e),{success:!1,error:"Workflow not found"};let d=r.default.createHash("sha256").update(`${l.id}:${s.id}:${JSON.stringify(i)}`).digest("hex"),u=process.env.N8N_WEBHOOK_SECRET||process.env.N8N_OUTBOUND_SECRET;if(!u)return console.error("N8N_WEBHOOK_SECRET not configured"),{success:!1,error:"Webhook authentication not configured. Cannot trigger workflow."};if("default-webhook-secret"===u)return console.error("CRITICAL: N8N_WEBHOOK_SECRET using insecure default value in production"),{success:!1,error:"Webhook authentication misconfigured. Please set a secure N8N_WEBHOOK_SECRET."};let p=r.default.createHmac("sha256",u).update(d).digest("hex"),{data:_,error:f}=await o.from("workflow_runs").insert({workflow_id:l.id,workflow_key:l.key,triggered_by:s.id,entity_type:n??"process",entity_id:a||null,input_params:i,status:"queued",idempotency_token:d,webhook_signature:p}).select().single();if(f||!_)return console.error("Failed to create workflow run:",f),{success:!1,error:"Failed to create workflow run"};let E={workflow_run_id:_.id,workflow_key:l.key,triggered_by:{id:s.id,email:s.email,display_name:s.displayName,role:s.role,title:s.title},payload:i,entity_type:_.entity_type},g=await fetch(l.n8n_webhook_url,{method:"POST",headers:{"Content-Type":"application/json","x-verso-signature":p,"x-idempotency-key":d,"x-workflow-run-id":_.id},body:JSON.stringify(E)}),m=g.headers.get("content-type")||"",w={};if(["application/octet-stream","application/vnd.openxmlformats-officedocument","application/msword","application/pdf","application/zip","image/","video/","audio/"].some(e=>m.includes(e))){console.log("ðŸ” Detected binary response, Content-Type:",m);let e=await g.arrayBuffer(),t=Buffer.from(e),r=function(e){let t=e.get("content-disposition");if(!t)return;let r=t.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);if(r&&r[1])return r[1].replace(/['"]/g,"")}(g.headers),i=t.slice(0,4).toString("hex");console.log("ðŸ“„ Binary file signature:",i,"size:",t.length,"bytes"),w={binary:t,filename:r,mimeType:m,size:t.length,signature:i}}else if(m.includes("application/json")){let e=await g.text();try{w=JSON.parse(e)}catch(t){console.warn("âš ï¸ Failed to parse JSON response:",t),w={raw:e}}}else{let e=await g.text();try{w=JSON.parse(e)}catch{console.log("âš ï¸ Unknown content type, treating as potential binary string"),w={raw:e}}}if(!g.ok){let e=w.raw?`Failed to trigger n8n: ${w.raw}`:`Failed to trigger n8n: ${g.status} ${g.statusText}`;return await o.from("workflow_runs").update({status:"failed",error_message:e,completed_at:new Date().toISOString()}).eq("id",_.id),{success:!1,error:"Failed to trigger n8n webhook"}}return await o.from("workflow_runs").update({status:"running",started_at:new Date().toISOString(),output_data:w}).eq("id",_.id),await o.from("audit_logs").insert({event_type:"workflow",actor_id:s.id,action:"workflow_triggered",entity_type:"workflow_runs",entity_id:_.id,action_details:{workflow_key:l.key,payload:i,entity_type:_.entity_type},timestamp:new Date().toISOString()}),{success:!0,workflow_run_id:_.id,n8n_response:w}}catch(e){return console.error("Workflow trigger error:",e),{success:!1,error:"Internal error triggering workflow"}}}e.s(["triggerWorkflow",()=>i])},485746,e=>{"use strict";var t=e.i(779444),r=e.i(698261),i=e.i(821776),n=e.i(796417),a=e.i(856890),s=e.i(26996),o=e.i(436944),l=e.i(88281),c=e.i(765944),d=e.i(984788),u=e.i(237011),p=e.i(712007),_=e.i(777657),f=e.i(13180),E=e.i(273827),g=e.i(193695);e.i(947956);var m=e.i(36217),w=e.i(414131),R=e.i(433669),h=e.i(911357),y=e.i(751966);async function S(e,{params:t}){try{let{id:e}=await t,r=await (0,R.createClient)(),{data:{user:i},error:n}=await r.auth.getUser();if(n||!i)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{data:a}=await r.from("profiles").select("id, email, role, display_name, title").eq("id",i.id).single();if(!a||!(a.role?.startsWith("staff_")||"ceo"===a.role))return w.NextResponse.json({error:"Staff access required"},{status:403});let s=(0,R.createServiceClient)(),{data:o,error:l}=await s.from("subscriptions").select(`
        id,
        commitment,
        funded_amount,
        status,
        subscription_date,
        num_shares,
        units,
        price_per_share,
        investor:investor_id (
          id,
          legal_name,
          email
        ),
        vehicle:vehicle_id (
          id,
          name,
          type,
          series,
          fund_id
        )
      `).eq("id",e).single();if(l||!o)return w.NextResponse.json({error:"Subscription not found"},{status:404});if("active"!==o.status)return w.NextResponse.json({error:"Certificate can only be generated for fully funded (active) subscriptions",current_status:o.status},{status:400});let{data:c}=await s.from("documents").select("id, file_name, created_at").eq("type","certificate").eq("subscription_id",e).order("created_at",{ascending:!1}).limit(1).single();if(c)return w.NextResponse.json({warning:"Certificate already exists for this subscription",existing_certificate:c});let d=await (0,y.triggerWorkflow)({workflowKey:"generate-investment-certificate",payload:{subscription_id:e,investor_id:o.investor?.id,investor_name:o.investor?.legal_name,investor_email:o.investor?.email,vehicle_id:o.vehicle?.id,vehicle_name:o.vehicle?.name,vehicle_type:o.vehicle?.type,vehicle_series:o.vehicle?.series,commitment_amount:o.commitment,funded_amount:o.funded_amount,shares:o.num_shares||o.units,price_per_share:o.price_per_share,subscription_date:o.subscription_date,certificate_date:new Date().toISOString().split("T")[0],include_watermark:!0},entityType:"subscription",entityId:e,user:{id:a.id,email:a.email||i.email||"",displayName:a.display_name,role:a.role,title:a.title}});if(!d.success)return console.error("Certificate workflow trigger failed:",d.error),await h.auditLogger.log({actor_user_id:a.id,action:h.AuditActions.CREATE,entity:"documents",entity_id:e,metadata:{type:"certificate_generation_requested",subscription_id:e,investor_id:o.investor?.id,vehicle_id:o.vehicle?.id,workflow_error:d.error,status:"pending_n8n_setup"}}),w.NextResponse.json({success:!1,message:"Certificate generation requested but workflow not fully configured",subscription_id:e,investor:o.investor?.legal_name,vehicle:o.vehicle?.name,note:"The n8n workflow for certificate generation needs to be set up. The request has been logged."});return await h.auditLogger.log({actor_user_id:a.id,action:h.AuditActions.CREATE,entity:"documents",entity_id:e,metadata:{type:"certificate_generation_triggered",subscription_id:e,investor_id:o.investor?.id,vehicle_id:o.vehicle?.id,workflow_run_id:d.workflow_run_id}}),w.NextResponse.json({success:!0,message:"Certificate generation workflow triggered",workflow_run_id:d.workflow_run_id,subscription:{id:e,investor:o.investor?.legal_name,vehicle:o.vehicle?.name,status:o.status}})}catch(e){return console.error("Certificate generation error:",e),w.NextResponse.json({error:"Unexpected error",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function v(e,{params:t}){try{let{id:e}=await t,r=await (0,R.createClient)(),{data:{user:i},error:n}=await r.auth.getUser();if(n||!i)return w.NextResponse.json({error:"Unauthorized"},{status:401});let a=(0,R.createServiceClient)(),{data:s}=await a.from("documents").select("id, file_name, storage_path, created_at, file_size").eq("type","certificate").eq("subscription_id",e).order("created_at",{ascending:!1}).limit(1).single(),{data:o}=await a.from("workflow_runs").select("id, status, created_at, started_at").eq("workflow_key","generate-investment-certificate").eq("entity_id",e).in("status",["queued","running"]).order("created_at",{ascending:!1}).limit(1).single();return w.NextResponse.json({subscription_id:e,has_certificate:!!s,certificate:s||null,pending_generation:!!o,pending_workflow:o||null})}catch(e){return console.error("Certificate status check error:",e),w.NextResponse.json({error:"Unexpected error",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}e.s(["GET",()=>v,"POST",()=>S,"dynamic",0,"force-dynamic"],668199);var C=e.i(668199);let N=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/subscriptions/[id]/certificate/route",pathname:"/api/subscriptions/[id]/certificate",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/subscriptions/[id]/certificate/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:O,workUnitAsyncStorage:T,serverHooks:A}=N;function I(){return(0,i.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:T})}async function x(e,t,i){N.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/subscriptions/[id]/certificate/route";w=w.replace(/\/index$/,"")||"/";let R=await N.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:h,params:y,nextConfig:S,parsedUrl:v,isDraftMode:C,prerenderManifest:O,routerServerContext:T,isOnDemandRevalidate:A,revalidateOnlyGenerated:I,resolvedPathname:x,clientReferenceManifest:k,serverActionsManifest:b}=R,D=(0,o.normalizeAppPath)(w),M=!!(O.dynamicRoutes[D]||O.routes[x]),P=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,v,!1):t.end("This page could not be found"),null);if(M&&!C){let e=!!O.routes[x],t=O.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await P();throw new g.NoFallbackError}}let U=null;!M||N.isDev||C||(U="/index"===(U=x)?"/":U);let L=!0===N.isDev||!M,q=M&&!L;b&&k&&(0,s.setManifestsSingleton)({page:w,clientReferenceManifest:k,serverActionsManifest:b});let j=e.method||"GET",G=(0,a.getTracer)(),W=G.getActiveScopeSpan(),F={params:y,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i,n)=>N.onRequestError(e,t,i,n,T)},sharedContext:{buildId:h}},H=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),K=c.NextRequestAdapter.fromNodeNextRequest(H,(0,c.signalFromNodeResponse)(t));try{let s=async e=>N.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=G.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${j} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${w}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var a,l;let c=async({previousCacheEntry:r})=>{try{if(!o&&A&&I&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let c=F.renderOpts.collectedTags;if(!M)return await (0,p.sendResponse)(H,B,a,F.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[E.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,i=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==r?void 0:r.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:A})},!1,T),t}},d=await N.handleResponse({req:e,nextConfig:S,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:I,responseGenerator:c,waitUntil:i.waitUntil,isMinimalMode:o});if(!M)return null;if((null==d||null==(a=d.value)?void 0:a.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,_.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&M||g.delete(E.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(H,B,new Response(d.value.body,{headers:g,status:d.value.status||200})),null};W?await l(W):await G.withPropagatedContext(e.headers,()=>G.trace(d.BaseServerSpan.handleRequest,{spanName:`${j} ${w}`,kind:a.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:A})},!1,T),M)throw t;return await (0,p.sendResponse)(H,B,new Response(null,{status:500})),null}}e.s(["handler",()=>x,"patchFetch",()=>I,"routeModule",()=>N,"serverHooks",()=>A,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>T],485746)},261365,e=>{e.v(e=>Promise.resolve().then(()=>e(368899)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__63ba2944._.js.map