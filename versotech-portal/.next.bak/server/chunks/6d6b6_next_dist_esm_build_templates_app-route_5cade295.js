module.exports=[916959,e=>{"use strict";var t=e.i(779444),r=e.i(698261),n=e.i(821776),a=e.i(796417),i=e.i(856890),s=e.i(26996),o=e.i(436944),u=e.i(88281),d=e.i(765944),l=e.i(984788),g=e.i(237011),_=e.i(712007),c=e.i(777657),p=e.i(13180),f=e.i(273827),m=e.i(193695);e.i(947956);var h=e.i(36217),R=e.i(414131),w=e.i(433669),E=e.i(254799),v=e.i(911357),x=e.i(28885),y=e.i(411164);async function N(e,t){if(!t)return null;try{let r=new x.SignatureStorageManager(e),n=await r.downloadPDF(t),a=await (0,y.detectAnchors)(n);if(0===a.length)return console.warn("⚠️ [introducer-agreements/sign] No anchors detected in PDF"),null;let i=(0,y.getPlacementsFromAnchors)(a,"party_a","introducer_agreement");return i.length>0?i:null}catch(e){return console.error("❌ [introducer-agreements/sign] Failed to detect anchors:",e),null}}async function C(e,{params:t}){try{let{id:e}=await t,r=await (0,w.createClient)(),{data:{user:n}}=await r.auth.getUser();if(!n)return R.NextResponse.json({error:"Unauthorized"},{status:401});let a=(0,w.createServiceClient)(),{data:i,error:s}=await a.from("introducer_agreements").select(`
        *,
        introducer:introducer_id (
          id,
          legal_name,
          email,
          contact_name
        )
      `).eq("id",e).single();if(s||!i)return R.NextResponse.json({error:"Agreement not found"},{status:404});let o=null;if(i.arranger_id){let{data:e}=await a.from("arranger_entities").select("id, legal_name").eq("id",i.arranger_id).single();o=e}let{data:u}=await a.rpc("get_user_personas",{p_user_id:n.id}),d=u?.some(e=>"staff"===e.persona_type&&["staff_admin","ceo","staff_member"].includes(e.role_in_entity)),l=!!u?.find(e=>"arranger"===e.persona_type&&e.entity_id===i.arranger_id)&&i.arranger_id,g=!!u?.find(e=>"introducer"===e.persona_type&&e.entity_id===i.introducer_id);i.introducer;let _=!!i.arranger_id,c=await N(a,i.pdf_url);if(l&&"approved"===i.status&&_){if(i.arranger_signature_request_id){let{data:e}=await a.from("signature_requests").select("signing_token, token_expires_at, status").eq("id",i.arranger_signature_request_id).single();if(e&&"pending"===e.status&&new Date(e.token_expires_at)>new Date)return R.NextResponse.json({signing_url:`/sign/${e.signing_token}`,pdf_url:i.pdf_url})}let t=E.default.randomUUID(),r=new Date(Date.now()+6048e5),s=o?.legal_name||"Arranger",{data:u,error:d}=await a.from("signature_requests").insert({investor_id:i.introducer_id,introducer_id:i.introducer_id,introducer_agreement_id:i.id,signer_email:n.email,signer_name:n.user_metadata?.full_name||s,document_type:"introducer_agreement",signer_role:"arranger",signature_position:"party_a",signing_token:t,token_expires_at:r.toISOString(),unsigned_pdf_path:i.pdf_url,...c&&c.length>0?{signature_placements:c}:{},status:"pending",created_by:n.id}).select("id").single();if(d||!u)return console.error("[introducer-agreements/sign] Create arranger signature request error:",d),R.NextResponse.json({error:"Failed to create signature request"},{status:500});return await a.from("introducer_agreements").update({arranger_signature_request_id:u.id,status:"pending_arranger_signature",updated_at:new Date().toISOString()}).eq("id",e),await v.auditLogger.log({actor_user_id:n.id,action:v.AuditActions.AGREEMENT_SIGNED,entity:v.AuditEntities.INTRODUCER_AGREEMENTS,entity_id:e,metadata:{introducer_id:i.introducer_id,arranger_id:i.arranger_id,signer_role:"arranger",previous_status:"approved",new_status:"pending_arranger_signature",signature_request_id:u.id}}),R.NextResponse.json({signing_url:`/sign/${t}`,pdf_url:i.pdf_url,expires_at:r.toISOString(),signer_type:"arranger"})}if(d&&"approved"===i.status&&!_){if(i.ceo_signature_request_id){let{data:e}=await a.from("signature_requests").select("signing_token, token_expires_at, status").eq("id",i.ceo_signature_request_id).single();if(e&&"pending"===e.status&&new Date(e.token_expires_at)>new Date)return R.NextResponse.json({signing_url:`/sign/${e.signing_token}`,pdf_url:i.pdf_url})}let t=E.default.randomUUID(),r=new Date(Date.now()+6048e5),{data:s,error:o}=await a.from("signature_requests").insert({investor_id:i.introducer_id,introducer_id:i.introducer_id,introducer_agreement_id:i.id,signer_email:n.email,signer_name:n.user_metadata?.full_name||n.email?.split("@")[0]||"CEO",document_type:"introducer_agreement",signer_role:"admin",signature_position:"party_a",signing_token:t,token_expires_at:r.toISOString(),unsigned_pdf_path:i.pdf_url,...c&&c.length>0?{signature_placements:c}:{},status:"pending",created_by:n.id}).select("id").single();if(o||!s)return console.error("[introducer-agreements/sign] Create CEO signature request error:",o),R.NextResponse.json({error:"Failed to create signature request"},{status:500});return await a.from("introducer_agreements").update({ceo_signature_request_id:s.id,status:"pending_ceo_signature",updated_at:new Date().toISOString()}).eq("id",e),await v.auditLogger.log({actor_user_id:n.id,action:v.AuditActions.AGREEMENT_SIGNED,entity:v.AuditEntities.INTRODUCER_AGREEMENTS,entity_id:e,metadata:{introducer_id:i.introducer_id,signer_role:"ceo",previous_status:"approved",new_status:"pending_ceo_signature",signature_request_id:s.id}}),R.NextResponse.json({signing_url:`/sign/${t}`,pdf_url:i.pdf_url,expires_at:r.toISOString(),signer_type:"ceo"})}if(g&&"pending_introducer_signature"===i.status){if(i.introducer_signature_request_id){let{data:e}=await a.from("signature_requests").select("signing_token, token_expires_at, status").eq("id",i.introducer_signature_request_id).single();if(e&&"pending"===e.status&&new Date(e.token_expires_at)>new Date)return R.NextResponse.json({signing_url:`/sign/${e.signing_token}`,pdf_url:i.signed_pdf_url||i.pdf_url})}return R.NextResponse.json({error:"No valid signature request found. Please contact support."},{status:400})}if(d&&"approved"!==i.status||l&&"approved"!==i.status)return R.NextResponse.json({error:`Cannot sign agreement in status: ${i.status}. Must be approved.`},{status:400});if(g&&"pending_introducer_signature"!==i.status)return R.NextResponse.json({error:`Cannot sign agreement in status: ${i.status}. ${_?"Arranger":"CEO"} must sign first.`},{status:400});return R.NextResponse.json({error:"Unauthorized to sign this agreement"},{status:403})}catch(e){return console.error("[introducer-agreements/sign] Unexpected error:",e),R.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["POST",()=>C],715502);var A=e.i(715502);let q=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/introducer-agreements/[id]/sign/route",pathname:"/api/introducer-agreements/[id]/sign",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/introducer-agreements/[id]/sign/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:S,workUnitAsyncStorage:D,serverHooks:O}=q;function T(){return(0,n.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:D})}async function k(e,t,n){q.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/introducer-agreements/[id]/sign/route";R=R.replace(/\/index$/,"")||"/";let w=await q.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:E,params:v,nextConfig:x,parsedUrl:y,isDraftMode:N,prerenderManifest:C,routerServerContext:A,isOnDemandRevalidate:S,revalidateOnlyGenerated:D,resolvedPathname:O,clientReferenceManifest:T,serverActionsManifest:k}=w,I=(0,o.normalizeAppPath)(R),P=!!(C.dynamicRoutes[I]||C.routes[O]),U=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,y,!1):t.end("This page could not be found"),null);if(P&&!N){let e=!!C.routes[O],t=C.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await U();throw new m.NoFallbackError}}let b=null;!P||q.isDev||N||(b="/index"===(b=O)?"/":b);let j=!0===q.isDev||!P,M=P&&!j;k&&T&&(0,s.setManifestsSingleton)({page:R,clientReferenceManifest:T,serverActionsManifest:k});let H=e.method||"GET",$=(0,i.getTracer)(),F=$.getActiveScopeSpan(),G={params:v,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,a)=>q.onRequestError(e,t,n,a,A)},sharedContext:{buildId:E}},K=new u.NodeNextRequest(e),L=new u.NodeNextResponse(t),B=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let s=async e=>q.handle(B,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${R}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),u=async a=>{var i,u;let d=async({previousCacheEntry:r})=>{try{if(!o&&S&&D&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(a);e.fetchMetrics=G.renderOpts.fetchMetrics;let u=G.renderOpts.pendingWaitUntil;u&&n.waitUntil&&(n.waitUntil(u),u=void 0);let d=G.renderOpts.collectedTags;if(!P)return await (0,_.sendResponse)(K,L,i,G.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,c.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,n=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await q.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:S})},!1,A),t}},l=await q.handleResponse({req:e,nextConfig:x,cacheKey:b,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:D,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:o});if(!P)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(u=l.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",S?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,c.fromNodeOutgoingHttpHeaders)(l.value.headers);return o&&P||m.delete(f.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,p.getCacheControlHeader)(l.cacheControl)),await (0,_.sendResponse)(K,L,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};F?await u(F):await $.withPropagatedContext(e.headers,()=>$.trace(l.BaseServerSpan.handleRequest,{spanName:`${H} ${R}`,kind:i.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},u))}catch(t){if(t instanceof m.NoFallbackError||await q.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:S})},!1,A),P)throw t;return await (0,_.sendResponse)(K,L,new Response(null,{status:500})),null}}e.s(["handler",()=>k,"patchFetch",()=>T,"routeModule",()=>q,"serverHooks",()=>O,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>D],916959)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_5cade295.js.map