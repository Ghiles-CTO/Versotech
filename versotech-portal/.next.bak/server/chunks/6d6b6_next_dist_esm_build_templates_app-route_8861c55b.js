module.exports=[608868,e=>{"use strict";var t=e.i(779444),r=e.i(698261),i=e.i(821776),n=e.i(796417),s=e.i(856890),a=e.i(26996),o=e.i(436944),l=e.i(88281),u=e.i(765944),c=e.i(984788),d=e.i(237011),p=e.i(712007),v=e.i(777657),f=e.i(13180),h=e.i(273827),_=e.i(193695);e.i(947956);var m=e.i(36217),b=e.i(414131),R=e.i(107854),g=e.i(433669),E=e.i(221640),w=e.i(911357),C=e.i(415653);let x=R.z.object({commitment:R.z.number().positive("Commitment must be positive").optional(),currency:R.z.string().length(3,"Currency must be 3 letters").toUpperCase().optional(),status:R.z.enum(["pending","committed","partially_funded","funded","active","closed","cancelled"]).optional(),effective_date:R.z.string().optional().nullable(),funding_due_at:R.z.string().optional().nullable(),acknowledgement_notes:R.z.string().optional().nullable()});async function y(e,{params:t}){let{investorId:r,subscriptionId:i}=await t;try{let e=await (0,g.createClient)(),{user:t,error:n}=await (0,E.getAuthenticatedUser)(e);if(n||!t)return b.NextResponse.json({error:"Unauthorized"},{status:401});if(!await (0,E.isStaffUser)(e,t))return b.NextResponse.json({error:"Staff access required"},{status:403});let s=(0,g.createServiceClient)(),{data:a,error:o}=await s.from("subscriptions").select(`
          *,
          vehicle:vehicles (
            id,
            name,
            type,
            currency
          ),
          investor:investors (
            id,
            legal_name,
            display_name
          )
        `).eq("id",i).eq("investor_id",r).single();if(o||!a)return b.NextResponse.json({error:"Subscription not found"},{status:404});return b.NextResponse.json({subscription:a})}catch(e){return console.error("[Subscription GET] Error:",e),b.NextResponse.json({error:"Internal server error"},{status:500})}}async function S(e,{params:t}){let{investorId:r,subscriptionId:i}=await t;try{let t=await (0,g.createClient)(),{user:n,error:s}=await (0,E.getAuthenticatedUser)(t);if(s||!n)return b.NextResponse.json({error:"Unauthorized"},{status:401});if(!await (0,E.isStaffUser)(t,n))return b.NextResponse.json({error:"Staff access required"},{status:403});let a=await e.json(),o=x.parse(a),l=(0,g.createServiceClient)(),{data:u,error:c}=await l.from("subscriptions").select("id, subscription_number, vehicle_id, investor_id, status, fee_plan_id").eq("id",i).eq("investor_id",r).single();if(c||!u)return b.NextResponse.json({error:"Subscription not found"},{status:404});let{data:d,error:p}=await l.from("subscriptions").update({commitment:o.commitment,currency:o.currency,status:o.status,effective_date:o.effective_date,funding_due_at:o.funding_due_at,acknowledgement_notes:o.acknowledgement_notes}).eq("id",i).select(`
          *,
          vehicle:vehicles (
            id,
            name
          ),
          investor:investors (
            id,
            legal_name
          )
        `).single();if(p||!d)return console.error("[Subscription PATCH] Update error:",p),b.NextResponse.json({error:"Failed to update subscription"},{status:500});o.status&&await l.from("entity_investors").update({allocation_status:o.status}).eq("vehicle_id",u.vehicle_id).eq("investor_id",u.investor_id);let v=!1;if("committed"===o.status&&"committed"!==u.status){console.log(`[Subscription PATCH] Auto-calculating fee events for subscription ${i}`);let{data:e}=await l.from("fee_events").select("id").eq("allocation_id",i).limit(1);if(e&&0!==e.length)console.log(`[Subscription PATCH] Fee events already exist for subscription ${i}`);else{let e=await (0,C.calculateSubscriptionFeeEvents)(l,i);if(e.success&&e.feeEvents&&e.feeEvents.length>0){let t=await (0,C.createFeeEvents)(l,i,u.investor_id,null,u.fee_plan_id||null,e.feeEvents);t.success?(v=!0,console.log(`[Subscription PATCH] Created ${t.feeEventIds?.length||0} fee events`)):console.error("[Subscription PATCH] Failed to create fee events:",t.error)}}}return await w.auditLogger.log({actor_user_id:n.id,action:w.AuditActions.UPDATE,entity:w.AuditEntities.SUBSCRIPTIONS,entity_id:i,metadata:{updates:o,subscription_number:u.subscription_number,fee_events_created:v}}),b.NextResponse.json({subscription:d,message:`Updated subscription #${u.subscription_number}`,fee_events_created:v})}catch(e){if(e instanceof R.z.ZodError)return b.NextResponse.json({error:"Invalid input",details:e.errors},{status:400});return console.error("[Subscription PATCH] Error:",e),b.NextResponse.json({error:"Internal server error"},{status:500})}}async function A(e,{params:t}){let{investorId:r,subscriptionId:i}=await t;try{let e=await (0,g.createClient)(),{user:t,error:n}=await (0,E.getAuthenticatedUser)(e);if(n||!t)return b.NextResponse.json({error:"Unauthorized"},{status:401});if(!await (0,E.isStaffUser)(e,t))return b.NextResponse.json({error:"Staff access required"},{status:403});let s=(0,g.createServiceClient)(),{data:a,error:o}=await s.from("subscriptions").select("id, subscription_number, vehicle_id, investor_id, status, fee_plan_id").eq("id",i).eq("investor_id",r).single();if(o||!a)return b.NextResponse.json({error:"Subscription not found"},{status:404});if("cancelled"===a.status)return b.NextResponse.json({error:"Subscription is already cancelled"},{status:400});let{data:l,error:u}=await s.from("subscriptions").update({status:"cancelled"}).eq("id",i).select().single();if(u||!l)return console.error("[Subscription DELETE] Cancel error:",u),b.NextResponse.json({error:"Failed to cancel subscription"},{status:500});await s.from("entity_investors").update({allocation_status:"cancelled"}).eq("vehicle_id",a.vehicle_id).eq("investor_id",a.investor_id);let{data:c}=await s.from("deals").select("id").eq("vehicle_id",a.vehicle_id);if(c&&c.length>0){let e=c.map(e=>e.id);await s.from("investor_deal_holdings").update({status:"cancelled"}).eq("investor_id",a.investor_id).in("deal_id",e)}return await w.auditLogger.log({actor_user_id:t.id,action:w.AuditActions.DELETE,entity:w.AuditEntities.SUBSCRIPTIONS,entity_id:i,metadata:{subscription_number:a.subscription_number,vehicle_id:a.vehicle_id,action:"cancelled"}}),b.NextResponse.json({message:`Cancelled subscription #${a.subscription_number}`,subscription:l})}catch(e){return console.error("[Subscription DELETE] Error:",e),b.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["DELETE",()=>A,"GET",()=>y,"PATCH",()=>S],523801);var N=e.i(523801);let T=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/investors/[investorId]/subscriptions/[subscriptionId]/route",pathname:"/api/investors/[investorId]/subscriptions/[subscriptionId]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/investors/[investorId]/subscriptions/[subscriptionId]/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:P,workUnitAsyncStorage:q,serverHooks:I}=T;function U(){return(0,i.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:q})}async function j(e,t,i){T.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/investors/[investorId]/subscriptions/[subscriptionId]/route";b=b.replace(/\/index$/,"")||"/";let R=await T.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:g,params:E,nextConfig:w,parsedUrl:C,isDraftMode:x,prerenderManifest:y,routerServerContext:S,isOnDemandRevalidate:A,revalidateOnlyGenerated:N,resolvedPathname:P,clientReferenceManifest:q,serverActionsManifest:I}=R,U=(0,o.normalizeAppPath)(b),j=!!(y.dynamicRoutes[U]||y.routes[P]),H=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,C,!1):t.end("This page could not be found"),null);if(j&&!x){let e=!!y.routes[P],t=y.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await H();throw new _.NoFallbackError}}let O=null;!j||T.isDev||x||(O="/index"===(O=P)?"/":O);let D=!0===T.isDev||!j,k=j&&!D;I&&q&&(0,a.setManifestsSingleton)({page:b,clientReferenceManifest:q,serverActionsManifest:I});let F=e.method||"GET",$=(0,s.getTracer)(),z=$.getActiveScopeSpan(),M={params:E,prerenderManifest:y,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i,n)=>T.onRequestError(e,t,i,n,S)},sharedContext:{buildId:g}},L=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),B=u.NextRequestAdapter.fromNodeNextRequest(L,(0,u.signalFromNodeResponse)(t));try{let a=async e=>T.handle(B,M).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${F} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${b}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var s,l;let u=async({previousCacheEntry:r})=>{try{if(!o&&A&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await a(n);e.fetchMetrics=M.renderOpts.fetchMetrics;let l=M.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let u=M.renderOpts.collectedTags;if(!j)return await (0,p.sendResponse)(L,K,s,M.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,v.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,i=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==r?void 0:r.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:A})},!1,S),t}},c=await T.handleResponse({req:e,nextConfig:w,cacheKey:O,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:N,responseGenerator:u,waitUntil:i.waitUntil,isMinimalMode:o});if(!j)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,v.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&j||_.delete(h.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(L,K,new Response(c.value.body,{headers:_,status:c.value.status||200})),null};z?await l(z):await $.withPropagatedContext(e.headers,()=>$.trace(c.BaseServerSpan.handleRequest,{spanName:`${F} ${b}`,kind:s.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:A})},!1,S),j)throw t;return await (0,p.sendResponse)(L,K,new Response(null,{status:500})),null}}e.s(["handler",()=>j,"patchFetch",()=>U,"routeModule",()=>T,"serverHooks",()=>I,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>q],608868)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_8861c55b.js.map