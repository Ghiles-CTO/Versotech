module.exports=[477646,e=>{"use strict";var t=e.i(779444),a=e.i(698261),r=e.i(821776),s=e.i(796417),n=e.i(856890),i=e.i(26996),o=e.i(436944),l=e.i(88281),d=e.i(765944),p=e.i(984788),u=e.i(237011),c=e.i(712007),_=e.i(777657),g=e.i(13180),f=e.i(273827),v=e.i(193695);e.i(947956);var y=e.i(36217),m=e.i(433669),h=e.i(911357),R=e.i(221640),w=e.i(414131),q=e.i(107854);let x=q.z.object({entity_type:q.z.string().min(1,"Entity type is required"),entity_id:q.z.string().uuid("Invalid entity ID"),action:q.z.enum(["approve","reject","revise"]),notes:q.z.string().optional(),priority:q.z.enum(["low","medium","high","critical"]).default("medium"),assigned_to:q.z.string().uuid("Invalid assignee ID").optional()}),E=q.z.object({action:q.z.enum(["approve","reject","revise"]).optional(),status:q.z.enum(["pending","approved","rejected"]).optional(),notes:q.z.string().optional(),assigned_to:q.z.string().uuid().optional()});async function b(e){try{let t=await (0,m.createClient)(),a=(0,m.createServiceClient)(),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{data:n}=await t.from("profiles").select("role, display_name").eq("id",r.id).single();if(!n||!["staff_admin","staff_ops","staff_rm","ceo"].includes(n.role))return w.NextResponse.json({error:"Staff access required to create approvals"},{status:403});let i=await e.json(),o=x.safeParse(i);if(!o.success)return w.NextResponse.json({error:"Invalid request data",details:o.error.errors},{status:400});let{entity_type:l,entity_id:d,action:p,notes:u,priority:c,assigned_to:_}=o.data,g=!1,f="";switch(l){case"deal_interest":let{data:v}=await t.from("investor_deal_interest").select("id, investors(legal_name)").eq("id",d).single();g=!!v,f=v?.investors?.[0]?.legal_name||"Unknown";break;case"deal_subscription":let{data:y}=await t.from("deal_subscription_submissions").select("id, investors(legal_name)").eq("id",d).single();g=!!y,f=y?.investors?.[0]?.legal_name||"Unknown";break;case"deal_close":let{data:R}=await t.from("deals").select("id, name").eq("id",d).single();g=!!R,f=R?.name||"Deal";break;case"allocation":let{data:q}=await t.from("allocations").select("id, investors(legal_name)").eq("id",d).single();g=!!q,f=q?.investors?.[0]?.legal_name||"Unknown";break;case"document":let{data:E}=await t.from("documents").select("id, type").eq("id",d).single();g=!!E,f=E?.type||"Unknown";break;default:return w.NextResponse.json({error:`Unsupported entity type: ${l}`},{status:400})}if(!g)return w.NextResponse.json({error:`${l} not found`},{status:404});let{data:b,error:A}=await a.from("approvals").insert({entity_type:l,entity_id:d,action:p,notes:u,priority:c,assigned_to:_,requested_by:r.id,status:"pending"}).select(`
        *,
        requested_by_profile:requested_by (
          display_name
        ),
        assigned_to_profile:assigned_to (
          display_name
        )
      `).single();if(A)return console.error("Approval creation error:",A),w.NextResponse.json({error:"Failed to create approval"},{status:500});return await h.auditLogger.log({actor_user_id:r.id,action:h.AuditActions.CREATE,entity:"approvals",entity_id:b.id,metadata:{entity_type:l,target_entity_id:d,action:p,priority:c,assigned_to:_,requested_by:n.display_name,entity_name:f}}),w.NextResponse.json({success:!0,approval_id:b.id,approval:b,message:`Approval request created for ${l}: ${f}`})}catch(e){return console.error("Approval creation API error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}async function A(e){try{let t=await (0,m.createClient)(),a=(0,m.createServiceClient)(),{searchParams:r}=new URL(e.url),{user:s,error:n}=await (0,R.getAuthenticatedUser)(t);if(n||!s)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{data:i}=await t.from("profiles").select("id, role, display_name, email").eq("id",s.id).single();if(!i||!["staff_admin","staff_ops","staff_rm","ceo"].includes(i.role))return w.NextResponse.json({error:"Staff access required to view approvals"},{status:403});let o=(r.get("status")||"pending").split(",").filter(Boolean),l=r.get("entity_type"),d=r.get("entity_types")?.split(",").filter(Boolean)||[],p=r.get("assigned_to"),u=r.get("priority"),c=r.get("priorities")?.split(",").filter(Boolean)||[],_=r.get("related_deal_id"),g=r.get("related_investor_id"),f="true"===r.get("overdue_only"),v=r.get("decided_after"),y=parseInt(r.get("limit")||"50",10),h=parseInt(r.get("offset")||"0",10),q=a.from("approvals").select(`
        *,
        requested_by_profile:requested_by (
          id,
          display_name,
          email,
          role
        ),
        assigned_to_profile:assigned_to (
          id,
          display_name,
          email,
          role
        ),
        approved_by_profile:approved_by (
          id,
          display_name,
          email,
          role
        ),
        related_deal:deals (
          id,
          name,
          status,
          deal_type,
          currency
        ),
        related_investor:investors (
          id,
          legal_name,
          kyc_status,
          type
        )
      `);q=o.length>1&&v?q.or(`status.eq.pending,and(status.in.(approved,rejected),resolved_at.gte.${v})`):o.length>1?q.in("status",o):q.eq("status",o[0]),l&&(q=q.eq("entity_type",l)),d.length>0&&(q=q.in("entity_type",d)),"me"===p?q=q.eq("assigned_to",i.id):p&&(q=q.eq("assigned_to",p)),u&&(q=q.eq("priority",u)),c.length>0&&(q=q.in("priority",c)),_&&(q=q.eq("related_deal_id",_)),g&&(q=q.eq("related_investor_id",g)),f&&(q=q.lt("sla_breach_at",new Date().toISOString()));let x=a.from("approvals").select("*",{count:"exact",head:!0});x=o.length>1&&v?x.or(`status.eq.pending,and(status.in.(approved,rejected),resolved_at.gte.${v})`):o.length>1?x.in("status",o):x.eq("status",o[0]),l&&(x=x.eq("entity_type",l)),d.length>0&&(x=x.in("entity_type",d)),"me"===p?x=x.eq("assigned_to",i.id):p&&(x=x.eq("assigned_to",p)),u&&(x=x.eq("priority",u)),c.length>0&&(x=x.in("priority",c)),_&&(x=x.eq("related_deal_id",_)),g&&(x=x.eq("related_investor_id",g)),f&&(x=x.lt("sla_breach_at",new Date().toISOString()));let{count:E}=await x,{data:b,error:A}=await q.order("sla_breach_at",{ascending:!0,nullsFirst:!1}).order("created_at",{ascending:!1}).range(h,h+y-1);if(A)return console.error("Error fetching approvals:",A),w.NextResponse.json({error:"Failed to fetch approvals"},{status:500});let{data:C,error:N}=await a.rpc("get_approval_stats",{p_staff_id:"me"===p?i.id:null}).single();N&&console.warn("Error fetching approval stats:",N);let{data:j}=await a.from("approvals").select("status",{count:"exact",head:!0});return w.NextResponse.json({approvals:b||[],stats:C||{total_pending:0,overdue_count:0,avg_processing_time_hours:0,approval_rate_24h:0,total_approved_30d:0,total_rejected_30d:0,total_awaiting_info:0},counts:{pending:b?.filter(e=>"pending"===e.status).length||0,approved:C?.total_approved_30d||0,rejected:C?.total_rejected_30d||0},total:E||0,pagination:{limit:y,offset:h,has_more:(E||0)>h+y},hasData:b&&b.length>0||!1})}catch(e){return console.error("Approvals GET API error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}async function C(e){try{let t=await (0,m.createClient)(),a=(0,m.createServiceClient)(),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{data:n}=await t.from("profiles").select("role, display_name").eq("id",r.id).single();if(!n||!["staff_admin","staff_ops","staff_rm","ceo"].includes(n.role))return w.NextResponse.json({error:"Staff access required to update approvals"},{status:403});let{approval_id:i,...o}=await e.json(),l=E.safeParse(o);if(!l.success)return w.NextResponse.json({error:"Invalid request data",details:l.error.errors},{status:400});if(!i)return w.NextResponse.json({error:"Approval ID is required"},{status:400});let d=l.data;d.status&&["approved","rejected"].includes(d.status)&&(d.decided_by=r.id,d.decided_at=new Date().toISOString());let{data:p,error:u}=await a.from("approvals").update(d).eq("id",i).select(`
        *,
        requested_by_profile:requested_by (
          display_name
        ),
        assigned_to_profile:assigned_to (
          display_name
        ),
        decided_by_profile:decided_by (
          display_name
        )
      `).single();if(u)return console.error("Approval update error:",u),w.NextResponse.json({error:"Failed to update approval"},{status:500});return await h.auditLogger.log({actor_user_id:r.id,action:h.AuditActions.UPDATE,entity:"approvals",entity_id:i,metadata:{entity_type:p.entity_type,target_entity_id:p.entity_id,old_status:"pending",new_status:p.status,action:p.action,decided_by:n.display_name,notes:p.notes}}),w.NextResponse.json({success:!0,approval:p,message:`Approval ${p.status} for ${p.entity_type}`})}catch(e){return console.error("Approval update API error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>A,"PATCH",()=>C,"POST",()=>b],107320);var N=e.i(107320);let j=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/approvals/route",pathname:"/api/approvals",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/approvals/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:I,workUnitAsyncStorage:S,serverHooks:P}=j;function T(){return(0,r.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:S})}async function U(e,t,r){j.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let m="/api/approvals/route";m=m.replace(/\/index$/,"")||"/";let h=await j.prepare(e,t,{srcPage:m,multiZoneDraftMode:!1});if(!h)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:w,nextConfig:q,parsedUrl:x,isDraftMode:E,prerenderManifest:b,routerServerContext:A,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,resolvedPathname:I,clientReferenceManifest:S,serverActionsManifest:P}=h,T=(0,o.normalizeAppPath)(m),U=!!(b.dynamicRoutes[T]||b.routes[I]),O=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,x,!1):t.end("This page could not be found"),null);if(U&&!E){let e=!!b.routes[I],t=b.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(q.experimental.adapterPath)return await O();throw new v.NoFallbackError}}let k=null;!U||j.isDev||E||(k="/index"===(k=I)?"/":k);let D=!0===j.isDev||!U,H=U&&!D;P&&S&&(0,i.setManifestsSingleton)({page:m,clientReferenceManifest:S,serverActionsManifest:P});let $=e.method||"GET",z=(0,n.getTracer)(),F=z.getActiveScopeSpan(),M={params:w,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!q.experimental.authInterrupts},cacheComponents:!!q.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:q.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,s)=>j.onRequestError(e,t,r,s,A)},sharedContext:{buildId:R}},B=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),L=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let i=async e=>j.handle(L,M).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=z.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${$} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${m}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var n,l;let d=async({previousCacheEntry:a})=>{try{if(!o&&C&&N&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=M.renderOpts.fetchMetrics;let l=M.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let d=M.renderOpts.collectedTags;if(!U)return await (0,c.sendResponse)(B,K,n,M.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,r=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await j.onRequestError(e,t,{routerKind:"App Router",routePath:m,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})},!1,A),t}},p=await j.handleResponse({req:e,nextConfig:q,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:o});if(!U)return null;if((null==p||null==(n=p.value)?void 0:n.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(l=p.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let v=(0,_.fromNodeOutgoingHttpHeaders)(p.value.headers);return o&&U||v.delete(f.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||v.get("Cache-Control")||v.set("Cache-Control",(0,g.getCacheControlHeader)(p.cacheControl)),await (0,c.sendResponse)(B,K,new Response(p.value.body,{headers:v,status:p.value.status||200})),null};F?await l(F):await z.withPropagatedContext(e.headers,()=>z.trace(p.BaseServerSpan.handleRequest,{spanName:`${$} ${m}`,kind:n.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await j.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})},!1,A),U)throw t;return await (0,c.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>T,"routeModule",()=>j,"serverHooks",()=>P,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>S],477646)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_c150a723.js.map