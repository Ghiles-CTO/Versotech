module.exports=[503845,e=>{"use strict";var t=e.i(779444),a=e.i(698261),i=e.i(821776),n=e.i(796417),r=e.i(856890),s=e.i(26996),l=e.i(436944),o=e.i(88281),d=e.i(765944),c=e.i(984788),_=e.i(237011),u=e.i(712007),p=e.i(777657),m=e.i(13180),f=e.i(273827),v=e.i(193695);e.i(947956);var h=e.i(36217),g=e.i(414131),R=e.i(433669);function w(e,t,a){if(!t)return a?.data_room_granted_at||a?.nda_signed_at||a?.interest_confirmed_at?"interested":"new_lead";switch(e){case"funded":case"active":return"funded";case"signed":case"committed":case"pending":case"approved":return"subscribing";case"cancelled":case"rejected":case"withdrawn":return"passed";default:return"interested"}}function b(e){return e?Array.isArray(e)?e[0]||null:e:null}async function E(){let e=await (0,R.createClient)(),t=(0,R.createServiceClient)();try{let{data:{user:a},error:i}=await e.auth.getUser();if(i||!a)return g.NextResponse.json({error:"Unauthorized"},{status:401});let{data:n}=await t.from("commercial_partner_users").select("commercial_partner_id").eq("user_id",a.id).maybeSingle();if(!n?.commercial_partner_id){let{data:e}=await t.from("commercial_partner_clients").select(`
          id,
          client_name,
          client_email,
          client_type,
          is_active,
          created_at,
          created_for_deal_id,
          client_investor_id,
          deal:created_for_deal_id (
            id,
            name,
            status
          )
        `).order("created_at",{ascending:!1}).limit(100),a=(e||[]).map(e=>{let t=b(e.deal);return{id:e.id,client_name:e.client_name||"Unknown Client",client_email:e.client_email,client_type:e.client_type,is_active:e.is_active??!0,created_at:e.created_at,deal_id:e.created_for_deal_id,deal_name:t?.name||null,deal_status:t?.status||null,investor_id:e.client_investor_id,subscription_id:null,subscription_amount:null,subscription_status:null,subscription_date:null,journey_stage:"new_lead",has_termsheet:!!e.created_for_deal_id,has_dataroom_access:!1,estimated_commission:null,commission_rate_bps:0}}),i={totalClients:a.length,activeClients:a.filter(e=>e.is_active).length,totalTransactions:0,totalValue:0,estimatedCommission:0};return g.NextResponse.json({staff_view:!0,partner:null,placement_agreement:null,clients:a,summary:i})}let r=n.commercial_partner_id,{data:s}=await t.from("commercial_partners").select("id, name, legal_name, type, status, logo_url").eq("id",r).single(),{data:l}=await t.from("placement_agreements").select("id, default_commission_bps, status").eq("commercial_partner_id",r).eq("status","active").maybeSingle(),{data:o,error:d}=await t.from("commercial_partner_clients").select(`
        id,
        client_name,
        client_email,
        client_type,
        is_active,
        created_at,
        created_for_deal_id,
        client_investor_id,
        deal:created_for_deal_id (
          id,
          name,
          status
        )
      `).eq("commercial_partner_id",r).order("created_at",{ascending:!1});if(d)return console.error("[cp-client-transactions] Clients fetch error:",d),g.NextResponse.json({error:"Failed to load clients"},{status:500});let c=(o||[]).filter(e=>e.client_investor_id).map(e=>e.client_investor_id),_=(o||[]).filter(e=>e.created_for_deal_id).map(e=>e.created_for_deal_id),u={};if(c.length>0){let{data:e}=await t.from("subscriptions").select(`
          id,
          investor_id,
          deal_id,
          commitment,
          status,
          subscription_date,
          deals (
            id,
            name,
            status
          )
        `).in("investor_id",c).eq("proxy_commercial_partner_id",r).order("created_at",{ascending:!1});e&&e.forEach(e=>{u[e.investor_id]||(u[e.investor_id]=[]),u[e.investor_id].push(e)})}let p=Object.values(u).flat().map(e=>e.deal_id).filter(Boolean),m=[...new Set([..._,...p])],f={};if(c.length>0&&m.length>0){let{data:e}=await t.from("deal_memberships").select("investor_id, deal_id, interest_confirmed_at, nda_signed_at, data_room_granted_at").in("investor_id",c).in("deal_id",m);e&&e.forEach(e=>{f[`${e.investor_id}:${e.deal_id}`]={interest_confirmed_at:e.interest_confirmed_at,nda_signed_at:e.nda_signed_at,data_room_granted_at:e.data_room_granted_at}})}let v={};if(m.length>0&&c.length>0){let{data:e}=await t.from("deal_data_room_access").select("deal_id, investor_id").in("deal_id",m).in("investor_id",c).is("revoked_at",null).or(`expires_at.is.null,expires_at.gte.${new Date().toISOString()}`);e&&e.forEach(e=>{v[`${e.deal_id}:${e.investor_id}`]=!0})}let h=l?.default_commission_bps||0,R=[];(o||[]).forEach(e=>{let t=e.client_investor_id&&u[e.client_investor_id]||[];if(0===t.length){let t;if(e.client_investor_id&&e.created_for_deal_id&&(t=f[`${e.client_investor_id}:${e.created_for_deal_id}`]),!t&&e.client_investor_id){let a=`${e.client_investor_id}:`,i=Object.keys(f).find(e=>e.startsWith(a));i&&(t=f[i])}let a=b(e.deal);R.push({id:e.id,client_name:e.client_name||"Unknown Client",client_email:e.client_email,client_type:e.client_type,is_active:e.is_active??!0,created_at:e.created_at,deal_id:e.created_for_deal_id,deal_name:a?.name||null,deal_status:a?.status||null,investor_id:e.client_investor_id,subscription_id:null,subscription_amount:null,subscription_status:null,subscription_date:null,journey_stage:w(null,!1,t),has_termsheet:!!e.created_for_deal_id,has_dataroom_access:!!(e.created_for_deal_id&&e.client_investor_id&&v[`${e.created_for_deal_id}:${e.client_investor_id}`]),estimated_commission:null,commission_rate_bps:h})}else t.forEach(t=>{let a=t.commitment||0,i=e.client_investor_id&&t.deal_id?`${e.client_investor_id}:${t.deal_id}`:"",n=i?f[i]:void 0,r=b(t.deals)||b(e.deal);R.push({id:`${e.id}-${t.id}`,client_name:e.client_name||"Unknown Client",client_email:e.client_email,client_type:e.client_type,is_active:e.is_active??!0,created_at:t.subscription_date||e.created_at,deal_id:t.deal_id,deal_name:r?.name||null,deal_status:r?.status||null,investor_id:e.client_investor_id,subscription_id:t.id,subscription_amount:a,subscription_status:t.status,subscription_date:t.subscription_date,journey_stage:w(t.status,!0,n),has_termsheet:!0,has_dataroom_access:!!(t.deal_id&&e.client_investor_id&&v[`${t.deal_id}:${e.client_investor_id}`]),estimated_commission:h>0?a*h/1e4:null,commission_rate_bps:h})})});let E=new Set((o||[]).map(e=>e.id)),y=(o||[]).filter(e=>e.is_active).length,C=R.filter(e=>e.subscription_amount),x=C.reduce((e,t)=>e+(t.subscription_amount||0),0),A=C.reduce((e,t)=>e+(t.estimated_commission||0),0),N={totalClients:E.size,activeClients:y,totalTransactions:C.length,totalValue:x,estimatedCommission:A};return g.NextResponse.json({staff_view:!1,partner:s,placement_agreement:l,clients:R,summary:N})}catch(e){return console.error("[cp-client-transactions] Unexpected error:",e),g.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>E],592779);var y=e.i(592779);let C=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/commercial-partners/me/client-transactions/route",pathname:"/api/commercial-partners/me/client-transactions",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/commercial-partners/me/client-transactions/route.ts",nextConfigOutput:"",userland:y}),{workAsyncStorage:x,workUnitAsyncStorage:A,serverHooks:N}=C;function T(){return(0,i.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:A})}async function S(e,t,i){C.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/commercial-partners/me/client-transactions/route";g=g.replace(/\/index$/,"")||"/";let R=await C.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:w,params:b,nextConfig:E,parsedUrl:y,isDraftMode:x,prerenderManifest:A,routerServerContext:N,isOnDemandRevalidate:T,revalidateOnlyGenerated:S,resolvedPathname:$,clientReferenceManifest:O,serverActionsManifest:P}=R,U=(0,l.normalizeAppPath)(g),q=!!(A.dynamicRoutes[U]||A.routes[$]),j=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,y,!1):t.end("This page could not be found"),null);if(q&&!x){let e=!!A.routes[$],t=A.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await j();throw new v.NoFallbackError}}let k=null;!q||C.isDev||x||(k="/index"===(k=$)?"/":k);let H=!0===C.isDev||!q,I=q&&!H;P&&O&&(0,s.setManifestsSingleton)({page:g,clientReferenceManifest:O,serverActionsManifest:P});let D=e.method||"GET",M=(0,r.getTracer)(),F=M.getActiveScopeSpan(),K={params:b,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i,n)=>C.onRequestError(e,t,i,n,N)},sharedContext:{buildId:w}},B=new o.NodeNextRequest(e),L=new o.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let s=async e=>C.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=M.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${D} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${D} ${g}`)}),l=!!(0,n.getRequestMeta)(e,"minimalMode"),o=async n=>{var r,o;let d=async({previousCacheEntry:a})=>{try{if(!l&&T&&S&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await s(n);e.fetchMetrics=K.renderOpts.fetchMetrics;let o=K.renderOpts.pendingWaitUntil;o&&i.waitUntil&&(i.waitUntil(o),o=void 0);let d=K.renderOpts.collectedTags;if(!q)return await (0,u.sendResponse)(B,L,r,K.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,i=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==a?void 0:a.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:T})},!1,N),t}},c=await C.handleResponse({req:e,nextConfig:E,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:S,responseGenerator:d,waitUntil:i.waitUntil,isMinimalMode:l});if(!q)return null;if((null==c||null==(r=c.value)?void 0:r.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(o=c.value)?void 0:o.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",T?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let v=(0,p.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&q||v.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||v.get("Cache-Control")||v.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,u.sendResponse)(B,L,new Response(c.value.body,{headers:v,status:c.value.status||200})),null};F?await o(F):await M.withPropagatedContext(e.headers,()=>M.trace(c.BaseServerSpan.handleRequest,{spanName:`${D} ${g}`,kind:r.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},o))}catch(t){if(t instanceof v.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:T})},!1,N),q)throw t;return await (0,u.sendResponse)(B,L,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>T,"routeModule",()=>C,"serverHooks",()=>N,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>A],503845)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_c2123811.js.map