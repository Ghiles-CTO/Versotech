module.exports=[120635,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},918622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},270406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},193695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},433669,e=>{"use strict";e.i(814247);var t=e.i(150615),a=e.i(12049),r=e.i(57824);let n=async()=>{let e=await (0,r.cookies)();return(0,t.createServerClient)("https://ipguxdssecfexudnvtia.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ3V4ZHNzZWNmZXh1ZG52dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4MzcsImV4cCI6MjA3MzkzNzgzN30.AGxM_YW9hfxuu7xDpi_4xhOoRhYM7iGTS1vJ0z2FByE",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:a,options:r})=>{e.set(t,a,r)})}catch(e){}}}})};e.s(["createClient",0,n,"createServiceClient",0,()=>(0,a.createClient)("https://ipguxdssecfexudnvtia.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})])},911357,e=>{"use strict";var t=e.i(433669);class a{static instance;static getInstance(){return a.instance||(a.instance=new a),a.instance}async log(e){try{let a=await (0,t.createClient)();await a.from("audit_logs").insert({event_type:"system",actor_id:e.actor_user_id||null,action:e.action,entity_type:e.entity,entity_id:e.entity_id||null,action_details:e.metadata||null,timestamp:new Date().toISOString()})}catch(e){console.error("Audit logging failed:",e)}}async logMany(e){for(let t of e)await this.log(t)}}let r=a.getInstance();e.s(["AuditActions",0,{LOGIN:"login",LOGOUT:"logout",PASSWORD_CHANGE:"password_change",CREATE:"create",READ:"read",UPDATE:"update",DELETE:"delete",DOCUMENT_UPLOAD:"document_upload",DOCUMENT_DOWNLOAD:"document_download",DOCUMENT_DELETE:"document_delete",WORKFLOW_TRIGGER:"workflow_trigger",WORKFLOW_COMPLETED:"workflow_completed",WORKFLOW_FAILED:"workflow_failed",USER_CREATED:"user_created",PROFILE_UPDATED:"profile_updated",ROLE_CHANGED:"role_changed",SUBSCRIPTION_CREATED:"subscription_created",CAPITAL_CALL_CREATED:"capital_call_created",DISTRIBUTION_CREATED:"distribution_created",REPORT_REQUESTED:"report_requested",MESSAGE_SENT:"message_sent",COMMISSION_CREATED:"commission_created",COMMISSION_ACCRUED:"commission_accrued",COMMISSION_INVOICE_REQUESTED:"commission_invoice_requested",COMMISSION_INVOICED:"commission_invoiced",COMMISSION_PAID:"commission_paid",COMMISSION_CANCELLED:"commission_cancelled",AGREEMENT_CREATED:"agreement_created",AGREEMENT_SENT:"agreement_sent",AGREEMENT_APPROVED:"agreement_approved",AGREEMENT_SIGNED:"agreement_signed",AGREEMENT_ACTIVATED:"agreement_activated",AGREEMENT_REJECTED:"agreement_rejected",AGREEMENT_EXPIRED:"agreement_expired"},"AuditEntities",0,{USERS:"users",PROFILES:"profiles",INVESTORS:"investors",VEHICLES:"vehicles",SUBSCRIPTIONS:"subscriptions",POSITIONS:"positions",DOCUMENTS:"documents",WORKFLOWS:"workflows",WORKFLOW_RUNS:"workflow_runs",CONVERSATIONS:"conversations",MESSAGES:"messages",REQUEST_TICKETS:"request_tickets",CAPITAL_CALLS:"capital_calls",DISTRIBUTIONS:"distributions",DEALS:"deals",ALLOCATIONS:"allocations",FEE_EVENTS:"fee_events",INVOICES:"invoices",BANK_TRANSACTIONS:"bank_transactions",PAYMENTS:"payments",ARRANGER:"arranger_entities",INTRODUCER:"introducers",PARTNER:"partners",COMMERCIAL_PARTNER:"commercial_partners",FEE_PLANS:"arranger_fee_plans",CEO_ENTITY:"ceo_entity",CEO_USERS:"ceo_users",INTRODUCER_COMMISSIONS:"introducer_commissions",PARTNER_COMMISSIONS:"partner_commissions",COMMERCIAL_PARTNER_COMMISSIONS:"commercial_partner_commissions",INTRODUCER_AGREEMENTS:"introducer_agreements",PARTNER_AGREEMENTS:"partner_agreements",COMMERCIAL_PARTNER_AGREEMENTS:"commercial_partner_agreements",INTRODUCTIONS:"introductions"},"auditLogger",0,r])},300184,e=>{"use strict";var t=e.i(779444),a=e.i(698261),r=e.i(821776),n=e.i(796417),s=e.i(856890),i=e.i(26996),o=e.i(436944),c=e.i(88281),d=e.i(765944),l=e.i(984788),u=e.i(237011),p=e.i(712007),_=e.i(777657),m=e.i(13180),E=e.i(273827),h=e.i(193695);e.i(947956);var R=e.i(36217),f=e.i(433669),A=e.i(38896),v=e.i(414131),N=e.i(911357);let S=e=>{if(null==e)return 0;if("number"==typeof e)return e;let t=parseFloat(e);return Number.isNaN(t)?0:t};async function g(e,t){let[{data:a},{data:r}]=await Promise.all([e.from("bank_transactions").select("id, amount, currency, match_confidence, match_notes, matched_invoice_ids").eq("id",t).single(),e.from("reconciliation_matches").select("invoice_id, matched_amount").eq("bank_transaction_id",t).eq("status","approved")]);if(!a)throw Error("Bank transaction not found for recalculation");let n=r||[],s=n.reduce((e,t)=>e+S(t.matched_amount),0),i=S(a.amount),o=s<=.01?"unmatched":.01>=Math.abs(s-i)?"matched":"partially_matched",c={status:o,matched_invoice_ids:Array.from(new Set(n.map(e=>e.invoice_id))),updated_at:new Date().toISOString()};"unmatched"===o&&(c.match_confidence=null,c.match_notes=null);let{error:d,data:l}=await e.from("bank_transactions").update(c).eq("id",t).select().single();if(d)throw d;return l}async function O(e,t,a){let{data:r,error:n}=await e.from("invoices").select("id, total, paid_amount, status, match_status, paid_at").eq("id",t).single();if(n||!r)throw Error("Invoice not found while reversing match");let s=S(r.paid_amount),i=S(r.total),o=Math.max(s-a,0),c=r.status;c=o<=.01?"sent":o>=i-.01?"paid":"partially_paid";let{error:d,data:l}=await e.from("invoices").update({paid_amount:o,status:c,match_status:o<=.01?"unmatched":o>=i-.01?"matched":"partially_matched",paid_at:"paid"===c?r.paid_at:null}).eq("id",t).select().single();if(d)throw d;return"paid"!==c&&await e.from("fee_events").update({status:"invoiced"}).eq("invoice_id",t).eq("status","paid"),l}async function C(e){let t=await (0,A.requireStaffAuth)();if(!t)return v.NextResponse.json({error:"Unauthorized"},{status:401});try{let{bank_transaction_id:a,match_id:r}=await e.json();if(!a)return v.NextResponse.json({error:"Missing bank_transaction_id"},{status:400});let n=await (0,f.createClient)();if(r){let{data:e,error:s}=await n.from("reconciliation_matches").select("id, bank_transaction_id, invoice_id, matched_amount, status, match_reason, notes, invoices ( id, total, paid_amount, status, match_status, paid_at )").eq("id",r).single();if(s||!e)return v.NextResponse.json({error:"Match not found"},{status:404});if(e.bank_transaction_id!==a)return v.NextResponse.json({error:"Match does not belong to the specified transaction"},{status:400});if("approved"!==e.status)return v.NextResponse.json({error:"Only approved matches can be reversed"},{status:400});let i=S(e.matched_amount),o=new Date().toISOString(),{error:c}=await n.from("reconciliation_matches").update({status:"reversed",match_reason:`${e.match_reason||"Match"} • reversed ${o}`,notes:`${e.notes?e.notes+" | ":""}Reversed on ${o}`}).eq("id",r);if(c)return console.error("Failed to mark match reversed",c),v.NextResponse.json({error:"Failed to reverse match"},{status:500});let d=await O(n,e.invoice_id,i),l=await g(n,a);return await N.auditLogger.log({actor_user_id:t.id,action:N.AuditActions.UPDATE,entity:N.AuditEntities.INVOICES,entity_id:e.invoice_id,metadata:{reversed_match_id:r,amount:i,new_paid_amount:d?.paid_amount}}),await N.auditLogger.log({actor_user_id:t.id,action:N.AuditActions.UPDATE,entity:N.AuditEntities.BANK_TRANSACTIONS,entity_id:a,metadata:{reversed_match_id:r,amount:i,status:l?.status,matched_invoice_ids:l?.matched_invoice_ids}}),v.NextResponse.json({success:!0,message:"Match reversed successfully",invoice:d,bank_transaction:l})}let{data:s,error:i}=await n.from("reconciliation_matches").select("id, invoice_id, matched_amount, status, match_reason, notes").eq("bank_transaction_id",a).eq("status","approved");if(i)return console.error("Failed to fetch matches for transaction",i),v.NextResponse.json({error:"Failed to load matches for transaction"},{status:500});let o=s||[];if(0===o.length)return v.NextResponse.json({success:!0,message:"No approved matches to reverse"});for(let e of o){let t=S(e.matched_amount),a=new Date().toISOString(),{error:r}=await n.from("reconciliation_matches").update({status:"reversed",match_reason:`${e.match_reason||"Match"} • reversed ${a}`,notes:`${e.notes?e.notes+" | ":""}Reversed on ${a}`}).eq("id",e.id);if(r)return console.error("Failed to reverse match",r),v.NextResponse.json({error:"Failed to reverse matches"},{status:500});await O(n,e.invoice_id,t)}let c=await g(n,a);return await N.auditLogger.log({actor_user_id:t.id,action:N.AuditActions.UPDATE,entity:N.AuditEntities.BANK_TRANSACTIONS,entity_id:a,metadata:{reversed_matches:o.length,status:c?.status}}),v.NextResponse.json({success:!0,message:"Transaction unmatched successfully",bank_transaction:c})}catch(e){return console.error("Unmatch error:",e),v.NextResponse.json({error:e?.message||"Failed to unmatch transaction"},{status:500})}}e.s(["POST",()=>C,"dynamic",0,"force-dynamic"],684625);var I=e.i(684625);let T=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/staff/reconciliation/unmatch/route",pathname:"/api/staff/reconciliation/unmatch",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/staff/reconciliation/unmatch/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:x,workUnitAsyncStorage:w,serverHooks:y}=T;function M(){return(0,r.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:w})}async function D(e,t,r){T.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/staff/reconciliation/unmatch/route";f=f.replace(/\/index$/,"")||"/";let A=await T.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!A)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:N,nextConfig:S,parsedUrl:g,isDraftMode:O,prerenderManifest:C,routerServerContext:I,isOnDemandRevalidate:x,revalidateOnlyGenerated:w,resolvedPathname:y,clientReferenceManifest:M,serverActionsManifest:D}=A,P=(0,o.normalizeAppPath)(f),b=!!(C.dynamicRoutes[P]||C.routes[y]),U=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,g,!1):t.end("This page could not be found"),null);if(b&&!O){let e=!!C.routes[y],t=C.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await U();throw new h.NoFallbackError}}let k=null;!b||T.isDev||O||(k="/index"===(k=y)?"/":k);let L=!0===T.isDev||!b,q=b&&!L;D&&M&&(0,i.setManifestsSingleton)({page:f,clientReferenceManifest:M,serverActionsManifest:D});let j=e.method||"GET",F=(0,s.getTracer)(),G=F.getActiveScopeSpan(),H={params:N,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,n)=>T.onRequestError(e,t,r,n,I)},sharedContext:{buildId:v}},K=new c.NodeNextRequest(e),V=new c.NodeNextResponse(t),$=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let i=async e=>T.handle($,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${j} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${f}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var s,c;let d=async({previousCacheEntry:a})=>{try{if(!o&&x&&w&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(n);e.fetchMetrics=H.renderOpts.fetchMetrics;let c=H.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let d=H.renderOpts.collectedTags;if(!b)return await (0,p.sendResponse)(K,V,s,H.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[E.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,r=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:x})},!1,I),t}},l=await T.handleResponse({req:e,nextConfig:S,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:w,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:o});if(!b)return null;if((null==l||null==(s=l.value)?void 0:s.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(c=l.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",x?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),O&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,_.fromNodeOutgoingHttpHeaders)(l.value.headers);return o&&b||h.delete(E.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,m.getCacheControlHeader)(l.cacheControl)),await (0,p.sendResponse)(K,V,new Response(l.value.body,{headers:h,status:l.value.status||200})),null};G?await c(G):await F.withPropagatedContext(e.headers,()=>F.trace(l.BaseServerSpan.handleRequest,{spanName:`${j} ${f}`,kind:s.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},c))}catch(t){if(t instanceof h.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:x})},!1,I),b)throw t;return await (0,p.sendResponse)(K,V,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>M,"routeModule",()=>T,"serverHooks",()=>y,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>w],300184)},261365,e=>{e.v(e=>Promise.resolve().then(()=>e(368899)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__bfa38c8e._.js.map