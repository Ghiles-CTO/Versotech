module.exports=[427484,e=>{"use strict";var t=e.i(779444),r=e.i(698261),n=e.i(821776),a=e.i(796417),i=e.i(856890),o=e.i(26996),s=e.i(436944),d=e.i(88281),l=e.i(765944),u=e.i(984788),c=e.i(237011),p=e.i(712007),_=e.i(777657),m=e.i(13180),g=e.i(273827),f=e.i(193695);e.i(947956);var y=e.i(36217),h=e.i(433669),v=e.i(911357),w=e.i(414131),D=e.i(254799),x=e.i(324299),b=e.i(169708);function R(e,t,r){let[n,a]=(0,x.normalizeDates)(r?.in,e,t),i=E(n,a),o=Math.abs((0,b.differenceInCalendarDays)(n,a));n.setDate(n.getDate()-i*o);let s=Number(E(n,a)===-i),d=i*(o-s);return 0===d?0:d}function E(e,t){let r=e.getFullYear()-t.getFullYear()||e.getMonth()-t.getMonth()||e.getDate()-t.getDate()||e.getHours()-t.getHours()||e.getMinutes()-t.getMinutes()||e.getSeconds()-t.getSeconds()||e.getMilliseconds()-t.getMilliseconds();return r<0?-1:r>0?1:r}var A=e.i(32993);function S(e,t){let r=(0,A.toDate)(e)-(0,A.toDate)(t);return r<0?-1:r>0?1:r}function N(e,t){return+(0,A.toDate)(e)<+(0,A.toDate)(t)}let C=["passport","national_id","drivers_license","signatory_id","id_card","residence_permit","visa","government_id","member_id","director_id","ubo_id"],T=["proof_of_address","signatory_proof_of_address","utility_bill","bank_statement","tax_bill","council_tax","rental_agreement","mortgage_statement","member_proof_of_address"],O={passport:{category:"id_document",requiresExpiry:!0,enforcement:"strict_block",warningDays:30},national_id:{category:"id_document",requiresExpiry:!0,enforcement:"strict_block",warningDays:30},drivers_license:{category:"id_document",requiresExpiry:!0,enforcement:"strict_block",warningDays:30},signatory_id:{category:"id_document",requiresExpiry:!0,enforcement:"strict_block",warningDays:30},member_id:{category:"id_document",requiresExpiry:!0,enforcement:"strict_block",warningDays:30},director_id:{category:"id_document",requiresExpiry:!0,enforcement:"strict_block",warningDays:30},ubo_id:{category:"id_document",requiresExpiry:!0,enforcement:"strict_block",warningDays:30},proof_of_address:{category:"proof_of_address",maxAgeDays:90,enforcement:"block_with_override",warningDays:14},signatory_proof_of_address:{category:"proof_of_address",maxAgeDays:90,enforcement:"block_with_override",warningDays:14},member_proof_of_address:{category:"proof_of_address",maxAgeDays:90,enforcement:"block_with_override",warningDays:14},utility_bill:{category:"proof_of_address",maxAgeDays:90,enforcement:"block_with_override",warningDays:14},bank_statement:{category:"proof_of_address",maxAgeDays:90,enforcement:"block_with_override",warningDays:14},certificate_of_incorporation:{category:"corporate",enforcement:"none"},regulatory_license:{category:"corporate",requiresExpiry:!0,enforcement:"warn",warningDays:60},insurance_certificate:{category:"corporate",requiresExpiry:!0,enforcement:"warn",warningDays:60}},k={category:"other",enforcement:"none"};function P(e){if(!e)return null;if(e instanceof Date)return e;let t=new Date(e);return isNaN(t.getTime())?null:t}async function I(e){try{let t=await (0,h.createClient)(),{data:{user:r},error:n}=await t.auth.getUser();if(n||!r)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{data:a}=await t.from("profiles").select("role, title").eq("id",r.id).single();if(!a||!["staff_admin","staff_ops","staff_rm","ceo"].includes(a.role))return w.NextResponse.json({error:"Staff access required for document upload"},{status:403});let i=await e.formData(),o=i.get("file"),s=i.get("type"),d=i.get("name"),l=i.get("description"),u=i.get("owner_investor_id"),c=i.get("vehicle_id"),p=i.get("entity_id"),_=i.get("arranger_entity_id"),m=i.get("introducer_id"),g=i.get("lawyer_id"),f=i.get("partner_id"),y=i.get("commercial_partner_id"),b=i.get("folder_id"),E=i.get("tags"),I="true"===i.get("confidential"),U=i.get("investor_member_id"),M=i.get("arranger_member_id"),q=i.get("partner_member_id"),$=i.get("introducer_member_id"),H=i.get("lawyer_member_id"),j=i.get("commercial_partner_member_id"),F=i.get("document_date"),z=i.get("document_expiry_date"),L=i.get("document_issue_date"),B="true"===i.get("staff_override"),K=i.get("override_reason");if(!o)return w.NextResponse.json({error:"No file provided"},{status:400});if(!s)return w.NextResponse.json({error:"Document type is required"},{status:400});let V=F?new Date(F):null,G=z?new Date(z):null,X=L?new Date(L):null,Y=function(e){var t,r;let n=O[e.documentType]||k,a=new Date;a.setHours(0,0,0,0);let i={isValid:!0,status:"valid",enforcement:n.enforcement,errors:[],warnings:[],canOverride:"block_with_override"===n.enforcement},o=P(e.expiryDate),s=P(e.documentDate),d=P(e.issueDate);if(("id_document"===n.category||(t=e.documentType,C.includes(t)||t.includes("_id")||t.includes("passport")||t.includes("license")))&&(n.requiresExpiry&&!o&&i.warnings.push("ID documents should have an expiry date"),o&&(i.daysUntilExpiry=R(o,a),N(o,a)?(i.isValid=!1,i.status="expired",i.errors.push(`ID document has expired on ${o.toLocaleDateString()}. Please upload a current, valid document.`),i.canOverride=!1):n.warningDays&&i.daysUntilExpiry<=n.warningDays&&(i.status="expiring_soon",i.warnings.push(`ID document expires in ${i.daysUntilExpiry} days (${o.toLocaleDateString()})`)))),"proof_of_address"===n.category||(r=e.documentType,T.includes(r)||r.includes("proof_of_address")||r.includes("utility")||r.includes("statement"))){let t=s||d;if(t){i.documentAgeInDays=R(a,t);let r=n.maxAgeDays||90;if(i.documentAgeInDays>r){let n=function(e,t,r){var n,a;let i,o,s,d,[l,u,c]=(0,x.normalizeDates)(void 0,e,e,t),p=S(u,c),_=Math.abs(function(e,t,r){let[n,a]=(0,x.normalizeDates)(void 0,e,t),i=n.getFullYear()-a.getFullYear();return 12*i+(n.getMonth()-a.getMonth())}(u,c));if(_<1)return 0;1===u.getMonth()&&u.getDate()>27&&u.setDate(30),u.setMonth(u.getMonth()-p*_);let m=S(u,c)===-p;+(i=(0,A.toDate)(l,void 0),n=void 0,(o=(0,A.toDate)(i,n?.in)).setHours(23,59,59,999),o)==+(a=void 0,d=(s=(0,A.toDate)(i,a?.in)).getMonth(),s.setFullYear(s.getFullYear(),d+1,0),s.setHours(23,59,59,999),s)&&1===_&&1===S(l,c)&&(m=!1);let g=p*(_-m);return 0===g?0:g}(a,t);e.isStaffOverride&&e.overrideReason?(i.status="valid",i.overrideReason=e.overrideReason,i.warnings.push(`Document is ${n} months old (>${r/30} months). Staff override applied: ${e.overrideReason}`)):(i.isValid=!1,i.status="stale",i.errors.push(`Proof of address must be dated within the last ${r/30} months. This document is ${n} months old (dated ${t.toLocaleDateString()}). Staff override required.`),i.canOverride=!0)}else if(n.warningDays){let e=r-i.documentAgeInDays;e<=n.warningDays&&i.warnings.push(`Proof of address becomes stale in ${e} days`)}}else i.warnings.push("Proof of address documents should have a document date for freshness validation")}return"corporate"===n.category&&o&&(i.daysUntilExpiry=R(o,a),N(o,a)?(i.status="expired",i.warnings.push(`This document expired on ${o.toLocaleDateString()}. Consider uploading a renewed version.`)):n.warningDays&&i.daysUntilExpiry<=n.warningDays&&(i.status="expiring_soon",i.warnings.push(`This document expires in ${i.daysUntilExpiry} days`))),i}({documentType:s,documentDate:V,expiryDate:G,issueDate:X,isStaffOverride:B,overrideReason:K});if(!Y.isValid)if(!Y.canOverride||!B||!K)return w.NextResponse.json({error:Y.errors[0]||"Document validation failed",validation:{status:Y.status,errors:Y.errors,warnings:Y.warnings,canOverride:Y.canOverride,daysUntilExpiry:Y.daysUntilExpiry,documentAgeInDays:Y.documentAgeInDays}},{status:422});else console.log(`[Document Upload] Staff override applied by ${r.id}: ${K}`);let W=E?E.split(",").map(e=>e.trim()).filter(Boolean):[];if(!["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","image/jpeg","image/png"].includes(o.type))return w.NextResponse.json({error:"Invalid file type. Allowed types: PDF, DOCX, XLSX, TXT, JPG, PNG"},{status:400});if(o.size>0x3200000)return w.NextResponse.json({error:"File size too large. Maximum size is 50MB"},{status:400});let J=o.name.split(".").pop(),Z=Date.now(),Q=D.default.randomBytes(16).toString("hex"),ee=`${s}/${Z}-${Q}.${J}`,et=await o.arrayBuffer(),er=Buffer.from(et),{data:en,error:ea}=await t.storage.from(process.env.STORAGE_BUCKET_NAME||"documents").upload(ee,er,{contentType:o.type,metadata:{uploaded_by:r.id,uploaded_at:new Date().toISOString(),original_name:o.name,document_type:s,confidential:I.toString()}});if(ea)return console.error("Storage upload error:",ea),w.NextResponse.json({error:"Failed to upload file"},{status:500});let ei={uploaded_by:a.title||r.email,uploaded_at:new Date().toISOString(),document_classification:I?"CONFIDENTIAL":"INTERNAL",verso_holdings_notice:"Property of VERSO Holdings - Authorized Use Only",compliance_notice:"Subject to BVI FSC regulation and GDPR data protection",original_filename:o.name,file_hash:D.default.createHash("sha256").update(er).digest("hex")},{data:eo,error:es}=await t.from("documents").insert({name:d||o.name.replace(/\.[^/.]+$/,""),description:l||null,file_key:ee,type:s,folder_id:b||null,tags:W.length>0?W:null,owner_investor_id:u||null,vehicle_id:c||null,entity_id:p||null,arranger_entity_id:_||null,introducer_id:m||null,lawyer_id:g||null,partner_id:f||null,commercial_partner_id:y||null,investor_member_id:U||null,arranger_member_id:M||null,partner_member_id:q||null,introducer_member_id:$||null,lawyer_member_id:H||null,commercial_partner_member_id:j||null,document_date:V||null,document_expiry_date:G||null,document_issue_date:X||null,validation_status:Y.status,validation_notes:Y.warnings.length>0?Y.warnings.join("; "):null,validated_at:new Date().toISOString(),validated_by:r.id,file_size_bytes:o.size,mime_type:o.type,current_version:1,status:"draft",is_published:!1,created_by:r.id,watermark:ei}).select(`
        *,
        investors:investors!documents_owner_investor_id_fkey(legal_name),
        vehicles:vehicles!documents_vehicle_id_fkey(name, type),
        folder:document_folders(id, name, path)
      `).single();if(es)return await t.storage.from(process.env.STORAGE_BUCKET_NAME||"documents").remove([ee]),console.error("Document record creation error:",es),w.NextResponse.json({error:"Failed to create document record"},{status:500});return await t.from("document_versions").insert({document_id:eo.id,version_number:1,file_key:ee,file_size_bytes:o.size,mime_type:o.type,created_by:r.id}),await v.auditLogger.log({actor_user_id:r.id,action:v.AuditActions.DOCUMENT_UPLOAD,entity:v.AuditEntities.DOCUMENTS,entity_id:eo.id,metadata:{file_key:ee,document_type:s,file_size:o.size,file_type:o.type,original_name:o.name,confidential:I,owner_investor_id:u,vehicle_id:c,arranger_entity_id:_,introducer_id:m,lawyer_id:g,partner_id:f,commercial_partner_id:y,investor_member_id:U,arranger_member_id:M,partner_member_id:q,introducer_member_id:$,lawyer_member_id:H,commercial_partner_member_id:j,validation_status:Y.status,validation_warnings:Y.warnings,staff_override:B,override_reason:K}}),w.NextResponse.json({success:!0,document:{id:eo.id,file_key:eo.file_key,type:eo.type,created_at:eo.created_at,watermark:ei,investor:eo.investors,vehicle:eo.vehicles},upload_info:{path:en.path,size:o.size,content_type:o.type}})}catch(e){return console.error("Document upload error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["POST",()=>I],37227);var U=e.i(37227);let M=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/documents/upload/route",pathname:"/api/documents/upload",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/documents/upload/route.ts",nextConfigOutput:"",userland:U}),{workAsyncStorage:q,workUnitAsyncStorage:$,serverHooks:H}=M;function j(){return(0,n.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:$})}async function F(e,t,n){M.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let h="/api/documents/upload/route";h=h.replace(/\/index$/,"")||"/";let v=await M.prepare(e,t,{srcPage:h,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:w,params:D,nextConfig:x,parsedUrl:b,isDraftMode:R,prerenderManifest:E,routerServerContext:A,isOnDemandRevalidate:S,revalidateOnlyGenerated:N,resolvedPathname:C,clientReferenceManifest:T,serverActionsManifest:O}=v,k=(0,s.normalizeAppPath)(h),P=!!(E.dynamicRoutes[k]||E.routes[C]),I=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,b,!1):t.end("This page could not be found"),null);if(P&&!R){let e=!!E.routes[C],t=E.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await I();throw new f.NoFallbackError}}let U=null;!P||M.isDev||R||(U="/index"===(U=C)?"/":U);let q=!0===M.isDev||!P,$=P&&!q;O&&T&&(0,o.setManifestsSingleton)({page:h,clientReferenceManifest:T,serverActionsManifest:O});let H=e.method||"GET",j=(0,i.getTracer)(),F=j.getActiveScopeSpan(),z={params:D,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,a)=>M.onRequestError(e,t,n,a,A)},sharedContext:{buildId:w}},L=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),K=l.NextRequestAdapter.fromNodeNextRequest(L,(0,l.signalFromNodeResponse)(t));try{let o=async e=>M.handle(K,z).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${h}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),d=async a=>{var i,d;let l=async({previousCacheEntry:r})=>{try{if(!s&&S&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(a);e.fetchMetrics=z.renderOpts.fetchMetrics;let d=z.renderOpts.pendingWaitUntil;d&&n.waitUntil&&(n.waitUntil(d),d=void 0);let l=z.renderOpts.collectedTags;if(!P)return await (0,p.sendResponse)(L,B,i,z.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[g.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==z.renderOpts.collectedRevalidate&&!(z.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&z.renderOpts.collectedRevalidate,n=void 0===z.renderOpts.collectedExpire||z.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:z.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await M.onRequestError(e,t,{routerKind:"App Router",routePath:h,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:S})},!1,A),t}},u=await M.handleResponse({req:e,nextConfig:x,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:N,responseGenerator:l,waitUntil:n.waitUntil,isMinimalMode:s});if(!P)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",S?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),R&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,_.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&P||f.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(L,B,new Response(u.value.body,{headers:f,status:u.value.status||200})),null};F?await d(F):await j.withPropagatedContext(e.headers,()=>j.trace(u.BaseServerSpan.handleRequest,{spanName:`${H} ${h}`,kind:i.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},d))}catch(t){if(t instanceof f.NoFallbackError||await M.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:S})},!1,A),P)throw t;return await (0,p.sendResponse)(L,B,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>j,"routeModule",()=>M,"serverHooks",()=>H,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>$],427484)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_56d81b3c.js.map