module.exports=[6929,e=>{"use strict";var t=e.i(779444),a=e.i(698261),r=e.i(821776),i=e.i(796417),s=e.i(856890),n=e.i(26996),l=e.i(436944),o=e.i(88281),d=e.i(765944),u=e.i(984788),c=e.i(237011),p=e.i(712007),m=e.i(777657),_=e.i(13180),g=e.i(273827),f=e.i(193695);e.i(947956);var y=e.i(36217),h=e.i(414131),v=e.i(433669),w=e.i(38896),R=e.i(221640),C=e.i(233793);async function A(e){try{let t=await (0,w.getCurrentUser)();if(!t)return h.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let a=(0,v.createServiceClient)();if(!await (0,R.isSuperAdmin)(a,t.id))return h.NextResponse.json({success:!1,error:"Forbidden"},{status:403});let r=e.nextUrl.searchParams,i=parseInt(r.get("page")||"1"),s=parseInt(r.get("pageSize")||"50"),n=r.get("search")||"",l=r.get("role")||"",o=l?l.split(",").filter(Boolean):[],d=r.get("entityType")||"",u=d?d.split(",").filter(Boolean):[],c=r.get("status")||"",p=c?c.split(",").filter(Boolean):[],m=r.get("kycStatus")||"",_=r.get("hasEntities"),g=r.get("sortBy")||"createdAt",f=r.get("sortOrder")||"desc",y="true"===r.get("includeDeleted"),A=a.from("profiles").select("id, display_name, email, role, title, phone, office_location, avatar_url, created_at, last_login_at, password_set, is_super_admin, signature_specimen_url, deleted_at");y||(A=A.is("deleted_at",null));let{data:E,error:x}=await A;if(x)return console.error("[admin/users] Profiles error:",x),h.NextResponse.json({success:!1,error:"Failed to fetch profiles"},{status:500});let[b,S,P,k,N,T]=await Promise.all([a.from("investor_users").select("user_id, investor_id, role, is_primary, can_sign, ceo_approval_status, investors:investors!investor_users_investor_id_fkey(id, legal_name)"),a.from("partner_users").select("user_id, partner_id, role, is_primary, can_sign, ceo_approval_status, partners:partners!partner_users_partner_fk(id, name, legal_name)"),a.from("lawyer_users").select("user_id, lawyer_id, role, is_primary, can_sign, ceo_approval_status, lawyers:lawyers!lawyer_users_lawyer_fk(id, firm_name, display_name)"),a.from("commercial_partner_users").select("user_id, commercial_partner_id, role, is_primary, can_sign, ceo_approval_status, commercial_partners:commercial_partners!commercial_partner_users_cp_fk(id, name, legal_name)"),a.from("introducer_users").select("user_id, introducer_id, role, is_primary, can_sign, ceo_approval_status, introducers:introducers!introducer_users_introducer_fk(id, legal_name)"),a.from("arranger_users").select("user_id, arranger_id, role, is_primary, can_sign, ceo_approval_status, arranger_entities:arranger_entities!arranger_users_arranger_fk(id, legal_name)")]),U=new Map,D=e=>Array.isArray(e)?e[0]:e;if(b.data)for(let e of b.data){let t=D(e.investors);if(!t)continue;let a=U.get(e.user_id)||[];a.push({id:t.id,name:t.legal_name||"Unnamed Investor",type:"investor",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status}),U.set(e.user_id,a)}if(S.data)for(let e of S.data){let t=D(e.partners);if(!t)continue;let a=U.get(e.user_id)||[];a.push({id:t.id,name:t.name||t.legal_name||"Unnamed Partner",type:"partner",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status}),U.set(e.user_id,a)}if(P.data)for(let e of P.data){let t=D(e.lawyers);if(!t)continue;let a=U.get(e.user_id)||[];a.push({id:t.id,name:t.firm_name||t.display_name||"Unnamed Law Firm",type:"lawyer",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status}),U.set(e.user_id,a)}if(k.data)for(let e of k.data){let t=D(e.commercial_partners);if(!t)continue;let a=U.get(e.user_id)||[];a.push({id:t.id,name:t.name||t.legal_name||"Unnamed Commercial Partner",type:"commercial_partner",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status}),U.set(e.user_id,a)}if(N.data)for(let e of N.data){let t=D(e.introducers);if(!t)continue;let a=U.get(e.user_id)||[];a.push({id:t.id,name:t.legal_name||"Unnamed Introducer",type:"introducer",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status}),U.set(e.user_id,a)}if(T.data)for(let e of T.data){let t=D(e.arranger_entities);if(!t)continue;let a=U.get(e.user_id)||[];a.push({id:t.id,name:t.legal_name||"Unnamed Arranger",type:"arranger",role:e.role||"member",isPrimary:e.is_primary||!1,canSign:e.can_sign||!1,approvalStatus:e.ceo_approval_status}),U.set(e.user_id,a)}let L=E?.map(e=>e.email).filter(Boolean)||[],O="email, kyc_status, id_type, id_expiry_date, nationality, country_of_tax_residency, is_us_citizen",[I,H,M,q,j,F]=L.length>0?await Promise.all([a.from("investor_members").select(O).in("email",L),a.from("partner_members").select(O).in("email",L),a.from("lawyer_members").select(O).in("email",L),a.from("commercial_partner_members").select(O).in("email",L),a.from("introducer_members").select(O).in("email",L),a.from("arranger_members").select(O).in("email",L)]):[{data:[]},{data:[]},{data:[]},{data:[]},{data:[]},{data:[]}],B=[...I.data||[],...H.data||[],...M.data||[],...q.data||[],...j.data||[],...F.data||[]],K={approved:5,submitted:4,pending:3,rejected:2,expired:1},$=new Map;for(let e of B){if(!e.email)continue;let t=$.get(e.email),a=t?.status&&K[t.status]||0,r=e.kyc_status&&K[e.kyc_status]||0;(!t||r>a)&&$.set(e.email,{status:e.kyc_status,idType:e.id_type,idExpiry:e.id_expiry_date,idExpiryWarning:(0,C.getIdExpiryWarning)(e.id_expiry_date),nationality:e.nationality,taxResidency:e.country_of_tax_residency,isUsPerson:e.is_us_citizen||!1})}let z=(E||[]).map(e=>({id:e.id,displayName:e.display_name||"Unknown",email:e.email||"",systemRole:e.role||"investor",title:e.title,phone:e.phone,officeLocation:e.office_location,avatarUrl:e.avatar_url,createdAt:e.created_at,lastLoginAt:e.last_login_at,passwordSet:e.password_set||!1,isSuperAdmin:e.is_super_admin||!1,hasSignature:!!e.signature_specimen_url,isDeleted:!!e.deleted_at,entities:U.get(e.id)||[],entityCount:(U.get(e.id)||[]).length,kyc:e.email&&$.get(e.email)||null}));if(n){let e=n.toLowerCase();z=z.filter(t=>t.displayName.toLowerCase().includes(e)||t.email.toLowerCase().includes(e)||t.title?.toLowerCase().includes(e))}if(o.length>0&&(z=z.filter(e=>o.includes(e.systemRole))),u.length>0&&(z=z.filter(e=>e.entities.some(e=>u.includes(e.type)))),p.length>0){let e=new Date(Date.now()-2592e6);z=z.filter(t=>{let a;return a=t.isDeleted?"deactivated":t.lastLoginAt?new Date(t.lastLoginAt)>e?"active":"inactive":"pending",p.includes(a)})}if(m&&"all"!==m&&(z=z.filter(e=>e.kyc?.status===m)),null!=_){let e="true"===_;z=z.filter(t=>e?t.entityCount>0:0===t.entityCount)}let W={total:z.length,active:z.filter(e=>e.lastLoginAt&&new Date(e.lastLoginAt)>new Date(Date.now()-2592e6)).length,staff:z.filter(e=>e.systemRole.startsWith("staff_")||"ceo"===e.systemRole).length,investors:z.filter(e=>e.entities.some(e=>"investor"===e.type)).length,partners:z.filter(e=>e.entities.some(e=>"partner"===e.type)).length,lawyers:z.filter(e=>e.entities.some(e=>"lawyer"===e.type)).length,introducers:z.filter(e=>e.entities.some(e=>"introducer"===e.type)).length,arrangers:z.filter(e=>e.entities.some(e=>"arranger"===e.type)).length,pendingKyc:z.filter(e=>e.kyc?.status==="pending"||e.kyc?.status==="submitted").length,superAdmins:z.filter(e=>e.isSuperAdmin).length};z.sort((e,t)=>{let a,r;switch(g){case"displayName":a=e.displayName.toLowerCase(),r=t.displayName.toLowerCase();break;case"email":a=e.email.toLowerCase(),r=t.email.toLowerCase();break;case"systemRole":a=e.systemRole,r=t.systemRole;break;case"entityCount":a=e.entityCount,r=t.entityCount;break;case"lastLoginAt":a=e.lastLoginAt?new Date(e.lastLoginAt).getTime():0,r=t.lastLoginAt?new Date(t.lastLoginAt).getTime():0;break;default:a=new Date(e.createdAt).getTime(),r=new Date(t.createdAt).getTime()}return"asc"===f?a<r?-1:+(a>r):a>r?-1:+(a<r)});let G=z.length,V=Math.ceil(G/s),X=(i-1)*s,Z=z.slice(X,X+s);return h.NextResponse.json({success:!0,data:Z,stats:W,pagination:{page:i,pageSize:s,totalPages:V,totalCount:G}})}catch(t){console.error("[admin/users] Error:",t);let e=t instanceof Error?t.message:"Failed to fetch users";return h.NextResponse.json({success:!1,error:e},{status:500})}}e.s(["GET",()=>A],223295);var E=e.i(223295);let x=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/admin/users/route",pathname:"/api/admin/users",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/admin/users/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:b,workUnitAsyncStorage:S,serverHooks:P}=x;function k(){return(0,r.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:S})}async function N(e,t,r){x.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let h="/api/admin/users/route";h=h.replace(/\/index$/,"")||"/";let v=await x.prepare(e,t,{srcPage:h,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:R,nextConfig:C,parsedUrl:A,isDraftMode:E,prerenderManifest:b,routerServerContext:S,isOnDemandRevalidate:P,revalidateOnlyGenerated:k,resolvedPathname:N,clientReferenceManifest:T,serverActionsManifest:U}=v,D=(0,l.normalizeAppPath)(h),L=!!(b.dynamicRoutes[D]||b.routes[N]),O=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,A,!1):t.end("This page could not be found"),null);if(L&&!E){let e=!!b.routes[N],t=b.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await O();throw new f.NoFallbackError}}let I=null;!L||x.isDev||E||(I="/index"===(I=N)?"/":I);let H=!0===x.isDev||!L,M=L&&!H;U&&T&&(0,n.setManifestsSingleton)({page:h,clientReferenceManifest:T,serverActionsManifest:U});let q=e.method||"GET",j=(0,s.getTracer)(),F=j.getActiveScopeSpan(),B={params:R,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,i)=>x.onRequestError(e,t,r,i,S)},sharedContext:{buildId:w}},K=new o.NodeNextRequest(e),$=new o.NodeNextResponse(t),z=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let n=async e=>x.handle(z,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=j.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${q} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${h}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),o=async i=>{var s,o;let d=async({previousCacheEntry:a})=>{try{if(!l&&P&&k&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await n(i);e.fetchMetrics=B.renderOpts.fetchMetrics;let o=B.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let d=B.renderOpts.collectedTags;if(!L)return await (0,p.sendResponse)(K,$,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,r=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:h,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:P})},!1,S),t}},u=await x.handleResponse({req:e,nextConfig:C,cacheKey:I,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:k,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:l});if(!L)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(o=u.value)?void 0:o.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",P?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&L||f.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,_.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(K,$,new Response(u.value.body,{headers:f,status:u.value.status||200})),null};F?await o(F):await j.withPropagatedContext(e.headers,()=>j.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${h}`,kind:s.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},o))}catch(t){if(t instanceof f.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:P})},!1,S),L)throw t;return await (0,p.sendResponse)(K,$,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>k,"routeModule",()=>x,"serverHooks",()=>P,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>S],6929)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_f0ac475c.js.map