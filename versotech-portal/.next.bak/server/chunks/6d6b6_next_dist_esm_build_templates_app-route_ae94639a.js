module.exports=[704246,e=>{"use strict";var t=e.i(779444),r=e.i(698261),i=e.i(821776),o=e.i(796417),n=e.i(856890),s=e.i(26996),a=e.i(436944),l=e.i(88281),d=e.i(765944),u=e.i(984788),c=e.i(237011),p=e.i(712007),m=e.i(777657),v=e.i(13180),_=e.i(273827),f=e.i(193695);e.i(947956);var y=e.i(36217),h=e.i(414131),g=e.i(433669),w=e.i(627291);async function R(e,{params:t}){let{id:r}=await t;try{let t=await (0,g.createClient)(),{data:{user:i},error:o}=await t.auth.getUser();if(o||!i)return h.NextResponse.json({error:"Unauthorized"},{status:401});let{data:n}=await t.from("profiles").select("role, display_name, email").eq("id",i.id).single();if(!n||!(n.role.startsWith("staff_")||"ceo"===n.role))return h.NextResponse.json({error:"Staff access required"},{status:403});let{action:s,rejection_reason:a,notes:l}=await e.json();if(!s||!["approve","reject","request_info"].includes(s))return h.NextResponse.json({error:'Invalid action. Must be "approve", "reject", or "request_info"'},{status:400});if("reject"===s&&!a)return h.NextResponse.json({error:"Rejection reason is required when rejecting"},{status:400});if("request_info"===s&&!a)return h.NextResponse.json({error:"Please specify what additional information is needed"},{status:400});let d=(0,g.createServiceClient)(),{data:u,error:c}=await d.from("kyc_submissions").select(`
        *,
        investor:investors(id, legal_name, display_name, email, kyc_status)
      `).eq("id",r).single();if(c||!u)return h.NextResponse.json({error:"Submission not found"},{status:404});if(!["pending","under_review"].includes(u.status))return h.NextResponse.json({error:`Cannot review submission with status: ${u.status}`},{status:400});let p={status:"approve"===s?"approved":"reject"===s?"rejected":"pending",reviewed_at:new Date().toISOString(),reviewed_by:i.id};"reject"===s&&(p.rejection_reason=a),"request_info"===s?p.metadata={...u.metadata||{},info_requested:!0,info_request_reason:a,info_requested_at:new Date().toISOString(),info_requested_by:i.id,review_notes:l||void 0}:l&&(p.metadata={...u.metadata||{},review_notes:l});let{data:m,error:v}=await d.from("kyc_submissions").update(p).eq("id",r).select().single();if(v)return console.error("Error updating submission:",v),h.NextResponse.json({error:"Failed to update submission"},{status:500});"approve"===s&&await b(d,u.investor.id),"approve"===s&&await C(d,u.investor.id,u.document_type,i.id),await d.from("audit_logs").insert({event_type:"compliance",actor_id:i.id,action:{approve:"kyc_document_approved",reject:"kyc_document_rejected",request_info:"kyc_info_requested"}[s],entity_type:"kyc_submission",entity_id:r,action_details:{document_type:u.document_type,investor_id:u.investor.id,investor_name:u.investor.legal_name||u.investor.display_name,rejection_reason:a||null,info_request_reason:"request_info"===s?a:null,notes:l||null},timestamp:new Date().toISOString()});try{let e=await (0,w.getInvestorPrimaryUserId)(u.investor.id);e&&(u.investor.display_name||u.investor.legal_name,"approve"===s?await (0,w.createInvestorNotification)({userId:e,investorId:u.investor.id,title:"KYC Documents Approved",message:"Your KYC documents have been reviewed and approved. Thank you for completing your verification.",link:"/versotech_main/documents",type:"kyc_status",extraMetadata:{submission_id:r,document_type:u.document_type}}):"request_info"===s?await (0,w.createInvestorNotification)({userId:e,investorId:u.investor.id,title:"Additional Information Requested",message:`Our compliance team has requested additional information for your ${u.document_type.replace(/_/g," ")} submission. Please review and provide the requested details.`,link:"/versotech_main/documents",type:"kyc_status",extraMetadata:{submission_id:r,document_type:u.document_type,info_request_reason:a}}):await (0,w.createInvestorNotification)({userId:e,investorId:u.investor.id,title:"KYC Submission Requires Attention",message:`Your ${u.document_type.replace(/_/g," ")} submission requires attention. Please review and resubmit.`,link:"/versotech_main/documents",type:"kyc_status",extraMetadata:{submission_id:r,document_type:u.document_type,rejection_reason:a}}))}catch(e){console.error("[kyc-review] Failed to send notification:",e)}return h.NextResponse.json({success:!0,submission:m,message:{approve:"Document approved successfully",reject:"Document rejected successfully",request_info:"Information request sent to investor"}[s]})}catch(e){return console.error("KYC review error:",e),h.NextResponse.json({error:"Internal server error"},{status:500})}}async function b(e,t){try{let{data:r}=await e.from("investors").select("type, kyc_status").eq("id",t).single();if(!r)return;let i=["entity","institution","corporate"].includes(r.type),{data:o}=await e.from("kyc_submissions").select("document_type, status, investor_member_id").eq("investor_id",t).is("counterparty_entity_id",null);if(!o)return;let n=(e,t)=>o.some(r=>r.document_type===e&&"approved"===r.status&&(void 0===t||r.investor_member_id===t)),s=e=>n("passport_id",e)||n("passport",e);if(i){if(!["incorporation_certificate","memo_articles","register_members","register_directors","bank_confirmation"].every(e=>n(e,null)))return void console.log(`[KYC Status] Investor ${t}: Entity documents not all approved`);let{data:r}=await e.from("investor_members").select("id, full_name").eq("investor_id",t).eq("is_active",!0),i=[];if(r&&r.length>0)for(let e of r){let r=s(e.id),o=n("utility_bill",e.id);if(r&&o)i.push(e.id);else{r||console.log(`[KYC Status] Investor ${t}: Member ${e.full_name} missing approved ID document`),o||console.log(`[KYC Status] Investor ${t}: Member ${e.full_name} missing approved utility_bill`);return}}i.length>0&&(await e.from("investor_members").update({kyc_status:"approved"}).in("id",i).neq("kyc_status","approved"),console.log(`[KYC Status] Updated ${i.length} member(s) to approved`))}else{if(!s(null))return void console.log(`[KYC Status] Investor ${t}: Individual ID document not approved`);if(!n("utility_bill",null))return void console.log(`[KYC Status] Investor ${t}: Individual utility_bill not approved`)}"approved"!==r.kyc_status&&(await e.from("investors").update({kyc_status:"approved",kyc_completed_at:new Date().toISOString()}).eq("id",t),console.log(`[KYC Status] Investor ${t}: KYC status updated to approved`))}catch(e){console.error("Error checking investor KYC status:",e)}}async function C(e,t,r,i){try{let o={passport_id:"Upload ID",passport:"Upload ID",utility_bill:"Upload Utility Bill",incorporation_certificate:"Upload Incorporation",memo_articles:"Upload Memo",register_members:"Upload Register of Members",register_directors:"Upload Register of Directors",register_beneficial_owners:"Upload Register of UBOs",bank_confirmation:"Upload Bank Confirmation",other:"Upload Document"}[r];if(!o)return;await e.from("tasks").update({status:"completed",completed_at:new Date().toISOString(),completed_by:i}).eq("investor_id",t).ilike("title",`%${o}%`).eq("status","pending")}catch(e){console.error("Error auto-completing tasks:",e)}}e.s(["POST",()=>R],173697);var q=e.i(173697);let I=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/staff/kyc-submissions/[id]/review/route",pathname:"/api/staff/kyc-submissions/[id]/review",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/versotech-portal/src/app/api/staff/kyc-submissions/[id]/review/route.ts",nextConfigOutput:"",userland:q}),{workAsyncStorage:k,workUnitAsyncStorage:E,serverHooks:x}=I;function S(){return(0,i.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:E})}async function N(e,t,i){I.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let h="/api/staff/kyc-submissions/[id]/review/route";h=h.replace(/\/index$/,"")||"/";let g=await I.prepare(e,t,{srcPage:h,multiZoneDraftMode:!1});if(!g)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:w,params:R,nextConfig:b,parsedUrl:C,isDraftMode:q,prerenderManifest:k,routerServerContext:E,isOnDemandRevalidate:x,revalidateOnlyGenerated:S,resolvedPathname:N,clientReferenceManifest:j,serverActionsManifest:A}=g,U=(0,a.normalizeAppPath)(h),O=!!(k.dynamicRoutes[U]||k.routes[N]),P=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,C,!1):t.end("This page could not be found"),null);if(O&&!q){let e=!!k.routes[N],t=k.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await P();throw new f.NoFallbackError}}let D=null;!O||I.isDev||q||(D="/index"===(D=N)?"/":D);let T=!0===I.isDev||!O,$=O&&!T;A&&j&&(0,s.setManifestsSingleton)({page:h,clientReferenceManifest:j,serverActionsManifest:A});let K=e.method||"GET",M=(0,n.getTracer)(),H=M.getActiveScopeSpan(),Y={params:R,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:T,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i,o)=>I.onRequestError(e,t,i,o,E)},sharedContext:{buildId:w}},F=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),L=d.NextRequestAdapter.fromNodeNextRequest(F,(0,d.signalFromNodeResponse)(t));try{let s=async e=>I.handle(L,Y).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=M.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${K} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${K} ${h}`)}),a=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var n,l;let d=async({previousCacheEntry:r})=>{try{if(!a&&x&&S&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(o);e.fetchMetrics=Y.renderOpts.fetchMetrics;let l=Y.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let d=Y.renderOpts.collectedTags;if(!O)return await (0,p.sendResponse)(F,B,n,Y.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[_.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==Y.renderOpts.collectedRevalidate&&!(Y.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&Y.renderOpts.collectedRevalidate,i=void 0===Y.renderOpts.collectedExpire||Y.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:Y.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:h,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:x})},!1,E),t}},u=await I.handleResponse({req:e,nextConfig:b,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:S,responseGenerator:d,waitUntil:i.waitUntil,isMinimalMode:a});if(!O)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});a||t.setHeader("x-nextjs-cache",x?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),q&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return a&&O||f.delete(_.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,v.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(F,B,new Response(u.value.body,{headers:f,status:u.value.status||200})),null};H?await l(H):await M.withPropagatedContext(e.headers,()=>M.trace(u.BaseServerSpan.handleRequest,{spanName:`${K} ${h}`,kind:n.SpanKind.SERVER,attributes:{"http.method":K,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:x})},!1,E),O)throw t;return await (0,p.sendResponse)(F,B,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>S,"routeModule",()=>I,"serverHooks",()=>x,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>E],704246)}];

//# sourceMappingURL=6d6b6_next_dist_esm_build_templates_app-route_ae94639a.js.map