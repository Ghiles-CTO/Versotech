{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,MAAM,eAAe;IAC1B,MAAM,cAAc,MAAM,IAAA,mKAAO;IAEjC,OAAO,IAAA,wNAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;wBAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAC/B;gBACF,EAAE,OAAO,OAAO;gBACd,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ;AAIO,MAAM,sBAAsB;IACjC,OAAO,IAAA,gOAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB,EACrC;QACE,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AAEJ"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/api/partners/me/fee-models/route.ts"],"sourcesContent":["import { createClient, createServiceClient } from '@/lib/supabase/server'\nimport { NextResponse } from 'next/server'\n\n/**\n * GET /api/partners/me/fee-models\n * Returns fee models assigned to the current partner or deals they are entitled to.\n *\n * IMPORTANT: Per Fred's requirements:\n * - Partners CAN see term sheets (unlike introducers who cannot)\n * - This API includes term_sheet data in the response\n */\nexport async function GET() {\n  const supabase = await createClient()\n  const serviceSupabase = createServiceClient()\n\n  try {\n    const { data: { user }, error: userError } = await supabase.auth.getUser()\n    if (userError || !user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const { data: partnerUser, error: partnerUserError } = await serviceSupabase\n      .from('partner_users')\n      .select('partner_id')\n      .eq('user_id', user.id)\n      .maybeSingle()\n\n    if (partnerUserError) {\n      console.error('[fee-models] Partner lookup error:', partnerUserError)\n      return NextResponse.json({ error: 'Failed to load partner profile' }, { status: 500 })\n    }\n\n    if (!partnerUser?.partner_id) {\n      return NextResponse.json({ error: 'Partner profile not found' }, { status: 404 })\n    }\n\n    const { data: memberships, error: membershipsError } = await serviceSupabase\n      .from('deal_memberships')\n      .select('deal_id')\n      .eq('user_id', user.id)\n\n    if (membershipsError) {\n      console.error('[fee-models] Membership lookup error:', membershipsError)\n      return NextResponse.json({ error: 'Failed to load deal memberships' }, { status: 500 })\n    }\n\n    const { data: referrals, error: referralsError } = await serviceSupabase\n      .from('deal_memberships')\n      .select('deal_id')\n      .eq('referred_by_entity_type', 'partner')\n      .eq('referred_by_entity_id', partnerUser.partner_id)\n\n    if (referralsError) {\n      console.error('[fee-models] Referral lookup error:', referralsError)\n      return NextResponse.json({ error: 'Failed to load referral deals' }, { status: 500 })\n    }\n\n    const dealIds = Array.from(\n      new Set([\n        ...(memberships || []).map(m => m.deal_id).filter(Boolean),\n        ...(referrals || []).map(r => r.deal_id).filter(Boolean)\n      ])\n    )\n\n    // Partners CAN see term sheets (per Fred's requirements)\n    let query = serviceSupabase\n      .from('fee_plans')\n      .select(`\n        id,\n        name,\n        description,\n        status,\n        is_active,\n        is_default,\n        effective_from,\n        effective_until,\n        accepted_at,\n        accepted_by,\n        invoice_requests_enabled,\n        deal:deal_id (\n          id,\n          name,\n          company_name,\n          status,\n          close_at\n        ),\n        term_sheet:term_sheet_id (\n          id,\n          version,\n          status,\n          term_sheet_date,\n          subscription_fee_percent,\n          management_fee_percent,\n          carried_interest_percent\n        ),\n        fee_components (\n          id,\n          kind,\n          rate_bps,\n          flat_amount,\n          calc_method,\n          frequency,\n          duration_periods,\n          duration_unit,\n          payment_schedule\n        )\n      `)\n      .order('created_at', { ascending: false })\n\n    if (dealIds.length > 0) {\n      query = query.or(`partner_id.eq.${partnerUser.partner_id},deal_id.in.(${dealIds.join(',')})`)\n    } else {\n      query = query.eq('partner_id', partnerUser.partner_id)\n    }\n\n    const { data: feePlans, error: feePlansError } = await query\n\n    if (feePlansError) {\n      console.error('[fee-models] Fee plan fetch error:', feePlansError)\n      return NextResponse.json({ error: 'Failed to fetch fee models' }, { status: 500 })\n    }\n\n    return NextResponse.json({ fee_models: feePlans || [] })\n  } catch (error) {\n    console.error('Unexpected error in GET /api/partners/me/fee-models:', error)\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}