module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient,
    "createServiceClient",
    ()=>createServiceClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
;
const createClient = async ()=>{
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ3V4ZHNzZWNmZXh1ZG52dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4MzcsImV4cCI6MjA3MzkzNzgzN30.AGxM_YW9hfxuu7xDpi_4xhOoRhYM7iGTS1vJ0z2FByE"), {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>{
                        cookieStore.set(name, value, options);
                    });
                } catch (error) {
                // The `setAll` method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            }
        }
    });
};
const createServiceClient = ()=>{
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), process.env.SUPABASE_SERVICE_ROLE_KEY, {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    });
};
}),
"[project]/versotech-portal/src/app/api/commercial-partners/proxy-subscribe/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET,
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/zod/v4/classic/external.js [app-route] (ecmascript) <export * as z>");
;
;
;
const proxySubscribeSchema = __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].object({
    deal_id: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().uuid(),
    client_investor_id: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().uuid(),
    commitment: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].number().positive(),
    stock_type: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].enum([
        'common',
        'preferred',
        'convertible',
        'warrant',
        'bond',
        'note',
        'other'
    ]).optional().default('common'),
    notes: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().optional(),
    proxy_authorization_doc_id: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().uuid().optional() // Optional reference to authorization document
});
async function POST(request) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
    const serviceSupabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceClient"])();
    try {
        // Authenticate user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        // Verify user is a commercial partner with proxy capability
        const { data: cpLinks } = await serviceSupabase.from('commercial_partner_users').select(`
        commercial_partner_id,
        can_execute_for_clients,
        role,
        commercial_partners (
          id,
          name,
          legal_name,
          status,
          cp_type
        )
      `).eq('user_id', user.id).eq('can_execute_for_clients', true);
        if (!cpLinks || cpLinks.length === 0) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Forbidden',
                message: 'You are not authorized to execute subscriptions for clients. Contact your administrator to enable proxy capability.'
            }, {
                status: 403
            });
        }
        const cpLink = cpLinks[0];
        const commercialPartner = cpLink.commercial_partners;
        if (commercialPartner?.status !== 'active') {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Commercial partner not active',
                message: 'Your commercial partner account is not active.'
            }, {
                status: 403
            });
        }
        // Parse and validate request body
        const body = await request.json();
        const validation = proxySubscribeSchema.safeParse(body);
        if (!validation.success) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Invalid request',
                details: validation.error.flatten()
            }, {
                status: 400
            });
        }
        const { deal_id, client_investor_id, commitment, stock_type, notes, proxy_authorization_doc_id } = validation.data;
        // Verify deal exists and is open
        const { data: deal, error: dealError } = await serviceSupabase.from('deals').select('id, name, status, vehicle_id, minimum_investment, maximum_investment').eq('id', deal_id).single();
        if (dealError || !deal) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Deal not found'
            }, {
                status: 404
            });
        }
        if (deal.status !== 'open' && deal.status !== 'allocation_pending') {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Deal not open for subscriptions',
                message: `Deal is currently ${deal.status}`
            }, {
                status: 400
            });
        }
        // SECURITY: Verify the commercial partner user has been dispatched to this deal
        // This prevents CPs from subscribing to deals they don't have access to
        // NOTE: deal_memberships uses composite key (deal_id, user_id), not a separate id column
        const { data: cpDealMembership } = await serviceSupabase.from('deal_memberships').select('deal_id, user_id, role, dispatched_at').eq('deal_id', deal_id).eq('user_id', user.id).in('role', [
            'commercial_partner_investor',
            'commercial_partner_proxy'
        ]).maybeSingle();
        if (!cpDealMembership) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Not authorized for this deal',
                message: 'You have not been dispatched to this deal. Contact your relationship manager for access.'
            }, {
                status: 403
            });
        }
        // Verify client investor exists
        const { data: clientInvestor, error: investorError } = await serviceSupabase.from('investors').select('id, legal_name, type, kyc_status').eq('id', client_investor_id).single();
        if (investorError || !clientInvestor) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Client investor not found'
            }, {
                status: 404
            });
        }
        // Verify client investor has completed KYC
        if (clientInvestor.kyc_status !== 'approved' && clientInvestor.kyc_status !== 'verified') {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Client KYC not complete',
                message: 'Client investor must complete KYC before subscribing.',
                kyc_status: clientInvestor.kyc_status
            }, {
                status: 400
            });
        }
        // Check commitment limits
        if (deal.minimum_investment && commitment < deal.minimum_investment) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Below minimum investment',
                message: `Minimum investment is ${deal.minimum_investment}`
            }, {
                status: 400
            });
        }
        if (deal.maximum_investment && commitment > deal.maximum_investment) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Exceeds maximum investment',
                message: `Maximum investment is ${deal.maximum_investment}`
            }, {
                status: 400
            });
        }
        // Check if subscription already exists
        const { data: existingSub } = await serviceSupabase.from('subscriptions').select('id, status').eq('deal_id', deal_id).eq('investor_id', client_investor_id).not('status', 'in', '(cancelled,rejected)').maybeSingle();
        if (existingSub) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Subscription already exists',
                message: 'Client already has a subscription for this deal.',
                subscription_id: existingSub.id,
                status: existingSub.status
            }, {
                status: 400
            });
        }
        // Create the subscription as proxy
        const now = new Date().toISOString();
        const { data: subscription, error: subError } = await serviceSupabase.from('subscriptions').insert({
            deal_id,
            vehicle_id: deal.vehicle_id,
            investor_id: client_investor_id,
            commitment,
            funded_amount: 0,
            status: 'pending',
            // Note: stock_type removed - column doesn't exist in subscriptions table
            // Use acknowledgement_notes instead of notes (correct column name)
            acknowledgement_notes: notes,
            // Proxy-specific fields
            submitted_by_proxy: true,
            proxy_user_id: user.id,
            proxy_commercial_partner_id: cpLink.commercial_partner_id,
            proxy_authorization_doc_id,
            created_at: now
        }).select().single();
        if (subError) {
            console.error('Error creating proxy subscription:', subError);
            // Check if it's a missing column error
            if (subError.message?.includes('submitted_by_proxy')) {
                // Fallback without proxy fields if columns don't exist yet
                const { data: fallbackSub, error: fallbackError } = await serviceSupabase.from('subscriptions').insert({
                    deal_id,
                    vehicle_id: deal.vehicle_id,
                    investor_id: client_investor_id,
                    commitment,
                    funded_amount: 0,
                    status: 'pending',
                    acknowledgement_notes: `${notes || ''}\n[Submitted by proxy: ${commercialPartner?.name} via ${user.email}]`.trim(),
                    created_at: now
                }).select().single();
                if (fallbackError) {
                    return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                        error: 'Failed to create subscription'
                    }, {
                        status: 500
                    });
                }
                // Log audit event with proxy info
                await serviceSupabase.from('audit_logs').insert({
                    user_id: user.id,
                    action: 'proxy_subscription_created',
                    entity_type: 'subscription',
                    entity_id: fallbackSub.id,
                    details: {
                        deal_id,
                        deal_name: deal.name,
                        client_investor_id,
                        client_name: clientInvestor.legal_name,
                        commitment,
                        commercial_partner_id: cpLink.commercial_partner_id,
                        commercial_partner_name: commercialPartner?.name
                    },
                    created_at: now
                });
                return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    success: true,
                    subscription_id: fallbackSub.id,
                    message: `Subscription submitted on behalf of ${clientInvestor.legal_name}`,
                    proxy_mode: true,
                    client: {
                        id: client_investor_id,
                        name: clientInvestor.legal_name
                    },
                    deal: {
                        id: deal_id,
                        name: deal.name
                    },
                    commitment
                });
            }
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to create subscription'
            }, {
                status: 500
            });
        }
        // Log audit event
        await serviceSupabase.from('audit_logs').insert({
            user_id: user.id,
            action: 'proxy_subscription_created',
            entity_type: 'subscription',
            entity_id: subscription.id,
            details: {
                deal_id,
                deal_name: deal.name,
                client_investor_id,
                client_name: clientInvestor.legal_name,
                commitment,
                commercial_partner_id: cpLink.commercial_partner_id,
                commercial_partner_name: commercialPartner?.name,
                proxy_authorization_doc_id
            },
            created_at: now
        });
        // Create notification for client investor's users
        const { data: clientUsers } = await serviceSupabase.from('investor_users').select('user_id').eq('investor_id', client_investor_id);
        if (clientUsers && clientUsers.length > 0) {
            const notifications = clientUsers.map((u)=>({
                    user_id: u.user_id,
                    investor_id: client_investor_id,
                    title: 'Subscription Submitted',
                    message: `${commercialPartner?.name} has submitted a subscription of ${commitment.toLocaleString()} for ${deal.name} on your behalf.`,
                    link: '/versotech_main/tasks',
                    metadata: {
                        type: 'proxy_subscription',
                        subscription_id: subscription.id,
                        deal_id,
                        commercial_partner_id: cpLink.commercial_partner_id
                    }
                }));
            await serviceSupabase.from('investor_notifications').insert(notifications);
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            subscription_id: subscription.id,
            message: `Subscription submitted on behalf of ${clientInvestor.legal_name}`,
            proxy_mode: true,
            client: {
                id: client_investor_id,
                name: clientInvestor.legal_name,
                type: clientInvestor.type
            },
            deal: {
                id: deal_id,
                name: deal.name
            },
            commitment,
            status: 'pending'
        });
    } catch (error) {
        console.error('Unexpected error in POST /api/commercial-partners/proxy-subscribe:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
async function GET(request) {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
    const serviceSupabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceClient"])();
    try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        // Verify user is a commercial partner with proxy capability
        const { data: cpLinks } = await serviceSupabase.from('commercial_partner_users').select(`
        commercial_partner_id,
        can_execute_for_clients,
        commercial_partners (
          id,
          name,
          status
        )
      `).eq('user_id', user.id).eq('can_execute_for_clients', true);
        // Return empty response if not a commercial partner (don't 403, just indicate no proxy capability)
        if (!cpLinks || cpLinks.length === 0) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                commercial_partner_id: null,
                commercial_partner_name: null,
                clients: [],
                can_execute_for_clients: false
            });
        }
        const cpId = cpLinks[0].commercial_partner_id;
        // Get clients from commercial_partner_clients table (primary source)
        const { data: cpClients } = await serviceSupabase.from('commercial_partner_clients').select(`
        id,
        client_name,
        client_email,
        client_type,
        client_investor_id,
        is_active,
        investor:client_investor_id (
          id,
          legal_name,
          type,
          kyc_status
        )
      `).eq('commercial_partner_id', cpId).eq('is_active', true).order('client_name');
        // Also get legacy clients linked via investors.commercial_partner_id
        const { data: legacyClients } = await serviceSupabase.from('investors').select(`
        id,
        legal_name,
        type,
        kyc_status
      `).eq('commercial_partner_id', cpId).eq('status', 'active').order('legal_name');
        // Combine and dedupe clients (client_investor_id from cpClients overlaps with legacyClients)
        const clientInvestorIds = new Set((cpClients || []).map((c)=>c.client_investor_id).filter(Boolean));
        const uniqueLegacyClients = (legacyClients || []).filter((lc)=>!clientInvestorIds.has(lc.id));
        // Format clients for response
        // IMPORTANT: Field names must match the Client interface in proxy-mode-context.tsx
        // Interface expects: { id, name, investor_type, kyc_status }
        const formattedClients = [
            // Clients from commercial_partner_clients (with or without linked investors)
            ...(cpClients || []).map((c)=>{
                const investor = c.investor;
                return {
                    id: investor?.id || null,
                    name: investor?.legal_name || c.client_name,
                    investor_type: investor?.type || c.client_type || 'entity',
                    kyc_status: investor?.kyc_status || 'not_linked',
                    client_record_id: c.id // Include the client record ID for reference
                };
            }),
            // Legacy clients directly linked to CP
            ...uniqueLegacyClients.map((lc)=>({
                    id: lc.id,
                    name: lc.legal_name,
                    investor_type: lc.type,
                    kyc_status: lc.kyc_status
                }))
        ];
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            commercial_partner_id: cpId,
            commercial_partner_name: cpLinks[0].commercial_partners?.name,
            clients: formattedClients,
            can_execute_for_clients: true
        });
    } catch (error) {
        console.error('Unexpected error in GET /api/commercial-partners/proxy-subscribe:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__bfbb3dff._.js.map