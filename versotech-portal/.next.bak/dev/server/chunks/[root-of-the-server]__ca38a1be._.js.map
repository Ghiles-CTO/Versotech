{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,MAAM,eAAe;IAC1B,MAAM,cAAc,MAAM,IAAA,mKAAO;IAEjC,OAAO,IAAA,wNAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;wBAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAC/B;gBACF,EAAE,OAAO,OAAO;gBACd,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ;AAIO,MAAM,sBAAsB;IACjC,OAAO,IAAA,gOAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB,EACrC;QACE,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AAEJ"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/api-auth.ts"],"sourcesContent":["/**\r\n * Helper to get authenticated user from Supabase auth\r\n * Works with both createClient() and createServiceClient()\r\n */\r\nexport async function getAuthenticatedUser(supabase: any) {\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n\r\n  return {\r\n    user,\r\n    error: authError\r\n  }\r\n}\r\n\r\n/**\r\n * Get user role from database profile\r\n */\r\nexport async function getUserRole(supabase: any, user: any): Promise<string | null> {\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  return profile?.role || null\r\n}\r\n\r\n/**\r\n * Check if user has a specific permission OR is CEO (CEO bypasses all permission checks)\r\n *\r\n * This centralizes permission checking so that:\r\n * 1. CEO users automatically have ALL permissions without needing staff_permissions entries\r\n * 2. Regular staff users need explicit permissions in staff_permissions table\r\n *\r\n * @param supabase - Supabase client (can be regular or service client)\r\n * @param userId - The user's ID\r\n * @param requiredPermissions - Array of permissions (user needs ANY of these, not all)\r\n * @returns true if user has permission or is CEO\r\n */\r\nexport async function hasPermission(\r\n  supabase: any,\r\n  userId: string,\r\n  requiredPermissions: string[]\r\n): Promise<boolean> {\r\n  // First, check if user is CEO - CEO bypasses all permission checks\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', userId)\r\n    .single()\r\n\r\n  if (profile?.role === 'ceo') {\r\n    return true // CEO has all permissions\r\n  }\r\n\r\n  // Also check if user has CEO persona (for multi_persona users)\r\n  const { data: ceoUser } = await supabase\r\n    .from('ceo_users')\r\n    .select('user_id')\r\n    .eq('user_id', userId)\r\n    .maybeSingle()\r\n\r\n  if (ceoUser) {\r\n    return true // User is in ceo_users table, has all permissions\r\n  }\r\n\r\n  // For non-CEO users, check staff_permissions table\r\n  const { data: permission } = await supabase\r\n    .from('staff_permissions')\r\n    .select('permission')\r\n    .eq('user_id', userId)\r\n    .in('permission', requiredPermissions)\r\n    .limit(1)\r\n    .maybeSingle()\r\n\r\n  return !!permission\r\n}\r\n\r\n/**\r\n * Check if user has super_admin permission OR is CEO\r\n * Convenience function for the most common permission check\r\n */\r\nexport async function isSuperAdmin(supabase: any, userId: string): Promise<boolean> {\r\n  return hasPermission(supabase, userId, ['super_admin'])\r\n}\r\n\r\n/**\r\n * Check if user is staff using both profile role AND persona system\r\n *\r\n * Users can have staff access through:\r\n * 1. Legacy role field: 'staff_*' or 'ceo' in profiles.role\r\n * 2. Persona system: staff or ceo persona via get_user_personas RPC\r\n */\r\nexport async function isStaffUser(supabase: any, user: any): Promise<boolean> {\r\n  // First check legacy role field\r\n  const role = await getUserRole(supabase, user)\r\n  if (role && (role.startsWith('staff_') || role === 'ceo')) {\r\n    return true\r\n  }\r\n\r\n  // For multi_persona users, check personas via RPC\r\n  if (role === 'multi_persona') {\r\n    try {\r\n      const { data: personas } = await supabase.rpc('get_user_personas', {\r\n        p_user_id: user.id\r\n      })\r\n\r\n      if (personas && Array.isArray(personas)) {\r\n        return personas.some(\r\n          (p: any) => p.persona_type === 'staff' || p.persona_type === 'ceo'\r\n        )\r\n      }\r\n    } catch (err) {\r\n      console.error('[isStaffUser] Error checking personas:', err)\r\n    }\r\n  }\r\n\r\n  return false\r\n}\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;;;;;AACM,eAAe,qBAAqB,QAAa;IACtD,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAExE,OAAO;QACL;QACA,OAAO;IACT;AACF;AAKO,eAAe,YAAY,QAAa,EAAE,IAAS;IACxD,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;IAET,OAAO,SAAS,QAAQ;AAC1B;AAcO,eAAe,cACpB,QAAa,EACb,MAAc,EACd,mBAA6B;IAE7B,mEAAmE;IACnE,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,QACT,MAAM;IAET,IAAI,SAAS,SAAS,OAAO;QAC3B,OAAO,KAAK,0BAA0B;;IACxC;IAEA,+DAA+D;IAC/D,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,aACL,MAAM,CAAC,WACP,EAAE,CAAC,WAAW,QACd,WAAW;IAEd,IAAI,SAAS;QACX,OAAO,KAAK,kDAAkD;;IAChE;IAEA,mDAAmD;IACnD,MAAM,EAAE,MAAM,UAAU,EAAE,GAAG,MAAM,SAChC,IAAI,CAAC,qBACL,MAAM,CAAC,cACP,EAAE,CAAC,WAAW,QACd,EAAE,CAAC,cAAc,qBACjB,KAAK,CAAC,GACN,WAAW;IAEd,OAAO,CAAC,CAAC;AACX;AAMO,eAAe,aAAa,QAAa,EAAE,MAAc;IAC9D,OAAO,cAAc,UAAU,QAAQ;QAAC;KAAc;AACxD;AASO,eAAe,YAAY,QAAa,EAAE,IAAS;IACxD,gCAAgC;IAChC,MAAM,OAAO,MAAM,YAAY,UAAU;IACzC,IAAI,QAAQ,CAAC,KAAK,UAAU,CAAC,aAAa,SAAS,KAAK,GAAG;QACzD,OAAO;IACT;IAEA,kDAAkD;IAClD,IAAI,SAAS,iBAAiB;QAC5B,IAAI;YACF,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,qBAAqB;gBACjE,WAAW,KAAK,EAAE;YACpB;YAEA,IAAI,YAAY,MAAM,OAAO,CAAC,WAAW;gBACvC,OAAO,SAAS,IAAI,CAClB,CAAC,IAAW,EAAE,YAAY,KAAK,WAAW,EAAE,YAAY,KAAK;YAEjE;QACF,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,0CAA0C;QAC1D;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 201, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/api/investors/available/route.ts"],"sourcesContent":["import { createClient } from '@/lib/supabase/server'\r\nimport { NextRequest, NextResponse } from 'next/server'\r\nimport { getAuthenticatedUser, isStaffUser } from '@/lib/api-auth'\r\n\r\n/**\r\n * Get list of available investors for group creation\r\n * API Route: /api/investors/available\r\n * Access: Staff only\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    // Authenticate user (supports Supabase auth and demo mode)\r\n    const { user, error: authError } = await getAuthenticatedUser(supabase)\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n    }\r\n\r\n    // Verify user is staff or arranger (check database profile, not JWT metadata)\r\n    const isStaff = await isStaffUser(supabase, user)\r\n\r\n    // Check if user is an arranger\r\n    let isArranger = false\r\n    if (!isStaff) {\r\n      const { data: arrangerUser } = await supabase\r\n        .from('arranger_users')\r\n        .select('arranger_id')\r\n        .eq('user_id', user.id)\r\n        .maybeSingle()\r\n      isArranger = !!arrangerUser\r\n    }\r\n\r\n    if (!isStaff && !isArranger) {\r\n      return NextResponse.json({ error: 'Forbidden - Staff or arranger access only' }, { status: 403 })\r\n    }\r\n\r\n    // Get all investor users with their entities\r\n    const { data: investorUsers, error: investorError} = await supabase\r\n      .from('investor_users')\r\n      .select(`\r\n        user_id,\r\n        investor_id,\r\n        profiles:user_id (\r\n          id,\r\n          display_name,\r\n          email,\r\n          role\r\n        )\r\n      `)\r\n\r\n    if (investorError) {\r\n      console.error('Error fetching investors:', investorError)\r\n      return NextResponse.json({ error: 'Failed to fetch investors' }, { status: 500 })\r\n    }\r\n\r\n    // Now get entity info separately to avoid join issues\r\n    const investorIds = (investorUsers || []).map((u: any) => u.investor_id).filter(Boolean)\r\n    \r\n    const entitiesMap = new Map()\r\n    if (investorIds.length > 0) {\r\n      const { data: entities } = await supabase\r\n        .from('investor_entities')\r\n        .select('id, entity_name, entity_type')\r\n        .in('id', investorIds)\r\n      \r\n      entities?.forEach(entity => {\r\n        entitiesMap.set(entity.id, entity)\r\n      })\r\n    }\r\n\r\n    // Normalize the data with entity information\r\n    const investors = (investorUsers || [])\r\n      .filter((item: any) => item.profiles) // Filter out any without profile data\r\n      .map((item: any) => {\r\n        const profile = item.profiles\r\n        const entity = entitiesMap.get(item.investor_id)\r\n        const baseDisplayName = profile.display_name?.trim()\r\n\r\n        // Provide fallback display names if needed\r\n        let displayName = baseDisplayName\r\n        if (!displayName) {\r\n          const emailPrefix = profile.email?.split('@')[0] || 'Investor'\r\n          displayName = emailPrefix.charAt(0).toUpperCase() + emailPrefix.slice(1)\r\n        }\r\n\r\n        return {\r\n          id: profile.id,\r\n          display_name: displayName,\r\n          email: profile.email || null,\r\n          role: profile.role || 'investor',\r\n          investor_id: item.investor_id,\r\n          entity_name: entity?.entity_name || null,\r\n          entity_type: entity?.entity_type || null,\r\n        }\r\n      })\r\n\r\n    return NextResponse.json({\r\n      investors\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('Get available investors error:', error)\r\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\r\n  }\r\n}\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAOO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,yKAAY;QAEnC,2DAA2D;QAC3D,MAAM,EAAE,IAAI,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,IAAA,0KAAoB,EAAC;QAC9D,IAAI,aAAa,CAAC,MAAM;YACtB,OAAO,uKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,8EAA8E;QAC9E,MAAM,UAAU,MAAM,IAAA,iKAAW,EAAC,UAAU;QAE5C,+BAA+B;QAC/B,IAAI,aAAa;QACjB,IAAI,CAAC,SAAS;YACZ,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,kBACL,MAAM,CAAC,eACP,EAAE,CAAC,WAAW,KAAK,EAAE,EACrB,WAAW;YACd,aAAa,CAAC,CAAC;QACjB;QAEA,IAAI,CAAC,WAAW,CAAC,YAAY;YAC3B,OAAO,uKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA4C,GAAG;gBAAE,QAAQ;YAAI;QACjG;QAEA,6CAA6C;QAC7C,MAAM,EAAE,MAAM,aAAa,EAAE,OAAO,aAAa,EAAC,GAAG,MAAM,SACxD,IAAI,CAAC,kBACL,MAAM,CAAC,CAAC;;;;;;;;;MAST,CAAC;QAEH,IAAI,eAAe;YACjB,QAAQ,KAAK,CAAC,6BAA6B;YAC3C,OAAO,uKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA4B,GAAG;gBAAE,QAAQ;YAAI;QACjF;QAEA,sDAAsD;QACtD,MAAM,cAAc,CAAC,iBAAiB,EAAE,EAAE,GAAG,CAAC,CAAC,IAAW,EAAE,WAAW,EAAE,MAAM,CAAC;QAEhF,MAAM,cAAc,IAAI;QACxB,IAAI,YAAY,MAAM,GAAG,GAAG;YAC1B,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,qBACL,MAAM,CAAC,gCACP,EAAE,CAAC,MAAM;YAEZ,UAAU,QAAQ,CAAA;gBAChB,YAAY,GAAG,CAAC,OAAO,EAAE,EAAE;YAC7B;QACF;QAEA,6CAA6C;QAC7C,MAAM,YAAY,CAAC,iBAAiB,EAAE,EACnC,MAAM,CAAC,CAAC,OAAc,KAAK,QAAQ,EAAE,sCAAsC;SAC3E,GAAG,CAAC,CAAC;YACJ,MAAM,UAAU,KAAK,QAAQ;YAC7B,MAAM,SAAS,YAAY,GAAG,CAAC,KAAK,WAAW;YAC/C,MAAM,kBAAkB,QAAQ,YAAY,EAAE;YAE9C,2CAA2C;YAC3C,IAAI,cAAc;YAClB,IAAI,CAAC,aAAa;gBAChB,MAAM,cAAc,QAAQ,KAAK,EAAE,MAAM,IAAI,CAAC,EAAE,IAAI;gBACpD,cAAc,YAAY,MAAM,CAAC,GAAG,WAAW,KAAK,YAAY,KAAK,CAAC;YACxE;YAEA,OAAO;gBACL,IAAI,QAAQ,EAAE;gBACd,cAAc;gBACd,OAAO,QAAQ,KAAK,IAAI;gBACxB,MAAM,QAAQ,IAAI,IAAI;gBACtB,aAAa,KAAK,WAAW;gBAC7B,aAAa,QAAQ,eAAe;gBACpC,aAAa,QAAQ,eAAe;YACtC;QACF;QAEF,OAAO,uKAAY,CAAC,IAAI,CAAC;YACvB;QACF;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kCAAkC;QAChD,OAAO,uKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF"}}]
}