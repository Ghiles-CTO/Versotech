module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient,
    "createServiceClient",
    ()=>createServiceClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
;
const createClient = async ()=>{
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ3V4ZHNzZWNmZXh1ZG52dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4MzcsImV4cCI6MjA3MzkzNzgzN30.AGxM_YW9hfxuu7xDpi_4xhOoRhYM7iGTS1vJ0z2FByE"), {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>{
                        cookieStore.set(name, value, options);
                    });
                } catch (error) {
                // The `setAll` method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            }
        }
    });
};
const createServiceClient = ()=>{
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), process.env.SUPABASE_SERVICE_ROLE_KEY, {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    });
};
}),
"[project]/versotech-portal/src/lib/audit.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "AuditActions",
    ()=>AuditActions,
    "AuditEntities",
    ()=>AuditEntities,
    "auditLogger",
    ()=>auditLogger
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)");
;
class AuditLogger {
    static instance;
    static getInstance() {
        if (!AuditLogger.instance) {
            AuditLogger.instance = new AuditLogger();
        }
        return AuditLogger.instance;
    }
    async log(entry) {
        try {
            const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
            // Insert into audit_logs with correct column names
            await supabase.from('audit_logs').insert({
                event_type: 'system',
                actor_id: entry.actor_user_id || null,
                action: entry.action,
                entity_type: entry.entity,
                entity_id: entry.entity_id || null,
                action_details: entry.metadata || null,
                timestamp: new Date().toISOString()
            });
        } catch (error) {
            console.error('Audit logging failed:', error);
        // Don't throw to avoid breaking the main operation
        }
    }
    async logMany(entries) {
        for (const entry of entries){
            await this.log(entry);
        }
    }
}
const auditLogger = AuditLogger.getInstance();
const AuditActions = {
    // Authentication
    LOGIN: 'login',
    LOGOUT: 'logout',
    PASSWORD_CHANGE: 'password_change',
    // Data operations
    CREATE: 'create',
    READ: 'read',
    UPDATE: 'update',
    DELETE: 'delete',
    // Documents
    DOCUMENT_UPLOAD: 'document_upload',
    DOCUMENT_DOWNLOAD: 'document_download',
    DOCUMENT_DELETE: 'document_delete',
    // Workflows
    WORKFLOW_TRIGGER: 'workflow_trigger',
    WORKFLOW_COMPLETED: 'workflow_completed',
    WORKFLOW_FAILED: 'workflow_failed',
    // System operations
    USER_CREATED: 'user_created',
    PROFILE_UPDATED: 'profile_updated',
    ROLE_CHANGED: 'role_changed',
    // Business operations
    SUBSCRIPTION_CREATED: 'subscription_created',
    CAPITAL_CALL_CREATED: 'capital_call_created',
    DISTRIBUTION_CREATED: 'distribution_created',
    REPORT_REQUESTED: 'report_requested',
    MESSAGE_SENT: 'message_sent',
    // Commission lifecycle (GAP-7)
    COMMISSION_CREATED: 'commission_created',
    COMMISSION_ACCRUED: 'commission_accrued',
    COMMISSION_INVOICE_REQUESTED: 'commission_invoice_requested',
    COMMISSION_INVOICED: 'commission_invoiced',
    COMMISSION_PAID: 'commission_paid',
    COMMISSION_CANCELLED: 'commission_cancelled',
    // Agreement events (GAP-8)
    AGREEMENT_CREATED: 'agreement_created',
    AGREEMENT_SENT: 'agreement_sent',
    AGREEMENT_APPROVED: 'agreement_approved',
    AGREEMENT_SIGNED: 'agreement_signed',
    AGREEMENT_ACTIVATED: 'agreement_activated',
    AGREEMENT_REJECTED: 'agreement_rejected',
    AGREEMENT_EXPIRED: 'agreement_expired'
};
const AuditEntities = {
    USERS: 'users',
    PROFILES: 'profiles',
    INVESTORS: 'investors',
    VEHICLES: 'vehicles',
    SUBSCRIPTIONS: 'subscriptions',
    POSITIONS: 'positions',
    DOCUMENTS: 'documents',
    WORKFLOWS: 'workflows',
    WORKFLOW_RUNS: 'workflow_runs',
    CONVERSATIONS: 'conversations',
    MESSAGES: 'messages',
    REQUEST_TICKETS: 'request_tickets',
    CAPITAL_CALLS: 'capital_calls',
    DISTRIBUTIONS: 'distributions',
    DEALS: 'deals',
    // RESERVATIONS: 'reservations', // Deprecated - removed from workflow
    ALLOCATIONS: 'allocations',
    FEE_EVENTS: 'fee_events',
    INVOICES: 'invoices',
    BANK_TRANSACTIONS: 'bank_transactions',
    PAYMENTS: 'payments',
    ARRANGER: 'arranger_entities',
    INTRODUCER: 'introducers',
    PARTNER: 'partners',
    COMMERCIAL_PARTNER: 'commercial_partners',
    FEE_PLANS: 'arranger_fee_plans',
    CEO_ENTITY: 'ceo_entity',
    CEO_USERS: 'ceo_users',
    // Commission entities (GAP-7)
    INTRODUCER_COMMISSIONS: 'introducer_commissions',
    PARTNER_COMMISSIONS: 'partner_commissions',
    COMMERCIAL_PARTNER_COMMISSIONS: 'commercial_partner_commissions',
    // Agreement entities (GAP-8)
    INTRODUCER_AGREEMENTS: 'introducer_agreements',
    PARTNER_AGREEMENTS: 'partner_agreements',
    COMMERCIAL_PARTNER_AGREEMENTS: 'commercial_partner_agreements',
    // Introductions
    INTRODUCTIONS: 'introductions'
};
}),
"[project]/versotech-portal/src/lib/document-auth.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "authenticateStaffForDocuments",
    ()=>authenticateStaffForDocuments
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/server.js [app-route] (ecmascript)");
;
;
async function authenticateStaffForDocuments() {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        return {
            serviceSupabase: null,
            userId: '',
            error: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            })
        };
    }
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
    if (!profile || ![
        'staff_admin',
        'staff_ops',
        'staff_rm',
        'ceo'
    ].includes(profile.role)) {
        return {
            serviceSupabase: null,
            userId: '',
            error: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Staff access required'
            }, {
                status: 403
            })
        };
    }
    return {
        serviceSupabase: (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceClient"])(),
        userId: user.id
    };
}
}),
"[project]/versotech-portal/src/app/api/staff/documents/folders/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET,
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$audit$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/audit.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$document$2d$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/document-auth.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/zod/v4/classic/external.js [app-route] (ecmascript) <export * as z>");
;
;
;
;
// Validation schemas
const createFolderSchema = __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].object({
    name: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().min(1, 'Folder name is required').max(255),
    parent_folder_id: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().uuid().optional(),
    vehicle_id: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().uuid().optional(),
    folder_type: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].enum([
        'vehicle_root',
        'category',
        'custom'
    ])
});
async function GET(request) {
    try {
        // Authenticate
        const auth = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$document$2d$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["authenticateStaffForDocuments"])();
        if (auth.error) return auth.error;
        const { serviceSupabase, userId } = auth;
        // Get query parameters
        const searchParams = request.nextUrl.searchParams;
        const vehicleId = searchParams.get('vehicle_id');
        const folderType = searchParams.get('folder_type');
        const includeTree = searchParams.get('tree') === 'true';
        // Build query
        let query = serviceSupabase.from('document_folders').select(`
        *,
        vehicle:vehicles(id, name, type),
        created_by_profile:profiles!document_folders_created_by_fkey(display_name, email)
      `).order('path', {
            ascending: true
        });
        if (vehicleId) {
            query = query.eq('vehicle_id', vehicleId);
        }
        if (folderType) {
            query = query.eq('folder_type', folderType);
        }
        const { data: folders, error: foldersError } = await query;
        if (foldersError) {
            console.error('[API] Folders query error:', foldersError);
            console.error('[API] Error details:', JSON.stringify(foldersError, null, 2));
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to fetch folders',
                details: foldersError.message || 'Unknown database error',
                code: foldersError.code,
                hint: foldersError.hint
            }, {
                status: 500
            });
        }
        // If tree structure is requested, build hierarchy
        if (includeTree) {
            // Get document counts for all folders
            const { data: documentCounts, error: docCountError } = await serviceSupabase.from('documents').select('id, folder_id').not('folder_id', 'is', null);
            if (docCountError) {
                console.error('[API] Document counts query error:', docCountError);
                return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'Failed to fetch document counts',
                    details: docCountError.message
                }, {
                    status: 500
                });
            }
            const tree = buildFolderTree(folders || [], documentCounts || []);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                folders: tree,
                total: folders?.length || 0
            });
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            folders: folders || [],
            total: folders?.length || 0
        });
    } catch (error) {
        console.error('Folders GET error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
async function POST(request) {
    try {
        // Authenticate
        const auth = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$document$2d$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["authenticateStaffForDocuments"])();
        if (auth.error) return auth.error;
        const { serviceSupabase, userId } = auth;
        // Parse and validate request body
        const body = await request.json();
        const validation = createFolderSchema.safeParse(body);
        if (!validation.success) {
            console.error('[API] Validation failed:', validation.error.errors);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Invalid request data',
                details: validation.error.errors
            }, {
                status: 400
            });
        }
        const { name, parent_folder_id, folder_type } = validation.data;
        let vehicle_id = validation.data.vehicle_id;
        // If creating subfolder, inherit vehicle_id from parent
        if (parent_folder_id && !vehicle_id) {
            const { data: parentFolder } = await serviceSupabase.from('document_folders').select('vehicle_id').eq('id', parent_folder_id).single();
            if (parentFolder) {
                vehicle_id = parentFolder.vehicle_id;
            }
        }
        // Build folder path
        let path = `/${name}`;
        if (parent_folder_id) {
            const { data: parentFolder } = await serviceSupabase.from('document_folders').select('path').eq('id', parent_folder_id).single();
            if (parentFolder) {
                path = `${parentFolder.path}/${name}`;
            }
        } else if (vehicle_id && folder_type === 'vehicle_root') {
            // For vehicle root, use vehicle name
            const { data: vehicle } = await serviceSupabase.from('vehicles').select('name').eq('id', vehicle_id).single();
            if (vehicle) {
                path = `/${vehicle.name}`;
            }
        }
        // Check for duplicate path
        const { data: existingFolder } = await serviceSupabase.from('document_folders').select('id').eq('path', path).single();
        if (existingFolder) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'A folder with this path already exists'
            }, {
                status: 409
            });
        }
        // Validate userId is a UUID (for demo accounts compatibility)
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        const createdBy = uuidRegex.test(userId) ? userId : null;
        // Create folder
        const { data: folder, error: createError } = await serviceSupabase.from('document_folders').insert({
            name,
            path,
            parent_folder_id: parent_folder_id || null,
            vehicle_id: vehicle_id || null,
            folder_type,
            created_by: createdBy
        }).select(`
        *,
        vehicle:vehicles(id, name, type),
        created_by_profile:profiles!document_folders_created_by_fkey(display_name, email)
      `).single();
        if (createError) {
            console.error('Folder creation error:', createError);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to create folder'
            }, {
                status: 500
            });
        }
        // Audit log
        await __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$audit$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["auditLogger"].log({
            actor_user_id: userId,
            action: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$audit$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["AuditActions"].CREATE,
            entity: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$audit$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["AuditEntities"].DOCUMENTS,
            entity_id: folder.id,
            metadata: {
                folder_name: name,
                folder_path: path,
                folder_type,
                vehicle_id,
                parent_folder_id
            }
        });
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            folder
        }, {
            status: 201
        });
    } catch (error) {
        console.error('Folders POST error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
// Helper function to build folder tree
function buildFolderTree(folders, documentCounts) {
    const folderMap = new Map();
    const tree = [];
    // Count documents per folder
    const countsByFolder = new Map();
    documentCounts.forEach((doc)=>{
        const folderId = doc.folder_id;
        countsByFolder.set(folderId, (countsByFolder.get(folderId) || 0) + 1);
    });
    // Create map of all folders with document counts
    folders.forEach((folder)=>{
        folderMap.set(folder.id, {
            ...folder,
            children: [],
            document_count: countsByFolder.get(folder.id) || 0
        });
    });
    // Build tree structure
    folders.forEach((folder)=>{
        const node = folderMap.get(folder.id);
        if (folder.parent_folder_id) {
            const parent = folderMap.get(folder.parent_folder_id);
            if (parent) {
                parent.children.push(node);
            } else {
                tree.push(node);
            }
        } else {
            tree.push(node);
        }
    });
    // Recursive function to aggregate document counts from all descendants
    function aggregateCounts(node) {
        let total = node.document_count || 0;
        if (node.children && node.children.length > 0) {
            node.children.forEach((child)=>{
                total += aggregateCounts(child);
            });
        }
        node.document_count = total;
        return total;
    }
    // Apply recursive counting to all root nodes
    tree.forEach((root)=>aggregateCounts(root));
    return tree;
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__f8f143a5._.js.map