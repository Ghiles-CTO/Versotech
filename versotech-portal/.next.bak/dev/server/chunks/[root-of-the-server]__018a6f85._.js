module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient,
    "createServiceClient",
    ()=>createServiceClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
;
const createClient = async ()=>{
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ3V4ZHNzZWNmZXh1ZG52dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4MzcsImV4cCI6MjA3MzkzNzgzN30.AGxM_YW9hfxuu7xDpi_4xhOoRhYM7iGTS1vJ0z2FByE"), {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>{
                        cookieStore.set(name, value, options);
                    });
                } catch (error) {
                // The `setAll` method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            }
        }
    });
};
const createServiceClient = ()=>{
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), process.env.SUPABASE_SERVICE_ROLE_KEY, {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    });
};
}),
"[project]/versotech-portal/src/app/api/staff/fees/dashboard/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET
]);
/**
 * Fees Dashboard API Route
 * Returns KPIs and overview data
 */ var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)");
;
;
async function GET(request) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Unauthorized'
        }, {
            status: 401
        });
        const now = new Date();
        const yearStart = new Date(now.getFullYear(), 0, 1).toISOString();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
        const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1).toISOString();
        const next30Days = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();
        // Fetch fee events for revenue calculations
        const { data: feeEvents } = await supabase.from('fee_events').select('computed_amount, event_date, status').eq('status', 'paid');
        const ytdFees = feeEvents?.filter((e)=>e.event_date >= yearStart).reduce((sum, e)=>sum + e.computed_amount, 0) || 0;
        const mtdFees = feeEvents?.filter((e)=>e.event_date >= monthStart).reduce((sum, e)=>sum + e.computed_amount, 0) || 0;
        const qtdFees = feeEvents?.filter((e)=>e.event_date >= quarterStart).reduce((sum, e)=>sum + e.computed_amount, 0) || 0;
        // Fetch invoice statistics
        const { data: invoices } = await supabase.from('invoices').select('status, total, balance_due, due_date');
        const outstanding = invoices?.filter((i)=>[
                'sent',
                'partially_paid'
            ].includes(i.status)) || [];
        const overdue = invoices?.filter((i)=>[
                'sent',
                'partially_paid',
                'overdue'
            ].includes(i.status) && new Date(i.due_date) < now) || [];
        const outstandingAmount = outstanding.reduce((sum, i)=>sum + (i.balance_due || i.total), 0);
        const overdueAmount = overdue.reduce((sum, i)=>sum + (i.balance_due || i.total), 0);
        // Fetch upcoming fees
        const { data: upcomingSchedules } = await supabase.from('fee_schedules').select('*, fee_component:fee_components(*), investor:investors(display_name)').eq('status', 'active').lte('next_due_date', next30Days).order('next_due_date');
        const upcomingFeesAmount = upcomingSchedules?.reduce((sum, schedule)=>{
            // Simplified calculation - would need actual allocation amounts
            return sum + 1000; // Placeholder
        }, 0) || 0;
        // Fetch all commissions from all 3 tables
        const [introducerRes, partnerRes, commercialPartnerRes] = await Promise.all([
            supabase.from('introducer_commissions').select('accrual_amount, status, paid_at'),
            supabase.from('partner_commissions').select('accrual_amount, status, paid_at'),
            supabase.from('commercial_partner_commissions').select('accrual_amount, status, paid_at')
        ]);
        const introducerCommissions = introducerRes.data || [];
        const partnerCommissions = partnerRes.data || [];
        const commercialPartnerCommissions = commercialPartnerRes.data || [];
        // Helper to calculate commission totals for a single table
        const calculateCommissionTotals = (commissions)=>{
            const accrued = commissions.filter((c)=>c.status === 'accrued').reduce((sum, c)=>sum + Number(c.accrual_amount), 0);
            const invoiced = commissions.filter((c)=>c.status === 'invoiced').reduce((sum, c)=>sum + Number(c.accrual_amount), 0);
            const paid = commissions.filter((c)=>c.status === 'paid').reduce((sum, c)=>sum + Number(c.accrual_amount), 0);
            const paidYtd = commissions.filter((c)=>c.status === 'paid' && c.paid_at && c.paid_at >= yearStart).reduce((sum, c)=>sum + Number(c.accrual_amount), 0);
            return {
                accrued,
                invoiced,
                paid,
                paidYtd,
                owed: accrued + invoiced
            };
        };
        const introducerTotals = calculateCommissionTotals(introducerCommissions);
        const partnerTotals = calculateCommissionTotals(partnerCommissions);
        const commercialPartnerTotals = calculateCommissionTotals(commercialPartnerCommissions);
        // Calculate aggregated totals across all 3 tables
        const commissionSummary = {
            total_owed: introducerTotals.owed + partnerTotals.owed + commercialPartnerTotals.owed,
            total_accrued: introducerTotals.accrued + partnerTotals.accrued + commercialPartnerTotals.accrued,
            total_invoiced: introducerTotals.invoiced + partnerTotals.invoiced + commercialPartnerTotals.invoiced,
            total_paid_ytd: introducerTotals.paidYtd + partnerTotals.paidYtd + commercialPartnerTotals.paidYtd,
            by_entity_type: {
                introducer: {
                    owed: introducerTotals.owed,
                    paid: introducerTotals.paidYtd
                },
                partner: {
                    owed: partnerTotals.owed,
                    paid: partnerTotals.paidYtd
                },
                commercial_partner: {
                    owed: commercialPartnerTotals.owed,
                    paid: commercialPartnerTotals.paidYtd
                }
            }
        };
        // Return KPIs
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            data: {
                total_fees_ytd: ytdFees,
                total_fees_mtd: mtdFees,
                total_fees_qtd: qtdFees,
                outstanding_invoices_count: outstanding.length,
                outstanding_invoices_amount: outstandingAmount,
                overdue_invoices_count: overdue.length,
                overdue_invoices_amount: overdueAmount,
                upcoming_fees_30days: upcomingFeesAmount,
                upcoming_fees_count: upcomingSchedules?.length || 0,
                introducer_commissions_owed: introducerTotals.owed,
                commission_summary: commissionSummary
            }
        });
    } catch (error) {
        console.error('Error in GET /api/staff/fees/dashboard:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__018a6f85._.js.map