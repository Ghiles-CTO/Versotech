{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 26, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/components/entities/entities-page-enhanced.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const EntitiesPageEnhanced = registerClientReference(\n    function() { throw new Error(\"Attempted to call EntitiesPageEnhanced() from the server but EntitiesPageEnhanced is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/components/entities/entities-page-enhanced.tsx <module evaluation>\",\n    \"EntitiesPageEnhanced\",\n);\n"],"names":[],"mappings":";;;;AAAA,uEAAuE;AACvE;;AACO,MAAM,uBAAuB,IAAA,+RAAuB,EACvD;IAAa,MAAM,IAAI,MAAM;AAAwP,GACrR,qGACA","ignoreList":[0]}},
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/components/entities/entities-page-enhanced.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const EntitiesPageEnhanced = registerClientReference(\n    function() { throw new Error(\"Attempted to call EntitiesPageEnhanced() from the server but EntitiesPageEnhanced is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/components/entities/entities-page-enhanced.tsx\",\n    \"EntitiesPageEnhanced\",\n);\n"],"names":[],"mappings":";;;;AAAA,uEAAuE;AACvE;;AACO,MAAM,uBAAuB,IAAA,+RAAuB,EACvD;IAAa,MAAM,IAAI,MAAM;AAAwP,GACrR,iFACA","ignoreList":[0]}},
    {"offset": {"line": 54, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 62, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/%28main%29/versotech_main/entities/page.tsx"],"sourcesContent":["import { createClient, createServiceClient } from '@/lib/supabase/server'\r\nimport { EntitiesPageEnhanced } from '@/components/entities/entities-page-enhanced'\r\nimport { AlertCircle } from 'lucide-react'\r\nimport { checkStaffAccess } from '@/lib/auth'\r\n\r\nexport const dynamic = 'force-dynamic'\r\nexport const revalidate = 0\r\n\r\n/**\r\n * Entities Page for Unified Portal (versotech_main)\r\n *\r\n * Persona-aware entity management:\r\n * - Staff/CEO personas: Full access to all entities (vehicles)\r\n * - Other personas: Access denied\r\n */\r\nexport default async function EntitiesPage() {\r\n  const clientSupabase = await createClient()\r\n  const { data: { user }, error: userError } = await clientSupabase.auth.getUser()\r\n\r\n  if (!user || userError) {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <div className=\"text-center py-16\">\r\n          <AlertCircle className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\r\n          <h3 className=\"text-lg font-medium text-foreground mb-2\">\r\n            Authentication Required\r\n          </h3>\r\n          <p className=\"text-muted-foreground\">\r\n            Please log in to view entities.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Check if user has staff/CEO persona for full access\r\n  const hasStaffAccess = await checkStaffAccess(user.id)\r\n  const serviceSupabase = createServiceClient()\r\n\r\n  if (!hasStaffAccess) {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <div className=\"text-center py-16\">\r\n          <AlertCircle className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\r\n          <h3 className=\"text-lg font-medium text-foreground mb-2\">\r\n            Access Restricted\r\n          </h3>\r\n          <p className=\"text-muted-foreground\">\r\n            Entity management is only available to staff members.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Load entities (vehicles)\r\n  const { data: entities, error } = await serviceSupabase\r\n    .from('vehicles')\r\n    .select('*')\r\n    .order('entity_code', { ascending: true, nullsFirst: false })\r\n\r\n  if (error) {\r\n    console.error('[EntitiesPage] Error loading entities:', error)\r\n  }\r\n\r\n  let enrichedEntities = entities || []\r\n\r\n  if (entities && entities.length > 0) {\r\n    const vehicleIds = entities.map((entity) => entity.id)\r\n\r\n    try {\r\n      const [\r\n        { data: investorLinks, error: investorLinksError },\r\n        { data: subscriptionRows, error: subscriptionError },\r\n        { data: openFlags, error: openFlagsError },\r\n        { data: latestEvents, error: latestEventsError }\r\n      ] = await Promise.all([\r\n        serviceSupabase\r\n          .from('entity_investors')\r\n          .select('vehicle_id, investor_id')\r\n          .in('vehicle_id', vehicleIds),\r\n        serviceSupabase\r\n          .from('subscriptions')\r\n          .select('vehicle_id, investor_id')\r\n          .in('vehicle_id', vehicleIds),\r\n        serviceSupabase\r\n          .from('entity_flags')\r\n          .select('vehicle_id')\r\n          .eq('status', 'open')\r\n          .in('vehicle_id', vehicleIds),\r\n        serviceSupabase\r\n          .from('entity_events')\r\n          .select('vehicle_id, created_at')\r\n          .in('vehicle_id', vehicleIds)\r\n      ])\r\n\r\n      if (investorLinksError) {\r\n        console.error('[EntitiesPage] investor link aggregate error:', investorLinksError)\r\n      }\r\n      if (subscriptionError) {\r\n        console.error('[EntitiesPage] subscription aggregate error:', subscriptionError)\r\n      }\r\n      if (openFlagsError) {\r\n        console.error('[EntitiesPage] flag aggregate error:', openFlagsError)\r\n      }\r\n      if (latestEventsError) {\r\n        console.error('[EntitiesPage] event aggregate error:', latestEventsError)\r\n      }\r\n\r\n      const investorCountMap = new Map<string, Set<string>>()\r\n      ;(investorLinks ?? []).forEach((row) => {\r\n        if (!row?.vehicle_id) return\r\n        const set = investorCountMap.get(row.vehicle_id) ?? new Set<string>()\r\n        if (row.investor_id) {\r\n          set.add(row.investor_id)\r\n        } else {\r\n          set.add(`entity-link-${row.vehicle_id}-${set.size}`)\r\n        }\r\n        investorCountMap.set(row.vehicle_id, set)\r\n      })\r\n      ;(subscriptionRows ?? []).forEach((row) => {\r\n        if (!row?.vehicle_id || !row?.investor_id) return\r\n        const set = investorCountMap.get(row.vehicle_id) ?? new Set<string>()\r\n        set.add(row.investor_id)\r\n        investorCountMap.set(row.vehicle_id, set)\r\n      })\r\n\r\n      const flagCountMap = new Map<string, number>()\r\n      ;(openFlags ?? []).forEach((row) => {\r\n        if (!row?.vehicle_id) return\r\n        flagCountMap.set(\r\n          row.vehicle_id,\r\n          (flagCountMap.get(row.vehicle_id) || 0) + 1\r\n        )\r\n      })\r\n\r\n      const lastEventMap = new Map<string, string>()\r\n      ;(latestEvents ?? []).forEach((row) => {\r\n        if (!row?.vehicle_id || !row?.created_at) return\r\n        const current = lastEventMap.get(row.vehicle_id)\r\n        if (!current || new Date(row.created_at) > new Date(current)) {\r\n          lastEventMap.set(row.vehicle_id, row.created_at)\r\n        }\r\n      })\r\n\r\n      enrichedEntities = entities.map((entity) => ({\r\n        ...entity,\r\n        investor_count: investorCountMap.get(entity.id)?.size || 0,\r\n        open_flag_count: flagCountMap.get(entity.id) || 0,\r\n        last_event_at: lastEventMap.get(entity.id) || null\r\n      }))\r\n    } catch (aggregateError) {\r\n      console.error('[EntitiesPage] Failed to load entity aggregates:', aggregateError)\r\n    }\r\n  }\r\n\r\n  return <EntitiesPageEnhanced entities={enrichedEntities} />\r\n}\r\n"],"names":[],"mappings":"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"}}]
}