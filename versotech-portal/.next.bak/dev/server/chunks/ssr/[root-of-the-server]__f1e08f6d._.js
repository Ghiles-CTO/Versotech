module.exports = [
"[project]/versotech-portal/src/app/favicon.ico.mjs { IMAGE => \"[project]/versotech-portal/src/app/favicon.ico (static in ecmascript, tag client)\" } [app-rsc] (structured image object, ecmascript, Next.js Server Component)", ((__turbopack_context__) => {

__turbopack_context__.n(__turbopack_context__.i("[project]/versotech-portal/src/app/favicon.ico.mjs { IMAGE => \"[project]/versotech-portal/src/app/favicon.ico (static in ecmascript, tag client)\" } [app-rsc] (structured image object, ecmascript)"));
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[project]/versotech-portal/src/app/layout.tsx [app-rsc] (ecmascript, Next.js Server Component)", ((__turbopack_context__) => {

__turbopack_context__.n(__turbopack_context__.i("[project]/versotech-portal/src/app/layout.tsx [app-rsc] (ecmascript)"));
}),
"[project]/versotech-portal/src/app/(main)/versotech_main/layout.tsx [app-rsc] (ecmascript, Next.js Server Component)", ((__turbopack_context__) => {

__turbopack_context__.n(__turbopack_context__.i("[project]/versotech-portal/src/app/(main)/versotech_main/layout.tsx [app-rsc] (ecmascript)"));
}),
"[project]/versotech-portal/src/app/(staff)/versotech/staff/versosign/versosign-page-client.tsx [app-rsc] (client reference proxy) <module evaluation>", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "VersoSignPageClient",
    ()=>VersoSignPageClient
]);
// This file is generated by next-core EcmascriptClientReferenceModule.
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.js [app-rsc] (ecmascript)");
;
const VersoSignPageClient = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call VersoSignPageClient() from the server but VersoSignPageClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/versotech-portal/src/app/(staff)/versotech/staff/versosign/versosign-page-client.tsx <module evaluation>", "VersoSignPageClient");
}),
"[project]/versotech-portal/src/app/(staff)/versotech/staff/versosign/versosign-page-client.tsx [app-rsc] (client reference proxy)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "VersoSignPageClient",
    ()=>VersoSignPageClient
]);
// This file is generated by next-core EcmascriptClientReferenceModule.
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.js [app-rsc] (ecmascript)");
;
const VersoSignPageClient = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call VersoSignPageClient() from the server but VersoSignPageClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/versotech-portal/src/app/(staff)/versotech/staff/versosign/versosign-page-client.tsx", "VersoSignPageClient");
}),
"[project]/versotech-portal/src/app/(staff)/versotech/staff/versosign/versosign-page-client.tsx [app-rsc] (ecmascript)", ((__turbopack_context__) => {
"use strict";

var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$app$2f28$staff$292f$versotech$2f$staff$2f$versosign$2f$versosign$2d$page$2d$client$2e$tsx__$5b$app$2d$rsc$5d$__$28$client__reference__proxy$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/versotech-portal/src/app/(staff)/versotech/staff/versosign/versosign-page-client.tsx [app-rsc] (client reference proxy) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$app$2f28$staff$292f$versotech$2f$staff$2f$versosign$2f$versosign$2d$page$2d$client$2e$tsx__$5b$app$2d$rsc$5d$__$28$client__reference__proxy$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/app/(staff)/versotech/staff/versosign/versosign-page-client.tsx [app-rsc] (client reference proxy)");
;
__turbopack_context__.n(__TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$app$2f28$staff$292f$versotech$2f$staff$2f$versosign$2f$versosign$2d$page$2d$client$2e$tsx__$5b$app$2d$rsc$5d$__$28$client__reference__proxy$29$__);
}),
"[project]/versotech-portal/src/app/(main)/versotech_main/versosign/placement-agreement-signing-section.tsx [app-rsc] (client reference proxy) <module evaluation>", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "PlacementAgreementSigningSection",
    ()=>PlacementAgreementSigningSection
]);
// This file is generated by next-core EcmascriptClientReferenceModule.
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.js [app-rsc] (ecmascript)");
;
const PlacementAgreementSigningSection = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call PlacementAgreementSigningSection() from the server but PlacementAgreementSigningSection is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/placement-agreement-signing-section.tsx <module evaluation>", "PlacementAgreementSigningSection");
}),
"[project]/versotech-portal/src/app/(main)/versotech_main/versosign/placement-agreement-signing-section.tsx [app-rsc] (client reference proxy)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "PlacementAgreementSigningSection",
    ()=>PlacementAgreementSigningSection
]);
// This file is generated by next-core EcmascriptClientReferenceModule.
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.js [app-rsc] (ecmascript)");
;
const PlacementAgreementSigningSection = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call PlacementAgreementSigningSection() from the server but PlacementAgreementSigningSection is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/placement-agreement-signing-section.tsx", "PlacementAgreementSigningSection");
}),
"[project]/versotech-portal/src/app/(main)/versotech_main/versosign/placement-agreement-signing-section.tsx [app-rsc] (ecmascript)", ((__turbopack_context__) => {
"use strict";

var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$app$2f28$main$292f$versotech_main$2f$versosign$2f$placement$2d$agreement$2d$signing$2d$section$2e$tsx__$5b$app$2d$rsc$5d$__$28$client__reference__proxy$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/versotech-portal/src/app/(main)/versotech_main/versosign/placement-agreement-signing-section.tsx [app-rsc] (client reference proxy) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$app$2f28$main$292f$versotech_main$2f$versosign$2f$placement$2d$agreement$2d$signing$2d$section$2e$tsx__$5b$app$2d$rsc$5d$__$28$client__reference__proxy$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/app/(main)/versotech_main/versosign/placement-agreement-signing-section.tsx [app-rsc] (client reference proxy)");
;
__turbopack_context__.n(__TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$app$2f28$main$292f$versotech_main$2f$versosign$2f$placement$2d$agreement$2d$signing$2d$section$2e$tsx__$5b$app$2d$rsc$5d$__$28$client__reference__proxy$29$__);
}),
"[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx [app-rsc] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "default",
    ()=>VersoSignPage,
    "dynamic",
    ()=>dynamic
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime.js [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$app$2f28$staff$292f$versotech$2f$staff$2f$versosign$2f$versosign$2d$page$2d$client$2e$tsx__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/app/(staff)/versotech/staff/versosign/versosign-page-client.tsx [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$lucide$2d$react$2f$dist$2f$esm$2f$icons$2f$circle$2d$alert$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__$3c$export__default__as__AlertCircle$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/lucide-react/dist/esm/icons/circle-alert.js [app-rsc] (ecmascript) <export default as AlertCircle>");
// IntroducerAgreementSigningSection removed - introducer agreements now use standard task flow
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$app$2f28$main$292f$versotech_main$2f$versosign$2f$placement$2d$agreement$2d$signing$2d$section$2e$tsx__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/app/(main)/versotech_main/versosign/placement-agreement-signing-section.tsx [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$auth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/auth.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/headers.js [app-rsc] (ecmascript)");
;
;
;
;
;
;
;
const dynamic = 'force-dynamic';
async function VersoSignPage() {
    const clientSupabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["createClient"])();
    const { data: { user }, error: userError } = await clientSupabase.auth.getUser();
    if (!user || userError) {
        return /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
            className: "p-6",
            children: /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                className: "text-center py-16",
                children: [
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$lucide$2d$react$2f$dist$2f$esm$2f$icons$2f$circle$2d$alert$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__$3c$export__default__as__AlertCircle$3e$__["AlertCircle"], {
                        className: "h-12 w-12 text-gray-400 mx-auto mb-4"
                    }, void 0, false, {
                        fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                        lineNumber: 46,
                        columnNumber: 11
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("h3", {
                        className: "text-lg font-medium text-foreground mb-2",
                        children: "Authentication Required"
                    }, void 0, false, {
                        fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                        lineNumber: 47,
                        columnNumber: 11
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("p", {
                        className: "text-muted-foreground",
                        children: "Please log in to view VersoSign."
                    }, void 0, false, {
                        fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                        lineNumber: 50,
                        columnNumber: 11
                    }, this)
                ]
            }, void 0, true, {
                fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                lineNumber: 45,
                columnNumber: 9
            }, this)
        }, void 0, false, {
            fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
            lineNumber: 44,
            columnNumber: 7
        }, this);
    }
    // Check user personas for access level
    const isStaff = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$auth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["checkStaffAccess"])(user.id);
    const serviceSupabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["createServiceClient"])();
    const { data: personas } = await serviceSupabase.rpc('get_user_personas', {
        p_user_id: user.id
    });
    const isLawyer = personas?.some((p)=>p.persona_type === 'lawyer') || false;
    const isIntroducer = personas?.some((p)=>p.persona_type === 'introducer') || false;
    const isArranger = personas?.some((p)=>p.persona_type === 'arranger') || false;
    const isPartner = personas?.some((p)=>p.persona_type === 'partner') || false;
    // Get ACTIVE persona from cookie - filter tasks by active persona only
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["cookies"])();
    const activePersonaType = cookieStore.get('verso_active_persona_type')?.value;
    // Determine which persona queries should run based on ACTIVE persona
    const shouldShowStaffTasks = isStaff && (activePersonaType === 'ceo' || activePersonaType === 'staff' || !activePersonaType);
    const shouldShowArrangerTasks = isArranger && activePersonaType === 'arranger';
    const shouldShowInvestorTasks = activePersonaType === 'investor';
    const shouldShowLawyerTasks = isLawyer && activePersonaType === 'lawyer';
    const shouldShowIntroducerTasks = isIntroducer && activePersonaType === 'introducer';
    // Get partner IDs if user has partner persona
    let partnerIds = [];
    if (isPartner) {
        const { data: partnerLinks } = await serviceSupabase.from('partner_users').select('partner_id').eq('user_id', user.id);
        partnerIds = partnerLinks?.map((link)=>link.partner_id) || [];
    }
    // Get arranger IDs if user has arranger persona
    let arrangerIds = [];
    if (isArranger) {
        const { data: arrangerLinks } = await serviceSupabase.from('arranger_users').select('arranger_id').eq('user_id', user.id);
        arrangerIds = arrangerLinks?.map((link)=>link.arranger_id) || [];
    }
    // Get introducer IDs if user has introducer persona
    let introducerIds = [];
    if (isIntroducer) {
        const { data: introducerLinks } = await serviceSupabase.from('introducer_users').select('introducer_id').eq('user_id', user.id);
        introducerIds = introducerLinks?.map((link)=>link.introducer_id) || [];
    }
    // Get CEO entity ID if user is a CEO member
    // This allows CEO members to see tasks owned by the CEO entity
    let ceoEntityId = null;
    const { data: ceoMembership } = await serviceSupabase.from('ceo_users').select('user_id').eq('user_id', user.id).maybeSingle();
    if (ceoMembership) {
        const { data: ceoEntity } = await serviceSupabase.from('ceo_entity').select('id').limit(1).single();
        ceoEntityId = ceoEntity?.id || null;
    }
    // Introducer agreements now use standard task flow - no separate section needed
    // Fetch placement agreements pending signature
    let placementAgreementsForSigning = [];
    const fetchedPlacementAgreementIds = new Set();
    if (isStaff) {
        // CEO/Staff: See agreements approved and waiting for CEO signature (non-arranger agreements)
        const { data: placementData } = await serviceSupabase.from('placement_agreements').select(`
        id, status, default_commission_bps, pdf_url, created_at,
        ceo_signature_request_id, cp_signature_request_id,
        arranger_signature_request_id, arranger_id,
        commercial_partner:commercial_partner_id (id, legal_name, display_name, email)
      `).eq('status', 'approved').is('arranger_id', null) // Only non-arranger agreements for CEO
        .order('created_at', {
            ascending: false
        });
        for (const agreement of placementData || []){
            if (!fetchedPlacementAgreementIds.has(agreement.id)) {
                placementAgreementsForSigning.push(agreement);
                fetchedPlacementAgreementIds.add(agreement.id);
            }
        }
    }
    if (isArranger && arrangerIds.length > 0) {
        // Arranger: See their placement agreements pending signature
        const { data: arrangerPlacementData } = await serviceSupabase.from('placement_agreements').select(`
        id, status, default_commission_bps, pdf_url, created_at,
        ceo_signature_request_id, cp_signature_request_id,
        arranger_signature_request_id, arranger_id,
        commercial_partner:commercial_partner_id (id, legal_name, display_name, email)
      `).in('arranger_id', arrangerIds).eq('status', 'approved').order('created_at', {
            ascending: false
        });
        for (const agreement of arrangerPlacementData || []){
            if (!fetchedPlacementAgreementIds.has(agreement.id)) {
                placementAgreementsForSigning.push(agreement);
                fetchedPlacementAgreementIds.add(agreement.id);
            }
        }
    }
    // Get investor IDs if user has investor persona
    let investorIds = [];
    const hasInvestorAccess = personas?.some((p)=>p.persona_type === 'investor') || false;
    if (hasInvestorAccess) {
        const { data: investorLinks } = await serviceSupabase.from('investor_users').select('investor_id').eq('user_id', user.id);
        investorIds = investorLinks?.map((link)=>link.investor_id) || [];
    }
    // Get lawyer IDs if user has lawyer persona
    let lawyerIds = [];
    if (isLawyer) {
        const { data: lawyerLinks } = await serviceSupabase.from('lawyer_users').select('lawyer_id').eq('user_id', user.id);
        lawyerIds = lawyerLinks?.map((link)=>link.lawyer_id) || [];
    }
    // Fetch signature tasks for this user using ADDITIVE model
    // Users with multiple personas see tasks from ALL their personas (no more else-if priority bug)
    let tasks = [];
    const fetchedTaskIds = new Set();
    // Helper to add tasks without duplicates
    const addTasksWithDedup = (newTasks)=>{
        for (const task of newTasks){
            if (!fetchedTaskIds.has(task.id)) {
                tasks.push(task);
                fetchedTaskIds.add(task.id);
            }
        }
    };
    // 1. Staff/CEO: See their OWN signature tasks AND tasks owned by CEO entity (if CEO member)
    // ONLY runs if active persona is ceo/staff
    if (shouldShowStaffTasks) {
        // Build query for staff tasks: user-owned OR CEO-entity-owned (if user is CEO member)
        let staffTasksQuery = serviceSupabase.from('tasks').select('*').in('kind', [
            'countersignature',
            'subscription_pack_signature',
            'other'
        ]).order('due_at', {
            ascending: true,
            nullsFirst: false
        });
        if (ceoEntityId) {
            // CEO member: see both user-owned AND CEO-entity-owned tasks
            staffTasksQuery = staffTasksQuery.or(`owner_user_id.eq.${user.id},owner_ceo_entity_id.eq.${ceoEntityId}`);
        } else {
            // Non-CEO staff: only see their own tasks
            staffTasksQuery = staffTasksQuery.eq('owner_user_id', user.id);
        }
        const { data: staffTasks } = await staffTasksQuery;
        addTasksWithDedup(staffTasks || []);
    }
    // 2. Lawyer: See subscription_pack_signature tasks for assigned deals
    // ONLY runs if active persona is lawyer
    if (shouldShowLawyerTasks && lawyerIds.length > 0) {
        const { data: lawyerAssignments } = await serviceSupabase.from('deal_lawyer_assignments').select('deal_id').in('lawyer_id', lawyerIds);
        const assignedDealIds = lawyerAssignments?.map((a)=>a.deal_id) || [];
        if (assignedDealIds.length > 0) {
            const { data: lawyerTasks } = await serviceSupabase.from('tasks').select('*').eq('kind', 'subscription_pack_signature').in('related_deal_id', assignedDealIds).order('due_at', {
                ascending: true,
                nullsFirst: false
            });
            addTasksWithDedup(lawyerTasks || []);
        }
    }
    // 3. Investor: Tasks owned by user OR by their investor entities
    // ONLY runs if active persona is investor
    if (shouldShowInvestorTasks && investorIds.length > 0) {
        const { data: investorTasks } = await serviceSupabase.from('tasks').select('*').in('kind', [
            'countersignature',
            'subscription_pack_signature',
            'other'
        ]).or(`owner_user_id.eq.${user.id},owner_investor_id.in.(${investorIds.join(',')})`).order('due_at', {
            ascending: true,
            nullsFirst: false
        });
        addTasksWithDedup(investorTasks || []);
    }
    // 4. Introducer: Tasks owned by user (introducer countersignatures)
    // ONLY runs if active persona is introducer
    if (shouldShowIntroducerTasks) {
        const { data: introducerTasks } = await serviceSupabase.from('tasks').select('*').in('kind', [
            'countersignature',
            'subscription_pack_signature',
            'other'
        ]).eq('owner_user_id', user.id).order('due_at', {
            ascending: true,
            nullsFirst: false
        });
        addTasksWithDedup(introducerTasks || []);
    }
    // 5. Arranger: Tasks for their mandates (deals they arrange)
    // ONLY runs if active persona is arranger
    // IMPORTANT: Exclude CEO-owned tasks (owner_ceo_entity_id IS NOT NULL) to prevent
    // arranger seeing CEO countersign tasks when both are on the same deal
    if (shouldShowArrangerTasks && arrangerIds.length > 0) {
        const { data: arrangerDeals } = await serviceSupabase.from('deals').select('id').in('arranger_entity_id', arrangerIds);
        const arrangerDealIds = arrangerDeals?.map((d)=>d.id) || [];
        if (arrangerDealIds.length > 0) {
            const { data: arrangerTasks } = await serviceSupabase.from('tasks').select('*').in('kind', [
                'countersignature',
                'subscription_pack_signature'
            ]).in('related_deal_id', arrangerDealIds).is('owner_ceo_entity_id', null) // Exclude CEO tasks
            .order('due_at', {
                ascending: true,
                nullsFirst: false
            });
            addTasksWithDedup(arrangerTasks || []);
        }
    }
    // 6. Fallback: If no tasks found and no personas matched above, get user's direct tasks
    if (tasks.length === 0 && !isStaff && !isLawyer && investorIds.length === 0 && !isArranger) {
        const { data: userTasks } = await serviceSupabase.from('tasks').select('*').in('kind', [
            'countersignature',
            'subscription_pack_signature',
            'other'
        ]).eq('owner_user_id', user.id).order('due_at', {
            ascending: true,
            nullsFirst: false
        });
        addTasksWithDedup(userTasks || []);
    }
    // Filter out pending/in_progress tasks where the linked signature request has expired
    // This prevents showing "Sign Document" for expired signature requests
    if (tasks.length > 0) {
        const pendingTasksWithSignatureRef = tasks.filter((t)=>(t.status === 'pending' || t.status === 'in_progress') && t.related_entity_type === 'signature_request' && t.related_entity_id);
        if (pendingTasksWithSignatureRef.length > 0) {
            const signatureRequestIds = pendingTasksWithSignatureRef.map((t)=>t.related_entity_id);
            // Check which signature requests are expired
            const { data: expiredSigRequests } = await serviceSupabase.from('signature_requests').select('id').in('id', signatureRequestIds).eq('status', 'expired');
            const expiredIds = new Set((expiredSigRequests || []).map((s)=>s.id));
            // Mark tasks with expired signature requests
            tasks = tasks.map((t)=>{
                if (expiredIds.has(t.related_entity_id) && (t.status === 'pending' || t.status === 'in_progress')) {
                    return {
                        ...t,
                        _expired: true
                    };
                }
                return t;
            });
        }
    }
    // Fetch expired signature requests (staff/CEO only)
    let expiredSignatures = [];
    if (isStaff) {
        const { data: expiredData } = await serviceSupabase.from('signature_requests').select(`
        id, signer_name, signer_email, document_type,
        token_expires_at, created_at, investor_id,
        investor:investors(display_name, legal_name)
      `).eq('status', 'expired').order('token_expires_at', {
            ascending: false
        }).limit(50);
        expiredSignatures = expiredData || [];
    }
    // If user has no signature tasks and no agreements to sign and is not staff/lawyer/introducer/arranger/partner, show appropriate message
    const hasTasks = tasks && tasks.length > 0;
    const hasAgreementsToSign = placementAgreementsForSigning.length > 0;
    const hasRelevantPersona = isStaff || isLawyer || isIntroducer || isArranger || isPartner;
    if (!hasTasks && !hasAgreementsToSign && !hasRelevantPersona) {
        return /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
            className: "p-6",
            children: /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                className: "text-center py-16",
                children: [
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$lucide$2d$react$2f$dist$2f$esm$2f$icons$2f$circle$2d$alert$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__$3c$export__default__as__AlertCircle$3e$__["AlertCircle"], {
                        className: "h-12 w-12 text-gray-400 mx-auto mb-4"
                    }, void 0, false, {
                        fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                        lineNumber: 375,
                        columnNumber: 11
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("h3", {
                        className: "text-lg font-medium text-foreground mb-2",
                        children: "No Signature Tasks"
                    }, void 0, false, {
                        fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                        lineNumber: 376,
                        columnNumber: 11
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("p", {
                        className: "text-muted-foreground",
                        children: "You don't have any pending signature tasks at this time."
                    }, void 0, false, {
                        fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                        lineNumber: 379,
                        columnNumber: 11
                    }, this)
                ]
            }, void 0, true, {
                fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                lineNumber: 374,
                columnNumber: 9
            }, this)
        }, void 0, false, {
            fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
            lineNumber: 373,
            columnNumber: 7
        }, this);
    }
    // Sort by priority (high → medium → low), then by due_at
    const priorityOrder = {
        high: 0,
        medium: 1,
        low: 2
    };
    const sortedTasks = (tasks || []).sort((a, b)=>{
        const pA = priorityOrder[a.priority] ?? 99;
        const pB = priorityOrder[b.priority] ?? 99;
        if (pA !== pB) return pA - pB;
        if (!a.due_at && !b.due_at) return 0;
        if (!a.due_at) return 1;
        if (!b.due_at) return -1;
        return new Date(a.due_at).getTime() - new Date(b.due_at).getTime();
    });
    // Separate expired tasks from actionable tasks
    const actionableTasks = sortedTasks.filter((t)=>!t._expired);
    const expiredTasks = sortedTasks.filter((t)=>t._expired);
    // Group tasks by type
    const signatureGroups = [
        {
            category: 'countersignatures',
            title: 'Pending Countersignatures',
            description: 'Subscription agreements awaiting your countersignature',
            // Only show non-expired tasks in actionable view
            tasks: actionableTasks.filter((t)=>t.kind === 'countersignature' && (t.status === 'pending' || t.status === 'in_progress'))
        },
        {
            category: 'follow_ups',
            title: 'Manual Follow-ups Required',
            description: 'Investors without platform accounts - manual intervention needed',
            tasks: actionableTasks.filter((t)=>t.metadata?.issue === 'investor_no_user_account' && t.status === 'pending')
        },
        {
            category: 'other',
            title: 'Completed Signatures',
            description: 'Recently completed signature tasks',
            tasks: sortedTasks.filter((t)=>(t.kind === 'countersignature' || t.kind === 'subscription_pack_signature') && t.status === 'completed').slice(0, 10) // Show last 10 completed
        },
        {
            category: 'expired',
            title: 'Expired Signatures',
            description: 'Signature requests that have expired - may need to be resent',
            // Include both expired signature requests AND tasks with expired signatures
            tasks: expiredTasks,
            expiredSignatures: expiredSignatures
        }
    ];
    // Get stats for dashboard (only count actionable tasks)
    const stats = {
        pending: actionableTasks.filter((t)=>t.status === 'pending').length,
        in_progress: actionableTasks.filter((t)=>t.status === 'in_progress').length,
        completed_today: sortedTasks.filter((t)=>t.status === 'completed' && t.completed_at && new Date(t.completed_at).toDateString() === new Date().toDateString()).length,
        overdue: actionableTasks.filter((t)=>t.status === 'pending' && t.due_at && new Date(t.due_at) < new Date()).length,
        expired: expiredSignatures.length + expiredTasks.length
    };
    return /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
        className: "p-6 space-y-6",
        children: [
            (isStaff || isArranger) && placementAgreementsForSigning.length > 0 && /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$app$2f28$main$292f$versotech_main$2f$versosign$2f$placement$2d$agreement$2d$signing$2d$section$2e$tsx__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["PlacementAgreementSigningSection"], {
                agreements: placementAgreementsForSigning,
                isStaff: isStaff,
                isArranger: isArranger
            }, void 0, false, {
                fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                lineNumber: 464,
                columnNumber: 9
            }, this),
            isPartner && !hasTasks && !hasAgreementsToSign && /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                className: "bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-950/20 dark:to-teal-950/20 border border-emerald-200 dark:border-emerald-800 rounded-xl p-8 text-center",
                children: [
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("div", {
                        className: "w-16 h-16 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mx-auto mb-4",
                        children: /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("svg", {
                            className: "w-8 h-8 text-emerald-600 dark:text-emerald-400",
                            fill: "none",
                            stroke: "currentColor",
                            viewBox: "0 0 24 24",
                            children: /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("path", {
                                strokeLinecap: "round",
                                strokeLinejoin: "round",
                                strokeWidth: 2,
                                d: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                            }, void 0, false, {
                                fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                                lineNumber: 476,
                                columnNumber: 15
                            }, this)
                        }, void 0, false, {
                            fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                            lineNumber: 475,
                            columnNumber: 13
                        }, this)
                    }, void 0, false, {
                        fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                        lineNumber: 474,
                        columnNumber: 11
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("h3", {
                        className: "text-lg font-semibold text-emerald-900 dark:text-emerald-100 mb-2",
                        children: "All Caught Up!"
                    }, void 0, false, {
                        fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                        lineNumber: 479,
                        columnNumber: 11
                    }, this),
                    /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])("p", {
                        className: "text-emerald-700 dark:text-emerald-300 max-w-md mx-auto",
                        children: "You don't have any pending signature tasks as a Partner. When your referred investors have documents requiring your signature, they'll appear here."
                    }, void 0, false, {
                        fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                        lineNumber: 482,
                        columnNumber: 11
                    }, this)
                ]
            }, void 0, true, {
                fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                lineNumber: 473,
                columnNumber: 9
            }, this),
            /*#__PURE__*/ (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$jsx$2d$dev$2d$runtime$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["jsxDEV"])(__TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$app$2f28$staff$292f$versotech$2f$staff$2f$versosign$2f$versosign$2d$page$2d$client$2e$tsx__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["VersoSignPageClient"], {
                userId: user.id,
                signatureGroups: signatureGroups,
                stats: stats
            }, void 0, false, {
                fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
                lineNumber: 489,
                columnNumber: 7
            }, this)
        ]
    }, void 0, true, {
        fileName: "[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx",
        lineNumber: 461,
        columnNumber: 5
    }, this);
}
}),
"[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx [app-rsc] (ecmascript, Next.js Server Component)", ((__turbopack_context__) => {

__turbopack_context__.n(__turbopack_context__.i("[project]/versotech-portal/src/app/(main)/versotech_main/versosign/page.tsx [app-rsc] (ecmascript)"));
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__f1e08f6d._.js.map