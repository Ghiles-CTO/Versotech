{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/components/messaging/staff/messaging-client.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const MessagingClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call MessagingClient() from the server but MessagingClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/components/messaging/staff/messaging-client.tsx <module evaluation>\",\n    \"MessagingClient\",\n);\n"],"names":[],"mappings":";;;;AAAA,uEAAuE;AACvE;;AACO,MAAM,kBAAkB,IAAA,+RAAuB,EAClD;IAAa,MAAM,IAAI,MAAM;AAA8O,GAC3Q,sGACA","ignoreList":[0]}},
    {"offset": {"line": 36, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/components/messaging/staff/messaging-client.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const MessagingClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call MessagingClient() from the server but MessagingClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/components/messaging/staff/messaging-client.tsx\",\n    \"MessagingClient\",\n);\n"],"names":[],"mappings":";;;;AAAA,uEAAuE;AACvE;;AACO,MAAM,kBAAkB,IAAA,+RAAuB,EAClD;IAAa,MAAM,IAAI,MAAM;AAA8O,GAC3Q,kFACA","ignoreList":[0]}},
    {"offset": {"line": 50, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/client.ts/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const createClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call createClient() from the server but createClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/lib/supabase/client.ts <module evaluation>\",\n    \"createClient\",\n);\nexport const hasActiveSession = registerClientReference(\n    function() { throw new Error(\"Attempted to call hasActiveSession() from the server but hasActiveSession is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/lib/supabase/client.ts <module evaluation>\",\n    \"hasActiveSession\",\n);\nexport const resetClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call resetClient() from the server but resetClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/lib/supabase/client.ts <module evaluation>\",\n    \"resetClient\",\n);\n"],"names":[],"mappings":";;;;;;;;AAAA,uEAAuE;AACvE;;AACO,MAAM,eAAe,IAAA,+RAAuB,EAC/C;IAAa,MAAM,IAAI,MAAM;AAAwO,GACrQ,6EACA;AAEG,MAAM,mBAAmB,IAAA,+RAAuB,EACnD;IAAa,MAAM,IAAI,MAAM;AAAgP,GAC7Q,6EACA;AAEG,MAAM,cAAc,IAAA,+RAAuB,EAC9C;IAAa,MAAM,IAAI,MAAM;AAAsO,GACnQ,6EACA","ignoreList":[0]}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/client.ts/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const createClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call createClient() from the server but createClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/lib/supabase/client.ts\",\n    \"createClient\",\n);\nexport const hasActiveSession = registerClientReference(\n    function() { throw new Error(\"Attempted to call hasActiveSession() from the server but hasActiveSession is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/lib/supabase/client.ts\",\n    \"hasActiveSession\",\n);\nexport const resetClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call resetClient() from the server but resetClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/versotech-portal/src/lib/supabase/client.ts\",\n    \"resetClient\",\n);\n"],"names":[],"mappings":";;;;;;;;AAAA,uEAAuE;AACvE;;AACO,MAAM,eAAe,IAAA,+RAAuB,EAC/C;IAAa,MAAM,IAAI,MAAM;AAAwO,GACrQ,yDACA;AAEG,MAAM,mBAAmB,IAAA,+RAAuB,EACnD;IAAa,MAAM,IAAI,MAAM;AAAgP,GAC7Q,yDACA;AAEG,MAAM,cAAc,IAAA,+RAAuB,EAC9C;IAAa,MAAM,IAAI,MAAM;AAAsO,GACnQ,yDACA","ignoreList":[0]}},
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 114, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/messaging/supabase.ts"],"sourcesContent":["import { createClient } from '@/lib/supabase/client'\nimport type {\n  ConversationFilters,\n  ConversationMessage,\n  ConversationSummary,\n  MessageSender,\n} from '@/types/messaging'\n\ninterface FetchConversationsOptions extends ConversationFilters {\n  limit?: number\n  offset?: number\n  includeMessages?: boolean\n}\n\ninterface FetchConversationsResponse {\n  conversations: ConversationSummary[]\n  total: number\n  limit: number\n  offset: number\n  hasMore: boolean\n}\n\ninterface FetchMessagesOptions {\n  limit?: number\n  offset?: number\n}\n\nexport async function fetchConversationsClient(\n  filters: FetchConversationsOptions\n): Promise<FetchConversationsResponse> {\n  const params = new URLSearchParams()\n\n  if (filters.visibility) params.set('visibility', filters.visibility)\n  if (filters.type) params.set('type', filters.type)\n  if (filters.unreadOnly) params.set('unread', 'true')\n  if (filters.search) params.set('search', filters.search)\n  if (filters.dealId) params.set('dealId', filters.dealId)\n  if (typeof filters.limit === 'number') params.set('limit', String(filters.limit))\n  if (typeof filters.offset === 'number') params.set('offset', String(filters.offset))\n  if (filters.includeMessages === false) params.set('includeMessages', 'false')\n\n  const response = await fetch(`/api/conversations?${params.toString()}`, {\n    cache: 'no-store',\n  })\n\n  if (!response.ok) {\n    const error = await response.json().catch(() => null)\n    throw new Error(error?.error || 'Failed to load conversations')\n  }\n\n  const data = await response.json()\n\n  return {\n    conversations: data.conversations as ConversationSummary[],\n    total: data.pagination.total,\n    limit: data.pagination.limit,\n    offset: data.pagination.offset,\n    hasMore: data.pagination.has_more,\n  }\n}\n\nexport function normalizeConversation(raw: any): ConversationSummary {\n  const participants = Array.isArray(raw?.conversation_participants)\n    ? raw.conversation_participants.map((participant: any) => {\n        const profile = participant?.profiles || {}\n        return {\n          id: profile.id || participant.user_id,\n          displayName: profile.display_name || profile.email || null,\n          email: profile.email || null,\n          role: profile.role || null,\n          avatarUrl: profile.avatar_url ?? null,\n          participantRole: participant?.participant_role ?? 'member',\n          joinedAt: participant?.joined_at,\n          lastReadAt: participant?.last_read_at ?? null,\n          lastNotifiedAt: participant?.last_notified_at ?? null,\n          isMuted: participant?.is_muted ?? false,\n          isPinned: participant?.is_pinned ?? false,\n        }\n      })\n    : []\n\n  const latestMessageRaw = Array.isArray(raw?.messages) ? raw.messages[0] : null\n  const latestMessage = latestMessageRaw ? normalizeMessage(latestMessageRaw) : null\n\n  return {\n    id: raw.id,\n    subject: raw.subject ?? null,\n    preview: raw.preview ?? null,\n    type: raw.type ?? 'dm',\n    visibility: raw.visibility ?? 'internal',\n    ownerTeam: raw.owner_team ?? null,\n    dealId: raw.deal_id ?? null,\n    createdBy: raw.created_by ?? null,\n    createdAt: raw.created_at,\n    updatedAt: raw.updated_at,\n    lastMessageAt: raw.last_message_at ?? null,\n    lastMessageId: raw.last_message_id ?? null,\n    archivedAt: raw.archived_at ?? null,\n    metadata: raw.metadata ?? {},\n    participants,\n    unreadCount: raw.unreadCount ?? 0,\n    latestMessage,\n    participantCount: participants.length,\n  }\n}\n\nexport async function fetchConversationMessages(\n  conversationId: string,\n  options: FetchMessagesOptions = {}\n): Promise<ConversationMessage[]> {\n  const params = new URLSearchParams()\n  if (typeof options.limit === 'number') params.set('limit', String(options.limit))\n  if (typeof options.offset === 'number') params.set('offset', String(options.offset))\n\n  const response = await fetch(`/api/conversations/${conversationId}/messages?${params.toString()}`)\n\n  if (!response.ok) {\n    const error = await response.json().catch(() => null)\n    throw new Error(error?.error || 'Failed to fetch messages')\n  }\n\n  const data = await response.json()\n  return data.messages as ConversationMessage[]\n}\n\nexport async function markConversationRead(conversationId: string) {\n  await fetch(`/api/conversations/${conversationId}/read`, { method: 'POST' })\n}\n\nexport function getClientSupabase() {\n  return createClient()\n}\n\nexport function subscribeToConversationUpdates(\n  conversationId: string,\n  callbacks: {\n    onMessage?: (message: ConversationMessage) => void\n    onUpdate?: () => void\n  }\n) {\n  const supabase = createClient()\n\n  \n\n  const channel = supabase\n    .channel(`conversation-${conversationId}`)\n    .on(\n      'postgres_changes',\n      {\n        event: 'INSERT',\n        schema: 'public',\n        table: 'messages',\n        filter: `conversation_id=eq.${conversationId}`,\n      },\n      (payload) => {\n        if (payload.eventType === 'INSERT') {\n          callbacks.onMessage?.(normalizeMessage(payload.new))\n        }\n        callbacks.onUpdate?.()\n      }\n    )\n    .on(\n      'postgres_changes',\n      {\n        event: '*',\n        schema: 'public',\n        table: 'conversation_participants',\n        filter: `conversation_id=eq.${conversationId}`,\n      },\n      (payload) => {\n        callbacks.onUpdate?.()\n      }\n    )\n    .subscribe()\n\n  return () => {\n    supabase.removeChannel(channel)\n  }\n}\n\nexport function normalizeMessage(raw: any): ConversationMessage {\n  // Handle both API responses (with joined sender) and realtime events (without joins)\n  const sender = raw.sender as MessageSender | undefined\n\n  return {\n    id: raw.id,\n    conversationId: raw.conversation_id,\n    senderId: raw.sender_id,\n    body: raw.body ?? null,\n    messageType: raw.message_type ?? 'text',\n    fileKey: raw.file_key ?? null,\n    replyToMessageId: raw.reply_to_message_id ?? null,\n    metadata: raw.metadata ?? {},\n    createdAt: raw.created_at,\n    editedAt: raw.edited_at ?? null,\n    deletedAt: raw.deleted_at ?? null,\n    // Sender might not be available in realtime payloads, that's ok\n    sender: sender ? {\n      id: sender.id ?? null,\n      displayName: sender.displayName ?? (sender as any).display_name ?? null,\n      email: sender.email ?? null,\n      role: sender.role ?? null,\n      avatarUrl: sender.avatarUrl ?? (sender as any).avatar_url ?? null,\n    } : null,\n    readBy: Array.isArray(raw.read_by) ? raw.read_by : [],\n  }\n}\n\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 272, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/%28main%29/versotech_main/messages/page.tsx"],"sourcesContent":["import { MessagingClient } from '@/components/messaging/staff/messaging-client'\r\nimport { createClient, createServiceClient } from '@/lib/supabase/server'\r\nimport { normalizeConversation } from '@/lib/messaging/supabase'\r\nimport { AlertCircle } from 'lucide-react'\r\nimport { checkStaffAccess } from '@/lib/auth'\r\n\r\nexport const dynamic = 'force-dynamic'\r\n\r\n/**\r\n * Messages Page for Unified Portal (versotech_main)\r\n *\r\n * Persona-aware messaging:\r\n * - Staff/CEO personas: Access to all conversations\r\n * - Other personas: Only conversations they're participating in\r\n */\r\nexport default async function MessagesPage() {\r\n  const clientSupabase = await createClient()\r\n  const { data: { user }, error: userError } = await clientSupabase.auth.getUser()\r\n\r\n  if (!user || userError) {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <div className=\"text-center py-16\">\r\n          <AlertCircle className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\r\n          <h3 className=\"text-lg font-medium text-foreground mb-2\">\r\n            Authentication Required\r\n          </h3>\r\n          <p className=\"text-muted-foreground\">\r\n            Please log in to view messages.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Check user personas for access control\r\n  const isStaff = await checkStaffAccess(user.id)\r\n  const serviceSupabase = createServiceClient()\r\n\r\n  const { data: personas } = await serviceSupabase.rpc('get_user_personas', {\r\n    p_user_id: user.id\r\n  })\r\n  const isArranger = personas?.some((p: any) => p.persona_type === 'arranger') || false\r\n  const isIntroducer = personas?.some((p: any) => p.persona_type === 'introducer') || false\r\n\r\n  // Block arrangers who don't have staff access\r\n  // Per user stories: Arrangers need notifications, not messaging\r\n  if (isArranger && !isStaff) {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <div className=\"text-center py-16\">\r\n          <AlertCircle className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\r\n          <h3 className=\"text-lg font-medium text-foreground mb-2\">\r\n            Messages Not Available\r\n          </h3>\r\n          <p className=\"text-muted-foreground\">\r\n            As an arranger, you&apos;ll receive important updates via the notification system.\r\n            Check the notification bell for alerts about agreements, payments, and signatures.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Block introducers who don't have staff access\r\n  // Per PRD: Introducers have zero messaging user stories - passive notification recipients only\r\n  if (isIntroducer && !isStaff) {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <div className=\"text-center py-16\">\r\n          <AlertCircle className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\r\n          <h3 className=\"text-lg font-medium text-foreground mb-2\">\r\n            Messages Not Available\r\n          </h3>\r\n          <p className=\"text-muted-foreground\">\r\n            As an introducer, you&apos;ll receive important updates via the notification system.\r\n            Check the notification bell for alerts about introduction progress and commission updates.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Only staff get elevated messaging access (all conversations)\r\n  const hasStaffAccess = isStaff\r\n\r\n  let conversationData: any[] = []\r\n\r\n  if (hasStaffAccess) {\r\n    // Staff: Access to all conversations\r\n    const { data, error } = await serviceSupabase\r\n      .from('conversations')\r\n      .select(`\r\n        *,\r\n        conversation_participants (\r\n          conversation_id,\r\n          user_id,\r\n          participant_role,\r\n          joined_at,\r\n          last_read_at,\r\n          last_notified_at,\r\n          is_muted,\r\n          is_pinned,\r\n          profiles:user_id (\r\n            id,\r\n            display_name,\r\n            email,\r\n            role,\r\n            avatar_url\r\n          )\r\n        ),\r\n        messages (\r\n          id,\r\n          conversation_id,\r\n          sender_id,\r\n          body,\r\n          message_type,\r\n          file_key,\r\n          reply_to_message_id,\r\n          metadata,\r\n          created_at,\r\n          edited_at,\r\n          deleted_at,\r\n          sender:sender_id (\r\n            id,\r\n            display_name,\r\n            email,\r\n            role,\r\n            avatar_url\r\n          )\r\n        )\r\n      `)\r\n      .order('last_message_at', { ascending: false, nullsFirst: false })\r\n      .order('created_at', { foreignTable: 'messages', ascending: false })\r\n      .limit(1, { foreignTable: 'messages' })\r\n      .limit(50)\r\n\r\n    if (error) {\r\n      console.error('[Messages Page] Error loading conversations:', error)\r\n    }\r\n    conversationData = data || []\r\n  } else {\r\n    // Non-staff: Only conversations they're participating in\r\n    const { data, error } = await serviceSupabase\r\n      .from('conversations')\r\n      .select(`\r\n        *,\r\n        conversation_participants!inner (\r\n          conversation_id,\r\n          user_id,\r\n          participant_role,\r\n          joined_at,\r\n          last_read_at,\r\n          last_notified_at,\r\n          is_muted,\r\n          is_pinned,\r\n          profiles:user_id (\r\n            id,\r\n            display_name,\r\n            email,\r\n            role,\r\n            avatar_url\r\n          )\r\n        ),\r\n        messages (\r\n          id,\r\n          conversation_id,\r\n          sender_id,\r\n          body,\r\n          message_type,\r\n          file_key,\r\n          reply_to_message_id,\r\n          metadata,\r\n          created_at,\r\n          edited_at,\r\n          deleted_at,\r\n          sender:sender_id (\r\n            id,\r\n            display_name,\r\n            email,\r\n            role,\r\n            avatar_url\r\n          )\r\n        )\r\n      `)\r\n      .eq('conversation_participants.user_id', user.id)\r\n      .order('last_message_at', { ascending: false, nullsFirst: false })\r\n      .order('created_at', { foreignTable: 'messages', ascending: false })\r\n      .limit(1, { foreignTable: 'messages' })\r\n      .limit(50)\r\n\r\n    if (error) {\r\n      console.error('[Messages Page] Error loading conversations:', error)\r\n    }\r\n    conversationData = data || []\r\n  }\r\n\r\n  // Normalize conversations\r\n  const normalizedConversations = conversationData.map(normalizeConversation)\r\n\r\n  // Compute unread counts\r\n  const conversationIds = normalizedConversations.map(conv => conv.id)\r\n\r\n  if (conversationIds.length > 0) {\r\n    const { data: unreadData } = await serviceSupabase.rpc('get_conversation_unread_counts', {\r\n      p_user_id: user.id,\r\n      p_conversation_ids: conversationIds,\r\n    })\r\n\r\n    const unreadMap = new Map<string, number>()\r\n    for (const row of unreadData || []) {\r\n      if (row?.conversation_id) {\r\n        unreadMap.set(row.conversation_id, Number(row.unread_count) || 0)\r\n      }\r\n    }\r\n\r\n    for (const conversation of normalizedConversations) {\r\n      conversation.unreadCount = unreadMap.get(conversation.id) ?? 0\r\n    }\r\n  }\r\n\r\n  return (\r\n    <MessagingClient initialConversations={normalizedConversations} currentUserId={user.id} />\r\n  )\r\n}\r\n"],"names":[],"mappings":"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"}}]
}