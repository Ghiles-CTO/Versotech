module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient,
    "createServiceClient",
    ()=>createServiceClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
;
const createClient = async ()=>{
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ3V4ZHNzZWNmZXh1ZG52dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4MzcsImV4cCI6MjA3MzkzNzgzN30.AGxM_YW9hfxuu7xDpi_4xhOoRhYM7iGTS1vJ0z2FByE"), {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>{
                        cookieStore.set(name, value, options);
                    });
                } catch (error) {
                // The `setAll` method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            }
        }
    });
};
const createServiceClient = ()=>{
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), process.env.SUPABASE_SERVICE_ROLE_KEY, {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    });
};
}),
"[project]/versotech-portal/src/lib/audit.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "AuditActions",
    ()=>AuditActions,
    "AuditEntities",
    ()=>AuditEntities,
    "auditLogger",
    ()=>auditLogger
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)");
;
class AuditLogger {
    static instance;
    static getInstance() {
        if (!AuditLogger.instance) {
            AuditLogger.instance = new AuditLogger();
        }
        return AuditLogger.instance;
    }
    async log(entry) {
        try {
            const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
            // Insert into audit_logs with correct column names
            await supabase.from('audit_logs').insert({
                event_type: 'system',
                actor_id: entry.actor_user_id || null,
                action: entry.action,
                entity_type: entry.entity,
                entity_id: entry.entity_id || null,
                action_details: entry.metadata || null,
                timestamp: new Date().toISOString()
            });
        } catch (error) {
            console.error('Audit logging failed:', error);
        // Don't throw to avoid breaking the main operation
        }
    }
    async logMany(entries) {
        for (const entry of entries){
            await this.log(entry);
        }
    }
}
const auditLogger = AuditLogger.getInstance();
const AuditActions = {
    // Authentication
    LOGIN: 'login',
    LOGOUT: 'logout',
    PASSWORD_CHANGE: 'password_change',
    // Data operations
    CREATE: 'create',
    READ: 'read',
    UPDATE: 'update',
    DELETE: 'delete',
    // Documents
    DOCUMENT_UPLOAD: 'document_upload',
    DOCUMENT_DOWNLOAD: 'document_download',
    DOCUMENT_DELETE: 'document_delete',
    // Workflows
    WORKFLOW_TRIGGER: 'workflow_trigger',
    WORKFLOW_COMPLETED: 'workflow_completed',
    WORKFLOW_FAILED: 'workflow_failed',
    // System operations
    USER_CREATED: 'user_created',
    PROFILE_UPDATED: 'profile_updated',
    ROLE_CHANGED: 'role_changed',
    // Business operations
    SUBSCRIPTION_CREATED: 'subscription_created',
    CAPITAL_CALL_CREATED: 'capital_call_created',
    DISTRIBUTION_CREATED: 'distribution_created',
    REPORT_REQUESTED: 'report_requested',
    MESSAGE_SENT: 'message_sent',
    // Commission lifecycle (GAP-7)
    COMMISSION_CREATED: 'commission_created',
    COMMISSION_ACCRUED: 'commission_accrued',
    COMMISSION_INVOICE_REQUESTED: 'commission_invoice_requested',
    COMMISSION_INVOICED: 'commission_invoiced',
    COMMISSION_PAID: 'commission_paid',
    COMMISSION_CANCELLED: 'commission_cancelled',
    // Agreement events (GAP-8)
    AGREEMENT_CREATED: 'agreement_created',
    AGREEMENT_SENT: 'agreement_sent',
    AGREEMENT_APPROVED: 'agreement_approved',
    AGREEMENT_SIGNED: 'agreement_signed',
    AGREEMENT_ACTIVATED: 'agreement_activated',
    AGREEMENT_REJECTED: 'agreement_rejected',
    AGREEMENT_EXPIRED: 'agreement_expired'
};
const AuditEntities = {
    USERS: 'users',
    PROFILES: 'profiles',
    INVESTORS: 'investors',
    VEHICLES: 'vehicles',
    SUBSCRIPTIONS: 'subscriptions',
    POSITIONS: 'positions',
    DOCUMENTS: 'documents',
    WORKFLOWS: 'workflows',
    WORKFLOW_RUNS: 'workflow_runs',
    CONVERSATIONS: 'conversations',
    MESSAGES: 'messages',
    REQUEST_TICKETS: 'request_tickets',
    CAPITAL_CALLS: 'capital_calls',
    DISTRIBUTIONS: 'distributions',
    DEALS: 'deals',
    // RESERVATIONS: 'reservations', // Deprecated - removed from workflow
    ALLOCATIONS: 'allocations',
    FEE_EVENTS: 'fee_events',
    INVOICES: 'invoices',
    BANK_TRANSACTIONS: 'bank_transactions',
    PAYMENTS: 'payments',
    ARRANGER: 'arranger_entities',
    INTRODUCER: 'introducers',
    PARTNER: 'partners',
    COMMERCIAL_PARTNER: 'commercial_partners',
    FEE_PLANS: 'arranger_fee_plans',
    CEO_ENTITY: 'ceo_entity',
    CEO_USERS: 'ceo_users',
    // Commission entities (GAP-7)
    INTRODUCER_COMMISSIONS: 'introducer_commissions',
    PARTNER_COMMISSIONS: 'partner_commissions',
    COMMERCIAL_PARTNER_COMMISSIONS: 'commercial_partner_commissions',
    // Agreement entities (GAP-8)
    INTRODUCER_AGREEMENTS: 'introducer_agreements',
    PARTNER_AGREEMENTS: 'partner_agreements',
    COMMERCIAL_PARTNER_AGREEMENTS: 'commercial_partner_agreements',
    // Introductions
    INTRODUCTIONS: 'introductions'
};
}),
"[project]/versotech-portal/src/lib/api-auth.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Helper to get authenticated user from Supabase auth
 * Works with both createClient() and createServiceClient()
 */ __turbopack_context__.s([
    "getAuthenticatedUser",
    ()=>getAuthenticatedUser,
    "getUserRole",
    ()=>getUserRole,
    "hasPermission",
    ()=>hasPermission,
    "isStaffUser",
    ()=>isStaffUser,
    "isSuperAdmin",
    ()=>isSuperAdmin
]);
async function getAuthenticatedUser(supabase) {
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    return {
        user,
        error: authError
    };
}
async function getUserRole(supabase, user) {
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
    return profile?.role || null;
}
async function hasPermission(supabase, userId, requiredPermissions) {
    // First, check if user is CEO - CEO bypasses all permission checks
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', userId).single();
    if (profile?.role === 'ceo') {
        return true // CEO has all permissions
        ;
    }
    // Also check if user has CEO persona (for multi_persona users)
    const { data: ceoUser } = await supabase.from('ceo_users').select('user_id').eq('user_id', userId).maybeSingle();
    if (ceoUser) {
        return true // User is in ceo_users table, has all permissions
        ;
    }
    // For non-CEO users, check staff_permissions table
    const { data: permission } = await supabase.from('staff_permissions').select('permission').eq('user_id', userId).in('permission', requiredPermissions).limit(1).maybeSingle();
    return !!permission;
}
async function isSuperAdmin(supabase, userId) {
    return hasPermission(supabase, userId, [
        'super_admin'
    ]);
}
async function isStaffUser(supabase, user) {
    // First check legacy role field
    const role = await getUserRole(supabase, user);
    if (role && (role.startsWith('staff_') || role === 'ceo')) {
        return true;
    }
    // For multi_persona users, check personas via RPC
    if (role === 'multi_persona') {
        try {
            const { data: personas } = await supabase.rpc('get_user_personas', {
                p_user_id: user.id
            });
            if (personas && Array.isArray(personas)) {
                return personas.some((p)=>p.persona_type === 'staff' || p.persona_type === 'ceo');
            }
        } catch (err) {
            console.error('[isStaffUser] Error checking personas:', err);
        }
    }
    return false;
}
}),
"[project]/versotech-portal/src/app/api/deals/[id]/inventory/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET,
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$audit$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/audit.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/zod/v4/classic/external.js [app-route] (ecmascript) <export * as z>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$api$2d$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/api-auth.ts [app-route] (ecmascript)");
;
;
;
;
;
// Schema for adding share lot
const createShareLotSchema = __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].object({
    source_id: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().uuid().optional(),
    source_type: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].enum([
        'company',
        'fund',
        'colleague',
        'other'
    ]),
    counterparty_name: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().optional(),
    units_total: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].number().positive(),
    unit_cost: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].number().positive(),
    currency: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().default('USD'),
    acquired_at: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().optional(),
    lockup_until: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().optional(),
    notes: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].string().optional()
});
async function GET(request, { params }) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        const { user, error: authError } = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$api$2d$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getAuthenticatedUser"])(supabase);
        if (authError || !user) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const { id: dealId } = await params;
        // Fetch share lots with source info
        const { data: shareLots, error } = await supabase.from('share_lots').select(`
        *,
        share_sources (
          id,
          kind,
          counterparty_name,
          notes
        )
      `).eq('deal_id', dealId).order('acquired_at', {
            ascending: true,
            nullsFirst: false
        });
        if (error) {
            console.error('Fetch share lots error:', error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to fetch inventory'
            }, {
                status: 500
            });
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            inventory: shareLots || []
        });
    } catch (error) {
        console.error('API /deals/[id]/inventory GET error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
async function POST(request, { params }) {
    try {
        const supabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceClient"])();
        const regularSupabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        const { user, error: authError } = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$api$2d$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getAuthenticatedUser"])(regularSupabase);
        if (authError || !user) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        // Check if user is staff (works with both real auth and demo mode)
        const isStaff = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$api$2d$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isStaffUser"])(supabase, user);
        if (!isStaff) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Staff access required'
            }, {
                status: 403
            });
        }
        const { id: dealId } = await params;
        const body = await request.json();
        const validatedData = createShareLotSchema.parse(body);
        // Create or get share source if needed
        let sourceId = validatedData.source_id;
        if (!sourceId) {
            // Create new share source
            const { data: newSource, error: sourceError } = await supabase.from('share_sources').insert({
                kind: validatedData.source_type,
                counterparty_name: validatedData.counterparty_name,
                notes: validatedData.notes
            }).select().single();
            if (sourceError) {
                console.error('Create source error:', sourceError);
                return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'Failed to create share source'
                }, {
                    status: 500
                });
            }
            sourceId = newSource.id;
        }
        // Create share lot
        const { data: shareLot, error } = await supabase.from('share_lots').insert({
            deal_id: dealId,
            source_id: sourceId,
            units_total: validatedData.units_total,
            unit_cost: validatedData.unit_cost,
            currency: validatedData.currency,
            acquired_at: validatedData.acquired_at,
            lockup_until: validatedData.lockup_until,
            units_remaining: validatedData.units_total,
            status: 'available'
        }).select(`
        *,
        share_sources (
          id,
          kind,
          counterparty_name,
          notes
        )
      `).single();
        if (error) {
            console.error('Create share lot error:', error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to create share lot'
            }, {
                status: 500
            });
        }
        // Audit log
        await __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$audit$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["auditLogger"].log({
            actor_user_id: user.id,
            action: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$audit$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["AuditActions"].CREATE,
            entity: 'share_lots',
            entity_id: shareLot.id,
            metadata: {
                deal_id: dealId,
                units_total: validatedData.units_total,
                unit_cost: validatedData.unit_cost
            }
        });
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            shareLot
        }, {
            status: 201
        });
    } catch (error) {
        if (error instanceof __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$zod$2f$v4$2f$classic$2f$external$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$export__$2a$__as__z$3e$__["z"].ZodError) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Invalid request data',
                details: error.errors
            }, {
                status: 400
            });
        }
        console.error('API /deals/[id]/inventory POST error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__c575c3cd._.js.map