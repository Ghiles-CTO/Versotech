{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,MAAM,eAAe;IAC1B,MAAM,cAAc,MAAM,IAAA,mKAAO;IAEjC,OAAO,IAAA,wNAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;wBAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAC/B;gBACF,EAAE,OAAO,OAAO;gBACd,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ;AAIO,MAAM,sBAAsB;IACjC,OAAO,IAAA,gOAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB,EACrC;QACE,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AAEJ"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/smart-client.ts"],"sourcesContent":["import { createClient } from './server'\n\n/**\n * Create an authenticated Supabase client\n * Returns the standard authenticated client that respects RLS policies\n */\nexport async function createSmartClient() {\n  return await createClient()\n}\n"],"names":[],"mappings":";;;;AAAA;;AAMO,eAAe;IACpB,OAAO,MAAM,IAAA,yKAAY;AAC3B"}},
    {"offset": {"line": 141, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/api/staff/requests/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport { cookies } from 'next/headers'\nimport { createSmartClient } from '@/lib/supabase/smart-client'\n\ntype RequestFilters = {\n  status?: string | null\n  category?: string | null\n  priority?: string | null\n  assigned_to?: string | null\n  overdue_only?: string | null\n  q?: string | null\n}\n\nasync function getAuthenticatedStaff(supabase: any) {\n  const {\n    data: { user },\n    error,\n  } = await supabase.auth.getUser()\n\n  if (!user || error) {\n    return { user: null, error: error || new Error('Not authenticated'), role: null }\n  }\n\n  const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single()\n  if (!(profile?.role?.startsWith('staff_') || profile?.role === 'ceo')) {\n    return { user: null, error: new Error('Staff access required'), role: null }\n  }\n  return { user, error: null, role: profile.role } as const\n}\n\nexport async function GET(request: Request) {\n  try {\n    const supabase = await createSmartClient()\n    const { user, error, role } = await getAuthenticatedStaff(supabase)\n\n    if (error || !user || !role) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const { searchParams } = new URL(request.url)\n    const filters: RequestFilters = {\n      status: searchParams.get('status'),\n      category: searchParams.get('category'),\n      priority: searchParams.get('priority'),\n      assigned_to: searchParams.get('assigned_to'),\n      overdue_only: searchParams.get('overdue_only'),\n      q: searchParams.get('q'),\n    }\n\n    let query = supabase\n      .from('request_tickets')\n      .select(\n        `\n        *,\n        investor:investors!request_tickets_investor_id_fkey (id, legal_name),\n        created_by_profile:profiles!request_tickets_created_by_fkey (id, display_name, email),\n        assigned_to_profile:profiles!request_tickets_assigned_to_fkey (id, display_name, email)\n      `,\n      )\n      .order('created_at', { ascending: false })\n\n    if (filters.status && filters.status !== 'all') {\n      query = query.eq('status', filters.status)\n    }\n    if (filters.category && filters.category !== 'all') {\n      query = query.eq('category', filters.category)\n    }\n    if (filters.priority && filters.priority !== 'all') {\n      query = query.eq('priority', filters.priority)\n    }\n    \n    // Handle 'assigned_to = me' filter - skip for demo users with non-UUID IDs\n    if (filters.assigned_to === 'me') {\n      // Check if user.id is a valid UUID\n      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i\n      if (uuidRegex.test(user.id)) {\n        query = query.eq('assigned_to', user.id)\n      } else {\n        // For demo users, return empty results for 'my tasks'\n        query = query.eq('id', '00000000-0000-0000-0000-000000000000')\n      }\n    } else if (filters.assigned_to && filters.assigned_to !== 'all') {\n      query = query.eq('assigned_to', filters.assigned_to)\n    }\n    // Overdue filtering requires due_date which doesn't exist in current schema; ignore for now\n    if (filters.q) {\n      const search = filters.q\n      query = query.or(\n        `subject.ilike.%${search}%,details.ilike.%${search}%,investor.legal_name.ilike.%${search}%,assigned_to_profile.display_name.ilike.%${search}%`,\n      )\n    }\n\n    const { data: requests, error: fetchError } = await query\n\n    if (fetchError) {\n      console.error('[StaffRequests] Error fetching requests:', fetchError)\n      return NextResponse.json(\n        {\n          error: 'Failed to fetch requests',\n          details: fetchError.message,\n          hint: fetchError.hint,\n          code: fetchError.code,\n          status: 500,\n        },\n        { status: 500 },\n      )\n    }\n\n    const statsQuery = supabase\n      .from('request_tickets')\n      .select('status', { count: 'exact', head: false })\n\n    const { data: allTickets, error: statsError } = await statsQuery\n\n    if (statsError) {\n      console.warn('[StaffRequests] Stats query failed, continuing with stats=null', statsError)\n    }\n\n    const stats = allTickets\n      ? {\n          total_requests: allTickets.length,\n          open_count: allTickets.filter((ticket: any) => ticket.status === 'open').length,\n          in_progress_count: allTickets.filter((ticket: any) => ['assigned', 'in_progress'].includes(ticket.status)).length,\n          ready_count: allTickets.filter((ticket: any) => ticket.status === 'ready').length,\n          overdue_count: 0,\n          avg_fulfillment_time_hours: null,\n          sla_compliance_rate: null,\n        }\n      : null\n\n    return NextResponse.json({\n      requests: requests || [],\n      stats,\n      hasData: Boolean(requests && requests.length > 0),\n    })\n  } catch (err) {\n    console.error('[StaffRequests] Unexpected error:', err)\n    return NextResponse.json(\n      {\n        error: 'Internal server error',\n        details: err instanceof Error ? err.message : String(err),\n        status: 500,\n      },\n      { status: 500 },\n    )\n  }\n}\n\n\n"],"names":[],"mappings":";;;;AAAA;AAEA;;;AAWA,eAAe,sBAAsB,QAAa;IAChD,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACd,KAAK,EACN,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAE/B,IAAI,CAAC,QAAQ,OAAO;QAClB,OAAO;YAAE,MAAM;YAAM,OAAO,SAAS,IAAI,MAAM;YAAsB,MAAM;QAAK;IAClF;IAEA,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,YAAY,MAAM,CAAC,QAAQ,EAAE,CAAC,MAAM,KAAK,EAAE,EAAE,MAAM;IACjG,IAAI,CAAC,CAAC,SAAS,MAAM,WAAW,aAAa,SAAS,SAAS,KAAK,GAAG;QACrE,OAAO;YAAE,MAAM;YAAM,OAAO,IAAI,MAAM;YAA0B,MAAM;QAAK;IAC7E;IACA,OAAO;QAAE;QAAM,OAAO;QAAM,MAAM,QAAQ,IAAI;IAAC;AACjD;AAEO,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,uLAAiB;QACxC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,GAAG,MAAM,sBAAsB;QAE1D,IAAI,SAAS,CAAC,QAAQ,CAAC,MAAM;YAC3B,OAAO,uKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,UAA0B;YAC9B,QAAQ,aAAa,GAAG,CAAC;YACzB,UAAU,aAAa,GAAG,CAAC;YAC3B,UAAU,aAAa,GAAG,CAAC;YAC3B,aAAa,aAAa,GAAG,CAAC;YAC9B,cAAc,aAAa,GAAG,CAAC;YAC/B,GAAG,aAAa,GAAG,CAAC;QACtB;QAEA,IAAI,QAAQ,SACT,IAAI,CAAC,mBACL,MAAM,CACL,CAAC;;;;;MAKH,CAAC,EAEA,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM;QAE1C,IAAI,QAAQ,MAAM,IAAI,QAAQ,MAAM,KAAK,OAAO;YAC9C,QAAQ,MAAM,EAAE,CAAC,UAAU,QAAQ,MAAM;QAC3C;QACA,IAAI,QAAQ,QAAQ,IAAI,QAAQ,QAAQ,KAAK,OAAO;YAClD,QAAQ,MAAM,EAAE,CAAC,YAAY,QAAQ,QAAQ;QAC/C;QACA,IAAI,QAAQ,QAAQ,IAAI,QAAQ,QAAQ,KAAK,OAAO;YAClD,QAAQ,MAAM,EAAE,CAAC,YAAY,QAAQ,QAAQ;QAC/C;QAEA,2EAA2E;QAC3E,IAAI,QAAQ,WAAW,KAAK,MAAM;YAChC,mCAAmC;YACnC,MAAM,YAAY;YAClB,IAAI,UAAU,IAAI,CAAC,KAAK,EAAE,GAAG;gBAC3B,QAAQ,MAAM,EAAE,CAAC,eAAe,KAAK,EAAE;YACzC,OAAO;gBACL,sDAAsD;gBACtD,QAAQ,MAAM,EAAE,CAAC,MAAM;YACzB;QACF,OAAO,IAAI,QAAQ,WAAW,IAAI,QAAQ,WAAW,KAAK,OAAO;YAC/D,QAAQ,MAAM,EAAE,CAAC,eAAe,QAAQ,WAAW;QACrD;QACA,4FAA4F;QAC5F,IAAI,QAAQ,CAAC,EAAE;YACb,MAAM,SAAS,QAAQ,CAAC;YACxB,QAAQ,MAAM,EAAE,CACd,CAAC,eAAe,EAAE,OAAO,iBAAiB,EAAE,OAAO,6BAA6B,EAAE,OAAO,0CAA0C,EAAE,OAAO,CAAC,CAAC;QAElJ;QAEA,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM;QAEpD,IAAI,YAAY;YACd,QAAQ,KAAK,CAAC,4CAA4C;YAC1D,OAAO,uKAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,SAAS,WAAW,OAAO;gBAC3B,MAAM,WAAW,IAAI;gBACrB,MAAM,WAAW,IAAI;gBACrB,QAAQ;YACV,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,aAAa,SAChB,IAAI,CAAC,mBACL,MAAM,CAAC,UAAU;YAAE,OAAO;YAAS,MAAM;QAAM;QAElD,MAAM,EAAE,MAAM,UAAU,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM;QAEtD,IAAI,YAAY;YACd,QAAQ,IAAI,CAAC,kEAAkE;QACjF;QAEA,MAAM,QAAQ,aACV;YACE,gBAAgB,WAAW,MAAM;YACjC,YAAY,WAAW,MAAM,CAAC,CAAC,SAAgB,OAAO,MAAM,KAAK,QAAQ,MAAM;YAC/E,mBAAmB,WAAW,MAAM,CAAC,CAAC,SAAgB;oBAAC;oBAAY;iBAAc,CAAC,QAAQ,CAAC,OAAO,MAAM,GAAG,MAAM;YACjH,aAAa,WAAW,MAAM,CAAC,CAAC,SAAgB,OAAO,MAAM,KAAK,SAAS,MAAM;YACjF,eAAe;YACf,4BAA4B;YAC5B,qBAAqB;QACvB,IACA;QAEJ,OAAO,uKAAY,CAAC,IAAI,CAAC;YACvB,UAAU,YAAY,EAAE;YACxB;YACA,SAAS,QAAQ,YAAY,SAAS,MAAM,GAAG;QACjD;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,qCAAqC;QACnD,OAAO,uKAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,SAAS,eAAe,QAAQ,IAAI,OAAO,GAAG,OAAO;YACrD,QAAQ;QACV,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}