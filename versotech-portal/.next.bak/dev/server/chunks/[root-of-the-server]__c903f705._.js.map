{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/api/auth/signin/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { createServerClient } from '@supabase/ssr'\r\n\r\ntype StaffRole = 'staff_admin' | 'staff_ops' | 'staff_rm' | 'ceo'\r\n\r\ntype SupabaseProfile = {\r\n  id: string\r\n  email: string\r\n  role: string\r\n  display_name: string\r\n  title?: string | null\r\n  created_at?: string\r\n}\r\n\r\nconst STAFF_ROLES: StaffRole[] = ['staff_admin', 'staff_ops', 'staff_rm', 'ceo']\r\nconst STAFF_DOMAINS = ['@versotech.com', '@verso.com']\r\n\r\nconst isStaffRole = (role: string | null | undefined): role is StaffRole => {\r\n  return !!role && STAFF_ROLES.includes(role as StaffRole)\r\n}\r\n\r\nconst isStaffEmail = (email: string | null | undefined): boolean => {\r\n  if (!email) return false\r\n  const lowered = email.toLowerCase()\r\n  return STAFF_DOMAINS.some((domain) => lowered.endsWith(domain))\r\n}\r\n\r\nconst deriveDisplayName = (user: { email?: string | null; user_metadata?: Record<string, unknown> }): string => {\r\n  const metadata = user.user_metadata ?? {}\r\n\r\n  if (typeof metadata === 'object' && metadata !== null) {\r\n    const fullName = (metadata as Record<string, unknown>).full_name\r\n    if (typeof fullName === 'string' && fullName.trim()) {\r\n      return fullName\r\n    }\r\n\r\n    const displayName = (metadata as Record<string, unknown>).display_name\r\n    if (typeof displayName === 'string' && displayName.trim()) {\r\n      return displayName\r\n    }\r\n  }\r\n\r\n  if (user.email) {\r\n    const [localPart] = user.email.split('@')\r\n    if (localPart) return localPart\r\n  }\r\n\r\n  return 'User'\r\n}\r\n\r\n/**\r\n * Resolves the default role for a new user during sign-in.\r\n *\r\n * DESIGN DECISION (Unified Portal - Phase 2):\r\n * Staff auto-provisioning by company email is DISABLED in the unified portal.\r\n * All staff members must be invited by administrators via the User Management UI.\r\n * This provides better security and audit trails for staff account creation.\r\n *\r\n * The company email auto-provisioning logic below only works if portal='staff',\r\n * but the unified portal login always sends portal='investor'. This is intentional.\r\n *\r\n * Staff can still sign in normally after being invited - this function only affects\r\n * NEW users who don't have a profile yet.\r\n */\r\nconst resolveDefaultRole = (\r\n  portal: string,\r\n  metadataRole: string | null,\r\n  email: string | null\r\n): string | null => {\r\n  // SECURITY: Never trust metadataRole for staff roles\r\n  // Staff roles should ONLY come from:\r\n  // 1. Admin-created profiles (invitation flow)\r\n  // 2. Company email domain validation (legacy, disabled in unified portal)\r\n\r\n  if (portal === 'staff') {\r\n    // Legacy staff portal: auto-provision by company email domain\r\n    // NOTE: This path is not used in the unified portal (portal is always 'investor')\r\n    if (isStaffEmail(email)) {\r\n      return 'staff_ops'\r\n    }\r\n    // DENY - non-company email trying to access staff portal\r\n    return null\r\n  }\r\n\r\n  // Unified portal: always default to investor for new users\r\n  // Staff must be pre-invited by administrators\r\n  return 'investor'\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  // Create a response that we'll set cookies on\r\n  // This is required because cookies().set() doesn't reliably work in Route Handlers\r\n  let response = NextResponse.json({ success: false })\r\n\r\n  try {\r\n    const body = await request.json()\r\n    const email = typeof body.email === 'string' ? body.email : ''\r\n    const password = typeof body.password === 'string' ? body.password : ''\r\n    const portalContext = typeof body.portal === 'string' ? body.portal : 'investor'\r\n\r\n    if (!email || !password) {\r\n      return NextResponse.json({\r\n        error: 'Email and password are required'\r\n      }, { status: 400 })\r\n    }\r\n\r\n    // Create Supabase client that sets cookies DIRECTLY on the response\r\n    // This pattern is required for Route Handlers (unlike Server Components)\r\n    const supabase = createServerClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n      {\r\n        cookies: {\r\n          getAll() {\r\n            return request.cookies.getAll()\r\n          },\r\n          setAll(cookiesToSet) {\r\n            // Set cookies on the response object\r\n            cookiesToSet.forEach(({ name, value, options }) => {\r\n              response.cookies.set(name, value, options)\r\n            })\r\n          },\r\n        },\r\n      }\r\n    )\r\n\r\n    // Clear any existing session first to prevent conflicts\r\n    // This is critical for fixing \"Invalid Refresh Token\" errors on re-login\r\n    try {\r\n      await supabase.auth.signOut({ scope: 'local' })\r\n    } catch (signOutError) {\r\n      console.warn('[signin] Pre-signin signOut warning (non-fatal):', signOutError)\r\n      // Non-fatal, continue with sign-in\r\n    }\r\n\r\n    const { data, error } = await supabase.auth.signInWithPassword({\r\n      email,\r\n      password\r\n    })\r\n\r\n    if (error) {\r\n      console.error('[signin] Supabase sign-in error:', {\r\n        message: error.message,\r\n        status: error.status,\r\n        name: error.name\r\n      })\r\n\r\n      // Provide specific error messages based on error type\r\n      if (error.message?.toLowerCase().includes('invalid login credentials')) {\r\n        return NextResponse.json({\r\n          error: 'Invalid email or password. Please check your credentials and try again.'\r\n        }, { status: 401 })\r\n      }\r\n\r\n      if (error.message?.toLowerCase().includes('email not confirmed')) {\r\n        return NextResponse.json({\r\n          error: 'Please confirm your email address before signing in.'\r\n        }, { status: 403 })\r\n      }\r\n\r\n      if (error.message?.toLowerCase().includes('refresh') ||\r\n          error.message?.toLowerCase().includes('session')) {\r\n        return NextResponse.json({\r\n          error: 'Session conflict detected. Please try again.'\r\n        }, { status: 409 })\r\n      }\r\n\r\n      if (error.message?.toLowerCase().includes('rate limit') ||\r\n          error.message?.toLowerCase().includes('too many')) {\r\n        return NextResponse.json({\r\n          error: 'Too many login attempts. Please wait a moment and try again.'\r\n        }, { status: 429 })\r\n      }\r\n\r\n      // Generic error for unknown cases\r\n      return NextResponse.json({\r\n        error: 'Authentication failed. Please try again or contact support if the problem persists.',\r\n        debug: process.env.NODE_ENV === 'development' ? error.message : undefined\r\n      }, { status: 401 })\r\n    }\r\n\r\n    if (!data.user) {\r\n      await supabase.auth.signOut()\r\n      return NextResponse.json({ error: 'Authentication failed - no user data' }, { status: 401 })\r\n    }\r\n\r\n    if (!data.session) {\r\n      await supabase.auth.signOut()\r\n      return NextResponse.json({\r\n        error: 'Email verification required. Please confirm your email before signing in.'\r\n      }, { status: 403 })\r\n    }\r\n\r\n    const user = data.user\r\n    const userEmail = user.email?.toLowerCase() ?? null\r\n    const metadataRole = typeof user.user_metadata?.role === 'string' ? user.user_metadata.role : null\r\n\r\n    const {\r\n      data: profile,\r\n      error: profileError\r\n    } = await supabase\r\n      .from('profiles')\r\n      .select('*')\r\n      .eq('id', user.id)\r\n      .single<SupabaseProfile>()\r\n\r\n    let resolvedProfile: SupabaseProfile | null = profile ?? null\r\n\r\n    if ((profileError && profileError.code === 'PGRST116') || !profile) {\r\n      const defaultRole = resolveDefaultRole(portalContext, metadataRole, userEmail)\r\n\r\n      if (!defaultRole) {\r\n        await supabase.auth.signOut()\r\n        return NextResponse.json({\r\n          error: 'Staff access required. Please contact an administrator.'\r\n        }, { status: 403 })\r\n      }\r\n\r\n      const displayName = deriveDisplayName(user)\r\n\r\n      const { data: createdProfile, error: upsertError } = await supabase\r\n        .from('profiles')\r\n        .upsert({\r\n          id: user.id,\r\n          email: user.email,\r\n          role: defaultRole,\r\n          display_name: displayName,\r\n          created_at: new Date().toISOString()\r\n        }, { onConflict: 'id' })\r\n        .select('*')\r\n        .single<SupabaseProfile>()\r\n\r\n      if (upsertError || !createdProfile) {\r\n        console.error('Signin profile upsert error:', upsertError)\r\n        await supabase.auth.signOut()\r\n        return NextResponse.json({\r\n          error: 'User profile could not be created'\r\n        }, { status: 500 })\r\n      }\r\n\r\n      resolvedProfile = createdProfile\r\n    } else if (profileError) {\r\n      console.error('Signin profile fetch error:', profileError)\r\n      await supabase.auth.signOut()\r\n      return NextResponse.json({\r\n        error: 'Failed to load user profile'\r\n      }, { status: 500 })\r\n    }\r\n\r\n    if (!resolvedProfile) {\r\n      await supabase.auth.signOut()\r\n      return NextResponse.json({\r\n        error: 'User profile not found'\r\n      }, { status: 404 })\r\n    }\r\n\r\n    // Unified portal: all users go to /versotech_main/dashboard\r\n    // The layout handles persona-based routing and access control\r\n    let redirectPath = '/versotech_main/dashboard'\r\n\r\n    // Staff portal context check is no longer needed since we have unified access\r\n    // Keep backward compatibility: staff role users coming from old staff login\r\n    if (portalContext === 'staff' && !isStaffRole(resolvedProfile.role)) {\r\n      await supabase.auth.signOut()\r\n      return NextResponse.json({\r\n        error: 'Staff access required. This account has investor-level access.'\r\n      }, { status: 403 })\r\n    }\r\n\r\n    // Create the success response with all the data\r\n    // Cookies have already been set on `response` by Supabase's setAll() callback\r\n    const successData = {\r\n      success: true,\r\n      redirect: redirectPath,\r\n      session: {\r\n        access_token: data.session.access_token,\r\n        refresh_token: data.session.refresh_token,\r\n        expires_at: data.session.expires_at\r\n      },\r\n      user: {\r\n        id: user.id,\r\n        email: user.email,\r\n        role: resolvedProfile.role,\r\n        displayName: resolvedProfile.display_name\r\n      }\r\n    }\r\n\r\n    // Create new response with success data but PRESERVE the cookies from setAll\r\n    const successResponse = NextResponse.json(successData)\r\n\r\n    // Copy all cookies from the response that setAll populated\r\n    response.cookies.getAll().forEach(cookie => {\r\n      successResponse.cookies.set(cookie.name, cookie.value)\r\n    })\r\n\r\n    return successResponse\r\n  } catch (error) {\r\n    console.error('Signin error:', error)\r\n    return NextResponse.json({\r\n      error: 'Internal server error'\r\n    }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}