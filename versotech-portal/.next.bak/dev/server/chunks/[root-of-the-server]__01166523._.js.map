{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,MAAM,eAAe;IAC1B,MAAM,cAAc,MAAM,IAAA,mKAAO;IAEjC,OAAO,IAAA,wNAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;wBAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAC/B;gBACF,EAAE,OAAO,OAAO;gBACd,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ;AAIO,MAAM,sBAAsB;IACjC,OAAO,IAAA,gOAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB,EACrC;QACE,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AAEJ"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/api/investors/route.ts"],"sourcesContent":["import { createClient, createServiceClient } from '@/lib/supabase/server'\nimport { NextResponse, NextRequest } from 'next/server'\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Auth check first - prevent unauthenticated access\n    const authSupabase = await createClient()\n    const { data: { user } } = await authSupabase.auth.getUser()\n\n    if (!user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    // Staff role check - only staff can access investor list\n    const { data: profile } = await authSupabase\n      .from('profiles')\n      .select('role')\n      .eq('id', user.id)\n      .single()\n\n    if (!(profile?.role?.startsWith('staff_') || profile?.role === 'ceo')) {\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 })\n    }\n\n    // Use service client for the actual query (bypasses RLS for full access)\n    const supabase = createServiceClient()\n\n    // Get query parameters\n    const searchParams = request.nextUrl.searchParams\n    const limit = parseInt(searchParams.get('limit') || '100')\n    const offset = parseInt(searchParams.get('offset') || '0')\n    const hasUsers = searchParams.get('has_users') === 'true'\n    const search = searchParams.get('search')\n\n    let investors: any[] = []\n    let error: any = null\n\n    if (hasUsers) {\n      // Fetch only investors that have linked user accounts\n      let query = supabase\n        .from('investors')\n        .select(`\n          id,\n          legal_name,\n          display_name,\n          email,\n          type,\n          kyc_status,\n          investor_users!inner (\n            user_id,\n            profiles:user_id (\n              id,\n              display_name,\n              email,\n              role\n            )\n          )\n        `)\n        .order('legal_name')\n        .range(offset, offset + limit - 1)\n\n      // Add search filter - search in legal_name, display_name, or email\n      if (search) {\n        query = query.or(`legal_name.ilike.%${search}%,display_name.ilike.%${search}%,email.ilike.%${search}%`)\n      }\n\n      const result = await query\n      investors = result.data || []\n      error = result.error\n    } else {\n      // Fetch all investors with more fields\n      let query = supabase\n        .from('investors')\n        .select('id, legal_name, display_name, email, type, kyc_status')\n        .order('legal_name')\n        .range(offset, offset + limit - 1)\n\n      // Add search filter\n      if (search) {\n        query = query.or(`legal_name.ilike.%${search}%,display_name.ilike.%${search}%,email.ilike.%${search}%`)\n      }\n\n      const result = await query\n      investors = result.data || []\n      error = result.error\n    }\n\n    if (error) {\n      console.error('Fetch investors error:', error)\n      return NextResponse.json(\n        { error: 'Failed to fetch investors' },\n        { status: 500 }\n      )\n    }\n\n    // Return with both 'data' and 'investors' keys for compatibility\n    return NextResponse.json({\n      data: investors || [],\n      investors: investors || []\n    })\n\n  } catch (error) {\n    console.error('API /investors error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,oDAAoD;QACpD,MAAM,eAAe,MAAM,IAAA,yKAAY;QACvC,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,GAAG,MAAM,aAAa,IAAI,CAAC,OAAO;QAE1D,IAAI,CAAC,MAAM;YACT,OAAO,uKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,yDAAyD;QACzD,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,aAC7B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;QAET,IAAI,CAAC,CAAC,SAAS,MAAM,WAAW,aAAa,SAAS,SAAS,KAAK,GAAG;YACrE,OAAO,uKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAY,GAAG;gBAAE,QAAQ;YAAI;QACjE;QAEA,yEAAyE;QACzE,MAAM,WAAW,IAAA,gLAAmB;QAEpC,uBAAuB;QACvB,MAAM,eAAe,QAAQ,OAAO,CAAC,YAAY;QACjD,MAAM,QAAQ,SAAS,aAAa,GAAG,CAAC,YAAY;QACpD,MAAM,SAAS,SAAS,aAAa,GAAG,CAAC,aAAa;QACtD,MAAM,WAAW,aAAa,GAAG,CAAC,iBAAiB;QACnD,MAAM,SAAS,aAAa,GAAG,CAAC;QAEhC,IAAI,YAAmB,EAAE;QACzB,IAAI,QAAa;QAEjB,IAAI,UAAU;YACZ,sDAAsD;YACtD,IAAI,QAAQ,SACT,IAAI,CAAC,aACL,MAAM,CAAC,CAAC;;;;;;;;;;;;;;;;QAgBT,CAAC,EACA,KAAK,CAAC,cACN,KAAK,CAAC,QAAQ,SAAS,QAAQ;YAElC,mEAAmE;YACnE,IAAI,QAAQ;gBACV,QAAQ,MAAM,EAAE,CAAC,CAAC,kBAAkB,EAAE,OAAO,sBAAsB,EAAE,OAAO,eAAe,EAAE,OAAO,CAAC,CAAC;YACxG;YAEA,MAAM,SAAS,MAAM;YACrB,YAAY,OAAO,IAAI,IAAI,EAAE;YAC7B,QAAQ,OAAO,KAAK;QACtB,OAAO;YACL,uCAAuC;YACvC,IAAI,QAAQ,SACT,IAAI,CAAC,aACL,MAAM,CAAC,yDACP,KAAK,CAAC,cACN,KAAK,CAAC,QAAQ,SAAS,QAAQ;YAElC,oBAAoB;YACpB,IAAI,QAAQ;gBACV,QAAQ,MAAM,EAAE,CAAC,CAAC,kBAAkB,EAAE,OAAO,sBAAsB,EAAE,OAAO,eAAe,EAAE,OAAO,CAAC,CAAC;YACxG;YAEA,MAAM,SAAS,MAAM;YACrB,YAAY,OAAO,IAAI,IAAI,EAAE;YAC7B,QAAQ,OAAO,KAAK;QACtB;QAEA,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,0BAA0B;YACxC,OAAO,uKAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA4B,GACrC;gBAAE,QAAQ;YAAI;QAElB;QAEA,iEAAiE;QACjE,OAAO,uKAAY,CAAC,IAAI,CAAC;YACvB,MAAM,aAAa,EAAE;YACrB,WAAW,aAAa,EAAE;QAC5B;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,uKAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}