{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,MAAM,eAAe;IAC1B,MAAM,cAAc,MAAM,IAAA,mKAAO;IAEjC,OAAO,IAAA,wNAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;wBAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAC/B;gBACF,EAAE,OAAO,OAAO;gBACd,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ;AAIO,MAAM,sBAAsB;IACjC,OAAO,IAAA,gOAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB,EACrC;QACE,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AAEJ"}},
    {"offset": {"line": 134, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/auth.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\r\nimport { cookies } from 'next/headers'\r\nimport { redirect } from 'next/navigation'\r\nimport type { User, Session } from '@supabase/supabase-js'\r\n\r\n// Profile roles (stored in profiles.role)\r\nexport type ProfileRole =\r\n  | 'investor'\r\n  | 'staff_admin'\r\n  | 'staff_ops'\r\n  | 'staff_rm'\r\n  | 'arranger'\r\n  | 'introducer'\r\n  | 'partner'\r\n  | 'commercial_partner'\r\n  | 'lawyer'\r\n  | 'ceo'\r\n\r\n// All persona types (from get_user_personas())\r\nexport type PersonaType = 'staff' | 'investor' | 'arranger' | 'introducer' | 'partner' | 'commercial_partner' | 'lawyer'\r\n\r\n// UserRole = ProfileRole for backward compatibility\r\nexport type UserRole = ProfileRole\r\n\r\nconst STAFF_ROLES: ProfileRole[] = ['staff_admin', 'staff_ops', 'staff_rm', 'ceo']\r\n\r\nexport interface AuthUser {\r\n  id: string\r\n  email: string\r\n  displayName: string\r\n  avatar?: string\r\n  role: UserRole\r\n  title?: string\r\n  created_at: string\r\n  permissions?: string[]\r\n}\r\n\r\n// Alias for backward compatibility\r\nexport type Profile = AuthUser\r\n\r\nexport interface AuthSession {\r\n  user: AuthUser\r\n  session: Session\r\n}\r\n\r\nexport class AuthError extends Error {\r\n  constructor(message: string, public code?: string) {\r\n    super(message)\r\n    this.name = 'AuthError'\r\n  }\r\n}\r\n\r\n// Server-side Supabase client\r\nconst createServerSupabaseClient = async () => {\r\n  const cookieStore = await cookies()\r\n\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        getAll() {\r\n          return cookieStore.getAll()\r\n        },\r\n        setAll(cookiesToSet) {\r\n          try {\r\n            cookiesToSet.forEach(({ name, value, options }) =>\r\n              cookieStore.set(name, value, options)\r\n            )\r\n          } catch {\r\n            // The `setAll` method was called from a Server Component.\r\n            // This can be ignored if you have middleware refreshing\r\n            // user sessions.\r\n          }\r\n        },\r\n      },\r\n    }\r\n  )\r\n}\r\n\r\n// Get current user with profile data\r\nexport async function getCurrentUser(): Promise<AuthUser | null> {\r\n  try {\r\n    const supabase = await createServerSupabaseClient()\r\n\r\n    // Get current auth user\r\n    const { data: { user }, error: userError } = await supabase.auth.getUser()\r\n\r\n    if (userError || !user) {\r\n      return null\r\n    }\r\n\r\n    // Get profile data from database\r\n    const { data: profile, error: profileError } = await supabase\r\n      .from('profiles')\r\n      .select('*')\r\n      .eq('id', user.id)\r\n      .single()\r\n\r\n    if (profileError || !profile) {\r\n      console.error('[auth] Profile not found for user:', user.id, profileError)\r\n      return null\r\n    }\r\n\r\n    // Fetch permissions for staff users\r\n    let permissions: string[] = []\r\n    const isStaffRole = STAFF_ROLES.includes(profile.role)\r\n\r\n    if (isStaffRole) {\r\n      const { data: permissionsData } = await supabase\r\n        .from('staff_permissions')\r\n        .select('permission')\r\n        .eq('user_id', user.id)\r\n\r\n      permissions = permissionsData?.map(p => p.permission) || []\r\n    }\r\n\r\n    return {\r\n      id: profile.id,\r\n      email: profile.email,\r\n      displayName: profile.display_name || profile.email?.split('@')[0] || 'User',\r\n      avatar: profile.avatar_url,\r\n      role: profile.role as UserRole,\r\n      title: profile.title,\r\n      created_at: profile.created_at,\r\n      permissions\r\n    }\r\n  } catch (error) {\r\n    console.error('Error getting current user:', error)\r\n    return null\r\n  }\r\n}\r\n\r\n// Get current session\r\nexport async function getCurrentSession(): Promise<Session | null> {\r\n  try {\r\n    const supabase = await createServerSupabaseClient()\r\n\r\n    const { data: { session }, error } = await supabase.auth.getSession()\r\n\r\n    if (error) {\r\n      console.error('Error getting session:', error)\r\n      return null\r\n    }\r\n\r\n    return session\r\n  } catch (error) {\r\n    console.error('Error getting session:', error)\r\n    return null\r\n  }\r\n}\r\n\r\n// Get profile (alias for getCurrentUser for backward compatibility)\r\nexport async function getProfile(): Promise<AuthUser | null> {\r\n  const user = await getCurrentUser()\r\n  if (user) {\r\n    console.log('[auth] Profile retrieved:', user.email, user.role)\r\n  } else {\r\n    console.log('[auth] No profile found')\r\n  }\r\n  return user\r\n}\r\n\r\n// Require authentication\r\nexport async function requireAuth(allowedRoles?: UserRole[]) {\r\n  const user = await getCurrentUser()\r\n\r\n  if (!user) {\r\n    redirect('/versotech_main/login')\r\n  }\r\n\r\n  if (allowedRoles && !allowedRoles.includes(user.role)) {\r\n    throw new Error('Insufficient permissions')\r\n  }\r\n\r\n  return user\r\n}\r\n\r\n// Require investor auth\r\nexport async function requireInvestorAuth() {\r\n  const user = await getCurrentUser()\r\n\r\n  if (!user) {\r\n    redirect('/versotech_main/login')\r\n  }\r\n\r\n  if (user.role !== 'investor') {\r\n    throw new Error('Investor access required')\r\n  }\r\n\r\n  return user\r\n}\r\n\r\n// Require staff auth\r\nexport async function requireStaffAuth() {\r\n  const user = await getCurrentUser()\r\n\r\n  if (!user) {\r\n    redirect('/versotech_main/login')\r\n  }\r\n\r\n  if (!STAFF_ROLES.includes(user.role)) {\r\n    throw new Error('Staff access required')\r\n  }\r\n\r\n  return user\r\n}\r\n\r\n/**\r\n * Check if a user has staff-level access for page authorization.\r\n *\r\n * IMPORTANT: Staff users (staff_admin, ceo, staff_ops, staff_rm) don't have\r\n * traditional database persona entries. Their \"personas\" are created synthetically\r\n * in the layout. This function checks BOTH:\r\n * 1. Profile role (for staff users without persona entries)\r\n * 2. Database personas (for users with explicit staff/ceo persona entries)\r\n *\r\n * @param userId - The user's ID\r\n * @returns true if user has staff access (via role OR persona)\r\n */\r\nexport async function checkStaffAccess(userId: string): Promise<boolean> {\r\n  const supabase = await createServerSupabaseClient()\r\n\r\n  // Check profile role first (handles synthetic staff personas)\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', userId)\r\n    .single()\r\n\r\n  if (!profileError && profile && STAFF_ROLES.includes(profile.role as ProfileRole)) {\r\n    return true\r\n  }\r\n\r\n  // Fallback: check database personas (for edge cases)\r\n  const { data: personas } = await supabase.rpc('get_user_personas', {\r\n    p_user_id: userId\r\n  })\r\n\r\n  return personas?.some(\r\n    (p: { persona_type: string }) => p.persona_type === 'staff' || p.persona_type === 'ceo'\r\n  ) || false\r\n}\r\n\r\n/**\r\n * Check if a user has CEO-level access (full admin access).\r\n * CEO access is granted to users with 'ceo' or 'staff_admin' profile roles.\r\n */\r\nexport async function checkCeoAccess(userId: string): Promise<boolean> {\r\n  const supabase = await createServerSupabaseClient()\r\n\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', userId)\r\n    .single()\r\n\r\n  return profile?.role === 'ceo' || profile?.role === 'staff_admin'\r\n}\r\n\r\n// Export STAFF_ROLES for use in pages\r\nexport { STAFF_ROLES }\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 309, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/api-auth.ts"],"sourcesContent":["/**\r\n * Helper to get authenticated user from Supabase auth\r\n * Works with both createClient() and createServiceClient()\r\n */\r\nexport async function getAuthenticatedUser(supabase: any) {\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n\r\n  return {\r\n    user,\r\n    error: authError\r\n  }\r\n}\r\n\r\n/**\r\n * Get user role from database profile\r\n */\r\nexport async function getUserRole(supabase: any, user: any): Promise<string | null> {\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  return profile?.role || null\r\n}\r\n\r\n/**\r\n * Check if user has a specific permission OR is CEO (CEO bypasses all permission checks)\r\n *\r\n * This centralizes permission checking so that:\r\n * 1. CEO users automatically have ALL permissions without needing staff_permissions entries\r\n * 2. Regular staff users need explicit permissions in staff_permissions table\r\n *\r\n * @param supabase - Supabase client (can be regular or service client)\r\n * @param userId - The user's ID\r\n * @param requiredPermissions - Array of permissions (user needs ANY of these, not all)\r\n * @returns true if user has permission or is CEO\r\n */\r\nexport async function hasPermission(\r\n  supabase: any,\r\n  userId: string,\r\n  requiredPermissions: string[]\r\n): Promise<boolean> {\r\n  // First, check if user is CEO - CEO bypasses all permission checks\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', userId)\r\n    .single()\r\n\r\n  if (profile?.role === 'ceo') {\r\n    return true // CEO has all permissions\r\n  }\r\n\r\n  // Also check if user has CEO persona (for multi_persona users)\r\n  const { data: ceoUser } = await supabase\r\n    .from('ceo_users')\r\n    .select('user_id')\r\n    .eq('user_id', userId)\r\n    .maybeSingle()\r\n\r\n  if (ceoUser) {\r\n    return true // User is in ceo_users table, has all permissions\r\n  }\r\n\r\n  // For non-CEO users, check staff_permissions table\r\n  const { data: permission } = await supabase\r\n    .from('staff_permissions')\r\n    .select('permission')\r\n    .eq('user_id', userId)\r\n    .in('permission', requiredPermissions)\r\n    .limit(1)\r\n    .maybeSingle()\r\n\r\n  return !!permission\r\n}\r\n\r\n/**\r\n * Check if user has super_admin permission OR is CEO\r\n * Convenience function for the most common permission check\r\n */\r\nexport async function isSuperAdmin(supabase: any, userId: string): Promise<boolean> {\r\n  return hasPermission(supabase, userId, ['super_admin'])\r\n}\r\n\r\n/**\r\n * Check if user is staff using both profile role AND persona system\r\n *\r\n * Users can have staff access through:\r\n * 1. Legacy role field: 'staff_*' or 'ceo' in profiles.role\r\n * 2. Persona system: staff or ceo persona via get_user_personas RPC\r\n */\r\nexport async function isStaffUser(supabase: any, user: any): Promise<boolean> {\r\n  // First check legacy role field\r\n  const role = await getUserRole(supabase, user)\r\n  if (role && (role.startsWith('staff_') || role === 'ceo')) {\r\n    return true\r\n  }\r\n\r\n  // For multi_persona users, check personas via RPC\r\n  if (role === 'multi_persona') {\r\n    try {\r\n      const { data: personas } = await supabase.rpc('get_user_personas', {\r\n        p_user_id: user.id\r\n      })\r\n\r\n      if (personas && Array.isArray(personas)) {\r\n        return personas.some(\r\n          (p: any) => p.persona_type === 'staff' || p.persona_type === 'ceo'\r\n        )\r\n      }\r\n    } catch (err) {\r\n      console.error('[isStaffUser] Error checking personas:', err)\r\n    }\r\n  }\r\n\r\n  return false\r\n}\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;;;;;AACM,eAAe,qBAAqB,QAAa;IACtD,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAExE,OAAO;QACL;QACA,OAAO;IACT;AACF;AAKO,eAAe,YAAY,QAAa,EAAE,IAAS;IACxD,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;IAET,OAAO,SAAS,QAAQ;AAC1B;AAcO,eAAe,cACpB,QAAa,EACb,MAAc,EACd,mBAA6B;IAE7B,mEAAmE;IACnE,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,QACT,MAAM;IAET,IAAI,SAAS,SAAS,OAAO;QAC3B,OAAO,KAAK,0BAA0B;;IACxC;IAEA,+DAA+D;IAC/D,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,aACL,MAAM,CAAC,WACP,EAAE,CAAC,WAAW,QACd,WAAW;IAEd,IAAI,SAAS;QACX,OAAO,KAAK,kDAAkD;;IAChE;IAEA,mDAAmD;IACnD,MAAM,EAAE,MAAM,UAAU,EAAE,GAAG,MAAM,SAChC,IAAI,CAAC,qBACL,MAAM,CAAC,cACP,EAAE,CAAC,WAAW,QACd,EAAE,CAAC,cAAc,qBACjB,KAAK,CAAC,GACN,WAAW;IAEd,OAAO,CAAC,CAAC;AACX;AAMO,eAAe,aAAa,QAAa,EAAE,MAAc;IAC9D,OAAO,cAAc,UAAU,QAAQ;QAAC;KAAc;AACxD;AASO,eAAe,YAAY,QAAa,EAAE,IAAS;IACxD,gCAAgC;IAChC,MAAM,OAAO,MAAM,YAAY,UAAU;IACzC,IAAI,QAAQ,CAAC,KAAK,UAAU,CAAC,aAAa,SAAS,KAAK,GAAG;QACzD,OAAO;IACT;IAEA,kDAAkD;IAClD,IAAI,SAAS,iBAAiB;QAC5B,IAAI;YACF,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,qBAAqB;gBACjE,WAAW,KAAK,EAAE;YACpB;YAEA,IAAI,YAAY,MAAM,OAAO,CAAC,WAAW;gBACvC,OAAO,SAAS,IAAI,CAClB,CAAC,IAAW,EAAE,YAAY,KAAK,WAAW,EAAE,YAAY,KAAK;YAEjE;QACF,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,0CAA0C;QAC1D;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 382, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/utils/date-helpers.ts"],"sourcesContent":["/**\n * Date Helper Utilities\n *\n * Shared utility functions for date-related operations across the application.\n */\n\n/**\n * Check if an ID document is expiring soon (within 30 days) or already expired.\n *\n * @param expiryDate - The expiry date string (ISO format) or null\n * @returns 'expired' if the date is in the past, 'expiring_soon' if within 30 days, null otherwise\n */\nexport function getIdExpiryWarning(expiryDate: string | null): 'expired' | 'expiring_soon' | null {\n  if (!expiryDate) return null\n\n  const expiry = new Date(expiryDate)\n  const now = new Date()\n  const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000)\n\n  if (expiry < now) return 'expired'\n  if (expiry < thirtyDaysFromNow) return 'expiring_soon'\n  return null\n}\n\n/**\n * Format a date string for display in UK format (e.g., \"17 Jan 2026\")\n *\n * @param dateStr - The date string to format\n * @returns Formatted date string\n */\nexport function formatDateDisplay(dateStr: string): string {\n  return new Date(dateStr).toLocaleDateString('en-GB', {\n    day: 'numeric',\n    month: 'short',\n    year: 'numeric'\n  })\n}\n\n/**\n * Get a human-readable relative time string (e.g., \"2 days ago\", \"Just now\")\n *\n * @param dateStr - The date string to compare to now, or null\n * @returns A human-readable relative time string\n */\nexport function getRelativeTime(dateStr: string | null): string {\n  if (!dateStr) return 'Never'\n\n  const date = new Date(dateStr)\n  const now = new Date()\n  const diff = now.getTime() - date.getTime()\n  const hours = Math.floor(diff / (1000 * 60 * 60))\n  const days = Math.floor(diff / (1000 * 60 * 60 * 24))\n\n  if (hours < 1) return 'Just now'\n  if (hours === 1) return '1 hour ago'\n  if (hours < 24) return `${hours} hours ago`\n  if (days === 1) return 'Yesterday'\n  if (days < 7) return `${days} days ago`\n  if (days < 30) return `${Math.floor(days / 7)} weeks ago`\n  if (days < 365) return `${Math.floor(days / 30)} months ago`\n  return `${Math.floor(days / 365)} years ago`\n}\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED;;;;;CAKC;;;;;;;;AACM,SAAS,mBAAmB,UAAyB;IAC1D,IAAI,CAAC,YAAY,OAAO;IAExB,MAAM,SAAS,IAAI,KAAK;IACxB,MAAM,MAAM,IAAI;IAChB,MAAM,oBAAoB,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,KAAK,KAAK,KAAK;IAEvE,IAAI,SAAS,KAAK,OAAO;IACzB,IAAI,SAAS,mBAAmB,OAAO;IACvC,OAAO;AACT;AAQO,SAAS,kBAAkB,OAAe;IAC/C,OAAO,IAAI,KAAK,SAAS,kBAAkB,CAAC,SAAS;QACnD,KAAK;QACL,OAAO;QACP,MAAM;IACR;AACF;AAQO,SAAS,gBAAgB,OAAsB;IACpD,IAAI,CAAC,SAAS,OAAO;IAErB,MAAM,OAAO,IAAI,KAAK;IACtB,MAAM,MAAM,IAAI;IAChB,MAAM,OAAO,IAAI,OAAO,KAAK,KAAK,OAAO;IACzC,MAAM,QAAQ,KAAK,KAAK,CAAC,OAAO,CAAC,OAAO,KAAK,EAAE;IAC/C,MAAM,OAAO,KAAK,KAAK,CAAC,OAAO,CAAC,OAAO,KAAK,KAAK,EAAE;IAEnD,IAAI,QAAQ,GAAG,OAAO;IACtB,IAAI,UAAU,GAAG,OAAO;IACxB,IAAI,QAAQ,IAAI,OAAO,GAAG,MAAM,UAAU,CAAC;IAC3C,IAAI,SAAS,GAAG,OAAO;IACvB,IAAI,OAAO,GAAG,OAAO,GAAG,KAAK,SAAS,CAAC;IACvC,IAAI,OAAO,IAAI,OAAO,GAAG,KAAK,KAAK,CAAC,OAAO,GAAG,UAAU,CAAC;IACzD,IAAI,OAAO,KAAK,OAAO,GAAG,KAAK,KAAK,CAAC,OAAO,IAAI,WAAW,CAAC;IAC5D,OAAO,GAAG,KAAK,KAAK,CAAC,OAAO,KAAK,UAAU,CAAC;AAC9C"}},
    {"offset": {"line": 435, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/api/admin/users/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { createServiceClient } from '@/lib/supabase/server'\r\nimport { getCurrentUser } from '@/lib/auth'\r\nimport { isSuperAdmin } from '@/lib/api-auth'\r\nimport { getIdExpiryWarning } from '@/lib/utils/date-helpers'\r\n\r\n// Type definitions for the Users API response\r\nexport interface EntityAssociation {\r\n  id: string\r\n  name: string\r\n  type: 'investor' | 'partner' | 'lawyer' | 'commercial_partner' | 'introducer' | 'arranger'\r\n  role: string\r\n  isPrimary: boolean\r\n  canSign: boolean\r\n  approvalStatus: string | null\r\n}\r\n\r\n// Summary KYC for list view\r\nexport interface UserKyc {\r\n  status: 'approved' | 'pending' | 'submitted' | 'rejected' | 'expired' | null\r\n  idType: string | null\r\n  idExpiry: string | null\r\n  idExpiryWarning: 'expired' | 'expiring_soon' | null\r\n  nationality: string | null\r\n  taxResidency: string | null\r\n  isUsPerson: boolean\r\n}\r\n\r\n// Full KYC data for detail view (matches IndividualKycData interface)\r\nexport interface FullUserKyc {\r\n  // KYC Status\r\n  kyc_status: 'approved' | 'pending' | 'submitted' | 'rejected' | 'expired' | null\r\n\r\n  // Personal Info\r\n  first_name: string | null\r\n  middle_name: string | null\r\n  middle_initial: string | null\r\n  last_name: string | null\r\n  name_suffix: string | null\r\n  date_of_birth: string | null\r\n  country_of_birth: string | null\r\n  nationality: string | null\r\n  email: string | null\r\n  phone_mobile: string | null\r\n  phone_office: string | null\r\n\r\n  // Residential Address\r\n  residential_street: string | null\r\n  residential_line_2: string | null\r\n  residential_city: string | null\r\n  residential_state: string | null\r\n  residential_postal_code: string | null\r\n  residential_country: string | null\r\n\r\n  // Tax Information\r\n  is_us_citizen: boolean | null\r\n  is_us_taxpayer: boolean | null\r\n  us_taxpayer_id: string | null\r\n  country_of_tax_residency: string | null\r\n  tax_id_number: string | null\r\n\r\n  // Identification Document\r\n  id_type: string | null\r\n  id_number: string | null\r\n  id_issue_date: string | null\r\n  id_expiry_date: string | null\r\n  id_issuing_country: string | null\r\n\r\n  // Proof documents\r\n  proof_of_address_date: string | null\r\n  proof_of_address_expiry: string | null\r\n}\r\n\r\nexport interface UserRow {\r\n  // Core Profile\r\n  id: string\r\n  displayName: string\r\n  email: string\r\n  systemRole: string\r\n  title: string | null\r\n  phone: string | null\r\n  officeLocation: string | null\r\n  avatarUrl: string | null\r\n  createdAt: string\r\n  lastLoginAt: string | null\r\n  passwordSet: boolean\r\n  isSuperAdmin: boolean\r\n  hasSignature: boolean\r\n  isDeleted: boolean\r\n\r\n  // Entity Associations (aggregated)\r\n  entities: EntityAssociation[]\r\n  entityCount: number\r\n\r\n  // KYC Summary (from linked members)\r\n  kyc: UserKyc | null\r\n}\r\n\r\nexport interface UsersStats {\r\n  total: number\r\n  active: number\r\n  staff: number\r\n  investors: number\r\n  partners: number\r\n  lawyers: number\r\n  introducers: number\r\n  arrangers: number\r\n  pendingKyc: number\r\n  superAdmins: number\r\n}\r\n\r\nexport interface UsersResponse {\r\n  success: boolean\r\n  data?: UserRow[]\r\n  stats?: UsersStats\r\n  pagination?: {\r\n    page: number\r\n    pageSize: number\r\n    totalPages: number\r\n    totalCount: number\r\n  }\r\n  error?: string\r\n}\r\n\r\nexport async function GET(request: NextRequest): Promise<NextResponse<UsersResponse>> {\r\n  try {\r\n    const user = await getCurrentUser()\r\n    if (!user) {\r\n      return NextResponse.json({ success: false, error: 'Unauthorized' }, { status: 401 })\r\n    }\r\n\r\n    const supabase = createServiceClient()\r\n\r\n    // Check if user is super admin OR CEO\r\n    const hasAccess = await isSuperAdmin(supabase, user.id)\r\n    if (!hasAccess) {\r\n      return NextResponse.json({ success: false, error: 'Forbidden' }, { status: 403 })\r\n    }\r\n\r\n    // Parse query parameters\r\n    const searchParams = request.nextUrl.searchParams\r\n    const page = parseInt(searchParams.get('page') || '1')\r\n    const pageSize = parseInt(searchParams.get('pageSize') || '50')\r\n    const search = searchParams.get('search') || ''\r\n    // Support multiple values (comma-separated) for filters\r\n    const roleFilter = searchParams.get('role') || ''\r\n    const roleFilters = roleFilter ? roleFilter.split(',').filter(Boolean) : []\r\n    const entityTypeFilter = searchParams.get('entityType') || ''\r\n    const entityTypeFilters = entityTypeFilter ? entityTypeFilter.split(',').filter(Boolean) : []\r\n    const statusFilter = searchParams.get('status') || ''\r\n    const statusFilters = statusFilter ? statusFilter.split(',').filter(Boolean) : []\r\n    const kycStatusFilter = searchParams.get('kycStatus') || ''\r\n    const hasEntitiesFilter = searchParams.get('hasEntities')\r\n    const sortBy = searchParams.get('sortBy') || 'createdAt'\r\n    const sortOrder = searchParams.get('sortOrder') || 'desc'\r\n    const includeDeleted = searchParams.get('includeDeleted') === 'true'\r\n\r\n    // 1. Fetch all profiles\r\n    let profilesQuery = supabase\r\n      .from('profiles')\r\n      .select('id, display_name, email, role, title, phone, office_location, avatar_url, created_at, last_login_at, password_set, is_super_admin, signature_specimen_url, deleted_at')\r\n\r\n    if (!includeDeleted) {\r\n      profilesQuery = profilesQuery.is('deleted_at', null)\r\n    }\r\n\r\n    const { data: profiles, error: profilesError } = await profilesQuery\r\n\r\n    if (profilesError) {\r\n      console.error('[admin/users] Profiles error:', profilesError)\r\n      return NextResponse.json({ success: false, error: 'Failed to fetch profiles' }, { status: 500 })\r\n    }\r\n\r\n    // 2. Fetch all entity associations in parallel\r\n    const [\r\n      investorUsersResult,\r\n      partnerUsersResult,\r\n      lawyerUsersResult,\r\n      commercialPartnerUsersResult,\r\n      introducerUsersResult,\r\n      arrangerUsersResult\r\n    ] = await Promise.all([\r\n      supabase.from('investor_users').select('user_id, investor_id, role, is_primary, can_sign, ceo_approval_status, investors:investors!investor_users_investor_id_fkey(id, legal_name)'),\r\n      supabase.from('partner_users').select('user_id, partner_id, role, is_primary, can_sign, ceo_approval_status, partners:partners!partner_users_partner_fk(id, name, legal_name)'),\r\n      supabase.from('lawyer_users').select('user_id, lawyer_id, role, is_primary, can_sign, ceo_approval_status, lawyers:lawyers!lawyer_users_lawyer_fk(id, firm_name, display_name)'),\r\n      supabase.from('commercial_partner_users').select('user_id, commercial_partner_id, role, is_primary, can_sign, ceo_approval_status, commercial_partners:commercial_partners!commercial_partner_users_cp_fk(id, name, legal_name)'),\r\n      supabase.from('introducer_users').select('user_id, introducer_id, role, is_primary, can_sign, ceo_approval_status, introducers:introducers!introducer_users_introducer_fk(id, legal_name)'),\r\n      supabase.from('arranger_users').select('user_id, arranger_id, role, is_primary, can_sign, ceo_approval_status, arranger_entities:arranger_entities!arranger_users_arranger_fk(id, legal_name)')\r\n    ])\r\n\r\n    // Build entity association maps by user_id\r\n    const entityMap = new Map<string, EntityAssociation[]>()\r\n\r\n    // Helper to safely get entity data\r\n    const getEntity = (data: unknown) => Array.isArray(data) ? data[0] : data\r\n\r\n    // Process investor associations\r\n    if (investorUsersResult.data) {\r\n      for (const iu of investorUsersResult.data) {\r\n        const entity = getEntity(iu.investors) as { id: string; legal_name: string | null } | null\r\n        if (!entity) continue\r\n        const associations = entityMap.get(iu.user_id) || []\r\n        associations.push({\r\n          id: entity.id,\r\n          name: entity.legal_name || 'Unnamed Investor',\r\n          type: 'investor',\r\n          role: iu.role || 'member',\r\n          isPrimary: iu.is_primary || false,\r\n          canSign: iu.can_sign || false,\r\n          approvalStatus: iu.ceo_approval_status\r\n        })\r\n        entityMap.set(iu.user_id, associations)\r\n      }\r\n    }\r\n\r\n    // Process partner associations\r\n    if (partnerUsersResult.data) {\r\n      for (const pu of partnerUsersResult.data) {\r\n        const entity = getEntity(pu.partners) as { id: string; name: string | null; legal_name: string | null } | null\r\n        if (!entity) continue\r\n        const associations = entityMap.get(pu.user_id) || []\r\n        associations.push({\r\n          id: entity.id,\r\n          name: entity.name || entity.legal_name || 'Unnamed Partner',\r\n          type: 'partner',\r\n          role: pu.role || 'member',\r\n          isPrimary: pu.is_primary || false,\r\n          canSign: pu.can_sign || false,\r\n          approvalStatus: pu.ceo_approval_status\r\n        })\r\n        entityMap.set(pu.user_id, associations)\r\n      }\r\n    }\r\n\r\n    // Process lawyer associations\r\n    if (lawyerUsersResult.data) {\r\n      for (const lu of lawyerUsersResult.data) {\r\n        const entity = getEntity(lu.lawyers) as { id: string; firm_name: string | null; display_name: string | null } | null\r\n        if (!entity) continue\r\n        const associations = entityMap.get(lu.user_id) || []\r\n        associations.push({\r\n          id: entity.id,\r\n          name: entity.firm_name || entity.display_name || 'Unnamed Law Firm',\r\n          type: 'lawyer',\r\n          role: lu.role || 'member',\r\n          isPrimary: lu.is_primary || false,\r\n          canSign: lu.can_sign || false,\r\n          approvalStatus: lu.ceo_approval_status\r\n        })\r\n        entityMap.set(lu.user_id, associations)\r\n      }\r\n    }\r\n\r\n    // Process commercial partner associations\r\n    if (commercialPartnerUsersResult.data) {\r\n      for (const cpu of commercialPartnerUsersResult.data) {\r\n        const entity = getEntity(cpu.commercial_partners) as { id: string; name: string | null; legal_name: string | null } | null\r\n        if (!entity) continue\r\n        const associations = entityMap.get(cpu.user_id) || []\r\n        associations.push({\r\n          id: entity.id,\r\n          name: entity.name || entity.legal_name || 'Unnamed Commercial Partner',\r\n          type: 'commercial_partner',\r\n          role: cpu.role || 'member',\r\n          isPrimary: cpu.is_primary || false,\r\n          canSign: cpu.can_sign || false,\r\n          approvalStatus: cpu.ceo_approval_status\r\n        })\r\n        entityMap.set(cpu.user_id, associations)\r\n      }\r\n    }\r\n\r\n    // Process introducer associations\r\n    if (introducerUsersResult.data) {\r\n      for (const iu of introducerUsersResult.data) {\r\n        const entity = getEntity(iu.introducers) as { id: string; legal_name: string | null } | null\r\n        if (!entity) continue\r\n        const associations = entityMap.get(iu.user_id) || []\r\n        associations.push({\r\n          id: entity.id,\r\n          name: entity.legal_name || 'Unnamed Introducer',\r\n          type: 'introducer',\r\n          role: iu.role || 'member',\r\n          isPrimary: iu.is_primary || false,\r\n          canSign: iu.can_sign || false,\r\n          approvalStatus: iu.ceo_approval_status\r\n        })\r\n        entityMap.set(iu.user_id, associations)\r\n      }\r\n    }\r\n\r\n    // Process arranger associations\r\n    if (arrangerUsersResult.data) {\r\n      for (const au of arrangerUsersResult.data) {\r\n        const entity = getEntity(au.arranger_entities) as { id: string; legal_name: string | null } | null\r\n        if (!entity) continue\r\n        const associations = entityMap.get(au.user_id) || []\r\n        associations.push({\r\n          id: entity.id,\r\n          name: entity.legal_name || 'Unnamed Arranger',\r\n          type: 'arranger',\r\n          role: au.role || 'member',\r\n          isPrimary: au.is_primary || false,\r\n          canSign: au.can_sign || false,\r\n          approvalStatus: au.ceo_approval_status\r\n        })\r\n        entityMap.set(au.user_id, associations)\r\n      }\r\n    }\r\n\r\n    // 3. Fetch KYC data from DIRECT member tables (linked by email)\r\n    // Users can be members in any entity type, so we check all 6 direct member tables\r\n    // NOTE: counterparty_entity_members is EXCLUDED - it stores members of third-party\r\n    // structures (trusts, LLCs) that investors invest THROUGH, not the user's personal KYC\r\n    const profileEmails = profiles?.map(p => p.email).filter(Boolean) || []\r\n\r\n    // Fetch KYC data from all direct member tables in parallel (6 tables)\r\n    const kycFields = 'email, kyc_status, id_type, id_expiry_date, nationality, country_of_tax_residency, is_us_citizen'\r\n    const [\r\n      investorMembersResult,\r\n      partnerMembersResult,\r\n      lawyerMembersResult,\r\n      commercialPartnerMembersResult,\r\n      introducerMembersResult,\r\n      arrangerMembersResult\r\n    ] = profileEmails.length > 0\r\n      ? await Promise.all([\r\n          supabase.from('investor_members').select(kycFields).in('email', profileEmails),\r\n          supabase.from('partner_members').select(kycFields).in('email', profileEmails),\r\n          supabase.from('lawyer_members').select(kycFields).in('email', profileEmails),\r\n          supabase.from('commercial_partner_members').select(kycFields).in('email', profileEmails),\r\n          supabase.from('introducer_members').select(kycFields).in('email', profileEmails),\r\n          supabase.from('arranger_members').select(kycFields).in('email', profileEmails)\r\n        ])\r\n      : [{ data: [] }, { data: [] }, { data: [] }, { data: [] }, { data: [] }, { data: [] }]\r\n\r\n    // Combine all KYC data from direct member tables\r\n    const allKycMembers = [\r\n      ...(investorMembersResult.data || []),\r\n      ...(partnerMembersResult.data || []),\r\n      ...(lawyerMembersResult.data || []),\r\n      ...(commercialPartnerMembersResult.data || []),\r\n      ...(introducerMembersResult.data || []),\r\n      ...(arrangerMembersResult.data || [])\r\n    ]\r\n\r\n    // Build KYC map by email\r\n    // Priority: approved > submitted > pending > rejected > expired > null\r\n    const kycStatusPriority: Record<string, number> = {\r\n      'approved': 5,\r\n      'submitted': 4,\r\n      'pending': 3,\r\n      'rejected': 2,\r\n      'expired': 1\r\n    }\r\n\r\n    const kycMap = new Map<string, UserKyc>()\r\n    for (const member of allKycMembers) {\r\n      if (!member.email) continue\r\n\r\n      const existing = kycMap.get(member.email)\r\n      const existingPriority = existing?.status ? (kycStatusPriority[existing.status] || 0) : 0\r\n      const newPriority = member.kyc_status ? (kycStatusPriority[member.kyc_status] || 0) : 0\r\n\r\n      // Store if we don't have data for this email yet, or if this one has higher priority status\r\n      if (!existing || newPriority > existingPriority) {\r\n        kycMap.set(member.email, {\r\n          status: member.kyc_status as UserKyc['status'],\r\n          idType: member.id_type,\r\n          idExpiry: member.id_expiry_date,\r\n          idExpiryWarning: getIdExpiryWarning(member.id_expiry_date),\r\n          nationality: member.nationality,\r\n          taxResidency: member.country_of_tax_residency,\r\n          isUsPerson: member.is_us_citizen || false\r\n        })\r\n      }\r\n    }\r\n\r\n    // 4. Build user rows\r\n    let userRows: UserRow[] = (profiles || []).map(p => ({\r\n      id: p.id,\r\n      displayName: p.display_name || 'Unknown',\r\n      email: p.email || '',\r\n      systemRole: p.role || 'investor',\r\n      title: p.title,\r\n      phone: p.phone,\r\n      officeLocation: p.office_location,\r\n      avatarUrl: p.avatar_url,\r\n      createdAt: p.created_at,\r\n      lastLoginAt: p.last_login_at,\r\n      passwordSet: p.password_set || false,\r\n      isSuperAdmin: p.is_super_admin || false,\r\n      hasSignature: !!p.signature_specimen_url,\r\n      isDeleted: !!p.deleted_at,\r\n      entities: entityMap.get(p.id) || [],\r\n      entityCount: (entityMap.get(p.id) || []).length,\r\n      kyc: p.email ? kycMap.get(p.email) || null : null\r\n    }))\r\n\r\n    // 5. Apply filters\r\n    if (search) {\r\n      const searchLower = search.toLowerCase()\r\n      userRows = userRows.filter(u =>\r\n        u.displayName.toLowerCase().includes(searchLower) ||\r\n        u.email.toLowerCase().includes(searchLower) ||\r\n        u.title?.toLowerCase().includes(searchLower)\r\n      )\r\n    }\r\n\r\n    // Multi-select role filter\r\n    if (roleFilters.length > 0) {\r\n      userRows = userRows.filter(u => roleFilters.includes(u.systemRole))\r\n    }\r\n\r\n    // Multi-select entity type filter\r\n    if (entityTypeFilters.length > 0) {\r\n      userRows = userRows.filter(u =>\r\n        u.entities.some(e => entityTypeFilters.includes(e.type))\r\n      )\r\n    }\r\n\r\n    // Status filter (derived from user data)\r\n    // Status: active, pending, inactive, deactivated\r\n    if (statusFilters.length > 0) {\r\n      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)\r\n      userRows = userRows.filter(u => {\r\n        let status: string\r\n        if (u.isDeleted) {\r\n          status = 'deactivated'\r\n        } else if (!u.lastLoginAt) {\r\n          status = 'pending'\r\n        } else if (new Date(u.lastLoginAt) > thirtyDaysAgo) {\r\n          status = 'active'\r\n        } else {\r\n          status = 'inactive'\r\n        }\r\n        return statusFilters.includes(status)\r\n      })\r\n    }\r\n\r\n    if (kycStatusFilter && kycStatusFilter !== 'all') {\r\n      userRows = userRows.filter(u => u.kyc?.status === kycStatusFilter)\r\n    }\r\n\r\n    if (hasEntitiesFilter !== null && hasEntitiesFilter !== undefined) {\r\n      const hasEntities = hasEntitiesFilter === 'true'\r\n      userRows = userRows.filter(u => hasEntities ? u.entityCount > 0 : u.entityCount === 0)\r\n    }\r\n\r\n    // 6. Calculate stats (before pagination)\r\n    const stats: UsersStats = {\r\n      total: userRows.length,\r\n      active: userRows.filter(u => u.lastLoginAt && new Date(u.lastLoginAt) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)).length,\r\n      staff: userRows.filter(u => u.systemRole.startsWith('staff_') || u.systemRole === 'ceo').length,\r\n      investors: userRows.filter(u => u.entities.some(e => e.type === 'investor')).length,\r\n      partners: userRows.filter(u => u.entities.some(e => e.type === 'partner')).length,\r\n      lawyers: userRows.filter(u => u.entities.some(e => e.type === 'lawyer')).length,\r\n      introducers: userRows.filter(u => u.entities.some(e => e.type === 'introducer')).length,\r\n      arrangers: userRows.filter(u => u.entities.some(e => e.type === 'arranger')).length,\r\n      pendingKyc: userRows.filter(u => u.kyc?.status === 'pending' || u.kyc?.status === 'submitted').length,\r\n      superAdmins: userRows.filter(u => u.isSuperAdmin).length\r\n    }\r\n\r\n    // 7. Apply sorting\r\n    userRows.sort((a, b) => {\r\n      let aVal: string | number, bVal: string | number\r\n\r\n      switch (sortBy) {\r\n        case 'displayName':\r\n          aVal = a.displayName.toLowerCase()\r\n          bVal = b.displayName.toLowerCase()\r\n          break\r\n        case 'email':\r\n          aVal = a.email.toLowerCase()\r\n          bVal = b.email.toLowerCase()\r\n          break\r\n        case 'systemRole':\r\n          aVal = a.systemRole\r\n          bVal = b.systemRole\r\n          break\r\n        case 'entityCount':\r\n          aVal = a.entityCount\r\n          bVal = b.entityCount\r\n          break\r\n        case 'lastLoginAt':\r\n          aVal = a.lastLoginAt ? new Date(a.lastLoginAt).getTime() : 0\r\n          bVal = b.lastLoginAt ? new Date(b.lastLoginAt).getTime() : 0\r\n          break\r\n        case 'createdAt':\r\n        default:\r\n          aVal = new Date(a.createdAt).getTime()\r\n          bVal = new Date(b.createdAt).getTime()\r\n      }\r\n\r\n      if (sortOrder === 'asc') {\r\n        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0\r\n      } else {\r\n        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0\r\n      }\r\n    })\r\n\r\n    // 8. Apply pagination\r\n    const totalCount = userRows.length\r\n    const totalPages = Math.ceil(totalCount / pageSize)\r\n    const offset = (page - 1) * pageSize\r\n    const paginatedUsers = userRows.slice(offset, offset + pageSize)\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: paginatedUsers,\r\n      stats,\r\n      pagination: {\r\n        page,\r\n        pageSize,\r\n        totalPages,\r\n        totalCount\r\n      }\r\n    })\r\n\r\n  } catch (error: unknown) {\r\n    console.error('[admin/users] Error:', error)\r\n    const errorMessage = error instanceof Error ? error.message : 'Failed to fetch users'\r\n    return NextResponse.json(\r\n      { success: false, error: errorMessage },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}