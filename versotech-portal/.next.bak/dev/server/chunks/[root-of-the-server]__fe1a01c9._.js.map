{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,MAAM,eAAe;IAC1B,MAAM,cAAc,MAAM,IAAA,mKAAO;IAEjC,OAAO,IAAA,wNAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;wBAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAC/B;gBACF,EAAE,OAAO,OAAO;gBACd,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ;AAIO,MAAM,sBAAsB;IACjC,OAAO,IAAA,gOAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB,EACrC;QACE,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AAEJ"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/document-auth.ts"],"sourcesContent":["import { createClient, createServiceClient } from '@/lib/supabase/server'\nimport { NextResponse } from 'next/server'\n\nexport interface AuthResult {\n  serviceSupabase: any\n  userId: string\n  error?: NextResponse\n}\n\nexport async function authenticateStaffForDocuments(): Promise<AuthResult> {\n  const supabase = await createClient()\n  const { data: { user }, error: authError } = await supabase.auth.getUser()\n  \n  if (authError || !user) {\n    return {\n      serviceSupabase: null,\n      userId: '',\n      error: NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n  }\n\n  const { data: profile } = await supabase\n    .from('profiles')\n    .select('role')\n    .eq('id', user.id)\n    .single()\n\n  if (!profile || !['staff_admin', 'staff_ops', 'staff_rm', 'ceo'].includes(profile.role)) {\n    return {\n      serviceSupabase: null,\n      userId: '',\n      error: NextResponse.json({ error: 'Staff access required' }, { status: 403 })\n    }\n  }\n  \n  return {\n    serviceSupabase: createServiceClient(),\n    userId: user.id\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAQO,eAAe;IACpB,MAAM,WAAW,MAAM,IAAA,yKAAY;IACnC,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAExE,IAAI,aAAa,CAAC,MAAM;QACtB,OAAO;YACL,iBAAiB;YACjB,QAAQ;YACR,OAAO,uKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;IACF;IAEA,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;IAET,IAAI,CAAC,WAAW,CAAC;QAAC;QAAe;QAAa;QAAY;KAAM,CAAC,QAAQ,CAAC,QAAQ,IAAI,GAAG;QACvF,OAAO;YACL,iBAAiB;YACjB,QAAQ;YACR,OAAO,uKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7E;IACF;IAEA,OAAO;QACL,iBAAiB,IAAA,gLAAmB;QACpC,QAAQ,KAAK,EAAE;IACjB;AACF"}},
    {"offset": {"line": 176, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/api/staff/documents/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { authenticateStaffForDocuments } from '@/lib/document-auth'\n\n// GET /api/staff/documents - List documents with advanced filtering\nexport async function GET(request: NextRequest) {\n  try {\n    // Authenticate\n    const auth = await authenticateStaffForDocuments()\n    if (auth.error) return auth.error\n    \n    const { serviceSupabase, userId } = auth\n\n    // Get query parameters\n    const searchParams = request.nextUrl.searchParams\n    const folderId = searchParams.get('folder_id')\n    const folderIds = searchParams.getAll('folder_ids') // For recursive folder search\n    const includeSubfolders = searchParams.get('include_subfolders') === 'true'\n    const vehicleId = searchParams.get('vehicle_id')\n    const status = searchParams.get('status')\n    const search = searchParams.get('search')\n    const type = searchParams.get('type')\n    const tags = searchParams.get('tags')?.split(',').filter(Boolean)\n    // Use higher limit when searching to ensure client-side filter has enough data\n    const defaultLimit = search ? '1000' : '200'\n    const limit = parseInt(searchParams.get('limit') || defaultLimit)\n    const offset = parseInt(searchParams.get('offset') || '0')\n    const sortBy = searchParams.get('sort_by') || 'created_at'\n    const sortOrder = searchParams.get('sort_order') || 'desc'\n\n    // Build query\n    let query = serviceSupabase\n      .from('documents')\n      .select(`\n        *,\n        folder:document_folders(id, name, path, folder_type),\n        vehicle:vehicles!documents_vehicle_id_fkey(id, name, type),\n        investor:investors!documents_owner_investor_id_fkey(id, legal_name),\n        deal:deals!documents_deal_id_fkey(id, name, status),\n        created_by_profile:profiles!documents_created_by_fkey(display_name, email),\n        current_approval:document_approvals(id, status, review_notes, reviewed_at, reviewed_by_profile:profiles!document_approvals_reviewed_by_fkey(display_name)),\n        publishing_schedule:document_publishing_schedule(id, publish_at, unpublish_at, published)\n      `, { count: 'exact' })\n\n    // Apply filters\n    if (folderIds && folderIds.length > 0 && includeSubfolders) {\n      // Include documents from all folders (parent and descendants)\n      query = query.in('folder_id', folderIds)\n    } else if (folderId) {\n      query = query.eq('folder_id', folderId)\n    }\n\n    if (vehicleId) {\n      query = query.eq('vehicle_id', vehicleId)\n    }\n\n    if (status) {\n      query = query.eq('status', status)\n    }\n\n    if (type) {\n      query = query.eq('type', type)\n    }\n\n    // Note: Search filtering is handled client-side to enable searching across\n    // joined tables (vehicle name, folder path, etc.) which is not easily\n    // supported by Supabase query builder. Server returns all matching folder\n    // documents and client filters by all fields.\n\n    if (tags && tags.length > 0) {\n      query = query.contains('tags', tags)\n    }\n\n    // Apply sorting\n    const ascending = sortOrder === 'asc'\n    query = query.order(sortBy, { ascending })\n\n    // Apply pagination\n    query = query.range(offset, offset + limit - 1)\n\n    const { data: documents, error: documentsError, count } = await query\n\n    if (documentsError) {\n      console.error('[API] Documents query error:', documentsError)\n      console.error('[API] Error details:', JSON.stringify(documentsError, null, 2))\n      return NextResponse.json(\n        { \n          error: 'Failed to fetch documents',\n          details: documentsError.message || 'Unknown database error',\n          code: documentsError.code,\n          hint: documentsError.hint\n        },\n        { status: 500 }\n      )\n    }\n\n    // Get statistics\n    const { data: stats } = await serviceSupabase\n      .from('documents')\n      .select('status')\n      .then((result: any) => {\n        const statusCounts: Record<string, number> = {\n          draft: 0,\n          pending_approval: 0,\n          approved: 0,\n          published: 0,\n          archived: 0\n        }\n\n        result.data?.forEach((doc: any) => {\n          const status = doc.status || 'draft'\n          statusCounts[status] = (statusCounts[status] || 0) + 1\n        })\n\n        return { data: statusCounts }\n      })\n\n    return NextResponse.json({\n      documents: documents || [],\n      pagination: {\n        total: count || 0,\n        limit,\n        offset,\n        has_more: (count || 0) > offset + limit,\n        current_page: Math.floor(offset / limit) + 1,\n        total_pages: Math.ceil((count || 0) / limit)\n      },\n      stats: stats || {},\n      filters_applied: {\n        folder_id: folderId,\n        vehicle_id: vehicleId,\n        status,\n        search,\n        type,\n        tags\n      }\n    })\n\n  } catch (error) {\n    console.error('Documents GET error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}