module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient,
    "createServiceClient",
    ()=>createServiceClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
;
const createClient = async ()=>{
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ3V4ZHNzZWNmZXh1ZG52dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4MzcsImV4cCI6MjA3MzkzNzgzN30.AGxM_YW9hfxuu7xDpi_4xhOoRhYM7iGTS1vJ0z2FByE"), {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>{
                        cookieStore.set(name, value, options);
                    });
                } catch (error) {
                // The `setAll` method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            }
        }
    });
};
const createServiceClient = ()=>{
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), process.env.SUPABASE_SERVICE_ROLE_KEY, {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    });
};
}),
"[project]/versotech-portal/src/app/api/staff/fees/projected/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET
]);
/**
 * Projected Fees API Route
 * GET /api/staff/fees/projected - Calculate projected annual fees from active subscriptions
 */ var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)");
;
;
async function GET(request) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        // Check auth
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        // Fetch ALL subscriptions with ALL fee fields
        const { data: subscriptions, error } = await supabase.from('subscriptions').select(`
        id,
        commitment,
        current_nav,
        status,
        vehicle_id,
        subscription_fee_percent,
        subscription_fee_amount,
        spread_fee_amount,
        bd_fee_percent,
        bd_fee_amount,
        finra_fee_amount,
        performance_fee_tier1_percent,
        performance_fee_tier1_threshold,
        performance_fee_tier2_percent,
        performance_fee_tier2_threshold,
        price_per_share,
        cost_per_share,
        num_shares,
        spread_per_share,
        management_fee_percent,
        management_fee_amount,
        management_fee_frequency,
        investor:investors(id, display_name)
      `);
        if (error) {
            console.error('Error fetching subscriptions:', error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to fetch subscriptions'
            }, {
                status: 500
            });
        }
        // Fetch active fee schedules with their components
        const { data: feeSchedules, error: schedError } = await supabase.from('fee_schedules').select(`
        id,
        investor_id,
        fee_component_id,
        start_date,
        end_date,
        status,
        fee_components(
          id,
          kind,
          rate_bps,
          flat_amount,
          frequency
        )
      `).eq('status', 'active');
        if (schedError) {
            console.error('Error fetching fee schedules:', schedError);
        }
        // Fetch vehicles
        const { data: vehicles } = await supabase.from('vehicles').select('id, name');
        const vehiclesMap = new Map(vehicles?.map((v)=>[
                v.id,
                v
            ]) || []);
        // Fee totals by type
        let totalSubscriptionFees = 0;
        let totalSpreadFees = 0;
        let totalBDFees = 0;
        let totalFINRAFees = 0;
        let totalPerformanceFees = 0;
        let totalManagementFees = 0;
        let totalAllFees = 0;
        let totalCommittedCapital = 0;
        let totalCurrentNAV = 0;
        const totalSubscriptions = subscriptions?.length || 0;
        let totalUnrealizedGains = 0;
        // Group by status
        const statusGroups = new Map();
        const vehicleGroups = new Map();
        // Process each subscription
        for (const sub of subscriptions || []){
            const commitment = sub.commitment || 0;
            const nav = sub.current_nav || 0;
            const status = sub.status || 'unknown';
            const vehicleId = sub.vehicle_id;
            // Calculate all fee types
            // 1. Subscription Fee (can be percent or fixed amount)
            let subscriptionFee = 0;
            if (sub.subscription_fee_amount) {
                subscriptionFee = sub.subscription_fee_amount;
            } else if (sub.subscription_fee_percent) {
                subscriptionFee = commitment * (sub.subscription_fee_percent / 100);
            }
            // 2. Spread Fee (fixed amount)
            const spreadFee = sub.spread_fee_amount || 0;
            // 3. BD Fee (can be percent or fixed amount)
            let bdFee = 0;
            if (sub.bd_fee_amount) {
                bdFee = sub.bd_fee_amount;
            } else if (sub.bd_fee_percent) {
                bdFee = commitment * (sub.bd_fee_percent / 100);
            }
            // 4. FINRA Fee (fixed amount)
            const finraFee = sub.finra_fee_amount || 0;
            // 5. Performance Fee (tiered based on returns)
            let performanceFee = 0;
            if (nav > 0 && commitment > 0) {
                const returns = nav - commitment;
                if (returns > 0) {
                    const tier1Threshold = sub.performance_fee_tier1_threshold || 0;
                    const tier2Threshold = sub.performance_fee_tier2_threshold || 0;
                    const tier1Percent = sub.performance_fee_tier1_percent || 0;
                    const tier2Percent = sub.performance_fee_tier2_percent || 0;
                    if (tier2Percent > 0 && returns > tier2Threshold) {
                        performanceFee = returns * (tier2Percent / 100);
                    } else if (tier1Percent > 0 && returns > tier1Threshold) {
                        performanceFee = returns * (tier1Percent / 100);
                    }
                }
            }
            // 6. Management Fee (can be percent or fixed amount, recurring)
            // Management fees are calculated on an annual basis here for projection
            let managementFee = 0;
            if (sub.management_fee_amount) {
                // Fixed management fee amount (annualized if needed based on frequency)
                const frequency = sub.management_fee_frequency || 'annual';
                if (frequency === 'monthly') {
                    managementFee = sub.management_fee_amount * 12;
                } else if (frequency === 'quarterly') {
                    managementFee = sub.management_fee_amount * 4;
                } else {
                    managementFee = sub.management_fee_amount; // annual
                }
            } else if (sub.management_fee_percent) {
                // Percentage-based management fee (on committed capital)
                managementFee = commitment * (sub.management_fee_percent / 100);
            }
            // 7. Unrealized Gains (price_per_share - cost_per_share) Ã— num_shares
            let unrealizedGain = 0;
            const pricePerShare = sub.price_per_share || 0;
            const costPerShare = sub.cost_per_share || 0;
            const numShares = sub.num_shares || 0;
            if (numShares > 0 && (pricePerShare > 0 || costPerShare > 0)) {
                unrealizedGain = (pricePerShare - costPerShare) * numShares;
            }
            const totalFees = subscriptionFee + spreadFee + bdFee + finraFee + performanceFee + managementFee;
            // Update grand totals
            totalSubscriptionFees += subscriptionFee;
            totalSpreadFees += spreadFee;
            totalBDFees += bdFee;
            totalFINRAFees += finraFee;
            totalPerformanceFees += performanceFee;
            totalManagementFees += managementFee;
            totalAllFees += totalFees;
            totalCommittedCapital += commitment;
            totalCurrentNAV += nav;
            totalUnrealizedGains += unrealizedGain;
            // Update status groups
            if (!statusGroups.has(status)) {
                statusGroups.set(status, {
                    subscription_fees: 0,
                    spread_fees: 0,
                    bd_fees: 0,
                    finra_fees: 0,
                    performance_fees: 0,
                    management_fees: 0,
                    total_fees: 0,
                    unrealized_gains: 0,
                    committed_capital: 0,
                    current_nav: 0,
                    subscription_count: 0
                });
            }
            const statusGroup = statusGroups.get(status);
            statusGroup.subscription_fees += subscriptionFee;
            statusGroup.spread_fees += spreadFee;
            statusGroup.bd_fees += bdFee;
            statusGroup.finra_fees += finraFee;
            statusGroup.performance_fees += performanceFee;
            statusGroup.management_fees += managementFee;
            statusGroup.total_fees += totalFees;
            statusGroup.unrealized_gains += unrealizedGain;
            statusGroup.committed_capital += commitment;
            statusGroup.current_nav += nav;
            statusGroup.subscription_count += 1;
            // Update vehicle groups
            const vehicle = vehiclesMap.get(vehicleId);
            const vehicleName = vehicle?.name || 'Unknown Vehicle';
            if (!vehicleGroups.has(vehicleId)) {
                vehicleGroups.set(vehicleId, {
                    vehicle_id: vehicleId,
                    vehicle_name: vehicleName,
                    fees: {
                        subscription_fees: 0,
                        spread_fees: 0,
                        bd_fees: 0,
                        finra_fees: 0,
                        performance_fees: 0,
                        management_fees: 0,
                        total_fees: 0,
                        unrealized_gains: 0
                    },
                    committed_capital: 0,
                    current_nav: 0,
                    subscription_count: 0,
                    by_status: new Map()
                });
            }
            const vehicleGroup = vehicleGroups.get(vehicleId);
            vehicleGroup.fees.subscription_fees += subscriptionFee;
            vehicleGroup.fees.spread_fees += spreadFee;
            vehicleGroup.fees.bd_fees += bdFee;
            vehicleGroup.fees.finra_fees += finraFee;
            vehicleGroup.fees.performance_fees += performanceFee;
            vehicleGroup.fees.management_fees += managementFee;
            vehicleGroup.fees.total_fees += totalFees;
            vehicleGroup.fees.unrealized_gains += unrealizedGain;
            vehicleGroup.committed_capital += commitment;
            vehicleGroup.current_nav += nav;
            vehicleGroup.subscription_count += 1;
            // Update status within vehicle
            if (!vehicleGroup.by_status.has(status)) {
                vehicleGroup.by_status.set(status, {
                    subscription_fees: 0,
                    spread_fees: 0,
                    bd_fees: 0,
                    finra_fees: 0,
                    performance_fees: 0,
                    management_fees: 0,
                    total_fees: 0,
                    unrealized_gains: 0,
                    committed_capital: 0,
                    current_nav: 0,
                    subscription_count: 0
                });
            }
            const vehicleStatus = vehicleGroup.by_status.get(status);
            vehicleStatus.subscription_fees += subscriptionFee;
            vehicleStatus.spread_fees += spreadFee;
            vehicleStatus.bd_fees += bdFee;
            vehicleStatus.finra_fees += finraFee;
            vehicleStatus.performance_fees += performanceFee;
            vehicleStatus.management_fees += managementFee;
            vehicleStatus.total_fees += totalFees;
            vehicleStatus.unrealized_gains += unrealizedGain;
            vehicleStatus.committed_capital += commitment;
            vehicleStatus.current_nav += nav;
            vehicleStatus.subscription_count += 1;
        }
        // Convert to arrays
        const byStatus = Array.from(statusGroups.entries()).map(([status, data])=>({
                status,
                ...data
            })).sort((a, b)=>b.total_fees - a.total_fees);
        const byVehicle = Array.from(vehicleGroups.values()).map((vehicle)=>({
                vehicle_id: vehicle.vehicle_id,
                vehicle_name: vehicle.vehicle_name,
                fees: vehicle.fees,
                committed_capital: vehicle.committed_capital,
                current_nav: vehicle.current_nav,
                subscription_count: vehicle.subscription_count,
                by_status: Array.from(vehicle.by_status.entries()).map(([status, data])=>({
                        status,
                        ...data
                    }))
            })).sort((a, b)=>b.fees.total_fees - a.fees.total_fees);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            data: {
                totals: {
                    subscription_fees: totalSubscriptionFees,
                    spread_fees: totalSpreadFees,
                    bd_fees: totalBDFees,
                    finra_fees: totalFINRAFees,
                    performance_fees: totalPerformanceFees,
                    management_fees: totalManagementFees,
                    total_fees: totalAllFees,
                    unrealized_gains: totalUnrealizedGains,
                    committed_capital: totalCommittedCapital,
                    current_nav: totalCurrentNAV,
                    total_subscriptions: totalSubscriptions
                },
                by_status: byStatus,
                by_vehicle: byVehicle
            }
        });
    } catch (error) {
        console.error('Unexpected error in GET /api/staff/fees/projected:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__c8b58912._.js.map