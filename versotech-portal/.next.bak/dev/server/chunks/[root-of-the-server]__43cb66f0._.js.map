{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,MAAM,eAAe;IAC1B,MAAM,cAAc,MAAM,IAAA,mKAAO;IAEjC,OAAO,IAAA,wNAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;wBAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAC/B;gBACF,EAAE,OAAO,OAAO;gBACd,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ;AAIO,MAAM,sBAAsB;IACjC,OAAO,IAAA,gOAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB,EACrC;QACE,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AAEJ"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/api-auth.ts"],"sourcesContent":["/**\r\n * Helper to get authenticated user from Supabase auth\r\n * Works with both createClient() and createServiceClient()\r\n */\r\nexport async function getAuthenticatedUser(supabase: any) {\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n\r\n  return {\r\n    user,\r\n    error: authError\r\n  }\r\n}\r\n\r\n/**\r\n * Get user role from database profile\r\n */\r\nexport async function getUserRole(supabase: any, user: any): Promise<string | null> {\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  return profile?.role || null\r\n}\r\n\r\n/**\r\n * Check if user has a specific permission OR is CEO (CEO bypasses all permission checks)\r\n *\r\n * This centralizes permission checking so that:\r\n * 1. CEO users automatically have ALL permissions without needing staff_permissions entries\r\n * 2. Regular staff users need explicit permissions in staff_permissions table\r\n *\r\n * @param supabase - Supabase client (can be regular or service client)\r\n * @param userId - The user's ID\r\n * @param requiredPermissions - Array of permissions (user needs ANY of these, not all)\r\n * @returns true if user has permission or is CEO\r\n */\r\nexport async function hasPermission(\r\n  supabase: any,\r\n  userId: string,\r\n  requiredPermissions: string[]\r\n): Promise<boolean> {\r\n  // First, check if user is CEO - CEO bypasses all permission checks\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', userId)\r\n    .single()\r\n\r\n  if (profile?.role === 'ceo') {\r\n    return true // CEO has all permissions\r\n  }\r\n\r\n  // Also check if user has CEO persona (for multi_persona users)\r\n  const { data: ceoUser } = await supabase\r\n    .from('ceo_users')\r\n    .select('user_id')\r\n    .eq('user_id', userId)\r\n    .maybeSingle()\r\n\r\n  if (ceoUser) {\r\n    return true // User is in ceo_users table, has all permissions\r\n  }\r\n\r\n  // For non-CEO users, check staff_permissions table\r\n  const { data: permission } = await supabase\r\n    .from('staff_permissions')\r\n    .select('permission')\r\n    .eq('user_id', userId)\r\n    .in('permission', requiredPermissions)\r\n    .limit(1)\r\n    .maybeSingle()\r\n\r\n  return !!permission\r\n}\r\n\r\n/**\r\n * Check if user has super_admin permission OR is CEO\r\n * Convenience function for the most common permission check\r\n */\r\nexport async function isSuperAdmin(supabase: any, userId: string): Promise<boolean> {\r\n  return hasPermission(supabase, userId, ['super_admin'])\r\n}\r\n\r\n/**\r\n * Check if user is staff using both profile role AND persona system\r\n *\r\n * Users can have staff access through:\r\n * 1. Legacy role field: 'staff_*' or 'ceo' in profiles.role\r\n * 2. Persona system: staff or ceo persona via get_user_personas RPC\r\n */\r\nexport async function isStaffUser(supabase: any, user: any): Promise<boolean> {\r\n  // First check legacy role field\r\n  const role = await getUserRole(supabase, user)\r\n  if (role && (role.startsWith('staff_') || role === 'ceo')) {\r\n    return true\r\n  }\r\n\r\n  // For multi_persona users, check personas via RPC\r\n  if (role === 'multi_persona') {\r\n    try {\r\n      const { data: personas } = await supabase.rpc('get_user_personas', {\r\n        p_user_id: user.id\r\n      })\r\n\r\n      if (personas && Array.isArray(personas)) {\r\n        return personas.some(\r\n          (p: any) => p.persona_type === 'staff' || p.persona_type === 'ceo'\r\n        )\r\n      }\r\n    } catch (err) {\r\n      console.error('[isStaffUser] Error checking personas:', err)\r\n    }\r\n  }\r\n\r\n  return false\r\n}\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;;;;;AACM,eAAe,qBAAqB,QAAa;IACtD,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAExE,OAAO;QACL;QACA,OAAO;IACT;AACF;AAKO,eAAe,YAAY,QAAa,EAAE,IAAS;IACxD,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;IAET,OAAO,SAAS,QAAQ;AAC1B;AAcO,eAAe,cACpB,QAAa,EACb,MAAc,EACd,mBAA6B;IAE7B,mEAAmE;IACnE,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,QACT,MAAM;IAET,IAAI,SAAS,SAAS,OAAO;QAC3B,OAAO,KAAK,0BAA0B;;IACxC;IAEA,+DAA+D;IAC/D,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,aACL,MAAM,CAAC,WACP,EAAE,CAAC,WAAW,QACd,WAAW;IAEd,IAAI,SAAS;QACX,OAAO,KAAK,kDAAkD;;IAChE;IAEA,mDAAmD;IACnD,MAAM,EAAE,MAAM,UAAU,EAAE,GAAG,MAAM,SAChC,IAAI,CAAC,qBACL,MAAM,CAAC,cACP,EAAE,CAAC,WAAW,QACd,EAAE,CAAC,cAAc,qBACjB,KAAK,CAAC,GACN,WAAW;IAEd,OAAO,CAAC,CAAC;AACX;AAMO,eAAe,aAAa,QAAa,EAAE,MAAc;IAC9D,OAAO,cAAc,UAAU,QAAQ;QAAC;KAAc;AACxD;AASO,eAAe,YAAY,QAAa,EAAE,IAAS;IACxD,gCAAgC;IAChC,MAAM,OAAO,MAAM,YAAY,UAAU;IACzC,IAAI,QAAQ,CAAC,KAAK,UAAU,CAAC,aAAa,SAAS,KAAK,GAAG;QACzD,OAAO;IACT;IAEA,kDAAkD;IAClD,IAAI,SAAS,iBAAiB;QAC5B,IAAI;YACF,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,qBAAqB;gBACjE,WAAW,KAAK,EAAE;YACpB;YAEA,IAAI,YAAY,MAAM,OAAO,CAAC,WAAW;gBACvC,OAAO,SAAS,IAAI,CAClB,CAAC,IAAW,EAAE,YAAY,KAAK,WAAW,EAAE,YAAY,KAAK;YAEjE;QACF,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,0CAA0C;QAC1D;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 201, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/api/staff/available/route.ts"],"sourcesContent":["import { createClient } from '@/lib/supabase/server'\nimport { NextRequest, NextResponse } from 'next/server'\nimport { getAuthenticatedUser } from '@/lib/api-auth'\n\n/**\n * Get list of available staff members that investors can message\n * API Route: /api/staff/available\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const supabase = await createClient()\n\n    // Authenticate user (supports Supabase auth and demo mode)\n    const { user, error: authError } = await getAuthenticatedUser(supabase)\n    if (authError || !user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    // Get all staff members (admin, ops, rm) - investors and staff can both see this list\n    const { data: staffMembers, error: staffError } = await supabase\n      .from('profiles')\n      .select('id, display_name, email, role')\n      .in('role', ['staff_admin', 'staff_ops', 'staff_rm', 'ceo'])\n      .order('display_name')\n\n    if (staffError) {\n      console.error('Error fetching staff members:', staffError)\n      return NextResponse.json({ error: 'Failed to fetch staff members' }, { status: 500 })\n    }\n\n    // For each staff member, check if there's an existing conversation\n    const normalizedStaff = (staffMembers || []).map((staff, index) => {\n      const baseDisplayName = staff.display_name?.trim()\n\n      if (baseDisplayName) {\n        return { ...staff, display_name: baseDisplayName }\n      }\n\n      const labelPrefix = staff.role === 'staff_admin' ? 'Admin' : 'Team Member'\n\n      const duplicates = (staffMembers || []).filter(\n        (member) => !member.display_name && member.role === staff.role\n      )\n\n      if (duplicates.length <= 1) {\n        return {\n          ...staff,\n          display_name: `${labelPrefix} ${index + 1}`\n        }\n      }\n\n      const position = duplicates.findIndex((member) => member.id === staff.id)\n\n      return {\n        ...staff,\n        display_name: `${labelPrefix} ${position + 1}`\n      }\n    })\n\n    const staffWithConversations = await Promise.all(\n      normalizedStaff.map(async (staff) => {\n        const normalizedName = staff.display_name\n\n        // Check for existing conversation\n        const { data: existingConv } = await supabase\n          .from('conversation_participants')\n          .select(`\n            conversation_id,\n            last_read_at,\n            conversations:conversation_id (\n              id,\n              last_message_at,\n              messages (\n                id,\n                sender_id,\n                created_at\n              )\n            )\n          `)\n          .eq('user_id', user.id)\n\n        let conversationId: string | null = null\n        let lastMessageAt: string | null = null\n        let unreadCount = 0\n\n        if (existingConv) {\n          for (const conv of existingConv) {\n            const { data: staffParticipant } = await supabase\n              .from('conversation_participants')\n              .select('user_id, last_read_at')\n              .eq('conversation_id', conv.conversation_id)\n              .eq('user_id', staff.id)\n              .single()\n\n            if (staffParticipant) {\n              conversationId = conv.conversation_id\n              lastMessageAt = (conv.conversations as any)?.[0]?.last_message_at || null\n\n              const lastReadAt = conv.last_read_at\n              if (lastReadAt && (conv.conversations as any)?.[0]?.messages) {\n                unreadCount = (conv.conversations as any)[0].messages.filter((message: any) => {\n                  return message.sender_id !== user.id && new Date(message.created_at) > new Date(lastReadAt)\n                }).length\n              }\n              break\n            }\n          }\n        }\n\n        return {\n          ...staff,\n          display_name: normalizedName,\n          conversationId,\n          lastMessageAt,\n          unreadCount\n        }\n      })\n    )\n\n    const rolePriority: Record<string, number> = {\n      staff_admin: 0,\n      staff_ops: 1,\n      staff_rm: 2\n    }\n\n    return NextResponse.json({\n      staff: staffWithConversations\n    })\n\n  } catch (error) {\n    console.error('Get available staff error:', error)\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n\n\n\n"],"names":[],"mappings":"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"}}]
}