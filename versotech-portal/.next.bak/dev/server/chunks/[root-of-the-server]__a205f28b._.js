module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient,
    "createServiceClient",
    ()=>createServiceClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
;
const createClient = async ()=>{
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ3V4ZHNzZWNmZXh1ZG52dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4MzcsImV4cCI6MjA3MzkzNzgzN30.AGxM_YW9hfxuu7xDpi_4xhOoRhYM7iGTS1vJ0z2FByE"), {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>{
                        cookieStore.set(name, value, options);
                    });
                } catch (error) {
                // The `setAll` method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            }
        }
    });
};
const createServiceClient = ()=>{
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), process.env.SUPABASE_SERVICE_ROLE_KEY, {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    });
};
}),
"[project]/versotech-portal/src/lib/audit.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "AuditActions",
    ()=>AuditActions,
    "AuditEntities",
    ()=>AuditEntities,
    "auditLogger",
    ()=>auditLogger
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)");
;
class AuditLogger {
    static instance;
    static getInstance() {
        if (!AuditLogger.instance) {
            AuditLogger.instance = new AuditLogger();
        }
        return AuditLogger.instance;
    }
    async log(entry) {
        try {
            const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
            // Insert into audit_logs with correct column names
            await supabase.from('audit_logs').insert({
                event_type: 'system',
                actor_id: entry.actor_user_id || null,
                action: entry.action,
                entity_type: entry.entity,
                entity_id: entry.entity_id || null,
                action_details: entry.metadata || null,
                timestamp: new Date().toISOString()
            });
        } catch (error) {
            console.error('Audit logging failed:', error);
        // Don't throw to avoid breaking the main operation
        }
    }
    async logMany(entries) {
        for (const entry of entries){
            await this.log(entry);
        }
    }
}
const auditLogger = AuditLogger.getInstance();
const AuditActions = {
    // Authentication
    LOGIN: 'login',
    LOGOUT: 'logout',
    PASSWORD_CHANGE: 'password_change',
    // Data operations
    CREATE: 'create',
    READ: 'read',
    UPDATE: 'update',
    DELETE: 'delete',
    // Documents
    DOCUMENT_UPLOAD: 'document_upload',
    DOCUMENT_DOWNLOAD: 'document_download',
    DOCUMENT_DELETE: 'document_delete',
    // Workflows
    WORKFLOW_TRIGGER: 'workflow_trigger',
    WORKFLOW_COMPLETED: 'workflow_completed',
    WORKFLOW_FAILED: 'workflow_failed',
    // System operations
    USER_CREATED: 'user_created',
    PROFILE_UPDATED: 'profile_updated',
    ROLE_CHANGED: 'role_changed',
    // Business operations
    SUBSCRIPTION_CREATED: 'subscription_created',
    CAPITAL_CALL_CREATED: 'capital_call_created',
    DISTRIBUTION_CREATED: 'distribution_created',
    REPORT_REQUESTED: 'report_requested',
    MESSAGE_SENT: 'message_sent',
    // Commission lifecycle (GAP-7)
    COMMISSION_CREATED: 'commission_created',
    COMMISSION_ACCRUED: 'commission_accrued',
    COMMISSION_INVOICE_REQUESTED: 'commission_invoice_requested',
    COMMISSION_INVOICED: 'commission_invoiced',
    COMMISSION_PAID: 'commission_paid',
    COMMISSION_CANCELLED: 'commission_cancelled',
    // Agreement events (GAP-8)
    AGREEMENT_CREATED: 'agreement_created',
    AGREEMENT_SENT: 'agreement_sent',
    AGREEMENT_APPROVED: 'agreement_approved',
    AGREEMENT_SIGNED: 'agreement_signed',
    AGREEMENT_ACTIVATED: 'agreement_activated',
    AGREEMENT_REJECTED: 'agreement_rejected',
    AGREEMENT_EXPIRED: 'agreement_expired'
};
const AuditEntities = {
    USERS: 'users',
    PROFILES: 'profiles',
    INVESTORS: 'investors',
    VEHICLES: 'vehicles',
    SUBSCRIPTIONS: 'subscriptions',
    POSITIONS: 'positions',
    DOCUMENTS: 'documents',
    WORKFLOWS: 'workflows',
    WORKFLOW_RUNS: 'workflow_runs',
    CONVERSATIONS: 'conversations',
    MESSAGES: 'messages',
    REQUEST_TICKETS: 'request_tickets',
    CAPITAL_CALLS: 'capital_calls',
    DISTRIBUTIONS: 'distributions',
    DEALS: 'deals',
    // RESERVATIONS: 'reservations', // Deprecated - removed from workflow
    ALLOCATIONS: 'allocations',
    FEE_EVENTS: 'fee_events',
    INVOICES: 'invoices',
    BANK_TRANSACTIONS: 'bank_transactions',
    PAYMENTS: 'payments',
    ARRANGER: 'arranger_entities',
    INTRODUCER: 'introducers',
    PARTNER: 'partners',
    COMMERCIAL_PARTNER: 'commercial_partners',
    FEE_PLANS: 'arranger_fee_plans',
    CEO_ENTITY: 'ceo_entity',
    CEO_USERS: 'ceo_users',
    // Commission entities (GAP-7)
    INTRODUCER_COMMISSIONS: 'introducer_commissions',
    PARTNER_COMMISSIONS: 'partner_commissions',
    COMMERCIAL_PARTNER_COMMISSIONS: 'commercial_partner_commissions',
    // Agreement entities (GAP-8)
    INTRODUCER_AGREEMENTS: 'introducer_agreements',
    PARTNER_AGREEMENTS: 'partner_agreements',
    COMMERCIAL_PARTNER_AGREEMENTS: 'commercial_partner_agreements',
    // Introductions
    INTRODUCTIONS: 'introductions'
};
}),
"[project]/versotech-portal/src/lib/api-auth.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

/**
 * Helper to get authenticated user from Supabase auth
 * Works with both createClient() and createServiceClient()
 */ __turbopack_context__.s([
    "getAuthenticatedUser",
    ()=>getAuthenticatedUser,
    "getUserRole",
    ()=>getUserRole,
    "hasPermission",
    ()=>hasPermission,
    "isStaffUser",
    ()=>isStaffUser,
    "isSuperAdmin",
    ()=>isSuperAdmin
]);
async function getAuthenticatedUser(supabase) {
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    return {
        user,
        error: authError
    };
}
async function getUserRole(supabase, user) {
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
    return profile?.role || null;
}
async function hasPermission(supabase, userId, requiredPermissions) {
    // First, check if user is CEO - CEO bypasses all permission checks
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', userId).single();
    if (profile?.role === 'ceo') {
        return true // CEO has all permissions
        ;
    }
    // Also check if user has CEO persona (for multi_persona users)
    const { data: ceoUser } = await supabase.from('ceo_users').select('user_id').eq('user_id', userId).maybeSingle();
    if (ceoUser) {
        return true // User is in ceo_users table, has all permissions
        ;
    }
    // For non-CEO users, check staff_permissions table
    const { data: permission } = await supabase.from('staff_permissions').select('permission').eq('user_id', userId).in('permission', requiredPermissions).limit(1).maybeSingle();
    return !!permission;
}
async function isSuperAdmin(supabase, userId) {
    return hasPermission(supabase, userId, [
        'super_admin'
    ]);
}
async function isStaffUser(supabase, user) {
    // First check legacy role field
    const role = await getUserRole(supabase, user);
    if (role && (role.startsWith('staff_') || role === 'ceo')) {
        return true;
    }
    // For multi_persona users, check personas via RPC
    if (role === 'multi_persona') {
        try {
            const { data: personas } = await supabase.rpc('get_user_personas', {
                p_user_id: user.id
            });
            if (personas && Array.isArray(personas)) {
                return personas.some((p)=>p.persona_type === 'staff' || p.persona_type === 'ceo');
            }
        } catch (err) {
            console.error('[isStaffUser] Error checking personas:', err);
        }
    }
    return false;
}
}),
"[project]/versotech-portal/src/lib/supabase/client.ts [app-route] (client reference proxy) <module evaluation>", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient,
    "hasActiveSession",
    ()=>hasActiveSession,
    "resetClient",
    ()=>resetClient
]);
// This file is generated by next-core EcmascriptClientReferenceModule.
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.js [app-route] (ecmascript)");
;
const createClient = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call createClient() from the server but createClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/versotech-portal/src/lib/supabase/client.ts <module evaluation>", "createClient");
const hasActiveSession = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call hasActiveSession() from the server but hasActiveSession is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/versotech-portal/src/lib/supabase/client.ts <module evaluation>", "hasActiveSession");
const resetClient = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call resetClient() from the server but resetClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/versotech-portal/src/lib/supabase/client.ts <module evaluation>", "resetClient");
}),
"[project]/versotech-portal/src/lib/supabase/client.ts [app-route] (client reference proxy)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient,
    "hasActiveSession",
    ()=>hasActiveSession,
    "resetClient",
    ()=>resetClient
]);
// This file is generated by next-core EcmascriptClientReferenceModule.
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.js [app-route] (ecmascript)");
;
const createClient = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call createClient() from the server but createClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/versotech-portal/src/lib/supabase/client.ts", "createClient");
const hasActiveSession = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call hasActiveSession() from the server but hasActiveSession is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/versotech-portal/src/lib/supabase/client.ts", "hasActiveSession");
const resetClient = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call resetClient() from the server but resetClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/versotech-portal/src/lib/supabase/client.ts", "resetClient");
}),
"[project]/versotech-portal/src/lib/supabase/client.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$client$2e$ts__$5b$app$2d$route$5d$__$28$client__reference__proxy$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/client.ts [app-route] (client reference proxy) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$client$2e$ts__$5b$app$2d$route$5d$__$28$client__reference__proxy$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/client.ts [app-route] (client reference proxy)");
;
__turbopack_context__.n(__TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$client$2e$ts__$5b$app$2d$route$5d$__$28$client__reference__proxy$29$__);
}),
"[project]/versotech-portal/src/lib/messaging/supabase.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "fetchConversationMessages",
    ()=>fetchConversationMessages,
    "fetchConversationsClient",
    ()=>fetchConversationsClient,
    "getClientSupabase",
    ()=>getClientSupabase,
    "markConversationRead",
    ()=>markConversationRead,
    "normalizeConversation",
    ()=>normalizeConversation,
    "normalizeMessage",
    ()=>normalizeMessage,
    "subscribeToConversationUpdates",
    ()=>subscribeToConversationUpdates
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/client.ts [app-route] (ecmascript)");
;
async function fetchConversationsClient(filters) {
    const params = new URLSearchParams();
    if (filters.visibility) params.set('visibility', filters.visibility);
    if (filters.type) params.set('type', filters.type);
    if (filters.unreadOnly) params.set('unread', 'true');
    if (filters.search) params.set('search', filters.search);
    if (filters.dealId) params.set('dealId', filters.dealId);
    if (typeof filters.limit === 'number') params.set('limit', String(filters.limit));
    if (typeof filters.offset === 'number') params.set('offset', String(filters.offset));
    if (filters.includeMessages === false) params.set('includeMessages', 'false');
    const response = await fetch(`/api/conversations?${params.toString()}`, {
        cache: 'no-store'
    });
    if (!response.ok) {
        const error = await response.json().catch(()=>null);
        throw new Error(error?.error || 'Failed to load conversations');
    }
    const data = await response.json();
    return {
        conversations: data.conversations,
        total: data.pagination.total,
        limit: data.pagination.limit,
        offset: data.pagination.offset,
        hasMore: data.pagination.has_more
    };
}
function normalizeConversation(raw) {
    const participants = Array.isArray(raw?.conversation_participants) ? raw.conversation_participants.map((participant)=>{
        const profile = participant?.profiles || {};
        return {
            id: profile.id || participant.user_id,
            displayName: profile.display_name || profile.email || null,
            email: profile.email || null,
            role: profile.role || null,
            avatarUrl: profile.avatar_url ?? null,
            participantRole: participant?.participant_role ?? 'member',
            joinedAt: participant?.joined_at,
            lastReadAt: participant?.last_read_at ?? null,
            lastNotifiedAt: participant?.last_notified_at ?? null,
            isMuted: participant?.is_muted ?? false,
            isPinned: participant?.is_pinned ?? false
        };
    }) : [];
    const latestMessageRaw = Array.isArray(raw?.messages) ? raw.messages[0] : null;
    const latestMessage = latestMessageRaw ? normalizeMessage(latestMessageRaw) : null;
    return {
        id: raw.id,
        subject: raw.subject ?? null,
        preview: raw.preview ?? null,
        type: raw.type ?? 'dm',
        visibility: raw.visibility ?? 'internal',
        ownerTeam: raw.owner_team ?? null,
        dealId: raw.deal_id ?? null,
        createdBy: raw.created_by ?? null,
        createdAt: raw.created_at,
        updatedAt: raw.updated_at,
        lastMessageAt: raw.last_message_at ?? null,
        lastMessageId: raw.last_message_id ?? null,
        archivedAt: raw.archived_at ?? null,
        metadata: raw.metadata ?? {},
        participants,
        unreadCount: raw.unreadCount ?? 0,
        latestMessage,
        participantCount: participants.length
    };
}
async function fetchConversationMessages(conversationId, options = {}) {
    const params = new URLSearchParams();
    if (typeof options.limit === 'number') params.set('limit', String(options.limit));
    if (typeof options.offset === 'number') params.set('offset', String(options.offset));
    const response = await fetch(`/api/conversations/${conversationId}/messages?${params.toString()}`);
    if (!response.ok) {
        const error = await response.json().catch(()=>null);
        throw new Error(error?.error || 'Failed to fetch messages');
    }
    const data = await response.json();
    return data.messages;
}
async function markConversationRead(conversationId) {
    await fetch(`/api/conversations/${conversationId}/read`, {
        method: 'POST'
    });
}
function getClientSupabase() {
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
}
function subscribeToConversationUpdates(conversationId, callbacks) {
    const supabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$client$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
    const channel = supabase.channel(`conversation-${conversationId}`).on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'messages',
        filter: `conversation_id=eq.${conversationId}`
    }, (payload)=>{
        if (payload.eventType === 'INSERT') {
            callbacks.onMessage?.(normalizeMessage(payload.new));
        }
        callbacks.onUpdate?.();
    }).on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'conversation_participants',
        filter: `conversation_id=eq.${conversationId}`
    }, (payload)=>{
        callbacks.onUpdate?.();
    }).subscribe();
    return ()=>{
        supabase.removeChannel(channel);
    };
}
function normalizeMessage(raw) {
    // Handle both API responses (with joined sender) and realtime events (without joins)
    const sender = raw.sender;
    return {
        id: raw.id,
        conversationId: raw.conversation_id,
        senderId: raw.sender_id,
        body: raw.body ?? null,
        messageType: raw.message_type ?? 'text',
        fileKey: raw.file_key ?? null,
        replyToMessageId: raw.reply_to_message_id ?? null,
        metadata: raw.metadata ?? {},
        createdAt: raw.created_at,
        editedAt: raw.edited_at ?? null,
        deletedAt: raw.deleted_at ?? null,
        // Sender might not be available in realtime payloads, that's ok
        sender: sender ? {
            id: sender.id ?? null,
            displayName: sender.displayName ?? sender.display_name ?? null,
            email: sender.email ?? null,
            role: sender.role ?? null,
            avatarUrl: sender.avatarUrl ?? sender.avatar_url ?? null
        } : null,
        readBy: Array.isArray(raw.read_by) ? raw.read_by : []
    };
}
}),
"[project]/versotech-portal/src/lib/messaging/selectors.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "applyConversationFilters",
    ()=>applyConversationFilters,
    "sortConversations",
    ()=>sortConversations
]);
function applyConversationFilters(conversations, filters) {
    return conversations.filter((conversation)=>{
        if (filters.type !== 'all' && conversation.type !== filters.type) return false;
        if (filters.visibility !== 'all' && conversation.visibility !== filters.visibility) return false;
        if (filters.dealId && conversation.dealId !== filters.dealId) return false;
        if (filters.unreadOnly && (!conversation.unreadCount || conversation.unreadCount === 0)) return false;
        if (filters.search) {
            const query = filters.search.toLowerCase();
            const haystack = [];
            if (conversation.subject) haystack.push(conversation.subject);
            if (conversation.preview) haystack.push(conversation.preview);
            if (conversation.ownerTeam) haystack.push(conversation.ownerTeam);
            conversation.participants.forEach((participant)=>{
                if (participant.displayName) haystack.push(participant.displayName);
                if (participant.email) haystack.push(participant.email);
            });
            const matches = haystack.some((entry)=>entry.toLowerCase().includes(query));
            if (!matches) return false;
        }
        return true;
    });
}
function sortConversations(conversations) {
    return [
        ...conversations
    ].sort((a, b)=>{
        const aTime = a.lastMessageAt ? new Date(a.lastMessageAt).getTime() : new Date(a.createdAt).getTime();
        const bTime = b.lastMessageAt ? new Date(b.lastMessageAt).getTime() : new Date(b.createdAt).getTime();
        return bTime - aTime;
    });
}
}),
"[project]/versotech-portal/src/lib/messaging/utils.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "formatFullTimestamp",
    ()=>formatFullTimestamp,
    "formatRelativeTime",
    ()=>formatRelativeTime,
    "getDateDivider",
    ()=>getDateDivider,
    "getInitials",
    ()=>getInitials,
    "groupMessages",
    ()=>groupMessages,
    "shouldShowDateDivider",
    ()=>shouldShowDateDivider,
    "truncateText",
    ()=>truncateText
]);
function formatRelativeTime(timestamp) {
    const now = new Date();
    const messageTime = new Date(timestamp);
    const diffInSeconds = Math.floor((now.getTime() - messageTime.getTime()) / 1000);
    // Less than a minute
    if (diffInSeconds < 60) {
        return 'Just now';
    }
    // Less than an hour
    if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes}m ago`;
    }
    // Less than 24 hours
    if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours}h ago`;
    }
    // Yesterday
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    if (messageTime.toDateString() === yesterday.toDateString()) {
        return `Yesterday at ${messageTime.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        })}`;
    }
    // Less than a week
    if (diffInSeconds < 604800) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days}d ago`;
    }
    // Older - show full date
    return messageTime.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: messageTime.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
    });
}
function formatFullTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });
}
function groupMessages(messages, groupWindowMinutes = 5) {
    if (messages.length === 0) return [];
    const grouped = [];
    for(let i = 0; i < messages.length; i++){
        const current = messages[i];
        const prev = i > 0 ? messages[i - 1] : null;
        const next = i < messages.length - 1 ? messages[i + 1] : null;
        // Check if this message should be grouped with the previous one
        const shouldGroupWithPrev = prev && prev.senderId === current.senderId && !prev.deletedAt && !current.deletedAt && new Date(current.createdAt).getTime() - new Date(prev.createdAt).getTime() < groupWindowMinutes * 60 * 1000;
        // Check if this message should be grouped with the next one
        const shouldGroupWithNext = next && next.senderId === current.senderId && !next.deletedAt && !current.deletedAt && new Date(next.createdAt).getTime() - new Date(current.createdAt).getTime() < groupWindowMinutes * 60 * 1000;
        grouped.push({
            ...current,
            isGroupStart: !shouldGroupWithPrev,
            isGroupEnd: !shouldGroupWithNext,
            showAvatar: !shouldGroupWithPrev,
            showTimestamp: !shouldGroupWithNext
        });
    }
    return grouped;
}
function getInitials(name) {
    if (!name) return '?';
    const parts = name.trim().split(' ');
    if (parts.length >= 2) {
        return `${parts[0][0]}${parts[1][0]}`.toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
}
function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength).trim() + 'â€¦';
}
function getDateDivider(timestamp) {
    const messageDate = new Date(timestamp);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    // Reset time to midnight for comparison
    const messageDateOnly = new Date(messageDate.getFullYear(), messageDate.getMonth(), messageDate.getDate());
    const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const yesterdayOnly = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());
    if (messageDateOnly.getTime() === todayOnly.getTime()) {
        return 'Today';
    }
    if (messageDateOnly.getTime() === yesterdayOnly.getTime()) {
        return 'Yesterday';
    }
    // Within this week
    const diffDays = Math.floor((todayOnly.getTime() - messageDateOnly.getTime()) / (1000 * 60 * 60 * 24));
    if (diffDays < 7) {
        return messageDate.toLocaleDateString('en-US', {
            weekday: 'long'
        });
    }
    // Older
    return messageDate.toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: messageDate.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
    });
}
function shouldShowDateDivider(currentMessage, previousMessage) {
    if (!previousMessage) return true;
    const currentDate = new Date(currentMessage.createdAt);
    const previousDate = new Date(previousMessage.createdAt);
    // Different day
    return currentDate.toDateString() !== previousDate.toDateString();
}
}),
"[project]/versotech-portal/src/lib/messaging/index.ts [app-route] (ecmascript) <locals>", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$messaging$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/messaging/supabase.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$messaging$2f$selectors$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/messaging/selectors.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$messaging$2f$utils$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/messaging/utils.ts [app-route] (ecmascript)");
;
;
;
}),
"[project]/versotech-portal/src/app/api/conversations/[id]/messages/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET,
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$audit$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/audit.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$api$2d$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/api-auth.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$messaging$2f$index$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/messaging/index.ts [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$messaging$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/messaging/supabase.ts [app-route] (ecmascript)");
;
;
;
;
;
async function GET(request, { params }) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        const { user, error: authError } = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$api$2d$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getAuthenticatedUser"])(supabase);
        if (authError || !user) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const userId = user.id;
        const { id: conversationId } = await params;
        const { searchParams } = new URL(request.url);
        const limit = Math.min(Math.max(parseInt(searchParams.get('limit') || '50', 10) || 50, 1), 200);
        const offset = Math.max(parseInt(searchParams.get('offset') || '0', 10) || 0, 0);
        const { data: messages, error } = await supabase.from('messages').select(`
        *,
        sender:sender_id (
          id,
          display_name,
          email,
          role,
          avatar_url
        )
      `).eq('conversation_id', conversationId).order('created_at', {
            ascending: true
        }).range(offset, offset + limit - 1);
        if (error) {
            console.error('Error fetching messages:', error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to fetch messages'
            }, {
                status: 500
            });
        }
        const normalized = (messages || []).map(__TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$messaging$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["normalizeMessage"]);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            messages: normalized,
            has_more: (messages?.length || 0) === limit
        });
    } catch (error) {
        console.error('Messages API error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
async function POST(request, { params }) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        const { user, error: authError } = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$api$2d$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getAuthenticatedUser"])(supabase);
        if (authError || !user) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const userId = user.id;
        const { id: conversationId } = await params;
        const { body, file_key, reply_to_message_id, metadata } = await request.json();
        if (!body && !file_key) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Message body or file is required'
            }, {
                status: 400
            });
        }
        // Verify conversation exists (access control handled by RLS)
        const serviceClient = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceClient"])();
        const { data: conversation, error: convError } = await serviceClient.from('conversations').select('id').eq('id', conversationId).single();
        if (convError || !conversation) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Conversation not found'
            }, {
                status: 404
            });
        }
        // Create message (RLS will enforce access control)
        const { data: message, error: msgError } = await supabase.from('messages').insert({
            conversation_id: conversationId,
            sender_id: userId,
            body,
            file_key,
            reply_to_message_id,
            metadata: metadata ?? {}
        }).select(`
        *,
        sender:sender_id (
          id,
          display_name,
          email,
          role,
          avatar_url
        )
      `).single();
        if (msgError) {
            console.error('Error creating message:', msgError);
            // Check if it's an RLS policy violation
            if (msgError.code === '42501' || msgError.message?.includes('policy')) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'Access denied - you do not have permission to send messages in this conversation'
                }, {
                    status: 403
                });
            }
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to send message'
            }, {
                status: 500
            });
        }
        const normalizedMessage = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$messaging$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["normalizeMessage"])(message);
        // Log message for audit
        await __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$audit$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["auditLogger"].log({
            actor_user_id: userId,
            action: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$audit$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["AuditActions"].MESSAGE_SENT,
            entity: __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$audit$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["AuditEntities"].MESSAGES,
            entity_id: message.id,
            metadata: {
                conversation_id: conversationId,
                has_body: !!body,
                has_attachment: !!file_key,
                reply_to_message_id: reply_to_message_id || null,
                message_length: body?.length || 0
            }
        });
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            message: normalizedMessage
        });
    } catch (error) {
        console.error('Send message error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__a205f28b._.js.map