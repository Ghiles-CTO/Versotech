{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,MAAM,eAAe;IAC1B,MAAM,cAAc,MAAM,IAAA,mKAAO;IAEjC,OAAO,IAAA,wNAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;wBAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAC/B;gBACF,EAAE,OAAO,OAAO;gBACd,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ;AAIO,MAAM,sBAAsB;IACjC,OAAO,IAAA,gOAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB,EACrC;QACE,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AAEJ"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/api/investors/me/opportunities/%5Bid%5D/route.ts"],"sourcesContent":["import { createClient, createServiceClient } from '@/lib/supabase/server'\r\nimport { NextResponse } from 'next/server'\r\ninterface RouteParams {\r\n  params: Promise<{ id: string }>\r\n}\r\n\r\n/**\r\n * GET /api/investors/me/opportunities/:id\r\n * Fetch a single opportunity with full details, journey stages, and data room access\r\n *\r\n * For MODE 2 (commercial_partner_proxy): Pass ?client_investor_id=xxx to view client's dataroom\r\n */\r\nexport async function GET(request: Request, { params }: RouteParams) {\r\n  console.log('ðŸ”´ [opportunities/[id]] GET handler called')\r\n  const { id: dealId } = await params\r\n  console.log('ðŸ”´ [opportunities/[id]] dealId:', dealId)\r\n  const supabase = await createClient()\r\n  const serviceSupabase = createServiceClient()\r\n\r\n  // Get client_investor_id from query params for MODE 2 proxy access\r\n  const url = new URL(request.url)\r\n  const clientInvestorId = url.searchParams.get('client_investor_id')\r\n\r\n  try {\r\n    const { data: { user }, error: userError } = await supabase.auth.getUser()\r\n    if (userError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n    }\r\n\r\n    // Get user's membership for this deal first (security check)\r\n    // This works for ALL personas: investors, partners, introducers, CPs, lawyers, arrangers\r\n    const { data: membership } = await serviceSupabase\r\n      .from('deal_memberships')\r\n      .select('*')\r\n      .eq('deal_id', dealId)\r\n      .eq('user_id', user.id)\r\n      .maybeSingle()\r\n\r\n    // Get investor ID for this user (optional - only investors have this)\r\n    const { data: investorLinks } = await serviceSupabase\r\n      .from('investor_users')\r\n      .select('investor_id')\r\n      .eq('user_id', user.id)\r\n\r\n    const investorId = investorLinks?.[0]?.investor_id || null\r\n\r\n    // MODE 2: For commercial_partner_proxy role, allow viewing client's dataroom\r\n    let effectiveInvestorId = membership?.investor_id || investorId\r\n    let isProxyMode = false\r\n    let proxyClientName: string | null = null\r\n\r\n    if (clientInvestorId && membership?.role === 'commercial_partner_proxy') {\r\n      // Validate that this user's CP has access to the client\r\n      const { data: cpLink } = await serviceSupabase\r\n        .from('commercial_partner_users')\r\n        .select('commercial_partner_id')\r\n        .eq('user_id', user.id)\r\n        .maybeSingle()\r\n\r\n      if (cpLink) {\r\n        // Check if client is linked to this CP\r\n        const { data: clientLink } = await serviceSupabase\r\n          .from('commercial_partner_clients')\r\n          .select('id, client_name, client_investor_id')\r\n          .eq('commercial_partner_id', cpLink.commercial_partner_id)\r\n          .eq('client_investor_id', clientInvestorId)\r\n          .eq('is_active', true)\r\n          .maybeSingle()\r\n\r\n        if (clientLink) {\r\n          // Valid client - use their investor_id for dataroom access\r\n          effectiveInvestorId = clientInvestorId\r\n          isProxyMode = true\r\n          proxyClientName = clientLink.client_name\r\n          console.log('ðŸ”µ [opportunities/[id]] MODE 2: Viewing as proxy for client:', proxyClientName)\r\n        } else {\r\n          return NextResponse.json({ error: 'Client not authorized for this commercial partner' }, { status: 403 })\r\n        }\r\n      }\r\n    }\r\n\r\n    // Check if investor has access to this deal (must be a member or deal is public)\r\n    const { data: deal, error: dealError } = await serviceSupabase\r\n      .from('deals')\r\n      .select('*')\r\n      .eq('id', dealId)\r\n      .single()\r\n\r\n    if (dealError || !deal) {\r\n      console.error('[GET opportunity] Deal query failed:', { dealId, dealError, deal })\r\n      return NextResponse.json({ error: 'Deal not found' }, { status: 404 })\r\n    }\r\n\r\n    // DEBUG: Log what deal was fetched to verify correct data\r\n    console.log('ðŸ”µ [opportunities/[id]] Deal fetched:', {\r\n      requestedId: dealId,\r\n      returnedId: deal.id,\r\n      returnedName: deal.name,\r\n      match: dealId === deal.id\r\n    })\r\n\r\n    // Fetch vehicle separately if it exists\r\n    let vehicle = null\r\n    if (deal.vehicle_id) {\r\n      const { data: v } = await serviceSupabase\r\n        .from('vehicles')\r\n        .select('id, name, type, formation_date, currency')\r\n        .eq('id', deal.vehicle_id)\r\n        .single()\r\n      vehicle = v\r\n    }\r\n\r\n    const isDealOpen = deal.status === 'open' || deal.status === 'allocation_pending'\r\n\r\n    // Security: Only allow access if membership exists or deal is explicitly public\r\n    if (!membership && !isDealOpen) {\r\n      return NextResponse.json({ error: 'You do not have access to this opportunity' }, { status: 403 })\r\n    }\r\n\r\n    // Get data room access (use maybeSingle as record might not exist)\r\n    const { data: dataRoomAccess } = await serviceSupabase\r\n      .from('deal_data_room_access')\r\n      .select('*')\r\n      .eq('deal_id', dealId)\r\n      .eq('investor_id', effectiveInvestorId)\r\n      .is('revoked_at', null)\r\n      .order('granted_at', { ascending: false })\r\n      .limit(1)\r\n      .maybeSingle()\r\n\r\n    // Get subscription if exists (use maybeSingle as subscription might not exist)\r\n    const vehicleId = deal.vehicle_id\r\n    let subscription = null\r\n    let subscriptionSubmission: { id: string; status: string; submitted_at: string | null } | null = null\r\n    let subscriptionDocuments: {\r\n      nda: {\r\n        status: string\r\n        signatories: Array<{\r\n          name: string\r\n          email: string\r\n          status: string\r\n          signed_at: string | null\r\n        }>\r\n        unsigned_url: string | null\r\n        signed_url: string | null\r\n      }\r\n      subscription_pack: {\r\n        status: string\r\n        signatories: Array<{\r\n          name: string\r\n          email: string\r\n          status: string\r\n          signed_at: string | null\r\n        }>\r\n        unsigned_url: string | null\r\n        signed_url: string | null\r\n      }\r\n      certificate: {\r\n        status: string\r\n        url: string | null\r\n      } | null\r\n    } | null = null\r\n\r\n    // Query subscription by deal_id (NOT vehicle_id) to ensure deal-specific data\r\n    // Multiple deals can share the same vehicle_id, so using vehicle_id would\r\n    // return subscriptions from wrong deals (e.g., both Anthropic deals share a vehicle)\r\n    if (dealId) {\r\n      const { data: sub } = await serviceSupabase\r\n        .from('subscriptions')\r\n        .select(`\r\n          id,\r\n          status,\r\n          commitment,\r\n          currency,\r\n          funded_amount,\r\n          pack_generated_at,\r\n          pack_sent_at,\r\n          signed_at,\r\n          funded_at,\r\n          activated_at,\r\n          created_at\r\n        `)\r\n        .eq('deal_id', dealId)\r\n        .eq('investor_id', effectiveInvestorId)\r\n        .order('created_at', { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle()\r\n\r\n      subscription = sub\r\n\r\n      // Fetch signature documents for this subscription\r\n      if (sub) {\r\n        // Get NDA signature requests for this deal/investor\r\n        const { data: ndaSignatures } = await serviceSupabase\r\n          .from('signature_requests')\r\n          .select('id, signer_name, signer_email, status, signature_timestamp, unsigned_pdf_path, signed_pdf_path')\r\n          .eq('deal_id', dealId)\r\n          .eq('investor_id', effectiveInvestorId)\r\n          .eq('document_type', 'nda')\r\n          .order('created_at', { ascending: true })\r\n\r\n        // Get subscription pack signature requests\r\n        const { data: subPackSignatures } = await serviceSupabase\r\n          .from('signature_requests')\r\n          .select('id, signer_name, signer_email, status, signature_timestamp, unsigned_pdf_path, signed_pdf_path')\r\n          .eq('subscription_id', sub.id)\r\n          .eq('document_type', 'subscription')\r\n          .order('created_at', { ascending: true })\r\n\r\n        // Calculate NDA status\r\n        const ndaSigs = ndaSignatures || []\r\n        const ndaAllSigned = ndaSigs.length > 0 && ndaSigs.every(s => s.status === 'signed')\r\n        const ndaSomeSigned = ndaSigs.some(s => s.status === 'signed')\r\n        const ndaStatus = ndaAllSigned ? 'complete' : ndaSomeSigned ? 'partial' : ndaSigs.length > 0 ? 'pending' : 'not_started'\r\n\r\n        // Calculate subscription pack status\r\n        const subSigs = subPackSignatures || []\r\n        const subAllSigned = subSigs.length > 0 && subSigs.every(s => s.status === 'signed')\r\n        const subSomeSigned = subSigs.some(s => s.status === 'signed')\r\n        const subStatus = subAllSigned ? 'complete' : subSomeSigned ? 'partial' : subSigs.length > 0 ? 'pending' : 'not_started'\r\n\r\n        // Get the first available PDF paths (they're the same for all signatories of same doc type)\r\n        const ndaUnsignedPath = ndaSigs.find(s => s.unsigned_pdf_path)?.unsigned_pdf_path || null\r\n        const ndaSignedPath = ndaAllSigned ? ndaSigs.find(s => s.signed_pdf_path)?.signed_pdf_path : null\r\n        const subUnsignedPath = subSigs.find(s => s.unsigned_pdf_path)?.unsigned_pdf_path || null\r\n        const subSignedPath = subAllSigned ? subSigs.find(s => s.signed_pdf_path)?.signed_pdf_path : null\r\n\r\n        subscriptionDocuments = {\r\n          nda: {\r\n            status: ndaStatus,\r\n            signatories: ndaSigs.map(s => ({\r\n              name: s.signer_name,\r\n              email: s.signer_email,\r\n              status: s.status,\r\n              signed_at: s.signature_timestamp\r\n            })),\r\n            unsigned_url: ndaUnsignedPath,\r\n            signed_url: ndaSignedPath\r\n          },\r\n          subscription_pack: {\r\n            status: subStatus,\r\n            signatories: subSigs.map(s => ({\r\n              name: s.signer_name,\r\n              email: s.signer_email,\r\n              status: s.status,\r\n              signed_at: s.signature_timestamp\r\n            })),\r\n            unsigned_url: subUnsignedPath,\r\n            signed_url: subSignedPath\r\n          },\r\n          // Certificate - lookup from documents table if subscription is activated\r\n          certificate: await (async () => {\r\n            if (!sub.activated_at) return null\r\n\r\n            // Check for actual certificate document\r\n            const { data: certDoc } = await serviceSupabase\r\n              .from('documents')\r\n              .select('id, file_key')\r\n              .eq('subscription_id', sub.id)\r\n              .eq('type', 'certificate')\r\n              .maybeSingle()\r\n\r\n            if (certDoc) {\r\n              return {\r\n                status: 'available',\r\n                document_id: certDoc.id,\r\n                url: certDoc.file_key\r\n              }\r\n            }\r\n\r\n            // Certificate not yet generated\r\n            return {\r\n              status: 'generating',\r\n              document_id: null,\r\n              url: null\r\n            }\r\n          })()\r\n        }\r\n      }\r\n    }\r\n\r\n    if (effectiveInvestorId) {\r\n      const { data: submission } = await serviceSupabase\r\n        .from('deal_subscription_submissions')\r\n        .select('id, status, submitted_at')\r\n        .eq('deal_id', dealId)\r\n        .eq('investor_id', effectiveInvestorId)\r\n        .order('submitted_at', { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle()\r\n\r\n      subscriptionSubmission = submission ?? null\r\n    }\r\n\r\n    // Get journey stages using RPC function\r\n    const { data: journeyStages } = await serviceSupabase\r\n      .rpc('get_investor_journey_stage', {\r\n        p_deal_id: dealId,\r\n        p_investor_id: effectiveInvestorId\r\n      })\r\n\r\n    // Get fee structures for the deal\r\n    // PERSONA ACCESS RULES (per Fred's meeting requirements):\r\n    // - Introducers: CANNOT see term sheet (fee structures)\r\n    // - Lawyers: CANNOT see term sheet (fee structures)\r\n    // - All others (investors, partners, arrangers, CPs): CAN see term sheet\r\n    const isRestrictedFromTermSheet = membership?.role === 'introducer' || membership?.role === 'lawyer'\r\n\r\n    let feeStructures: any[] = []\r\n    if (!isRestrictedFromTermSheet) {\r\n      // Check if investor has an assigned term sheet (from dispatch)\r\n      if (membership?.term_sheet_id) {\r\n        // Fetch ONLY the assigned term sheet - this ensures different investor classes\r\n        // see their specific fee structure based on how they were dispatched\r\n        const { data: assignedTermSheet } = await serviceSupabase\r\n          .from('deal_fee_structures')\r\n          .select('*')\r\n          .eq('id', membership.term_sheet_id)\r\n          .single()\r\n\r\n        if (assignedTermSheet) {\r\n          feeStructures = [assignedTermSheet]\r\n        }\r\n      }\r\n\r\n      // Fallback: If no assigned term sheet or it wasn't found, get first published\r\n      // This handles backward compatibility for existing memberships\r\n      if (feeStructures.length === 0) {\r\n        const { data: fallbackTermSheet } = await serviceSupabase\r\n          .from('deal_fee_structures')\r\n          .select('*')\r\n          .eq('deal_id', dealId)\r\n          .eq('status', 'published')\r\n          .order('created_at', { ascending: true })\r\n          .limit(1)\r\n\r\n        feeStructures = fallbackTermSheet || []\r\n      }\r\n    }\r\n\r\n    // Get FAQs for the deal\r\n    const { data: faqs } = await serviceSupabase\r\n      .from('deal_faqs')\r\n      .select('*')\r\n      .eq('deal_id', dealId)\r\n      .order('display_order', { ascending: true })\r\n\r\n    // Get all authorized signatories for the investor entity\r\n    const { data: allSignatories } = await serviceSupabase\r\n      .from('investor_members')\r\n      .select('id')\r\n      .eq('investor_id', effectiveInvestorId)\r\n      .eq('role', 'authorized_signatory')\r\n      .eq('is_active', true)\r\n\r\n    // Check if ALL signatories have signed NDA for this deal (entity-level check)\r\n    // Per Fred's requirement: ALL signatories must sign before ANY entity user gets data room access\r\n    let allSignatoriesSignedNda = true\r\n    if (allSignatories && allSignatories.length > 0) {\r\n      const { data: ndaSignatures } = await serviceSupabase\r\n        .from('signature_requests')\r\n        .select('member_id')\r\n        .eq('deal_id', dealId)\r\n        .eq('investor_id', effectiveInvestorId)\r\n        .eq('document_type', 'nda')\r\n        .not('signature_timestamp', 'is', null)\r\n\r\n      const signedMemberIds = new Set((ndaSignatures || []).map(sig => sig.member_id))\r\n      allSignatoriesSignedNda = allSignatories.every(sig => signedMemberIds.has(sig.id))\r\n    }\r\n\r\n    // Get data room documents if investor has access\r\n    // PERSONA ACCESS RULES (per Fred's meeting requirements):\r\n    // - Introducers: NEVER get data room access\r\n    // - Lawyers: NEVER get data room access\r\n    // - Arrangers: AUTOMATIC access (no NDA required)\r\n    // - All others (investors, partners, CPs): Access after NDA signed\r\n    const isRestrictedFromDataRoom = membership?.role === 'introducer' || membership?.role === 'lawyer'\r\n    const isArrangerWithAutoAccess = membership?.role === 'arranger'\r\n\r\n    let dataRoomDocuments: any[] = []\r\n    let hasDataRoomAccess = false\r\n\r\n    if (isRestrictedFromDataRoom) {\r\n      // Introducers and lawyers NEVER get data room access\r\n      hasDataRoomAccess = false\r\n    } else if (isArrangerWithAutoAccess) {\r\n      // Arrangers get AUTOMATIC access - no NDA required (per Fred: \"doesn't need to sign an NDA so it's automatic\")\r\n      hasDataRoomAccess = true\r\n    } else {\r\n      // Check if access was already legitimately granted (grandfathering)\r\n      // This handles the case where new signatories are added AFTER NDA was signed\r\n      // - Expiry check is preserved (7-day access period still enforced)\r\n      // - Revocation check is preserved\r\n      // - New investors still need ALL signatories to sign before first access\r\n      const accessRecordValid = dataRoomAccess &&\r\n        !dataRoomAccess.revoked_at &&\r\n        (!dataRoomAccess.expires_at || new Date(dataRoomAccess.expires_at) > new Date())\r\n\r\n      const accessAlreadyGranted = membership?.data_room_granted_at && accessRecordValid\r\n\r\n      // Grant access if: already granted (grandfather) OR all current signatories have signed\r\n      hasDataRoomAccess = accessAlreadyGranted || (allSignatoriesSignedNda && accessRecordValid)\r\n    }\r\n\r\n    if (hasDataRoomAccess) {\r\n      const { data: docs } = await serviceSupabase\r\n        .from('deal_data_room_documents')\r\n        .select(`\r\n          id,\r\n          deal_id,\r\n          file_name,\r\n          file_key,\r\n          folder,\r\n          file_size_bytes,\r\n          mime_type,\r\n          document_notes,\r\n          created_at,\r\n          document_expires_at,\r\n          is_featured,\r\n          external_link\r\n        `)\r\n        .eq('deal_id', dealId)\r\n        .eq('visible_to_investors', true)\r\n        .order('folder', { ascending: true })\r\n        .order('file_name', { ascending: true })\r\n\r\n      const now = new Date()\r\n      dataRoomDocuments = (docs || [])\r\n        .filter(doc => !doc.document_expires_at || new Date(doc.document_expires_at) > now)\r\n        .map(doc => ({\r\n          id: doc.id,\r\n          file_name: doc.file_name || 'Document',\r\n          file_type: doc.mime_type || 'application/octet-stream',\r\n          file_size: doc.file_size_bytes ? Number(doc.file_size_bytes) : 0,\r\n          category: doc.folder || 'General',\r\n          description: doc.document_notes || null,\r\n          uploaded_at: doc.created_at,\r\n          is_featured: doc.is_featured || false,\r\n          external_link: doc.external_link || null,\r\n          file_key: doc.file_key || null\r\n        }))\r\n    }\r\n\r\n    // Get investor's authorized signatories\r\n    const { data: signatories } = await serviceSupabase\r\n      .from('investor_members')\r\n      .select('id, full_name, email, role')\r\n      .eq('investor_id', effectiveInvestorId)\r\n      .eq('role', 'authorized_signatory')\r\n      .eq('is_active', true)\r\n\r\n    // Calculate current journey stage\r\n    let currentStage = 0\r\n    if (subscription?.activated_at) currentStage = 10\r\n    else if (subscription?.funded_at) currentStage = 9\r\n    else if (subscription?.signed_at) currentStage = 8\r\n    else if (subscription?.pack_sent_at) currentStage = 7\r\n    else if (subscription?.pack_generated_at) currentStage = 6\r\n    else if (membership?.data_room_granted_at) currentStage = 5\r\n    else if (membership?.nda_signed_at) currentStage = 4\r\n    else if (membership?.interest_confirmed_at) currentStage = 3\r\n    else if (membership?.viewed_at) currentStage = 2\r\n    else if (membership?.dispatched_at) currentStage = 1\r\n\r\n    // Build the response\r\n    const hasPendingSubmission = subscriptionSubmission?.status === 'pending_review'\r\n\r\n    const opportunity = {\r\n      id: deal.id,\r\n      name: deal.name,\r\n      description: deal.description,\r\n      investment_thesis: deal.investment_thesis,\r\n      status: deal.status,\r\n      deal_type: deal.deal_type,\r\n      currency: deal.currency || 'USD',\r\n      minimum_investment: deal.minimum_investment,\r\n      maximum_investment: deal.maximum_investment,\r\n      target_amount: deal.target_amount,\r\n      raised_amount: deal.raised_amount,\r\n      offer_unit_price: deal.offer_unit_price,\r\n      open_at: deal.open_at,\r\n      close_at: deal.close_at,\r\n      company_name: deal.company_name,\r\n      company_logo_url: deal.company_logo_url,\r\n      company_website: deal.company_website,\r\n      sector: deal.sector,\r\n      stage: deal.stage,\r\n      location: deal.location,\r\n      stock_type: deal.stock_type,\r\n      deal_round: deal.deal_round,\r\n      vehicle: vehicle,\r\n\r\n      // Membership status\r\n      has_membership: !!membership,\r\n      membership: membership ? {\r\n        role: membership.role,\r\n        dispatched_at: membership.dispatched_at,\r\n        viewed_at: membership.viewed_at,\r\n        interest_confirmed_at: membership.interest_confirmed_at,\r\n        nda_signed_at: membership.nda_signed_at,\r\n        data_room_granted_at: membership.data_room_granted_at\r\n      } : null,\r\n\r\n      // Journey progress\r\n      journey: {\r\n        current_stage: currentStage,\r\n        stages: journeyStages || [],\r\n        summary: {\r\n          received: membership?.dispatched_at || null,\r\n          viewed: membership?.viewed_at || null,\r\n          interest_confirmed: membership?.interest_confirmed_at || null,\r\n          nda_signed: membership?.nda_signed_at || null,\r\n          data_room_access: membership?.data_room_granted_at || null,\r\n          pack_generated: subscription?.pack_generated_at || null,\r\n          pack_sent: subscription?.pack_sent_at || null,\r\n          signed: subscription?.signed_at || null,\r\n          funded: subscription?.funded_at || null,\r\n          active: subscription?.activated_at || null\r\n        }\r\n      },\r\n\r\n      // Data room access\r\n      data_room: {\r\n        has_access: hasDataRoomAccess,\r\n        access_details: dataRoomAccess ? {\r\n          granted_at: dataRoomAccess.granted_at,\r\n          expires_at: dataRoomAccess.expires_at,\r\n          auto_granted: dataRoomAccess.auto_granted\r\n        } : null,\r\n        documents: dataRoomDocuments,\r\n        requires_nda: !allSignatoriesSignedNda,\r\n        nda_status: {\r\n          all_signed: allSignatoriesSignedNda,\r\n          total_signatories: allSignatories?.length || 0,\r\n          message: allSignatories && allSignatories.length > 0 && !allSignatoriesSignedNda\r\n            ? `All ${allSignatories.length} authorized signatories must sign the NDA to unlock the data room`\r\n            : null\r\n        }\r\n      },\r\n\r\n      // Subscription status\r\n      subscription: subscription ? {\r\n        id: subscription.id,\r\n        status: subscription.status,\r\n        commitment: subscription.commitment,\r\n        currency: subscription.currency || deal.currency || 'USD',\r\n        funded_amount: subscription.funded_amount,\r\n        pack_generated_at: subscription.pack_generated_at,\r\n        pack_sent_at: subscription.pack_sent_at,\r\n        signed_at: subscription.signed_at,\r\n        funded_at: subscription.funded_at,\r\n        activated_at: subscription.activated_at,\r\n        created_at: subscription.created_at,\r\n        is_signed: !!subscription.signed_at,\r\n        is_funded: !!subscription.funded_at,\r\n        is_active: !!subscription.activated_at,\r\n        documents: subscriptionDocuments\r\n      } : null,\r\n      subscription_submission: subscriptionSubmission,\r\n\r\n      // Fee structures\r\n      fee_structures: feeStructures || [],\r\n\r\n      // FAQs\r\n      faqs: faqs || [],\r\n\r\n      // Signatories for NDA/subscription signing\r\n      signatories: signatories || [],\r\n\r\n      // Computed flags for UI\r\n      // Only show express interest for users with an investor persona\r\n      can_express_interest: effectiveInvestorId !== null && !membership?.interest_confirmed_at,\r\n      can_sign_nda: !!membership?.interest_confirmed_at && !membership?.nda_signed_at,\r\n      can_access_data_room: hasDataRoomAccess,\r\n      // SECURITY FIX: Only allow subscription for roles that permit investing\r\n      // commercial_partner_proxy has its own endpoint at /api/commercial-partners/proxy-subscribe\r\n      // Must have an investor profile (effectiveInvestorId) to be able to subscribe\r\n      can_subscribe: effectiveInvestorId !== null && !subscription && !hasPendingSubmission && isDealOpen && (\r\n        !membership?.role || // Public deal without membership (user still needs investor profile - checked above)\r\n        ['investor', 'partner_investor', 'introducer_investor', 'commercial_partner_investor', 'co_investor'].includes(membership.role)\r\n      ),\r\n      // Indicate if user is tracking-only (cannot invest)\r\n      is_tracking_only: !!membership?.role && !['investor', 'partner_investor', 'introducer_investor', 'commercial_partner_investor', 'co_investor'].includes(membership.role),\r\n      can_sign_subscription: subscription?.pack_sent_at && !subscription?.signed_at,\r\n\r\n      // MODE 2: Proxy mode info for commercial partners viewing on behalf of clients\r\n      proxy_mode: isProxyMode ? {\r\n        is_proxy: true,\r\n        client_name: proxyClientName,\r\n        client_investor_id: clientInvestorId\r\n      } : null,\r\n\r\n      // Indicate if user can use proxy mode (has commercial_partner_proxy role)\r\n      can_use_proxy_mode: membership?.role === 'commercial_partner_proxy',\r\n\r\n      // PERSONA-BASED ACCESS CONTROLS (per Fred's meeting requirements)\r\n      // These flags tell the frontend which sections to hide/show\r\n      access_controls: {\r\n        // Introducers and lawyers cannot see the term sheet\r\n        can_view_term_sheet: !isRestrictedFromTermSheet,\r\n        // Introducers and lawyers never get data room access\r\n        can_view_data_room: !isRestrictedFromDataRoom,\r\n        // Arrangers get automatic access without NDA\r\n        has_auto_data_room_access: isArrangerWithAutoAccess,\r\n        // Reason for restrictions (for UI messaging)\r\n        restriction_reason: isRestrictedFromTermSheet || isRestrictedFromDataRoom\r\n          ? `As ${membership?.role === 'introducer' ? 'an introducer' : 'a lawyer'}, you do not have access to ${isRestrictedFromTermSheet && isRestrictedFromDataRoom ? 'the term sheet or data room' : isRestrictedFromTermSheet ? 'the term sheet' : 'the data room'} for this deal.`\r\n          : null\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({ opportunity })\r\n  } catch (error) {\r\n    console.error('Unexpected error in GET /api/investors/me/opportunities/:id:', error)\r\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/investors/me/opportunities/:id\r\n * Record view or express interest in an opportunity\r\n */\r\nexport async function POST(request: Request, { params }: RouteParams) {\r\n  const { id: dealId } = await params\r\n  const supabase = await createClient()\r\n  const serviceSupabase = createServiceClient()\r\n\r\n  try {\r\n    const { data: { user }, error: userError } = await supabase.auth.getUser()\r\n    if (userError || !user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n    }\r\n\r\n    const body = await request.json()\r\n    const action = body.action as string\r\n\r\n    // Validate action\r\n    const validActions = ['view', 'express_interest']\r\n    if (!validActions.includes(action)) {\r\n      return NextResponse.json({ error: 'Invalid action' }, { status: 400 })\r\n    }\r\n\r\n    // Get investor ID\r\n    const { data: investorLinks } = await serviceSupabase\r\n      .from('investor_users')\r\n      .select('investor_id')\r\n      .eq('user_id', user.id)\r\n\r\n    if (!investorLinks || investorLinks.length === 0) {\r\n      return NextResponse.json({ error: 'No investor profile found' }, { status: 404 })\r\n    }\r\n\r\n    const investorId = investorLinks[0].investor_id\r\n\r\n    // Check if membership exists (use user_id for PK)\r\n    const { data: existingMembership } = await serviceSupabase\r\n      .from('deal_memberships')\r\n      .select('*')\r\n      .eq('deal_id', dealId)\r\n      .eq('user_id', user.id)\r\n      .single()\r\n\r\n    if (action === 'view') {\r\n      if (existingMembership) {\r\n        // Update viewed_at if not already set\r\n        if (!existingMembership.viewed_at) {\r\n          await serviceSupabase\r\n            .from('deal_memberships')\r\n            .update({ viewed_at: new Date().toISOString() })\r\n            .eq('deal_id', dealId)\r\n            .eq('user_id', user.id)\r\n        }\r\n      } else {\r\n        // Create new membership with viewed_at (for direct view without dispatch)\r\n        await serviceSupabase\r\n          .from('deal_memberships')\r\n          .insert({\r\n            deal_id: dealId,\r\n            user_id: user.id,\r\n            investor_id: investorId,\r\n            role: 'investor',\r\n            viewed_at: new Date().toISOString()\r\n          })\r\n      }\r\n\r\n      return NextResponse.json({ success: true, action: 'viewed' })\r\n    }\r\n\r\n    if (action === 'express_interest') {\r\n      if (!existingMembership) {\r\n        // Create membership and express interest in one go\r\n        await serviceSupabase\r\n          .from('deal_memberships')\r\n          .insert({\r\n            deal_id: dealId,\r\n            user_id: user.id,\r\n            investor_id: investorId,\r\n            role: 'investor',\r\n            viewed_at: new Date().toISOString(),\r\n            interest_confirmed_at: new Date().toISOString()\r\n          })\r\n      } else if (!existingMembership.interest_confirmed_at) {\r\n        // Update existing membership\r\n        await serviceSupabase\r\n          .from('deal_memberships')\r\n          .update({\r\n            interest_confirmed_at: new Date().toISOString(),\r\n            viewed_at: existingMembership.viewed_at || new Date().toISOString()\r\n          })\r\n          .eq('deal_id', dealId)\r\n          .eq('user_id', user.id)\r\n      }\r\n\r\n      return NextResponse.json({ success: true, action: 'interest_expressed' })\r\n    }\r\n\r\n    return NextResponse.json({ error: 'Unknown action' }, { status: 400 })\r\n  } catch (error) {\r\n    console.error('Unexpected error in POST /api/investors/me/opportunities/:id:', error)\r\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}