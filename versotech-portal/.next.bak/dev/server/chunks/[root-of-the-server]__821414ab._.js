module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient,
    "createServiceClient",
    ()=>createServiceClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
;
const createClient = async ()=>{
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ3V4ZHNzZWNmZXh1ZG52dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4MzcsImV4cCI6MjA3MzkzNzgzN30.AGxM_YW9hfxuu7xDpi_4xhOoRhYM7iGTS1vJ0z2FByE"), {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>{
                        cookieStore.set(name, value, options);
                    });
                } catch (error) {
                // The `setAll` method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            }
        }
    });
};
const createServiceClient = ()=>{
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), process.env.SUPABASE_SERVICE_ROLE_KEY, {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    });
};
}),
"[project]/versotech-portal/src/app/api/partners/me/dashboard/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/server.js [app-route] (ecmascript)");
;
;
function normalizeJoin(value) {
    if (!value) return null;
    return Array.isArray(value) ? value[0] || null : value;
}
async function GET() {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
    const serviceSupabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceClient"])();
    try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const { data: partnerUser, error: partnerUserError } = await serviceSupabase.from('partner_users').select('partner_id').eq('user_id', user.id).maybeSingle();
        if (partnerUserError) {
            console.error('[partner-dashboard] Partner lookup error:', partnerUserError);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to load partner profile'
            }, {
                status: 500
            });
        }
        if (!partnerUser?.partner_id) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Partner profile not found'
            }, {
                status: 404
            });
        }
        const partnerId = partnerUser.partner_id;
        const { data: ownMemberships, error: ownMembershipsError } = await serviceSupabase.from('deal_memberships').select('deal_id, role, dispatched_at').eq('user_id', user.id).not('dispatched_at', 'is', null);
        if (ownMembershipsError) {
            console.error('[partner-dashboard] Membership lookup error:', ownMembershipsError);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to load deal memberships'
            }, {
                status: 500
            });
        }
        const trackedDeals = (ownMemberships || []).filter((m)=>m.role === 'partner').length;
        const investableDeals = (ownMemberships || []).filter((m)=>m.role === 'partner_investor').length;
        const ownDealIds = Array.from(new Set((ownMemberships || []).map((m)=>m.deal_id).filter(Boolean)));
        const { data: referralMemberships, error: referralError } = await serviceSupabase.from('deal_memberships').select(`
        deal_id,
        investor_id,
        role,
        dispatched_at,
        interest_confirmed_at,
        deal:deal_id (
          id,
          name,
          status
        ),
        investor:investor_id (
          id,
          legal_name,
          display_name
        )
      `).eq('referred_by_entity_type', 'partner').eq('referred_by_entity_id', partnerId).order('dispatched_at', {
            ascending: false
        });
        if (referralError) {
            console.error('[partner-dashboard] Referral lookup error:', referralError);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to load referrals'
            }, {
                status: 500
            });
        }
        const referrals = referralMemberships || [];
        const referralPairs = referrals.filter((r)=>r.investor_id && r.deal_id).map((r)=>`${r.investor_id}:${r.deal_id}`);
        const referralPairSet = new Set(referralPairs);
        const investorIds = Array.from(new Set(referrals.map((r)=>r.investor_id).filter(Boolean)));
        const referralDealIds = Array.from(new Set(referrals.map((r)=>r.deal_id).filter(Boolean)));
        let matchedSubscriptions = [];
        if (investorIds.length > 0 && referralDealIds.length > 0) {
            const { data: subs, error: subsError } = await serviceSupabase.from('subscriptions').select('investor_id, deal_id, commitment, status, signed_at, currency').in('investor_id', investorIds).in('deal_id', referralDealIds);
            if (subsError) {
                console.error('[partner-dashboard] Subscription lookup error:', subsError);
                return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'Failed to load subscription data'
                }, {
                    status: 500
                });
            }
            matchedSubscriptions = (subs || []).filter((sub)=>referralPairSet.has(`${sub.investor_id}:${sub.deal_id}`));
        }
        const subscriptionMap = new Map(matchedSubscriptions.map((sub)=>[
                `${sub.investor_id}:${sub.deal_id}`,
                sub
            ]));
        const subscribedStatuses = new Set([
            'committed',
            'active'
        ]);
        const pendingStatuses = new Set([
            'pending'
        ]);
        let totalCommitment = 0;
        let subscribedInvestors = 0;
        let pipelineInvestors = 0;
        for (const referral of referrals){
            if (!referral.investor_id || !referral.deal_id) continue;
            const subscription = subscriptionMap.get(`${referral.investor_id}:${referral.deal_id}`);
            const status = subscription?.status || null;
            if (status && subscribedStatuses.has(status)) {
                subscribedInvestors += 1;
                totalCommitment += Number(subscription?.commitment || 0);
                continue;
            }
            if (status && pendingStatuses.has(status) || !status && referral.interest_confirmed_at) {
                pipelineInvestors += 1;
            }
        }
        const commitmentCurrency = matchedSubscriptions.find((sub)=>sub.currency)?.currency || 'USD';
        let pendingCommissions = 0;
        let pendingCommissionCurrency = 'USD';
        let feePlanQuery = serviceSupabase.from('fee_plans').select('id');
        const feePlanDealIds = Array.from(new Set([
            ...ownDealIds,
            ...referralDealIds
        ]));
        if (feePlanDealIds.length > 0) {
            feePlanQuery = feePlanQuery.or(`partner_id.eq.${partnerId},deal_id.in.(${feePlanDealIds.join(',')})`);
        } else {
            feePlanQuery = feePlanQuery.eq('partner_id', partnerId);
        }
        const { data: feePlans, error: feePlansError } = await feePlanQuery;
        if (feePlansError) {
            console.error('[partner-dashboard] Fee plan lookup error:', feePlansError);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to load fee plans'
            }, {
                status: 500
            });
        }
        const feePlanIds = (feePlans || []).map((plan)=>plan.id);
        if (feePlanIds.length > 0) {
            const { data: feeComponents, error: feeComponentsError } = await serviceSupabase.from('fee_components').select('id, fee_plan_id').in('fee_plan_id', feePlanIds);
            if (feeComponentsError) {
                console.error('[partner-dashboard] Fee components lookup error:', feeComponentsError);
                return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'Failed to load fee components'
                }, {
                    status: 500
                });
            }
            const componentIds = (feeComponents || []).map((component)=>component.id);
            if (componentIds.length > 0) {
                const { data: feeEvents, error: feeEventsError } = await serviceSupabase.from('fee_events').select('computed_amount, status, currency').in('fee_component_id', componentIds).in('status', [
                    'accrued',
                    'invoiced'
                ]);
                if (feeEventsError) {
                    console.error('[partner-dashboard] Fee events lookup error:', feeEventsError);
                    return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                        error: 'Failed to load fee events'
                    }, {
                        status: 500
                    });
                }
                pendingCommissions = (feeEvents || []).reduce((sum, event)=>sum + Number(event.computed_amount || 0), 0);
                pendingCommissionCurrency = feeEvents?.[0]?.currency || pendingCommissionCurrency;
            }
        }
        const recentReferrals = referrals.slice(0, 10).map((referral)=>{
            const deal = normalizeJoin(referral.deal);
            const investor = normalizeJoin(referral.investor);
            const subscription = referral.investor_id && referral.deal_id ? subscriptionMap.get(`${referral.investor_id}:${referral.deal_id}`) || null : null;
            return {
                deal_id: referral.deal_id,
                deal_name: deal?.name || null,
                deal_status: deal?.status || null,
                investor_id: referral.investor_id,
                investor_name: investor?.display_name || investor?.legal_name || null,
                dispatched_at: referral.dispatched_at,
                interest_confirmed_at: referral.interest_confirmed_at,
                subscription: subscription ? {
                    commitment: subscription.commitment,
                    status: subscription.status,
                    signed_at: subscription.signed_at
                } : null
            };
        });
        // Calculate performance metrics
        const conversionRate = referrals.length > 0 ? Math.round(subscribedInvestors / referrals.length * 100) : 0;
        // Calculate this month vs last month comparison
        const now = new Date();
        const startOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const thisMonthReferrals = referrals.filter((r)=>r.dispatched_at && new Date(r.dispatched_at) >= startOfThisMonth).length;
        const lastMonthReferrals = referrals.filter((r)=>r.dispatched_at && new Date(r.dispatched_at) >= startOfLastMonth && new Date(r.dispatched_at) < startOfThisMonth).length;
        const referralGrowth = lastMonthReferrals > 0 ? Math.round((thisMonthReferrals - lastMonthReferrals) / lastMonthReferrals * 100) : thisMonthReferrals > 0 ? 100 : 0;
        // Calculate paid vs pending commissions
        let paidCommissions = 0;
        if (feePlanIds.length > 0) {
            const { data: paidEvents } = await serviceSupabase.from('fee_events').select('computed_amount').in('fee_component_id', (await serviceSupabase.from('fee_components').select('id').in('fee_plan_id', feePlanIds)).data?.map((c)=>c.id) || []).eq('status', 'paid');
            paidCommissions = (paidEvents || []).reduce((sum, event)=>sum + Number(event.computed_amount || 0), 0);
        }
        // Average commitment per investor
        const avgCommitmentPerInvestor = subscribedInvestors > 0 ? Math.round(totalCommitment / subscribedInvestors) : 0;
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            metrics: {
                totalReferredInvestors: referrals.length,
                subscribedInvestors,
                pipelineInvestors,
                totalCommitment,
                commitmentCurrency,
                pendingCommissions,
                pendingCommissionCurrency,
                trackedDeals,
                investableDeals
            },
            performance: {
                conversionRate,
                thisMonthReferrals,
                lastMonthReferrals,
                referralGrowth,
                paidCommissions,
                avgCommitmentPerInvestor,
                avgCommitmentCurrency: commitmentCurrency
            },
            recent_referrals: recentReferrals
        });
    } catch (error) {
        console.error('Unexpected error in GET /api/partners/me/dashboard:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__821414ab._.js.map