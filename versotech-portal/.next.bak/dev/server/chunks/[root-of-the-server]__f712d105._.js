module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient,
    "createServiceClient",
    ()=>createServiceClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
;
const createClient = async ()=>{
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ3V4ZHNzZWNmZXh1ZG52dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjE4MzcsImV4cCI6MjA3MzkzNzgzN30.AGxM_YW9hfxuu7xDpi_4xhOoRhYM7iGTS1vJ0z2FByE"), {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>{
                        cookieStore.set(name, value, options);
                    });
                } catch (error) {
                // The `setAll` method was called from a Server Component.
                // This can be ignored if you have middleware refreshing
                // user sessions.
                }
            }
        }
    });
};
const createServiceClient = ()=>{
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(("TURBOPACK compile-time value", "https://ipguxdssecfexudnvtia.supabase.co"), process.env.SUPABASE_SERVICE_ROLE_KEY, {
        auth: {
            autoRefreshToken: false,
            persistSession: false
        }
    });
};
}),
"[project]/versotech-portal/src/app/api/commercial-partners/me/client-transactions/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/versotech-portal/src/lib/supabase/server.ts [app-route] (ecmascript)");
;
;
function getJourneyStage(subscriptionStatus, hasSubscription, membership) {
    if (!hasSubscription) {
        if (membership?.data_room_granted_at) return 'interested';
        if (membership?.nda_signed_at) return 'interested';
        if (membership?.interest_confirmed_at) return 'interested';
        return 'new_lead';
    }
    switch(subscriptionStatus){
        case 'funded':
        case 'active':
            return 'funded';
        case 'signed':
        case 'committed':
        case 'pending':
        case 'approved':
            return 'subscribing';
        case 'cancelled':
        case 'rejected':
        case 'withdrawn':
            return 'passed';
        default:
            return 'interested';
    }
}
function normalizeJoin(value) {
    if (!value) return null;
    return Array.isArray(value) ? value[0] || null : value;
}
async function GET() {
    const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
    const serviceSupabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServiceClient"])();
    try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const { data: cpUser } = await serviceSupabase.from('commercial_partner_users').select('commercial_partner_id').eq('user_id', user.id).maybeSingle();
        if (!cpUser?.commercial_partner_id) {
            // Staff fallback - show limited dataset
            const { data: clientsData } = await serviceSupabase.from('commercial_partner_clients').select(`
          id,
          client_name,
          client_email,
          client_type,
          is_active,
          created_at,
          created_for_deal_id,
          client_investor_id,
          deal:created_for_deal_id (
            id,
            name,
            status
          )
        `).order('created_at', {
                ascending: false
            }).limit(100);
            const processed = (clientsData || []).map((client)=>{
                const deal = normalizeJoin(client.deal);
                return {
                    id: client.id,
                    client_name: client.client_name || 'Unknown Client',
                    client_email: client.client_email,
                    client_type: client.client_type,
                    is_active: client.is_active ?? true,
                    created_at: client.created_at,
                    deal_id: client.created_for_deal_id,
                    deal_name: deal?.name || null,
                    deal_status: deal?.status || null,
                    investor_id: client.client_investor_id,
                    subscription_id: null,
                    subscription_amount: null,
                    subscription_status: null,
                    subscription_date: null,
                    journey_stage: 'new_lead',
                    has_termsheet: !!client.created_for_deal_id,
                    has_dataroom_access: false,
                    estimated_commission: null,
                    commission_rate_bps: 0
                };
            });
            const summary = {
                totalClients: processed.length,
                activeClients: processed.filter((c)=>c.is_active).length,
                totalTransactions: 0,
                totalValue: 0,
                estimatedCommission: 0
            };
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                staff_view: true,
                partner: null,
                placement_agreement: null,
                clients: processed,
                summary
            });
        }
        const cpId = cpUser.commercial_partner_id;
        const { data: partner } = await serviceSupabase.from('commercial_partners').select('id, name, legal_name, type, status, logo_url').eq('id', cpId).single();
        const { data: agreement } = await serviceSupabase.from('placement_agreements').select('id, default_commission_bps, status').eq('commercial_partner_id', cpId).eq('status', 'active').maybeSingle();
        const { data: clientsData, error: clientsError } = await serviceSupabase.from('commercial_partner_clients').select(`
        id,
        client_name,
        client_email,
        client_type,
        is_active,
        created_at,
        created_for_deal_id,
        client_investor_id,
        deal:created_for_deal_id (
          id,
          name,
          status
        )
      `).eq('commercial_partner_id', cpId).order('created_at', {
            ascending: false
        });
        if (clientsError) {
            console.error('[cp-client-transactions] Clients fetch error:', clientsError);
            return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Failed to load clients'
            }, {
                status: 500
            });
        }
        const investorIds = (clientsData || []).filter((client)=>client.client_investor_id).map((client)=>client.client_investor_id);
        // Get dealIds from client records (will combine with subscription dealIds after fetch)
        const dealIdsFromClients = (clientsData || []).filter((client)=>client.created_for_deal_id).map((client)=>client.created_for_deal_id);
        let subscriptionsMap = {};
        if (investorIds.length > 0) {
            const { data: subs } = await serviceSupabase.from('subscriptions').select(`
          id,
          investor_id,
          deal_id,
          commitment,
          status,
          subscription_date,
          deals (
            id,
            name,
            status
          )
        `).in('investor_id', investorIds).eq('proxy_commercial_partner_id', cpId).order('created_at', {
                ascending: false
            });
            if (subs) {
                subs.forEach((sub)=>{
                    if (!subscriptionsMap[sub.investor_id]) {
                        subscriptionsMap[sub.investor_id] = [];
                    }
                    subscriptionsMap[sub.investor_id].push(sub);
                });
            }
        }
        // Combine dealIds from BOTH client links AND subscriptions
        const dealIdsFromSubscriptions = Object.values(subscriptionsMap).flat().map((sub)=>sub.deal_id).filter(Boolean);
        const allDealIds = [
            ...new Set([
                ...dealIdsFromClients,
                ...dealIdsFromSubscriptions
            ])
        ];
        let membershipMap = {};
        if (investorIds.length > 0 && allDealIds.length > 0) {
            const { data: memberships } = await serviceSupabase.from('deal_memberships').select('investor_id, deal_id, interest_confirmed_at, nda_signed_at, data_room_granted_at').in('investor_id', investorIds).in('deal_id', allDealIds);
            if (memberships) {
                memberships.forEach((m)=>{
                    const key = `${m.investor_id}:${m.deal_id}`;
                    membershipMap[key] = {
                        interest_confirmed_at: m.interest_confirmed_at,
                        nda_signed_at: m.nda_signed_at,
                        data_room_granted_at: m.data_room_granted_at
                    };
                });
            }
        }
        let dataroomAccessMap = {};
        if (allDealIds.length > 0 && investorIds.length > 0) {
            const { data: accessRecords } = await serviceSupabase.from('deal_data_room_access').select('deal_id, investor_id').in('deal_id', allDealIds).in('investor_id', investorIds).is('revoked_at', null).or(`expires_at.is.null,expires_at.gte.${new Date().toISOString()}`);
            if (accessRecords) {
                accessRecords.forEach((record)=>{
                    const key = `${record.deal_id}:${record.investor_id}`;
                    dataroomAccessMap[key] = true;
                });
            }
        }
        const commissionBps = agreement?.default_commission_bps || 0;
        const processed = [];
        (clientsData || []).forEach((client)=>{
            const subscriptions = client.client_investor_id ? subscriptionsMap[client.client_investor_id] || [] : [];
            if (subscriptions.length === 0) {
                // Try to find membership from explicit deal link first
                let membership = undefined;
                if (client.client_investor_id && client.created_for_deal_id) {
                    const explicitKey = `${client.client_investor_id}:${client.created_for_deal_id}`;
                    membership = membershipMap[explicitKey];
                }
                // If no explicit link membership, check if there are any memberships for this investor
                // (This handles cases where the client is associated via other paths)
                if (!membership && client.client_investor_id) {
                    // Find any membership for this investor in our membershipMap
                    const investorPrefix = `${client.client_investor_id}:`;
                    const matchingKey = Object.keys(membershipMap).find((key)=>key.startsWith(investorPrefix));
                    if (matchingKey) {
                        membership = membershipMap[matchingKey];
                    }
                }
                const deal = normalizeJoin(client.deal);
                processed.push({
                    id: client.id,
                    client_name: client.client_name || 'Unknown Client',
                    client_email: client.client_email,
                    client_type: client.client_type,
                    is_active: client.is_active ?? true,
                    created_at: client.created_at,
                    deal_id: client.created_for_deal_id,
                    deal_name: deal?.name || null,
                    deal_status: deal?.status || null,
                    investor_id: client.client_investor_id,
                    subscription_id: null,
                    subscription_amount: null,
                    subscription_status: null,
                    subscription_date: null,
                    journey_stage: getJourneyStage(null, false, membership),
                    has_termsheet: !!client.created_for_deal_id,
                    has_dataroom_access: !!(client.created_for_deal_id && client.client_investor_id && dataroomAccessMap[`${client.created_for_deal_id}:${client.client_investor_id}`]),
                    estimated_commission: null,
                    commission_rate_bps: commissionBps
                });
            } else {
                subscriptions.forEach((sub)=>{
                    const commitment = sub.commitment || 0;
                    const estimatedComm = commissionBps > 0 ? commitment * commissionBps / 10000 : null;
                    const membershipKey = client.client_investor_id && sub.deal_id ? `${client.client_investor_id}:${sub.deal_id}` : '';
                    const membership = membershipKey ? membershipMap[membershipKey] : undefined;
                    const deal = normalizeJoin(sub.deals) || normalizeJoin(client.deal);
                    processed.push({
                        id: `${client.id}-${sub.id}`,
                        client_name: client.client_name || 'Unknown Client',
                        client_email: client.client_email,
                        client_type: client.client_type,
                        is_active: client.is_active ?? true,
                        created_at: sub.subscription_date || client.created_at,
                        deal_id: sub.deal_id,
                        deal_name: deal?.name || null,
                        deal_status: deal?.status || null,
                        investor_id: client.client_investor_id,
                        subscription_id: sub.id,
                        subscription_amount: commitment,
                        subscription_status: sub.status,
                        subscription_date: sub.subscription_date,
                        journey_stage: getJourneyStage(sub.status, true, membership),
                        has_termsheet: true,
                        has_dataroom_access: !!(sub.deal_id && client.client_investor_id && dataroomAccessMap[`${sub.deal_id}:${client.client_investor_id}`]),
                        estimated_commission: estimatedComm,
                        commission_rate_bps: commissionBps
                    });
                });
            }
        });
        const uniqueClients = new Set((clientsData || []).map((client)=>client.id));
        const activeClients = (clientsData || []).filter((client)=>client.is_active).length;
        const withSubscription = processed.filter((client)=>client.subscription_amount);
        const totalValue = withSubscription.reduce((sum, client)=>sum + (client.subscription_amount || 0), 0);
        const estimatedCommission = withSubscription.reduce((sum, client)=>sum + (client.estimated_commission || 0), 0);
        const summary = {
            totalClients: uniqueClients.size,
            activeClients,
            totalTransactions: withSubscription.length,
            totalValue,
            estimatedCommission
        };
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            staff_view: false,
            partner,
            placement_agreement: agreement,
            clients: processed,
            summary
        });
    } catch (error) {
        console.error('[cp-client-transactions] Unexpected error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$versotech$2d$portal$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__f712d105._.js.map