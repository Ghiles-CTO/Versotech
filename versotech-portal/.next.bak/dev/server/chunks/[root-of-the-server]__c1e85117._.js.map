{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,MAAM,eAAe;IAC1B,MAAM,cAAc,MAAM,IAAA,mKAAO;IAEjC,OAAO,IAAA,wNAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;wBAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAC/B;gBACF,EAAE,OAAO,OAAO;gBACd,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ;AAIO,MAAM,sBAAsB;IACjC,OAAO,IAAA,gOAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB,EACrC;QACE,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AAEJ"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/api/subscription-submissions/summary/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { createClient, createServiceClient } from '@/lib/supabase/server'\r\n\r\n/**\r\n * GET /api/subscription-submissions/summary\r\n *\r\n * Returns the total confirmed interest amount from deal_subscription_submissions.\r\n * This represents investors who clicked \"Subscribe Now\" and submitted a subscription request.\r\n */\r\nexport async function GET() {\r\n  const supabase = await createClient()\r\n  const serviceSupabase = createServiceClient()\r\n\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n  }\r\n\r\n  // Check staff access\r\n  const { data: profile } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single()\r\n\r\n  const isStaff = profile?.role?.startsWith('staff_') || profile?.role === 'ceo'\r\n  if (!isStaff) {\r\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })\r\n  }\r\n\r\n  // Sum all amounts from deal_subscription_submissions payload_json\r\n  // The amount is stored as payload_json->>'amount' or payload_json->>'subscription_amount'\r\n  const { data, error } = await serviceSupabase.rpc('get_subscription_submissions_total')\r\n\r\n  if (error) {\r\n    // Fallback: query directly if RPC doesn't exist\r\n    console.warn('[subscription-submissions/summary] RPC failed, using fallback query:', error.message)\r\n\r\n    const { data: submissions, error: queryError } = await serviceSupabase\r\n      .from('deal_subscription_submissions')\r\n      .select('payload_json')\r\n\r\n    if (queryError) {\r\n      console.error('[subscription-submissions/summary] Query failed:', queryError)\r\n      return NextResponse.json({ totalAmount: 0 })\r\n    }\r\n\r\n    // Calculate total from payload_json.amount\r\n    const totalAmount = (submissions ?? []).reduce((sum, sub) => {\r\n      const payload = sub.payload_json as Record<string, any> | null\r\n      const amount = Number(payload?.amount ?? payload?.subscription_amount ?? 0)\r\n      return sum + (isNaN(amount) ? 0 : amount)\r\n    }, 0)\r\n\r\n    return NextResponse.json({ totalAmount })\r\n  }\r\n\r\n  return NextResponse.json({ totalAmount: data ?? 0 })\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAQO,eAAe;IACpB,MAAM,WAAW,MAAM,IAAA,yKAAY;IACnC,MAAM,kBAAkB,IAAA,gLAAmB;IAE3C,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IACxE,IAAI,aAAa,CAAC,MAAM;QACtB,OAAO,uKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;IAEA,qBAAqB;IACrB,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,YACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;IAET,MAAM,UAAU,SAAS,MAAM,WAAW,aAAa,SAAS,SAAS;IACzE,IAAI,CAAC,SAAS;QACZ,OAAO,uKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;IACjE;IAEA,kEAAkE;IAClE,0FAA0F;IAC1F,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,gBAAgB,GAAG,CAAC;IAElD,IAAI,OAAO;QACT,gDAAgD;QAChD,QAAQ,IAAI,CAAC,wEAAwE,MAAM,OAAO;QAElG,MAAM,EAAE,MAAM,WAAW,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,gBACpD,IAAI,CAAC,iCACL,MAAM,CAAC;QAEV,IAAI,YAAY;YACd,QAAQ,KAAK,CAAC,oDAAoD;YAClE,OAAO,uKAAY,CAAC,IAAI,CAAC;gBAAE,aAAa;YAAE;QAC5C;QAEA,2CAA2C;QAC3C,MAAM,cAAc,CAAC,eAAe,EAAE,EAAE,MAAM,CAAC,CAAC,KAAK;YACnD,MAAM,UAAU,IAAI,YAAY;YAChC,MAAM,SAAS,OAAO,SAAS,UAAU,SAAS,uBAAuB;YACzE,OAAO,MAAM,CAAC,MAAM,UAAU,IAAI,MAAM;QAC1C,GAAG;QAEH,OAAO,uKAAY,CAAC,IAAI,CAAC;YAAE;QAAY;IACzC;IAEA,OAAO,uKAAY,CAAC,IAAI,CAAC;QAAE,aAAa,QAAQ;IAAE;AACpD"}}]
}