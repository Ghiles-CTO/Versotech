{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport { createClient as createSupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) => {\n              cookieStore.set(name, value, options)\n            })\n          } catch (error) {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n// Server client with service role for admin operations\n// Uses raw supabase-js client which properly bypasses RLS with service role\nexport const createServiceClient = () => {\n  return createSupabaseClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n      },\n    }\n  )\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,MAAM,eAAe;IAC1B,MAAM,cAAc,MAAM,IAAA,mKAAO;IAEjC,OAAO,IAAA,wNAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;wBAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAC/B;gBACF,EAAE,OAAO,OAAO;gBACd,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ;AAIO,MAAM,sBAAsB;IACjC,OAAO,IAAA,gOAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB,EACrC;QACE,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AAEJ"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///Users/ghilesmoussaoui/Desktop/Versotech/versotech-portal/src/app/api/staff/fees/dashboard/route.ts"],"sourcesContent":["/**\n * Fees Dashboard API Route\n * Returns KPIs and overview data\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\n\ninterface CommissionRow {\n  accrual_amount: number;\n  status: string;\n  paid_at: string | null;\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n\n    const now = new Date();\n    const yearStart = new Date(now.getFullYear(), 0, 1).toISOString();\n    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();\n    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1).toISOString();\n    const next30Days = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();\n\n    // Fetch fee events for revenue calculations\n    const { data: feeEvents } = await supabase\n      .from('fee_events')\n      .select('computed_amount, event_date, status')\n      .eq('status', 'paid');\n\n    const ytdFees = feeEvents?.filter(e => e.event_date >= yearStart).reduce((sum, e) => sum + e.computed_amount, 0) || 0;\n    const mtdFees = feeEvents?.filter(e => e.event_date >= monthStart).reduce((sum, e) => sum + e.computed_amount, 0) || 0;\n    const qtdFees = feeEvents?.filter(e => e.event_date >= quarterStart).reduce((sum, e) => sum + e.computed_amount, 0) || 0;\n\n    // Fetch invoice statistics\n    const { data: invoices } = await supabase\n      .from('invoices')\n      .select('status, total, balance_due, due_date');\n\n    const outstanding = invoices?.filter(i => ['sent', 'partially_paid'].includes(i.status)) || [];\n    const overdue = invoices?.filter(i => ['sent', 'partially_paid', 'overdue'].includes(i.status) && new Date(i.due_date) < now) || [];\n\n    const outstandingAmount = outstanding.reduce((sum, i) => sum + (i.balance_due || i.total), 0);\n    const overdueAmount = overdue.reduce((sum, i) => sum + (i.balance_due || i.total), 0);\n\n    // Fetch upcoming fees\n    const { data: upcomingSchedules } = await supabase\n      .from('fee_schedules')\n      .select('*, fee_component:fee_components(*), investor:investors(display_name)')\n      .eq('status', 'active')\n      .lte('next_due_date', next30Days)\n      .order('next_due_date');\n\n    const upcomingFeesAmount = upcomingSchedules?.reduce((sum, schedule) => {\n      // Simplified calculation - would need actual allocation amounts\n      return sum + 1000; // Placeholder\n    }, 0) || 0;\n\n    // Fetch all commissions from all 3 tables\n    const [introducerRes, partnerRes, commercialPartnerRes] = await Promise.all([\n      supabase\n        .from('introducer_commissions')\n        .select('accrual_amount, status, paid_at'),\n      supabase\n        .from('partner_commissions')\n        .select('accrual_amount, status, paid_at'),\n      supabase\n        .from('commercial_partner_commissions')\n        .select('accrual_amount, status, paid_at'),\n    ]);\n\n    const introducerCommissions: CommissionRow[] = introducerRes.data || [];\n    const partnerCommissions: CommissionRow[] = partnerRes.data || [];\n    const commercialPartnerCommissions: CommissionRow[] = commercialPartnerRes.data || [];\n\n    // Helper to calculate commission totals for a single table\n    const calculateCommissionTotals = (commissions: CommissionRow[]) => {\n      const accrued = commissions\n        .filter(c => c.status === 'accrued')\n        .reduce((sum, c) => sum + Number(c.accrual_amount), 0);\n      const invoiced = commissions\n        .filter(c => c.status === 'invoiced')\n        .reduce((sum, c) => sum + Number(c.accrual_amount), 0);\n      const paid = commissions\n        .filter(c => c.status === 'paid')\n        .reduce((sum, c) => sum + Number(c.accrual_amount), 0);\n      const paidYtd = commissions\n        .filter(c => c.status === 'paid' && c.paid_at && c.paid_at >= yearStart)\n        .reduce((sum, c) => sum + Number(c.accrual_amount), 0);\n      return { accrued, invoiced, paid, paidYtd, owed: accrued + invoiced };\n    };\n\n    const introducerTotals = calculateCommissionTotals(introducerCommissions);\n    const partnerTotals = calculateCommissionTotals(partnerCommissions);\n    const commercialPartnerTotals = calculateCommissionTotals(commercialPartnerCommissions);\n\n    // Calculate aggregated totals across all 3 tables\n    const commissionSummary = {\n      total_owed: introducerTotals.owed + partnerTotals.owed + commercialPartnerTotals.owed,\n      total_accrued: introducerTotals.accrued + partnerTotals.accrued + commercialPartnerTotals.accrued,\n      total_invoiced: introducerTotals.invoiced + partnerTotals.invoiced + commercialPartnerTotals.invoiced,\n      total_paid_ytd: introducerTotals.paidYtd + partnerTotals.paidYtd + commercialPartnerTotals.paidYtd,\n      by_entity_type: {\n        introducer: { owed: introducerTotals.owed, paid: introducerTotals.paidYtd },\n        partner: { owed: partnerTotals.owed, paid: partnerTotals.paidYtd },\n        commercial_partner: { owed: commercialPartnerTotals.owed, paid: commercialPartnerTotals.paidYtd },\n      },\n    };\n\n    // Return KPIs\n    return NextResponse.json({\n      data: {\n        total_fees_ytd: ytdFees,\n        total_fees_mtd: mtdFees,\n        total_fees_qtd: qtdFees,\n        outstanding_invoices_count: outstanding.length,\n        outstanding_invoices_amount: outstandingAmount,\n        overdue_invoices_count: overdue.length,\n        overdue_invoices_amount: overdueAmount,\n        upcoming_fees_30days: upcomingFeesAmount,\n        upcoming_fees_count: upcomingSchedules?.length || 0,\n        introducer_commissions_owed: introducerTotals.owed, // Legacy field for backward compatibility\n        commission_summary: commissionSummary,\n      },\n    });\n  } catch (error) {\n    console.error('Error in GET /api/staff/fees/dashboard:', error);\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}