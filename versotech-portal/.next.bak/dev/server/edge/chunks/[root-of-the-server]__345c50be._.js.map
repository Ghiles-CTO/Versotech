{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/versotech-portal/src/middleware.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\r\nimport { NextResponse, type NextRequest } from 'next/server'\r\n\r\nexport async function middleware(request: NextRequest) {\r\n  const { pathname } = request.nextUrl\r\n\r\n  let supabaseResponse = NextResponse.next({\r\n    request,\r\n  })\r\n\r\n  const supabase = createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        getAll() {\r\n          return request.cookies.getAll()\r\n        },\r\n        setAll(cookiesToSet) {\r\n          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))\r\n          supabaseResponse = NextResponse.next({\r\n            request,\r\n          })\r\n          cookiesToSet.forEach(({ name, value, options }) =>\r\n            supabaseResponse.cookies.set(name, value, options)\r\n          )\r\n        },\r\n      },\r\n    }\r\n  )\r\n\r\n  try {\r\n    // Skip middleware for static files, API routes, and public pages\r\n    if (\r\n      pathname.startsWith('/_next/static') ||\r\n      pathname.startsWith('/_next/image') ||\r\n      pathname.startsWith('/favicon.ico') ||\r\n      pathname.startsWith('/api/') ||\r\n      pathname === '/auth/callback' ||\r\n      pathname.match(/\\.(svg|png|jpg|jpeg|gif|webp)$/)\r\n    ) {\r\n      return supabaseResponse\r\n    }\r\n\r\n    // =========================================================================\r\n    // LEGACY URL REDIRECTS (301 Permanent)\r\n    // Phase 2 migration: Old portal URLs ‚Üí New unified portal URLs\r\n    // =========================================================================\r\n\r\n    // Helper to create 301 redirect preserving query params\r\n    const createLegacyRedirect = (newPath: string) => {\r\n      const url = new URL(request.url)\r\n      url.pathname = newPath\r\n      return NextResponse.redirect(url, { status: 301 })\r\n    }\r\n\r\n    // --- Investor Portal Redirects (/versoholdings/* ‚Üí /versotech_main/*) ---\r\n\r\n    // Login/Auth\r\n    if (pathname === '/versoholdings/login') {\r\n      return createLegacyRedirect('/versotech_main/login')\r\n    }\r\n    if (pathname === '/versoholdings/set-password') {\r\n      return createLegacyRedirect('/versotech_main/set-password')\r\n    }\r\n\r\n    // Dashboard\r\n    if (pathname === '/versoholdings/dashboard') {\r\n      return createLegacyRedirect('/versotech_main/dashboard')\r\n    }\r\n\r\n    // Deals ‚Üí Opportunities (renamed)\r\n    if (pathname === '/versoholdings/deals') {\r\n      return createLegacyRedirect('/versotech_main/opportunities')\r\n    }\r\n    // Dynamic deal route\r\n    if (pathname.match(/^\\/versoholdings\\/deal\\/([^/]+)$/)) {\r\n      const dealId = pathname.split('/')[3]\r\n      return createLegacyRedirect(`/versotech_main/opportunities/${dealId}`)\r\n    }\r\n\r\n    // Data Rooms ‚Üí Opportunities (integrated)\r\n    if (pathname === '/versoholdings/data-rooms') {\r\n      return createLegacyRedirect('/versotech_main/opportunities')\r\n    }\r\n    if (pathname.match(/^\\/versoholdings\\/data-rooms\\/([^/]+)$/)) {\r\n      const dealId = pathname.split('/')[3]\r\n      return createLegacyRedirect(`/versotech_main/opportunities/${dealId}`)\r\n    }\r\n\r\n    // Holdings ‚Üí Portfolio (renamed)\r\n    if (pathname === '/versoholdings/holdings') {\r\n      return createLegacyRedirect('/versotech_main/portfolio')\r\n    }\r\n    // Vehicle detail ‚Üí Portfolio detail\r\n    if (pathname.match(/^\\/versoholdings\\/vehicle\\/([^/]+)$/)) {\r\n      const vehicleId = pathname.split('/')[3]\r\n      return createLegacyRedirect(`/versotech_main/portfolio/${vehicleId}`)\r\n    }\r\n\r\n    // Tasks/Notifications ‚Üí Dashboard (moved to header)\r\n    if (pathname === '/versoholdings/tasks') {\r\n      return createLegacyRedirect('/versotech_main/tasks')\r\n    }\r\n    if (pathname === '/versoholdings/notifications') {\r\n      return createLegacyRedirect('/versotech_main/notifications')\r\n    }\r\n\r\n    // Messages ‚Üí Inbox\r\n    if (pathname === '/versoholdings/messages') {\r\n      return createLegacyRedirect('/versotech_main/messages')\r\n    }\r\n\r\n    // Reports ‚Üí Documents (renamed)\r\n    if (pathname === '/versoholdings/reports') {\r\n      return createLegacyRedirect('/versotech_main/documents')\r\n    }\r\n    if (pathname === '/versoholdings/documents') {\r\n      return createLegacyRedirect('/versotech_main/documents')\r\n    }\r\n\r\n    // Profile\r\n    if (pathname === '/versoholdings/profile') {\r\n      return createLegacyRedirect('/versotech_main/profile')\r\n    }\r\n\r\n    // --- Staff Portal Redirects (/versotech/staff/* ‚Üí /versotech_main/*) ---\r\n\r\n    // Login\r\n    if (pathname === '/versotech/login') {\r\n      return createLegacyRedirect('/versotech_main/login')\r\n    }\r\n\r\n    // Staff dashboard\r\n    if (pathname === '/versotech/staff' || pathname === '/versotech/staff/') {\r\n      return createLegacyRedirect('/versotech_main/dashboard')\r\n    }\r\n\r\n    // Deals management\r\n    if (pathname === '/versotech/staff/deals') {\r\n      return createLegacyRedirect('/versotech_main/deals')\r\n    }\r\n    if (pathname === '/versotech/staff/deals/new') {\r\n      return createLegacyRedirect('/versotech_main/deals/new')\r\n    }\r\n    if (pathname.match(/^\\/versotech\\/staff\\/deals\\/([^/]+)$/)) {\r\n      const dealId = pathname.split('/')[4]\r\n      return createLegacyRedirect(`/versotech_main/deals/${dealId}`)\r\n    }\r\n\r\n    // Investors management ‚Üí Users with type filter\r\n    if (pathname === '/versotech/staff/investors') {\r\n      const url = new URL(request.url)\r\n      url.pathname = '/versotech_main/investors'\r\n      return NextResponse.redirect(url, { status: 301 })\r\n    }\r\n    if (pathname.match(/^\\/versotech\\/staff\\/investors\\/([^/]+)$/)) {\r\n      const investorId = pathname.split('/')[4]\r\n      const url = new URL(request.url)\r\n      url.pathname = `/versotech_main/investors/${investorId}`\r\n      return NextResponse.redirect(url, { status: 301 })\r\n    }\r\n\r\n    // Arrangers management\r\n    if (pathname === '/versotech/staff/arrangers') {\r\n      return createLegacyRedirect('/versotech_main/arrangers')\r\n    }\r\n    if (pathname.match(/^\\/versotech\\/staff\\/arrangers\\/([^/]+)$/)) {\r\n      const arrangerId = pathname.split('/')[4]\r\n      return createLegacyRedirect(`/versotech_main/arrangers/${arrangerId}`)\r\n    }\r\n\r\n    // Introducers management\r\n    if (pathname === '/versotech/staff/introducers') {\r\n      return createLegacyRedirect('/versotech_main/introducers')\r\n    }\r\n    if (pathname.match(/^\\/versotech\\/staff\\/introducers\\/([^/]+)$/)) {\r\n      const introducerId = pathname.split('/')[4]\r\n      return createLegacyRedirect(`/versotech_main/introducers/${introducerId}`)\r\n    }\r\n\r\n    // Approvals ‚Üí Inbox with tab\r\n    if (pathname === '/versotech/staff/approvals') {\r\n      const url = new URL(request.url)\r\n      url.pathname = '/versotech_main/approvals'\r\n      return NextResponse.redirect(url, { status: 301 })\r\n    }\r\n\r\n    // Messages ‚Üí Inbox with tab\r\n    if (pathname === '/versotech/staff/messages') {\r\n      return createLegacyRedirect('/versotech_main/messages')\r\n    }\r\n\r\n    // Fees\r\n    if (pathname === '/versotech/staff/fees') {\r\n      return createLegacyRedirect('/versotech_main/fees')\r\n    }\r\n\r\n    // KYC Review\r\n    if (pathname === '/versotech/staff/kyc-review') {\r\n      return createLegacyRedirect('/versotech_main/kyc-review')\r\n    }\r\n\r\n    // VersoSign\r\n    if (pathname === '/versotech/staff/versosign') {\r\n      return createLegacyRedirect('/versotech_main/versosign')\r\n    }\r\n\r\n    // Audit\r\n    if (pathname === '/versotech/staff/audit') {\r\n      return createLegacyRedirect('/versotech_main/audit')\r\n    }\r\n\r\n    // Reconciliation\r\n    if (pathname === '/versotech/staff/reconciliation') {\r\n      return createLegacyRedirect('/versotech_main/reconciliation')\r\n    }\r\n\r\n    // Subscriptions\r\n    if (pathname === '/versotech/staff/subscriptions') {\r\n      return createLegacyRedirect('/versotech_main/subscriptions')\r\n    }\r\n    if (pathname === '/versotech/staff/subscriptions/vehicle-summary') {\r\n      return createLegacyRedirect('/versotech_main/subscriptions/vehicle-summary')\r\n    }\r\n\r\n    // Documents\r\n    if (pathname === '/versotech/staff/documents') {\r\n      return createLegacyRedirect('/versotech_main/documents')\r\n    }\r\n\r\n    // Entities\r\n    if (pathname === '/versotech/staff/entities') {\r\n      return createLegacyRedirect('/versotech_main/entities')\r\n    }\r\n    if (pathname.match(/^\\/versotech\\/staff\\/entities\\/([^/]+)$/)) {\r\n      const entityId = pathname.split('/')[4]\r\n      return createLegacyRedirect(`/versotech_main/entities/${entityId}`)\r\n    }\r\n\r\n    // Calendar\r\n    if (pathname === '/versotech/staff/calendar') {\r\n      return createLegacyRedirect('/versotech_main/calendar')\r\n    }\r\n\r\n    // Admin ‚Üí Admin portal\r\n    if (pathname === '/versotech/staff/admin') {\r\n      return createLegacyRedirect('/versotech_main/admin')\r\n    }\r\n\r\n    // Processes\r\n    if (pathname === '/versotech/staff/processes') {\r\n      return createLegacyRedirect('/versotech_admin/processes')\r\n    }\r\n\r\n    // =========================================================================\r\n    // END LEGACY URL REDIRECTS\r\n    // =========================================================================\r\n\r\n    // Skip auth check if there's a confirmation code - let the client handle it\r\n    const searchParams = request.nextUrl.searchParams\r\n    const code = searchParams.get('code')\r\n    const error = searchParams.get('error')\r\n\r\n    if (code || error) {\r\n      console.log('[middleware] Auth code/error detected, skipping auth check:', { code: code?.substring(0, 8) + '...', error })\r\n\r\n      // If there's an error param (like session_expired), clear cookies to prevent loops\r\n      if (error) {\r\n        console.log('[middleware] Clearing cookies due to error param:', error)\r\n\r\n        // Redirect to same URL without error param to break the cycle\r\n        const cleanUrl = new URL(request.url)\r\n        cleanUrl.searchParams.delete('error')\r\n        cleanUrl.searchParams.delete('code')\r\n\r\n        const response = NextResponse.redirect(cleanUrl)\r\n\r\n        // Delete Supabase auth cookies using correct names (project-specific)\r\n        // NEW production database: kagzryotbbnusdcyvqei\r\n        response.cookies.delete('sb-kagzryotbbnusdcyvqei-auth-token')\r\n        response.cookies.delete('sb-kagzryotbbnusdcyvqei-auth-token-code-verifier')\r\n\r\n        // Also set to empty as fallback\r\n        response.cookies.set('sb-kagzryotbbnusdcyvqei-auth-token', '', {\r\n          maxAge: 0,\r\n          path: '/'\r\n        })\r\n        response.cookies.set('sb-kagzryotbbnusdcyvqei-auth-token-code-verifier', '', {\r\n          maxAge: 0,\r\n          path: '/'\r\n        })\r\n\r\n        return response\r\n      }\r\n\r\n      return supabaseResponse\r\n    }\r\n\r\n    // Public routes that don't require authentication\r\n    const publicRoutes = [\r\n      '/',\r\n      '/versoholdings/login',\r\n      '/versotech/login',\r\n      '/versotech_main/login',\r\n      '/versotech_main/set-password',\r\n      '/versotech_main/reset-password',\r\n      '/logout',\r\n      '/invitation/accept'  // Allow unauthenticated access for new user invitations\r\n    ]\r\n\r\n    const isPublicRoute = publicRoutes.includes(pathname) || pathname.startsWith('/sign/')\r\n    const isLoginRoute = pathname === '/versoholdings/login' || pathname === '/versotech/login' || pathname === '/versotech_main/login'\r\n\r\n    // Step 1: Use getUser() for authenticated validation (recommended by Supabase)\r\n    // This contacts the Supabase Auth server to validate the session, ensuring authenticity\r\n    let user = null\r\n    let authError = null\r\n\r\n    const { data: { user: validatedUser }, error: userError } = await supabase.auth.getUser()\r\n\r\n    if (userError) {\r\n      // Check if token needs refresh\r\n      if (userError.message?.includes('token') || userError.message?.includes('expired')) {\r\n        console.log('[middleware] Token validation failed, attempting refresh...')\r\n\r\n        // Attempt to refresh the session with retry logic for transient failures\r\n        let refreshAttempts = 0\r\n        let refreshedSession = null\r\n        let refreshError = null\r\n\r\n        while (refreshAttempts < 3) {\r\n          const { data, error } = await supabase.auth.refreshSession()\r\n\r\n          if (!error && data.session) {\r\n            refreshedSession = data.session\r\n            console.log('[middleware] Token refreshed successfully',\r\n              refreshAttempts > 0 ? `(after ${refreshAttempts + 1} attempts)` : '')\r\n            break\r\n          }\r\n\r\n          refreshError = error\r\n          refreshAttempts++\r\n\r\n          // Don't retry on permanent errors\r\n          if (error?.message?.includes('Invalid Refresh Token') ||\r\n              error?.message?.includes('already been used')) {\r\n            console.warn('[middleware] Permanent refresh error, not retrying:', error.message)\r\n            break\r\n          }\r\n\r\n          if (refreshAttempts < 3) {\r\n            console.warn(`[middleware] Token refresh attempt ${refreshAttempts} failed, retrying...`, error?.message)\r\n            // Exponential backoff: 100ms, 200ms, 400ms\r\n            await new Promise(resolve => setTimeout(resolve, 100 * Math.pow(2, refreshAttempts - 1)))\r\n          }\r\n        }\r\n\r\n        if (refreshError) {\r\n          console.warn('[middleware] Token refresh failed after retries:', refreshError.message)\r\n          authError = refreshError\r\n        } else if (refreshedSession) {\r\n          user = refreshedSession.user\r\n        }\r\n      } else {\r\n        console.warn('[middleware] User validation failed:', userError.message)\r\n        authError = userError\r\n      }\r\n    } else {\r\n      user = validatedUser\r\n    }\r\n\r\n    // Step 4: Handle authentication failure\r\n    const isRefreshTokenError = authError && (\r\n      authError.message?.includes('refresh') ||\r\n      authError.message?.includes('Invalid Refresh Token') ||\r\n      authError.message?.includes('already been used')\r\n    )\r\n\r\n    if (isRefreshTokenError && authError) {\r\n      console.log('[middleware] Refresh token error detected, clearing session:', authError.message)\r\n      // TODO: Add monitoring/alerting here for production - this should be RARE with the fixes\r\n      // Example: Sentry.captureException(authError, { tags: { type: 'refresh_token_already_used' } })\r\n      // Clear the invalid session\r\n      await supabase.auth.signOut({ scope: 'local' })\r\n\r\n      // Only redirect if not already on a public route\r\n      if (!isPublicRoute) {\r\n        const response = NextResponse.redirect(\r\n          new URL('/versotech_main/login?error=session_expired', request.url)\r\n        )\r\n        // NEW production database: kagzryotbbnusdcyvqei\r\n        response.cookies.delete('sb-kagzryotbbnusdcyvqei-auth-token')\r\n        response.cookies.delete('sb-kagzryotbbnusdcyvqei-auth-token-code-verifier')\r\n        response.cookies.set('sb-kagzryotbbnusdcyvqei-auth-token', '', { maxAge: 0, path: '/' })\r\n        response.cookies.set('sb-kagzryotbbnusdcyvqei-auth-token-code-verifier', '', { maxAge: 0, path: '/' })\r\n        return response\r\n      }\r\n    }\r\n\r\n    if (authError || !user) {\r\n      if (isPublicRoute) {\r\n        const response = NextResponse.next({\r\n          request,\r\n        })\r\n\r\n        if (isLoginRoute) {\r\n          // NEW production database: kagzryotbbnusdcyvqei\r\n          response.cookies.delete('sb-kagzryotbbnusdcyvqei-auth-token')\r\n          response.cookies.delete('sb-kagzryotbbnusdcyvqei-auth-token-code-verifier')\r\n          response.cookies.set('sb-kagzryotbbnusdcyvqei-auth-token', '', { maxAge: 0, path: '/' })\r\n          response.cookies.set('sb-kagzryotbbnusdcyvqei-auth-token-code-verifier', '', { maxAge: 0, path: '/' })\r\n        }\r\n\r\n        return response\r\n      }\r\n\r\n      console.log('[auth] Authentication failed:', authError?.message || 'No user found')\r\n\r\n      // Unified login - all unauthenticated users go to the same login\r\n      const redirectUrl = new URL('/versotech_main/login?error=auth_required', request.url)\r\n\r\n      const response = NextResponse.redirect(redirectUrl)\r\n\r\n      // NEW production database: kagzryotbbnusdcyvqei\r\n      response.cookies.delete('sb-kagzryotbbnusdcyvqei-auth-token')\r\n      response.cookies.delete('sb-kagzryotbbnusdcyvqei-auth-token-code-verifier')\r\n      response.cookies.set('sb-kagzryotbbnusdcyvqei-auth-token', '', { maxAge: 0, path: '/' })\r\n      response.cookies.set('sb-kagzryotbbnusdcyvqei-auth-token-code-verifier', '', { maxAge: 0, path: '/' })\r\n\r\n      return response\r\n    }\r\n\r\n    console.log('üîç User authenticated:', {\r\n      userId: user.id,\r\n      email: user.email,\r\n      pathname: pathname\r\n    })\r\n\r\n    if (isPublicRoute) {\r\n      return supabaseResponse\r\n    }\r\n\r\n\r\n    // This check is now handled above - user is guaranteed to exist here\r\n\r\n    // Get user profile for role-based access control\r\n    const { data: profile, error: profileError } = await supabase\r\n      .from('profiles')\r\n      .select('*')\r\n      .eq('id', user.id)\r\n      .single()\r\n\r\n    // Handle profile fetch errors - distinguish between permanent and transient failures\r\n    if (profileError || !profile) {\r\n      // PGRST116 = Profile record not found (permanent error - user needs to be signed out)\r\n      if (profileError?.code === 'PGRST116' || !profile) {\r\n        console.error('[auth] Profile not found for authenticated user (permanent error):', {\r\n          userId: user.id,\r\n          error: profileError\r\n        })\r\n        await supabase.auth.signOut()\r\n\r\n        // Redirect to unified login\r\n        return NextResponse.redirect(new URL('/versotech_main/login?error=profile_not_found', request.url))\r\n      } else {\r\n        // Transient database error (connection timeout, etc.) - return 500, don't sign out\r\n        console.error('[auth] Transient database error fetching profile:', {\r\n          userId: user.id,\r\n          error: profileError,\r\n          errorCode: profileError?.code\r\n        })\r\n        // TODO: Add monitoring/alerting here for production\r\n        // Example: Sentry.captureException(profileError, { tags: { type: 'profile_fetch_failure' } })\r\n\r\n        return NextResponse.json(\r\n          { error: 'Database error. Please try again.' },\r\n          { status: 500 }\r\n        )\r\n      }\r\n    }\r\n\r\n    const effectiveProfile = profile\r\n\r\n    // =========================================================================\r\n    // ROLE-BASED & PERSONA-BASED ACCESS CONTROL\r\n    // =========================================================================\r\n    // Architecture:\r\n    // - MIDDLEWARE: Handles authentication and persona-based route access\r\n    // - LAYOUTS: Still enforce persona requirements and load full persona context\r\n    //   - versotech_main/layout.tsx: Requires at least one persona\r\n    //   - versotech_admin/layout.tsx: Requires CEO persona (staff + role_in_entity='ceo')\r\n    // - SIDEBAR: Filters navigation items by active persona (users only see relevant routes)\r\n    // - DATA QUERIES: Filter by actual entity relationships (security layer)\r\n    //\r\n    // This separation ensures:\r\n    // 1. Fast middleware (no persona DB calls)\r\n    // 2. Clean authorization in layouts (one place to maintain)\r\n    // 3. Defense in depth (data queries enforce final access)\r\n    // =========================================================================\r\n\r\n    const isUnifiedRoute = pathname.startsWith('/versotech_main')\r\n    const isAdminRoute = pathname.startsWith('/versotech_admin')\r\n\r\n    let personaTypes = new Set<string>()\r\n    let isCEO = false\r\n    const isProfileCEO = effectiveProfile.role === 'ceo' || effectiveProfile.role === 'staff_admin'\r\n\r\n    if (isUnifiedRoute || isAdminRoute) {\r\n      const { data: personas, error: personaError } = await supabase.rpc('get_user_personas', {\r\n        p_user_id: user.id\r\n      })\r\n\r\n      if (personaError) {\r\n        console.warn('[middleware] Persona lookup failed, falling back to profile role:', personaError.message)\r\n      } else if (Array.isArray(personas)) {\r\n        personaTypes = new Set(personas.map((persona: any) => persona.persona_type))\r\n        // isCEO grants access to CEO-only sections (/versotech_admin, sensitive reports, etc.)\r\n        // DESIGN DECISION: Both 'ceo' persona AND 'staff_admin' role get CEO-level access.\r\n        // This is intentional - staff_admin users are system administrators who need\r\n        // full platform access. If stricter separation is needed in the future,\r\n        // create a separate 'isSystemAdmin' check or restrict staff_admin from this check.\r\n        isCEO = personas.some(\r\n          (persona: any) =>\r\n            persona.persona_type === 'ceo' ||  // CEO persona type\r\n            (persona.persona_type === 'staff' && persona.role_in_entity === 'staff_admin')  // staff_admin also gets CEO access\r\n        )\r\n      }\r\n\r\n      if (personaTypes.size === 0) {\r\n        const roleToPersona: Record<string, string> = {\r\n          investor: 'investor',\r\n          arranger: 'arranger',\r\n          introducer: 'introducer',\r\n          partner: 'partner',\r\n          commercial_partner: 'commercial_partner',\r\n          lawyer: 'lawyer',\r\n          ceo: 'staff',\r\n          staff_admin: 'staff',\r\n          staff_ops: 'staff',\r\n          staff_rm: 'staff',\r\n        }\r\n\r\n        const fallbackPersona = roleToPersona[effectiveProfile.role]\r\n        if (fallbackPersona) {\r\n          personaTypes.add(fallbackPersona)\r\n        }\r\n        // CEO fallback: ceo or staff_admin role\r\n        if (effectiveProfile.role === 'ceo' || effectiveProfile.role === 'staff_admin') {\r\n          isCEO = true\r\n        }\r\n      }\r\n\r\n      if (isProfileCEO) {\r\n        isCEO = true\r\n        personaTypes.add('ceo')\r\n      }\r\n\r\n      if (personaTypes.size === 0) {\r\n        return NextResponse.redirect(new URL('/versotech_main/login?error=no_personas', request.url))\r\n      }\r\n\r\n      supabaseResponse.cookies.set(\r\n        'verso_personas',\r\n        JSON.stringify({ types: Array.from(personaTypes), isCEO }),\r\n        { httpOnly: true, sameSite: 'lax', path: '/' }\r\n      )\r\n\r\n      const hasPersona = (personaType: string) => personaTypes.has(personaType)\r\n      const hasAnyPersona = (allowed: string[]) => allowed.some((type) => personaTypes.has(type))\r\n\r\n      const matchesPrefix = (prefixes: string[]) => prefixes.some((prefix) => pathname.startsWith(prefix))\r\n\r\n      const ceoOnlyPaths = [\r\n        '/versotech_admin',\r\n        '/versotech_main/kyc-review',\r\n        '/versotech_main/fees',\r\n        '/versotech_main/reconciliation',\r\n        '/versotech_main/audit',\r\n        '/versotech_main/users',\r\n        '/versotech_main/admin',\r\n      ]\r\n\r\n      const staffPaths = [\r\n        '/versotech_main/deals',\r\n        '/versotech_main/subscriptions',\r\n        '/versotech_main/investors',\r\n        '/versotech_main/entities',\r\n        '/versotech_main/approvals',\r\n        '/versotech_main/requests',\r\n        '/versotech_main/introducers',\r\n        '/versotech_main/arrangers',\r\n      ]\r\n\r\n      const investorAccessPaths = [\r\n        '/versotech_main/opportunities',\r\n        '/versotech_main/portfolio',\r\n      ]\r\n\r\n      const arrangerPaths = [\r\n        '/versotech_main/my-mandates',\r\n        '/versotech_main/my-partners',\r\n        '/versotech_main/my-introducers',\r\n        '/versotech_main/my-commercial-partners',\r\n        '/versotech_main/my-lawyers',\r\n        '/versotech_main/fee-plans',\r\n        '/versotech_main/payment-requests',\r\n        '/versotech_main/arranger-profile',\r\n      ]\r\n\r\n      const introducerPaths = [\r\n        '/versotech_main/introductions',\r\n        '/versotech_main/introducer-agreements',\r\n      ]\r\n\r\n      const partnerPaths = [\r\n        '/versotech_main/partner-transactions',\r\n        '/versotech_main/shared-transactions',\r\n      ]\r\n\r\n      const commercialPartnerPaths = [\r\n        '/versotech_main/client-transactions',\r\n        '/versotech_main/placement-agreements',\r\n      ]\r\n\r\n      const lawyerPaths = [\r\n        '/versotech_main/assigned-deals',\r\n      ]\r\n\r\n      // Paths accessible by both lawyers and arrangers\r\n      const lawyerAndArrangerPaths = [\r\n        '/versotech_main/escrow',\r\n        '/versotech_main/subscription-packs',\r\n        '/versotech_main/lawyer-reconciliation',\r\n      ]\r\n\r\n      if (matchesPrefix(ceoOnlyPaths) && !isCEO) {\r\n        return NextResponse.redirect(new URL('/versotech_main/dashboard', request.url))\r\n      }\r\n\r\n      // CEO users have full access to staff paths (they have 'ceo' persona, not 'staff')\r\n      if (matchesPrefix(staffPaths) && !hasAnyPersona(['staff', 'ceo'])) {\r\n        return NextResponse.redirect(new URL('/versotech_main/dashboard', request.url))\r\n      }\r\n\r\n      // Allow all personas that need to view opportunities/deals:\r\n      // - investors, partners, introducers, commercial_partners (core investor personas)\r\n      // - lawyers (need to view deals for escrow/compliance)\r\n      // - arrangers (need to view deals they're managing)\r\n      if (matchesPrefix(investorAccessPaths) && !hasAnyPersona(['investor', 'partner', 'introducer', 'commercial_partner', 'lawyer', 'arranger'])) {\r\n        return NextResponse.redirect(new URL('/versotech_main/dashboard', request.url))\r\n      }\r\n\r\n      if (matchesPrefix(arrangerPaths) && !hasPersona('arranger')) {\r\n        return NextResponse.redirect(new URL('/versotech_main/dashboard', request.url))\r\n      }\r\n\r\n      if (matchesPrefix(introducerPaths) && !hasAnyPersona(['introducer', 'staff', 'ceo'])) {\r\n        return NextResponse.redirect(new URL('/versotech_main/dashboard', request.url))\r\n      }\r\n\r\n      if (matchesPrefix(partnerPaths) && !hasPersona('partner')) {\r\n        return NextResponse.redirect(new URL('/versotech_main/dashboard', request.url))\r\n      }\r\n\r\n      if (matchesPrefix(commercialPartnerPaths) && !hasPersona('commercial_partner')) {\r\n        return NextResponse.redirect(new URL('/versotech_main/dashboard', request.url))\r\n      }\r\n\r\n      if (matchesPrefix(lawyerPaths) && !hasPersona('lawyer')) {\r\n        return NextResponse.redirect(new URL('/versotech_main/dashboard', request.url))\r\n      }\r\n\r\n      if (matchesPrefix(lawyerAndArrangerPaths) && !hasAnyPersona(['lawyer', 'arranger'])) {\r\n        return NextResponse.redirect(new URL('/versotech_main/dashboard', request.url))\r\n      }\r\n\r\n      console.log(`‚úÖ Access granted (persona-checked): ${user.email} ‚Üí ${pathname}`)\r\n      return supabaseResponse\r\n    }\r\n\r\n    // LEGACY: Old investor portal routes\r\n    if (pathname.startsWith('/versoholdings') && effectiveProfile.role !== 'investor') {\r\n      // Staff user trying to access investor portal\r\n      if (['staff_admin', 'staff_ops', 'staff_rm', 'ceo'].includes(effectiveProfile.role)) {\r\n        return NextResponse.redirect(new URL('/versotech/staff', request.url))\r\n      }\r\n      // Unknown role, redirect to investor login\r\n      return NextResponse.redirect(new URL('/versoholdings/login', request.url))\r\n    }\r\n\r\n    // LEGACY: Old staff portal routes\r\n    // CRITICAL FIX: Use '/versotech/' (with trailing slash) to avoid matching '/versotech_main/*'\r\n    // The old check used '/versotech' which incorrectly matched '/versotech_main/dashboard' because\r\n    // '/versotech_main'.startsWith('/versotech') === true\r\n    if (pathname.startsWith('/versotech/staff') || (pathname.startsWith('/versotech/') && !pathname.startsWith('/versotech/login'))) {\r\n      // Only staff roles can access staff portal\r\n      if (!['staff_admin', 'staff_ops', 'staff_rm', 'ceo'].includes(effectiveProfile.role)) {\r\n        return NextResponse.redirect(new URL('/versoholdings/dashboard', request.url))\r\n      }\r\n    }\r\n\r\n    console.log(`‚úÖ Access granted: ${user.email} (${effectiveProfile.role}) ‚Üí ${pathname}`)\r\n    return supabaseResponse\r\n\r\n  } catch (error) {\r\n    console.error('Middleware error:', error)\r\n    // On error, redirect to login WITH error indicator so we can debug\r\n    const errorMessage = error instanceof Error ? error.message : 'unknown'\r\n    console.error('Middleware error details:', errorMessage)\r\n    return NextResponse.redirect(new URL(`/versotech_main/login?error=middleware_error&detail=${encodeURIComponent(errorMessage.substring(0, 100))}`, request.url))\r\n  }\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',\r\n  ],\r\n}\r\n"],"names":[],"mappings":"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"}}]
}