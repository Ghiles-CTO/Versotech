(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,564153,e=>{"use strict";let t=(0,e.i(410587).default)("check-check",[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]]);e.s(["CheckCheck",()=>t],564153)},804306,501328,135771,607730,715898,e=>{"use strict";var t=e.i(59178);async function s(e){let t=new URLSearchParams;e.visibility&&t.set("visibility",e.visibility),e.type&&t.set("type",e.type),e.unreadOnly&&t.set("unread","true"),e.search&&t.set("search",e.search),e.dealId&&t.set("dealId",e.dealId),"number"==typeof e.limit&&t.set("limit",String(e.limit)),"number"==typeof e.offset&&t.set("offset",String(e.offset)),!1===e.includeMessages&&t.set("includeMessages","false");let s=await fetch(`/api/conversations?${t.toString()}`,{cache:"no-store"});if(!s.ok){let e=await s.json().catch(()=>null);throw Error(e?.error||"Failed to load conversations")}let a=await s.json();return{conversations:a.conversations,total:a.pagination.total,limit:a.pagination.limit,offset:a.pagination.offset,hasMore:a.pagination.has_more}}function a(e){let t=Array.isArray(e?.conversation_participants)?e.conversation_participants.map(e=>{let t=e?.profiles||{};return{id:t.id||e.user_id,displayName:t.display_name||t.email||null,email:t.email||null,role:t.role||null,avatarUrl:t.avatar_url??null,participantRole:e?.participant_role??"member",joinedAt:e?.joined_at,lastReadAt:e?.last_read_at??null,lastNotifiedAt:e?.last_notified_at??null,isMuted:e?.is_muted??!1,isPinned:e?.is_pinned??!1}}):[],s=Array.isArray(e?.messages)?e.messages[0]:null,a=s?i(s):null;return{id:e.id,subject:e.subject??null,preview:e.preview??null,type:e.type??"dm",visibility:e.visibility??"internal",ownerTeam:e.owner_team??null,dealId:e.deal_id??null,createdBy:e.created_by??null,createdAt:e.created_at,updatedAt:e.updated_at,lastMessageAt:e.last_message_at??null,lastMessageId:e.last_message_id??null,archivedAt:e.archived_at??null,metadata:e.metadata??{},participants:t,unreadCount:e.unreadCount??0,latestMessage:a,participantCount:t.length}}async function r(e,t={}){let s=new URLSearchParams;"number"==typeof t.limit&&s.set("limit",String(t.limit)),"number"==typeof t.offset&&s.set("offset",String(t.offset));let a=await fetch(`/api/conversations/${e}/messages?${s.toString()}`);if(!a.ok){let e=await a.json().catch(()=>null);throw Error(e?.error||"Failed to fetch messages")}return(await a.json()).messages}async function l(e){await fetch(`/api/conversations/${e}/read`,{method:"POST"})}function n(e,s){let a=(0,t.createClient)(),r=a.channel(`conversation-${e}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${e}`},e=>{"INSERT"===e.eventType&&s.onMessage?.(i(e.new)),s.onUpdate?.()}).on("postgres_changes",{event:"*",schema:"public",table:"conversation_participants",filter:`conversation_id=eq.${e}`},e=>{s.onUpdate?.()}).subscribe();return()=>{a.removeChannel(r)}}function i(e){let t=e.sender;return{id:e.id,conversationId:e.conversation_id,senderId:e.sender_id,body:e.body??null,messageType:e.message_type??"text",fileKey:e.file_key??null,replyToMessageId:e.reply_to_message_id??null,metadata:e.metadata??{},createdAt:e.created_at,editedAt:e.edited_at??null,deletedAt:e.deleted_at??null,sender:t?{id:t.id??null,displayName:t.displayName??t.display_name??null,email:t.email??null,role:t.role??null,avatarUrl:t.avatarUrl??t.avatar_url??null}:null,readBy:Array.isArray(e.read_by)?e.read_by:[]}}function o(e,t){return e.filter(e=>{if("all"!==t.type&&e.type!==t.type||"all"!==t.visibility&&e.visibility!==t.visibility||t.dealId&&e.dealId!==t.dealId||t.unreadOnly&&(!e.unreadCount||0===e.unreadCount))return!1;if(t.search){let s=t.search.toLowerCase(),a=[];if(e.subject&&a.push(e.subject),e.preview&&a.push(e.preview),e.ownerTeam&&a.push(e.ownerTeam),e.participants.forEach(e=>{e.displayName&&a.push(e.displayName),e.email&&a.push(e.email)}),!a.some(e=>e.toLowerCase().includes(s)))return!1}return!0})}function d(e){return[...e].sort((e,t)=>{let s=e.lastMessageAt?new Date(e.lastMessageAt).getTime():new Date(e.createdAt).getTime();return(t.lastMessageAt?new Date(t.lastMessageAt).getTime():new Date(t.createdAt).getTime())-s})}function c(e){let t=new Date,s=new Date(e),a=Math.floor((t.getTime()-s.getTime())/1e3);if(a<60)return"Just now";if(a<3600){let e=Math.floor(a/60);return`${e}m ago`}if(a<86400){let e=Math.floor(a/3600);return`${e}h ago`}let r=new Date(t);if(r.setDate(r.getDate()-1),s.toDateString()===r.toDateString())return`Yesterday at ${s.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}`;if(a<604800){let e=Math.floor(a/86400);return`${e}d ago`}return s.toLocaleDateString("en-US",{month:"short",day:"numeric",year:s.getFullYear()!==t.getFullYear()?"numeric":void 0})}function u(e){return new Date(e).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}function m(e,t=5){if(0===e.length)return[];let s=[];for(let a=0;a<e.length;a++){let r=e[a],l=a>0?e[a-1]:null,n=a<e.length-1?e[a+1]:null,i=l&&l.senderId===r.senderId&&!l.deletedAt&&!r.deletedAt&&new Date(r.createdAt).getTime()-new Date(l.createdAt).getTime()<60*t*1e3,o=n&&n.senderId===r.senderId&&!n.deletedAt&&!r.deletedAt&&new Date(n.createdAt).getTime()-new Date(r.createdAt).getTime()<60*t*1e3;s.push({...r,isGroupStart:!i,isGroupEnd:!o,showAvatar:!i,showTimestamp:!o})}return s}function h(e){if(!e)return"?";let t=e.trim().split(" ");return t.length>=2?`${t[0][0]}${t[1][0]}`.toUpperCase():e.substring(0,2).toUpperCase()}function g(e,t){return e.length<=t?e:e.substring(0,t).trim()+"…"}function x(e){let t=new Date(e),s=new Date,a=new Date(s);a.setDate(a.getDate()-1);let r=new Date(t.getFullYear(),t.getMonth(),t.getDate()),l=new Date(s.getFullYear(),s.getMonth(),s.getDate()),n=new Date(a.getFullYear(),a.getMonth(),a.getDate());return r.getTime()===l.getTime()?"Today":r.getTime()===n.getTime()?"Yesterday":7>Math.floor((l.getTime()-r.getTime())/864e5)?t.toLocaleDateString("en-US",{weekday:"long"}):t.toLocaleDateString("en-US",{month:"long",day:"numeric",year:t.getFullYear()!==s.getFullYear()?"numeric":void 0})}function p(e,t){if(!t)return!0;let s=new Date(e.createdAt),a=new Date(t.createdAt);return s.toDateString()!==a.toDateString()}e.s(["fetchConversationMessages",()=>r,"fetchConversationsClient",()=>s,"markConversationRead",()=>l,"normalizeConversation",()=>a,"subscribeToConversationUpdates",()=>n],501328),e.s(["applyConversationFilters",()=>o,"sortConversations",()=>d],135771),e.s(["formatFullTimestamp",()=>u,"formatRelativeTime",()=>c,"getDateDivider",()=>x,"getInitials",()=>h,"groupMessages",()=>m,"shouldShowDateDivider",()=>p,"truncateText",()=>g],607730),e.s([],804306);var f=e.i(722679),v=e.i(340915),b=e.i(74434),y=e.i(316264),j=e.i(282141),w=e.i(564153),N=e.i(310556),C=e.i(554369),S=e.i(415814);function k({message:e,senderName:t,senderEmail:s,senderAvatarUrl:a,isSelf:r,isGroupStart:l,isGroupEnd:n,showAvatar:i,showTimestamp:o,onDelete:d}){return e.deletedAt?(0,f.jsx)("div",{className:(0,j.cn)("flex items-center gap-2 py-1",r?"justify-end":"justify-start"),children:(0,f.jsx)("span",{className:"text-xs italic text-muted-foreground",children:"Message deleted"})}):(0,f.jsxs)(S.motion.div,{initial:{opacity:0,y:10,scale:.98},animate:{opacity:1,y:0,scale:1},transition:{duration:.25,ease:[.25,.1,.25,1]},className:(0,j.cn)("flex gap-2 group",r?"flex-row-reverse":"flex-row",!l&&"mt-0.5",l&&"mt-5"),children:[(0,f.jsx)("div",{className:(0,j.cn)("flex-shrink-0 self-end",!i&&"w-9"),children:i?(0,f.jsxs)(b.Avatar,{className:"h-9 w-9 border-2 border-background shadow-sm transition-transform duration-200 group-hover:scale-110",children:[a&&(0,f.jsx)(b.AvatarImage,{src:a,alt:t}),(0,f.jsx)(b.AvatarFallback,{className:"text-xs bg-muted text-foreground font-medium",children:h(t)})]}):null}),(0,f.jsxs)("div",{className:(0,j.cn)("flex flex-col gap-1 max-w-[75%] md:max-w-[65%] relative",r&&"items-end"),children:[r&&d&&!e.deletedAt&&(0,f.jsx)(y.Button,{variant:"ghost",size:"icon",className:"absolute -left-10 top-1 h-7 w-7 opacity-0 group-hover:opacity-100 transition-opacity text-muted-foreground hover:text-red-500",onClick:()=>d(e.id),children:(0,f.jsx)(C.Trash2,{className:"h-4 w-4"})}),l&&!r&&(0,f.jsx)("span",{className:"text-xs font-semibold text-foreground/80 px-2 mb-0.5",children:t}),(0,f.jsx)("div",{className:(0,j.cn)("relative px-3.5 py-2.5 rounded-lg text-[14px] leading-relaxed","transition-all duration-200 ease-out",r?"bg-primary text-primary-foreground shadow-md shadow-primary/20":"bg-card text-foreground border border-border shadow-sm","rounded-tl-2xl rounded-tr-2xl",r?"rounded-bl-2xl rounded-br-md":"rounded-bl-md rounded-br-2xl",l&&(r?"rounded-br-2xl":"rounded-bl-2xl"),"group-hover:shadow-xl group-hover:-translate-y-0.5",r?"group-hover:shadow-primary/30":"group-hover:shadow-lg","max-w-full"),title:u(e.createdAt),children:(0,f.jsxs)("div",{className:"flex flex-col",children:[(0,f.jsx)("p",{className:"whitespace-pre-wrap break-words",children:e.body}),(0,f.jsxs)("div",{className:(0,j.cn)("flex items-center gap-1 mt-1 justify-end select-none",r?"text-primary-foreground/60":"text-muted-foreground/70"),children:[e.editedAt&&(0,f.jsx)("span",{className:"text-[9px] italic mr-1",children:"Edited"}),(0,f.jsx)("span",{className:"text-[9px] font-medium",children:new Date(e.createdAt).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}),r&&(0,f.jsx)("span",{className:"ml-0.5",children:e.readBy&&e.readBy.length>0?(0,f.jsx)(w.CheckCheck,{className:"h-3.5 w-3.5"}):(0,f.jsx)(N.Check,{className:"h-3.5 w-3.5"})})]})]})})]})]})}function D({isSent:e=!1}){return(0,f.jsxs)("div",{className:(0,j.cn)("flex gap-3 animate-pulse",e?"justify-end":"justify-start"),children:[!e&&(0,f.jsx)("div",{className:"h-8 w-8 rounded-full bg-muted/60 shrink-0"}),(0,f.jsxs)("div",{className:(0,j.cn)("flex flex-col gap-2 max-w-[70%]",e?"items-end":"items-start"),children:[!e&&(0,f.jsx)("div",{className:"h-3 w-24 bg-muted/60 rounded"}),(0,f.jsx)("div",{className:(0,j.cn)("rounded-2xl bg-muted/60",e?"rounded-br-md":"rounded-bl-md","h-20 w-full min-w-[200px]")}),(0,f.jsx)("div",{className:"h-2 w-16 bg-muted/40 rounded"})]}),e&&(0,f.jsx)("div",{className:"h-8 w-8 rounded-full bg-muted/60 shrink-0"})]})}function M({isSent:e,count:t=3}){return(0,f.jsx)("div",{className:"space-y-4 p-4",children:Array.from({length:t}).map((t,s)=>(0,f.jsx)(D,{isSent:void 0!==e?e:s%2==0},s))})}let A=v.forwardRef(({className:e,onChange:t,...s},a)=>{let r=v.useRef(null),l=v.useCallback(()=>{let e=r.current;e&&(e.style.height="auto",e.style.height=`${e.scrollHeight}px`)},[]);v.useEffect(()=>{l()},[s.value,l]);let n=v.useCallback(e=>{r.current=e,"function"==typeof a?a(e):a&&(a.current=e)},[a]);return(0,f.jsx)("textarea",{ref:n,className:(0,j.cn)("flex min-h-[44px] max-h-[200px] w-full rounded-md border border-input","bg-background px-3 py-2 text-sm ring-offset-background","placeholder:text-muted-foreground","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2","disabled:cursor-not-allowed disabled:opacity-50","resize-none overflow-y-auto","transition-all duration-200 ease-out",e),onChange:e=>{l(),t?.(e)},...s})});A.displayName="AutoExpandTextarea";var _=e.i(907434),T=e.i(129432),I=e.i(932735),U=e.i(410587);let F=(0,U.default)("paperclip",[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]]);var E=e.i(64927),$=e.i(501259);let R=(0,U.default)("smile",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);var B=e.i(417439),L=e.i(510166),V=e.i(908925);function z({conversation:e,currentUserId:t,onRead:s,onError:a,onDelete:i}){let[o,d]=(0,v.useState)([]),[c,u]=(0,v.useState)(!0),[g,w]=(0,v.useState)(""),[N,S]=(0,v.useState)(!1),[D,U]=(0,v.useState)(!1),[z,O]=(0,v.useState)(null);(0,v.useRef)(null);let G=(0,v.useRef)(null);console.log("[ConversationView] Rendering with",o.length,"messages for conversation:",e.id);let P=async()=>{try{if(!(await fetch(`/api/conversations/${e.id}`,{method:"DELETE"})).ok)throw Error("Failed to delete conversation");i?.(e.id),U(!1)}catch(e){a?.(e.message||"Failed to delete conversation")}},Y=async t=>{try{if(!(await fetch(`/api/conversations/${e.id}/messages/${t}`,{method:"DELETE"})).ok)throw Error("Failed to delete message");d(e=>e.filter(e=>e.id!==t)),O(null)}catch(e){a?.(e.message||"Failed to delete message")}},q=(0,v.useMemo)(()=>{let s=new Map;return e.participants.forEach(e=>{e.id&&s.set(e.id,{name:e.displayName||e.email||"Unknown User",email:e.email})}),t&&!s.has(t)&&s.set(t,{name:"You",email:null}),s},[e.participants,t]),K=(0,v.useMemo)(()=>m(o),[o]);(0,v.useEffect)(()=>{console.log("[ConversationView] Auto-scroll triggered, messages:",o.length),o.length>0&&G.current&&(console.log("[ConversationView] Scrolling to bottom"),G.current.scrollIntoView({behavior:"smooth"}))},[o]),(0,v.useEffect)(()=>{let t=!0;return u(!0),d([]),r(e.id,{limit:200}).then(a=>{t&&(d(a),s?.(),l(e.id).catch(console.error))}).catch(e=>{console.error("Load messages error",e)}).finally(()=>{t&&u(!1)}),()=>{t=!1}},[e.id,s]);let H=async()=>{if(g.trim()){console.log("[ConversationView] Sending message:",g),S(!0);try{let t=await fetch(`/api/conversations/${e.id}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({body:g})});if(!t.ok){let e=await t.json().catch(()=>null);throw Error(e?.error||"Failed to send message")}let s=await t.json();console.log("[ConversationView] Message sent, adding optimistically:",s.message),s.message&&d(e=>e.some(e=>e.id===s.message.id)?e:[...e,s.message]),w("")}catch(e){console.error("[ConversationView] Send error:",e),a?.(e.message||"Failed to send message")}finally{S(!1)}}};return(0,v.useEffect)(()=>{console.log("[ConversationView] Setting up realtime for conversation:",e.id);let t=n(e.id,{onMessage:t=>{console.log("[ConversationView] Received new message from realtime:",t),d(e=>{if(console.log("[ConversationView] Current messages before add:",e.length),e.some(e=>e.id===t.id))return console.log("[ConversationView] Message already exists, skipping"),e;console.log("[ConversationView] Adding realtime message to list");let s=[...e,t];return console.log("[ConversationView] Messages after add:",s.length),s}),l(e.id).catch(console.error)}});return()=>{console.log("[ConversationView] Cleaning up realtime for conversation:",e.id),t()}},[e.id]),(0,f.jsxs)("div",{className:"flex-1 flex flex-col min-h-0",children:[(0,f.jsx)("header",{className:"relative z-10 border-b border-border bg-card px-6 py-4",children:(0,f.jsxs)("div",{className:"flex items-center justify-between",children:[(0,f.jsxs)("div",{className:"flex items-center gap-3",children:[(0,f.jsxs)("div",{className:"flex -space-x-2",children:[e.participants.slice(0,3).map((e,t)=>(0,f.jsxs)(b.Avatar,{className:"h-9 w-9 border-2 border-background",children:[e.avatarUrl&&(0,f.jsx)(b.AvatarImage,{src:e.avatarUrl,alt:e.displayName||e.email||"User"}),(0,f.jsx)(b.AvatarFallback,{className:"text-xs bg-muted text-foreground",children:h(e.displayName||e.email)})]},e.id)),e.participants.length>3&&(0,f.jsx)(b.Avatar,{className:"h-9 w-9 border-2 border-background",children:(0,f.jsxs)(b.AvatarFallback,{className:"text-xs bg-muted text-foreground",children:["+",e.participants.length-3]})})]}),(0,f.jsxs)("div",{className:"flex-1",children:[(0,f.jsx)("h3",{className:"text-base font-semibold text-foreground",children:e.subject||"Untitled Conversation"}),(0,f.jsxs)("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[(0,f.jsx)($.Users,{className:"h-3 w-3"}),(0,f.jsxs)("span",{children:[e.participants.length," participant",1!==e.participants.length?"s":""]})]})]})]}),(0,f.jsxs)("div",{className:"flex items-center gap-2",children:[(0,f.jsx)(T.Badge,{variant:"outline",className:"capitalize border-border text-foreground",children:e.type.replace("_"," ")}),(0,f.jsxs)(L.DropdownMenu,{children:[(0,f.jsx)(L.DropdownMenuTrigger,{asChild:!0,children:(0,f.jsx)(y.Button,{variant:"ghost",size:"icon",className:"h-8 w-8",children:(0,f.jsx)(E.MoreVertical,{className:"h-4 w-4"})})}),(0,f.jsxs)(L.DropdownMenuContent,{align:"end",className:"w-48",children:[(0,f.jsx)(L.DropdownMenuItem,{className:"cursor-pointer",children:"View Details"}),(0,f.jsx)(L.DropdownMenuItem,{className:"cursor-pointer",children:"Mute Notifications"}),(0,f.jsx)(L.DropdownMenuSeparator,{}),(0,f.jsxs)(L.DropdownMenuItem,{className:"cursor-pointer text-red-600 focus:text-red-600",onClick:()=>U(!0),children:[(0,f.jsx)(C.Trash2,{className:"h-4 w-4 mr-2"}),"Delete Conversation"]})]})]})]})]})}),(0,f.jsx)(_.ScrollArea,{className:"flex-1 min-h-0 bg-muted/20",children:(0,f.jsxs)("div",{className:"px-4 py-6 md:px-8",children:[c?(0,f.jsx)(M,{count:3}):0===o.length?(0,f.jsxs)("div",{className:"flex flex-col items-center justify-center h-full min-h-[400px] text-center px-4",children:[(0,f.jsxs)("div",{className:"relative mb-6",children:[(0,f.jsx)("div",{className:"rounded-full bg-gradient-to-br from-primary/10 to-primary/5 p-8 backdrop-blur-sm border border-primary/10",children:(0,f.jsx)(B.MessageSquare,{className:"h-12 w-12 text-primary/60"})}),(0,f.jsx)("div",{className:"absolute -top-1 -right-1 h-4 w-4 rounded-full bg-primary/20 animate-ping"})]}),(0,f.jsx)("h3",{className:"text-xl font-semibold text-foreground mb-2",children:"Start the Conversation"}),(0,f.jsxs)("p",{className:"text-sm text-muted-foreground max-w-md leading-relaxed",children:["No messages yet. Break the ice and send the first message to"," ",(0,f.jsx)("span",{className:"font-medium text-foreground",children:e.participants.filter(e=>e.id!==t)[0]?.displayName||"your team"}),"."]})]}):(0,f.jsx)("div",{className:"space-y-0",children:K.map((e,s)=>{let a=e.senderId===t,r=e.sender?.displayName?{name:e.sender.displayName,email:e.sender.email}:q.get(e.senderId||""),l=r?.name||"Unknown User",n=p(e,s>0?K[s-1]:void 0);return(0,f.jsxs)("div",{children:[n&&(0,f.jsx)("div",{className:"flex items-center justify-center my-6",children:(0,f.jsx)("div",{className:"px-3 py-1 rounded-full bg-muted/50 backdrop-blur-sm",children:(0,f.jsx)("span",{className:"text-xs font-medium text-muted-foreground",children:x(e.createdAt)})})}),(0,f.jsx)(k,{message:e,senderName:l,senderEmail:r?.email,senderAvatarUrl:e.sender?.avatarUrl??null,isSelf:a,isGroupStart:e.isGroupStart,isGroupEnd:e.isGroupEnd,showAvatar:e.showAvatar,showTimestamp:e.showTimestamp,onDelete:O})]},e.id)})}),(0,f.jsx)("div",{ref:G})]})}),(0,f.jsxs)("div",{className:"relative z-10 border-t border-border bg-card px-6 py-4",children:[(0,f.jsxs)("div",{className:"flex items-end gap-2",children:[(0,f.jsxs)("div",{className:"flex items-center gap-1 shrink-0",children:[(0,f.jsx)(y.Button,{variant:"ghost",size:"icon",className:"h-9 w-9 text-muted-foreground hover:text-foreground",disabled:N,title:"Add emoji",children:(0,f.jsx)(R,{className:"h-5 w-5"})}),(0,f.jsx)(y.Button,{variant:"ghost",size:"icon",className:"h-9 w-9 text-muted-foreground hover:text-foreground",disabled:N,title:"Attach file",children:(0,f.jsx)(F,{className:"h-5 w-5"})})]}),(0,f.jsx)("div",{className:"flex-1 relative",children:(0,f.jsx)(A,{value:g,onChange:e=>w(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),H())},placeholder:"Type a message…",disabled:N,className:(0,j.cn)("min-h-[44px] max-h-[200px]","bg-background text-foreground","border-border focus-within:border-primary","placeholder:text-muted-foreground","transition-all duration-200","px-4 py-3")})}),(0,f.jsx)(y.Button,{onClick:H,disabled:N||!g.trim(),size:"icon",className:(0,j.cn)("h-11 w-11 shrink-0 rounded-full shadow-lg","transition-all duration-200 ease-out",g.trim()?"scale-100 opacity-100 hover:scale-105 hover:shadow-xl active:scale-95":"scale-90 opacity-50 cursor-not-allowed"),children:N?(0,f.jsx)("div",{className:"h-4 w-4 border-2 border-primary-foreground/30 border-t-primary-foreground rounded-full animate-spin"}):(0,f.jsx)(I.Send,{className:"h-4 w-4"})})]}),g.trim()&&!N&&(0,f.jsxs)("p",{className:"text-[10px] text-muted-foreground mt-2 px-1",children:["Press ",(0,f.jsx)("kbd",{className:"px-1 py-0.5 rounded bg-muted text-foreground text-[10px]",children:"Ctrl"})," + ",(0,f.jsx)("kbd",{className:"px-1 py-0.5 rounded bg-muted text-foreground text-[10px]",children:"Enter"})," to send"]})]}),(0,f.jsx)(V.AlertDialog,{open:D,onOpenChange:U,children:(0,f.jsxs)(V.AlertDialogContent,{children:[(0,f.jsxs)(V.AlertDialogHeader,{children:[(0,f.jsx)(V.AlertDialogTitle,{children:"Delete Conversation?"}),(0,f.jsx)(V.AlertDialogDescription,{children:"This will permanently delete this conversation and all its messages. This action cannot be undone."})]}),(0,f.jsxs)(V.AlertDialogFooter,{children:[(0,f.jsx)(V.AlertDialogCancel,{children:"Cancel"}),(0,f.jsx)(V.AlertDialogAction,{onClick:P,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})}),(0,f.jsx)(V.AlertDialog,{open:!!z,onOpenChange:e=>!e&&O(null),children:(0,f.jsxs)(V.AlertDialogContent,{children:[(0,f.jsxs)(V.AlertDialogHeader,{children:[(0,f.jsx)(V.AlertDialogTitle,{children:"Delete Message?"}),(0,f.jsx)(V.AlertDialogDescription,{children:"This will permanently delete this message. This action cannot be undone."})]}),(0,f.jsxs)(V.AlertDialogFooter,{children:[(0,f.jsx)(V.AlertDialogCancel,{children:"Cancel"}),(0,f.jsx)(V.AlertDialogAction,{onClick:()=>z&&Y(z),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})})]})}e.s(["ConversationView",()=>z],715898)},953111,e=>{"use strict";var t=e.i(722679),s=e.i(340915);e.i(804306);var a=e.i(501328),r=e.i(282141),l=e.i(316264),n=e.i(129432),i=e.i(191569),o=e.i(74434),d=e.i(538892),c=e.i(263229),u=e.i(262823);let m=(0,e.i(410587).default)("message-square-plus",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}],["path",{d:"M12 8v6",key:"1ib9pf"}],["path",{d:"M9 11h6",key:"1fldmi"}]]);var h=e.i(135771),g=e.i(607730);let x=[{value:"all",label:"All"},{value:"investor",label:"Investor"},{value:"internal",label:"Internal"},{value:"deal",label:"Deals"}],p=[{value:"all",label:"All Types"},{value:"dm",label:"Direct"},{value:"group",label:"Group"},{value:"deal_room",label:"Deal Rooms"},{value:"broadcast",label:"Broadcasts"}];function f({conversations:e,filters:a,onFiltersChange:f,onRefresh:v,onSelectConversation:b,onCreateConversation:y,activeConversationId:j,isLoading:w,errorMessage:N,canCreateConversation:C=!0}){let[S,k]=(0,s.useState)(a.search||""),D=(0,s.useMemo)(()=>{let t={...a,search:S||void 0},s=(0,h.applyConversationFilters)(e,t);return(0,h.sortConversations)(s)},[e,a,S]),M=(0,s.useMemo)(()=>{let t={all:0,investor:0,internal:0,deal:0};for(let s of e)t.all+=s.unreadCount||0,t[s.visibility]+=s.unreadCount||0;return t},[e]);return(0,t.jsxs)("aside",{className:"w-full sm:w-[360px] border-r border-border bg-card flex flex-col text-foreground",children:[(0,t.jsxs)("div",{className:"p-4 border-b border-border space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2 text-foreground",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:"text-lg font-semibold",children:"Messages"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Track investor and internal threads"})]}),(0,t.jsx)(l.Button,{variant:"ghost",size:"icon",onClick:v,disabled:w,className:"text-foreground hover:text-foreground hover:bg-muted",children:w?(0,t.jsx)(c.Loader2,{className:"h-4 w-4 animate-spin"}):(0,t.jsx)(u.RefreshCw,{className:"h-4 w-4"})})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,t.jsxs)(d.Select,{value:a.visibility,onValueChange:e=>{f({...a,visibility:e})},children:[(0,t.jsx)(d.SelectTrigger,{className:"bg-muted border-border text-foreground",children:(0,t.jsx)(d.SelectValue,{placeholder:"Visibility"})}),(0,t.jsx)(d.SelectContent,{className:"bg-muted text-popover-foreground border-border",children:x.map(e=>(0,t.jsx)(d.SelectItem,{value:e.value,children:(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,t.jsx)("span",{children:e.label}),(0,t.jsx)(n.Badge,{variant:"secondary",className:"bg-secondary text-foreground",children:M[e.value]})]})},e.value))})]}),(0,t.jsxs)(d.Select,{value:a.type,onValueChange:e=>{f({...a,type:e})},children:[(0,t.jsx)(d.SelectTrigger,{className:"bg-muted border-border text-foreground",children:(0,t.jsx)(d.SelectValue,{placeholder:"Type"})}),(0,t.jsx)(d.SelectContent,{className:"bg-muted text-popover-foreground border-border",children:p.map(e=>(0,t.jsx)(d.SelectItem,{value:e.value,children:e.label},e.value))})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(l.Button,{variant:a.unreadOnly?"default":"outline",size:"sm",className:"w-full text-popover-foreground",onClick:()=>{f({...a,unreadOnly:!a.unreadOnly})},children:["Unread ",a.unreadOnly?"":`(${M.all})`]}),C&&(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,t.jsxs)(l.Button,{size:"sm",variant:"default",className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>y("dm"),children:[(0,t.jsx)(m,{className:"h-3.5 w-3.5 mr-1.5"}),"New Chat"]}),(0,t.jsxs)(l.Button,{size:"sm",variant:"outline",className:"border-border text-popover-foreground hover:bg-muted",onClick:()=>y("group"),children:[(0,t.jsx)(m,{className:"h-3.5 w-3.5 mr-1.5"}),"New Group"]})]})]}),(0,t.jsx)(i.Input,{placeholder:"Search conversations",value:S,onChange:e=>{var t;k(t=e.target.value),f({...a,search:t||void 0})},className:"bg-muted border-border text-popover-foreground placeholder:text-muted-foreground"}),N?(0,t.jsx)("div",{className:"text-xs text-red-300 border border-red-500/40 bg-red-500/10 p-2 rounded",children:N}):null]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto bg-background",children:0===D.length?(0,t.jsx)("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground text-sm",children:w?"Loading conversations…":"No conversations match your filters."}):(0,t.jsx)("ul",{className:"p-2 space-y-1",children:D.map(e=>{let s=e.id===j,a=e.participants[0],l=e.lastMessageAt||e.createdAt;return(0,t.jsx)("li",{children:(0,t.jsx)("button",{className:(0,r.cn)("w-full text-left px-3 py-3 rounded-lg group","transition-all duration-200 ease-out","hover:bg-muted/80 hover:shadow-md hover:scale-[1.02]","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2","active:scale-[0.98]",s?"bg-muted shadow-sm scale-[1.01]":"bg-transparent"),onClick:()=>b(e.id),children:(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsxs)(o.Avatar,{className:"h-11 w-11 transition-transform duration-200 group-hover:scale-110",children:[a?.avatarUrl&&(0,t.jsx)(o.AvatarImage,{src:a.avatarUrl,alt:a.displayName||a.email||"User"}),(0,t.jsx)(o.AvatarFallback,{className:"bg-secondary text-foreground text-sm font-medium",children:(0,g.getInitials)(a?.displayName||a?.email)})]}),e.unreadCount>0&&(0,t.jsx)("div",{className:"absolute -top-1 -right-1 h-5 w-5 rounded-full bg-blue-500 flex items-center justify-center shadow-lg animate-pulse",children:(0,t.jsx)("span",{className:"text-[10px] font-bold text-white",children:e.unreadCount>9?"9+":e.unreadCount})})]}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-baseline justify-between gap-2 mb-1",children:[(0,t.jsx)("span",{className:(0,r.cn)("font-semibold truncate text-sm",e.unreadCount>0?"text-white":"text-foreground"),children:e.subject||"Untitled Conversation"}),(0,t.jsx)("span",{className:"text-[10px] text-muted-foreground shrink-0",suppressHydrationWarning:!0,children:(0,g.formatRelativeTime)(l)})]}),(0,t.jsx)("p",{className:(0,r.cn)("text-xs truncate",e.unreadCount>0?"text-foreground/80 font-medium":"text-muted-foreground"),children:(0,g.truncateText)(e.preview||e.latestMessage?.body||"No messages yet",60)}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-1.5",children:[(0,t.jsx)(n.Badge,{variant:"outline",className:"text-[10px] capitalize border-border text-muted-foreground px-1.5 py-0",children:e.type.replace("_"," ")}),e.participants.length>1&&(0,t.jsxs)("span",{className:"text-[10px] text-muted-foreground",children:[e.participants.length," participants"]})]})]})]})})},e.id)})})})]})}var v=e.i(715898),b=e.i(59178),y=e.i(994500),j=e.i(352776),w=e.i(816654),N=e.i(312692);function C({open:e,onOpenChange:a,mode:o,onCreate:d,staffDirectory:c,investorDirectory:u,isSubmitting:m}){let[h,g]=(0,s.useState)(""),[x,p]=(0,s.useState)(""),[f,v]=(0,s.useState)([]),[b,y]=(0,s.useState)([]),[C,S]=(0,s.useState)("");console.log("[NewConversationDialog] Mode:",o,"Staff:",c.length,"Investors:",u.length);let k="dm"===o,D="group"===o,M=f.length+b.length,A=b.length>0,_=(0,s.useMemo)(()=>{let e=[...f,...b][0];return[...c,...u].find(t=>t.id===e)},[f,b,c,u]),T=(0,s.useMemo)(()=>{if(!C)return c;let e=C.toLowerCase();return c.filter(t=>t.display_name?.toLowerCase().includes(e)||t.email?.toLowerCase().includes(e))},[c,C]),I=(0,s.useMemo)(()=>{if(!C)return u;let e=C.toLowerCase();return u.filter(t=>t.display_name?.toLowerCase().includes(e)||t.email?.toLowerCase().includes(e)||t.entity_name?.toLowerCase().includes(e))},[u,C]),U=(0,s.useMemo)(()=>{let e=new Map;return I.forEach(t=>{let s=t.entity_name||"Individual Investors";e.has(s)||e.set(s,[]),e.get(s).push(t)}),Array.from(e.entries()).sort((e,t)=>e[0].localeCompare(t[0]))},[I]),F=(0,s.useMemo)(()=>{let e=[];if(e.push({kind:"section",title:"Staff Members",description:"Internal team available for messaging",count:T.length}),0===T.length)e.push({kind:"empty",message:C?"No staff found":"No staff members available"});else for(let t of T)e.push({kind:"staff",entry:t});if(e.push({kind:"section",title:"Investors",description:"Include investor contacts in this thread",count:I.length}),0===I.length)e.push({kind:"empty",message:C?"No investors found":"No investors available"});else for(let[t,s]of U)for(let a of(e.push({kind:"group",title:t}),s))e.push({kind:"investor",entry:a});return e},[T,I,U,C]),E=e=>{k?(v([e]),y([])):v(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},$=e=>{k?(y([e]),v([])):y(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},R=e=>{e||(g(""),p(""),S(""),v([]),y([])),a(e)},B=k?1===M:M>0;return(0,t.jsx)(j.Dialog,{open:e,onOpenChange:R,children:(0,t.jsx)(j.DialogContent,{className:"w-[min(95vw,1100px)] rounded-2xl border border-slate-700 bg-slate-950 p-0 text-slate-50",showCloseButton:!1,children:(0,t.jsxs)("div",{className:"flex h-[min(90vh,880px)] flex-col",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between gap-3 border-b border-slate-800 px-6 py-5",children:[(0,t.jsxs)(j.DialogHeader,{className:"flex-1 gap-1",children:[(0,t.jsx)(j.DialogTitle,{className:"text-2xl font-semibold text-white",children:k?"Start New Direct Conversation":"Create New Group"}),(0,t.jsx)(j.DialogDescription,{className:"mt-1 text-base text-slate-300",children:k?"Select one person to start a direct conversation with.":"Select multiple people and give your group a name."})]}),(0,t.jsx)(j.DialogClose,{className:"rounded-md border border-slate-600 px-3 py-1 text-sm text-slate-200 transition-colors hover:bg-slate-800 hover:text-white",children:"Close"})]}),(0,t.jsx)("div",{className:"flex-1 min-h-0 overflow-hidden",children:(0,t.jsxs)("div",{className:"h-full overflow-y-auto px-6 py-6 space-y-6",children:[D&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("label",{htmlFor:"group-name",className:"text-sm font-semibold text-white",children:["Group Name ",(0,t.jsx)("span",{className:"text-red-400",children:"*"})]}),(0,t.jsx)(i.Input,{id:"group-name",placeholder:"e.g., Q4 Planning Team",value:h,onChange:e=>g(e.target.value),className:"h-11 bg-slate-900 border-slate-700 text-white placeholder:text-slate-400"})]}),k&&_&&(0,t.jsxs)("div",{className:"rounded-lg border border-blue-500/40 bg-blue-500/10 p-4",children:[(0,t.jsx)("p",{className:"text-xs font-semibold uppercase tracking-wider text-blue-300",children:"Starting conversation with"}),(0,t.jsx)("p",{className:"mt-1 text-lg font-semibold text-white",children:_.display_name||_.email}),(0,t.jsx)("p",{className:"text-sm text-slate-300",children:_.email})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("label",{htmlFor:"initial-message",className:"text-base font-semibold text-white",children:[k?"First message":"Initial message"," ",(0,t.jsx)("span",{className:"text-slate-400 font-normal",children:"(optional)"})]}),(0,t.jsx)(w.Textarea,{id:"initial-message",placeholder:k?"Say hello...":"Kick off the conversation...",value:x,onChange:e=>p(e.target.value),rows:3,className:"bg-slate-900 border border-slate-700 text-white placeholder:text-slate-500 focus:border-blue-500"})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("label",{htmlFor:"search-people",className:"text-base font-semibold text-white",children:k?"Select one person":"Select participants"}),(0,t.jsx)(i.Input,{id:"search-people",placeholder:"Search by name or email...",value:C,onChange:e=>S(e.target.value),className:"h-12 bg-slate-900 border border-slate-700 text-white placeholder:text-slate-500 focus:border-blue-500"})]}),(0,t.jsx)("section",{className:"rounded-xl border border-slate-800 bg-slate-900/70",children:(0,t.jsx)("div",{className:"max-h-[calc(80vh-240px)] overflow-y-auto px-5 py-4 space-y-4",children:F.map((e,s)=>{switch(e.kind){case"section":return(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-white",children:e.title}),(0,t.jsx)("p",{className:"text-xs text-slate-400",children:e.description})]}),(0,t.jsx)(n.Badge,{variant:"outline",className:"border-slate-600 bg-slate-800 text-xs font-semibold uppercase text-slate-200",children:e.count})]},`${e.kind}-${e.title}-${s}`);case"group":return(0,t.jsx)("div",{className:"pt-3 text-xs font-semibold uppercase tracking-wider text-slate-300",children:e.title},`group-${e.title}-${s}`);case"empty":return(0,t.jsx)("p",{className:"py-6 text-center text-sm text-slate-400",children:e.message},`empty-${e.message}-${s}`);case"staff":{let a=e.entry,l=f.includes(a.id);return(0,t.jsxs)("label",{className:(0,r.cn)("flex flex-col gap-2 rounded-xl border px-4 py-4 transition-colors",l?"border-blue-500 bg-blue-500/15 shadow-[0_0_0_1px_rgba(59,130,246,0.35)]":"border-slate-700 hover:border-slate-600 hover:bg-slate-800/60"),onClick:()=>E(a.id),children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-4",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[D?(0,t.jsx)(N.Checkbox,{checked:l,onCheckedChange:()=>E(a.id),className:"h-5 w-5"}):(0,t.jsx)("span",{className:(0,r.cn)("flex h-5 w-5 items-center justify-center rounded-full border-2",l?"border-blue-400 bg-blue-500":"border-slate-500"),children:l&&(0,t.jsx)("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})}),(0,t.jsx)("p",{className:"text-base font-semibold text-white leading-tight whitespace-normal",children:a.display_name||a.email||"Staff member"})]}),(0,t.jsx)(n.Badge,{variant:"outline",className:"border-slate-600 bg-slate-800 text-xs font-semibold uppercase text-slate-200",children:a.role.replace("staff_","")})]}),(0,t.jsx)("p",{className:"text-sm text-slate-300 leading-tight whitespace-normal",children:a.email})]},`staff-${a.id}-${s}`)}case"investor":{let a=e.entry,l=b.includes(a.id);return(0,t.jsxs)("label",{className:(0,r.cn)("flex flex-col gap-2 rounded-xl border px-4 py-4 transition-colors",l?"border-blue-500 bg-blue-500/15 shadow-[0_0_0_1px_rgba(59,130,246,0.35)]":"border-slate-700 hover-border-slate-600 hover:bg-slate-800/60"),onClick:()=>$(a.id),children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-4",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[D?(0,t.jsx)(N.Checkbox,{checked:l,onCheckedChange:()=>$(a.id),className:"h-5 w-5"}):(0,t.jsx)("span",{className:(0,r.cn)("flex h-5 w-5 items-center justify-center rounded-full border-2",l?"border-blue-400 bg-blue-500":"border-slate-500"),children:l&&(0,t.jsx)("span",{className:"h-2.5 w-2.5 rounded-full bg-white"})}),(0,t.jsx)("span",{className:"text-base font-semibold text-white leading-tight whitespace-normal",children:a.display_name||a.email||"Investor"})]}),a.entity_type&&(0,t.jsx)(n.Badge,{variant:"outline",className:"border-blue-400/60 bg-blue-500/10 text-xs font-semibold capitalize text-blue-200",children:a.entity_type})]}),(0,t.jsx)("p",{className:"text-sm text-slate-300 leading-tight whitespace-normal",children:a.email})]},`investor-${a.id}-${s}`)}}})})}),(0,t.jsxs)("div",{className:"rounded-xl border border-slate-800 bg-slate-900/70 px-6 py-4",children:[(0,t.jsx)("p",{className:"text-sm font-semibold uppercase tracking-wide text-white",children:"Summary"}),(0,t.jsx)("p",{className:"mt-2 text-base text-white",children:k?1===M?`Ready to message ${_?.display_name||_?.email}`:"Select one person to continue":`${M} participant${1===M?"":"s"} selected`}),A&&(0,t.jsx)("p",{className:"mt-2 text-sm font-medium text-blue-300",children:"✓ Contains investors • Visibility automatically set to Investor"}),!B&&(0,t.jsx)("p",{className:"mt-2 text-sm text-red-300",children:k?"⚠ Select exactly one person":"⚠ Select at least one participant"}),D&&!h.trim()&&(0,t.jsx)("p",{className:"mt-2 text-sm text-red-300",children:"⚠ Group name is required"})]})]})}),(0,t.jsxs)(j.DialogFooter,{className:"gap-3 border-t border-slate-800 px-6 py-4",children:[(0,t.jsx)(l.Button,{type:"button",variant:"outline",onClick:()=>R(!1),disabled:m,className:"h-11 border border-slate-600 bg-slate-900 text-slate-100 transition-colors hover:bg-slate-800 hover:text-white",children:"Cancel"}),(0,t.jsx)(l.Button,{type:"button",onClick:()=>{let e=[...f,...b],t=h.trim();k&&_?t=_.display_name||_.email||"Direct Message":t||(t="Untitled conversation");let s=A?"investor":"internal",a=k?"dm":"group";console.log("[NewConversationDialog] Submitting:",{mode:o,subject:t,participantIds:e,totalParticipants:e.length,visibility:s,type:a}),d({subject:t,participantIds:e,visibility:s,type:a,initialMessage:x.trim()||void 0})},disabled:m||!B||D&&!h.trim(),className:"h-11 bg-blue-600 px-8 text-base font-semibold text-white shadow-[0_8px_16px_rgba(37,99,235,0.35)] transition-colors hover:bg-blue-500",children:m?"Creating…":k?"Start Conversation":"Create Group"})]})]})})})}let S={visibility:"all",type:"all"};function k({initialConversations:e,currentUserId:r,canCreateConversation:l=!0}){let n=(0,s.useMemo)(()=>(0,b.createClient)(),[]),[i,o]=(0,s.useState)(S),[d,c]=(0,s.useState)(e),[u,m]=(0,s.useState)(!1),[h,g]=(0,s.useState)(e[0]?.id||null),[x,p]=(0,s.useState)(null),[j,w]=(0,s.useState)(!1),[N,k]=(0,s.useState)("dm"),[D,M]=(0,s.useState)([]),[A,_]=(0,s.useState)([]),[T,I]=(0,s.useState)(!1),U=(0,s.useRef)(h);U.current=h,console.log("[MessagingClient] Initial conversations:",e.length),console.log("[MessagingClient] Current conversations state:",d.length),console.log("[MessagingClient] Filters:",i);let F=d.find(e=>e.id===h)||null,E=(0,s.useCallback)(async(e,t=!1)=>{console.log("[MessagingClient] loadConversations called with filters:",e||i,"silent:",t),t||m(!0),p(null);try{let t=e||i,{conversations:s}=await (0,a.fetchConversationsClient)({...t,includeMessages:!0,limit:50});console.log("[MessagingClient] Fetched conversations:",s.length),c(s),s.length>0&&!h&&g(s[0].id)}catch(e){console.error("[MessagingClient] Load conversations error",e),p(e.message||"Failed to load conversations")}finally{t||m(!1)}},[i,h]),$=(0,s.useCallback)(e=>{o(e),E(e)},[E]),R=(0,s.useCallback)(()=>{E(i)},[E,i]),B=(0,s.useCallback)(e=>{g(e),c(t=>t.map(t=>t.id===e?{...t,unreadCount:0}:t)),(0,a.markConversationRead)(e).catch(console.error)},[]);(0,s.useEffect)(()=>{console.log("[Staff Messages] Setting up realtime subscription");let e=n.channel("staff_conversations_all").on("postgres_changes",{event:"INSERT",schema:"public",table:"conversations"},()=>{console.log("[Realtime] New conversation created, refreshing list"),(0,a.fetchConversationsClient)({...i,includeMessages:!0,limit:50}).then(({conversations:e})=>{c(e)}).catch(console.error)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},e=>{let t=e.new?.conversation_id;t&&t!==U.current&&(console.log("[Realtime] New message in background conversation, refreshing list"),(0,a.fetchConversationsClient)({...i,includeMessages:!0,limit:50}).then(({conversations:e})=>{c(e)}).catch(console.error))}).subscribe(e=>{console.log("[Realtime] Subscription status:",e)});return()=>{console.log("[Staff Messages] Cleaning up realtime subscription"),n.removeChannel(e)}},[n,i]);let L=(0,s.useCallback)(e=>{y.toast.error(e)},[]),V=(0,s.useCallback)(e=>{console.log("[MessagingClient] Deleting conversation:",e),c(t=>t.filter(t=>t.id!==e)),g(null),y.toast.success("Conversation deleted")},[]);(0,s.useEffect)(()=>{l?(async()=>{try{console.log("[MessagingClient] Loading staff and investor directories...");let[e,t]=await Promise.all([fetch("/api/staff/available"),fetch("/api/investors/available")]);if(e.ok){let t=await e.json();console.log("[MessagingClient] Staff directory loaded:",t.staff?.length||0,"members"),M(t.staff||[])}else console.error("[MessagingClient] Staff fetch failed:",e.status);if(t.ok){let e=await t.json();console.log("[MessagingClient] Investor directory loaded:",e.investors?.length||0,"investors"),console.log("[MessagingClient] Sample investor:",e.investors?.[0]),_(e.investors||[])}else console.error("[MessagingClient] Investor fetch failed:",t.status)}catch(e){console.error("[MessagingClient] Failed to load directories",e)}})():console.log("[MessagingClient] Skipping directory load - user cannot create conversations")},[l]);let z=async e=>{let t=Array.from(new Set(e.participantIds));if(console.log("[MessagingClient] Creating conversation:",{subject:e.subject,participants:t.length,type:e.type,visibility:e.visibility}),!t.length)return void y.toast.error("Select at least one participant");I(!0);try{let s={subject:e.subject,participant_ids:t,type:e.type,visibility:"all"===e.visibility?"internal":e.visibility,initial_message:e.initialMessage};console.log("[MessagingClient] Request payload:",s);let a=await fetch("/api/conversations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!a.ok){let e=await a.json().catch(()=>null);throw console.error("[MessagingClient] Create conversation error:",e),Error(e?.error||"Failed to create conversation")}let r=await a.json();console.log("[MessagingClient] Conversation created:",r),y.toast.success("Conversation created successfully!"),w(!1),await E(i),r?.conversation?.id&&g(r.conversation.id)}catch(e){console.error("[MessagingClient] Create conversation failed:",e),y.toast.error(e.message||"Unable to create conversation")}finally{I(!1)}};return(0,t.jsxs)("div",{className:"flex h-[calc(100vh-4rem)] overflow-hidden",children:[(0,t.jsx)(f,{conversations:d,filters:i,onFiltersChange:$,onRefresh:R,onSelectConversation:B,onCreateConversation:e=>{k(e),w(!0)},activeConversationId:h,isLoading:u,errorMessage:x,canCreateConversation:l}),(0,t.jsx)("div",{className:"flex-1 flex flex-col",children:F?(0,t.jsx)(v.ConversationView,{conversation:F,currentUserId:r,onRead:()=>(0,a.markConversationRead)(F.id),onError:L,onDelete:V},F.id):(0,t.jsx)("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:"Select a conversation to get started"})}),l&&(0,t.jsx)(C,{open:j,onOpenChange:w,mode:N,staffDirectory:D,investorDirectory:A,onCreate:z,isSubmitting:T})]})}e.s(["MessagingClient",()=>k],953111)}]);