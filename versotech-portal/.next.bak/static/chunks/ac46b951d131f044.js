(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,932735,e=>{"use strict";let a=(0,e.i(410587).default)("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);e.s(["Send",()=>a],932735)},80465,e=>{"use strict";let a=(0,e.i(410587).default)("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);e.s(["CheckCircle",()=>a],80465)},237635,e=>{"use strict";var a=e.i(722679),t=e.i(282141);function r({className:e,...r}){return(0,a.jsx)("div",{"data-slot":"table-container",className:"relative w-full overflow-x-auto",children:(0,a.jsx)("table",{"data-slot":"table",className:(0,t.cn)("w-full caption-bottom text-sm",e),...r})})}function s({className:e,...r}){return(0,a.jsx)("thead",{"data-slot":"table-header",className:(0,t.cn)("[&_tr]:border-b",e),...r})}function n({className:e,...r}){return(0,a.jsx)("tbody",{"data-slot":"table-body",className:(0,t.cn)("[&_tr:last-child]:border-0",e),...r})}function l({className:e,...r}){return(0,a.jsx)("tr",{"data-slot":"table-row",className:(0,t.cn)("hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",e),...r})}function i({className:e,...r}){return(0,a.jsx)("th",{"data-slot":"table-head",className:(0,t.cn)("text-foreground h-11 md:h-10 px-2 text-left align-middle font-medium text-xs sm:text-sm [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",e),...r})}function d({className:e,...r}){return(0,a.jsx)("td",{"data-slot":"table-cell",className:(0,t.cn)("p-2 align-middle text-xs sm:text-sm [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",e),...r})}e.s(["Table",()=>r,"TableBody",()=>n,"TableCell",()=>d,"TableHead",()=>i,"TableHeader",()=>s,"TableRow",()=>l])},90613,e=>{"use strict";var a=e.i(722679),t=e.i(282141);function r({className:e,...r}){return(0,a.jsx)("div",{"data-slot":"card",className:(0,t.cn)("bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",e),...r})}function s({className:e,...r}){return(0,a.jsx)("div",{"data-slot":"card-header",className:(0,t.cn)("@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",e),...r})}function n({className:e,...r}){return(0,a.jsx)("div",{"data-slot":"card-title",className:(0,t.cn)("leading-none font-semibold",e),...r})}function l({className:e,...r}){return(0,a.jsx)("div",{"data-slot":"card-description",className:(0,t.cn)("text-muted-foreground text-sm",e),...r})}function i({className:e,...r}){return(0,a.jsx)("div",{"data-slot":"card-content",className:(0,t.cn)("px-6",e),...r})}function d({className:e,...r}){return(0,a.jsx)("div",{"data-slot":"card-footer",className:(0,t.cn)("flex items-center px-6 [.border-t]:pt-6",e),...r})}e.s(["Card",()=>r,"CardContent",()=>i,"CardDescription",()=>l,"CardFooter",()=>d,"CardHeader",()=>s,"CardTitle",()=>n])},816654,e=>{"use strict";var a=e.i(722679),t=e.i(340915),r=e.i(282141);let s=t.forwardRef(({className:e,...t},s)=>(0,a.jsx)("textarea",{className:(0,r.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:border-ring disabled:cursor-not-allowed disabled:opacity-50",e),ref:s,...t}));s.displayName="Textarea",e.s(["Textarea",()=>s])},429760,e=>{"use strict";var a=e.i(722679),t=e.i(340915),r=e.i(679472),s=e.i(47264),n=e.i(478985),l=e.i(873358),i=e.i(362208),d=e.i(599205),o=e.i(68977),c=e.i(798827),u="Tabs",[m,p]=(0,s.createContextScope)(u,[n.createRovingFocusGroupScope]),x=(0,n.createRovingFocusGroupScope)(),[h,f]=m(u),g=t.forwardRef((e,t)=>{let{__scopeTabs:r,value:s,onValueChange:n,defaultValue:l,orientation:m="horizontal",dir:p,activationMode:x="automatic",...f}=e,g=(0,d.useDirection)(p),[j,b]=(0,o.useControllableState)({prop:s,onChange:n,defaultProp:l??"",caller:u});return(0,a.jsx)(h,{scope:r,baseId:(0,c.useId)(),value:j,onValueChange:b,orientation:m,dir:g,activationMode:x,children:(0,a.jsx)(i.Primitive.div,{dir:g,"data-orientation":m,...f,ref:t})})});g.displayName=u;var j="TabsList",b=t.forwardRef((e,t)=>{let{__scopeTabs:r,loop:s=!0,...l}=e,d=f(j,r),o=x(r);return(0,a.jsx)(n.Root,{asChild:!0,...o,orientation:d.orientation,dir:d.dir,loop:s,children:(0,a.jsx)(i.Primitive.div,{role:"tablist","aria-orientation":d.orientation,...l,ref:t})})});b.displayName=j;var v="TabsTrigger",y=t.forwardRef((e,t)=>{let{__scopeTabs:s,value:l,disabled:d=!1,...o}=e,c=f(v,s),u=x(s),m=_(c.baseId,l),p=C(c.baseId,l),h=l===c.value;return(0,a.jsx)(n.Item,{asChild:!0,...u,focusable:!d,active:h,children:(0,a.jsx)(i.Primitive.button,{type:"button",role:"tab","aria-selected":h,"aria-controls":p,"data-state":h?"active":"inactive","data-disabled":d?"":void 0,disabled:d,id:m,...o,ref:t,onMouseDown:(0,r.composeEventHandlers)(e.onMouseDown,e=>{d||0!==e.button||!1!==e.ctrlKey?e.preventDefault():c.onValueChange(l)}),onKeyDown:(0,r.composeEventHandlers)(e.onKeyDown,e=>{[" ","Enter"].includes(e.key)&&c.onValueChange(l)}),onFocus:(0,r.composeEventHandlers)(e.onFocus,()=>{let e="manual"!==c.activationMode;h||d||!e||c.onValueChange(l)})})})});y.displayName=v;var N="TabsContent",w=t.forwardRef((e,r)=>{let{__scopeTabs:s,value:n,forceMount:d,children:o,...c}=e,u=f(N,s),m=_(u.baseId,n),p=C(u.baseId,n),x=n===u.value,h=t.useRef(x);return t.useEffect(()=>{let e=requestAnimationFrame(()=>h.current=!1);return()=>cancelAnimationFrame(e)},[]),(0,a.jsx)(l.Presence,{present:d||x,children:({present:t})=>(0,a.jsx)(i.Primitive.div,{"data-state":x?"active":"inactive","data-orientation":u.orientation,role:"tabpanel","aria-labelledby":m,hidden:!t,id:p,tabIndex:0,...c,ref:r,style:{...e.style,animationDuration:h.current?"0s":void 0},children:t&&o})})});function _(e,a){return`${e}-trigger-${a}`}function C(e,a){return`${e}-content-${a}`}w.displayName=N;var S=e.i(282141);let T=t.forwardRef(({id:e,...r},s)=>{let n=t.useId();return(0,a.jsx)(g,{ref:s,id:e??n,...r})});T.displayName="Tabs";let k=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)(b,{ref:r,className:(0,S.cn)("inline-flex h-11 md:h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",e),...t}));k.displayName=b.displayName;let D=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)(y,{ref:r,className:(0,S.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-2 md:py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",e),...t}));D.displayName=y.displayName;let F=t.forwardRef(({className:e,...t},r)=>(0,a.jsx)(w,{ref:r,className:(0,S.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",e),...t}));F.displayName=w.displayName,e.s(["Tabs",()=>T,"TabsContent",()=>F,"TabsList",()=>k,"TabsTrigger",()=>D],429760)},908925,e=>{"use strict";let a;var t=e.i(722679),r=e.i(340915),s=e.i(47264),n=e.i(886978),l=e.i(62773),i=e.i(679472),d=Symbol("radix.slottable"),o="AlertDialog",[c,u]=(0,s.createContextScope)(o,[l.createDialogScope]),m=(0,l.createDialogScope)(),p=e=>{let{__scopeAlertDialog:a,...r}=e,s=m(a);return(0,t.jsx)(l.Root,{...s,...r,modal:!0})};p.displayName=o;var x=r.forwardRef((e,a)=>{let{__scopeAlertDialog:r,...s}=e,n=m(r);return(0,t.jsx)(l.Trigger,{...n,...s,ref:a})});x.displayName="AlertDialogTrigger";var h=e=>{let{__scopeAlertDialog:a,...r}=e,s=m(a);return(0,t.jsx)(l.Portal,{...s,...r})};h.displayName="AlertDialogPortal";var f=r.forwardRef((e,a)=>{let{__scopeAlertDialog:r,...s}=e,n=m(r);return(0,t.jsx)(l.Overlay,{...n,...s,ref:a})});f.displayName="AlertDialogOverlay";var g="AlertDialogContent",[j,b]=c(g),v=((a=({children:e})=>(0,t.jsx)(t.Fragment,{children:e})).displayName="AlertDialogContent.Slottable",a.__radixId=d,a),y=r.forwardRef((e,a)=>{let{__scopeAlertDialog:s,children:d,...o}=e,c=m(s),u=r.useRef(null),p=(0,n.useComposedRefs)(a,u),x=r.useRef(null);return(0,t.jsx)(l.WarningProvider,{contentName:g,titleName:N,docsSlug:"alert-dialog",children:(0,t.jsx)(j,{scope:s,cancelRef:x,children:(0,t.jsxs)(l.Content,{role:"alertdialog",...c,...o,ref:p,onOpenAutoFocus:(0,i.composeEventHandlers)(o.onOpenAutoFocus,e=>{e.preventDefault(),x.current?.focus({preventScroll:!0})}),onPointerDownOutside:e=>e.preventDefault(),onInteractOutside:e=>e.preventDefault(),children:[(0,t.jsx)(v,{children:d}),(0,t.jsx)(D,{contentRef:u})]})})})});y.displayName=g;var N="AlertDialogTitle",w=r.forwardRef((e,a)=>{let{__scopeAlertDialog:r,...s}=e,n=m(r);return(0,t.jsx)(l.Title,{...n,...s,ref:a})});w.displayName=N;var _="AlertDialogDescription",C=r.forwardRef((e,a)=>{let{__scopeAlertDialog:r,...s}=e,n=m(r);return(0,t.jsx)(l.Description,{...n,...s,ref:a})});C.displayName=_;var S=r.forwardRef((e,a)=>{let{__scopeAlertDialog:r,...s}=e,n=m(r);return(0,t.jsx)(l.Close,{...n,...s,ref:a})});S.displayName="AlertDialogAction";var T="AlertDialogCancel",k=r.forwardRef((e,a)=>{let{__scopeAlertDialog:r,...s}=e,{cancelRef:i}=b(T,r),d=m(r),o=(0,n.useComposedRefs)(a,i);return(0,t.jsx)(l.Close,{...d,...s,ref:o})});k.displayName=T;var D=({contentRef:e})=>{let a=`\`${g}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${g}\` by passing a \`${_}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${g}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return r.useEffect(()=>{document.getElementById(e.current?.getAttribute("aria-describedby"))||console.warn(a)},[a,e]),null},F=e.i(282141),A=e.i(316264);function P({...e}){return(0,t.jsx)(p,{"data-slot":"alert-dialog",...e})}function E({...e}){return(0,t.jsx)(x,{"data-slot":"alert-dialog-trigger",...e})}function R({...e}){return(0,t.jsx)(h,{"data-slot":"alert-dialog-portal",...e})}function B({className:e,...a}){return(0,t.jsx)(f,{"data-slot":"alert-dialog-overlay",className:(0,F.cn)("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/80 backdrop-blur-sm",e),...a})}function $({className:e,...a}){return(0,t.jsxs)(R,{children:[(0,t.jsx)(B,{}),(0,t.jsx)(y,{"data-slot":"alert-dialog-content",className:(0,F.cn)("bg-background border-border text-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg backdrop-blur-xl",e),...a})]})}function I({className:e,...a}){return(0,t.jsx)("div",{"data-slot":"alert-dialog-header",className:(0,F.cn)("flex flex-col gap-2 text-center sm:text-left",e),...a})}function M({className:e,...a}){return(0,t.jsx)("div",{"data-slot":"alert-dialog-footer",className:(0,F.cn)("flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",e),...a})}function H({className:e,...a}){return(0,t.jsx)(w,{"data-slot":"alert-dialog-title",className:(0,F.cn)("text-lg font-semibold text-foreground",e),...a})}function L({className:e,...a}){return(0,t.jsx)(C,{"data-slot":"alert-dialog-description",className:(0,F.cn)("text-muted-foreground text-sm",e),...a})}function z({className:e,...a}){return(0,t.jsx)(S,{className:(0,F.cn)((0,A.buttonVariants)(),e),...a})}function V({className:e,...a}){return(0,t.jsx)(k,{className:(0,F.cn)((0,A.buttonVariants)({variant:"outline"}),e),...a})}e.s(["AlertDialog",()=>P,"AlertDialogAction",()=>z,"AlertDialogCancel",()=>V,"AlertDialogContent",()=>$,"AlertDialogDescription",()=>L,"AlertDialogFooter",()=>M,"AlertDialogHeader",()=>I,"AlertDialogTitle",()=>H,"AlertDialogTrigger",()=>E],908925)},554369,e=>{"use strict";let a=(0,e.i(410587).default)("trash-2",[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]]);e.s(["Trash2",()=>a],554369)},551544,e=>{"use strict";let a=(0,e.i(410587).default)("square-pen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);e.s(["Edit",()=>a],551544)},726907,e=>{"use strict";var a=e.i(722679),t=e.i(340915),r=e.i(994500),s=e.i(90613),n=e.i(316264),l=e.i(129432),i=e.i(191569),d=e.i(514133),o=e.i(816654),c=e.i(538892),u=e.i(237635),m=e.i(352776),p=e.i(908925),x=e.i(831833),h=e.i(551544),f=e.i(554369),g=e.i(119311),j=e.i(501259),b=e.i(263229),v=e.i(401148),y=e.i(971743),N=e.i(335994),w=e.i(691974),_=e.i(432598),C=e.i(932735),S=e.i(80465),T=e.i(230112),k=e.i(197098),D=e.i(410587);let F=(0,D.default)("layout-list",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}],["path",{d:"M14 4h7",key:"3xa0d5"}],["path",{d:"M14 9h7",key:"1icrd9"}],["path",{d:"M14 15h7",key:"1mj8o2"}],["path",{d:"M14 20h7",key:"11slyb"}]]),A=(0,D.default)("folder-kanban",[["path",{d:"M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z",key:"1fr9dc"}],["path",{d:"M8 10v4",key:"tgpxqk"}],["path",{d:"M12 10v2",key:"hh53o1"}],["path",{d:"M16 10v6",key:"1d6xys"}]]);var P=e.i(429760),E=e.i(59178);let R=[{value:"subscription",label:"Subscription Fee"},{value:"management",label:"Management Fee"},{value:"performance",label:"Performance Fee"},{value:"bd_fee",label:"Broker-Dealer Fee"},{value:"flat",label:"Flat Fee"},{value:"other",label:"Other"}],B=[{value:"upfront",label:"Upfront"},{value:"recurring",label:"Recurring"},{value:"on_demand",label:"On Demand"}];function $(){let[e,D]=(0,t.useState)([]),[$,I]=(0,t.useState)([]),[M,H]=(0,t.useState)(!0),[L,z]=(0,t.useState)(null),[V,O]=(0,t.useState)("list"),[q,U]=(0,t.useState)(new Map),[K,G]=(0,t.useState)(new Set),[Y,W]=(0,t.useState)(!1),[J,X]=(0,t.useState)(!1),[Z,Q]=(0,t.useState)(null),[ee,ea]=(0,t.useState)(!1),[et,er]=(0,t.useState)(null),[es,en]=(0,t.useState)(""),[el,ei]=(0,t.useState)(""),[ed,eo]=(0,t.useState)("none"),[ec,eu]=(0,t.useState)("none"),[em,ep]=(0,t.useState)([]);(0,t.useEffect)(()=>{ex()},[]);let ex=async()=>{try{H(!0);let e=(0,E.createClient)(),a=await fetch("/api/arrangers/me/fee-plans?include_components=true&is_active=all");if(!a.ok)throw Error("Failed to fetch fee plans");let t=await a.json();D(t.data||[]);let{data:{user:r}}=await e.auth.getUser();if(!r)throw Error("Not authenticated");let{data:s}=await e.from("arranger_users").select("arranger_id").eq("user_id",r.id).single();if(s){let{data:a}=await e.from("deals").select("id").eq("arranger_entity_id",s.arranger_id);if(a&&a.length>0){let r=a.map(e=>e.id),{data:n}=await e.from("deal_memberships").select("referred_by_entity_id, referred_by_entity_type").in("deal_id",r).not("referred_by_entity_id","is",null),l=[...new Set((n||[]).filter(e=>"partner"===e.referred_by_entity_type).map(e=>e.referred_by_entity_id))],i=[...new Set((n||[]).filter(e=>"introducer"===e.referred_by_entity_type).map(e=>e.referred_by_entity_id))],d=[];if(l.length>0){let{data:a}=await e.from("partners").select("id, name").in("id",l);(a||[]).forEach(e=>{d.push({id:e.id,name:e.name,type:"partner"})})}if(i.length>0){let{data:a}=await e.from("introducers").select("id, legal_name").in("id",i);(a||[]).forEach(e=>{d.push({id:e.id,name:e.legal_name,type:"introducer"})})}let o=(n||[]).filter(e=>"commercial_partner"===e.referred_by_entity_type).map(e=>e.referred_by_entity_id),{data:c}=await e.from("placement_agreements").select("commercial_partner_id").eq("arranger_id",s.arranger_id),u=(c||[]).map(e=>e.commercial_partner_id).filter(Boolean),m=[...new Set([...o,...u])];if(m.length>0){let{data:a}=await e.from("commercial_partners").select("id, name, legal_name").in("id",m);(a||[]).forEach(e=>{d.push({id:e.id,name:e.name||e.legal_name||"Unknown CP",type:"commercial_partner"})})}I(d);let p=new Map,x=[...new Set((t.data||[]).filter(e=>e.deal_id).map(e=>e.deal_id))],h=new Map;if(x.length>0){let{data:a}=await e.from("deals").select("id, name, status").in("id",x);h=new Map((a||[]).map(e=>[e.id,e]))}for(let e of t.data||[]){let a=e.deal_id||"general",t=e.deal_id?h.get(e.deal_id)||{id:e.deal_id,name:"Unknown Deal"}:{id:"general",name:"General (No Deal)",status:"active"};p.has(a)||p.set(a,{deal:t,plans:[]}),p.get(a).plans.push(e)}U(p)}}z(null)}catch(e){console.error("[FeePlansPage] Error:",e),z(e instanceof Error?e.message:"Failed to load data")}finally{H(!1)}},eh=()=>{en(""),ei(""),eo("none"),eu("none"),ep([])},ef=()=>{eh(),Q(null),W(!0)},eg=e=>{Q(e),en(e.name),ei(e.description||""),e.partner_id?(eo("partner"),eu(e.partner_id)):e.introducer_id?(eo("introducer"),eu(e.introducer_id)):e.commercial_partner_id?(eo("commercial_partner"),eu(e.commercial_partner_id)):(eo("none"),eu("none")),ep(e.components||[]),W(!0)},ej=e=>{Q(e),X(!0)},eb=(e,a)=>{let t=[...em];t[e]={...t[e],...a},ep(t)},ev=async()=>{if(!es.trim())return void z("Plan name is required");if(0===em.length)return void z("At least one fee component is required");ea(!0),z(null);try{let e={name:es.trim(),description:el.trim()||void 0,components:em.map(e=>({...e,rate_bps:e.rate_bps?Number(e.rate_bps):void 0,flat_amount:e.flat_amount?Number(e.flat_amount):void 0}))};"partner"===ed&&"none"!==ec?e.partner_id=ec:"introducer"===ed&&"none"!==ec?e.introducer_id=ec:"commercial_partner"===ed&&"none"!==ec&&(e.commercial_partner_id=ec);let a=Z?`/api/arrangers/me/fee-plans/${Z.id}`:"/api/arrangers/me/fee-plans",t=await fetch(a,{method:Z?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to save fee plan")}await ex(),W(!1),eh(),r.toast.success(Z?"Fee plan updated":"Fee plan created",{description:`"${es}" has been saved successfully.`})}catch(e){console.error("[FeePlansPage] Save error:",e),z(e instanceof Error?e.message:"Failed to save fee plan")}finally{ea(!1)}},ey=async()=>{if(!Z)return;let e=Z.name;try{if(!(await fetch(`/api/arrangers/me/fee-plans/${Z.id}`,{method:"DELETE"})).ok)throw Error("Failed to delete fee plan");await ex(),X(!1),Q(null),r.toast.success("Fee plan deleted",{description:`"${e}" has been removed.`})}catch(e){console.error("[FeePlansPage] Delete error:",e),z(e instanceof Error?e.message:"Failed to delete fee plan")}},eN=async e=>{if(!e.partner_id&&!e.introducer_id&&!e.commercial_partner_id)return void r.toast.error("Cannot send fee plan",{description:"Please assign this fee plan to a partner, introducer, or commercial partner first."});er(e.id),z(null);try{let a=await fetch(`/api/arrangers/me/fee-plans/${e.id}/send`,{method:"POST"});if(!a.ok){let e=await a.json();throw Error(e.error||"Failed to send fee plan")}let t=await a.json();await ex(),"no_users"===t.notification_status?r.toast.warning("Fee plan sent",{description:`"${e.name}" was marked as sent, but there are no users to notify.`}):"failed"===t.notification_status?r.toast.warning("Fee plan sent",{description:`"${e.name}" was sent, but notifications could not be delivered.`}):r.toast.success("Fee plan sent",{description:`"${e.name}" has been sent to ${t.notified_users} user(s).`})}catch(e){console.error("[FeePlansPage] Send error:",e),r.toast.error("Failed to send fee plan",{description:e instanceof Error?e.message:"An unexpected error occurred."})}finally{er(null)}},ew=e=>{let a=new Set(K);a.has(e)?a.delete(e):a.add(e),G(a)},e_=e=>`${(e/100).toFixed(2)}%`,eC=e=>{if(e.partner_id){let a=$.find(a=>a.id===e.partner_id&&"partner"===a.type);return a?.name||"Partner"}if(e.introducer_id){let a=$.find(a=>a.id===e.introducer_id&&"introducer"===a.type);return a?.name||"Introducer"}if(e.commercial_partner_id){let a=$.find(a=>a.id===e.commercial_partner_id&&"commercial_partner"===a.type);return a?.name||"Commercial Partner"}return"General"},eS=e=>e.partner_id?(0,a.jsx)(j.Users,{className:"h-4 w-4 text-blue-400"}):e.introducer_id?(0,a.jsx)(N.UserPlus,{className:"h-4 w-4 text-green-400"}):e.commercial_partner_id?(0,a.jsx)(w.Briefcase,{className:"h-4 w-4 text-purple-400"}):(0,a.jsx)(y.Building2,{className:"h-4 w-4 text-gray-400"});return M?(0,a.jsxs)("div",{className:"flex items-center justify-center py-16",children:[(0,a.jsx)(b.Loader2,{className:"h-8 w-8 animate-spin text-muted-foreground"}),(0,a.jsx)("span",{className:"ml-3 text-muted-foreground",children:"Loading fee plans..."})]}):(0,a.jsxs)("div",{className:"p-6 space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-foreground",children:"Fee Plans"}),(0,a.jsx)("p",{className:"text-muted-foreground mt-1",children:"Create and manage fee structures for your network partners"})]}),(0,a.jsxs)(n.Button,{onClick:ef,className:"gap-2",children:[(0,a.jsx)(x.Plus,{className:"h-4 w-4"}),"Create Fee Plan"]})]}),L&&(0,a.jsxs)("div",{className:"bg-red-500/10 border border-red-500/30 text-red-400 text-sm p-4 rounded flex items-center gap-2",children:[(0,a.jsx)(v.AlertCircle,{className:"h-4 w-4"}),L]}),(0,a.jsx)(s.Card,{className:"bg-blue-500/10 border-blue-500/30",children:(0,a.jsx)(s.CardContent,{className:"pt-6",children:(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:[(0,a.jsx)("strong",{className:"text-blue-400",children:"How Fee Plans Work:"})," Create fee structures for your partners, introducers, and commercial partners. These plans define the fee components that will apply to subscriptions they refer. You can assign different fee structures to different entities based on your agreements."]})})}),(0,a.jsxs)(P.Tabs,{value:V,onValueChange:e=>O(e),children:[(0,a.jsxs)(P.TabsList,{className:"mb-4",children:[(0,a.jsxs)(P.TabsTrigger,{value:"list",className:"gap-2",children:[(0,a.jsx)(F,{className:"h-4 w-4"}),"List View"]}),(0,a.jsxs)(P.TabsTrigger,{value:"by-opportunity",className:"gap-2",children:[(0,a.jsx)(A,{className:"h-4 w-4"}),"By Opportunity"]})]}),(0,a.jsx)(P.TabsContent,{value:"list",children:(0,a.jsxs)(s.Card,{children:[(0,a.jsxs)(s.CardHeader,{children:[(0,a.jsx)(s.CardTitle,{children:"Your Fee Plans"}),(0,a.jsxs)(s.CardDescription,{children:[e.length," fee plan",1!==e.length?"s":""," created"]})]}),(0,a.jsx)(s.CardContent,{children:0===e.length?(0,a.jsxs)("div",{className:"border border-dashed border-muted rounded-lg py-12 flex flex-col items-center justify-center text-center space-y-2",children:[(0,a.jsx)(g.FileText,{className:"h-10 w-10 text-muted-foreground"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"No fee plans created yet"}),(0,a.jsxs)(n.Button,{onClick:ef,variant:"outline",size:"sm",children:[(0,a.jsx)(x.Plus,{className:"h-4 w-4 mr-1"}),"Create Your First Fee Plan"]})]}):(0,a.jsx)("div",{className:"rounded-md border overflow-x-auto",children:(0,a.jsxs)(u.Table,{children:[(0,a.jsx)(u.TableHeader,{children:(0,a.jsxs)(u.TableRow,{children:[(0,a.jsx)(u.TableHead,{children:"Plan Name"}),(0,a.jsx)(u.TableHead,{children:"Assigned To"}),(0,a.jsx)(u.TableHead,{children:"Fee Components"}),(0,a.jsx)(u.TableHead,{children:"Status"}),(0,a.jsx)(u.TableHead,{className:"text-right",children:"Actions"})]})}),(0,a.jsx)(u.TableBody,{children:e.map(e=>(0,a.jsxs)(u.TableRow,{children:[(0,a.jsx)(u.TableCell,{children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(g.FileText,{className:"h-4 w-4 text-muted-foreground"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium",children:e.name}),e.description&&(0,a.jsx)("div",{className:"text-sm text-muted-foreground truncate max-w-[200px]",children:e.description})]})]})}),(0,a.jsx)(u.TableCell,{children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[eS(e),(0,a.jsx)("span",{children:eC(e)})]})}),(0,a.jsx)(u.TableCell,{children:(0,a.jsxs)("div",{className:"flex flex-wrap gap-1",children:[e.components?.slice(0,3).map((e,t)=>(0,a.jsxs)(l.Badge,{variant:"outline",className:"text-xs",children:[e.kind,": ",e.rate_bps?e_(e.rate_bps):e.flat_amount?`$${e.flat_amount}`:"N/A"]},t)),(e.components?.length||0)>3&&(0,a.jsxs)(l.Badge,{variant:"outline",className:"text-xs",children:["+",(e.components?.length||0)-3," more"]})]})}),(0,a.jsx)(u.TableCell,{children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[e.is_active?(0,a.jsx)(l.Badge,{variant:"outline",className:"bg-green-500/10 text-green-500 border-green-500",children:"Active"}):(0,a.jsx)(l.Badge,{variant:"outline",className:"bg-gray-500/10 text-gray-500 border-gray-500",children:"Inactive"}),"sent"===e.status&&(0,a.jsx)(l.Badge,{variant:"outline",className:"bg-blue-500/10 text-blue-500 border-blue-500",children:"Sent"})]})}),(0,a.jsx)(u.TableCell,{className:"text-right",children:(0,a.jsxs)("div",{className:"flex gap-1 justify-end",children:[(e.partner_id||e.introducer_id||e.commercial_partner_id)&&"sent"!==e.status&&(0,a.jsx)(n.Button,{variant:"ghost",size:"sm",onClick:()=>eN(e),disabled:et===e.id,title:"Send to entity","aria-label":`Send fee plan "${e.name}" to entity`,children:et===e.id?(0,a.jsx)(b.Loader2,{className:"h-4 w-4 animate-spin","aria-hidden":"true"}):(0,a.jsx)(C.Send,{className:"h-4 w-4 text-blue-500","aria-hidden":"true"})}),"sent"===e.status&&(0,a.jsx)(n.Button,{variant:"ghost",size:"sm",disabled:!0,title:"Already sent","aria-label":"Fee plan already sent",children:(0,a.jsx)(S.CheckCircle,{className:"h-4 w-4 text-green-500","aria-hidden":"true"})}),"sent"!==e.status&&(0,a.jsx)(n.Button,{variant:"ghost",size:"sm",onClick:()=>eg(e),"aria-label":`Edit fee plan "${e.name}"`,children:(0,a.jsx)(h.Edit,{className:"h-4 w-4","aria-hidden":"true"})}),(0,a.jsx)(n.Button,{variant:"ghost",size:"sm",onClick:()=>ej(e),"aria-label":`Delete fee plan "${e.name}"`,children:(0,a.jsx)(f.Trash2,{className:"h-4 w-4 text-red-500","aria-hidden":"true"})})]})})]},e.id))})]})})})]})}),(0,a.jsx)(P.TabsContent,{value:"by-opportunity",children:(0,a.jsx)(()=>(0,a.jsxs)("div",{className:"space-y-4",children:[Array.from(q.entries()).map(([e,{deal:t,plans:r}])=>(0,a.jsxs)(s.Card,{children:[(0,a.jsx)(s.CardHeader,{className:"cursor-pointer hover:bg-muted/50 transition-colors py-4",onClick:()=>ew(e),onKeyDown:a=>{("Enter"===a.key||" "===a.key)&&(a.preventDefault(),ew(e))},tabIndex:0,role:"button","aria-expanded":K.has(e),"aria-label":`${t.name} - ${r.length} fee plan${1!==r.length?"s":""}`,children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[K.has(e)?(0,a.jsx)(T.ChevronDown,{className:"h-5 w-5","aria-hidden":"true"}):(0,a.jsx)(k.ChevronRight,{className:"h-5 w-5","aria-hidden":"true"}),(0,a.jsxs)("div",{children:[(0,a.jsx)(s.CardTitle,{className:"text-lg",children:t.name}),(0,a.jsxs)(s.CardDescription,{children:[r.length," fee plan",1!==r.length?"s":"",t.status&&` â€¢ ${t.status}`]})]})]}),(0,a.jsx)(l.Badge,{variant:"outline",children:r.length})]})}),K.has(e)&&(0,a.jsx)(s.CardContent,{className:"pt-0",children:(0,a.jsx)("div",{className:"space-y-3",children:r.map(e=>(0,a.jsxs)("div",{className:"border rounded-lg p-4 bg-muted/30",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(g.FileText,{className:"h-4 w-4 text-muted-foreground"}),(0,a.jsx)("span",{className:"font-medium",children:e.name}),"sent"===e.status&&(0,a.jsx)(l.Badge,{variant:"outline",className:"bg-blue-500/10 text-blue-500 text-xs",children:"Sent"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[eS(e),(0,a.jsx)("span",{className:"text-sm text-muted-foreground",children:eC(e)})]})]}),e.description&&(0,a.jsx)("p",{className:"text-sm text-muted-foreground mb-2",children:e.description}),(0,a.jsx)("div",{className:"flex flex-wrap gap-1 mt-2",children:e.components?.map((e,t)=>(0,a.jsxs)(l.Badge,{variant:"secondary",className:"text-xs",children:[e.kind,": ",e.rate_bps?e_(e.rate_bps):e.flat_amount?`$${e.flat_amount}`:"N/A"]},t))}),(0,a.jsxs)("div",{className:"flex gap-2 mt-3 pt-3 border-t",children:[(e.partner_id||e.introducer_id||e.commercial_partner_id)&&"sent"!==e.status&&(0,a.jsxs)(n.Button,{variant:"outline",size:"sm",onClick:a=>{a.stopPropagation(),eN(e)},disabled:et===e.id,children:[et===e.id?(0,a.jsx)(b.Loader2,{className:"h-3 w-3 mr-1 animate-spin"}):(0,a.jsx)(C.Send,{className:"h-3 w-3 mr-1"}),"Send"]}),"sent"!==e.status&&(0,a.jsxs)(n.Button,{variant:"outline",size:"sm",onClick:a=>{a.stopPropagation(),eg(e)},children:[(0,a.jsx)(h.Edit,{className:"h-3 w-3 mr-1"})," Edit"]}),(0,a.jsxs)(n.Button,{variant:"outline",size:"sm",onClick:a=>{a.stopPropagation(),ej(e)},children:[(0,a.jsx)(f.Trash2,{className:"h-3 w-3 mr-1 text-red-500"})," Delete"]})]})]},e.id))})})]},e)),0===q.size&&(0,a.jsxs)("div",{className:"border border-dashed rounded-lg py-12 flex flex-col items-center justify-center text-center space-y-2",children:[(0,a.jsx)(A,{className:"h-10 w-10 text-muted-foreground"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"No fee plans to display by opportunity"})]})]}),{})})]}),(0,a.jsx)(m.Dialog,{open:Y,onOpenChange:W,children:(0,a.jsxs)(m.DialogContent,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[(0,a.jsxs)(m.DialogHeader,{children:[(0,a.jsx)(m.DialogTitle,{children:Z?"Edit Fee Plan":"Create Fee Plan"}),(0,a.jsx)(m.DialogDescription,{children:"Define the fee structure for your network partners"})]}),L&&(0,a.jsxs)("div",{className:"bg-red-500/10 border border-red-500/30 text-red-400 text-sm p-3 rounded flex items-center gap-2",children:[(0,a.jsx)(v.AlertCircle,{className:"h-4 w-4 flex-shrink-0"}),L]}),(0,a.jsxs)("div",{className:"space-y-6 py-4",children:[(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(d.Label,{htmlFor:"name",children:"Plan Name *"}),(0,a.jsx)(i.Input,{id:"name",value:es,onChange:e=>en(e.target.value),placeholder:"e.g., Standard Partner Fee"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(d.Label,{htmlFor:"description",children:"Description"}),(0,a.jsx)(o.Textarea,{id:"description",value:el,onChange:e=>ei(e.target.value),placeholder:"Optional description",rows:2})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(d.Label,{children:"Entity Type"}),(0,a.jsxs)(c.Select,{value:ed,onValueChange:e=>{eo(e),eu("none")},children:[(0,a.jsx)(c.SelectTrigger,{children:(0,a.jsx)(c.SelectValue,{})}),(0,a.jsxs)(c.SelectContent,{children:[(0,a.jsx)(c.SelectItem,{value:"none",children:"General (No specific entity)"}),(0,a.jsx)(c.SelectItem,{value:"partner",children:"Partner"}),(0,a.jsx)(c.SelectItem,{value:"introducer",children:"Introducer"}),(0,a.jsx)(c.SelectItem,{value:"commercial_partner",children:"Commercial Partner"})]})]})]}),"none"!==ed&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)(d.Label,{children:["Select ","partner"===ed?"Partner":"introducer"===ed?"Introducer":"Commercial Partner"]}),(0,a.jsxs)(c.Select,{value:ec,onValueChange:eu,children:[(0,a.jsx)(c.SelectTrigger,{children:(0,a.jsx)(c.SelectValue,{placeholder:"Select..."})}),(0,a.jsxs)(c.SelectContent,{children:[(0,a.jsx)(c.SelectItem,{value:"none",children:"None"}),$.filter(e=>e.type===ed).map(e=>(0,a.jsx)(c.SelectItem,{value:e.id,children:e.name},e.id))]})]})]})]})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)(d.Label,{children:["Fee Components (",em.length,")"]}),(0,a.jsxs)(n.Button,{onClick:()=>{ep([...em,{kind:"management",calc_method:"percent_per_annum",frequency:"quarterly",payment_schedule:"recurring"}])},size:"sm",variant:"outline",children:[(0,a.jsx)(x.Plus,{className:"h-4 w-4 mr-1"}),"Add Component"]})]}),0===em.length?(0,a.jsx)("div",{className:"border border-dashed rounded-lg py-8 text-center text-muted-foreground",children:'Click "Add Component" to define fee components'}):(0,a.jsx)("div",{className:"space-y-4",children:em.map((e,t)=>(0,a.jsxs)(s.Card,{children:[(0,a.jsxs)(s.CardHeader,{className:"py-3 flex flex-row items-center justify-between",children:[(0,a.jsxs)(s.CardTitle,{className:"text-sm",children:["Component ",t+1]}),(0,a.jsx)(n.Button,{variant:"ghost",size:"sm",onClick:()=>{ep(em.filter((e,a)=>a!==t))},children:(0,a.jsx)(_.X,{className:"h-4 w-4"})})]}),(0,a.jsxs)(s.CardContent,{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(d.Label,{children:"Fee Type"}),(0,a.jsxs)(c.Select,{value:e.kind,onValueChange:e=>eb(t,{kind:e}),children:[(0,a.jsx)(c.SelectTrigger,{children:(0,a.jsx)(c.SelectValue,{})}),(0,a.jsx)(c.SelectContent,{children:R.map(e=>(0,a.jsx)(c.SelectItem,{value:e.value,children:e.label},e.value))})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(d.Label,{children:"Payment Schedule"}),(0,a.jsxs)(c.Select,{value:e.payment_schedule||"recurring",onValueChange:e=>eb(t,{payment_schedule:e}),children:[(0,a.jsx)(c.SelectTrigger,{children:(0,a.jsx)(c.SelectValue,{})}),(0,a.jsx)(c.SelectContent,{children:B.map(e=>(0,a.jsx)(c.SelectItem,{value:e.value,children:e.label},e.value))})]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(d.Label,{children:"Rate (basis points)"}),(0,a.jsx)(i.Input,{type:"number",value:e.rate_bps||"",onChange:e=>eb(t,{rate_bps:e.target.value?Number(e.target.value):void 0}),placeholder:"e.g., 200 = 2%"}),e.rate_bps&&(0,a.jsxs)("p",{className:"text-xs text-muted-foreground",children:["= ",(e.rate_bps/100).toFixed(2),"%"]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(d.Label,{children:"Flat Amount ($)"}),(0,a.jsx)(i.Input,{type:"number",value:e.flat_amount||"",onChange:e=>eb(t,{flat_amount:e.target.value?Number(e.target.value):void 0}),placeholder:"e.g., 5000"})]})]})]})]},t))})]})]}),(0,a.jsxs)(m.DialogFooter,{children:[(0,a.jsx)(n.Button,{variant:"outline",onClick:()=>W(!1),disabled:ee,children:"Cancel"}),(0,a.jsx)(n.Button,{onClick:ev,disabled:ee,children:ee?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(b.Loader2,{className:"h-4 w-4 mr-2 animate-spin"}),"Saving..."]}):Z?"Update Plan":"Create Plan"})]})]})}),(0,a.jsx)(p.AlertDialog,{open:J,onOpenChange:X,children:(0,a.jsxs)(p.AlertDialogContent,{children:[(0,a.jsxs)(p.AlertDialogHeader,{children:[(0,a.jsx)(p.AlertDialogTitle,{children:"Delete Fee Plan?"}),(0,a.jsxs)(p.AlertDialogDescription,{children:['Are you sure you want to delete "',Z?.name,'"? This will deactivate the fee plan and hide it from the list. Existing subscriptions using this plan will not be affected.']})]}),(0,a.jsxs)(p.AlertDialogFooter,{children:[(0,a.jsx)(p.AlertDialogCancel,{children:"Cancel"}),(0,a.jsx)(p.AlertDialogAction,{onClick:ey,className:"bg-red-500 hover:bg-red-600",children:"Delete"})]})]})})]})}e.s(["default",()=>$],726907)}]);