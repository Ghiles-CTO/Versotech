(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,786560,e=>{"use strict";var t=e.i(722679),r=e.i(340915),a=e.i(415814),s=e.i(285614),n=e.i(352776),l=e.i(316264),d=e.i(191569),i=e.i(514133),c=e.i(538892),o=e.i(312692),m=e.i(129432),u=e.i(831833),x=e.i(554369),h=e.i(263229),p=e.i(619324),b=e.i(230112),g=e.i(119311),f=e.i(196767),_=e.i(71637),j=e.i(310556),v=e.i(971743),N=e.i(401148);function y({dealId:e,value:a,onChange:s,required:n=!0,disabled:l=!1}){let[d,o]=(0,r.useState)(!1),[u,x]=(0,r.useState)([]),[p,b]=(0,r.useState)(null);(0,r.useEffect)(()=>{e?f(e):(x([]),s(void 0,null))},[e]);let f=async e=>{o(!0),b(null);try{let t=await fetch(`/api/deals/${e}/fee-structures?status=published`);if(!t.ok)throw Error("Failed to load term sheets");let r=(await t.json()).term_sheets||[];x(r),a&&!r.find(e=>e.id===a)&&s(void 0,null)}catch(e){console.error("Error loading term sheets:",e),b("Failed to load term sheets"),x([])}finally{o(!1)}},_=e=>null==e?"-":`${e}%`,j=u.find(e=>e.id===a);return e?(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(i.Label,{className:"text-foreground font-medium",children:["Term Sheet ",n&&(0,t.jsx)("span",{className:"text-red-500 dark:text-red-400",children:"*"})]}),d?(0,t.jsxs)("div",{className:"flex items-center gap-2 text-muted-foreground h-11 px-3 border border-border rounded-md bg-muted/50",children:[(0,t.jsx)(h.Loader2,{className:"h-4 w-4 animate-spin"}),(0,t.jsx)("span",{className:"text-sm",children:"Loading term sheets..."})]}):p?(0,t.jsxs)("div",{className:"flex items-center gap-2 text-red-500 dark:text-red-400 text-sm bg-red-500/10 p-3 rounded border border-red-500/30",children:[(0,t.jsx)(N.AlertCircle,{className:"h-4 w-4"}),(0,t.jsx)("span",{children:p})]}):0===u.length?(0,t.jsxs)("div",{className:"flex items-center gap-2 text-amber-600 dark:text-amber-400 text-sm bg-amber-500/10 p-3 rounded border border-amber-500/30",children:[(0,t.jsx)(N.AlertCircle,{className:"h-4 w-4"}),(0,t.jsx)("span",{children:"No published term sheets available for this deal. Create and publish a term sheet first."})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(c.Select,{value:a||"none",onValueChange:e=>{if("none"===e)s(void 0,null);else{let t=u.find(t=>t.id===e);s(e,t||null)}},disabled:l,children:[(0,t.jsx)(c.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-11",children:(0,t.jsx)(c.SelectValue,{placeholder:"Select a term sheet"})}),(0,t.jsxs)(c.SelectContent,{className:"bg-popover border-border",children:[!n&&(0,t.jsx)(c.SelectItem,{value:"none",children:"No term sheet"}),u.map(e=>(0,t.jsx)(c.SelectItem,{value:e.id,children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(g.FileText,{className:"h-4 w-4 text-muted-foreground"}),(0,t.jsxs)("span",{children:["Version ",e.version]}),e.term_sheet_date&&(0,t.jsxs)("span",{className:"text-muted-foreground text-xs",children:["(",new Date(e.term_sheet_date).toLocaleDateString(),")"]})]})},e.id))]})]}),j&&(0,t.jsxs)("div",{className:"bg-muted/50 border border-border rounded-md p-3 mt-2",children:[(0,t.jsx)("p",{className:"text-xs text-muted-foreground mb-2 font-medium",children:"Term Sheet Fee Limits:"}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,t.jsxs)(m.Badge,{variant:"outline",className:"text-xs border-blue-500/30 text-blue-600 dark:text-blue-400",children:["Subscription: ",_(j.subscription_fee_percent)]}),(0,t.jsxs)(m.Badge,{variant:"outline",className:"text-xs border-green-500/30 text-green-600 dark:text-green-400",children:["Management: ",_(j.management_fee_percent)]}),(0,t.jsxs)(m.Badge,{variant:"outline",className:"text-xs border-purple-500/30 text-purple-600 dark:text-purple-400",children:["Performance: ",_(j.carried_interest_percent)]})]}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground mt-2",children:"Fee model values must not exceed these limits."})]})]})]}):(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(i.Label,{className:"text-foreground font-medium",children:["Term Sheet ",n&&(0,t.jsx)("span",{className:"text-red-500 dark:text-red-400",children:"*"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 text-amber-600 dark:text-amber-400 text-sm bg-amber-500/10 p-3 rounded border border-amber-500/30",children:[(0,t.jsx)(N.AlertCircle,{className:"h-4 w-4"}),(0,t.jsx)("span",{children:"Select a deal first to see available term sheets"})]})]})}var w=e.i(501259),S=e.i(691974);function k({dealId:e,entityType:a,onEntityTypeChange:s,entityId:n,onEntityIdChange:l,required:d=!0,disabled:o=!1,excludeTypes:m=[]}){let[u,x]=(0,r.useState)(!1),[p,b]=(0,r.useState)([]),[g,f]=(0,r.useState)(null);(0,r.useEffect)(()=>{e&&a?_(e,a):(b([]),l(void 0))},[e,a]);let _=async(e,t)=>{x(!0),f(null);try{let r="";switch(t){case"introducer":r=`/api/deals/${e}/introducers`;break;case"partner":r=`/api/deals/${e}/partners`;break;case"commercial_partner":r=`/api/deals/${e}/commercial-partners`}let a=await fetch(r);if(!a.ok){console.warn(`Entity endpoint ${r} not available, trying fallback`),await j(t);return}let s=await a.json(),d=s.introducers||s.partners||s.commercial_partners||[];if(0===d.length&&s.data&&Array.isArray(s.data)&&(d=s.data.filter(e=>e.entity_type===t.replace("_","")).map(e=>({id:e.entity_id,name:e.entity_name,email:e.entity_email}))),0===d.length){console.log(`No ${t}s found for deal, loading all ${t}s from admin endpoint`),await j(t);return}b(d),n&&!d.find(e=>e.id===n)&&l(void 0)}catch(e){console.error("Error loading entities:",e),await j(t)}finally{x(!1)}},j=async e=>{try{let t="";switch(e){case"introducer":t="/api/admin/introducers";break;case"partner":t="/api/admin/partners";break;case"commercial_partner":t="/api/admin/commercial-partners"}let r=await fetch(t);if(!r.ok)throw Error(`Failed to load ${e}s`);let a=await r.json(),s=(a.introducers||a.partners||a.commercial_partners||a.data||[]).map(e=>({id:e.id,name:e.name||e.legal_name||e.company_name||e.contact_name,email:e.email||e.contact_email,company_name:e.company_name||e.legal_name}));b(s)}catch(t){console.error("Error in fallback loading:",t),f(`Failed to load ${e}s`),b([])}},y=e=>{switch(e){case"introducer":return"Introducer";case"partner":return"Partner";case"commercial_partner":return"Commercial Partner"}};return e?(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(i.Label,{className:"text-white font-medium",children:["Entity Type ",d&&(0,t.jsx)("span",{className:"text-red-400",children:"*"})]}),(0,t.jsxs)(c.Select,{value:a||"none",onValueChange:e=>{"none"===e?s(void 0):s(e),l(void 0)},disabled:o,children:[(0,t.jsx)(c.SelectTrigger,{className:"bg-black border-gray-700 text-white h-11",children:(0,t.jsx)(c.SelectValue,{placeholder:"Select entity type"})}),(0,t.jsxs)(c.SelectContent,{className:"bg-black border-gray-700 text-white",children:[!d&&(0,t.jsx)(c.SelectItem,{value:"none",children:"No entity"}),!m.includes("introducer")&&(0,t.jsx)(c.SelectItem,{value:"introducer",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(w.Users,{className:"h-4 w-4 text-blue-400"}),(0,t.jsx)("span",{children:"Introducer"})]})}),!m.includes("partner")&&(0,t.jsx)(c.SelectItem,{value:"partner",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(v.Building2,{className:"h-4 w-4 text-green-400"}),(0,t.jsx)("span",{children:"Partner"})]})}),!m.includes("commercial_partner")&&(0,t.jsx)(c.SelectItem,{value:"commercial_partner",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(S.Briefcase,{className:"h-4 w-4 text-purple-400"}),(0,t.jsx)("span",{children:"Commercial Partner"})]})})]})]})]}),a&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(i.Label,{className:"text-white font-medium",children:[y(a)," ",d&&(0,t.jsx)("span",{className:"text-red-400",children:"*"})]}),u?(0,t.jsxs)("div",{className:"flex items-center gap-2 text-gray-400 h-11 px-3 border border-gray-700 rounded-md bg-black",children:[(0,t.jsx)(h.Loader2,{className:"h-4 w-4 animate-spin"}),(0,t.jsxs)("span",{className:"text-sm",children:["Loading ",a,"s..."]})]}):g?(0,t.jsxs)("div",{className:"flex items-center gap-2 text-red-400 text-sm bg-red-500/10 p-3 rounded border border-red-500/30",children:[(0,t.jsx)(N.AlertCircle,{className:"h-4 w-4"}),(0,t.jsx)("span",{children:g})]}):0===p.length?(0,t.jsxs)("div",{className:"flex items-center gap-2 text-amber-400 text-sm bg-amber-500/10 p-3 rounded border border-amber-500/30",children:[(0,t.jsx)(N.AlertCircle,{className:"h-4 w-4"}),(0,t.jsxs)("span",{children:["No ",a,"s available. Add ",a,"s to the system first."]})]}):(0,t.jsxs)(c.Select,{value:n||"none",onValueChange:e=>{"none"===e?l(void 0):l(e)},disabled:o,children:[(0,t.jsx)(c.SelectTrigger,{className:"bg-black border-gray-700 text-white h-11",children:(0,t.jsx)(c.SelectValue,{placeholder:`Select ${y(a)}`})}),(0,t.jsxs)(c.SelectContent,{className:"bg-black border-gray-700 text-white max-h-60",children:[!d&&(0,t.jsx)(c.SelectItem,{value:"none",children:"No selection"}),p.map(e=>(0,t.jsx)(c.SelectItem,{value:e.id,children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(e=>{switch(e){case"introducer":return(0,t.jsx)(w.Users,{className:"h-4 w-4"});case"partner":return(0,t.jsx)(v.Building2,{className:"h-4 w-4"});case"commercial_partner":return(0,t.jsx)(S.Briefcase,{className:"h-4 w-4"});default:return null}})(a),(0,t.jsx)("span",{children:e.name||e.company_name}),e.email&&(0,t.jsxs)("span",{className:"text-gray-400 text-xs",children:["(",e.email,")"]})]})},e.id))]})]})]})]}):(0,t.jsx)("div",{className:"space-y-4",children:(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)(i.Label,{className:"text-white font-medium",children:["Entity Type ",d&&(0,t.jsx)("span",{className:"text-red-400",children:"*"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 text-amber-400 text-sm bg-amber-500/10 p-3 rounded border border-amber-500/30",children:[(0,t.jsx)(N.AlertCircle,{className:"h-4 w-4"}),(0,t.jsx)("span",{children:"Select a deal first to assign an entity"})]})]})})}let C=[{value:"subscription",label:"Subscription Fee",color:"blue"},{value:"management",label:"Management Fee",color:"green"},{value:"performance",label:"Performance Fee",color:"purple"},{value:"flat",label:"Flat Fee",color:"amber"},{value:"spread_markup",label:"Spread/Markup",color:"cyan"},{value:"other",label:"Other",color:"gray"}],I=[{value:"percent_of_investment",label:"% of Investment"},{value:"percent_per_annum",label:"% per Annum"},{value:"percent_of_profit",label:"% of Profit"},{value:"fixed_amount",label:"Fixed Amount"}],T=["British Virgin Islands","England and Wales","Cayman Islands","Delaware, USA","Singapore"],L={duration_months:36,non_circumvention_months:null,non_circumvention_indefinite:!0,governing_law:"British Virgin Islands",vat_number:"",intro_payment_days:3,perf_payment_days:10,has_catchup:!1,has_high_water_mark:!1,has_no_cap:!0};function F({title:e,icon:r,isOpen:n,onToggle:l,children:d,badge:i,status:c}){return(0,t.jsxs)("div",{className:"border border-border rounded-2xl overflow-hidden bg-card shadow-lg",children:[(0,t.jsxs)("button",{type:"button",onClick:l,className:"w-full px-8 py-6 flex items-center justify-between hover:bg-muted/60 transition-colors",children:[(0,t.jsxs)("div",{className:"flex items-center gap-5",children:[(0,t.jsx)("div",{className:"text-blue-500 dark:text-blue-400 p-2 bg-blue-500/10 rounded-lg",children:r}),(0,t.jsx)("span",{className:"font-bold text-foreground text-xl",children:e}),i&&(0,t.jsx)(m.Badge,{variant:"outline",className:"text-sm border-border text-foreground px-3 py-1 font-medium",children:i})]}),(0,t.jsxs)("div",{className:"flex items-center gap-5",children:["complete"===c&&(0,t.jsx)("div",{className:"w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center",children:(0,t.jsx)(j.Check,{className:"w-5 h-5 text-green-500 dark:text-green-400"})}),"error"===c&&(0,t.jsx)("div",{className:"w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center",children:(0,t.jsx)(p.AlertTriangle,{className:"w-5 h-5 text-red-500 dark:text-red-400"})}),(0,t.jsx)(a.motion.div,{animate:{rotate:180*!!n},transition:{duration:.2},className:"p-1",children:(0,t.jsx)(b.ChevronDown,{className:"w-6 h-6 text-muted-foreground"})})]})]}),(0,t.jsx)(s.AnimatePresence,{children:n&&(0,t.jsx)(a.motion.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.25,ease:"easeInOut"},children:(0,t.jsx)("div",{className:"px-8 pb-8 pt-6 border-t border-border bg-muted/30",children:d})})})]})}function A({component:e,index:a,onChange:s,onRemove:n,termSheetLimits:o}){let m=C.find(t=>t.value===e.kind),u=e.rate_bps?(e.rate_bps/100).toFixed(2):null,h=(0,r.useMemo)(()=>{if(!o||!e.rate_bps)return!1;let t=o[e.kind];return!!t&&e.rate_bps/100>t},[o,e.rate_bps,e.kind]);return(0,t.jsxs)("div",{className:`border-2 rounded-2xl p-6 bg-card ${(()=>{switch(m?.color){case"blue":return"border-blue-500/40";case"green":return"border-green-500/40";case"purple":return"border-purple-500/40";case"amber":return"border-amber-500/40";case"cyan":return"border-cyan-500/40";default:return"border-border"}})()} transition-all hover:bg-muted/60`,children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,t.jsxs)("div",{className:"flex items-center gap-5",children:[(0,t.jsx)("div",{className:`w-12 h-12 rounded-xl ${(()=>{switch(m?.color){case"blue":return"bg-blue-500/20 text-blue-400";case"green":return"bg-green-500/20 text-green-400";case"purple":return"bg-purple-500/20 text-purple-400";case"amber":return"bg-amber-500/20 text-amber-400";case"cyan":return"bg-cyan-500/20 text-cyan-400";default:return"bg-muted text-muted-foreground"}})()} flex items-center justify-center font-bold text-lg`,children:a+1}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)(i.Label,{className:"text-sm text-muted-foreground",children:"Fee Type"}),(0,t.jsxs)(c.Select,{value:e.kind,onValueChange:e=>s({kind:e}),children:[(0,t.jsx)(c.SelectTrigger,{className:"w-64 bg-muted/50 border-border text-foreground h-12 text-base font-medium",children:(0,t.jsx)(c.SelectValue,{})}),(0,t.jsx)(c.SelectContent,{className:"bg-popover border-border",children:C.map(e=>(0,t.jsx)(c.SelectItem,{value:e.value,className:"text-base py-3",children:e.label},e.value))})]})]})]}),(0,t.jsx)(l.Button,{type:"button",variant:"ghost",size:"icon",onClick:n,className:"text-muted-foreground hover:text-red-500 dark:hover:text-red-400 hover:bg-red-500/10 h-12 w-12 rounded-xl",children:(0,t.jsx)(x.Trash2,{className:"w-6 h-6"})})]}),(0,t.jsxs)("div",{className:"grid grid-cols-4 gap-6",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.Label,{className:"text-sm text-muted-foreground font-medium",children:"Calculation Method"}),(0,t.jsxs)(c.Select,{value:e.calc_method,onValueChange:e=>s({calc_method:e}),children:[(0,t.jsx)(c.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-12 text-base",children:(0,t.jsx)(c.SelectValue,{})}),(0,t.jsx)(c.SelectContent,{className:"bg-popover border-border",children:I.map(e=>(0,t.jsx)(c.SelectItem,{value:e.value,className:"text-base py-2.5",children:e.label},e.value))})]})]}),"fixed_amount"===e.calc_method?(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.Label,{className:"text-sm text-muted-foreground font-medium",children:"Amount (USD)"}),(0,t.jsx)(d.Input,{type:"number",step:"0.01",min:"0",value:e.flat_amount||"",onChange:e=>s({flat_amount:e.target.value?Number(e.target.value):void 0}),placeholder:"5,000.00",className:"bg-muted/50 border-border text-foreground h-12 text-lg font-mono"}),e.flat_amount&&(0,t.jsxs)("p",{className:"text-base text-green-600 dark:text-green-400 font-semibold",children:["$",e.flat_amount.toLocaleString()]})]}):(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.Label,{className:"text-sm text-muted-foreground font-medium",children:"Rate (Basis Points)"}),(0,t.jsx)(d.Input,{type:"number",value:e.rate_bps||"",onChange:e=>s({rate_bps:e.target.value?Number(e.target.value):void 0}),placeholder:"200",className:`bg-muted/50 border-border text-foreground h-12 text-lg font-mono ${h?"border-red-500 bg-red-500/10":""}`}),u&&(0,t.jsxs)("p",{className:`text-base font-semibold ${h?"text-red-500 dark:text-red-400":"text-blue-600 dark:text-blue-400"}`,children:["= ",u,"%",h&&" ⚠️ exceeds limit"]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.Label,{className:"text-sm text-muted-foreground font-medium",children:"Payment Schedule"}),(0,t.jsxs)(c.Select,{value:e.payment_schedule||"upfront",onValueChange:e=>s({payment_schedule:e}),children:[(0,t.jsx)(c.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-12 text-base",children:(0,t.jsx)(c.SelectValue,{})}),(0,t.jsxs)(c.SelectContent,{className:"bg-popover border-border",children:[(0,t.jsx)(c.SelectItem,{value:"upfront",className:"text-base py-2.5",children:"Upfront"}),(0,t.jsx)(c.SelectItem,{value:"recurring",className:"text-base py-2.5",children:"Recurring"}),(0,t.jsx)(c.SelectItem,{value:"on_demand",className:"text-base py-2.5",children:"On Demand"})]})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.Label,{className:"text-sm text-muted-foreground font-medium",children:"Notes"}),(0,t.jsx)(d.Input,{value:e.notes||"",onChange:e=>s({notes:e.target.value}),placeholder:"Optional notes...",className:"bg-muted/50 border-border text-foreground h-12 text-base"})]})]})]})}function P({open:e,onClose:m,onSuccess:x,feePlan:b,dealId:j,initialTermSheetId:N}){let[w,S]=(0,r.useState)(!1),[C,I]=(0,r.useState)(null),[P,$]=(0,r.useState)({basic:!0,components:!0,agreement:!1}),[B,V]=(0,r.useState)([]),[E,D]=(0,r.useState)([]),[O,M]=(0,r.useState)(""),[U,R]=(0,r.useState)(""),[q,z]=(0,r.useState)(j),[G,H]=(0,r.useState)(!0),[W,K]=(0,r.useState)(N),[J,Q]=(0,r.useState)(null),[X,Y]=(0,r.useState)(),[Z,ee]=(0,r.useState)(),[et,er]=(0,r.useState)([]),[ea,es]=(0,r.useState)(L),en=!!b,el=et.some(e=>"performance"===e.kind),ed=et.some(e=>"subscription"===e.kind),ei=(0,r.useMemo)(()=>{if(J)return{subscription:J.subscription_fee_percent||void 0,management:J.management_fee_percent||void 0,performance:J.carried_interest_percent||void 0}},[J]),ec=O.trim()&&q&&W&&X&&Z,eo=0===E.length;(0,r.useEffect)(()=>{e&&eu()},[e]),(0,r.useEffect)(()=>{if(e)if(b){M(b.name),R(b.description||""),z(b.deal_id||void 0),H(b.is_active),K(b.term_sheet_id||void 0),b.introducer_id?(Y("introducer"),ee(b.introducer_id)):b.partner_id?(Y("partner"),ee(b.partner_id)):b.commercial_partner_id&&(Y("commercial_partner"),ee(b.commercial_partner_id)),es({duration_months:b.agreement_duration_months??36,non_circumvention_months:b.non_circumvention_months??null,non_circumvention_indefinite:null==b.non_circumvention_months,governing_law:b.governing_law??"British Virgin Islands",vat_number:b.vat_registration_number??"",intro_payment_days:3,perf_payment_days:10,hurdle_rate_bps:void 0,has_catchup:!1,catchup_rate_bps:void 0,has_high_water_mark:!1,has_no_cap:!0,performance_cap_percent:void 0});let e=b.components||[],t=e.find(e=>"subscription"===e.kind),r=e.find(e=>"performance"===e.kind);t&&es(e=>({...e,intro_payment_days:t.payment_days_after_event??3})),r&&es(e=>({...e,perf_payment_days:r.payment_days_after_event??10,hurdle_rate_bps:r.hurdle_rate_bps,has_catchup:r.has_catchup??!1,catchup_rate_bps:r.catchup_rate_bps,has_high_water_mark:r.has_high_water_mark??!1,has_no_cap:r.has_no_cap??!0,performance_cap_percent:r.performance_cap_percent})),er(e.map(e=>({id:e.id,kind:e.kind,calc_method:e.calc_method||"percent_of_investment",frequency:e.frequency||"one_time",rate_bps:e.rate_bps,flat_amount:e.flat_amount,notes:e.notes||"",payment_schedule:e.payment_schedule||"upfront",duration_periods:e.duration_periods,duration_unit:e.duration_unit})))}else em()},[e,b,j,N]),(0,r.useEffect)(()=>{J&&et.length>0?D(function(e,t){let r=[];for(let s of e){var a;if(!s.rate_bps)continue;let e=null==(a=s.rate_bps)?null:a/100;if(null!==e)switch(s.kind){case"subscription":null!==t.subscription_fee_percent&&void 0!==t.subscription_fee_percent&&e>t.subscription_fee_percent&&r.push(`Subscription fee (${e}%) exceeds term sheet limit (${t.subscription_fee_percent}%)`);break;case"management":null!==t.management_fee_percent&&void 0!==t.management_fee_percent&&e>t.management_fee_percent&&r.push(`Management fee (${e}%) exceeds term sheet limit (${t.management_fee_percent}%)`);break;case"performance":null!==t.carried_interest_percent&&void 0!==t.carried_interest_percent&&e>t.carried_interest_percent&&r.push(`Performance fee (${e}%) exceeds term sheet limit (${t.carried_interest_percent}%)`)}}return r}(et,J)):D([])},[et,J]),(0,r.useEffect)(()=>{X&&Z&&$(e=>({...e,agreement:!0}))},[X,Z]);let em=(0,r.useCallback)(()=>{M(""),R(""),z(j),H(!0),K(N),Q(null),Y(void 0),ee(void 0),er([]),es(L),I(null),D([]),$({basic:!0,components:!0,agreement:!1})},[j,N]),eu=async()=>{try{let e=await fetch("/api/deals"),t=await e.json();V(t.deals||[])}catch(e){console.error("Error loading deals:",e)}},ex=e=>{$(t=>({...t,[e]:!t[e]}))},eh=()=>{er([...et,{kind:"subscription",calc_method:"percent_of_investment",frequency:"one_time",payment_schedule:"upfront"}])},ep=e=>{es(t=>({...t,...e}))},eb=async()=>{if(!O.trim())return void I("Plan name is required");if(!q)return void I("A deal must be selected");if(!W)return void I("A term sheet must be selected");if(!X||!Z)return void I("An entity must be selected");if(E.length>0)return void I(`Fee values exceed term sheet limits: ${E.join("; ")}`);S(!0),I(null);try{let e=et.map(e=>{let{id:t,notes:r,...a}=e,s={...a,notes:r?.trim()||void 0,has_catchup:!1,has_high_water_mark:!1,...t&&t.length>10?{id:t}:{}};return"subscription"===e.kind?{...s,payment_days_after_event:ea.intro_payment_days}:"performance"===e.kind?{...s,payment_days_after_event:ea.perf_payment_days,hurdle_rate_bps:ea.hurdle_rate_bps||void 0,has_catchup:ea.has_catchup,catchup_rate_bps:ea.has_catchup?ea.catchup_rate_bps:void 0,has_high_water_mark:ea.has_high_water_mark,has_no_cap:ea.has_no_cap,performance_cap_percent:ea.has_no_cap?void 0:ea.performance_cap_percent}:s}),t={name:O.trim(),description:U.trim()||void 0,deal_id:q,term_sheet_id:W,...{introducer_id:"introducer"===X?Z:void 0,partner_id:"partner"===X?Z:void 0,commercial_partner_id:"commercial_partner"===X?Z:void 0},is_active:G,agreement_duration_months:ea.duration_months,non_circumvention_months:ea.non_circumvention_indefinite?null:ea.non_circumvention_months,governing_law:ea.governing_law,vat_registration_number:ea.vat_number.trim()||null,components:e},r=b?`/api/staff/fees/plans/${b.id}`:"/api/staff/fees/plans",a=await fetch(r,{method:b?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok){let e=await a.json().catch(()=>({error:`HTTP ${a.status}`})),t=e.error||"Failed to save",r=e.details?`
${e.details}`:"";throw Error(`${t}${r}`)}x()}catch(e){I(e instanceof Error?e.message:"Failed to save fee plan")}finally{S(!1)}};return(0,t.jsx)(n.Dialog,{open:e,onOpenChange:e=>!e&&m(),children:(0,t.jsxs)(n.DialogContent,{showCloseButton:!1,className:"!max-w-[1400px] !w-[96vw] !max-h-[94vh] !p-0 bg-background border-border text-foreground overflow-hidden flex flex-col",children:[(0,t.jsx)(n.DialogHeader,{className:"px-10 py-6 border-b border-border bg-gradient-to-r from-blue-500/5 dark:from-blue-900/10 via-muted/30 to-transparent shrink-0",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(n.DialogTitle,{className:"text-2xl font-bold text-foreground tracking-tight",children:en?"Edit Fee Plan":"Create New Fee Plan"}),(0,t.jsx)("p",{className:"text-base text-muted-foreground mt-2",children:en?"Modify fee structure and agreement terms":"Define a fee structure for a partner or introducer agreement"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-6",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 bg-muted/50 px-4 py-2 rounded-lg border border-border",children:[(0,t.jsx)(o.Checkbox,{id:"is_active",checked:G,onCheckedChange:e=>H(e),className:"border-border h-5 w-5"}),(0,t.jsx)(i.Label,{htmlFor:"is_active",className:"text-sm text-muted-foreground cursor-pointer font-medium",children:"Plan Active"})]}),(0,t.jsx)(l.Button,{type:"button",variant:"ghost",size:"icon",onClick:m,className:"h-10 w-10 text-muted-foreground hover:text-foreground hover:bg-muted rounded-lg",children:(0,t.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,t.jsx)("path",{d:"M18 6 6 18"}),(0,t.jsx)("path",{d:"m6 6 12 12"})]})})]})]})}),(0,t.jsx)(s.AnimatePresence,{children:C&&(0,t.jsx)(a.motion.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"px-10 py-4 bg-red-500/10 border-b border-red-500/30 shrink-0",children:(0,t.jsxs)("div",{className:"flex items-center gap-3 text-red-400",children:[(0,t.jsx)(p.AlertTriangle,{className:"w-5 h-5 shrink-0"}),(0,t.jsx)("span",{className:"text-base",children:C})]})})}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto px-10 py-8 space-y-6",children:[(0,t.jsx)(F,{title:"Basic Information",icon:(0,t.jsx)(g.FileText,{className:"w-5 h-5"}),isOpen:P.basic,onToggle:()=>ex("basic"),status:ec?"complete":void 0,children:(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-8",children:[(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)(i.Label,{className:"text-base text-foreground font-medium",children:["Plan Name ",(0,t.jsx)("span",{className:"text-red-500 dark:text-red-400",children:"*"})]}),(0,t.jsx)(d.Input,{value:O,onChange:e=>M(e.target.value),placeholder:"e.g., Standard Introducer Fee Plan",className:"bg-muted/50 border-border text-foreground h-12 text-base focus:border-blue-500 focus:ring-1 focus:ring-blue-500/30"})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)(i.Label,{className:"text-base text-foreground font-medium",children:"Description"}),(0,t.jsx)(d.Input,{value:U,onChange:e=>R(e.target.value),placeholder:"Optional description of this fee arrangement...",className:"bg-muted/50 border-border text-foreground h-12 text-base focus:border-blue-500"})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-3 gap-8",children:[(0,t.jsx)("div",{className:"space-y-3",children:j?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.Label,{className:"text-base text-foreground font-medium",children:"Deal"}),(0,t.jsxs)("div",{className:"flex items-center gap-3 px-4 py-3 bg-muted/50 border border-border rounded-lg text-foreground h-12",children:[(0,t.jsx)(v.Building2,{className:"w-5 h-5 text-blue-500 dark:text-blue-400"}),(0,t.jsx)("span",{className:"text-base truncate",children:B.find(e=>e.id===j)?.name||"Loading..."})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(i.Label,{className:"text-base text-foreground font-medium",children:["Deal ",(0,t.jsx)("span",{className:"text-red-500 dark:text-red-400",children:"*"})]}),(0,t.jsxs)(c.Select,{value:q||"",onValueChange:e=>{z(e||void 0),K(void 0),Q(null),Y(void 0),ee(void 0)},children:[(0,t.jsx)(c.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-12 text-base",children:(0,t.jsx)(c.SelectValue,{placeholder:"Select a deal"})}),(0,t.jsx)(c.SelectContent,{className:"bg-popover border-border",children:B.map(e=>(0,t.jsx)(c.SelectItem,{value:e.id,className:"text-base py-2.5",children:e.name},e.id))})]})]})}),(0,t.jsx)("div",{className:"space-y-3",children:(0,t.jsx)(y,{dealId:q,value:W,onChange:(e,t)=>{K(e),Q(t)},required:!0})}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)(i.Label,{className:"text-base text-foreground font-medium",children:["Entity Type ",(0,t.jsx)("span",{className:"text-red-500 dark:text-red-400",children:"*"})]}),(0,t.jsxs)(c.Select,{value:X||"",onValueChange:e=>{Y(e||void 0),ee(void 0)},disabled:!q,children:[(0,t.jsx)(c.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-12 text-base",children:(0,t.jsx)(c.SelectValue,{placeholder:q?"Select type":"Select deal first"})}),(0,t.jsxs)(c.SelectContent,{className:"bg-popover border-border",children:[(0,t.jsx)(c.SelectItem,{value:"introducer",className:"text-base py-2.5",children:"Introducer"}),(0,t.jsx)(c.SelectItem,{value:"partner",className:"text-base py-2.5",children:"Partner"})]})]})]})]}),X&&q&&(0,t.jsx)("div",{className:"pt-4 border-t border-border",children:(0,t.jsx)(k,{dealId:q,entityType:X,onEntityTypeChange:Y,entityId:Z,onEntityIdChange:ee,required:!0,excludeTypes:["commercial_partner"]})})]})}),(0,t.jsx)(F,{title:"Fee Components",icon:(0,t.jsx)(f.DollarSign,{className:"w-5 h-5"}),isOpen:P.components,onToggle:()=>ex("components"),badge:`${et.length} component${1!==et.length?"s":""}`,status:et.length>0?eo?"complete":"error":void 0,children:(0,t.jsxs)("div",{className:"space-y-4",children:[E.length>0&&(0,t.jsx)("div",{className:"p-3 bg-red-500/10 border border-red-500/30 rounded-lg",children:(0,t.jsxs)("div",{className:"flex items-start gap-2",children:[(0,t.jsx)(p.AlertTriangle,{className:"w-4 h-4 text-red-400 mt-0.5"}),(0,t.jsxs)("div",{className:"text-sm text-red-400",children:[(0,t.jsx)("p",{className:"font-medium",children:"Fees exceed term sheet limits:"}),(0,t.jsx)("ul",{className:"mt-1 space-y-1",children:E.map((e,r)=>(0,t.jsxs)("li",{children:["• ",e]},r))})]})]})}),0===et.length?(0,t.jsxs)("div",{className:"text-center py-8 border-2 border-dashed border-border rounded-lg",children:[(0,t.jsx)(f.DollarSign,{className:"w-8 h-8 text-muted-foreground mx-auto mb-2"}),(0,t.jsx)("p",{className:"text-muted-foreground text-sm",children:"No fee components defined"}),(0,t.jsxs)(l.Button,{type:"button",onClick:eh,variant:"outline",size:"sm",className:"mt-3 border-border text-muted-foreground hover:bg-muted",children:[(0,t.jsx)(u.Plus,{className:"w-4 h-4 mr-2"}),"Add First Component"]})]}):(0,t.jsxs)("div",{className:"space-y-3",children:[et.map((e,r)=>(0,t.jsx)(A,{component:e,index:r,onChange:e=>{er(t=>{let a=[...t];return a[r]={...a[r],...e},a})},onRemove:()=>{er(e=>e.filter((e,t)=>t!==r))},termSheetLimits:ei},r)),(0,t.jsxs)(l.Button,{type:"button",onClick:eh,variant:"outline",size:"sm",className:"w-full border-border border-dashed text-muted-foreground hover:bg-muted hover:text-foreground",children:[(0,t.jsx)(u.Plus,{className:"w-4 h-4 mr-2"}),"Add Component"]})]})]})}),("introducer"===X||"partner"===X)&&(0,t.jsx)(F,{title:"Agreement Terms",icon:(0,t.jsx)(_.ScrollText,{className:"w-5 h-5"}),isOpen:P.agreement,onToggle:()=>ex("agreement"),badge:"introducer"===X?"DOC 3":"Placement",children:(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("h4",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-2 h-2 rounded-full bg-blue-500"}),"General Terms"]}),(0,t.jsxs)("div",{className:"grid grid-cols-3 gap-4 pl-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Agreement Duration"}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(d.Input,{type:"number",min:"1",value:ea.duration_months,onChange:e=>ep({duration_months:Number(e.target.value)||36}),className:"bg-muted/50 border-border text-foreground h-9 w-20"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"months"})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Non-Circumvention"}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(o.Checkbox,{checked:ea.non_circumvention_indefinite,onCheckedChange:e=>{ep({non_circumvention_indefinite:!!e,non_circumvention_months:e?null:24})},className:"border-border"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"Indefinite"}),!ea.non_circumvention_indefinite&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(d.Input,{type:"number",min:"1",value:ea.non_circumvention_months||"",onChange:e=>ep({non_circumvention_months:Number(e.target.value)||null}),className:"bg-muted/50 border-border text-foreground h-8 w-16"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"mo"})]})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Governing Law"}),(0,t.jsxs)(c.Select,{value:ea.governing_law,onValueChange:e=>ep({governing_law:e}),children:[(0,t.jsx)(c.SelectTrigger,{className:"bg-muted/50 border-border text-foreground h-9 text-xs",children:(0,t.jsx)(c.SelectValue,{})}),(0,t.jsx)(c.SelectContent,{className:"bg-popover border-border",children:T.map(e=>(0,t.jsx)(c.SelectItem,{value:e,className:"text-xs",children:e},e))})]})]})]})]}),ed&&(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("h4",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-2 h-2 rounded-full bg-green-500"}),"Introduction Fee Payment"]}),(0,t.jsx)("div",{className:"pl-4",children:(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Payment After Closing"}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(d.Input,{type:"number",min:"1",max:"90",value:ea.intro_payment_days,onChange:e=>ep({intro_payment_days:Number(e.target.value)||3}),className:"bg-muted/50 border-border text-foreground h-9 w-20"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"business days after share certificate"})]})]})})]}),el&&(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("h4",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-2 h-2 rounded-full bg-purple-500"}),"Performance Fee (Carried Interest)"]}),(0,t.jsxs)("div",{className:"pl-4 space-y-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Payment After Redemption"}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(d.Input,{type:"number",min:"1",max:"90",value:ea.perf_payment_days,onChange:e=>ep({perf_payment_days:Number(e.target.value)||10}),className:"bg-muted/50 border-border text-foreground h-9 w-20"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"days"})]})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"Hurdle Rate"}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(d.Input,{type:"number",min:"0",value:ea.hurdle_rate_bps||"",onChange:e=>ep({hurdle_rate_bps:e.target.value?Number(e.target.value):void 0}),placeholder:"800",className:"bg-muted/50 border-border text-foreground h-9 w-24"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"bps"})]}),ea.hurdle_rate_bps&&(0,t.jsxs)("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:["= ",(ea.hurdle_rate_bps/100).toFixed(2),"%"]})]})]}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-6",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(o.Checkbox,{checked:ea.has_catchup,onCheckedChange:e=>ep({has_catchup:!!e}),className:"border-border"}),(0,t.jsx)("span",{className:"text-sm text-muted-foreground",children:"GP Catchup"}),ea.has_catchup&&(0,t.jsxs)("div",{className:"flex items-center gap-1 ml-2",children:[(0,t.jsx)(d.Input,{type:"number",value:ea.catchup_rate_bps||"",onChange:e=>ep({catchup_rate_bps:e.target.value?Number(e.target.value):void 0}),className:"bg-muted/50 border-border text-foreground h-8 w-20"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"bps"})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(o.Checkbox,{checked:ea.has_high_water_mark,onCheckedChange:e=>ep({has_high_water_mark:!!e}),className:"border-border"}),(0,t.jsx)("span",{className:"text-sm text-muted-foreground",children:"High Water Mark"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(o.Checkbox,{checked:ea.has_no_cap,onCheckedChange:e=>{ep({has_no_cap:!!e,performance_cap_percent:e?void 0:20})},className:"border-border"}),(0,t.jsx)("span",{className:"text-sm text-muted-foreground",children:"No Cap"}),!ea.has_no_cap&&(0,t.jsxs)("div",{className:"flex items-center gap-1 ml-2",children:[(0,t.jsx)(d.Input,{type:"number",step:"0.1",min:"0",max:"100",value:ea.performance_cap_percent||"",onChange:e=>ep({performance_cap_percent:e.target.value?Number(e.target.value):void 0}),className:"bg-muted/50 border-border text-foreground h-8 w-16"}),(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"%"})]})]})]})]})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("h4",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-2 h-2 rounded-full bg-amber-500"}),"VAT Information"]}),(0,t.jsx)("div",{className:"pl-4",children:(0,t.jsxs)("div",{className:"space-y-2 max-w-xs",children:[(0,t.jsx)(i.Label,{className:"text-xs text-muted-foreground",children:"VAT Registration Number"}),(0,t.jsx)(d.Input,{value:ea.vat_number,onChange:e=>ep({vat_number:e.target.value}),placeholder:"e.g., GB123456789",className:"bg-muted/50 border-border text-foreground h-9"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Leave blank if not VAT registered"})]})})]})]})})]}),(0,t.jsxs)("div",{className:"px-10 py-6 border-t border-border bg-muted/60 flex items-center justify-between shrink-0",children:[(0,t.jsxs)("div",{className:"text-base text-muted-foreground",children:[(0,t.jsx)("span",{className:"font-semibold text-foreground text-lg",children:et.length})," fee component",1!==et.length?"s":""," defined",E.length>0&&(0,t.jsxs)("span",{className:"text-red-500 dark:text-red-400 ml-4 inline-flex items-center gap-2",children:[(0,t.jsx)(p.AlertTriangle,{className:"w-5 h-5"}),E.length," validation error",1!==E.length?"s":""]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-5",children:[(0,t.jsx)(l.Button,{type:"button",variant:"outline",onClick:m,disabled:w,className:"border-border text-foreground hover:bg-muted h-12 px-8 text-base font-medium",children:"Cancel"}),(0,t.jsx)(l.Button,{type:"button",onClick:eb,disabled:w||!ec||E.length>0,className:"bg-blue-600 hover:bg-blue-500 h-12 px-10 min-w-[180px] text-base font-semibold shadow-lg shadow-blue-500/20",children:w?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(h.Loader2,{className:"w-5 h-5 mr-2 animate-spin"}),"Saving..."]}):(0,t.jsx)(t.Fragment,{children:en?"Update Fee Plan":"Create Fee Plan"})})]})]})]})})}e.s(["default",()=>P],786560)}]);