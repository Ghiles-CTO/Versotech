(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,146141,e=>{"use strict";var s=e.i(722679),t=e.i(340915),a=e.i(603274),r=e.i(619324);let l=(0,e.i(410587).default)("arrow-down-wide-narrow",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"M11 4h10",key:"1w87gc"}],["path",{d:"M11 8h7",key:"djye34"}],["path",{d:"M11 12h4",key:"q8tih4"}]]);var i=e.i(84065),n=e.i(429747),o=e.i(645855),d=e.i(382021),c=e.i(263229),u=e.i(191026),h=e.i(771035),x=e.i(780),g=e.i(750809),m=e.i(837221),p=e.i(733179),j=e.i(704477),f=e.i(335994),v=e.i(129432),y=e.i(316264),N=e.i(538892),b=e.i(352776),w=e.i(877),C=e.i(994500);function S({requestId:e,currentPriority:a,onUpdate:r,variant:l="inline"}){let[i,n]=(0,t.useState)(a),[o,d]=(0,t.useState)(!1),[u,h]=(0,t.useState)(!1),[x,g]=(0,t.useState)(null),m=async e=>{if("dialog"===l){g(e),h(!0);return}await p(e)},p=async s=>{d(!0);try{if(!(await fetch(`/api/requests/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({priority:s})})).ok)throw Error("Failed to update priority");n(s),C.toast.success(`Priority updated to ${w.PRIORITY_CONFIG[s].label}`),r?.(),h(!1)}catch(e){console.error("Failed to update priority:",e),C.toast.error("Failed to update priority")}finally{d(!1)}};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(N.Select,{value:i,onValueChange:m,disabled:o,children:[(0,s.jsx)(N.SelectTrigger,{className:"w-auto gap-2 border-none bg-transparent hover:bg-white/10",children:o?(0,s.jsx)(c.Loader2,{className:"h-3 w-3 animate-spin"}):(0,s.jsx)(v.Badge,{variant:w.PRIORITY_CONFIG[i].badge,children:w.PRIORITY_CONFIG[i].label})}),(0,s.jsx)(N.SelectContent,{children:(0,s.jsxs)(N.SelectGroup,{children:[(0,s.jsx)(N.SelectLabel,{children:"Change Priority"}),["urgent","high","normal","low"].map(e=>(0,s.jsx)(N.SelectItem,{value:e,children:(0,s.jsx)("div",{className:"flex items-center gap-2",children:(0,s.jsx)(v.Badge,{variant:w.PRIORITY_CONFIG[e].badge,children:w.PRIORITY_CONFIG[e].label})})},e))]})})]}),"dialog"===l&&(0,s.jsx)(b.Dialog,{open:u,onOpenChange:h,children:(0,s.jsxs)(b.DialogContent,{children:[(0,s.jsxs)(b.DialogHeader,{children:[(0,s.jsx)(b.DialogTitle,{children:"Change Request Priority"}),(0,s.jsxs)(b.DialogDescription,{children:["Are you sure you want to change the priority from"," ",(0,s.jsx)(v.Badge,{variant:w.PRIORITY_CONFIG[i].badge,children:w.PRIORITY_CONFIG[i].label})," ","to"," ",x&&(0,s.jsx)(v.Badge,{variant:w.PRIORITY_CONFIG[x].badge,children:w.PRIORITY_CONFIG[x].label}),"?"]})]}),(0,s.jsxs)(b.DialogFooter,{children:[(0,s.jsx)(y.Button,{variant:"outline",onClick:()=>h(!1),disabled:o,children:"Cancel"}),(0,s.jsxs)(y.Button,{onClick:()=>{x&&p(x)},disabled:o,children:[o&&(0,s.jsx)(c.Loader2,{className:"h-4 w-4 animate-spin mr-2"}),"Confirm"]})]})]})})]})}var _=e.i(510166),T=e.i(230112),R=e.i(80465),q=e.i(432598),I=e.i(816654),k=e.i(514133);let A={open:["assigned","in_progress","cancelled"],assigned:["in_progress","open","cancelled"],in_progress:["ready","awaiting_info","cancelled"],awaiting_info:["in_progress"],ready:["closed","in_progress"],closed:[],cancelled:[]},O={open:o.Clock,assigned:h.Play,in_progress:h.Play,awaiting_info:u.MessageCircle,ready:R.CheckCircle,closed:R.CheckCircle,cancelled:q.X};function D({requestId:e,currentStatus:a,onUpdate:r}){let[l,i]=(0,t.useState)(!1),[n,o]=(0,t.useState)(!1),[d,u]=(0,t.useState)(null),[h,x]=(0,t.useState)(""),g=A[a]||[],m=async(s,t)=>{i(!0);try{let a={status:s};if(t&&(a.completion_note=t),!(await fetch(`/api/requests/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(a)})).ok)throw Error("Failed to update status");C.toast.success(`Status updated to ${w.REQUEST_STATUS_CONFIG[s].label}`),r?.(),o(!1),x("")}catch(e){console.error("Failed to update status:",e),C.toast.error("Failed to update status")}finally{i(!1)}};if("closed"===a||"cancelled"===a){let e=O[a];return(0,s.jsxs)(v.Badge,{variant:"outline",className:"gap-1",children:[(0,s.jsx)(e,{className:"h-3 w-3"}),w.REQUEST_STATUS_CONFIG[a].label]})}let p=O[a];return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(_.DropdownMenu,{children:[(0,s.jsx)(_.DropdownMenuTrigger,{asChild:!0,children:(0,s.jsxs)(y.Button,{variant:"outline",size:"sm",className:"gap-2",disabled:l||0===g.length,children:[l?(0,s.jsx)(c.Loader2,{className:"h-3 w-3 animate-spin"}):(0,s.jsx)(p,{className:"h-3 w-3"}),w.REQUEST_STATUS_CONFIG[a].label,g.length>0&&(0,s.jsx)(T.ChevronDown,{className:"h-3 w-3"})]})}),(0,s.jsxs)(_.DropdownMenuContent,{align:"end",children:[(0,s.jsx)(_.DropdownMenuLabel,{children:"Change Status"}),(0,s.jsx)(_.DropdownMenuSeparator,{}),g.map(e=>{let t=O[e];return(0,s.jsxs)(_.DropdownMenuItem,{onClick:()=>{"closed"===e?(u(e),o(!0)):m(e)},children:[(0,s.jsx)(t,{className:"h-4 w-4 mr-2"}),w.REQUEST_STATUS_CONFIG[e].label]},e)})]})]}),(0,s.jsx)(b.Dialog,{open:n,onOpenChange:o,children:(0,s.jsxs)(b.DialogContent,{children:[(0,s.jsxs)(b.DialogHeader,{children:[(0,s.jsx)(b.DialogTitle,{children:"Close Request"}),(0,s.jsx)(b.DialogDescription,{children:"Add a completion note before closing this request. This will be visible to the investor."})]}),(0,s.jsx)("div",{className:"space-y-4",children:(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(k.Label,{htmlFor:"completion-note",children:"Completion Note"}),(0,s.jsx)(I.Textarea,{id:"completion-note",placeholder:"Describe what was delivered or how the request was resolved...",value:h,onChange:e=>x(e.target.value),rows:4})]})}),(0,s.jsxs)(b.DialogFooter,{children:[(0,s.jsx)(y.Button,{variant:"outline",onClick:()=>o(!1),disabled:l,children:"Cancel"}),(0,s.jsxs)(y.Button,{onClick:()=>{d&&m(d,h)},disabled:l||!h.trim(),children:[l&&(0,s.jsx)(c.Loader2,{className:"h-4 w-4 animate-spin mr-2"}),"Close Request"]})]})]})})]})}var L=e.i(35334);function U({requestId:e,currentAssignee:a,onUpdate:r,trigger:l,currentUserId:i}){let[n,o]=(0,t.useState)(!1),[d,u]=(0,t.useState)([]),[h,x]=(0,t.useState)(""),[g,m]=(0,t.useState)(""),[p,f]=(0,t.useState)(!1),[v,w]=(0,t.useState)(!1);(0,t.useEffect)(()=>{n&&S()},[n]);let S=async()=>{f(!0);try{let e=await fetch("/api/profiles?role=staff_admin%2Cstaff_ops%2Cstaff_rm",{credentials:"include"});if(!e.ok)throw Error("Failed to load staff list");let s=await e.json();u(s.profiles||[])}catch(e){console.error("Failed to load staff list:",e),C.toast.error("Failed to load staff members")}finally{f(!1)}},_=async()=>{if(!h)return void C.toast.error("Please select a staff member");w(!0);try{if(!(await fetch(`/api/staff/requests/${e}/assign`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({assigned_to:h,note:g||void 0})})).ok)throw Error("Failed to assign request");let s=d.find(e=>e.id===h);C.toast.success(`Request assigned to ${s?.display_name||"staff member"}`),r?.(),o(!1),x(""),m("")}catch(e){console.error("Failed to assign request:",e),C.toast.error("Failed to assign request")}finally{w(!1)}},T=async()=>{if(!i)return void C.toast.error("User ID not available");w(!0);try{if(!(await fetch(`/api/staff/requests/${e}/assign`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({assigned_to:i})})).ok)throw Error("Failed to assign request");C.toast.success("Request assigned to you"),r?.()}catch(e){console.error("Failed to assign request:",e),C.toast.error("Failed to assign request")}finally{w(!1)}};return(0,s.jsxs)(b.Dialog,{open:n,onOpenChange:o,children:[(0,s.jsx)(b.DialogTrigger,{asChild:!0,children:l||(0,s.jsxs)(y.Button,{variant:"outline",size:"sm",className:"gap-2",children:[(0,s.jsx)(j.User,{className:"h-4 w-4"}),a?"Reassign":"Assign"]})}),(0,s.jsxs)(b.DialogContent,{children:[(0,s.jsxs)(b.DialogHeader,{children:[(0,s.jsx)(b.DialogTitle,{children:a?"Reassign Request":"Assign Request"}),(0,s.jsx)(b.DialogDescription,{children:a?(0,s.jsxs)(s.Fragment,{children:["Currently assigned to ",(0,s.jsx)("strong",{children:a.display_name}),". Select a new staff member to reassign."]}):"Select a staff member to assign this request to."})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[i&&a?.id!==i&&(0,s.jsxs)(y.Button,{variant:"secondary",className:"w-full gap-2",onClick:T,disabled:v,children:[v?(0,s.jsx)(c.Loader2,{className:"h-4 w-4 animate-spin"}):(0,s.jsx)(L.UserCheck,{className:"h-4 w-4"}),"Assign to Me"]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(k.Label,{htmlFor:"staff-select",children:"Staff Member"}),p?(0,s.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,s.jsx)(c.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):(0,s.jsxs)(N.Select,{value:h,onValueChange:x,children:[(0,s.jsx)(N.SelectTrigger,{id:"staff-select",children:(0,s.jsx)(N.SelectValue,{placeholder:"Select staff member..."})}),(0,s.jsx)(N.SelectContent,{children:(0,s.jsxs)(N.SelectGroup,{children:[(0,s.jsx)(N.SelectLabel,{children:"Staff Members"}),d.map(e=>(0,s.jsx)(N.SelectItem,{value:e.id,children:(0,s.jsxs)("div",{className:"flex flex-col",children:[(0,s.jsx)("span",{children:e.display_name}),(0,s.jsxs)("span",{className:"text-xs text-muted-foreground",children:[e.title||e.role," • ",e.email]})]})},e.id))]})})]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(k.Label,{htmlFor:"assignment-note",children:"Assignment Note (Optional)"}),(0,s.jsx)(I.Textarea,{id:"assignment-note",placeholder:"Add context or instructions for the assignee...",value:g,onChange:e=>m(e.target.value),rows:3})]})]}),(0,s.jsxs)(b.DialogFooter,{children:[(0,s.jsx)(y.Button,{variant:"outline",onClick:()=>o(!1),disabled:v,children:"Cancel"}),(0,s.jsxs)(y.Button,{onClick:_,disabled:v||!h,children:[v&&(0,s.jsx)(c.Loader2,{className:"h-4 w-4 animate-spin mr-2"}),a?"Reassign":"Assign"]})]})]})]})}var B=e.i(90613),E=e.i(191569),F=e.i(907434),P=e.i(661521),G=e.i(59178),M=e.i(282141);let $={search:"",status:"all",category:"all",priority:"all",assignedTo:"all",overdueOnly:!1,groupByCategory:!0},V=[{value:"all",label:"All statuses"},{value:"open",label:"Open"},{value:"assigned",label:"Assigned"},{value:"in_progress",label:"In Progress"},{value:"ready",label:"Ready"},{value:"closed",label:"Closed"}],z=[{value:"all",label:"All priorities"},{value:"urgent",label:"Urgent"},{value:"high",label:"High"},{value:"normal",label:"Normal"},{value:"low",label:"Low"}],H=[{value:"all",label:"All categories"},{value:"tax_doc",label:"Tax Documents"},{value:"analysis",label:"Performance Analysis"},{value:"data_export",label:"Data Exports"},{value:"presentation",label:"Presentations"},{value:"communication",label:"Communications"},{value:"cashflow",label:"Cashflow"},{value:"valuation",label:"Valuation"},{value:"other",label:"Other"}],Q={urgent:0,high:1,normal:2,low:3};function Y(){let e=(0,G.createClient)(),r=(0,a.useRouter)(),l=(0,a.useSearchParams)(),[i,n]=(0,t.useState)(null),[o,d]=(0,t.useState)(()=>l?{search:l.get("q")||"",status:l.get("status")||"all",category:l.get("category")||"all",priority:l.get("priority")||"all",assignedTo:l.get("assigned_to")||"all",overdueOnly:"true"===l.get("overdue"),groupByCategory:"true"===l.get("group_by_category")}:$),[c,u]=(0,t.useState)([]),[h,x]=(0,t.useState)(null),[g,m]=(0,t.useState)(!0),[p,j]=(0,t.useState)(null),[f,v]=(0,t.useState)(null),[y,N]=(0,t.useState)(null),[w,S]=(0,t.useState)(!1);async function _(){try{let{data:{user:s}}=await e.auth.getUser();s&&n(s.id)}catch(e){console.error("Failed to load current user:",e)}}async function T(e=!0){e&&m(!0),j(null);try{let e=new URLSearchParams;o.search&&e.set("q",o.search),"all"!==o.status&&e.set("status",o.status),"all"!==o.category&&e.set("category",o.category),"all"!==o.priority&&e.set("priority",o.priority),"all"!==o.assignedTo&&e.set("assigned_to",o.assignedTo),o.overdueOnly&&e.set("overdue_only","true"),o.groupByCategory&&e.set("group_by_category","true");let s=await fetch(`/api/staff/requests${e.size?`?${e.toString()}`:""}`,{credentials:"include"});if(!s.ok){let e="Failed to load requests";try{let t=await s.json(),a=[];"string"==typeof t?.error&&t.error.trim().length>0&&a.push(t.error.trim()),"string"==typeof t?.details&&t.details.trim().length>0&&a.push(t.details.trim()),"string"==typeof t?.hint&&t.hint.trim().length>0&&a.push(`Hint: ${t.hint.trim()}`),"string"==typeof t?.code&&t.code.trim().length>0&&a.push(`Code: ${t.code.trim()}`),a.length>0&&(e=a.join(" — "))}catch{}if(401===s.status){let e="Staff authentication required. Sign in with a staff account or set the demo_auth_user cookie for a staff role.";f!==e&&C.toast.info(e),v(e),j(null),u([]),x(null),m(!1);return}throw console.error("[StaffRequests] API returned error:",e,s.status,{filters:o,authError:f}),Error(`${e} (status ${s.status})`)}let t=await s.json();u(t.requests||[]),x(t.stats||null),v(null),t.hasData||C.toast.info("Connect Supabase data or run migrations to populate real requests.")}catch(s){console.error("[StaffRequests] Failed to load requests",s);let e=s instanceof Error?s.message:"Unexpected error occurred";e.toLowerCase().includes("staff authentication required")?(f!==e&&C.toast.info(e),v(e),j(null)):(j(e),e.toLowerCase().includes("failed to fetch requests")||C.toast.error(e))}finally{m(!1)}}(0,t.useEffect)(()=>{T(),_()},[o]),(0,t.useEffect)(()=>{let s=e.channel("staff_request_tickets_updates").on("postgres_changes",{event:"*",schema:"public",table:"request_tickets"},e=>{("INSERT"===e.eventType||"UPDATE"===e.eventType||"DELETE"===e.eventType)&&T(!1)}).subscribe();return()=>{e.removeChannel(s)}},[]),(0,t.useEffect)(()=>{let e=()=>{T(!1)};return window.addEventListener("staffRequests:refresh",e),()=>window.removeEventListener("staffRequests:refresh",e)},[]),(0,t.useEffect)(()=>{if(!l)return;let e=new URLSearchParams;o.search&&e.set("q",o.search),"all"!==o.status&&e.set("status",o.status),"all"!==o.category&&e.set("category",o.category),"all"!==o.priority&&e.set("priority",o.priority),"all"!==o.assignedTo&&e.set("assigned_to",o.assignedTo),o.overdueOnly&&e.set("overdue","true"),o.groupByCategory&&e.set("group_by_category","true");let s=e.toString();r.replace(s?`?${s}`:"?",{scroll:!1})},[o]);let R=(0,t.useMemo)(()=>[...c].sort((e,s)=>{let t=Q[e.priority]??99,a=Q[s.priority]??99;if(t!==a)return t-a;let r=e.created_at?new Date(e.created_at).getTime():0;return(s.created_at?new Date(s.created_at).getTime():0)-r}),[c]),q=h?.overdue_count??0;return(0,s.jsxs)("div",{className:"p-6 space-y-6 text-foreground",children:[f&&(0,s.jsxs)(B.Card,{className:"border border-amber-400/40 bg-amber-500/10",children:[(0,s.jsxs)(B.CardHeader,{children:[(0,s.jsx)(B.CardTitle,{className:"text-amber-100",children:"Staff Authentication Required"}),(0,s.jsx)(B.CardDescription,{className:"text-amber-100/80",children:f})]}),(0,s.jsxs)(B.CardContent,{className:"text-sm text-amber-50/90 space-y-2",children:[(0,s.jsxs)("p",{children:["Sign in with a staff account: ",(0,s.jsx)("strong",{children:"admin@versotech.com"})," / ",(0,s.jsx)("strong",{children:"admin123"})]}),(0,s.jsxs)("p",{className:"text-xs",children:["Or set the ",(0,s.jsx)("code",{children:"demo_auth_user"})," cookie (must use valid UUID for assigned_to filters):"]}),(0,s.jsx)("pre",{className:"rounded bg-amber-900/40 border border-amber-400/30 p-2 text-xs text-amber-50 overflow-x-auto",children:'{"id":"2a833fc7-b307-4485-a4c1-4e5c5a010e74","email":"admin@versotech.com","role":"staff_admin","displayName":"Admin Demo"}'})]})]}),(0,s.jsx)(J,{onRefresh:()=>T(),isRefreshing:g}),(0,s.jsx)(W,{stats:h,totalRequests:R.length,overdueCount:q}),!f&&(0,s.jsx)(K,{filters:o,onChange:e=>{d(s=>({...s,...e}))},onReset:()=>{d($)},isLoading:g}),(0,s.jsx)(X,{requests:R,isLoading:g,error:f?null:p,onRefresh:()=>T(),onSelectRequest:e=>{N(e),S(!0)},disabled:!!f,authError:f,groupByCategory:!!o.groupByCategory,currentUserId:i}),(0,s.jsx)(b.Dialog,{open:w,onOpenChange:S,children:(0,s.jsxs)(b.DialogContent,{className:"max-w-3xl",children:[(0,s.jsx)(b.DialogHeader,{children:(0,s.jsx)(b.DialogTitle,{children:"Request Details"})}),(0,s.jsx)(F.ScrollArea,{className:"h-[70vh] pr-4",children:y?(0,s.jsx)(ee,{request:y,onUpdate:()=>T(),currentUserId:i}):(0,s.jsx)("div",{className:"text-muted-foreground",children:"Select a request to view details"})})]})})]})}function J({onRefresh:e,isRefreshing:t}){let r=(0,a.useRouter)();return(0,s.jsxs)("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-3xl font-bold",children:"Request Management"}),(0,s.jsx)("p",{className:"text-muted-foreground mt-1",children:"Centralized triage for investor tax, performance, and servicing requests."})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)(y.Button,{variant:"outline",onClick:e,className:"gap-2",disabled:t,children:[t?(0,s.jsx)(c.Loader2,{className:"h-4 w-4 animate-spin"}):(0,s.jsx)(x.RotateCcw,{className:"h-4 w-4"}),"Refresh"]}),(0,s.jsxs)(y.Button,{className:"gap-2",onClick:()=>r.push("/versotech_main/requests/analytics"),children:[(0,s.jsx)(p.TrendingUp,{className:"h-4 w-4"}),"Analytics"]})]})]})}function W({stats:e,totalRequests:t,overdueCount:a}){let r=[{title:"Total Requests",value:e?.total_requests??t,description:"Active in queue"},{title:"Open",value:e?.open_count??0,description:"Awaiting assignment"},{title:"In Progress",value:e?.in_progress_count??0,description:"Assigned & being worked"},{title:"Ready",value:e?.ready_count??0,description:"Awaiting delivery"},{title:"Overdue",value:a,description:"Past SLA deadline",highlight:a>0}];return(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-3 xl:grid-cols-5 gap-4",children:r.map(e=>(0,s.jsxs)(B.Card,{className:(0,M.cn)("border border-white/10 bg-white/5 transition-shadow",e.highlight?"shadow-lg shadow-red-500/20":"hover:shadow-lg"),children:[(0,s.jsx)(B.CardHeader,{className:"pb-3",children:(0,s.jsx)(B.CardTitle,{className:"text-sm text-muted-foreground",children:e.title})}),(0,s.jsxs)(B.CardContent,{children:[(0,s.jsx)("div",{className:"text-2xl font-semibold",children:e.value}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:e.description})]})]},e.title))})}function K({filters:e,onChange:t,onReset:a,isLoading:i}){let c="all"!==e.status||"all"!==e.category||"all"!==e.priority||"all"!==e.assignedTo||e.overdueOnly||e.search.length>0;return(0,s.jsx)(B.Card,{className:"border border-white/10 bg-white/5",children:(0,s.jsxs)(B.CardContent,{className:"p-4 space-y-4",children:[(0,s.jsxs)("div",{className:"flex flex-col gap-4 xl:flex-row xl:items-center xl:justify-between",children:[(0,s.jsxs)("div",{className:"relative flex-1",children:[(0,s.jsx)(g.Search,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),(0,s.jsx)(E.Input,{placeholder:"Search by request ID, investor, title, or assignee",value:e.search,onChange:e=>t({search:e.target.value}),className:"pl-10"})]}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,s.jsxs)(y.Button,{variant:"outline",className:"gap-2",onClick:a,disabled:i||!c,children:[(0,s.jsx)(m.SlidersHorizontal,{className:"h-4 w-4"}),"Reset"]}),(0,s.jsxs)(y.Button,{variant:e.groupByCategory?"default":"outline",className:"gap-2",onClick:()=>t({groupByCategory:!e.groupByCategory}),children:[(0,s.jsx)(n.ClipboardList,{className:"h-4 w-4"}),e.groupByCategory?"Grouped":"Group"]})]})]}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,s.jsxs)(y.Button,{variant:"me"===e.assignedTo?"default":"outline",size:"sm",className:"gap-2",onClick:()=>t({assignedTo:"me"===e.assignedTo?"all":"me"}),children:[(0,s.jsx)(j.User,{className:"h-3 w-3"})," My Tasks"]}),(0,s.jsx)(y.Button,{variant:"open"===e.status?"default":"outline",size:"sm",onClick:()=>t({status:"open"===e.status?"all":"open"}),children:"Unassigned"}),(0,s.jsxs)(y.Button,{variant:e.overdueOnly?"default":"outline",size:"sm",className:"gap-2",onClick:()=>t({overdueOnly:!e.overdueOnly}),children:[(0,s.jsx)(r.AlertTriangle,{className:"h-3 w-3"})," Overdue"]}),(0,s.jsx)(y.Button,{variant:"urgent"===e.priority||"high"===e.priority?"default":"outline",size:"sm",onClick:()=>{"urgent"===e.priority||"high"===e.priority?t({priority:"all"}):t({priority:"urgent"})},children:"High Priority"}),(0,s.jsx)(y.Button,{variant:"in_progress"===e.status?"default":"outline",size:"sm",onClick:()=>t({status:"in_progress"===e.status?"all":"in_progress"}),children:"In Progress"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-5",children:[(0,s.jsxs)(N.Select,{value:e.status,onValueChange:e=>t({status:e}),children:[(0,s.jsxs)(N.SelectTrigger,{className:"gap-2",children:[(0,s.jsx)(d.Filter,{className:"h-4 w-4"}),(0,s.jsx)(N.SelectValue,{placeholder:"Status"})]}),(0,s.jsx)(N.SelectContent,{children:(0,s.jsxs)(N.SelectGroup,{children:[(0,s.jsx)(N.SelectLabel,{children:"Status"}),V.map(e=>(0,s.jsx)(N.SelectItem,{value:e.value,children:e.label},e.value))]})})]}),(0,s.jsxs)(N.Select,{value:e.priority,onValueChange:e=>t({priority:e}),children:[(0,s.jsxs)(N.SelectTrigger,{className:"gap-2",children:[(0,s.jsx)(l,{className:"h-4 w-4"}),(0,s.jsx)(N.SelectValue,{placeholder:"Priority"})]}),(0,s.jsx)(N.SelectContent,{children:(0,s.jsxs)(N.SelectGroup,{children:[(0,s.jsx)(N.SelectLabel,{children:"Priority"}),z.map(e=>(0,s.jsx)(N.SelectItem,{value:e.value,children:e.label},e.value))]})})]}),(0,s.jsxs)(N.Select,{value:e.category,onValueChange:e=>t({category:e}),children:[(0,s.jsxs)(N.SelectTrigger,{className:"gap-2",children:[(0,s.jsx)(n.ClipboardList,{className:"h-4 w-4"}),(0,s.jsx)(N.SelectValue,{placeholder:"Category"})]}),(0,s.jsx)(N.SelectContent,{children:(0,s.jsxs)(N.SelectGroup,{children:[(0,s.jsx)(N.SelectLabel,{children:"Category"}),H.map(e=>(0,s.jsx)(N.SelectItem,{value:e.value,children:e.label},e.value))]})})]}),(0,s.jsxs)(N.Select,{value:e.assignedTo,onValueChange:e=>t({assignedTo:e}),children:[(0,s.jsxs)(N.SelectTrigger,{className:"gap-2",children:[(0,s.jsx)(j.User,{className:"h-4 w-4"}),(0,s.jsx)(N.SelectValue,{placeholder:"Assignee"})]}),(0,s.jsx)(N.SelectContent,{children:(0,s.jsxs)(N.SelectGroup,{children:[(0,s.jsx)(N.SelectLabel,{children:"Assignee"}),(0,s.jsx)(N.SelectItem,{value:"all",children:"All staff"}),(0,s.jsx)(N.SelectItem,{value:"me",children:"Assigned to me"})]})})]}),(0,s.jsxs)(N.Select,{value:e.overdueOnly?"overdue":"any",onValueChange:e=>t({overdueOnly:"overdue"===e}),children:[(0,s.jsxs)(N.SelectTrigger,{className:"gap-2",children:[(0,s.jsx)(o.Clock,{className:"h-4 w-4"}),(0,s.jsx)(N.SelectValue,{placeholder:"SLA"})]}),(0,s.jsx)(N.SelectContent,{children:(0,s.jsxs)(N.SelectGroup,{children:[(0,s.jsx)(N.SelectLabel,{children:"SLA"}),(0,s.jsx)(N.SelectItem,{value:"any",children:"All requests"}),(0,s.jsx)(N.SelectItem,{value:"overdue",children:"SLA breaches only"})]})})]})]})]})})}function X({requests:e,isLoading:t,error:a,onRefresh:l,onSelectRequest:i,disabled:o=!1,authError:d,groupByCategory:u=!1,currentUserId:h}){if(t)return(0,s.jsx)(B.Card,{className:"border border-white/10 bg-white/5",children:(0,s.jsxs)(B.CardContent,{className:"p-12 flex flex-col items-center gap-3 text-muted-foreground",children:[(0,s.jsx)(c.Loader2,{className:"h-8 w-8 animate-spin"}),(0,s.jsx)("p",{children:"Loading request queue…"})]})});if(a)return(0,s.jsx)(B.Card,{className:"border border-red-400/30 bg-red-500/10",children:(0,s.jsxs)(B.CardContent,{className:"p-6 space-y-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 text-sm text-red-200",children:[(0,s.jsx)(r.AlertTriangle,{className:"h-4 w-4"}),a]}),(0,s.jsxs)(y.Button,{variant:"outline",onClick:l,className:"gap-2 border-white/20",children:[(0,s.jsx)(x.RotateCcw,{className:"h-4 w-4"}),"Retry"]})]})});if(d)return(0,s.jsx)(B.Card,{className:"border border-dashed border-amber-400/40 bg-amber-500/10",children:(0,s.jsxs)(B.CardContent,{className:"p-10 text-center space-y-3 text-amber-100",children:[(0,s.jsx)(n.ClipboardList,{className:"h-12 w-12 text-amber-300/80 mx-auto"}),(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsx)("p",{className:"text-lg font-semibold",children:"Authentication Required"}),(0,s.jsx)("p",{className:"text-sm text-amber-100/80",children:d})]})]})});if(!e.length)return(0,s.jsx)(B.Card,{className:"border border-dashed border-white/20 bg-white/5",children:(0,s.jsxs)(B.CardContent,{className:"p-12 text-center space-y-3",children:[(0,s.jsx)(n.ClipboardList,{className:"h-12 w-12 text-muted-foreground/80 mx-auto"}),(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsx)("p",{className:"text-lg font-semibold",children:"No active requests"}),(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"When investors submit requests from the Reports page or inbox automations, they will appear here for triage."})]}),(0,s.jsxs)(y.Button,{variant:"outline",onClick:l,className:"gap-2 border-white/20",children:[(0,s.jsx)(x.RotateCcw,{className:"h-4 w-4"}),"Check again"]})]})});if(u){let t=new Map;for(let s of e){let e=s.category||"other",a=t.get(e)||[];a.push(s),t.set(e,a)}return(0,s.jsx)("div",{className:(0,M.cn)("space-y-6",o&&"opacity-50 pointer-events-none select-none"),children:Array.from(t.entries()).map(([e,t])=>(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(v.Badge,{variant:"outline",className:"border-white/20",children:w.REQUEST_CATEGORIES[e]?.label||e}),(0,s.jsxs)("span",{className:"text-xs text-muted-foreground",children:[t.length," items"]})]}),(0,s.jsx)("div",{className:"space-y-3",children:t.map(e=>(0,s.jsx)(Z,{request:e,onSelect:()=>i(e),onUpdate:l,currentUserId:h},e.id))})]},e))})}return(0,s.jsx)("div",{className:(0,M.cn)("space-y-4",o&&"opacity-50 pointer-events-none select-none"),children:e.map(e=>(0,s.jsx)(Z,{request:e,onSelect:()=>i(e),onUpdate:l,currentUserId:h},e.id))})}function Z({request:e,onSelect:t,onUpdate:a,currentUserId:l}){w.REQUEST_STATUS_CONFIG[e.status];let n=!!(e.due_date&&(0,w.isOverdue)(e.due_date));return(0,s.jsx)(B.Card,{className:(0,M.cn)("border border-white/10 bg-white/5 hover:border-white/30 transition-colors",n&&"border-red-400/50 bg-red-500/5"),children:(0,s.jsx)(B.CardContent,{className:"p-6",children:(0,s.jsxs)("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between",children:[(0,s.jsxs)("div",{className:"space-y-3 flex-1",children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2 text-sm",children:[(0,s.jsx)(v.Badge,{variant:"outline",className:"border-white/20 text-xs uppercase tracking-wide",children:e.id.split("-")[0]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(D,{requestId:e.id,currentStatus:e.status,onUpdate:a}),(0,s.jsx)(S,{requestId:e.id,currentPriority:e.priority,onUpdate:a,variant:"inline"}),(0,s.jsx)(v.Badge,{variant:"outline",className:"border-white/20",children:w.REQUEST_CATEGORIES[e.category]?.label||e.category}),n&&(0,s.jsxs)(v.Badge,{variant:"destructive",className:"gap-1",children:[(0,s.jsx)(r.AlertTriangle,{className:"h-3 w-3"}),"Overdue"]})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold",children:e.subject}),e.details&&(0,s.jsx)("p",{className:"text-sm text-muted-foreground line-clamp-2 max-w-2xl",children:e.details})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-3 text-sm md:grid-cols-2 xl:grid-cols-4",children:[(0,s.jsx)(es,{label:"Investor",value:e.investor?.legal_name||"N/A"}),(0,s.jsx)(es,{label:"Created",value:new Date(e.created_at).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}),(0,s.jsx)(es,{label:"Due",value:e.due_date?new Date(e.due_date).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Not set",emphasis:n}),(0,s.jsx)(es,{label:"Assigned",value:e.assigned_to_profile?.display_name||"Unassigned"})]}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-3 text-xs text-muted-foreground",children:[e.due_date&&(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)(i.Calendar,{className:"h-3 w-3"}),(0,w.formatTimeRemaining)(e.due_date)]}),e.linked_workflow_run&&(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)(h.Play,{className:"h-3 w-3"})," Workflow ",ea(e.linked_workflow_run)]})]})]}),(0,s.jsxs)("div",{className:"flex flex-col gap-2 lg:min-w-[160px]",children:[(0,s.jsxs)(y.Button,{variant:"outline",size:"sm",className:"gap-2",onClick:t,children:[(0,s.jsx)(er,{}),"View Details"]}),(0,s.jsx)(U,{requestId:e.id,currentAssignee:e.assigned_to_profile,currentUserId:l||void 0,onUpdate:a,trigger:(0,s.jsxs)(y.Button,{variant:"ghost",size:"sm",className:"gap-2 w-full justify-start",children:[(0,s.jsx)(f.UserPlus,{className:"h-4 w-4"}),e.assigned_to?"Reassign":"Assign"]})}),(0,s.jsxs)(y.Button,{variant:"ghost",size:"sm",className:"gap-2",onClick:t,children:[(0,s.jsx)(u.MessageCircle,{className:"h-4 w-4"}),"Conversation"]})]})]})})})}function ee({request:e,onUpdate:a,currentUserId:l}){let[i,n]=(0,t.useState)(!1),o=!!(e.due_date&&"closed"!==e.status&&"ready"!==e.status&&(0,w.isOverdue)(e.due_date));w.REQUEST_STATUS_CONFIG[e.status];let d=async()=>{n(!0);try{let s=await fetch("/api/conversations",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({subject:`Request ${e.id}: ${e.subject}`,participant_ids:[e.created_by],type:"dm",initial_message:`Context: request ${e.id} (${e.category||"general"}) - ${e.subject}`})});if(s.ok){let e=await s.json(),t=e?.conversation?.id;t&&(C.toast.success("Conversation created"),window.location.href=`/versotech_main/messages/${t}`)}else throw Error("Failed to create conversation")}catch(e){console.error("Failed to create conversation:",e),C.toast.error("Failed to create conversation")}finally{n(!1)}};return(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,s.jsx)(v.Badge,{variant:"outline",className:"border-white/20 text-xs",children:e.id}),(0,s.jsx)(D,{requestId:e.id,currentStatus:e.status,onUpdate:a}),(0,s.jsx)(S,{requestId:e.id,currentPriority:e.priority,onUpdate:a,variant:"inline"}),(0,s.jsx)(v.Badge,{variant:"outline",className:"border-white/20",children:w.REQUEST_CATEGORIES[e.category]?.label||e.category}),o&&(0,s.jsxs)(v.Badge,{variant:"destructive",className:"gap-1",children:[(0,s.jsx)(r.AlertTriangle,{className:"h-3 w-3"})," SLA breach"]})]}),(0,s.jsx)("h2",{className:"text-2xl font-semibold",children:e.subject}),e.details&&(0,s.jsx)("p",{className:"text-sm text-muted-foreground whitespace-pre-line",children:e.details})]}),(0,s.jsx)(P.Separator,{className:"border-white/10"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[(0,s.jsxs)(et,{title:"Investor",children:[(0,s.jsx)("p",{className:"text-sm font-medium",children:e.investor?.legal_name||"N/A"}),(0,s.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Created by: ",e.created_by_profile?.display_name]})]}),(0,s.jsxs)(et,{title:"Assignment",children:[(0,s.jsx)("p",{className:"text-sm font-medium",children:e.assigned_to_profile?.display_name||"Unassigned"}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:e.assigned_to?"Assigned staff member responsible for delivery.":"Assign to an available analyst or RM."})]}),e.due_date&&(0,s.jsxs)(et,{title:"SLA & Due Date",children:[(0,s.jsx)("p",{className:"text-sm font-medium",children:new Date(e.due_date).toLocaleString(void 0,{month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:(0,w.formatTimeRemaining)(e.due_date)})]}),(0,s.jsxs)(et,{title:"Linked Workflow & Deliverables",children:[e.linked_workflow_run?(0,s.jsxs)("p",{className:"text-sm font-medium",children:["Workflow run: ",ea(e.linked_workflow_run)]}):(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"No workflow run linked."}),e.result_doc_id?(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:"Deliverable ready for review."}):(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:"Attach deliverables before closing the request."})]})]}),(0,s.jsx)(P.Separator,{className:"border-white/10"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-medium mb-2",children:"Status History & Notes"}),(0,s.jsxs)("ul",{className:"space-y-2 text-sm text-muted-foreground",children:[(0,s.jsxs)("li",{children:["Created at ",new Date(e.created_at).toLocaleString()," by ",e.created_by_profile?.display_name]}),e.updated_at&&(0,s.jsxs)("li",{children:["Last updated at ",new Date(e.updated_at).toLocaleString()]}),e.closed_at&&(0,s.jsxs)("li",{children:["Closed at ",new Date(e.closed_at).toLocaleString()]}),e.completion_note&&(0,s.jsxs)("li",{className:"bg-white/5 border border-white/10 rounded-md p-3 text-foreground",children:[(0,s.jsx)("p",{className:"text-sm font-medium mb-1",children:"Completion Note"}),(0,s.jsx)("p",{className:"text-sm text-muted-foreground whitespace-pre-line",children:e.completion_note})]})]})]}),(0,s.jsx)(P.Separator,{className:"border-white/10"}),(0,s.jsx)("div",{className:"space-y-4",children:(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[(0,s.jsx)(U,{requestId:e.id,currentAssignee:e.assigned_to_profile,currentUserId:l||void 0,onUpdate:a,trigger:(0,s.jsxs)(y.Button,{variant:"secondary",className:"justify-start gap-2 w-full",children:[(0,s.jsx)(f.UserPlus,{className:"h-4 w-4"}),e.assigned_to?"Reassign Request":"Assign Request"]})}),(0,s.jsxs)(y.Button,{variant:"outline",className:"justify-start gap-2",onClick:d,disabled:i,children:[i?(0,s.jsx)(c.Loader2,{className:"h-4 w-4 animate-spin"}):(0,s.jsx)(u.MessageCircle,{className:"h-4 w-4"}),"Create Conversation"]})]})})]})}function es({label:e,value:t,emphasis:a}){return(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-xs text-muted-foreground uppercase tracking-wide",children:e}),(0,s.jsx)("div",{className:(0,M.cn)("text-sm font-medium",a&&"text-red-300"),children:t})]})}function et({title:e,children:t}){return(0,s.jsxs)("div",{className:"rounded-lg border border-white/10 bg-white/5 p-4 space-y-2",children:[(0,s.jsx)("h4",{className:"text-sm font-medium text-muted-foreground uppercase tracking-wide",children:e}),t]})}function ea(e){return e?`${e.slice(0,6)}…${e.slice(-4)}`:""}function er(){return(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"h-4 w-4",children:[(0,s.jsx)("path",{d:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7"}),(0,s.jsx)("circle",{cx:"12",cy:"12",r:"3"})]})}e.s(["RequestManagementPage",()=>Y],146141)}]);