# VERSO Portal – Project Status (October 13, 2025) ## 1. Executive Summary - Twin portals (versoholdings investor app, versotech staff app) share a single Next.js 15 codebase with a Supabase/Postgres backend. - Core feature pillars ship end-to-end: portfolio intelligence, deal lifecycle, document automation, messaging, workflow automation, fee & reconciliation engines. - Documentation is comprehensive (PRDs per module, implementation guides, ERDs, deployment notes); most functionality in code aligns with docs. - Supabase schema implements full v2.0 requirements (deal-scoped access, inventory with anti-oversell, per-investor terms, fee/invoice pipeline, introducer tracking, audit logging). - Remaining risk is coordination/cleanup: demo/debug endpoints, duplicated routes noted in APP_STRUCTURE_ANALYSIS.md, and ensuring RLS is consistently enforced where code uses service-role clients. ## 2. Codebase & Assets Overview | Area | Highlights | | --- | --- | | Root | README.md, historical investor fixes, SQL helpers under database/, extensive docs under docs/. | | Application | versotech-portal/ houses the Next.js app, src/app route groups for investor/staff/public, >130 shared components, lib utilities, Supabase clients, hooks. | | Database | Migrations in versotech-portal/database/migrations/ (Supabase CLI layout) plus reference SQL in root database/. | | Documentation | PRDs per investor/staff module, ERDs, implementation plans, deployment guides, valuation fix instructions, route inventory. | | Tests | Jest setup (src/__tests__), focused on dashboard/components; coverage still light. | ## 3. Investor Portal (/versoholdings) Breakdown ### Investor Dashboard (/versoholdings/dashboard) **Narrative & Layout** - Branded hero banner with portfolio context (badges for domicile, vehicle family, compliance posture) and an “as of” card showing valuation date. - KPI strip (Current NAV, Total Contributed, Total Distributions, Unfunded Commitment, Unrealized Gain $, Unrealized Gain %, DPI, TVPI, IRR). Each tile opens a modal with formulas, recent change, benchmarking, and recommended actions. - Body zones: performance trend chart, vehicle highlight cards, “VERSO Services” action rail (position statement, custom report, deal room), recent-activity timeline. Empty state swaps KPIs for onboarding flow if investor lacks data. **Technical Execution** - Server component (page.tsx) authenticates via createClient, resolves investor IDs from investor_users, then queries: - positions (fields: units, cost_basis, last_nav, as_of_date). - subscriptions filtered to status = 'active' (fields: commitment, currency). - cashflows (fields: type, amount, date). - performance_snapshots (fields: nav_value, contributed, distributed, dpi, tvpi, irr_net, ordered by snapshot_date). - activity_feed limited to recent entries (fields: activity_type, title, description, deal_id, vehicle_id, created_at). - Derived metrics calculated server-side: NAV, unfunded commitment (commitment - contributed), unrealized gain (NAV - cost_basis), ratio safeguards (handle zero denominators). - Client component RealtimeDashboard subscribes to Supabase realtime channels: - activity_feed with filter investor_id in (...). - performance_snapshots with filter investor_id in (...). - Deal context filter triggers additional fetches against /api/deals/:id and re-queries positions, cashflows, performance_snapshots scoped to vehicle_id. - No service-role client used; all queries respect the anon key and RLS policies. **Permissions & Edge Cases** - RLS on positions, cashflows, activity_feed, documents enforced via investor membership; staff masquerade depends on profiles.role like 'staff_%' policies. - Empty state triggered when positions, cashflows, performance_snapshots all return zero rows, shifting UI to onboarding CTA. - Realtime connection indicator warns on websocket disconnect; user can manually refresh. ### Active Deals (/versoholdings/deals) **Narrative & Layout** - Summary strip: Available deals, currently open deals, active reservations, pending commitments. - Deal cards show company logo (or initials), name, sector/stage/location tags, membership role badge, status chip (open, allocation_pending, closed), fee-plan summary, pricing (unit price, min/max investment), target/raised amounts with progress bar, timeline (open_at, close_at). - Action rail adapts per investor state: Accept Invitation, Submit Commitment, Reserve Units, View Details, Documents, Request Report. Closed deals collapse to informational cards. - Footer CTA encourages reading the deal guide or contacting the VERSO team. **Technical Execution** - Authentication via createClient. Investor IDs mapped via investor_users. - Reads performed with createServiceClient but filtered to the current user: - deals (select id, name, deal_type, status, currency, offer_unit_price, target_amount, raised_amount, open_at, close_at, description, investment_thesis, minimum_investment, maximum_investment, vehicle_id, company_logo_url, sector, stage, location). - deal_memberships!inner (fields: role, accepted_at, invited_at, deal_id, user_id). - vehicles join for metadata. - fee_plans (fields: id, name, description, is_default). - deal_commitments filtered by investor IDs (fields: requested_units, requested_amount, status, created_at). - reservations filtered by investor IDs (fields: requested_units, proposed_unit_price, status, expires_at, created_at). - Summary tiles computed from these datasets. - Actions trigger APIs: - /api/deals/:id/commitments (POST) — validates membership, inserts into deal_commitments, queues staff approval. - /api/deals/:id/reservations (POST) — calls fn_reserve_inventory to hold units, writes reservations and reservation_lot_items. - /api/reservations/:id/finalize (POST) — eventually run by staff or automation to invoke fn_finalize_allocation. - /api/deals/:id/invite-links (POST) — staff only. - Client modals (CommitmentModal, ReservationModal, DealDetailsModal) orchestrate forms and API calls with optimistic UI updates. **Permissions & Edge Cases** - RLS on deal_memberships, deal_commitments, reservations enforces investor-specific access; even with service-role reads, filtering keeps the response scoped. - Deals auto-marked closed when close_at < now, preventing new reservations. - Reservations show TTL countdown; once expired a cron job (fn_expire_reservations via n8n) restores lot balances. ### Holdings (/versoholdings/holdings) **Narrative & Layout** - KPI dashboard (Current NAV, Total Contributed, Total Distributions, Unfunded Commitment, Total Commitment, Total Cost Basis, Unrealized Gain $, Unrealized Gain %, DPI, TVPI, IRR). - Trend widget with period summary (“NAV up $230k in the last 30 days”). - Summary card (total positions, total vehicles, total deals, pending allocations, last updated timestamp). - Vehicle grid (name, type, units, value, cost basis, commitment vs. unfunded, performance delta) and optional Deal grid (allocations, reservations, spread calculations). - Card modals show deeper analytics (cashflow history, valuation timeline, fee impact) and link to documents/reports. **Technical Execution** - Server component uses Supabase RPCs: - calculate_investor_kpis_with_deals(investor_ids uuid[]) to aggregate portfolio metrics plus deal stats. - get_portfolio_trends(investor_ids uuid[], days_back int) for NAV delta. - get_investor_vehicle_breakdown(investor_ids uuid[]) for per-vehicle metrics. - Fallback to calculate_investor_kpis if enhanced RPC fails. - RPCs reference tables: positions, cashflows, subscriptions, deal_memberships, allocations, performance_snapshots, reservations. - Client EnhancedHoldingsPage sets up realtime listeners on positions, reservations, allocations, deal_memberships (filtered by investor IDs). Updates patch the relevant slices. - Filtering logic purely client-side; optional API calls for modal detail include /api/portfolio/kpi-details and /api/vehicles/:id. **Permissions & Edge Cases** - RLS on positions, subscriptions, cashflows, performance_snapshots restricts rows to authorized investors; staff dashboards use service-role in server context. - When no holdings exist, page shows onboarding prompts (link to Active Deals, contact relationship manager). - Pending allocations surfaced from allocations with status = 'pending_review' to remind investors of forthcoming updates. ### Documents (/versoholdings/documents) **Narrative & Layout** - Folder tree on the left (vehicle roots, categories such as Agreements, Reports, KYC, plus custom folders). Main pane lists documents with name, type, upload time, version badge, watermark indicator, quick actions. - Filters across the top for vehicle, deal, document type. Call-to-action to “Request report” links to Reports page. - Empty-folder states offer guidance (“Request missing docs from your relationship manager”). **Technical Execution** - Server queries: - document_folders (fields: id, name, parent_folder_id, vehicle_id, folder_type). - documents (fields: id, name, type, status, owner_investor_id, vehicle_id, deal_id, file_key, watermark, is_published, created_at, updated_at, current_version, file_size_bytes). - document_versions (fields: id, document_id, version_number, file_key, created_at, created_by). - Client component CategorizedDocumentsClient organizes folders, applies filters, and renders lists/cards. - Downloads call /api/documents/:id/download (POST). Handler logic: - Validate entitlement: investor ownership (owner_investor_id), subscription to vehicle (subscriptions + investor_users), or membership in deal_memberships. - Insert audit row into audit_log (fields: actor_user_id, action = 'document_download', entity = 'document', entity_id, ts). - Generate signed URL from Supabase storage with TTL (e.g., 60 seconds) and optional watermark tokens in response payload. - Version history triggered via modal hitting /api/documents/:id/versions (if implemented) to show past iterations. **Permissions & Edge Cases** - documents RLS: investors can select if they own the document, subscribe to the linked vehicle, or belong to the linked deal; staff roles bypass via role like 'staff_%' policy. - Watermarked downloads include investor details from profiles to discourage sharing. - Draft or pending-approval documents hidden from investors by checking status and is_published. ### Tasks (/versoholdings/tasks) **Narrative & Layout** - Progress summary at top (“6 of 9 onboarding tasks complete”). - Task list grouped by category (Onboarding, Compliance, Investment Setup). Each tile shows title, due date, status, priority, and expands to show instructions and action buttons. - Instruction panels can embed checklists, upload controls, or deep links to doc signing/workflows. - Completed view swaps list for celebratory state with suggested next steps. **Technical Execution** - Server queries: - tasks filtered by owner_user_id = current user or owner_investor_id in investor IDs. Fields: id, kind, category, title, description, due_at, status, priority, instructions (jsonb), related_entity_type, related_entity_id, created_at, updated_at. - task_templates for metadata (fields: kind, category, title, description, estimated_minutes, default_due_days, prerequisite_task_kinds). - task_actions (fields: task_id, action_type, action_config). - task_dependencies (fields: task_id, depends_on_task_id). - Client organizes tasks into sections, handles expand/collapse, triggers actions. - Completion flows call /api/tasks (PATCH) or /api/tasks/:id/complete (if implemented) to update status, completed_at, completed_by. Actions may trigger n8n workflows via /api/workflows/[key]/trigger using action_config data. - File upload tasks use document APIs, linking uploaded document_id back to the task’s related_entity_id. **Permissions & Edge Cases** - RLS on tasks ensures the investor only sees rows linked to them; staff roles have policies granting broader access for management. - Dependencies enforce ordering—UI should show locked tasks until prerequisites complete. - Overdue tasks highlight using due_at comparison; non-critical tasks can be snoozed if allowed by instructions JSON. ### Messages (/versoholdings/messages) **Narrative & Layout** - Sidebar with conversation list grouped by type (direct, deal room, system). Unread counters and last message preview. - Chat pane with message bubbles, timestamps, optional reactions, attachment chips. Deal rooms show deal metadata in header. - Composer supports text, attachment upload, quick actions (share document, link request). - Presence indicator shows which staff are online. **Technical Execution** - Route guarded by requireAuth(['investor']) to ensure investor role. - Server queries: - conversation_participants (fields: conversation_id, user_id, participant_role, joined_at, last_read_at, is_muted, is_pinned). Limited to 250. - conversations (fields: id, subject, type, deal_id, visibility, last_message_at, metadata). - messages limited to latest 50 per conversation (fields: id, conversation_id, sender_id, body, message_type, file_key, reply_to_message_id, metadata, created_at, edited_at, deleted_at). - Normalization step merges nested profiles for participants and senders. - Client InvestorMessagingClient subscribes to realtime channels for each conversation (filtered by conversation_id). Message insert/update/delete streamed live; read receipts update via /api/conversations/:id/read. - File uploads go to /api/documents/upload (multipart). Handler stores file in Supabase storage, adds row to documents if needed, and returns a file_key used in the message payload via /api/conversations/:id/messages (POST). - Download flows call /api/messaging/files/:id/download or reuse /api/documents/:id/download depending on storage strategy. **Permissions & Edge Cases** - RLS: conversations requires matching conversation_participants record or staff role; messages require membership; message_reads ensures reads only for participants. - Deal rooms rely on deal_memberships to populate participants automatically. - Broadcasters (staff) have separate endpoints /api/conversations/broadcast to seed investor threads; these are hidden in investor view. - If no conversations exist, page showcases CTA to start a chat or navigate to Requests. ### Reports (/versoholdings/reports) **Narrative & Layout** - “Request a report” wizard (choose report type, vehicle or portfolio-wide, date range). Submission logs a timeline entry. - Report history table showing status badges (“Queued,” “Processing,” “Ready,” “Failed”), timestamps, workflow info, download buttons. - Links to associated documents and ability to re-request with modified parameters. **Technical Execution** - Server fetches report_requests (fields: id, investor_id, vehicle_id, filters, status, result_doc_id, created_by, created_at, updated_at). Joins documents when result_doc_id present to show file info. - Wizard submission posts to /api/report-requests: - Validates investor owns vehicle/deal (using investor_users, subscriptions, deal_memberships). - Inserts row with status = 'queued', filters JSON (e.g., { "report_type": "position_statement", "vehicle_id": "...", "from": "2024-01-01", "to": "2024-12-31" }). - Calls n8n webhook with payload referencing report_request_id, investor_id, selected filters, idempotency token. - Workflow pipeline: - n8n fetches data via Supabase (SQL functions or RPCs), renders PDF. - Uploads PDF to Supabase storage, writes documents row (linking to investor, optional vehicle/deal). - Updates report_requests (status = 'ready', result_doc_id = ...). - Inserts row into workflow_runs (fields: workflow_id, workflow_key, status, triggered_by, entity_id, output_data). - Emits activity_feed entry. - Downloads reuse /api/documents/:id/download with watermarking. **Permissions & Edge Cases** - RLS on report_requests ensures only creator/investor sees their requests. Staff interface uses /versotech/staff/requests for triage. - Duplicate prevention: optional logic to detect existing queued requests matching same parameters. - Failed status surfaces error tooltip and invites investor to contact support. Staff can retry via n8n or manual workflows. ## 4. Staff Portal (/versotech/staff) Breakdown The staff portal arms operations, compliance, and relationship teams with full-fidelity controls. All routes sit behind requireStaffAuth and most pages use createServiceClient to bypass RLS (while still respecting business rules). Below is a page-by-page map that blends user experience with the technical substrate. ### Staff Dashboard (/versotech/staff) **Narrative & Layout** - Landing page for operations staff, themed in “dark ops” styling. Header badges reinforce compliance posture (BVI FSC, GDPR, n8n active). Date stamp shows data freshness. - KPI tiles: Active LPs, Pending KYC/AML (with high-priority indicator), Workflow Runs month-to-date, Compliance Rate. - Operations pipeline cards track KYC onboarding, NDA execution, subscription processing, and capital call schedule. Each card shows counts and highlights the next due event. - “Process Center” quick-launch buttons trigger automation workflows (Positions Statement, NDA Agent, Shared-Drive Notification, Inbox Manager, LinkedIn Leads Scraper, Reporting Agent). - Recent Operations feed streams latest workflow executions and system events. - Management quadrant links to Deals, Requests, Audit, Investors with live counts/percentages. **Technical Execution** - Route guarded by requireStaffAuth (ensures authenticated session + staff role in profiles.role). - Data fetched via helper getStaffDashboardData() which uses service-role queries and RPCs to assemble metrics: - Active LPs from investors (filter status = 'active'). - Pending KYC counts from investors (kyc_status, aml_risk_rating). - Workflow runs from workflow_runs (month-to-date count, statuses). - Compliance rate computed from approved investors vs. total. - Pipeline metrics from tasks (KYC-related), doc_packages/esign_envelopes (NDA execution), deal_commitments + approvals (subscription review), capital_calls (next due date, status). - Recent activity aggregated from workflow_runs, approvals, activity_feed flagged for staff. - The Process Center buttons link to /versotech/staff/processes where full workflow triggers live; they pass the workflow key via query parameters. **Permissions & Edge Cases** - All queries execute with service role, but data is limited to the organisation (single-tenant). For branch/region separation, filters would be applied at query level. - Missing metrics push user-friendly alerts (statusMessages). If getStaffDashboardData surfaces errors, the banner warns staff about data latency. - KPI definitions align with staff PRD to ensure consistent reporting. ### Deal Management List (/versotech/staff/deals) **Narrative & Layout** - Summary strip shows total deals, counts per status (open, draft, closed), estimated pipeline value. - Deal table/cards list each opportunity with type badge, status pill, linked vehicle, quick stats (unit price, creation date), and membership summary (number of investors/staff assigned). - Primary CTA “Create Deal” linking to /versotech/staff/deals/new for drafting new opportunities. **Technical Execution** - Uses createServiceClient to query deals ordered by created_at descending, including nested vehicles metadata and deal_memberships (mainly to surface staffing footprint). - Summary stats computed in-memory. - Filter/search/pagination handled client-side by DealsListClient component; advanced filters tie back to query string (status, type, staff owner). - Bulk actions (if enabled) call to APIs like /api/deals (POST/PATCH/DELETE) or custom endpoints for inventory import. **Permissions & Edge Cases** - Service role bypasses RLS; only staff with portal access can hit this page. For multi-team partitioning, additional checks (e.g., profiles.title) could restrict results. - Handles missing inventory summary gracefully; loads detail on demand via /versotech/staff/deals/[id] or RPC fn_deal_inventory_summary when staff open a specific deal. ### Deal Detail (/versotech/staff/deals/[id]) **Narrative & Layout** - Tabs/panels: Overview (terms, status timeline, fee plans), Inventory (share lots, available units, reservations, allocations), Memberships (investors, advisors, staff), Commitments (queue management), Documents (deal room files), Activity log. - Action buttons for editing deal metadata, opening invite links, triggering approvals, running fee computations. **Technical Execution** - Server component authenticates user, ensures staff role, and fetches the deal using service client: - deals with nested vehicles, deal_memberships (including profiles and investors), fee_plans with fee_components, share_lots with share_sources. - RPC fn_deal_inventory_summary(p_deal_id) for aggregated inventory stats. - deal_commitments, reservations, allocations (with related investors, approved_by_profile). - documents scoped to deal_id for shared files. - Client DealDetailClient composes UI and wires up actions: - Approve/reject commitments: /api/deals/:id/commitments/[commitmentId]/approve|reject. - Manage inventory: /api/deals/:id/inventory for CRUD on share lots; /api/deals/:id/reservations for staff-initiated holds. - Finalize allocations: /api/deals/:id/allocations/finalize calling fn_finalize_allocation. - Fee management: /api/deals/:id/fees/compute -> fn_compute_fee_events, /api/deals/:id/invoices/generate -> fn_invoice_fees. - Invite management: /api/deals/:id/invite-links (POST) to generate hashed invite tokens. - Audit trail updates activity_feed and audit_log on key mutations. **Permissions & Edge Cases** - Service role read/write; additional UI-level guardrails ensure only staff with appropriate profiles.title (e.g., bizops, compliance) can execute certain actions. Secondary approvals triggered via approvals when configured. - Inventory concurrency handled by Postgres locks in fn_reserve_inventory; UI shows warnings if units are low or lots locked. - Deal status transitions (draft→open→allocation_pending→closed) enforced by backend; UI highlights incomplete prerequisites (fee plans missing, approvals outstanding). ### Requests Inbox (/versotech/staff/requests) **Narrative & Layout** - Kanban or table view of investor “Ask” tickets, grouped by status (Open, Assigned, In Progress, Ready, Closed, Awaiting Info). - Each row shows investor name, subject, category, priority, SLA timer, assigned staff, linked workflow run/documents. - Detail pane allows internal notes, status transitions, attaching outputs, linking workflows or documents. - Analytics tab (/versotech/staff/requests/analytics) charts ticket volume, SLA compliance, response times. **Technical Execution** - Fetches request_tickets with joins to investors, profiles (assigned_to), documents (result), workflow_runs (linked automation). - Supports filtering by status, category, priority, deal, investor; search across subject/description. - Actions via API routes: - /api/requests (GET/POST) for listing/creating requests. - /api/requests/:id (PATCH) for updates (status, assignment, notes, linking results). - /api/staff/requests/:id/assign for mass assignment. - /api/staff/requests/stats used by analytics dashboard. - SLA timers computed from created_at, priority, and potentially workflow_runs to measure automation durations. **Permissions & Edge Cases** - Service role used; staff policies restrict modifications to authorized titles (ops, RM, compliance). Actions logged to audit_log with entity request_tickets. - Requests linked to deals respect deal context; staff can filter to see only tickets tied to particular opportunities. - Reassignment triggers notifications (email/slack) via n8n webhooks configured for request_tickets updates. ### Process Center (/versotech/staff/processes) **Narrative & Layout** - Catalog of automation workflows (cards grouping by category: Documents, Compliance, Communications, Data Processing, Multi-step). Each card displays workflow name, description, required staff titles, and trigger button. - Workflow detail modal describes input schema and outputs. **Technical Execution** - Data from workflows table (fields: id, key, name, description, category, required_role, required_title, input_schema, trigger_type, is_active). - Triggering a workflow hits /api/workflows/[key]/trigger with payload assembled from staff inputs. API validates staff role/title against required_role/required_title and enqueues run by calling n8n webhook stored in workflows.n8n_webhook_url. - workflow_runs captures execution state (queued, in-progress, completed, failed) and stores results/created tasks (created_tasks array) for follow-up. **Permissions & Edge Cases** - Access restricted to staff; additional UI logic disables trigger button when user lacks required title. - Workflows marked is_active=false hidden or labeled as offline. - Trigger responses show run ID and link to /versotech/staff/requests or relevant module depending on workflow output. ### Document Workspace (/versotech/staff/documents & /versotech/staff/documents/manage) **Narrative & Layout** - Staff view shows folder tree with additional admin controls: create folders, bulk upload, publish/unpublish, request approvals. Document list includes status (draft, pending approval, approved, published, archived), publish schedule, owner, deal/vehicle associations. - Side panel for document detail with approval history, publishing schedule, and watermark settings. **Technical Execution** - Queries document_folders, documents, document_versions, document_approvals, document_publishing_schedule with service role. - Bulk upload form posts to /api/staff/documents/bulk-upload (multipart) to ingest multiple files and auto-classify into folders. - Approvals flow uses /api/staff/documents/[id]/submit-approval, /approve, /publish, /access to manage lifecycle. - Integration with Dropbox Sign/DocuSign via doc_packages for generating subscription packs or NDAs; staff can trigger from document detail. - Manage view uses documents.status to gate investor visibility—publishing sets is_published=true and schedules via document_publishing_schedule cron (triggered by /api/cron/publish-documents, /api/cron/unpublish-documents). **Permissions & Edge Cases** - Service role ensures full access; however, operations around approvals respect profiles.title (e.g., compliance must sign off). Secondary approvals captured in approvals table. - Publishing before approvals raises validation errors; UI surfaces outstanding requests. ### Document Automation (/versotech/staff/documents/automation) **Narrative & Layout** - Focused on generating doc packages (term sheets, subscription packs, NDAs). Staff select template(s), merge data (investor, deal, fee plan), preview package, send for signature. - Status list shows each package with envelope status (draft, sent, signed, cancelled), recipients, and completion timestamps. **Technical Execution** - Uses doc_templates, doc_packages, doc_package_items, esign_envelopes tables. - Creating package calls /api/doc-packages (POST) which assembles package items, merges data per template schema, and integrates with e-sign provider (Dropbox Sign/DocuSign) using doc_templates.provider and file_key. - Webhook /api/webhooks/esign listens for envelope status updates, updates doc_packages.status, esign_envelopes.completed_at, and attaches signed PDFs to documents table. **Permissions & Edge Cases** - Only staff with appropriate titles can trigger e-sign (checked client-side and server-side via requireStaffAuth and optional title checks). - Error handling for provider failures; statuses set to cancelled or failed with notes. ### Investor Management (/versotech/staff/investors & /versotech/staff/investors/[id]) **Narrative & Layout** - Directory table lists investors with status badges (active, onboarding, suspended), KYC state, primary/secondary RM, committed capital, open tasks count. - Detail page features tabs: Overview (legal/KYC info, relationships), Subscriptions, Positions, Tasks, Documents, Messaging shortcuts, Activity log, Notes. - Inline actions for assigning RM, changing KYC status, triggering requests, sending messages. **Technical Execution** - Listing query pulls from investors (legal info, status, risk ratings), profiles (primary/secondary RM), aggregated data from subscriptions, positions, tasks for counts. - Detail page fetches: - investors record. - investor_users + profiles for user linkages. - subscriptions, positions, cashflows, performance_snapshots for holdings. - tasks for outstanding items. - documents specific to investor. - activity_feed filter by investor. - Messaging integration uses /versotech/staff/messages pre-filtered to investor threads. - Actions via APIs: /api/staff/investors (PATCH) for updates, /api/staff/investors/:id/users to add/remove user access, /api/tasks for manual task creation, /api/requests to log new asks. **Permissions & Edge Cases** - Service role; UI ensures only authorized titles can edit sensitive fields (e.g., compliance controls KYC status). Changes recorded in audit_log via middleware. - When investor is suspended/archived, UI dims actions and prompts reactivation workflow. ### Introducers (/versotech/staff/introducers) **Narrative & Layout** - Table of introducers (referral partners) with status, default commission rate, agreement status, outstanding commissions, contact info. - Detail view shows introductions pipeline, commission accruals, payments history, agreement documents. **Technical Execution** - Queries introducers, introductions, introducer_commissions, linking to documents for agreements. - Staff can onboard new introducers via form (POST /api/staff/introducers). - Commission lifecycle: - Accruals generated from deal allocations via triggers/functions (e.g., part of fn_finalize_allocation). - Invoice generation uses introducer_commissions linked to invoices. - UI supports marking commissions paid, adjusting rates, uploading updated agreements. **Permissions & Edge Cases** - Only staff with bizdev/ops titles allowed to edit; rate changes recorded in audit_log. - Introducer status drives visibility; inactive introducers greyed out but history retained. ### Fees & Billing (/versotech/staff/fees) **Narrative & Layout** - Dashboard summarizing fee plans, fee events (accrued vs. invoiced), outstanding invoices, payments received. - Tabs for Fee Plans (configuration editor), Fee Events (per investor/deal), Invoices, Payments. - Buttons to compute fees for a deal, generate invoices, ingest payments. **Technical Execution** - Fee Plans: fee_plans, fee_components editing via /api/deals/:id/fee-plans endpoints. - Fee Events: generated through RPC fn_compute_fee_events; UI calls /api/deals/:id/fees/compute to queue computation. - Invoices: /api/deals/:id/invoices/generate calls fn_invoice_fees, writes to invoices, invoice_lines. - Payments: /api/payments/ingest-bank ingests CSV/API feeds into bank_transactions; /api/reconciliations/match or /api/reconciliations handles matching to invoices, creating reconciliations. - UI surfaces statuses, links to documents, logs audit entries. **Permissions & Edge Cases** - Financial actions restricted to finance/ops titles; double-confirmation for destructive updates (void invoice, delete fee event). - Automations (n8n) schedule periodic fee computations; UI shows last run time. - Multi-currency support depends on currency fields; conversions handled outside scope or via future enhancements. ### Reconciliation (/versotech/staff/reconciliation) **Narrative & Layout** - Bank transaction table with match suggestions, confidence scores, status (unmatched, partially matched, matched). - Pane to review individual transaction, view suggested matches, approve/reject, or split into multiple invoices. - Import dialog for uploading bank statements. **Technical Execution** - Queries bank_transactions, suggested_matches, reconciliation_matches, payments, invoices. - Suggestion engine (could be n8n or SQL) populates suggested_matches with confidence score. - Approving a match writes to reconciliation_matches and optionally updates payments/invoices (status, paid_amount). - Import uses /api/payments/ingest-bank to parse CSV, create import_batches, populate bank_transactions. - Matching API /api/reconciliations/match processes manual approvals, ensures totals align. **Permissions & Edge Cases** - Finance-only access; actions logged. Split payments supported (one bank txn to multiple invoices) via match_type = 'split'. - Unmatched items flagged for follow-up; UI surfaces age of unmatched transactions. ### Approvals Queue (/versotech/staff/approvals) **Narrative & Layout** - Table/cards of pending approvals with filters by entity (deal allocation, document publish, fee override, introducer commission), priority, requester. - Detail drawer shows approval metadata, rationale, supporting documents, history of actions. - Buttons for approve, reject, request info; secondary approval workflows supported. **Technical Execution** - approvals table stores approval tasks (fields: entity_type, entity_id, action, status, requested_by, assigned_to, approved_by, approved_at, priority, entity_metadata). - approval_history captures timeline (created, assigned, approved, rejected, escalated). - APIs /api/approvals (GET/POST/PATCH) handle listing and state changes; /api/approvals/bulk-action for mass approve/reject; /api/approvals/[id]/action for targeted updates. - Approvals often triggered by other modules (deal commitments, document publishing, fee overrides) which insert rows and assign to relevant staff. **Permissions & Edge Cases** - Staff roles validated: e.g., compliance tasks assigned to users with profiles.title containing “compliance”; UI filters out tasks the user cannot act on. - SLA timers (fields sla_breach_at, sla_paused_at, sla_resumed_at) provide warning indicators. - Secondary approvals managed via requires_secondary_approval fields; UI enforces two-step confirmation. ### Messages (/versotech/staff/messages) **Narrative & Layout** - Staff inbox mirroring investor messaging but with extra filters (by investor, by deal, by conversation type) and admin controls (broadcast, escalations). - Each conversation shows SLA badges, pinned status, and quick links to investor/deal profiles. **Technical Execution** - Uses same underlying tables (conversations, conversation_participants, messages, message_reads) but staff are added as participants for all relevant threads. - Additional filters to surface investor unread count, escalated conversations (metadata field storing escalations). - Broadcast messages use /api/conversations/broadcast to seed system announcements to investor cohorts. - Escalation/assignment integrates with approvals or request_tickets depending on practise. **Permissions & Edge Cases** - Staff can see all conversations depending on role; superusers may have global view, others limited to assigned investors/deals. - Attachment downloads go through staff-privileged endpoints ensuring compliance logging. ### Audit & Compliance (/versotech/staff/audit) **Narrative & Layout** - Dashboard summarising audit log events, compliance alerts, SOC/GDPR/SFC report templates. Filters by risk level, event type, user. - Table lists individual audit events (actor, action, entity, risk level, compliance flag). - Compliance alert panel with triage controls (assign reviewer, mark resolved, escalate). - Report templates section to generate audit reports via workflows. **Technical Execution** - Queries audit_logs (fields: timestamp, event_type, action, actor_id, actor_email, actor_role, entity_type, entity_id, action_details, risk_level, compliance_flag, compliance_review_status). - audit_log_hash_chain used for tamper detection; UI may show chain integrity check. - compliance_alerts table surfaces flagged events (fields: alert_type, severity, status, assigned_to, resolution_notes). - audit_report_templates stored for on-demand report generation; triggers n8n workflows to compile logs/by timeframe. - Actions (assign, resolve, escalate) use /api/staff/audit endpoints or reuse approvals for oversight. **Permissions & Edge Cases** - Restricted to compliance officers; user role enforced server-side. - Hash chain verification exposed via UI button to validate audit trail. - Alerts with severity = 'critical' highlight in red and require explicit acknowledgement. ### Entities Management (/versotech/staff/entities) **Narrative & Layout** - Entity list (vehicles, SPVs, holding companies) with directors, jurisdiction, registration numbers, key dates. - Detail view shows general info, directors roster, events/change log, linked documents, deals associated with the entity. **Technical Execution** - Tables: vehicles (extended metadata), entity_directors, director_registry, entity_events, documents (entity-level), deal_memberships (for linking deals to entities). - Staff can add/update directors (writes to entity_directors, optionally director_registry), log events (entity_events), attach documents. - API endpoints under /api/entities or /api/staff/entities manage CRUD operations. **Permissions & Edge Cases** - Legal/compliance titles required to modify directors or entity data. - Audit logging ensures changes traceable; events include who/when. ### Admin Utilities (/versotech/staff/admin) **Narrative & Layout** - Toolbox for environment configuration: demo mode toggles, cache invalidation, session management, feature flags, health checks. **Technical Execution** - Hooks into auth helper functions, environment variables, and housekeeping endpoints (e.g., clearing caches, seeding demo data via scripts). - May call serverless functions or Node scripts (scripts/check-staff.js) for verification. **Permissions & Edge Cases** - Locked down to admin titles; misuse could impact production environment. --- This staff portal breakdown mirrors the investor sections: each page entry combines user experience, backing data sources, key API routes, automation hooks, and guardrails. With both portals fully catalogued, the document now supports client reviews, onboarding, and scoping of next-phase enhancements. ## 4. Staff Portal (/versotech/staff) Breakdown | Route | Capability Highlights | Data Sources | Key Components / APIs | | --- | --- | --- | --- | | / (Dashboard) | Ops KPIs, process shortcuts, pipeline status, recent activity feed. | profiles, investors, workflow_runs, approvals, tasks, activity_feed. | getStaffDashboardData, dashboard cards. | | /deals & /deals/[id] | Deal pipeline, invite management, inventory (share lots), reservations → allocations flow, fee plans, documents. | deals, share_sources, share_lots, reservations, allocations, deal_commitments, documents. | DealDetailClient, RPC fn_deal_inventory_summary, API suite under /api/deals/*. | | /approvals | Central approval queue w/ secondary approvals. | approvals, approval_history. | Approvals list, actions via /api/approvals. | | /requests (+ /requests/analytics) | Ask inbox triage, SLA tracking, analytics dashboards. | request_tickets, documents, workflow_runs. | Requests tables, assign/transition APIs. | | /processes | n8n workflow catalog, triggers. | workflows, workflow_runs. | Process trigger cards, /api/workflows/[key]/trigger. | | /documents & /documents/automation | Document workspace, publishing approvals, doc package automation. | documents, document_folders, document_versions, doc_packages, doc_templates, document_approvals. | Staff document management components, APIs under /api/staff/documents/* & /api/doc-packages. | | /investors & /investors/[id] | Investor CRM, onboarding state, linked users. | investors, investor_users, tasks, subscriptions, cashflows. | Investor detail cards, staff investor APIs. | | /introducers | Introducer onboarding, commission tracking. | introducers, introductions, introducer_commissions. | Introducer management UI, /api/staff/introducers. | | /fees | Fee plan management, fee events, invoicing overview. | fee_plans, fee_components, fee_events, invoices, payments. | Fee management components, /api/fees, /api/deals/:id/fees/compute, /api/deals/:id/invoices/generate. | | /reconciliation | Bank transaction ingest, matching. | bank_transactions, reconciliations, suggested_matches, payments. | Reconciliation tables, /api/payments/ingest-bank, /api/reconciliations/match. | | /messages | Staff inbox bridging investor chats, deal rooms. | conversations, messages, activity_feed. | Staff messaging client, broadcast endpoints. | | /audit | Compliance review dashboards. | audit_logs, compliance_alerts, audit_report_templates. | Audit tables, exports. | | /admin | Admin utilities (environment setup, demo toggles). | Config endpoints, profiles. | Admin cards, /api/staff/*. | ## 5. Backend & Integrations ### 5.1 Supabase Schema Highlights - **Core Identity & Portfolio**: profiles, investors, investor_users, vehicles, subscriptions, positions, cashflows, valuations, performance_snapshots. - **Deal & Inventory**: deals, deal_memberships, invite_links, share_sources, share_lots, reservations, reservation_lot_items, allocations, allocation_lot_items, deal_commitments. - **Pricing & Docs**: fee_plans, fee_components, investor_terms, term_sheets, doc_templates, doc_packages, doc_package_items, documents, document_folders, document_versions, document_approvals. - **Financial Ops**: fee_events, invoices, invoice_lines, payments, bank_transactions, reconciliations, suggested_matches, reconciliation_matches. - **Go-to-Market**: introducers, introductions, introducer_commissions. - **Operations & Compliance**: tasks, task_templates, workflow_runs, activity_feed, request_tickets, approvals, approval_history, audit_log, audit_logs, compliance_alerts, audit_report_templates. ### 5.2 Stored Procedures & Functions - Inventory & Deal Flow: fn_reserve_inventory, fn_expire_reservations, fn_finalize_allocation, fn_deal_inventory_summary. - Fee & Billing: fn_compute_fee_events, fn_invoice_fees. - Portfolio Analytics: calculate_investor_kpis_with_deals, calculate_investor_kpis, get_portfolio_trends, get_investor_vehicle_breakdown. - Misc: additional helper RPCs for dashboards, analytics (per migrations/SQL files). ### 5.3 API Surface (Next.js Route Handlers) - **Investor-Facing**: /api/me, /api/portfolio, /api/portfolio/kpi-details, /api/documents, /api/report-requests, /api/requests, /api/conversations, /api/conversations/:id/messages, /api/deals/:id/reservations, /api/reservations/:id/finalize (workflow handshake), /api/reservations/expire (cron). - **Staff-Facing**: /api/deals/* (inventory, commitments, invoices, fee plans, invite links, members), /api/approvals, /api/staff/documents/*, /api/staff/requests/*, /api/staff/investors/*, /api/staff/introducers, /api/staff/vehicles, /api/payments/ingest-bank, /api/reconciliations/match, /api/workflows/[key]/trigger, /api/conversations/broadcast. - **Cross-Cutting**: /api/doc-packages, /api/documents/upload, /api/documents/[id]/download, /api/webhooks/n8n, /api/webhooks/esign, /api/cron/publish-documents, /api/cron/unpublish-documents. ### 5.4 Automation & External Services - **n8n Workflows**: Report generation, doc assembly, reservation expiry cron, fee accruals, bank ingest; contract documented in PRD §10 and implementation files. - **E-Sign Providers**: Dropbox Sign / DocuSign integration via doc_packages, esign_envelopes, /api/doc-packages. - **Storage**: Supabase Storage (implied via file_key), watermarks, short-TTL downloads. - **Realtime**: Supabase channels for dashboards, messaging, holdings. ## 6. Documentation Inventory - **Product Requirements (Investor)**: docs/investor/*.md (Dashboard, Holdings, Active Deals, Documents, Reports, Tasks, Messages). - **Product Requirements (Staff)**: docs/staff/*.md (Approvals, Audit & Compliance, Deal Management, Entities, Fees, Introducers, Investor Management, Messages, Process Center, Reconciliation, Request Management, Staff Dashboard). - **Implementation Guides**: docs/implementation/* (Tasks module, Approvals, Process Center, etc.). - **Architecture & Schema**: docs/PRD.md, docs/DATABASE_SCHEMA.md, docs/database_entities_relationships.md, versotech-portal/docs/DATABASE_ARCHITECTURE.md. - **Operational Guides**: PRODUCTION_DEPLOYMENT_GUIDE.md, VALUATION_FIX_GUIDE.md, TROUBLESHOOTING_DEMO_AUTH_RLS.md, VERCEL_DEPLOYMENT.md, APPLY_MESSAGING_MIGRATION.md. - **Status & Plans**: versotech-portal/APP_STRUCTURE_ANALYSIS.md, staff.plan.md, feature completion summaries for major modules. ## 7. Testing, Tooling & Observations - **Testing**: Minimal unit/component tests located in src/__tests__; need broader coverage for critical flows (deals, reservations, fee computation, messaging). - **Linting & Config**: ESLint (eslint.config.mjs), Tailwind (tailwind.config.js), TypeScript (tsconfig.json). - **Supabase Access**: MCP-connected project Versotech (ipguxdssecfexudnvtia in region eu-central-2). Supabase tables confirmed with RLS on most sensitive tables; ensure any service-role usage remains server-only. - **Known Cleanup Items** (per APP_STRUCTURE_ANALYSIS.md): remove duplicate routes (/versoholdings/settings, /versotech/settings), eliminate test/debug API routes, strip demo auth files before production. - **Security Posture**: RLS policies documented in PRD §7; verify production parity (some tables currently rls_enabled=false such as investor_users, positions, cashflows, subscriptions; ensure intended access via service routes only or enable RLS prior to launch). ## 8. Outstanding Questions / Next Steps - Validate that all RPC functions are deployed in Supabase prod instance and wired to cron triggers (reservation expiry, fee accrual). - Confirm cleanup/removal of debug/demo endpoints ahead of launch per audit report. - Expand automated testing, especially for allocation finalization, fee invoicing, reconciliation matching, and messaging permissions. - Review service-role usage in investor routes (createServiceClient usage) to ensure no unintended exposure when deployed without additional auth checks. - Align documentation with latest code (e.g., ensure module guides reflect enhanced chat UI, new analytics). --- Generated by GPT-5 Codex (Cursor agent) on October 13, 2025.